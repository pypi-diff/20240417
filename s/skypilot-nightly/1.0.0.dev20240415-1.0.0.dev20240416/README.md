# Comparing `tmp/skypilot_nightly-1.0.0.dev20240415.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240416.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240415.tar", last modified: Mon Apr 15 10:38:05 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240416.tar", last modified: Tue Apr 16 10:38:02 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240415.tar` & `skypilot_nightly-1.0.0.dev20240416.tar`

### file list

```diff
@@ -1,335 +1,335 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.284411 skypilot_nightly-1.0.0.dev20240415/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    17869 2024-04-15 10:38:05.284411 skypilot_nightly-1.0.0.dev20240415/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    11712 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-15 10:38:05.284411 skypilot_nightly-1.0.0.dev20240415/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-15 10:38:02.000000 skypilot_nightly-1.0.0.dev20240415/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.224411 skypilot_nightly-1.0.0.dev20240415/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.228411 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     3698 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.228411 skypilot_nightly-1.0.0.dev20240415/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   118820 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   221923 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.228411 skypilot_nightly-1.0.0.dev20240415/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.228411 skypilot_nightly-1.0.0.dev20240415/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   186846 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.232411 skypilot_nightly-1.0.0.dev20240415/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    43129 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    30942 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    30816 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12508 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    46892 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    16680 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11042 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.236411 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.236411 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7528 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.236411 skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    32991 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.240411 skypilot_nightly-1.0.0.dev20240415/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   119221 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    24916 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    54049 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.240411 skypilot_nightly-1.0.0.dev20240415/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.240411 skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      782 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.240411 skypilot_nightly-1.0.0.dev20240415/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      199 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4400 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.244411 skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    16137 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.244411 skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8694 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.244411 skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      579 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.244411 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14212 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9457 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     8635 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    52429 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.244411 skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      553 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.248411 skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.248411 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.248411 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    60100 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.252411 skypilot_nightly-1.0.0.dev20240415/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30137 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    29231 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.252411 skypilot_nightly-1.0.0.dev20240415/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-15 10:38:02.000000 skypilot_nightly-1.0.0.dev20240415/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.252411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)     9204 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    11542 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35113 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18788 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.252411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.256411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    18603 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    15645 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.256411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.256411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.256411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.256411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.260411 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.260411 skypilot_nightly-1.0.0.dev20240415/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (127)     1561 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    25524 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13074 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.260411 skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.260411 skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.260411 skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    46443 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.264411 skypilot_nightly-1.0.0.dev20240415/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7290 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8872 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9851 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/spot-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.264411 skypilot_nightly-1.0.0.dev20240415/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.268411 skypilot_nightly-1.0.0.dev20240415/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.268411 skypilot_nightly-1.0.0.dev20240415/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    22349 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25413 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     6260 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.268411 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/generate_kind_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    20387 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.272411 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    17869 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9162 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2326 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-04-15 10:38:05.000000 skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-15 10:38:05.272411 skypilot_nightly-1.0.0.dev20240415/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   211200 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_spot_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-04-15 10:38:00.000000 skypilot_nightly-1.0.0.dev20240415/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.712923 skypilot_nightly-1.0.0.dev20240416/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    17869 2024-04-16 10:38:02.712923 skypilot_nightly-1.0.0.dev20240416/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    11712 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-16 10:38:02.712923 skypilot_nightly-1.0.0.dev20240416/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-16 10:37:59.000000 skypilot_nightly-1.0.0.dev20240416/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.644923 skypilot_nightly-1.0.0.dev20240416/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.648923 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3698 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21410 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.652923 skypilot_nightly-1.0.0.dev20240416/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118820 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   221923 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.652923 skypilot_nightly-1.0.0.dev20240416/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.652923 skypilot_nightly-1.0.0.dev20240416/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26440 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   186846 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.656923 skypilot_nightly-1.0.0.dev20240416/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    43129 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30942 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30816 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12036 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12508 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46892 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21044 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16680 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25299 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11042 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15546 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.656923 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.660923 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5487 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7528 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.660923 skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11969 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32991 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.660923 skypilot_nightly-1.0.0.dev20240416/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8226 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   119221 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8213 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24916 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    54049 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.664923 skypilot_nightly-1.0.0.dev20240416/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     4907 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.664923 skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      782 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36603 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.664923 skypilot_nightly-1.0.0.dev20240416/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      199 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4400 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8561 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.664923 skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4046 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8202 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16137 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.668923 skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8694 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14870 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.668923 skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      579 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24482 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22258 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.668923 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14212 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32523 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9457 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8635 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    53819 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.668923 skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      553 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11985 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25255 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.672923 skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7849 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.672923 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.672923 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24476 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    60100 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.676923 skypilot_nightly-1.0.0.dev20240416/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30137 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3732 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7571 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29231 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4689 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2047 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    55738 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36837 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13803 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.676923 skypilot_nightly-1.0.0.dev20240416/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      673 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12065 2024-04-16 10:37:59.000000 skypilot_nightly-1.0.0.dev20240416/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.680923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1963 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4293 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9964 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11542 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35113 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18788 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4292 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.680923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.680923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6203 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18603 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15645 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.680923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.680923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13992 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.684923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.684923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.684923 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1144 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5586 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/skypilot_config.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.684923 skypilot_nightly-1.0.0.dev20240416/sky/spot/
+-rw-r--r--   0 runner    (1001) docker     (127)     1561 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1117 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25830 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13074 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.688923 skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     2294 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.688923 skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.688923 skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     6247 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25656 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22487 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/spot_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31559 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/spot/spot_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46443 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.692923 skypilot_nightly-1.0.0.dev20240416/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7290 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9037 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8872 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6607 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9851 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5676 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6970 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5546 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1148 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1218 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/spot-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.692923 skypilot_nightly-1.0.0.dev20240416/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17601 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.696923 skypilot_nightly-1.0.0.dev20240416/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.696923 skypilot_nightly-1.0.0.dev20240416/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18805 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3485 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    22349 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25413 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6260 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      852 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.696923 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9667 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/generate_kind_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1173 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20387 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.700923 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    17869 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9162 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2326 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-04-16 10:38:02.000000 skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-16 10:38:02.700923 skypilot_nightly-1.0.0.dev20240416/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3618 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9599 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   211236 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17581 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_spot_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-04-16 10:37:57.000000 skypilot_nightly-1.0.0.dev20240416/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/LICENSE` & `skypilot_nightly-1.0.0.dev20240416/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240416/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240416/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240415
+Version: 1.0.0.dev20240416
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/README.md` & `skypilot_nightly-1.0.0.dev20240416/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240416/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/setup.py` & `skypilot_nightly-1.0.0.dev20240416/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = 'e60eb736422ecf541810a50cc9a37942b407dc41'
+_SKYPILOT_COMMIT_SHA = 'c9f575cf3d127ce6387795b0400a2de85c143377'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240415'
+__version__ = '1.0.0.dev20240416'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240416/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240416/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/backend_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/cloud_vm_ray_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240416/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/check.py` & `skypilot_nightly-1.0.0.dev20240416/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240416/sky/cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240416/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/kubernetes_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/kubernetes_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240416/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/core.py` & `skypilot_nightly-1.0.0.dev20240416/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240416/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240416/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240416/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240416/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240416/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240416/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240416/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/network.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/kubernetes/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -1021,36 +1021,72 @@
                               secret=ssh_key_secret,
                               service_type=service_type)
     content = yaml.safe_load(cont)
     return content
 
 
 def check_port_forward_mode_dependencies() -> None:
-    """Checks if 'socat' is installed"""
-    # We store the dependency list as a list of lists. Each inner list
-    # contains the name of the dependency, the command to check if it is
-    # installed, and the package name to install it.
-    dependency_list = [['socat', ['socat', '-V'], 'socat'],
-                       ['nc', ['nc', '-h'], 'netcat']]
-    for name, check_cmd, install_cmd in dependency_list:
-        try:
-            subprocess.run(check_cmd,
-                           stdout=subprocess.DEVNULL,
-                           stderr=subprocess.DEVNULL,
-                           check=True)
-        except (FileNotFoundError, subprocess.CalledProcessError):
+    """Checks if 'socat' and 'nc' are installed"""
+
+    # Construct runtime errors
+    socat_default_error = RuntimeError(
+        f'`socat` is required to setup Kubernetes cloud with '
+        f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
+        'default networking mode and it is not installed. '
+        'On Debian/Ubuntu, install it with:\n'
+        f'  $ sudo apt install socat\n'
+        f'On MacOS, install it with: \n'
+        f'  $ brew install socat')
+    netcat_default_error = RuntimeError(
+        f'`nc` is required to setup Kubernetes cloud with '
+        f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
+        'default networking mode and it is not installed. '
+        'On Debian/Ubuntu, install it with:\n'
+        f'  $ sudo apt install netcat\n'
+        f'On MacOS, install it with: \n'
+        f'  $ brew install netcat')
+    mac_installed_error = RuntimeError(
+        f'The default MacOS `nc` is installed. However, for '
+        f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
+        'default networking mode, GNU netcat is required. '
+        f'On MacOS, install it with: \n'
+        f'  $ brew install netcat')
+
+    # Ensure socat is installed
+    try:
+        subprocess.run(['socat', '-V'],
+                       stdout=subprocess.DEVNULL,
+                       stderr=subprocess.DEVNULL,
+                       check=True)
+    except (FileNotFoundError, subprocess.CalledProcessError):
+        with ux_utils.print_exception_no_traceback():
+            raise socat_default_error from None
+
+    # Ensure netcat is installed
+    #
+    # In some cases, the user may have the default MacOS nc installed, which
+    # does not support the -z flag. To use the -z flag for port scanning,
+    # they need GNU nc installed. We check for this case and raise an error.
+    try:
+        netcat_output = subprocess.run(['nc', '-h'],
+                                       capture_output=True,
+                                       check=False)
+        nc_mac_installed = netcat_output.returncode == 1 and 'apple' in str(
+            netcat_output.stderr)
+
+        if nc_mac_installed:
+            with ux_utils.print_exception_no_traceback():
+                raise mac_installed_error from None
+        elif netcat_output.returncode != 0:
             with ux_utils.print_exception_no_traceback():
-                raise RuntimeError(
-                    f'`{name}` is required to setup Kubernetes cloud with '
-                    f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
-                    'default networking mode and it is not installed. '
-                    'On Debian/Ubuntu, install it with:\n'
-                    f'  $ sudo apt install {install_cmd}\n'
-                    f'On MacOS, install it with: \n'
-                    f'  $ brew install {install_cmd}') from None
+                raise netcat_default_error from None
+
+    except FileNotFoundError:
+        with ux_utils.print_exception_no_traceback():
+            raise netcat_default_error from None
 
 
 def get_endpoint_debug_message() -> str:
     """ Returns a string message for user to debug Kubernetes port opening
 
     Polls the configured ports mode on Kubernetes to produce an
     appropriate error message with debugging hints.
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240416/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240416/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240416/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240416/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240416/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/constants.py`

 * *Files 6% similar despite different names*

```diff
@@ -26,21 +26,23 @@
 # We store the absolute path of the python executable (/opt/conda/bin/python3)
 # in this file, so that any future internal commands that need to use python
 # can use this path. This is useful for the case where the user has a custom
 # conda environment as a default environment, which is not the same as the one
 # used for installing SkyPilot runtime (ray and skypilot).
 SKY_PYTHON_PATH_FILE = '~/.sky/python_path'
 SKY_RAY_PATH_FILE = '~/.sky/ray_path'
-SKY_GET_PYTHON_PATH_CMD = (f'cat {SKY_PYTHON_PATH_FILE} 2> /dev/null || '
+SKY_GET_PYTHON_PATH_CMD = (f'[ -s {SKY_PYTHON_PATH_FILE} ] && '
+                           f'cat {SKY_PYTHON_PATH_FILE} 2> /dev/null || '
                            'which python3')
 # Python executable, e.g., /opt/conda/bin/python3
 SKY_PYTHON_CMD = f'$({SKY_GET_PYTHON_PATH_CMD})'
 SKY_PIP_CMD = f'{SKY_PYTHON_CMD} -m pip'
 # Ray executable, e.g., /opt/conda/bin/ray
-SKY_RAY_CMD = f'$(cat {SKY_RAY_PATH_FILE} 2> /dev/null || which ray)'
+SKY_RAY_CMD = (f'$([ -s {SKY_RAY_PATH_FILE} ] && '
+               f'cat {SKY_RAY_PATH_FILE} 2> /dev/null || which ray)')
 
 # The name for the environment variable that stores the unique ID of the
 # current task. This will stay the same across multiple recoveries of the
 # same spot task.
 TASK_ID_ENV_VAR = 'SKYPILOT_TASK_ID'
 # This environment variable stores a '\n'-separated list of task IDs that
 # are within the same spot job (DAG). This can be used by the user to
@@ -104,14 +106,16 @@
 _sky_version = str(version.parse(sky.__version__))
 RAY_STATUS = f'RAY_ADDRESS=127.0.0.1:{SKY_REMOTE_RAY_PORT} {SKY_RAY_CMD} status'
 # Install ray and skypilot on the remote cluster if they are not already
 # installed. {var} will be replaced with the actual value in
 # backend_utils.write_cluster_config.
 RAY_SKYPILOT_INSTALLATION_COMMANDS = (
     'mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app;'
+    # Print the PATH in provision.log to help debug PATH issues.
+    'echo PATH=$PATH; '
     # Backward compatibility for ray upgrade (#3248): do not upgrade ray if the
     # ray cluster is already running, to avoid the ray cluster being restarted.
     #
     # We do this guard to avoid any Ray client-server version mismatch.
     # Specifically: If existing ray cluster is an older version say 2.4, and we
     # pip install new version say 2.9 wheels here, then subsequent sky exec
     # (ray job submit) will have v2.9 vs. 2.4 mismatch, similarly this problem
@@ -120,17 +124,26 @@
     # NOTE: RAY_STATUS will only work for the cluster with ray cluster on our
     # latest ray port 6380, but those existing cluster launched before #1790
     # that has ray cluster on the default port 6379 will be upgraded and
     # restarted.
     f'{SKY_PIP_CMD} list | grep "ray " | '
     f'grep {SKY_REMOTE_RAY_VERSION} 2>&1 > /dev/null '
     f'|| {RAY_STATUS} || '
-    f'{SKY_PIP_CMD} install --exists-action w -U ray[default]=={SKY_REMOTE_RAY_VERSION};'  # pylint: disable=line-too-long
+    f'{SKY_PIP_CMD} install --exists-action w -U ray[default]=={SKY_REMOTE_RAY_VERSION}; '  # pylint: disable=line-too-long
+    # In some envs, e.g. pip does not have permission to write under /opt/conda
+    # ray package will be installed under ~/.local/bin. If the user's PATH does
+    # not include ~/.local/bin (the pip install will have the output: `WARNING:
+    # The scripts ray, rllib, serve and tune are installed in '~/.local/bin'
+    # which is not on PATH.`), causing an empty SKY_RAY_PATH_FILE later.
+    #
+    # Here, we add ~/.local/bin to the end of the PATH to make sure the issues
+    # mentioned above are resolved.
+    'export PATH=$PATH:$HOME/.local/bin; '
     # Writes ray path to file if it does not exist or the file is empty.
-    f'[ -s {SKY_RAY_PATH_FILE} ] || which ray > {SKY_RAY_PATH_FILE};'
+    f'[ -s {SKY_RAY_PATH_FILE} ] || which ray > {SKY_RAY_PATH_FILE}; '
     # END ray package check and installation
     f'{{ {SKY_PIP_CMD} list | grep "skypilot " && '
     '[ "$(cat ~/.sky/wheels/current_sky_wheel_hash)" == "{sky_wheel_hash}" ]; } || '  # pylint: disable=line-too-long
     f'{{ {SKY_PIP_CMD} uninstall skypilot -y; '
     f'{SKY_PIP_CMD} install "$(echo ~/.sky/wheels/{{sky_wheel_hash}}/'
     f'skypilot-{_sky_version}*.whl)[{{cloud}}, remote]" && '
     'echo "{sky_wheel_hash}" > ~/.sky/wheels/current_sky_wheel_hash || '
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/__init__.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/constants.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/controller.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/controller.py`

 * *Files 2% similar despite different names*

```diff
@@ -56,17 +56,23 @@
         self._backend = cloud_vm_ray_backend.CloudVmRayBackend()
 
         # pylint: disable=line-too-long
         # Add a unique identifier to the task environment variables, so that
         # the user can have the same id for multiple recoveries.
         #   Example value: sky-2022-10-04-22-46-52-467694_my-spot-name_spot_id-17-0
         job_id_env_vars = []
-        for i in range(len(self._dag.tasks)):
-            task_name = self._dag_name
-            if len(self._dag.tasks) > 1:
+        for i, task in enumerate(self._dag.tasks):
+            if len(self._dag.tasks) <= 1:
+                task_name = self._dag_name
+            else:
+                task_name = task.name
+                # This is guaranteed by the spot_launch API, where we fill in
+                # the task.name with
+                # dag_utils.maybe_infer_and_fill_dag_and_task_names.
+                assert task_name is not None, self._dag
                 task_name = f'{self._dag_name}_{task_name}'
             job_id_env_var = common_utils.get_global_job_id(
                 self._backend.run_timestamp,
                 f'{task_name}',
                 str(self._job_id),
                 task_id=i,
                 is_managed_job=True)
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/core.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/dashboard/templates/index.html` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/spot_state.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/spot_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/spot/spot_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/spot/spot_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240416/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/task.py` & `skypilot_nightly-1.0.0.dev20240416/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/sky-serve-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/spot-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/spot-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240416/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240416/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240416/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/controller_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/schemas.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240416/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240415
+Version: 1.0.0.dev20240416
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240416/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_smoke.py`

 * *Files 0% similar despite different names*

```diff
@@ -5763,7438 +5763,7441 @@
 00016820: 6e6f 7420 6861 7665 2061 206e 6f74 696f  not have a notio
 00016830: 6e20 6f66 2073 706f 7420 696e 7374 616e  n of spot instan
 00016840: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
 00016850: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
 00016860: 6620 7465 7374 5f73 706f 745f 7069 7065  f test_spot_pipe
 00016870: 6c69 6e65 2867 656e 6572 6963 5f63 6c6f  line(generic_clo
 00016880: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-00016890: 2254 6573 7420 6120 7370 6f74 c2a0 7069  "Test a spot..pi
-000168a0: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
-000168b0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-000168c0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-000168d0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-000168e0: 2020 2027 7370 6f74 2d70 6970 656c 696e     'spot-pipelin
-000168f0: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-00016900: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016910: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-00016920: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00016930: 5f79 616d 6c73 2f70 6970 656c 696e 652e  _yamls/pipeline.
-00016940: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
-00016950: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00016960: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-00016970: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00016980: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00016990: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-000169a0: 7265 7020 2253 5441 5254 494e 475c 7c52  rep "STARTING\|R
-000169b0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-000169c0: 2020 2020 2020 2320 6067 7265 7020 2d41        # `grep -A
-000169d0: 2034 207b 6e61 6d65 7d60 2066 696e 6473   4 {name}` finds
-000169e0: 2074 6865 206a 6f62 2077 6974 6820 7b6e   the job with {n
-000169f0: 616d 657d 2061 6e64 2074 6865 2034 206c  ame} and the 4 l
-00016a00: 696e 6573 0a20 2020 2020 2020 2020 2020  ines.           
-00016a10: 2023 2061 6674 6572 2069 742c 2069 2e65   # after it, i.e
-00016a20: 2e20 7468 6520 3420 7461 736b 7320 7769  . the 4 tasks wi
-00016a30: 7468 696e 2074 6865 206a 6f62 2e0a 2020  thin the job..  
-00016a40: 2020 2020 2020 2020 2020 2320 6073 6564            # `sed
-00016a50: 202d 6e20 3270 6020 6765 7473 2074 6865   -n 2p` gets the
-00016a60: 2073 6563 6f6e 6420 6c69 6e65 206f 6620   second line of 
-00016a70: 7468 6520 3420 6c69 6e65 732c 2069 2e65  the 4 lines, i.e
-00016a80: 2e20 7468 6520 6669 7273 740a 2020 2020  . the first.    
-00016a90: 2020 2020 2020 2020 2320 7461 736b 2077          # task w
-00016aa0: 6974 6869 6e20 7468 6520 6a6f 622e 0a20  ithin the job.. 
-00016ab0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00016ac0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00016ad0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00016ae0: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
-00016af0: 7265 7020 2253 5441 5254 494e 475c 7c52  rep "STARTING\|R
-00016b00: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00016b10: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00016b20: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00016b30: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-00016b40: 6420 2d6e 2033 7020 7c20 6772 6570 2022  d -n 3p | grep "
-00016b50: 5045 4e44 494e 4722 272c 0a20 2020 2020  PENDING"',.     
-00016b60: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-00016b70: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-00016b80: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
-00016b90: 7d27 292c 0a20 2020 2020 2020 2020 2020  }'),.           
-00016ba0: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-00016bb0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00016bc0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00016bd0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00016be0: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
-00016bf0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-00016c00: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-00016c10: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00016c20: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00016c30: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-00016c40: 6564 202d 6e20 3370 207c 2067 7265 7020  ed -n 3p | grep 
-00016c50: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-00016c60: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00016c70: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00016c80: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00016c90: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-00016ca0: 6420 2d6e 2034 7020 7c20 6772 6570 2022  d -n 4p | grep "
-00016cb0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-00016cc0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00016cd0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00016ce0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00016cf0: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-00016d00: 202d 6e20 3570 207c 2067 7265 7020 2243   -n 5p | grep "C
-00016d10: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
-00016d20: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-00016d30: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
-00016d40: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00016d50: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00016d60: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
-00016d70: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
-00016d80: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-00016d90: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00016da0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00016db0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
-00016dc0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2033  {name}| sed -n 3
-00016dd0: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00016de0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00016df0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00016e00: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
-00016e10: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
-00016e20: 6e20 3470 207c 2067 7265 7020 2243 414e  n 4p | grep "CAN
-00016e30: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00016e40: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00016e50: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00016e60: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-00016e70: 6420 2d6e 2035 7020 7c20 6772 6570 2022  d -n 5p | grep "
-00016e80: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00016e90: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00016ea0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-00016eb0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00016ec0: 653d 6627 7b6e 616d 657d 2729 2c0a 2020  e=f'{name}'),.  
-00016ed0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-00016ee0: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-00016ef0: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
-00016f00: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-00016f10: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-00016f20: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-00016f30: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
-00016f40: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00016f50: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00016f60: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-00016f70: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
-00016f80: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-00016f90: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00016fa0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00016fb0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
-00016fc0: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
-00016fd0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00016fe0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00016ff0: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00017000: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-00017010: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00017020: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00017030: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00017040: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-00017050: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-00017060: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00017070: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00017080: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00017090: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-000170a0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-000170b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-000170c0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-000170d0: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
-000170e0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-000170f0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017100: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00017110: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
-00017120: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
-00017130: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
-00017140: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00017150: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
-00017160: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
-00017170: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
-00017180: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00017190: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-000171a0: 6e61 6765 6420 7370 6f74 206a 6f62 2077  naged spot job w
-000171b0: 6974 6820 6661 696c 6564 2073 6574 7570  ith failed setup
-000171c0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-000171d0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-000171e0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-000171f0: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-00017200: 6f74 5f66 6169 6c65 645f 7365 7475 7027  ot_failed_setup'
-00017210: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00017220: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-00017230: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
-00017240: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00017250: 6572 6963 5f63 6c6f 7564 7d20 2d79 202d  eric_cloud} -y -
-00017260: 6420 7465 7374 732f 7465 7374 5f79 616d  d tests/test_yam
-00017270: 6c73 2f66 6169 6c65 645f 7365 7475 702e  ls/failed_setup.
-00017280: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00017290: 2020 2027 736c 6565 7020 3333 3027 2c0a     'sleep 330',.
-000172a0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-000172b0: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
-000172c0: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
-000172d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000172e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-000172f0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00017300: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00017310: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
-00017320: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00017330: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00017340: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00017350: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-00017360: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-00017370: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-00017380: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
-00017390: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-000173a0: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-000173b0: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-000173c0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-000173d0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000173e0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-000173f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-00017400: 6964 7374 6163 6b20 2023 666c 7569 6473  idstack  #fluids
-00017410: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-00017420: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00017430: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00017440: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
-00017450: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
-00017460: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00017470: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00017480: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00017490: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-000174a0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-000174b0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-000174c0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000174d0: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-000174e0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-000174f0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00017500: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00017510: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00017520: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00017530: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00017540: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-00017550: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-00017560: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
-00017570: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00017580: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00017590: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-000175a0: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
-000175b0: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
-000175c0: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
-000175d0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-000175e0: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
-000175f0: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
-00017600: 7069 7065 6c69 6e65 5f66 6169 6c65 645f  pipeline_failed_
-00017610: 7365 7475 7028 6765 6e65 7269 635f 636c  setup(generic_cl
-00017620: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00017630: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
-00017640: 706f 7420 6a6f 6220 7769 7468 2066 6169  pot job with fai
-00017650: 6c65 6420 7365 7475 7020 666f 7220 6120  led setup for a 
-00017660: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
-00017670: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00017680: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00017690: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000176a0: 2020 2020 2027 7370 6f74 5f70 6970 656c       'spot_pipel
-000176b0: 696e 655f 6661 696c 6564 5f73 6574 7570  ine_failed_setup
-000176c0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000176d0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000176e0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
-000176f0: 616d 657d 202d 7920 2d64 2074 6573 7473  ame} -y -d tests
-00017700: 2f74 6573 745f 7961 6d6c 732f 6661 696c  /test_yamls/fail
-00017710: 6564 5f73 6574 7570 5f70 6970 656c 696e  ed_setup_pipelin
-00017720: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-00017730: 2020 2020 2027 736c 6565 7020 3830 3027       'sleep 800'
-00017740: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00017750: 4d61 6b65 2073 7572 6520 7468 6520 6a6f  Make sure the jo
-00017760: 6220 6661 696c 6564 2071 7569 636b 6c79  b failed quickly
-00017770: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00017780: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00017790: 547d 207c 2067 7265 7020 7b6e 616d 657d  T} | grep {name}
-000177a0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-000177b0: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
-000177c0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000177d0: 2320 5461 736b 2030 2073 686f 756c 6420  # Task 0 should 
-000177e0: 6265 2053 5543 4345 4544 4544 2e0a 2020  be SUCCEEDED..  
-000177f0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00017800: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
-00017810: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00017820: 7d7c 2073 6564 202d 6e20 3270 207c 2067  }| sed -n 2p | g
-00017830: 7265 7020 2253 5543 4345 4544 4544 2227  rep "SUCCEEDED"'
-00017840: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00017850: 5461 736b 2031 2073 686f 756c 6420 6265  Task 1 should be
-00017860: 2046 4149 4c45 445f 5345 5455 502e 0a20   FAILED_SETUP.. 
-00017870: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00017880: 504f 545f 5155 4555 455f 5741 4954 7d20  POT_QUEUE_WAIT} 
-00017890: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
-000178a0: 657d 7c20 7365 6420 2d6e 2033 7020 7c20  e}| sed -n 3p | 
-000178b0: 6772 6570 2022 4641 494c 4544 5f53 4554  grep "FAILED_SET
-000178c0: 5550 2227 2c0a 2020 2020 2020 2020 2020  UP"',.          
-000178d0: 2020 2320 5461 736b 2032 2073 686f 756c    # Task 2 shoul
-000178e0: 6420 6265 2043 414e 4345 4c4c 4544 2e0a  d be CANCELLED..
-000178f0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00017900: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00017910: 207c 2067 7265 7020 2d41 2034 207b 6e61   | grep -A 4 {na
-00017920: 6d65 7d7c 2073 6564 202d 6e20 3470 207c  me}| sed -n 4p |
-00017930: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-00017940: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00017950: 2320 5461 736b 2033 2073 686f 756c 6420  # Task 3 should 
-00017960: 6265 2043 414e 4345 4c4c 4544 2e0a 2020  be CANCELLED..  
-00017970: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00017980: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
-00017990: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-000179a0: 7d7c 2073 6564 202d 6e20 3570 207c 2067  }| sed -n 5p | g
-000179b0: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-000179c0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000179d0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-000179e0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-000179f0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-00017a00: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-00017a10: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-00017a20: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
-00017a30: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-00017a40: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-00017a50: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-00017a60: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
-00017a70: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00017a80: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00017a90: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-00017aa0: 6720 6d61 6e61 6765 6420 7370 6f74 2072  g managed spot r
-00017ab0: 6563 6f76 6572 7920 2d2d 2d2d 2d2d 2d2d  ecovery --------
-00017ac0: 2d2d 0a0a 0a40 7079 7465 7374 2e6d 6172  --...@pytest.mar
-00017ad0: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-00017ae0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00017af0: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
-00017b00: 636f 7665 7279 5f61 7773 2861 7773 5f63  covery_aws(aws_c
-00017b10: 6f6e 6669 675f 7265 6769 6f6e 293a 0a20  onfig_region):. 
-00017b20: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-00017b30: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
-00017b40: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00017b50: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00017b60: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
-00017b70: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
-00017b80: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
-00017b90: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
-00017ba0: 0a20 2020 2020 2020 206e 616d 652c 2073  .        name, s
-00017bb0: 706f 742e 5350 4f54 5f43 4c55 5354 4552  pot.SPOT_CLUSTER
-00017bc0: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
-00017bd0: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
-00017be0: 7368 3d46 616c 7365 290a 2020 2020 7265  sh=False).    re
-00017bf0: 6769 6f6e 203d 2061 7773 5f63 6f6e 6669  gion = aws_confi
-00017c00: 675f 7265 6769 6f6e 0a20 2020 2074 6573  g_region.    tes
-00017c10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00017c20: 2020 2773 706f 745f 7265 636f 7665 7279    'spot_recovery
-00017c30: 5f61 7773 272c 0a20 2020 2020 2020 205b  _aws',.        [
-00017c40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00017c50: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00017c60: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
-00017c70: 696f 6e20 7b72 6567 696f 6e7d 202d 6e20  ion {region} -n 
-00017c80: 7b6e 616d 657d 2022 6563 686f 2053 4b59  {name} "echo SKY
-00017c90: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
-00017ca0: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
-00017cb0: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
-00017cc0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00017cd0: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
-00017ce0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00017cf0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00017d00: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00017d10: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00017d20: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-00017d30: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-00017d40: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-00017d50: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-00017d60: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-00017d70: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
-00017d80: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-00017d90: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-00017da0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00017db0: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-00017dc0: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-00017dd0: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-00017de0: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-00017df0: 2020 2020 2866 2761 7773 2065 6332 2074      (f'aws ec2 t
-00017e00: 6572 6d69 6e61 7465 2d69 6e73 7461 6e63  erminate-instanc
-00017e10: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-00017e20: 696f 6e7d 202d 2d69 6e73 7461 6e63 652d  ion} --instance-
-00017e30: 6964 7320 2428 270a 2020 2020 2020 2020  ids $('.        
-00017e40: 2020 2020 2066 2761 7773 2065 6332 2064       f'aws ec2 d
-00017e50: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
-00017e60: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00017e70: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00017e80: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
-00017e90: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
-00017ea0: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
-00017eb0: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d2a  {name_on_cloud}*
-00017ec0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00017ed0: 6627 2d2d 7175 6572 7920 5265 7365 7276  f'--query Reserv
-00017ee0: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
-00017ef0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
-00017f00: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
-00017f10: 2d2d 6f75 7470 7574 2074 6578 7429 2729  --output text)')
-00017f20: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00017f30: 6c65 6570 2031 3030 272c 0a20 2020 2020  leep 100',.     
-00017f40: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00017f50: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00017f60: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-00017f70: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
-00017f80: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
-00017f90: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
-00017fa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00017fb0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00017fc0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00017fd0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00017fe0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-00017ff0: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-00018000: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
-00018010: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
-00018020: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
-00018030: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-00018040: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00018050: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-00018060: 5f54 4153 4b5f 4944 207c 2067 7265 7020  _TASK_ID | grep 
-00018070: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
-00018080: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00018090: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-000180a0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-000180b0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-000180c0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-000180d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-000180e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000180f0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-00018100: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-00018110: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00018120: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
-00018130: 795f 6763 7028 293a 0a20 2020 2022 2222  y_gcp():.    """
-00018140: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
-00018150: 7420 7265 636f 7665 7279 2e22 2222 0a20  t recovery.""". 
-00018160: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00018170: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00018180: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
-00018190: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-000181a0: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-000181b0: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
-000181c0: 2020 206e 616d 652c 2073 706f 742e 5350     name, spot.SP
-000181d0: 4f54 5f43 4c55 5354 4552 5f4e 414d 455f  OT_CLUSTER_NAME_
-000181e0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
-000181f0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
-00018200: 7365 290a 2020 2020 7a6f 6e65 203d 2027  se).    zone = '
-00018210: 7573 2d65 6173 7434 2d62 270a 2020 2020  us-east4-b'.    
-00018220: 7175 6572 795f 636d 6420 3d20 280a 2020  query_cmd = (.  
-00018230: 2020 2020 2020 6627 6763 6c6f 7564 2063        f'gcloud c
-00018240: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-00018250: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
-00018260: 0a20 2020 2020 2020 2023 2060 3a60 206d  .        # `:` m
-00018270: 6561 6e73 2070 7265 6669 7820 6d61 7463  eans prefix matc
-00018280: 682e 0a20 2020 2020 2020 2066 2722 286c  h..        f'"(l
-00018290: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
-000182a0: 722d 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f  r-name:{name_on_
-000182b0: 636c 6f75 647d 2922 2027 0a20 2020 2020  cloud})" '.     
-000182c0: 2020 2066 272d 2d7a 6f6e 6573 3d7b 7a6f     f'--zones={zo
-000182d0: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
-000182e0: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
-000182f0: 2074 6572 6d69 6e61 7465 5f63 6d64 203d   terminate_cmd =
-00018300: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
-00018310: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
-00018320: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
-00018330: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00018340: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
-00018350: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
-00018360: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
-00018370: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-00018380: 6f74 5f72 6563 6f76 6572 795f 6763 7027  ot_recovery_gcp'
-00018390: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000183a0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-000183b0: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
-000183c0: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
-000183d0: 6e65 7d20 2d6e 207b 6e61 6d65 7d20 2d2d  ne} -n {name} --
-000183e0: 6370 7573 2032 2022 6563 686f 2053 4b59  cpus 2 "echo SKY
-000183f0: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
-00018400: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
-00018410: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
-00018420: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00018430: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
-00018440: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00018450: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00018460: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00018470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00018480: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-00018490: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-000184a0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-000184b0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-000184c0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-000184d0: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
-000184e0: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-000184f0: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-00018500: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00018510: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-00018520: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-00018530: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-00018540: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-00018550: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
-00018560: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
-00018570: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
-00018580: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00018590: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-000185a0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-000185b0: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
-000185c0: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
-000185d0: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
-000185e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000185f0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00018600: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00018610: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00018620: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-00018630: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-00018640: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
-00018650: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
-00018660: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
-00018670: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-00018680: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00018690: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-000186a0: 5f54 4153 4b5f 4944 3a20 7c20 6772 6570  _TASK_ID: | grep
-000186b0: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
-000186c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000186d0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-000186e0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-000186f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00018700: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
-00018710: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00018720: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00018730: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00018740: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
-00018750: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
-00018760: 7465 7374 5f73 706f 745f 7069 7065 6c69  test_spot_pipeli
-00018770: 6e65 5f72 6563 6f76 6572 795f 6177 7328  ne_recovery_aws(
-00018780: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
-00018790: 6e29 3a0a 2020 2020 2222 2254 6573 7420  n):.    """Test 
-000187a0: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
-000187b0: 6f76 6572 7920 666f 7220 6120 7069 7065  overy for a pipe
-000187c0: 6c69 6e65 2e22 2222 0a20 2020 206e 616d  line.""".    nam
-000187d0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000187e0: 5f6e 616d 6528 290a 2020 2020 7573 6572  _name().    user
-000187f0: 5f68 6173 6820 3d20 636f 6d6d 6f6e 5f75  _hash = common_u
-00018800: 7469 6c73 2e67 6574 5f75 7365 725f 6861  tils.get_user_ha
-00018810: 7368 2829 0a20 2020 2075 7365 725f 6861  sh().    user_ha
-00018820: 7368 203d 2075 7365 725f 6861 7368 5b3a  sh = user_hash[:
-00018830: 636f 6d6d 6f6e 5f75 7469 6c73 2e55 5345  common_utils.USE
-00018840: 525f 4841 5348 5f4c 454e 4754 485f 494e  R_HASH_LENGTH_IN
-00018850: 5f43 4c55 5354 4552 5f4e 414d 455d 0a20  _CLUSTER_NAME]. 
-00018860: 2020 2072 6567 696f 6e20 3d20 6177 735f     region = aws_
-00018870: 636f 6e66 6967 5f72 6567 696f 6e0a 2020  config_region.  
-00018880: 2020 6966 2072 6567 696f 6e20 213d 2027    if region != '
-00018890: 7573 2d65 6173 742d 3227 3a0a 2020 2020  us-east-2':.    
-000188a0: 2020 2020 7079 7465 7374 2e73 6b69 7028      pytest.skip(
-000188b0: 274f 6e6c 7920 7275 6e20 7370 6f74 2070  'Only run spot p
-000188c0: 6970 656c 696e 6520 7265 636f 7665 7279  ipeline recovery
-000188d0: 2074 6573 7420 696e 2075 732d 6561 7374   test in us-east
-000188e0: 2d32 2729 0a20 2020 2074 6573 7420 3d20  -2').    test = 
-000188f0: 5465 7374 280a 2020 2020 2020 2020 2773  Test(.        's
-00018900: 706f 745f 7069 7065 6c69 6e65 5f72 6563  pot_pipeline_rec
-00018910: 6f76 6572 795f 6177 7327 2c0a 2020 2020  overy_aws',.    
-00018920: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00018930: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-00018940: 6e63 6820 2d6e 207b 6e61 6d65 7d20 7465  nch -n {name} te
-00018950: 7374 732f 7465 7374 5f79 616d 6c73 2f70  sts/test_yamls/p
-00018960: 6970 656c 696e 655f 6177 732e 7961 6d6c  ipeline_aws.yaml
-00018970: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
-00018980: 2020 2020 2020 2773 6c65 6570 2034 3030        'sleep 400
-00018990: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000189a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-000189b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-000189c0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-000189d0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-000189e0: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-000189f0: 5f49 443d 2428 736b 7920 7370 6f74 206c  _ID=$(sky spot l
-00018a00: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-00018a10: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-00018a20: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00018a30: 443a 207c 2063 7574 202d 643a 202d 6632  D: | cut -d: -f2
-00018a40: 293b 2065 6368 6f20 2224 5255 4e5f 4944  ); echo "$RUN_ID
-00018a50: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
-00018a60: 6d65 7d2d 7275 6e2d 6964 272c 0a20 2020  me}-run-id',.   
-00018a70: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-00018a80: 4453 3d24 2873 6b79 2073 706f 7420 6c6f  DS=$(sky spot lo
-00018a90: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-00018aa0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-00018ab0: 2d41 2034 2053 4b59 5049 4c4f 545f 5441  -A 4 SKYPILOT_TA
-00018ac0: 534b 5f49 4453 207c 2063 7574 202d 6422  SK_IDS | cut -d"
-00018ad0: 2922 202d 6632 293b 2065 6368 6f20 2224  )" -f2); echo "$
-00018ae0: 5255 4e5f 4944 5322 207c 2074 6565 202f  RUN_IDS" | tee /
-00018af0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00018b00: 6473 272c 0a20 2020 2020 2020 2020 2020  ds',.           
-00018b10: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
-00018b20: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-00018b30: 792e 0a20 2020 2020 2020 2020 2020 2023  y..            #
-00018b40: 2054 6865 2060 6361 7420 2e2e 2e7c 2072   The `cat ...| r
-00018b50: 6576 6020 6973 2074 6f20 7265 7472 6965  ev` is to retrie
-00018b60: 7665 2074 6865 206a 6f62 5f69 6420 6672  ve the job_id fr
-00018b70: 6f6d 2074 6865 0a20 2020 2020 2020 2020  om the.         
-00018b80: 2020 2023 2053 4b59 5049 4c4f 545f 5441     # SKYPILOT_TA
-00018b90: 534b 5f49 442c 2077 6869 6368 2067 6574  SK_ID, which get
-00018ba0: 7320 7468 6520 7365 636f 6e64 2074 6f20  s the second to 
-00018bb0: 6c61 7374 2066 6965 6c64 0a20 2020 2020  last field.     
-00018bc0: 2020 2020 2020 2023 2073 6570 6172 6174         # separat
-00018bd0: 6564 2062 7920 602d 602e 0a20 2020 2020  ed by `-`..     
-00018be0: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-00018bf0: 2020 2020 2020 2020 2066 2753 504f 545f           f'SPOT_
-00018c00: 4a4f 425f 4944 3d60 6361 7420 2f74 6d70  JOB_ID=`cat /tmp
-00018c10: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 207c  /{name}-run-id |
-00018c20: 2072 6576 207c 2027 0a20 2020 2020 2020   rev | '.       
-00018c30: 2020 2020 2020 2020 2027 6375 7420 2d64           'cut -d
-00018c40: 5c27 2d5c 2720 2d66 3220 7c20 7265 7660  \'-\' -f2 | rev`
-00018c50: 3b27 0a20 2020 2020 2020 2020 2020 2020  ;'.             
-00018c60: 2020 2066 2761 7773 2065 6332 2074 6572     f'aws ec2 ter
-00018c70: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
-00018c80: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00018c90: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
-00018ca0: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
-00018cb0: 2020 2020 2020 6627 6177 7320 6563 3220        f'aws ec2 
-00018cc0: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
-00018cd0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-00018ce0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-00018cf0: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
-00018d00: 7775 293a 2066 6978 2074 6865 206e 616d  wu): fix the nam
-00018d10: 6520 666f 7220 7370 6f74 2063 6c75 7374  e for spot clust
-00018d20: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-00018d30: 2020 2020 272d 2d66 696c 7465 7273 204e      '--filters N
-00018d40: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
-00018d50: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
-00018d60: 2a2d 247b 5350 4f54 5f4a 4f42 5f49 447d  *-${SPOT_JOB_ID}
-00018d70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00018d80: 2020 6627 2d7b 7573 6572 5f68 6173 687d    f'-{user_hash}
-00018d90: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00018da0: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
-00018db0: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
-00018dc0: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
-00018dd0: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
-00018de0: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
-00018df0: 6578 7429 2729 2c0a 2020 2020 2020 2020  ext)'),.        
-00018e00: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
-00018e10: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00018e20: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00018e30: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00018e40: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00018e50: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
-00018e60: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00018e70: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
-00018e80: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00018e90: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00018ea0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00018eb0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00018ec0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00018ed0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
-00018ee0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00018ef0: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
-00018f00: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
-00018f10: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00018f20: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-00018f30: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
-00018f40: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
-00018f50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018f60: 2752 554e 5f49 4453 3d24 2873 6b79 2073  'RUN_IDS=$(sky s
-00018f70: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-00018f80: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-00018f90: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
-00018fa0: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
-00018fb0: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
-00018fc0: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
-00018fd0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00018fe0: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
-00018ff0: 2020 2020 2020 2020 2020 2066 2764 6966             f'dif
-00019000: 6620 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  f /tmp/{name}-ru
-00019010: 6e2d 6964 7320 2f74 6d70 2f7b 6e61 6d65  n-ids /tmp/{name
-00019020: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
-00019030: 2020 2020 2020 2020 2020 2020 6627 6361              f'ca
-00019040: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
-00019050: 6e2d 6964 7320 7c20 7365 6420 2d6e 2032  n-ids | sed -n 2
-00019060: 7020 7c20 6772 6570 2060 6361 7420 2f74  p | grep `cat /t
-00019070: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-00019080: 6027 2c0a 2020 2020 2020 2020 5d2c 0a20  `',.        ],. 
-00019090: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-000190a0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-000190b0: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-000190c0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-000190d0: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
-000190e0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-000190f0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00019100: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00019110: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-00019120: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-00019130: 5f70 6970 656c 696e 655f 7265 636f 7665  _pipeline_recove
-00019140: 7279 5f67 6370 2829 3a0a 2020 2020 2222  ry_gcp():.    ""
-00019150: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-00019160: 6f74 2072 6563 6f76 6572 7920 666f 7220  ot recovery for 
-00019170: 6120 7069 7065 6c69 6e65 2e22 2222 0a20  a pipeline.""". 
-00019180: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00019190: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000191a0: 2020 7a6f 6e65 203d 2027 7573 2d65 6173    zone = 'us-eas
-000191b0: 7434 2d62 270a 2020 2020 7573 6572 5f68  t4-b'.    user_h
-000191c0: 6173 6820 3d20 636f 6d6d 6f6e 5f75 7469  ash = common_uti
-000191d0: 6c73 2e67 6574 5f75 7365 725f 6861 7368  ls.get_user_hash
-000191e0: 2829 0a20 2020 2075 7365 725f 6861 7368  ().    user_hash
-000191f0: 203d 2075 7365 725f 6861 7368 5b3a 636f   = user_hash[:co
-00019200: 6d6d 6f6e 5f75 7469 6c73 2e55 5345 525f  mmon_utils.USER_
-00019210: 4841 5348 5f4c 454e 4754 485f 494e 5f43  HASH_LENGTH_IN_C
-00019220: 4c55 5354 4552 5f4e 414d 455d 0a20 2020  LUSTER_NAME].   
-00019230: 2071 7565 7279 5f63 6d64 203d 2028 2767   query_cmd = ('g
-00019240: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
-00019250: 7374 616e 6365 7320 6c69 7374 202d 2d66  stances list --f
-00019260: 696c 7465 723d 270a 2020 2020 2020 2020  ilter='.        
-00019270: 2020 2020 2020 2020 2066 2722 286c 6162           f'"(lab
-00019280: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-00019290: 6e61 6d65 3a2a 2d24 7b7b 5350 4f54 5f4a  name:*-${{SPOT_J
-000192a0: 4f42 5f49 447d 7d2d 7b75 7365 725f 6861  OB_ID}}-{user_ha
-000192b0: 7368 7d29 2220 270a 2020 2020 2020 2020  sh})" '.        
-000192c0: 2020 2020 2020 2020 2066 272d 2d7a 6f6e           f'--zon
-000192d0: 6573 3d7b 7a6f 6e65 7d20 2d2d 666f 726d  es={zone} --form
-000192e0: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
-000192f0: 2729 0a20 2020 2074 6572 6d69 6e61 7465  ').    terminate
-00019300: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
-00019310: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-00019320: 6573 2064 656c 6574 6520 2d2d 7a6f 6e65  es delete --zone
-00019330: 3d7b 7a6f 6e65 7d27 0a20 2020 2020 2020  ={zone}'.       
-00019340: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00019350: 202d 2d71 7569 6574 2024 287b 7175 6572   --quiet $({quer
-00019360: 795f 636d 647d 2927 290a 2020 2020 7465  y_cmd})').    te
-00019370: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00019380: 2020 2027 7370 6f74 5f70 6970 656c 696e     'spot_pipelin
-00019390: 655f 7265 636f 7665 7279 5f67 6370 272c  e_recovery_gcp',
-000193a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000193b0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-000193c0: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
-000193d0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-000193e0: 6d6c 732f 7069 7065 6c69 6e65 5f67 6370  mls/pipeline_gcp
-000193f0: 2e79 616d 6c20 202d 7920 2d64 272c 0a20  .yaml  -y -d',. 
-00019400: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00019410: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
-00019420: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00019430: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00019440: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00019450: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-00019460: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00019470: 6627 5255 4e5f 4944 3d24 2873 6b79 2073  f'RUN_ID=$(sky s
-00019480: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
-00019490: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-000194a0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-000194b0: 4153 4b5f 4944 3a20 7c20 6375 7420 2d64  ASK_ID: | cut -d
-000194c0: 3a20 2d66 3229 3b20 6563 686f 2022 2452  : -f2); echo "$R
-000194d0: 554e 5f49 4422 207c 2074 6565 202f 746d  UN_ID" | tee /tm
-000194e0: 702f 7b6e 616d 657d 2d72 756e 2d69 6427  p/{name}-run-id'
-000194f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00019500: 5255 4e5f 4944 533d 2428 736b 7920 7370  RUN_IDS=$(sky sp
-00019510: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
-00019520: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
-00019530: 6772 6570 202d 4120 3420 534b 5950 494c  grep -A 4 SKYPIL
-00019540: 4f54 5f54 4153 4b5f 4944 5320 7c20 6375  OT_TASK_IDS | cu
-00019550: 7420 2d64 2229 2220 2d66 3229 3b20 6563  t -d")" -f2); ec
-00019560: 686f 2022 2452 554e 5f49 4453 2220 7c20  ho "$RUN_IDS" | 
-00019570: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
-00019580: 7275 6e2d 6964 7327 2c0a 2020 2020 2020  run-ids',.      
-00019590: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-000195a0: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-000195b0: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-000195c0: 2020 2020 2320 5468 6520 6063 6174 202e      # The `cat .
-000195d0: 2e2e 7c20 7265 7660 2069 7320 746f 2072  ..| rev` is to r
-000195e0: 6574 7269 6576 6520 7468 6520 6a6f 625f  etrieve the job_
-000195f0: 6964 2066 726f 6d20 7468 650a 2020 2020  id from the.    
-00019600: 2020 2020 2020 2020 2320 534b 5950 494c          # SKYPIL
-00019610: 4f54 5f54 4153 4b5f 4944 2c20 7768 6963  OT_TASK_ID, whic
-00019620: 6820 6765 7473 2074 6865 2073 6563 6f6e  h gets the secon
-00019630: 6420 746f 206c 6173 7420 6669 656c 640a  d to last field.
-00019640: 2020 2020 2020 2020 2020 2020 2320 7365              # se
-00019650: 7061 7261 7465 6420 6279 2060 2d60 2e0a  parated by `-`..
-00019660: 2020 2020 2020 2020 2020 2020 2866 2753              (f'S
-00019670: 504f 545f 4a4f 425f 4944 3d60 6361 7420  POT_JOB_ID=`cat 
-00019680: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00019690: 6964 207c 2072 6576 207c 2027 0a20 2020  id | rev | '.   
-000196a0: 2020 2020 2020 2020 2020 6627 6375 7420            f'cut 
-000196b0: 2d64 5c27 2d5c 2720 2d66 3220 7c20 7265  -d\'-\' -f2 | re
-000196c0: 7660 3b7b 7465 726d 696e 6174 655f 636d  v`;{terminate_cm
-000196d0: 647d 2729 2c0a 2020 2020 2020 2020 2020  d}'),.          
-000196e0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-000196f0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00019700: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00019710: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00019720: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00019730: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-00019740: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00019750: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-00019760: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00019770: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00019780: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00019790: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-000197a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000197b0: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
-000197c0: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
-000197d0: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
-000197e0: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-000197f0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00019800: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-00019810: 4c4f 545f 5441 534b 5f49 443a 207c 2067  LOT_TASK_ID: | g
-00019820: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
-00019830: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-00019840: 4e5f 4944 533d 2428 736b 7920 7370 6f74  N_IDS=$(sky spot
-00019850: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00019860: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00019870: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
-00019880: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
-00019890: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
-000198a0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
-000198b0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-000198c0: 6e2d 6964 732d 6e65 7727 2c0a 2020 2020  n-ids-new',.    
-000198d0: 2020 2020 2020 2020 6627 6469 6666 202f          f'diff /
-000198e0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-000198f0: 6473 202f 746d 702f 7b6e 616d 657d 2d72  ds /tmp/{name}-r
-00019900: 756e 2d69 6473 2d6e 6577 272c 0a20 2020  un-ids-new',.   
-00019910: 2020 2020 2020 2020 2066 2763 6174 202f           f'cat /
-00019920: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00019930: 6473 207c 2073 6564 202d 6e20 3270 207c  ds | sed -n 2p |
-00019940: 2067 7265 7020 6063 6174 202f 746d 702f   grep `cat /tmp/
-00019950: 7b6e 616d 657d 2d72 756e 2d69 6460 272c  {name}-run-id`',
-00019960: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00019970: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00019980: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00019990: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-000199a0: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-000199b0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-000199c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000199d0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000199e0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-000199f0: 2023 2046 6c75 6964 7374 6163 6b20 646f   # Fluidstack do
-00019a00: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00019a10: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00019a20: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
-00019a30: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
-00019a40: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00019a50: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00019a60: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-00019a70: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-00019a80: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-00019a90: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00019aa0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00019ab0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-00019ac0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-00019ad0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00019ae0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00019af0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-00019b00: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-00019b10: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00019b20: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00019b30: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
-00019b40: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
-00019b50: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00019b60: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00019b70: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-00019b80: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
-00019b90: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
-00019ba0: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
-00019bb0: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
-00019bc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-00019bd0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00019be0: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
-00019bf0: 795f 6465 6661 756c 745f 7265 736f 7572  y_default_resour
-00019c00: 6365 7328 6765 6e65 7269 635f 636c 6f75  ces(generic_clou
-00019c10: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00019c20: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
-00019c30: 7420 7265 636f 7665 7279 2066 6f72 2064  t recovery for d
-00019c40: 6566 6175 6c74 2072 6573 6f75 7263 6573  efault resources
-00019c50: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00019c60: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00019c70: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00019c80: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
-00019c90: 6e61 6765 642d 7370 6f74 2d72 6563 6f76  naged-spot-recov
-00019ca0: 6572 792d 6465 6661 756c 742d 7265 736f  ery-default-reso
-00019cb0: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
-00019cc0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00019cd0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-00019ce0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-00019cf0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00019d00: 7d20 2273 6c65 6570 2033 3020 2626 2073  } "sleep 30 && s
-00019d10: 7564 6f20 7368 7574 646f 776e 206e 6f77  udo shutdown now
-00019d20: 2026 2620 736c 6565 7020 3130 3030 2220   && sleep 1000" 
-00019d30: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00019d40: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
-00019d50: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00019d60: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00019d70: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00019d80: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00019d90: 2022 5255 4e4e 494e 475c 7c52 4543 4f56   "RUNNING\|RECOV
-00019da0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-00019db0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-00019dc0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-00019dd0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-00019de0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-00019df0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-00019e00: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00019e10: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00019e20: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
-00019e30: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-00019e40: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-00019e50: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
-00019e60: 756c 7469 5f6e 6f64 655f 6177 7328 6177  ulti_node_aws(aw
-00019e70: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
-00019e80: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-00019e90: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
-00019ea0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
-00019eb0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00019ec0: 6e61 6d65 2829 0a20 2020 206e 616d 655f  name().    name_
-00019ed0: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-00019ee0: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-00019ef0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00019f00: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
-00019f10: 2c20 7370 6f74 2e53 504f 545f 434c 5553  , spot.SPOT_CLUS
-00019f20: 5445 525f 4e41 4d45 5f50 5245 4649 585f  TER_NAME_PREFIX_
-00019f30: 4c45 4e47 5448 2c20 6164 645f 7573 6572  LENGTH, add_user
-00019f40: 5f68 6173 683d 4661 6c73 6529 0a20 2020  _hash=False).   
-00019f50: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
-00019f60: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
-00019f70: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00019f80: 2020 2020 2027 7370 6f74 5f72 6563 6f76       'spot_recov
-00019f90: 6572 795f 6d75 6c74 695f 6e6f 6465 5f61  ery_multi_node_a
-00019fa0: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
-00019fb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00019fc0: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-00019fd0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-00019fe0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
-00019ff0: 616d 657d 202d 2d6e 756d 2d6e 6f64 6573  ame} --num-nodes
-0001a000: 2032 2022 6563 686f 2053 4b59 5049 4c4f   2 "echo SKYPILO
-0001a010: 545f 5441 534b 5f49 443a 205c 2453 4b59  T_TASK_ID: \$SKY
-0001a020: 5049 4c4f 545f 5441 534b 5f49 443b 2073  PILOT_TASK_ID; s
-0001a030: 6c65 6570 2031 3830 3022 2020 2d79 202d  leep 1800"  -y -
-0001a040: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0001a050: 2773 6c65 6570 2034 3530 272c 0a20 2020  'sleep 450',.   
-0001a060: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001a070: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001a080: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001a090: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-0001a0a0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-0001a0b0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
-0001a0c0: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-0001a0d0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-0001a0e0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-0001a0f0: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
-0001a100: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
-0001a110: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
-0001a120: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-0001a130: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
-0001a140: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
-0001a150: 6520 776f 726b 6572 206d 616e 7561 6c6c  e worker manuall
-0001a160: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
-0001a170: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
-0001a180: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
-0001a190: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001a1a0: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-0001a1b0: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
-0001a1c0: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
-0001a1d0: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
-0001a1e0: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
-0001a1f0: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-0001a200: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
-0001a210: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-0001a220: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-0001a230: 5f6f 6e5f 636c 6f75 647d 2a20 270a 2020  _on_cloud}* '.  
-0001a240: 2020 2020 2020 2020 2020 2027 4e61 6d65             'Name
-0001a250: 3d74 6167 3a72 6179 2d6e 6f64 652d 7479  =tag:ray-node-ty
-0001a260: 7065 2c56 616c 7565 733d 776f 726b 6572  pe,Values=worker
-0001a270: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001a280: 6627 2d2d 7175 6572 7920 5265 7365 7276  f'--query Reserv
-0001a290: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
-0001a2a0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
-0001a2b0: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
-0001a2c0: 2d2d 6f75 7470 7574 2074 6578 7429 2729  --output text)')
-0001a2d0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001a2e0: 6c65 6570 2035 3027 2c0a 2020 2020 2020  leep 50',.      
-0001a2f0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001a300: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001a310: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001a320: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-0001a330: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-0001a340: 2020 2020 2027 736c 6565 7020 3536 3027       'sleep 560'
-0001a350: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001a360: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001a370: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001a380: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001a390: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-0001a3a0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-0001a3b0: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
-0001a3c0: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
-0001a3d0: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
-0001a3e0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
-0001a3f0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-0001a400: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
-0001a410: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
-0001a420: 3a20 2d66 3220 7c20 6772 6570 2022 2452  : -f2 | grep "$R
-0001a430: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-0001a440: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-0001a450: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-0001a460: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-0001a470: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-0001a480: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
-0001a490: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0001a4a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0001a4b0: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
-0001a4c0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001a4d0: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-0001a4e0: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
-0001a4f0: 756c 7469 5f6e 6f64 655f 6763 7028 293a  ulti_node_gcp():
-0001a500: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
-0001a510: 6167 6564 2073 706f 7420 7265 636f 7665  aged spot recove
-0001a520: 7279 2e22 2222 0a20 2020 206e 616d 6520  ry.""".    name 
-0001a530: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001a540: 616d 6528 290a 2020 2020 6e61 6d65 5f6f  ame().    name_o
-0001a550: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
-0001a560: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-0001a570: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-0001a580: 6428 0a20 2020 2020 2020 206e 616d 652c  d(.        name,
-0001a590: 2073 706f 742e 5350 4f54 5f43 4c55 5354   spot.SPOT_CLUST
-0001a5a0: 4552 5f4e 414d 455f 5052 4546 4958 5f4c  ER_NAME_PREFIX_L
-0001a5b0: 454e 4754 482c 2061 6464 5f75 7365 725f  ENGTH, add_user_
-0001a5c0: 6861 7368 3d46 616c 7365 290a 2020 2020  hash=False).    
-0001a5d0: 7a6f 6e65 203d 2027 7573 2d77 6573 7432  zone = 'us-west2
-0001a5e0: 2d61 270a 2020 2020 2320 5573 6520 273a  -a'.    # Use ':
-0001a5f0: 2720 746f 206d 6174 6368 2061 7320 7468  ' to match as th
-0001a600: 6520 636c 7573 7465 7220 6e61 6d65 2077  e cluster name w
-0001a610: 696c 6c20 636f 6e74 6169 6e20 7468 6520  ill contain the 
-0001a620: 7375 6666 6978 2077 6974 6820 6a6f 6220  suffix with job 
-0001a630: 6964 0a20 2020 2071 7565 7279 5f63 6d64  id.    query_cmd
-0001a640: 203d 2028 0a20 2020 2020 2020 2066 2767   = (.        f'g
-0001a650: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
-0001a660: 7374 616e 6365 7320 6c69 7374 202d 2d66  stances list --f
-0001a670: 696c 7465 723d 270a 2020 2020 2020 2020  ilter='.        
-0001a680: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
-0001a690: 6c75 7374 6572 2d6e 616d 653a 7b6e 616d  luster-name:{nam
-0001a6a0: 655f 6f6e 5f63 6c6f 7564 7d20 414e 4420  e_on_cloud} AND 
-0001a6b0: 270a 2020 2020 2020 2020 6627 6c61 6265  '.        f'labe
-0001a6c0: 6c73 2e72 6179 2d6e 6f64 652d 7479 7065  ls.ray-node-type
-0001a6d0: 3d77 6f72 6b65 7229 2220 2d2d 7a6f 6e65  =worker)" --zone
-0001a6e0: 733d 7b7a 6f6e 657d 202d 2d66 6f72 6d61  s={zone} --forma
-0001a6f0: 743d 2276 616c 7565 286e 616d 6529 2227  t="value(name)"'
-0001a700: 290a 2020 2020 7465 726d 696e 6174 655f  ).    terminate_
-0001a710: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
-0001a720: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
-0001a730: 7320 6465 6c65 7465 202d 2d7a 6f6e 653d  s delete --zone=
-0001a740: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
-0001a750: 2020 2020 2020 2020 2020 2020 2066 2720               f' 
-0001a760: 2d2d 7175 6965 7420 2428 7b71 7565 7279  --quiet $({query
-0001a770: 5f63 6d64 7d29 2729 0a20 2020 2074 6573  _cmd})').    tes
-0001a780: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001a790: 2020 2773 706f 745f 7265 636f 7665 7279    'spot_recovery
-0001a7a0: 5f6d 756c 7469 5f6e 6f64 655f 6763 7027  _multi_node_gcp'
-0001a7b0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0001a7c0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-0001a7d0: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
-0001a7e0: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
-0001a7f0: 6e65 7d20 2d6e 207b 6e61 6d65 7d20 2d2d  ne} -n {name} --
-0001a800: 6e75 6d2d 6e6f 6465 7320 3220 2265 6368  num-nodes 2 "ech
-0001a810: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
-0001a820: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
-0001a830: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
-0001a840: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
-0001a850: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001a860: 3430 3027 2c0a 2020 2020 2020 2020 2020  400',.          
-0001a870: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001a880: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001a890: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001a8a0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-0001a8b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001a8c0: 5255 4e5f 4944 3d24 2873 6b79 2073 706f  RUN_ID=$(sky spo
-0001a8d0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-0001a8e0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-0001a8f0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-0001a900: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
-0001a910: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-0001a920: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
-0001a930: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
-0001a940: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
-0001a950: 6d69 6e61 7465 2074 6865 2077 6f72 6b65  minate the worke
-0001a960: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-0001a970: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
-0001a980: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
-0001a990: 2020 2027 736c 6565 7020 3530 272c 0a20     'sleep 50',. 
-0001a9a0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001a9b0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001a9c0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001a9d0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001a9e0: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-0001a9f0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001aa00: 2034 3230 272c 0a20 2020 2020 2020 2020   420',.         
-0001aa10: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0001aa20: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001aa30: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-0001aa40: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-0001aa50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001aa60: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
-0001aa70: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-0001aa80: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
-0001aa90: 2073 6b79 2073 706f 7420 6c6f 6773 202d   sky spot logs -
-0001aaa0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-0001aab0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-0001aac0: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
-0001aad0: 7574 202d 643a 202d 6632 207c 2067 7265  ut -d: -f2 | gre
-0001aae0: 7020 2224 5255 4e5f 4944 2227 2c0a 2020  p "$RUN_ID"',.  
-0001aaf0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001ab00: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-0001ab10: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001ab20: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001ab30: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
-0001ab40: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0001ab50: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0001ab60: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-0001ab70: 7773 0a40 7079 7465 7374 2e6d 6172 6b2e  ws.@pytest.mark.
-0001ab80: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
-0001ab90: 2074 6573 745f 7370 6f74 5f63 616e 6365   test_spot_cance
-0001aba0: 6c6c 6174 696f 6e5f 6177 7328 6177 735f  llation_aws(aws_
-0001abb0: 636f 6e66 6967 5f72 6567 696f 6e29 3a0a  config_region):.
-0001abc0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001abd0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001abe0: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
-0001abf0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001ac00: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001ac10: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001ac20: 2020 2020 6e61 6d65 2c20 7370 6f74 2e53      name, spot.S
-0001ac30: 504f 545f 434c 5553 5445 525f 4e41 4d45  POT_CLUSTER_NAME
-0001ac40: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
-0001ac50: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
-0001ac60: 6c73 6529 0a20 2020 206e 616d 655f 325f  lse).    name_2_
-0001ac70: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-0001ac80: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-0001ac90: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-0001aca0: 7564 280a 2020 2020 2020 2020 6627 7b6e  ud(.        f'{n
-0001acb0: 616d 657d 2d32 272c 2073 706f 742e 5350  ame}-2', spot.SP
-0001acc0: 4f54 5f43 4c55 5354 4552 5f4e 414d 455f  OT_CLUSTER_NAME_
-0001acd0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
-0001ace0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
-0001acf0: 7365 290a 2020 2020 6e61 6d65 5f33 5f6f  se).    name_3_o
-0001ad00: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
-0001ad10: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-0001ad20: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-0001ad30: 6428 0a20 2020 2020 2020 2066 277b 6e61  d(.        f'{na
-0001ad40: 6d65 7d2d 3327 2c20 7370 6f74 2e53 504f  me}-3', spot.SPO
-0001ad50: 545f 434c 5553 5445 525f 4e41 4d45 5f50  T_CLUSTER_NAME_P
-0001ad60: 5245 4649 585f 4c45 4e47 5448 2c20 6164  REFIX_LENGTH, ad
-0001ad70: 645f 7573 6572 5f68 6173 683d 4661 6c73  d_user_hash=Fals
-0001ad80: 6529 0a20 2020 2072 6567 696f 6e20 3d20  e).    region = 
-0001ad90: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
-0001ada0: 6e0a 2020 2020 7465 7374 203d 2054 6573  n.    test = Tes
-0001adb0: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
-0001adc0: 5f63 616e 6365 6c6c 6174 696f 6e5f 6177  _cancellation_aw
-0001add0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-0001ade0: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
-0001adf0: 2063 616e 6365 6c6c 6174 696f 6e20 6475   cancellation du
-0001ae00: 7269 6e67 2073 706f 7420 636c 7573 7465  ring spot cluste
-0001ae10: 7220 6265 696e 6720 6c61 756e 6368 6564  r being launched
-0001ae20: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0001ae30: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-0001ae40: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
-0001ae50: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d6e  gion {region} -n
-0001ae60: 207b 6e61 6d65 7d20 2273 6c65 6570 2031   {name} "sleep 1
-0001ae70: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
-0001ae80: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001ae90: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-0001aea0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001aeb0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001aec0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001aed0: 2067 7265 7020 2253 5441 5254 494e 4722   grep "STARTING"
-0001aee0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-0001aef0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-0001af00: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-0001af10: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-0001af20: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0001af30: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001af40: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001af50: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001af60: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001af70: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-0001af80: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-0001af90: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-0001afa0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001afb0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-0001afc0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001afd0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001afe0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-0001aff0: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
-0001b000: 3d24 2861 7773 2065 6332 2064 6573 6372  =$(aws ec2 descr
-0001b010: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-0001b020: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001b030: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-0001b040: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
-0001b050: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
-0001b060: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
-0001b070: 655f 6f6e 5f63 6c6f 7564 7d2d 2a20 270a  e_on_cloud}-* '.
-0001b080: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001b090: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
-0001b0a0: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
-0001b0b0: 5d2e 5374 6174 655b 5d2e 4e61 6d65 2027  ].State[].Name '
-0001b0c0: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
-0001b0d0: 2d6f 7574 7075 7420 7465 7874 2920 2626  -output text) &&
-0001b0e0: 2065 6368 6f20 2224 7322 2026 2620 6563   echo "$s" && ec
-0001b0f0: 686f 3b20 5b5b 202d 7a20 2224 7322 205d  ho; [[ -z "$s" ]
-0001b100: 5d20 7c7c 205b 5b20 2224 7322 203d 2022  ] || [[ "$s" = "
-0001b110: 7465 726d 696e 6174 6564 2220 5d5d 207c  terminated" ]] |
-0001b120: 7c20 5b5b 2022 2473 2220 3d20 2273 6875  | [[ "$s" = "shu
-0001b130: 7474 696e 672d 646f 776e 2220 5d5d 270a  tting-down" ]]'.
-0001b140: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0001b150: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
-0001b160: 7420 6361 6e63 656c 6c69 6e67 2074 6865  t cancelling the
-0001b170: 2073 706f 7420 636c 7573 7465 7220 6475   spot cluster du
-0001b180: 7269 6e67 2073 706f 7420 6a6f 6220 6265  ring spot job be
-0001b190: 696e 6720 7365 7475 702e 0a20 2020 2020  ing setup..     
-0001b1a0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-0001b1b0: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
-0001b1c0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001b1d0: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001b1e0: 2d32 2074 6573 7473 2f74 6573 745f 7961  -2 tests/test_ya
-0001b1f0: 6d6c 732f 7465 7374 5f6c 6f6e 675f 7365  mls/test_long_se
-0001b200: 7475 702e 7961 6d6c 2020 2d79 202d 6427  tup.yaml  -y -d'
-0001b210: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001b220: 6c65 6570 2033 3030 272c 0a20 2020 2020  leep 300',.     
-0001b230: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-0001b240: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-0001b250: 6a6f 625f 6e61 6d65 3d66 277b 6e61 6d65  job_name=f'{name
-0001b260: 7d2d 3227 292c 0a20 2020 2020 2020 2020  }-2'),.         
-0001b270: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0001b280: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001b290: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001b2a0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-0001b2b0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001b2c0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-0001b2d0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001b2e0: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0001b2f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001b300: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001b310: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001b320: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
-0001b330: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
-0001b340: 272c 0a20 2020 2020 2020 2020 2020 2028  ',.            (
-0001b350: 6627 733d 2428 6177 7320 6563 3220 6465  f's=$(aws ec2 de
-0001b360: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
-0001b370: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001b380: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-0001b390: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
-0001b3a0: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
-0001b3b0: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
-0001b3c0: 6e61 6d65 5f32 5f6f 6e5f 636c 6f75 647d  name_2_on_cloud}
-0001b3d0: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
-0001b3e0: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
-0001b3f0: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
-0001b400: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
-0001b410: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
-0001b420: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-0001b430: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
-0001b440: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
-0001b450: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
-0001b460: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
-0001b470: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
-0001b480: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
-0001b490: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
-0001b4a0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0001b4b0: 2320 5465 7374 2063 616e 6365 6c6c 6174  # Test cancellat
-0001b4c0: 696f 6e20 6475 7269 6e67 2073 706f 7420  ion during spot 
-0001b4d0: 6a6f 6220 6973 2072 6563 6f76 6572 696e  job is recoverin
-0001b4e0: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
-0001b4f0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-0001b500: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-0001b510: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-0001b520: 6e20 7b6e 616d 657d 2d33 2022 736c 6565  n {name}-3 "slee
-0001b530: 7020 3130 3030 2220 202d 7920 2d64 272c  p 1000"  -y -d',
-0001b540: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001b550: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
-0001b560: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001b570: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001b580: 207b 6e61 6d65 7d2d 3320 7c20 6865 6164   {name}-3 | head
-0001b590: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-0001b5a0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-0001b5b0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
-0001b5c0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
-0001b5d0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
-0001b5e0: 2020 2866 2761 7773 2065 6332 2074 6572    (f'aws ec2 ter
-0001b5f0: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
-0001b600: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001b610: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
-0001b620: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
-0001b630: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
-0001b640: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-0001b650: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001b660: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0001b670: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
-0001b680: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-0001b690: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
-0001b6a0: 616d 655f 335f 6f6e 5f63 6c6f 7564 7d2d  ame_3_on_cloud}-
-0001b6b0: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
-0001b6c0: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
-0001b6d0: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-0001b6e0: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
-0001b6f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001b700: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
-0001b710: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-0001b720: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0001b730: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001b740: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001b750: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-0001b760: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001b770: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-0001b780: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
-0001b790: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001b7a0: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
-0001b7b0: 6d65 7d2d 3327 292c 0a20 2020 2020 2020  me}-3'),.       
-0001b7c0: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-0001b7d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001b7e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001b7f0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0001b800: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001b810: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
-0001b820: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0001b830: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-0001b840: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-0001b850: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001b860: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001b870: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
-0001b880: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-0001b890: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001b8a0: 2023 2054 6865 2063 6c75 7374 6572 2073   # The cluster s
-0001b8b0: 686f 756c 6420 6265 2074 6572 6d69 6e61  hould be termina
-0001b8c0: 7465 6420 2873 6875 7474 696e 672d 646f  ted (shutting-do
-0001b8d0: 776e 2920 6166 7465 7220 6361 6e63 656c  wn) after cancel
-0001b8e0: 6c61 7469 6f6e 2e20 5765 2064 6f6e 2774  lation. We don't
-0001b8f0: 2075 7365 2074 6865 2060 3d60 206f 7065   use the `=` ope
-0001b900: 7261 746f 7220 6865 7265 2062 6563 6175  rator here becau
-0001b910: 7365 0a20 2020 2020 2020 2020 2020 2023  se.            #
-0001b920: 2074 6865 7265 2063 616e 2062 6520 6d75   there can be mu
-0001b930: 6c74 6970 6c65 2056 4d20 7769 7468 2074  ltiple VM with t
-0001b940: 6865 2073 616d 6520 6e61 6d65 2064 7565  he same name due
-0001b950: 2074 6f20 7468 6520 7265 636f 7665 7279   to the recovery
-0001b960: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
-0001b970: 2773 3d24 2861 7773 2065 6332 2064 6573  's=$(aws ec2 des
-0001b980: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-0001b990: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0001b9a0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0001b9b0: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
-0001b9c0: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-0001b9d0: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
-0001b9e0: 616d 655f 335f 6f6e 5f63 6c6f 7564 7d2d  ame_3_on_cloud}-
-0001b9f0: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
-0001ba00: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
-0001ba10: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-0001ba20: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
-0001ba30: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
-0001ba40: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-0001ba50: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-0001ba60: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
-0001ba70: 7322 205d 5d20 7c7c 2065 6368 6f20 2224  s" ]] || echo "$
-0001ba80: 7322 207c 2067 7265 7020 2d76 202d 4520  s" | grep -v -E 
-0001ba90: 2270 656e 6469 6e67 7c72 756e 6e69 6e67  "pending|running
-0001baa0: 7c73 746f 7070 6564 7c73 746f 7070 696e  |stopped|stoppin
-0001bab0: 6722 270a 2020 2020 2020 2020 2020 2020  g"'.            
-0001bac0: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
-0001bad0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-0001bae0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
-0001baf0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001bb00: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-0001bb10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-0001bb20: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-0001bb30: 6573 745f 7370 6f74 5f63 616e 6365 6c6c  est_spot_cancell
-0001bb40: 6174 696f 6e5f 6763 7028 293a 0a20 2020  ation_gcp():.   
-0001bb50: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0001bb60: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0001bb70: 6e61 6d65 5f33 203d 2066 277b 6e61 6d65  name_3 = f'{name
-0001bb80: 7d2d 3327 0a20 2020 206e 616d 655f 335f  }-3'.    name_3_
-0001bb90: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-0001bba0: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-0001bbb0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-0001bbc0: 7564 280a 2020 2020 2020 2020 6e61 6d65  ud(.        name
-0001bbd0: 5f33 2c20 7370 6f74 2e53 504f 545f 434c  _3, spot.SPOT_CL
-0001bbe0: 5553 5445 525f 4e41 4d45 5f50 5245 4649  USTER_NAME_PREFI
-0001bbf0: 585f 4c45 4e47 5448 2c20 6164 645f 7573  X_LENGTH, add_us
-0001bc00: 6572 5f68 6173 683d 4661 6c73 6529 0a20  er_hash=False). 
-0001bc10: 2020 207a 6f6e 6520 3d20 2775 732d 7765     zone = 'us-we
-0001bc20: 7374 332d 6227 0a20 2020 2071 7565 7279  st3-b'.    query
-0001bc30: 5f73 7461 7465 5f63 6d64 203d 2028 0a20  _state_cmd = (. 
-0001bc40: 2020 2020 2020 2027 6763 6c6f 7564 2063         'gcloud c
-0001bc50: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-0001bc60: 206c 6973 7420 270a 2020 2020 2020 2020   list '.        
-0001bc70: 6627 2d2d 6669 6c74 6572 3d22 286c 6162  f'--filter="(lab
-0001bc80: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-0001bc90: 6e61 6d65 3a7b 6e61 6d65 5f33 5f6f 6e5f  name:{name_3_on_
-0001bca0: 636c 6f75 647d 2922 2027 0a20 2020 2020  cloud})" '.     
-0001bcb0: 2020 2027 2d2d 666f 726d 6174 3d22 7661     '--format="va
-0001bcc0: 6c75 6528 7374 6174 7573 2922 2729 0a20  lue(status)"'). 
-0001bcd0: 2020 2071 7565 7279 5f63 6d64 203d 2028     query_cmd = (
-0001bce0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
-0001bcf0: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
-0001bd00: 2d2d 6669 6c74 6572 3d27 0a20 2020 2020  --filter='.     
-0001bd10: 2020 2020 2020 2020 2020 2020 6627 2228              f'"(
-0001bd20: 6c61 6265 6c73 2e72 6179 2d63 6c75 7374  labels.ray-clust
-0001bd30: 6572 2d6e 616d 653a 7b6e 616d 655f 335f  er-name:{name_3_
-0001bd40: 6f6e 5f63 6c6f 7564 7d29 2220 270a 2020  on_cloud})" '.  
-0001bd50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001bd60: 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20  '--zones={zone} 
-0001bd70: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
-0001bd80: 6e61 6d65 2922 2729 0a20 2020 2074 6572  name)"').    ter
-0001bd90: 6d69 6e61 7465 5f63 6d64 203d 2028 6627  minate_cmd = (f'
-0001bda0: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-0001bdb0: 6e73 7461 6e63 6573 2064 656c 6574 6520  nstances delete 
-0001bdc0: 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27 0a20  --zone={zone}'. 
-0001bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bde0: 2020 2020 6627 202d 2d71 7569 6574 2024      f' --quiet $
-0001bdf0: 287b 7175 6572 795f 636d 647d 2927 290a  ({query_cmd})').
-0001be00: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0001be10: 0a20 2020 2020 2020 2027 7370 6f74 5f63  .        'spot_c
-0001be20: 616e 6365 6c6c 6174 696f 6e5f 6763 7027  ancellation_gcp'
-0001be30: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0001be40: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
-0001be50: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
-0001be60: 6e67 2073 706f 7420 636c 7573 7465 7220  ng spot cluster 
-0001be70: 6265 696e 6720 6c61 756e 6368 6564 2e0a  being launched..
-0001be80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001be90: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
-0001bea0: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
-0001beb0: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
-0001bec0: 7d20 2273 6c65 6570 2031 3030 3022 2020  } "sleep 1000"  
-0001bed0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-0001bee0: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
-0001bef0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001bf00: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001bf10: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0001bf20: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001bf30: 2253 5441 5254 494e 4722 272c 0a20 2020  "STARTING"',.   
-0001bf40: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
-0001bf50: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001bf60: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-0001bf70: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001bf80: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0001bf90: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001bfa0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001bfb0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-0001bfc0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0001bfd0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-0001bfe0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001bff0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0001c000: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001c010: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001c020: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-0001c030: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
-0001c040: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001c050: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-0001c060: 6365 6c6c 696e 6720 7468 6520 7370 6f74  celling the spot
-0001c070: 2063 6c75 7374 6572 2064 7572 696e 6720   cluster during 
-0001c080: 7370 6f74 206a 6f62 2062 6569 6e67 2073  spot job being s
-0001c090: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
-0001c0a0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-0001c0b0: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
-0001c0c0: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
-0001c0d0: 207b 6e61 6d65 7d2d 3220 7465 7374 732f   {name}-2 tests/
-0001c0e0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-0001c0f0: 6c6f 6e67 5f73 6574 7570 2e79 616d 6c20  long_setup.yaml 
-0001c100: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-0001c110: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
-0001c120: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
-0001c130: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-0001c140: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-0001c150: 6627 7b6e 616d 657d 2d32 2729 2c0a 2020  f'{name}-2'),.  
-0001c160: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001c170: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-0001c180: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001c190: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001c1a0: 657d 2d32 207c 2068 6561 6420 2d6e 3120  e}-2 | head -n1 
-0001c1b0: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
-0001c1c0: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
-0001c1d0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001c1e0: 6565 7020 3132 3027 2c0a 2020 2020 2020  eep 120',.      
-0001c1f0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0001c200: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001c210: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
-0001c220: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
-0001c230: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001c240: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-0001c250: 6365 6c6c 6174 696f 6e20 6475 7269 6e67  cellation during
-0001c260: 2073 706f 7420 6a6f 6220 6973 2072 6563   spot job is rec
-0001c270: 6f76 6572 696e 672e 0a20 2020 2020 2020  overing..       
-0001c280: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-0001c290: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
-0001c2a0: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-0001c2b0: 202d 6e20 7b6e 616d 657d 2d33 2022 736c   -n {name}-3 "sl
-0001c2c0: 6565 7020 3130 3030 2220 202d 7920 2d64  eep 1000"  -y -d
-0001c2d0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001c2e0: 736c 6565 7020 3330 3027 2c0a 2020 2020  sleep 300',.    
-0001c2f0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0001c300: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001c310: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-0001c320: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001c330: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0001c340: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-0001c350: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-0001c360: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-0001c370: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
-0001c380: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
-0001c390: 736c 6565 7020 3830 272c 0a20 2020 2020  sleep 80',.     
-0001c3a0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001c3b0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001c3c0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
-0001c3d0: 6420 2d6e 3120 7c20 6772 6570 2022 5245  d -n1 | grep "RE
-0001c3e0: 434f 5645 5249 4e47 2227 2c0a 2020 2020  COVERING"',.    
-0001c3f0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-0001c400: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0001c410: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
-0001c420: 657d 2d33 2729 2c0a 2020 2020 2020 2020  e}-3'),.        
-0001c430: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-0001c440: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001c450: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001c460: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0001c470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001c480: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-0001c490: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001c4a0: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-0001c4b0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001c4c0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001c4d0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001c4e0: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
-0001c4f0: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-0001c500: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001c510: 2320 5468 6520 636c 7573 7465 7220 7368  # The cluster sh
-0001c520: 6f75 6c64 2062 6520 7465 726d 696e 6174  ould be terminat
-0001c530: 6564 2028 5354 4f50 5049 4e47 2920 6166  ed (STOPPING) af
-0001c540: 7465 7220 6361 6e63 656c 6c61 7469 6f6e  ter cancellation
-0001c550: 2e20 5765 2064 6f6e 2774 2075 7365 2074  . We don't use t
-0001c560: 6865 2060 3d60 206f 7065 7261 746f 7220  he `=` operator 
-0001c570: 6865 7265 2062 6563 6175 7365 0a20 2020  here because.   
-0001c580: 2020 2020 2020 2020 2023 2074 6865 7265           # there
-0001c590: 2063 616e 2062 6520 6d75 6c74 6970 6c65   can be multiple
-0001c5a0: 2056 4d20 7769 7468 2074 6865 2073 616d   VM with the sam
-0001c5b0: 6520 6e61 6d65 2064 7565 2074 6f20 7468  e name due to th
-0001c5c0: 6520 7265 636f 7665 7279 2e0a 2020 2020  e recovery..    
-0001c5d0: 2020 2020 2020 2020 2866 2773 3d24 287b          (f's=$({
-0001c5e0: 7175 6572 795f 7374 6174 655f 636d 647d  query_state_cmd}
-0001c5f0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-0001c600: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
-0001c610: 7322 205d 5d20 7c7c 2065 6368 6f20 2224  s" ]] || echo "$
-0001c620: 7322 207c 2067 7265 7020 2d76 202d 4520  s" | grep -v -E 
-0001c630: 2250 524f 5649 5349 4f4e 494e 477c 5354  "PROVISIONING|ST
-0001c640: 4147 494e 477c 5255 4e4e 494e 477c 5245  AGING|RUNNING|RE
-0001c650: 5041 4952 494e 477c 5445 524d 494e 4154  PAIRING|TERMINAT
-0001c660: 4544 7c53 5553 5045 4e44 494e 477c 5355  ED|SUSPENDING|SU
-0001c670: 5350 454e 4445 447c 5355 5350 454e 4445  SPENDED|SUSPENDE
-0001c680: 4422 270a 2020 2020 2020 2020 2020 2020  D"'.            
-0001c690: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
-0001c6a0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-0001c6b0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
-0001c6c0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001c6d0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0001c6e0: 7469 6e67 2073 746f 7261 6765 2066 6f72  ting storage for
-0001c6f0: 206d 616e 6167 6564 2073 706f 7420 2d2d   managed spot --
-0001c700: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0001c710: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0001c720: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
-0001c730: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
-0001c740: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-0001c750: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-0001c760: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
-0001c770: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001c780: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-0001c790: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0001c7a0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-0001c7b0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-0001c7c0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001c7d0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001c7e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-0001c7f0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
-0001c800: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0001c810: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-0001c820: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-0001c830: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-0001c840: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-0001c850: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-0001c860: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-0001c870: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-0001c880: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-0001c890: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001c8a0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001c8b0: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
-0001c8c0: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
-0001c8d0: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
-0001c8e0: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
-0001c8f0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001c900: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-0001c910: 6566 2074 6573 745f 7370 6f74 5f73 746f  ef test_spot_sto
-0001c920: 7261 6765 2867 656e 6572 6963 5f63 6c6f  rage(generic_clo
-0001c930: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-0001c940: 2254 6573 7420 7374 6f72 6167 6520 7769  "Test storage wi
-0001c950: 7468 206d 616e 6167 6564 2073 706f 7422  th managed spot"
-0001c960: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001c970: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001c980: 290a 2020 2020 7961 6d6c 5f73 7472 203d  ).    yaml_str =
-0001c990: 2070 6174 686c 6962 2e50 6174 6828 0a20   pathlib.Path(. 
-0001c9a0: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
-0001c9b0: 2f6d 616e 6167 6564 5f73 706f 745f 7769  /managed_spot_wi
-0001c9c0: 7468 5f73 746f 7261 6765 2e79 616d 6c27  th_storage.yaml'
-0001c9d0: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
-0001c9e0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
-0001c9f0: 2066 2773 6b79 2d74 6573 742d 7b69 6e74   f'sky-test-{int
-0001ca00: 2874 696d 652e 7469 6d65 2829 297d 270a  (time.time())}'.
-0001ca10: 0a20 2020 2023 2041 6c73 6f20 7065 7266  .    # Also perf
-0001ca20: 6f72 6d20 7265 6769 6f6e 2074 6573 7469  orm region testi
-0001ca30: 6e67 2066 6f72 2062 7563 6b65 7420 6372  ng for bucket cr
-0001ca40: 6561 7469 6f6e 2074 6f20 7661 6c69 6461  eation to valida
-0001ca50: 7465 2069 6620 6275 636b 6574 7320 6172  te if buckets ar
-0001ca60: 650a 2020 2020 2320 6372 6561 7465 6420  e.    # created 
-0001ca70: 696e 2074 6865 2063 6f72 7265 6374 2072  in the correct r
-0001ca80: 6567 696f 6e20 616e 6420 636f 7272 6563  egion and correc
-0001ca90: 746c 7920 6d6f 756e 7465 6420 696e 2073  tly mounted in s
-0001caa0: 706f 7420 6a6f 6273 2e0a 2020 2020 2320  pot jobs..    # 
-0001cab0: 486f 7765 7665 722c 2077 6520 696e 6a65  However, we inje
-0001cac0: 6374 2074 6869 7320 7465 7374 696e 6720  ct this testing 
-0001cad0: 6f6e 6c79 2066 6f72 2041 5753 2061 6e64  only for AWS and
-0001cae0: 2047 4350 2073 696e 6365 2074 6865 7920   GCP since they 
-0001caf0: 6172 6520 7468 650a 2020 2020 2320 7375  are the.    # su
-0001cb00: 7070 6f72 7465 6420 6f62 6a65 6374 2073  pported object s
-0001cb10: 746f 7261 6765 2070 726f 7669 6465 7273  torage providers
-0001cb20: 2069 6e20 536b 7950 696c 6f74 2e0a 2020   in SkyPilot..  
-0001cb30: 2020 7265 6769 6f6e 5f66 6c61 6720 3d20    region_flag = 
-0001cb40: 2727 0a20 2020 2072 6567 696f 6e5f 7661  ''.    region_va
-0001cb50: 6c69 6461 7469 6f6e 5f63 6d64 203d 2027  lidation_cmd = '
-0001cb60: 7472 7565 270a 2020 2020 6966 2067 656e  true'.    if gen
-0001cb70: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
-0001cb80: 7773 273a 0a20 2020 2020 2020 2072 6567  ws':.        reg
-0001cb90: 696f 6e20 3d20 2765 752d 6365 6e74 7261  ion = 'eu-centra
-0001cba0: 6c2d 3127 0a20 2020 2020 2020 2072 6567  l-1'.        reg
-0001cbb0: 696f 6e5f 666c 6167 203d 2066 2720 2d2d  ion_flag = f' --
-0001cbc0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d27  region {region}'
-0001cbd0: 0a20 2020 2020 2020 2072 6567 696f 6e5f  .        region_
-0001cbe0: 636d 6420 3d20 5465 7374 5374 6f72 6167  cmd = TestStorag
-0001cbf0: 6557 6974 6843 7265 6465 6e74 6961 6c73  eWithCredentials
-0001cc00: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
-0001cc10: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0001cc20: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0001cc30: 7065 2e53 332c 2073 746f 7261 6765 5f6e  pe.S3, storage_n
-0001cc40: 616d 6529 0a20 2020 2020 2020 2072 6567  ame).        reg
-0001cc50: 696f 6e5f 7661 6c69 6461 7469 6f6e 5f63  ion_validation_c
-0001cc60: 6d64 203d 2066 277b 7265 6769 6f6e 5f63  md = f'{region_c
-0001cc70: 6d64 7d20 7c20 6772 6570 207b 7265 6769  md} | grep {regi
-0001cc80: 6f6e 7d27 0a20 2020 2065 6c69 6620 6765  on}'.    elif ge
-0001cc90: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
-0001cca0: 6763 7027 3a0a 2020 2020 2020 2020 7265  gcp':.        re
-0001ccb0: 6769 6f6e 203d 2027 7573 2d77 6573 7432  gion = 'us-west2
-0001ccc0: 270a 2020 2020 2020 2020 7265 6769 6f6e  '.        region
-0001ccd0: 5f66 6c61 6720 3d20 6627 202d 2d72 6567  _flag = f' --reg
-0001cce0: 696f 6e20 7b72 6567 696f 6e7d 270a 2020  ion {region}'.  
-0001ccf0: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
-0001cd00: 203d 2054 6573 7453 746f 7261 6765 5769   = TestStorageWi
-0001cd10: 7468 4372 6564 656e 7469 616c 732e 636c  thCredentials.cl
-0001cd20: 695f 7265 6769 6f6e 5f63 6d64 280a 2020  i_region_cmd(.  
-0001cd30: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0001cd40: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001cd50: 4743 532c 2073 746f 7261 6765 5f6e 616d  GCS, storage_nam
-0001cd60: 6529 0a20 2020 2020 2020 2072 6567 696f  e).        regio
-0001cd70: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
-0001cd80: 203d 2066 277b 7265 6769 6f6e 5f63 6d64   = f'{region_cmd
-0001cd90: 7d20 7c20 6772 6570 207b 7265 6769 6f6e  } | grep {region
-0001cda0: 7d27 0a0a 2020 2020 7961 6d6c 5f73 7472  }'..    yaml_str
-0001cdb0: 203d 2079 616d 6c5f 7374 722e 7265 706c   = yaml_str.repl
-0001cdc0: 6163 6528 2773 6b79 2d77 6f72 6b64 6972  ace('sky-workdir
-0001cdd0: 2d7a 6877 7527 2c20 7374 6f72 6167 655f  -zhwu', storage_
-0001cde0: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
-0001cdf0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
-0001ce00: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
-0001ce10: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
-0001ce20: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
-0001ce30: 2020 2066 2e77 7269 7465 2879 616d 6c5f     f.write(yaml_
-0001ce40: 7374 7229 0a20 2020 2020 2020 2066 2e66  str).        f.f
-0001ce50: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
-0001ce60: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
-0001ce70: 650a 2020 2020 2020 2020 7465 7374 203d  e.        test =
-0001ce80: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-0001ce90: 2020 2027 7370 6f74 5f73 746f 7261 6765     'spot_storage
-0001cea0: 272c 0a20 2020 2020 2020 2020 2020 205b  ',.            [
-0001ceb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cec0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
-0001ced0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-0001cee0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001cef0: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-0001cf00: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-0001cf10: 656e 6572 6963 5f63 6c6f 7564 7d7b 7265  eneric_cloud}{re
-0001cf20: 6769 6f6e 5f66 6c61 677d 207b 6669 6c65  gion_flag} {file
-0001cf30: 5f70 6174 687d 202d 7927 2c0a 2020 2020  _path} -y',.    
-0001cf40: 2020 2020 2020 2020 2020 2020 7265 6769              regi
-0001cf50: 6f6e 5f76 616c 6964 6174 696f 6e5f 636d  on_validation_cm
-0001cf60: 642c 2020 2320 4368 6563 6b20 6966 2074  d,  # Check if t
-0001cf70: 6865 2062 7563 6b65 7420 6973 2063 7265  he bucket is cre
-0001cf80: 6174 6564 2069 6e20 7468 6520 636f 7272  ated in the corr
-0001cf90: 6563 7420 7265 6769 6f6e 0a20 2020 2020  ect region.     
-0001cfa0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001cfb0: 7020 3630 272c 2020 2320 5761 6974 2074  p 60',  # Wait t
-0001cfc0: 6865 2073 706f 7420 7175 6575 6520 746f  he spot queue to
-0001cfd0: 2062 6520 7570 6461 7465 640a 2020 2020   be updated.    
-0001cfe0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001cff0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001d000: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0001d010: 6772 6570 2053 5543 4345 4544 4544 272c  grep SUCCEEDED',
-0001d020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d030: 2066 275b 2024 2861 7773 2073 3361 7069   f'[ $(aws s3api
-0001d040: 206c 6973 742d 6275 636b 6574 7320 2d2d   list-buckets --
-0001d050: 7175 6572 7920 2242 7563 6b65 7473 5b3f  query "Buckets[?
-0001d060: 636f 6e74 6169 6e73 284e 616d 652c 205c  contains(Name, \
-0001d070: 277b 7374 6f72 6167 655f 6e61 6d65 7d5c  '{storage_name}\
-0001d080: 2729 5d2e 4e61 6d65 2220 2d2d 6f75 7470  ')].Name" --outp
-0001d090: 7574 2074 6578 7420 7c20 7763 202d 6c29  ut text | wc -l)
-0001d0a0: 202d 6571 2030 205d 270a 2020 2020 2020   -eq 0 ]'.      
-0001d0b0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001d0c0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-0001d0d0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-0001d0e0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-0001d0f0: 2020 2020 2020 2020 2020 2320 496e 6372            # Incr
-0001d100: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-0001d110: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-0001d120: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-0001d130: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-0001d140: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-0001d150: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-0001d160: 2a20 3630 2c0a 2020 2020 2020 2020 290a  * 60,.        ).
-0001d170: 2020 2020 2020 2020 7275 6e5f 6f6e 655f          run_one_
-0001d180: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-0001d190: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-0001d1a0: 6720 7370 6f74 2054 5055 202d 2d2d 2d2d  g spot TPU -----
-0001d1b0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0001d1c0: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-0001d1d0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-0001d1e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7470  .@pytest.mark.tp
-0001d1f0: 750a 6465 6620 7465 7374 5f73 706f 745f  u.def test_spot_
-0001d200: 7470 7528 293a 0a20 2020 2022 2222 5465  tpu():.    """Te
-0001d210: 7374 206d 616e 6167 6564 2073 706f 7420  st managed spot 
-0001d220: 6f6e 2054 5055 2e22 2222 0a20 2020 206e  on TPU.""".    n
-0001d230: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0001d240: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0001d250: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0001d260: 2020 2027 7465 7374 2d73 706f 742d 7470     'test-spot-tp
-0001d270: 7527 2c0a 2020 2020 2020 2020 5b0a 2020  u',.        [.  
-0001d280: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001d290: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-0001d2a0: 6e61 6d65 7d20 6578 616d 706c 6573 2f74  name} examples/t
-0001d2b0: 7075 2f74 7075 766d 5f6d 6e69 7374 2e79  pu/tpuvm_mnist.y
-0001d2c0: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
-0001d2d0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-0001d2e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001d2f0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001d300: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001d310: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0001d320: 6570 2053 5441 5254 494e 4727 2c0a 2020  ep STARTING',.  
-0001d330: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001d340: 2038 3430 272c 2020 2320 5450 5520 7461   840',  # TPU ta
-0001d350: 6b65 7320 6120 7768 696c 6520 746f 206c  kes a while to l
-0001d360: 6175 6e63 680a 2020 2020 2020 2020 2020  aunch.          
-0001d370: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0001d380: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001d390: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001d3a0: 2067 7265 7020 2252 554e 4e49 4e47 5c7c   grep "RUNNING\|
-0001d3b0: 5355 4343 4545 4445 4422 272c 0a20 2020  SUCCEEDED"',.   
-0001d3c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001d3d0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0001d3e0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001d3f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-0001d400: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-0001d410: 6f75 7420 7369 6e63 6520 736b 7920 7370  out since sky sp
-0001d420: 6f74 2071 7565 7565 202d 7220 6361 6e20  ot queue -r can 
-0001d430: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-0001d440: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-0001d450: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001d460: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-0001d470: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001d480: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001d490: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
-0001d4a0: 2066 6f72 2073 706f 7420 2d2d 2d2d 2d2d   for spot ------
-0001d4b0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-0001d4c0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b20  k.no_fluidstack 
-0001d4d0: 2023 2046 6c75 6964 7374 6163 6b20 646f   # Fluidstack do
-0001d4e0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001d4f0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001d500: 7974 6573 742e 6d61 726b 2e6e 6f5f 617a  ytest.mark.no_az
-0001d510: 7572 6520 2023 2041 7a75 7265 2064 6f65  ure  # Azure doe
-0001d520: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-0001d530: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-0001d540: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-0001d550: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-0001d560: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-0001d570: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001d580: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001d590: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-0001d5a0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-0001d5b0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0001d5c0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-0001d5d0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
-0001d5e0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
-0001d5f0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001d600: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001d610: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
-0001d620: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
-0001d630: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0001d640: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-0001d650: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6b  pytest.mark.no_k
-0001d660: 7562 6572 6e65 7465 7320 2023 204b 7562  ubernetes  # Kub
-0001d670: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
-0001d680: 2068 6176 6520 6120 6e6f 7469 6f6e 206f   have a notion o
-0001d690: 6620 7370 6f74 2069 6e73 7461 6e63 6573  f spot instances
-0001d6a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-0001d6b0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-0001d6c0: 6573 745f 7370 6f74 5f69 6e6c 696e 655f  est_spot_inline_
-0001d6d0: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
-0001d6e0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-0001d6f0: 5465 7374 2073 706f 7420 656e 7622 2222  Test spot env"""
-0001d700: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001d710: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001d720: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0001d730: 0a20 2020 2020 2020 2027 7465 7374 2d73  .        'test-s
-0001d740: 706f 742d 696e 6c69 6e65 2d65 6e76 272c  pot-inline-env',
-0001d750: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0001d760: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
-0001d770: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
-0001d780: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
-0001d790: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-0001d7a0: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
-0001d7b0: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
-0001d7c0: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
-0001d7d0: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
-0001d7e0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001d7f0: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
-0001d800: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001d810: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001d820: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
-0001d830: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0001d840: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-0001d850: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001d860: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001d870: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
-0001d880: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
-0001d890: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
-0001d8a0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-0001d8b0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0001d8c0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-0001d8d0: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
-0001d8e0: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
-0001d8f0: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
-0001d900: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
-0001d910: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
-0001d920: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
-0001d930: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-0001d940: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001d950: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001d960: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0001d970: 7469 6e67 2065 6e76 202d 2d2d 2d2d 2d2d  ting env -------
-0001d980: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
-0001d990: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
-0001d9a0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-0001d9b0: 2022 2222 5465 7374 2065 6e76 2222 220a   """Test env""".
-0001d9c0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001d9d0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001d9e0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0001d9f0: 2020 2020 2020 2020 2774 6573 742d 696e          'test-in
-0001da00: 6c69 6e65 2d65 6e76 272c 0a20 2020 2020  line-env',.     
-0001da10: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001da20: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-0001da30: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
-0001da40: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-0001da50: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
-0001da60: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
-0001da70: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
-0001da80: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
-0001da90: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
-0001daa0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
-0001dab0: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
-0001dac0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
-0001dad0: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
-0001dae0: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
-0001daf0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001db00: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
-0001db10: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0001db20: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0001db30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001db40: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0001db50: 202d 2d65 6e76 2054 4553 545f 454e 5632   --env TEST_ENV2
-0001db60: 3d22 7375 6363 6573 7322 2022 285b 5b20  ="success" "([[ 
-0001db70: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
-0001db80: 4e56 325c 5c22 205d 5d20 2626 205b 5b20  NV2\\" ]] && [[ 
-0001db90: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001dba0: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
-0001dbb0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001dbc0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001dbd0: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
-0001dbe0: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-0001dbf0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0001dc00: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-0001dc10: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-0001dc20: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0001dc30: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0001dc40: 2020 2020 2020 5f67 6574 5f74 696d 656f        _get_timeo
-0001dc50: 7574 2867 656e 6572 6963 5f63 6c6f 7564  ut(generic_cloud
-0001dc60: 292c 0a20 2020 2029 0a20 2020 2072 756e  ),.    ).    run
-0001dc70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0001dc80: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-0001dc90: 6573 7469 6e67 2065 6e76 2066 696c 6520  esting env file 
-0001dca0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074  ----------.def t
-0001dcb0: 6573 745f 696e 6c69 6e65 5f65 6e76 5f66  est_inline_env_f
-0001dcc0: 696c 6528 6765 6e65 7269 635f 636c 6f75  ile(generic_clou
-0001dcd0: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-0001dce0: 5465 7374 2065 6e76 2222 220a 2020 2020  Test env""".    
-0001dcf0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001dd00: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0001dd10: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001dd20: 2020 2020 2774 6573 742d 696e 6c69 6e65      'test-inline
-0001dd30: 2d65 6e76 2d66 696c 6527 2c0a 2020 2020  -env-file',.    
-0001dd40: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001dd50: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0001dd60: 6320 7b6e 616d 657d 202d 7920 2d2d 636c  c {name} -y --cl
-0001dd70: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0001dd80: 7564 7d20 2d2d 656e 7620 5445 5354 5f45  ud} --env TEST_E
-0001dd90: 4e56 3d22 6865 6c6c 6f20 776f 726c 6422  NV="hello world"
-0001dda0: 202d 2d20 2228 5b5b 2021 202d 7a20 5c5c   -- "([[ ! -z \\
-0001ddb0: 225c 2454 4553 545f 454e 565c 5c22 205d  "\$TEST_ENV\\" ]
-0001ddc0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-0001ddd0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-0001dde0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
-0001ddf0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-0001de00: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
-0001de10: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
-0001de20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001de30: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0001de40: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-0001de50: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0001de60: 6563 207b 6e61 6d65 7d20 2d2d 656e 762d  ec {name} --env-
-0001de70: 6669 6c65 2065 7861 6d70 6c65 732f 7361  file examples/sa
-0001de80: 6d70 6c65 5f64 6f74 656e 7620 2228 5b5b  mple_dotenv "([[
-0001de90: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
-0001dea0: 454e 5632 5c5c 2220 5d5d 2026 2620 5b5b  ENV2\\" ]] && [[
-0001deb0: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-0001dec0: 4c4f 545f 4e4f 4445 5f49 5053 5c5c 2220  LOT_NODE_IPS\\" 
-0001ded0: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-0001dee0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-0001def0: 5f52 414e 4b5c 5c22 205d 5d29 207c 7c20  _RANK\\" ]]) || 
-0001df00: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
-0001df10: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0001df20: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-0001df30: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
-0001df40: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0001df50: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0001df60: 2020 2020 2020 205f 6765 745f 7469 6d65         _get_time
-0001df70: 6f75 7428 6765 6e65 7269 635f 636c 6f75  out(generic_clou
-0001df80: 6429 2c0a 2020 2020 290a 2020 2020 7275  d),.    ).    ru
-0001df90: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001dfa0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0001dfb0: 5465 7374 696e 6720 6375 7374 6f6d 2069  Testing custom i
-0001dfc0: 6d61 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a  mage ----------.
-0001dfd0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-0001dfe0: 0a64 6566 2074 6573 745f 6177 735f 6375  .def test_aws_cu
-0001dff0: 7374 6f6d 5f69 6d61 6765 2829 3a0a 2020  stom_image():.  
-0001e000: 2020 2222 2254 6573 7420 4157 5320 6375    """Test AWS cu
-0001e010: 7374 6f6d 2069 6d61 6765 2222 220a 2020  stom image""".  
-0001e020: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001e030: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001e040: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001e050: 2020 2020 2020 2774 6573 742d 6177 732d        'test-aws-
-0001e060: 6375 7374 6f6d 2d69 6d61 6765 272c 0a20  custom-image',. 
-0001e070: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001e080: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0001e090: 6820 2d63 207b 6e61 6d65 7d20 2d2d 7265  h -c {name} --re
-0001e0a0: 7472 792d 756e 7469 6c2d 7570 202d 7920  try-until-up -y 
-0001e0b0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0001e0c0: 2f74 6573 745f 6375 7374 6f6d 5f69 6d61  /test_custom_ima
-0001e0d0: 6765 2e79 616d 6c20 2d2d 636c 6f75 6420  ge.yaml --cloud 
-0001e0e0: 6177 7320 2d2d 7265 6769 6f6e 2075 732d  aws --region us-
-0001e0f0: 6561 7374 2d32 202d 2d69 6d61 6765 2d69  east-2 --image-i
-0001e100: 6420 616d 692d 3036 3264 6464 3930 6662  d ami-062ddd90fb
-0001e110: 3666 3832 3637 6127 2c20 2023 204e 7669  6f8267a',  # Nvi
-0001e120: 6469 6120 696d 6167 650a 2020 2020 2020  dia image.      
-0001e130: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0001e140: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0001e150: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
-0001e160: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0001e170: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0001e180: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-0001e190: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-0001e1a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0001e1b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0001e1c0: 6172 6b2e 6b75 6265 726e 6574 6573 0a40  ark.kubernetes.@
-0001e1d0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-0001e1e0: 6d65 7472 697a 6528 0a20 2020 2022 696d  metrize(.    "im
-0001e1f0: 6167 655f 6964 222c 0a20 2020 205b 0a20  age_id",.    [. 
-0001e200: 2020 2020 2020 2022 646f 636b 6572 3a6e         "docker:n
-0001e210: 7669 6469 612f 6375 6461 3a31 312e 382e  vidia/cuda:11.8.
-0001e220: 302d 6465 7665 6c2d 7562 756e 7475 3138  0-devel-ubuntu18
-0001e230: 2e30 3422 2c0a 2020 2020 2020 2020 2264  .04",.        "d
-0001e240: 6f63 6b65 723a 7562 756e 7475 3a31 382e  ocker:ubuntu:18.
-0001e250: 3034 222c 0a20 2020 2020 2020 2023 2054  04",.        # T
-0001e260: 6573 7420 696d 6167 6520 7769 7468 2070  est image with p
-0001e270: 7974 686f 6e20 332e 3131 2069 6e73 7461  ython 3.11 insta
-0001e280: 6c6c 6564 2062 7920 6465 6661 756c 742e  lled by default.
-0001e290: 0a20 2020 2020 2020 2022 646f 636b 6572  .        "docker
-0001e2a0: 3a63 6f6e 7469 6e75 756d 696f 2f6d 696e  :continuumio/min
-0001e2b0: 6963 6f6e 6461 3322 2c0a 2020 2020 5d29  iconda3",.    ])
-0001e2c0: 0a64 6566 2074 6573 745f 6b75 6265 726e  .def test_kubern
-0001e2d0: 6574 6573 5f63 7573 746f 6d5f 696d 6167  etes_custom_imag
-0001e2e0: 6528 696d 6167 655f 6964 293a 0a20 2020  e(image_id):.   
-0001e2f0: 2022 2222 5465 7374 204b 7562 6572 6e65   """Test Kuberne
-0001e300: 7465 7320 6375 7374 6f6d 2069 6d61 6765  tes custom image
-0001e310: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001e320: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001e330: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0001e340: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-0001e350: 742d 6b75 6265 726e 6574 6573 2d63 7573  t-kubernetes-cus
-0001e360: 746f 6d2d 696d 6167 6527 2c0a 2020 2020  tom-image',.    
-0001e370: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001e380: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0001e390: 6320 7b6e 616d 657d 202d 2d72 6574 7279  c {name} --retry
-0001e3a0: 2d75 6e74 696c 2d75 7020 2d79 2074 6573  -until-up -y tes
-0001e3b0: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
-0001e3c0: 7374 5f63 7573 746f 6d5f 696d 6167 652e  st_custom_image.
-0001e3d0: 7961 6d6c 202d 2d63 6c6f 7564 206b 7562  yaml --cloud kub
-0001e3e0: 6572 6e65 7465 7320 2d2d 696d 6167 652d  ernetes --image-
-0001e3f0: 6964 207b 696d 6167 655f 6964 7d20 2d2d  id {image_id} --
-0001e400: 7265 6769 6f6e 204e 6f6e 6520 2d2d 6770  region None --gp
-0001e410: 7573 2054 343a 3127 2c0a 2020 2020 2020  us T4:1',.      
-0001e420: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0001e430: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0001e440: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-0001e450: 2023 2054 7279 2065 7865 6320 746f 2072   # Try exec to r
-0001e460: 756e 2061 6761 696e 2061 6e64 2063 6865  un again and che
-0001e470: 636b 2069 6620 7468 6520 6c6f 6773 2061  ck if the logs a
-0001e480: 7265 2070 7269 6e74 6564 0a20 2020 2020  re printed.     
-0001e490: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0001e4a0: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
-0001e4b0: 6573 745f 7961 6d6c 732f 7465 7374 5f63  est_yamls/test_c
-0001e4c0: 7573 746f 6d5f 696d 6167 652e 7961 6d6c  ustom_image.yaml
-0001e4d0: 202d 2d63 6c6f 7564 206b 7562 6572 6e65   --cloud kuberne
-0001e4e0: 7465 7320 2d2d 696d 6167 652d 6964 207b  tes --image-id {
-0001e4f0: 696d 6167 655f 6964 7d20 2d2d 7265 6769  image_id} --regi
-0001e500: 6f6e 204e 6f6e 6520 2d2d 6770 7573 2054  on None --gpus T
-0001e510: 343a 3120 7c20 6772 6570 2022 4865 6c6c  4:1 | grep "Hell
-0001e520: 6f20 3130 3022 272c 0a20 2020 2020 2020  o 100"',.       
-0001e530: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
-0001e540: 2073 7368 2069 7320 776f 726b 696e 6720   ssh is working 
-0001e550: 7769 7468 2063 7573 746f 6d20 7573 6572  with custom user
-0001e560: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
-0001e570: 2066 2773 7368 207b 6e61 6d65 7d20 6563   f'ssh {name} ec
-0001e580: 686f 2068 6920 7c20 6772 6570 2068 6927  ho hi | grep hi'
-0001e590: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001e5a0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0001e5b0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0001e5c0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
-0001e5d0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-0001e5e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001e5f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-0001e600: 2e73 6c6f 770a 6465 6620 7465 7374 5f61  .slow.def test_a
-0001e610: 7a75 7265 5f73 7461 7274 5f73 746f 705f  zure_start_stop_
-0001e620: 7477 6f5f 6e6f 6465 7328 293a 0a20 2020  two_nodes():.   
-0001e630: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0001e640: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0001e650: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001e660: 2020 2020 2027 617a 7572 652d 7374 6172       'azure-star
-0001e670: 742d 7374 6f70 2d74 776f 2d6e 6f64 6573  t-stop-two-nodes
-0001e680: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0001e690: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001e6a0: 6175 6e63 6820 2d2d 6e75 6d2d 6e6f 6465  aunch --num-node
-0001e6b0: 733d 3220 2d79 202d 6320 7b6e 616d 657d  s=2 -y -c {name}
-0001e6c0: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
-0001e6d0: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-0001e6e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001e6f0: 736b 7920 6578 6563 202d 2d6e 756d 2d6e  sky exec --num-n
-0001e700: 6f64 6573 3d32 207b 6e61 6d65 7d20 6578  odes=2 {name} ex
-0001e710: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
-0001e720: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
-0001e730: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001e740: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-0001e750: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0001e760: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0001e770: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-0001e780: 2020 2066 2773 6b79 2073 746f 7020 2d79     f'sky stop -y
-0001e790: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0001e7a0: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-0001e7b0: 7420 2d79 207b 6e61 6d65 7d27 2c0a 2020  t -y {name}',.  
+00016890: 2254 6573 7420 6120 7370 6f74 2070 6970  "Test a spot pip
+000168a0: 656c 696e 652e 2222 220a 2020 2020 6e61  eline.""".    na
+000168b0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000168c0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000168d0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000168e0: 2020 2773 706f 742d 7069 7065 6c69 6e65    'spot-pipeline
+000168f0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00016900: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00016910: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
+00016920: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+00016930: 7961 6d6c 732f 7069 7065 6c69 6e65 2e79  yamls/pipeline.y
+00016940: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
+00016950: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+00016960: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016970: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00016980: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00016990: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+000169a0: 6570 2022 5354 4152 5449 4e47 5c7c 5255  ep "STARTING\|RU
+000169b0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+000169c0: 2020 2020 2023 2060 6772 6570 202d 4120       # `grep -A 
+000169d0: 3420 7b6e 616d 657d 6020 6669 6e64 7320  4 {name}` finds 
+000169e0: 7468 6520 6a6f 6220 7769 7468 207b 6e61  the job with {na
+000169f0: 6d65 7d20 616e 6420 7468 6520 3420 6c69  me} and the 4 li
+00016a00: 6e65 730a 2020 2020 2020 2020 2020 2020  nes.            
+00016a10: 2320 6166 7465 7220 6974 2c20 692e 652e  # after it, i.e.
+00016a20: 2074 6865 2034 2074 6173 6b73 2077 6974   the 4 tasks wit
+00016a30: 6869 6e20 7468 6520 6a6f 622e 0a20 2020  hin the job..   
+00016a40: 2020 2020 2020 2020 2023 2060 7365 6420           # `sed 
+00016a50: 2d6e 2032 7060 2067 6574 7320 7468 6520  -n 2p` gets the 
+00016a60: 7365 636f 6e64 206c 696e 6520 6f66 2074  second line of t
+00016a70: 6865 2034 206c 696e 6573 2c20 692e 652e  he 4 lines, i.e.
+00016a80: 2074 6865 2066 6972 7374 0a20 2020 2020   the first.     
+00016a90: 2020 2020 2020 2023 2074 6173 6b20 7769         # task wi
+00016aa0: 7468 696e 2074 6865 206a 6f62 2e0a 2020  thin the job..  
+00016ab0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00016ac0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00016ad0: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00016ae0: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
+00016af0: 6570 2022 5354 4152 5449 4e47 5c7c 5255  ep "STARTING\|RU
+00016b00: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00016b10: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00016b20: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00016b30: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00016b40: 202d 6e20 3370 207c 2067 7265 7020 2250   -n 3p | grep "P
+00016b50: 454e 4449 4e47 2227 2c0a 2020 2020 2020  ENDING"',.      
+00016b60: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
+00016b70: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00016b80: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+00016b90: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00016ba0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00016bb0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00016bc0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00016bd0: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00016be0: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+00016bf0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
+00016c00: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00016c10: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00016c20: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00016c30: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00016c40: 6420 2d6e 2033 7020 7c20 6772 6570 2022  d -n 3p | grep "
+00016c50: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+00016c60: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00016c70: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00016c80: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00016c90: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00016ca0: 202d 6e20 3470 207c 2067 7265 7020 2243   -n 4p | grep "C
+00016cb0: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
+00016cc0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00016cd0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00016ce0: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
+00016cf0: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+00016d00: 2d6e 2035 7020 7c20 6772 6570 2022 4341  -n 5p | grep "CA
+00016d10: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+00016d20: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00016d30: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
+00016d40: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00016d50: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00016d60: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+00016d70: 657d 7c20 7365 6420 2d6e 2032 7020 7c20  e}| sed -n 2p | 
+00016d80: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+00016d90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016da0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00016db0: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
+00016dc0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3370  name}| sed -n 3p
+00016dd0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+00016de0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+00016df0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00016e00: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
+00016e10: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00016e20: 2034 7020 7c20 6772 6570 2022 4341 4e43   4p | grep "CANC
+00016e30: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00016e40: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00016e50: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00016e60: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00016e70: 202d 6e20 3570 207c 2067 7265 7020 2243   -n 5p | grep "C
+00016e80: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+00016e90: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00016ea0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00016eb0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00016ec0: 3d66 277b 6e61 6d65 7d27 292c 0a20 2020  =f'{name}'),.   
+00016ed0: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
+00016ee0: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
+00016ef0: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
+00016f00: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
+00016f10: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
+00016f20: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
+00016f30: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
+00016f40: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00016f50: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00016f60: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00016f70: 6473 7461 636b 2020 2366 6c75 6964 7374  dstack  #fluidst
+00016f80: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
+00016f90: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00016fa0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00016fb0: 2e6e 6f5f 617a 7572 6520 2023 2041 7a75  .no_azure  # Azu
+00016fc0: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
+00016fd0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00016fe0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00016ff0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00017000: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00017010: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00017020: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+00017030: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00017040: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
+00017050: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00017060: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00017070: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00017080: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00017090: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+000170a0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+000170b0: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+000170c0: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+000170d0: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+000170e0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+000170f0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00017100: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
+00017110: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+00017120: 6573 206e 6f74 2068 6176 6520 6120 6e6f  es not have a no
+00017130: 7469 6f6e 206f 6620 7370 6f74 2069 6e73  tion of spot ins
+00017140: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00017150: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+00017160: 0a64 6566 2074 6573 745f 7370 6f74 5f66  .def test_spot_f
+00017170: 6169 6c65 645f 7365 7475 7028 6765 6e65  ailed_setup(gene
+00017180: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+00017190: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
+000171a0: 6167 6564 2073 706f 7420 6a6f 6220 7769  aged spot job wi
+000171b0: 7468 2066 6169 6c65 6420 7365 7475 702e  th failed setup.
+000171c0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+000171d0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000171e0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+000171f0: 7374 280a 2020 2020 2020 2020 2773 706f  st(.        'spo
+00017200: 745f 6661 696c 6564 5f73 6574 7570 272c  t_failed_setup',
+00017210: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00017220: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+00017230: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+00017240: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00017250: 7269 635f 636c 6f75 647d 202d 7920 2d64  ric_cloud} -y -d
+00017260: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00017270: 732f 6661 696c 6564 5f73 6574 7570 2e79  s/failed_setup.y
+00017280: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00017290: 2020 2773 6c65 6570 2033 3330 272c 0a20    'sleep 330',. 
+000172a0: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
+000172b0: 6520 7375 7265 2074 6865 206a 6f62 2066  e sure the job f
+000172c0: 6169 6c65 6420 7175 6963 6b6c 792e 0a20  ailed quickly.. 
+000172d0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+000172e0: 504f 545f 5155 4555 455f 5741 4954 7d20  POT_QUEUE_WAIT} 
+000172f0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00017300: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00017310: 2246 4149 4c45 445f 5345 5455 5022 272c  "FAILED_SETUP"',
+00017320: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00017330: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+00017340: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00017350: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+00017360: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
+00017370: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
+00017380: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
+00017390: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
+000173a0: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
+000173b0: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
+000173c0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+000173d0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000173e0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000173f0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00017400: 6473 7461 636b 2020 2366 6c75 6964 7374  dstack  #fluidst
+00017410: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
+00017420: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00017430: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00017440: 2e6e 6f5f 617a 7572 6520 2023 2041 7a75  .no_azure  # Azu
+00017450: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
+00017460: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00017470: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00017480: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00017490: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+000174a0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+000174b0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000174c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000174d0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
+000174e0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+000174f0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00017500: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00017510: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00017520: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00017530: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00017540: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+00017550: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+00017560: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+00017570: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00017580: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00017590: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
+000175a0: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+000175b0: 6573 206e 6f74 2068 6176 6520 6120 6e6f  es not have a no
+000175c0: 7469 6f6e 206f 6620 7370 6f74 2069 6e73  tion of spot ins
+000175d0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+000175e0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+000175f0: 0a64 6566 2074 6573 745f 7370 6f74 5f70  .def test_spot_p
+00017600: 6970 656c 696e 655f 6661 696c 6564 5f73  ipeline_failed_s
+00017610: 6574 7570 2867 656e 6572 6963 5f63 6c6f  etup(generic_clo
+00017620: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
+00017630: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
+00017640: 6f74 206a 6f62 2077 6974 6820 6661 696c  ot job with fail
+00017650: 6564 2073 6574 7570 2066 6f72 2061 2070  ed setup for a p
+00017660: 6970 656c 696e 652e 2222 220a 2020 2020  ipeline.""".    
+00017670: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00017680: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00017690: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000176a0: 2020 2020 2773 706f 745f 7069 7065 6c69      'spot_pipeli
+000176b0: 6e65 5f66 6169 6c65 645f 7365 7475 7027  ne_failed_setup'
+000176c0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000176d0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+000176e0: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
+000176f0: 6d65 7d20 2d79 202d 6420 7465 7374 732f  me} -y -d tests/
+00017700: 7465 7374 5f79 616d 6c73 2f66 6169 6c65  test_yamls/faile
+00017710: 645f 7365 7475 705f 7069 7065 6c69 6e65  d_setup_pipeline
+00017720: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00017730: 2020 2020 2773 6c65 6570 2038 3030 272c      'sleep 800',
+00017740: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
+00017750: 616b 6520 7375 7265 2074 6865 206a 6f62  ake sure the job
+00017760: 2066 6169 6c65 6420 7175 6963 6b6c 792e   failed quickly.
+00017770: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00017780: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00017790: 7d20 7c20 6772 6570 207b 6e61 6d65 7d20  } | grep {name} 
+000177a0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+000177b0: 7020 2246 4149 4c45 445f 5345 5455 5022  p "FAILED_SETUP"
+000177c0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+000177d0: 2054 6173 6b20 3020 7368 6f75 6c64 2062   Task 0 should b
+000177e0: 6520 5355 4343 4545 4445 442e 0a20 2020  e SUCCEEDED..   
+000177f0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00017800: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
+00017810: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00017820: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
+00017830: 6570 2022 5355 4343 4545 4445 4422 272c  ep "SUCCEEDED"',
+00017840: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00017850: 6173 6b20 3120 7368 6f75 6c64 2062 6520  ask 1 should be 
+00017860: 4641 494c 4544 5f53 4554 5550 2e0a 2020  FAILED_SETUP..  
+00017870: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00017880: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
+00017890: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+000178a0: 7d7c 2073 6564 202d 6e20 3370 207c 2067  }| sed -n 3p | g
+000178b0: 7265 7020 2246 4149 4c45 445f 5345 5455  rep "FAILED_SETU
+000178c0: 5022 272c 0a20 2020 2020 2020 2020 2020  P"',.           
+000178d0: 2023 2054 6173 6b20 3220 7368 6f75 6c64   # Task 2 should
+000178e0: 2062 6520 4341 4e43 454c 4c45 442e 0a20   be CANCELLED.. 
+000178f0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00017900: 504f 545f 5155 4555 455f 5741 4954 7d20  POT_QUEUE_WAIT} 
+00017910: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+00017920: 657d 7c20 7365 6420 2d6e 2034 7020 7c20  e}| sed -n 4p | 
+00017930: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+00017940: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00017950: 2054 6173 6b20 3320 7368 6f75 6c64 2062   Task 3 should b
+00017960: 6520 4341 4e43 454c 4c45 442e 0a20 2020  e CANCELLED..   
+00017970: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00017980: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
+00017990: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+000179a0: 7c20 7365 6420 2d6e 2035 7020 7c20 6772  | sed -n 5p | gr
+000179b0: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
+000179c0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000179d0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+000179e0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+000179f0: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+00017a00: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
+00017a10: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
+00017a20: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
+00017a30: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
+00017a40: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
+00017a50: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
+00017a60: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
+00017a70: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00017a80: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00017a90: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+00017aa0: 206d 616e 6167 6564 2073 706f 7420 7265   managed spot re
+00017ab0: 636f 7665 7279 202d 2d2d 2d2d 2d2d 2d2d  covery ---------
+00017ac0: 2d0a 0a0a 4070 7974 6573 742e 6d61 726b  -...@pytest.mark
+00017ad0: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+00017ae0: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+00017af0: 6566 2074 6573 745f 7370 6f74 5f72 6563  ef test_spot_rec
+00017b00: 6f76 6572 795f 6177 7328 6177 735f 636f  overy_aws(aws_co
+00017b10: 6e66 6967 5f72 6567 696f 6e29 3a0a 2020  nfig_region):.  
+00017b20: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
+00017b30: 6420 7370 6f74 2072 6563 6f76 6572 792e  d spot recovery.
+00017b40: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+00017b50: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00017b60: 2829 0a20 2020 206e 616d 655f 6f6e 5f63  ().    name_on_c
+00017b70: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
+00017b80: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
+00017b90: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
+00017ba0: 2020 2020 2020 2020 6e61 6d65 2c20 7370          name, sp
+00017bb0: 6f74 2e53 504f 545f 434c 5553 5445 525f  ot.SPOT_CLUSTER_
+00017bc0: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+00017bd0: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+00017be0: 683d 4661 6c73 6529 0a20 2020 2072 6567  h=False).    reg
+00017bf0: 696f 6e20 3d20 6177 735f 636f 6e66 6967  ion = aws_config
+00017c00: 5f72 6567 696f 6e0a 2020 2020 7465 7374  _region.    test
+00017c10: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00017c20: 2027 7370 6f74 5f72 6563 6f76 6572 795f   'spot_recovery_
+00017c30: 6177 7327 2c0a 2020 2020 2020 2020 5b0a  aws',.        [.
+00017c40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017c50: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+00017c60: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00017c70: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+00017c80: 6e61 6d65 7d20 2265 6368 6f20 534b 5950  name} "echo SKYP
+00017c90: 494c 4f54 5f54 4153 4b5f 4944 3a20 5c24  ILOT_TASK_ID: \$
+00017ca0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00017cb0: 3b20 736c 6565 7020 3138 3030 2220 202d  ; sleep 1800"  -
+00017cc0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00017cd0: 2020 2027 736c 6565 7020 3336 3027 2c0a     'sleep 360',.
+00017ce0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00017cf0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00017d00: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00017d10: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00017d20: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+00017d30: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+00017d40: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+00017d50: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00017d60: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00017d70: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+00017d80: 2063 7574 202d 643a 202d 6632 293b 2065   cut -d: -f2); e
+00017d90: 6368 6f20 2224 5255 4e5f 4944 2220 7c20  cho "$RUN_ID" | 
+00017da0: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+00017db0: 7275 6e2d 6964 272c 0a20 2020 2020 2020  run-id',.       
+00017dc0: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
+00017dd0: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+00017de0: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00017df0: 2020 2028 6627 6177 7320 6563 3220 7465     (f'aws ec2 te
+00017e00: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
+00017e10: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00017e20: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
+00017e30: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
+00017e40: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
+00017e50: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+00017e60: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00017e70: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+00017e80: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
+00017e90: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
+00017ea0: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
+00017eb0: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 2a20  name_on_cloud}* 
+00017ec0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+00017ed0: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
+00017ee0: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
+00017ef0: 735b 5d2e 496e 7374 616e 6365 4964 2027  s[].InstanceId '
+00017f00: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
+00017f10: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
+00017f20: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00017f30: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+00017f40: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00017f50: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00017f60: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00017f70: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00017f80: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00017f90: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+00017fa0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00017fb0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00017fc0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00017fd0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00017fe0: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00017ff0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00018000: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+00018010: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+00018020: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+00018030: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00018040: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00018050: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+00018060: 5441 534b 5f49 4420 7c20 6772 6570 2022  TASK_ID | grep "
+00018070: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
+00018080: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
+00018090: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+000180a0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+000180b0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+000180c0: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+000180d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000180e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000180f0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00018100: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+00018110: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
+00018120: 7374 5f73 706f 745f 7265 636f 7665 7279  st_spot_recovery
+00018130: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
+00018140: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
+00018150: 2072 6563 6f76 6572 792e 2222 220a 2020   recovery.""".  
+00018160: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00018170: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00018180: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
+00018190: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+000181a0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+000181b0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+000181c0: 2020 6e61 6d65 2c20 7370 6f74 2e53 504f    name, spot.SPO
+000181d0: 545f 434c 5553 5445 525f 4e41 4d45 5f50  T_CLUSTER_NAME_P
+000181e0: 5245 4649 585f 4c45 4e47 5448 2c20 6164  REFIX_LENGTH, ad
+000181f0: 645f 7573 6572 5f68 6173 683d 4661 6c73  d_user_hash=Fals
+00018200: 6529 0a20 2020 207a 6f6e 6520 3d20 2775  e).    zone = 'u
+00018210: 732d 6561 7374 342d 6227 0a20 2020 2071  s-east4-b'.    q
+00018220: 7565 7279 5f63 6d64 203d 2028 0a20 2020  uery_cmd = (.   
+00018230: 2020 2020 2066 2767 636c 6f75 6420 636f       f'gcloud co
+00018240: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+00018250: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
+00018260: 2020 2020 2020 2020 2320 603a 6020 6d65          # `:` me
+00018270: 616e 7320 7072 6566 6978 206d 6174 6368  ans prefix match
+00018280: 2e0a 2020 2020 2020 2020 6627 2228 6c61  ..        f'"(la
+00018290: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
+000182a0: 2d6e 616d 653a 7b6e 616d 655f 6f6e 5f63  -name:{name_on_c
+000182b0: 6c6f 7564 7d29 2220 270a 2020 2020 2020  loud})" '.      
+000182c0: 2020 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e    f'--zones={zon
+000182d0: 657d 202d 2d66 6f72 6d61 743d 2276 616c  e} --format="val
+000182e0: 7565 286e 616d 6529 2227 290a 2020 2020  ue(name)"').    
+000182f0: 7465 726d 696e 6174 655f 636d 6420 3d20  terminate_cmd = 
+00018300: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
+00018310: 6520 696e 7374 616e 6365 7320 6465 6c65  e instances dele
+00018320: 7465 202d 2d7a 6f6e 653d 7b7a 6f6e 657d  te --zone={zone}
+00018330: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00018340: 2020 2020 2020 2066 2720 2d2d 7175 6965         f' --quie
+00018350: 7420 2428 7b71 7565 7279 5f63 6d64 7d29  t $({query_cmd})
+00018360: 2729 0a20 2020 2074 6573 7420 3d20 5465  ').    test = Te
+00018370: 7374 280a 2020 2020 2020 2020 2773 706f  st(.        'spo
+00018380: 745f 7265 636f 7665 7279 5f67 6370 272c  t_recovery_gcp',
+00018390: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000183a0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+000183b0: 7420 6c61 756e 6368 202d 2d63 6c6f 7564  t launch --cloud
+000183c0: 2067 6370 202d 2d7a 6f6e 6520 7b7a 6f6e   gcp --zone {zon
+000183d0: 657d 202d 6e20 7b6e 616d 657d 202d 2d63  e} -n {name} --c
+000183e0: 7075 7320 3220 2265 6368 6f20 534b 5950  pus 2 "echo SKYP
+000183f0: 494c 4f54 5f54 4153 4b5f 4944 3a20 5c24  ILOT_TASK_ID: \$
+00018400: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00018410: 3b20 736c 6565 7020 3138 3030 2220 202d  ; sleep 1800"  -
+00018420: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00018430: 2020 2027 736c 6565 7020 3336 3027 2c0a     'sleep 360',.
+00018440: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00018450: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00018460: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00018470: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00018480: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+00018490: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+000184a0: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+000184b0: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+000184c0: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+000184d0: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+000184e0: 2063 7574 202d 643a 202d 6632 293b 2065   cut -d: -f2); e
+000184f0: 6368 6f20 2224 5255 4e5f 4944 2220 7c20  cho "$RUN_ID" | 
+00018500: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+00018510: 7275 6e2d 6964 272c 0a20 2020 2020 2020  run-id',.       
+00018520: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
+00018530: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+00018540: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00018550: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+00018560: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00018570: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+00018580: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00018590: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+000185a0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+000185b0: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+000185c0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+000185d0: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+000185e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000185f0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00018600: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00018610: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00018620: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00018630: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00018640: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+00018650: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+00018660: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+00018670: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00018680: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00018690: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+000186a0: 5441 534b 5f49 443a 207c 2067 7265 7020  TASK_ID: | grep 
+000186b0: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
+000186c0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+000186d0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+000186e0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+000186f0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00018700: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+00018710: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00018720: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00018730: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00018740: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00018750: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00018760: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
+00018770: 655f 7265 636f 7665 7279 5f61 7773 2861  e_recovery_aws(a
+00018780: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+00018790: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
+000187a0: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
+000187b0: 7665 7279 2066 6f72 2061 2070 6970 656c  very for a pipel
+000187c0: 696e 652e 2222 220a 2020 2020 6e61 6d65  ine.""".    name
+000187d0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000187e0: 6e61 6d65 2829 0a20 2020 2075 7365 725f  name().    user_
+000187f0: 6861 7368 203d 2063 6f6d 6d6f 6e5f 7574  hash = common_ut
+00018800: 696c 732e 6765 745f 7573 6572 5f68 6173  ils.get_user_has
+00018810: 6828 290a 2020 2020 7573 6572 5f68 6173  h().    user_has
+00018820: 6820 3d20 7573 6572 5f68 6173 685b 3a63  h = user_hash[:c
+00018830: 6f6d 6d6f 6e5f 7574 696c 732e 5553 4552  ommon_utils.USER
+00018840: 5f48 4153 485f 4c45 4e47 5448 5f49 4e5f  _HASH_LENGTH_IN_
+00018850: 434c 5553 5445 525f 4e41 4d45 5d0a 2020  CLUSTER_NAME].  
+00018860: 2020 7265 6769 6f6e 203d 2061 7773 5f63    region = aws_c
+00018870: 6f6e 6669 675f 7265 6769 6f6e 0a20 2020  onfig_region.   
+00018880: 2069 6620 7265 6769 6f6e 2021 3d20 2775   if region != 'u
+00018890: 732d 6561 7374 2d32 273a 0a20 2020 2020  s-east-2':.     
+000188a0: 2020 2070 7974 6573 742e 736b 6970 2827     pytest.skip('
+000188b0: 4f6e 6c79 2072 756e 2073 706f 7420 7069  Only run spot pi
+000188c0: 7065 6c69 6e65 2072 6563 6f76 6572 7920  peline recovery 
+000188d0: 7465 7374 2069 6e20 7573 2d65 6173 742d  test in us-east-
+000188e0: 3227 290a 2020 2020 7465 7374 203d 2054  2').    test = T
+000188f0: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00018900: 6f74 5f70 6970 656c 696e 655f 7265 636f  ot_pipeline_reco
+00018910: 7665 7279 5f61 7773 272c 0a20 2020 2020  very_aws',.     
+00018920: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00018930: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
+00018940: 6368 202d 6e20 7b6e 616d 657d 2074 6573  ch -n {name} tes
+00018950: 7473 2f74 6573 745f 7961 6d6c 732f 7069  ts/test_yamls/pi
+00018960: 7065 6c69 6e65 5f61 7773 2e79 616d 6c20  peline_aws.yaml 
+00018970: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00018980: 2020 2020 2027 736c 6565 7020 3430 3027       'sleep 400'
+00018990: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000189a0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+000189b0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+000189c0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+000189d0: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+000189e0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+000189f0: 4944 3d24 2873 6b79 2073 706f 7420 6c6f  ID=$(sky spot lo
+00018a00: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
+00018a10: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+00018a20: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+00018a30: 3a20 7c20 6375 7420 2d64 3a20 2d66 3229  : | cut -d: -f2)
+00018a40: 3b20 6563 686f 2022 2452 554e 5f49 4422  ; echo "$RUN_ID"
+00018a50: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
+00018a60: 657d 2d72 756e 2d69 6427 2c0a 2020 2020  e}-run-id',.    
+00018a70: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+00018a80: 533d 2428 736b 7920 7370 6f74 206c 6f67  S=$(sky spot log
+00018a90: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00018aa0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 202d  -follow | grep -
+00018ab0: 4120 3420 534b 5950 494c 4f54 5f54 4153  A 4 SKYPILOT_TAS
+00018ac0: 4b5f 4944 5320 7c20 6375 7420 2d64 2229  K_IDS | cut -d")
+00018ad0: 2220 2d66 3229 3b20 6563 686f 2022 2452  " -f2); echo "$R
+00018ae0: 554e 5f49 4453 2220 7c20 7465 6520 2f74  UN_IDS" | tee /t
+00018af0: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00018b00: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00018b10: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
+00018b20: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
+00018b30: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00018b40: 5468 6520 6063 6174 202e 2e2e 7c20 7265  The `cat ...| re
+00018b50: 7660 2069 7320 746f 2072 6574 7269 6576  v` is to retriev
+00018b60: 6520 7468 6520 6a6f 625f 6964 2066 726f  e the job_id fro
+00018b70: 6d20 7468 650a 2020 2020 2020 2020 2020  m the.          
+00018b80: 2020 2320 534b 5950 494c 4f54 5f54 4153    # SKYPILOT_TAS
+00018b90: 4b5f 4944 2c20 7768 6963 6820 6765 7473  K_ID, which gets
+00018ba0: 2074 6865 2073 6563 6f6e 6420 746f 206c   the second to l
+00018bb0: 6173 7420 6669 656c 640a 2020 2020 2020  ast field.      
+00018bc0: 2020 2020 2020 2320 7365 7061 7261 7465        # separate
+00018bd0: 6420 6279 2060 2d60 2e0a 2020 2020 2020  d by `-`..      
+00018be0: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
+00018bf0: 2020 2020 2020 2020 6627 5350 4f54 5f4a          f'SPOT_J
+00018c00: 4f42 5f49 443d 6063 6174 202f 746d 702f  OB_ID=`cat /tmp/
+00018c10: 7b6e 616d 657d 2d72 756e 2d69 6420 7c20  {name}-run-id | 
+00018c20: 7265 7620 7c20 270a 2020 2020 2020 2020  rev | '.        
+00018c30: 2020 2020 2020 2020 2763 7574 202d 645c          'cut -d\
+00018c40: 275f 5c27 202d 6631 207c 2072 6576 207c  '_\' -f1 | rev |
+00018c50: 2063 7574 202d 645c 272d 5c27 202d 6631   cut -d\'-\' -f1
+00018c60: 603b 270a 2020 2020 2020 2020 2020 2020  `;'.            
+00018c70: 2020 2020 6627 6177 7320 6563 3220 7465      f'aws ec2 te
+00018c80: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
+00018c90: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00018ca0: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
+00018cb0: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
+00018cc0: 2020 2020 2020 2066 2761 7773 2065 6332         f'aws ec2
+00018cd0: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
+00018ce0: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
+00018cf0: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
+00018d00: 2020 2020 2020 2020 2320 544f 444f 287a          # TODO(z
+00018d10: 6877 7529 3a20 6669 7820 7468 6520 6e61  hwu): fix the na
+00018d20: 6d65 2066 6f72 2073 706f 7420 636c 7573  me for spot clus
+00018d30: 7465 722e 0a20 2020 2020 2020 2020 2020  ter..           
+00018d40: 2020 2020 2027 2d2d 6669 6c74 6572 7320       '--filters 
+00018d50: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
+00018d60: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+00018d70: 3d2a 2d24 7b53 504f 545f 4a4f 425f 4944  =*-${SPOT_JOB_ID
+00018d80: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00018d90: 2020 2066 272d 7b75 7365 725f 6861 7368     f'-{user_hash
+00018da0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+00018db0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00018dc0: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00018dd0: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+00018de0: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+00018df0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+00018e00: 7465 7874 2927 292c 0a20 2020 2020 2020  text)'),.       
+00018e10: 2020 2020 2027 736c 6565 7020 3130 3027       'sleep 100'
+00018e20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00018e30: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00018e40: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00018e50: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00018e60: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
+00018e70: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00018e80: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+00018e90: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00018ea0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00018eb0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00018ec0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+00018ed0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+00018ee0: 2020 6627 5255 4e5f 4944 3d24 2863 6174    f'RUN_ID=$(cat
+00018ef0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00018f00: 2d69 6429 3b20 6563 686f 2024 5255 4e5f  -id); echo $RUN_
+00018f10: 4944 3b20 736b 7920 7370 6f74 206c 6f67  ID; sky spot log
+00018f20: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00018f30: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+00018f40: 4b59 5049 4c4f 545f 5441 534b 5f49 443a  KYPILOT_TASK_ID:
+00018f50: 207c 2067 7265 7020 2224 5255 4e5f 4944   | grep "$RUN_ID
+00018f60: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00018f70: 6627 5255 4e5f 4944 533d 2428 736b 7920  f'RUN_IDS=$(sky 
+00018f80: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00018f90: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00018fa0: 7c20 6772 6570 202d 4120 3420 534b 5950  | grep -A 4 SKYP
+00018fb0: 494c 4f54 5f54 4153 4b5f 4944 5320 7c20  ILOT_TASK_IDS | 
+00018fc0: 6375 7420 2d64 2229 2220 2d66 3229 3b20  cut -d")" -f2); 
+00018fd0: 6563 686f 2022 2452 554e 5f49 4453 2220  echo "$RUN_IDS" 
+00018fe0: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
+00018ff0: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
+00019000: 2020 2020 2020 2020 2020 2020 6627 6469              f'di
+00019010: 6666 202f 746d 702f 7b6e 616d 657d 2d72  ff /tmp/{name}-r
+00019020: 756e 2d69 6473 202f 746d 702f 7b6e 616d  un-ids /tmp/{nam
+00019030: 657d 2d72 756e 2d69 6473 2d6e 6577 272c  e}-run-ids-new',
+00019040: 0a20 2020 2020 2020 2020 2020 2066 2763  .            f'c
+00019050: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+00019060: 756e 2d69 6473 207c 2073 6564 202d 6e20  un-ids | sed -n 
+00019070: 3270 207c 2067 7265 7020 6063 6174 202f  2p | grep `cat /
+00019080: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00019090: 6460 272c 0a20 2020 2020 2020 205d 2c0a  d`',.        ],.
+000190a0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+000190b0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+000190c0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+000190d0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+000190e0: 3d32 3520 2a20 3630 2c0a 2020 2020 290a  =25 * 60,.    ).
+000190f0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00019100: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00019110: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
+00019120: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
+00019130: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
+00019140: 745f 7069 7065 6c69 6e65 5f72 6563 6f76  t_pipeline_recov
+00019150: 6572 795f 6763 7028 293a 0a20 2020 2022  ery_gcp():.    "
+00019160: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
+00019170: 706f 7420 7265 636f 7665 7279 2066 6f72  pot recovery for
+00019180: 2061 2070 6970 656c 696e 652e 2222 220a   a pipeline.""".
+00019190: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000191a0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000191b0: 2020 207a 6f6e 6520 3d20 2775 732d 6561     zone = 'us-ea
+000191c0: 7374 342d 6227 0a20 2020 2075 7365 725f  st4-b'.    user_
+000191d0: 6861 7368 203d 2063 6f6d 6d6f 6e5f 7574  hash = common_ut
+000191e0: 696c 732e 6765 745f 7573 6572 5f68 6173  ils.get_user_has
+000191f0: 6828 290a 2020 2020 7573 6572 5f68 6173  h().    user_has
+00019200: 6820 3d20 7573 6572 5f68 6173 685b 3a63  h = user_hash[:c
+00019210: 6f6d 6d6f 6e5f 7574 696c 732e 5553 4552  ommon_utils.USER
+00019220: 5f48 4153 485f 4c45 4e47 5448 5f49 4e5f  _HASH_LENGTH_IN_
+00019230: 434c 5553 5445 525f 4e41 4d45 5d0a 2020  CLUSTER_NAME].  
+00019240: 2020 7175 6572 795f 636d 6420 3d20 2827    query_cmd = ('
+00019250: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
+00019260: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
+00019270: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
+00019280: 2020 2020 2020 2020 2020 6627 2228 6c61            f'"(la
+00019290: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
+000192a0: 2d6e 616d 653a 2a2d 247b 7b53 504f 545f  -name:*-${{SPOT_
+000192b0: 4a4f 425f 4944 7d7d 2d7b 7573 6572 5f68  JOB_ID}}-{user_h
+000192c0: 6173 687d 2922 2027 0a20 2020 2020 2020  ash})" '.       
+000192d0: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
+000192e0: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+000192f0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+00019300: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
+00019310: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
+00019320: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00019330: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
+00019340: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
+00019350: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019360: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
+00019370: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
+00019380: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00019390: 2020 2020 2773 706f 745f 7069 7065 6c69      'spot_pipeli
+000193a0: 6e65 5f72 6563 6f76 6572 795f 6763 7027  ne_recovery_gcp'
+000193b0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000193c0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+000193d0: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
+000193e0: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+000193f0: 616d 6c73 2f70 6970 656c 696e 655f 6763  amls/pipeline_gc
+00019400: 702e 7961 6d6c 2020 2d79 202d 6427 2c0a  p.yaml  -y -d',.
+00019410: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00019420: 6570 2034 3030 272c 0a20 2020 2020 2020  ep 400',.       
+00019430: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00019440: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00019450: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00019460: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00019470: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00019480: 2066 2752 554e 5f49 443d 2428 736b 7920   f'RUN_ID=$(sky 
+00019490: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+000194a0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+000194b0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+000194c0: 5441 534b 5f49 443a 207c 2063 7574 202d  TASK_ID: | cut -
+000194d0: 643a 202d 6632 293b 2065 6368 6f20 2224  d: -f2); echo "$
+000194e0: 5255 4e5f 4944 2220 7c20 7465 6520 2f74  RUN_ID" | tee /t
+000194f0: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00019500: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00019510: 2752 554e 5f49 4453 3d24 2873 6b79 2073  'RUN_IDS=$(sky s
+00019520: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00019530: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00019540: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
+00019550: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
+00019560: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
+00019570: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
+00019580: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00019590: 2d72 756e 2d69 6473 272c 0a20 2020 2020  -run-ids',.     
+000195a0: 2020 2020 2020 2023 2054 6572 6d69 6e61         # Termina
+000195b0: 7465 2074 6865 2063 6c75 7374 6572 206d  te the cluster m
+000195c0: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
+000195d0: 2020 2020 2023 2054 6865 2060 6361 7420       # The `cat 
+000195e0: 2e2e 2e7c 2072 6576 6020 6973 2074 6f20  ...| rev` is to 
+000195f0: 7265 7472 6965 7665 2074 6865 206a 6f62  retrieve the job
+00019600: 5f69 6420 6672 6f6d 2074 6865 0a20 2020  _id from the.   
+00019610: 2020 2020 2020 2020 2023 2053 4b59 5049           # SKYPI
+00019620: 4c4f 545f 5441 534b 5f49 442c 2077 6869  LOT_TASK_ID, whi
+00019630: 6368 2067 6574 7320 7468 6520 7365 636f  ch gets the seco
+00019640: 6e64 2074 6f20 6c61 7374 2066 6965 6c64  nd to last field
+00019650: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
+00019660: 6570 6172 6174 6564 2062 7920 602d 602e  eparated by `-`.
+00019670: 0a20 2020 2020 2020 2020 2020 2028 6627  .            (f'
+00019680: 5350 4f54 5f4a 4f42 5f49 443d 6063 6174  SPOT_JOB_ID=`cat
+00019690: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+000196a0: 2d69 6420 7c20 7265 7620 7c20 270a 2020  -id | rev | '.  
+000196b0: 2020 2020 2020 2020 2020 2066 2763 7574             f'cut
+000196c0: 202d 645c 275f 5c27 202d 6631 207c 2072   -d\'_\' -f1 | r
+000196d0: 6576 207c 2063 7574 202d 645c 272d 5c27  ev | cut -d\'-\'
+000196e0: 202d 6631 603b 207b 7465 726d 696e 6174   -f1`; {terminat
+000196f0: 655f 636d 647d 2729 2c0a 2020 2020 2020  e_cmd}'),.      
+00019700: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
+00019710: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00019720: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00019730: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00019740: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00019750: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
+00019760: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00019770: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+00019780: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00019790: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+000197a0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+000197b0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+000197c0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+000197d0: 2020 6627 5255 4e5f 4944 3d24 2863 6174    f'RUN_ID=$(cat
+000197e0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+000197f0: 2d69 6429 3b20 6563 686f 2024 5255 4e5f  -id); echo $RUN_
+00019800: 4944 3b20 736b 7920 7370 6f74 206c 6f67  ID; sky spot log
+00019810: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+00019820: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+00019830: 4b59 5049 4c4f 545f 5441 534b 5f49 443a  KYPILOT_TASK_ID:
+00019840: 207c 2067 7265 7020 2224 5255 4e5f 4944   | grep "$RUN_ID
+00019850: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00019860: 6627 5255 4e5f 4944 533d 2428 736b 7920  f'RUN_IDS=$(sky 
+00019870: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00019880: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00019890: 7c20 6772 6570 202d 4120 3420 534b 5950  | grep -A 4 SKYP
+000198a0: 494c 4f54 5f54 4153 4b5f 4944 5320 7c20  ILOT_TASK_IDS | 
+000198b0: 6375 7420 2d64 2229 2220 2d66 3229 3b20  cut -d")" -f2); 
+000198c0: 6563 686f 2022 2452 554e 5f49 4453 2220  echo "$RUN_IDS" 
+000198d0: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
+000198e0: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
+000198f0: 2020 2020 2020 2020 2020 2020 6627 6469              f'di
+00019900: 6666 202f 746d 702f 7b6e 616d 657d 2d72  ff /tmp/{name}-r
+00019910: 756e 2d69 6473 202f 746d 702f 7b6e 616d  un-ids /tmp/{nam
+00019920: 657d 2d72 756e 2d69 6473 2d6e 6577 272c  e}-run-ids-new',
+00019930: 0a20 2020 2020 2020 2020 2020 2066 2763  .            f'c
+00019940: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+00019950: 756e 2d69 6473 207c 2073 6564 202d 6e20  un-ids | sed -n 
+00019960: 3270 207c 2067 7265 7020 6063 6174 202f  2p | grep `cat /
+00019970: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00019980: 6460 272c 0a20 2020 2020 2020 205d 2c0a  d`',.        ],.
+00019990: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+000199a0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+000199b0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+000199c0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+000199d0: 3d32 3520 2a20 3630 2c0a 2020 2020 290a  =25 * 60,.    ).
+000199e0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000199f0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00019a00: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00019a10: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
+00019a20: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
+00019a30: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+00019a40: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+00019a50: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
+00019a60: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00019a70: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00019a80: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00019a90: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+00019aa0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
+00019ab0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00019ac0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00019ad0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+00019ae0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+00019af0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00019b00: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00019b10: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+00019b20: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+00019b30: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00019b40: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00019b50: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+00019b60: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+00019b70: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
+00019b80: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00019b90: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00019ba0: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
+00019bb0: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
+00019bc0: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
+00019bd0: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
+00019be0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00019bf0: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+00019c00: 6566 2074 6573 745f 7370 6f74 5f72 6563  ef test_spot_rec
+00019c10: 6f76 6572 795f 6465 6661 756c 745f 7265  overy_default_re
+00019c20: 736f 7572 6365 7328 6765 6e65 7269 635f  sources(generic_
+00019c30: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00019c40: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
+00019c50: 2073 706f 7420 7265 636f 7665 7279 2066   spot recovery f
+00019c60: 6f72 2064 6566 6175 6c74 2072 6573 6f75  or default resou
+00019c70: 7263 6573 2e22 2222 0a20 2020 206e 616d  rces.""".    nam
+00019c80: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00019c90: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00019ca0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00019cb0: 2027 6d61 6e61 6765 642d 7370 6f74 2d72   'managed-spot-r
+00019cc0: 6563 6f76 6572 792d 6465 6661 756c 742d  ecovery-default-
+00019cd0: 7265 736f 7572 6365 7327 2c0a 2020 2020  resources',.    
+00019ce0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00019cf0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+00019d00: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
+00019d10: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00019d20: 6c6f 7564 7d20 2273 6c65 6570 2033 3020  loud} "sleep 30 
+00019d30: 2626 2073 7564 6f20 7368 7574 646f 776e  && sudo shutdown
+00019d40: 206e 6f77 2026 2620 736c 6565 7020 3130   now && sleep 10
+00019d50: 3030 2220 2d79 202d 6427 2c0a 2020 2020  00" -y -d',.    
+00019d60: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
+00019d70: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
+00019d80: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
+00019d90: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+00019da0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+00019db0: 6772 6570 2022 5255 4e4e 494e 475c 7c52  grep "RUNNING\|R
+00019dc0: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+00019dd0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00019de0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+00019df0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00019e00: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00019e10: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
+00019e20: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00019e30: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00019e40: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00019e50: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
+00019e60: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
+00019e70: 7465 7374 5f73 706f 745f 7265 636f 7665  test_spot_recove
+00019e80: 7279 5f6d 756c 7469 5f6e 6f64 655f 6177  ry_multi_node_aw
+00019e90: 7328 6177 735f 636f 6e66 6967 5f72 6567  s(aws_config_reg
+00019ea0: 696f 6e29 3a0a 2020 2020 2222 2254 6573  ion):.    """Tes
+00019eb0: 7420 6d61 6e61 6765 6420 7370 6f74 2072  t managed spot r
+00019ec0: 6563 6f76 6572 792e 2222 220a 2020 2020  ecovery.""".    
+00019ed0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00019ee0: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
+00019ef0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
+00019f00: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+00019f10: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+00019f20: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+00019f30: 6e61 6d65 2c20 7370 6f74 2e53 504f 545f  name, spot.SPOT_
+00019f40: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
+00019f50: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
+00019f60: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
+00019f70: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
+00019f80: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
+00019f90: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00019fa0: 0a20 2020 2020 2020 2027 7370 6f74 5f72  .        'spot_r
+00019fb0: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
+00019fc0: 6465 5f61 7773 272c 0a20 2020 2020 2020  de_aws',.       
+00019fd0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00019fe0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+00019ff0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+0001a000: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+0001a010: 6e20 7b6e 616d 657d 202d 2d6e 756d 2d6e  n {name} --num-n
+0001a020: 6f64 6573 2032 2022 6563 686f 2053 4b59  odes 2 "echo SKY
+0001a030: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
+0001a040: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
+0001a050: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
+0001a060: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+0001a070: 2020 2020 2773 6c65 6570 2034 3530 272c      'sleep 450',
+0001a080: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001a090: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+0001a0a0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+0001a0b0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001a0c0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+0001a0d0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+0001a0e0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
+0001a0f0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+0001a100: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+0001a110: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+0001a120: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
+0001a130: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
+0001a140: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+0001a150: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
+0001a160: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
+0001a170: 6520 7468 6520 776f 726b 6572 206d 616e  e the worker man
+0001a180: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+0001a190: 2020 2028 6627 6177 7320 6563 3220 7465     (f'aws ec2 te
+0001a1a0: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
+0001a1b0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001a1c0: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
+0001a1d0: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
+0001a1e0: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
+0001a1f0: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+0001a200: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001a210: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+0001a220: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
+0001a230: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
+0001a240: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
+0001a250: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 2a20  name_on_cloud}* 
+0001a260: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+0001a270: 4e61 6d65 3d74 6167 3a72 6179 2d6e 6f64  Name=tag:ray-nod
+0001a280: 652d 7479 7065 2c56 616c 7565 733d 776f  e-type,Values=wo
+0001a290: 726b 6572 2027 0a20 2020 2020 2020 2020  rker '.         
+0001a2a0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+0001a2b0: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+0001a2c0: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+0001a2d0: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+0001a2e0: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+0001a2f0: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
+0001a300: 2020 2773 6c65 6570 2035 3027 2c0a 2020    'sleep 50',.  
+0001a310: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001a320: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001a330: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001a340: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001a350: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+0001a360: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001a370: 3536 3027 2c0a 2020 2020 2020 2020 2020  560',.          
+0001a380: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001a390: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001a3a0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001a3b0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001a3c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001a3d0: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
+0001a3e0: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
+0001a3f0: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
+0001a400: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
+0001a410: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+0001a420: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+0001a430: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
+0001a440: 7420 2d64 3a20 2d66 3220 7c20 6772 6570  t -d: -f2 | grep
+0001a450: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
+0001a460: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001a470: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+0001a480: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+0001a490: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+0001a4a0: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+0001a4b0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+0001a4c0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001a4d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+0001a4e0: 700a 4070 7974 6573 742e 6d61 726b 2e6d  p.@pytest.mark.m
+0001a4f0: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
+0001a500: 7465 7374 5f73 706f 745f 7265 636f 7665  test_spot_recove
+0001a510: 7279 5f6d 756c 7469 5f6e 6f64 655f 6763  ry_multi_node_gc
+0001a520: 7028 293a 0a20 2020 2022 2222 5465 7374  p():.    """Test
+0001a530: 206d 616e 6167 6564 2073 706f 7420 7265   managed spot re
+0001a540: 636f 7665 7279 2e22 2222 0a20 2020 206e  covery.""".    n
+0001a550: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0001a560: 6572 5f6e 616d 6528 290a 2020 2020 6e61  er_name().    na
+0001a570: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
+0001a580: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+0001a590: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+0001a5a0: 636c 6f75 6428 0a20 2020 2020 2020 206e  cloud(.        n
+0001a5b0: 616d 652c 2073 706f 742e 5350 4f54 5f43  ame, spot.SPOT_C
+0001a5c0: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
+0001a5d0: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
+0001a5e0: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
+0001a5f0: 2020 2020 7a6f 6e65 203d 2027 7573 2d77      zone = 'us-w
+0001a600: 6573 7432 2d61 270a 2020 2020 2320 5573  est2-a'.    # Us
+0001a610: 6520 273a 2720 746f 206d 6174 6368 2061  e ':' to match a
+0001a620: 7320 7468 6520 636c 7573 7465 7220 6e61  s the cluster na
+0001a630: 6d65 2077 696c 6c20 636f 6e74 6169 6e20  me will contain 
+0001a640: 7468 6520 7375 6666 6978 2077 6974 6820  the suffix with 
+0001a650: 6a6f 6220 6964 0a20 2020 2071 7565 7279  job id.    query
+0001a660: 5f63 6d64 203d 2028 0a20 2020 2020 2020  _cmd = (.       
+0001a670: 2066 2767 636c 6f75 6420 636f 6d70 7574   f'gcloud comput
+0001a680: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+0001a690: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
+0001a6a0: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
+0001a6b0: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
+0001a6c0: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d20  {name_on_cloud} 
+0001a6d0: 414e 4420 270a 2020 2020 2020 2020 6627  AND '.        f'
+0001a6e0: 6c61 6265 6c73 2e72 6179 2d6e 6f64 652d  labels.ray-node-
+0001a6f0: 7479 7065 3d77 6f72 6b65 7229 2220 2d2d  type=worker)" --
+0001a700: 7a6f 6e65 733d 7b7a 6f6e 657d 202d 2d66  zones={zone} --f
+0001a710: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
+0001a720: 6529 2227 290a 2020 2020 7465 726d 696e  e)"').    termin
+0001a730: 6174 655f 636d 6420 3d20 2866 2767 636c  ate_cmd = (f'gcl
+0001a740: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+0001a750: 616e 6365 7320 6465 6c65 7465 202d 2d7a  ances delete --z
+0001a760: 6f6e 653d 7b7a 6f6e 657d 270a 2020 2020  one={zone}'.    
+0001a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a780: 2066 2720 2d2d 7175 6965 7420 2428 7b71   f' --quiet $({q
+0001a790: 7565 7279 5f63 6d64 7d29 2729 0a20 2020  uery_cmd})').   
+0001a7a0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001a7b0: 2020 2020 2020 2773 706f 745f 7265 636f        'spot_reco
+0001a7c0: 7665 7279 5f6d 756c 7469 5f6e 6f64 655f  very_multi_node_
+0001a7d0: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
+0001a7e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001a7f0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+0001a800: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
+0001a810: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
+0001a820: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
+0001a830: 2265 6368 6f20 534b 5950 494c 4f54 5f54  "echo SKYPILOT_T
+0001a840: 4153 4b5f 4944 3a20 5c24 534b 5950 494c  ASK_ID: \$SKYPIL
+0001a850: 4f54 5f54 4153 4b5f 4944 3b20 736c 6565  OT_TASK_ID; slee
+0001a860: 7020 3138 3030 2220 202d 7920 2d64 272c  p 1800"  -y -d',
+0001a870: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001a880: 6565 7020 3430 3027 2c0a 2020 2020 2020  eep 400',.      
+0001a890: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001a8a0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001a8b0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001a8c0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001a8d0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001a8e0: 2020 6627 5255 4e5f 4944 3d24 2873 6b79    f'RUN_ID=$(sky
+0001a8f0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+0001a900: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+0001a910: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+0001a920: 5f54 4153 4b5f 4944 207c 2063 7574 202d  _TASK_ID | cut -
+0001a930: 643a 202d 6632 293b 2065 6368 6f20 2224  d: -f2); echo "$
+0001a940: 5255 4e5f 4944 2220 7c20 7465 6520 2f74  RUN_ID" | tee /t
+0001a950: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+0001a960: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0001a970: 2054 6572 6d69 6e61 7465 2074 6865 2077   Terminate the w
+0001a980: 6f72 6b65 7220 6d61 6e75 616c 6c79 2e0a  orker manually..
+0001a990: 2020 2020 2020 2020 2020 2020 7465 726d              term
+0001a9a0: 696e 6174 655f 636d 642c 0a20 2020 2020  inate_cmd,.     
+0001a9b0: 2020 2020 2020 2027 736c 6565 7020 3530         'sleep 50
+0001a9c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001a9d0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001a9e0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001a9f0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001aa00: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
+0001aa10: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001aa20: 6c65 6570 2034 3230 272c 0a20 2020 2020  leep 420',.     
+0001aa30: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+0001aa40: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001aa50: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+0001aa60: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
+0001aa70: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+0001aa80: 2020 2066 2752 554e 5f49 443d 2428 6361     f'RUN_ID=$(ca
+0001aa90: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+0001aaa0: 6e2d 6964 293b 2065 6368 6f20 2452 554e  n-id); echo $RUN
+0001aab0: 5f49 443b 2073 6b79 2073 706f 7420 6c6f  _ID; sky spot lo
+0001aac0: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
+0001aad0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+0001aae0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
+0001aaf0: 207c 2063 7574 202d 643a 202d 6632 207c   | cut -d: -f2 |
+0001ab00: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+0001ab10: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0001ab20: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+0001ab30: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001ab40: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001ab50: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001ab60: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0001ab70: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001ab80: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0001ab90: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
+0001aba0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
+0001abb0: 0a64 6566 2074 6573 745f 7370 6f74 5f63  .def test_spot_c
+0001abc0: 616e 6365 6c6c 6174 696f 6e5f 6177 7328  ancellation_aws(
+0001abd0: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
+0001abe0: 6e29 3a0a 2020 2020 6e61 6d65 203d 205f  n):.    name = _
+0001abf0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0001ac00: 2829 0a20 2020 206e 616d 655f 6f6e 5f63  ().    name_on_c
+0001ac10: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
+0001ac20: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
+0001ac30: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
+0001ac40: 2020 2020 2020 2020 6e61 6d65 2c20 7370          name, sp
+0001ac50: 6f74 2e53 504f 545f 434c 5553 5445 525f  ot.SPOT_CLUSTER_
+0001ac60: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+0001ac70: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+0001ac80: 683d 4661 6c73 6529 0a20 2020 206e 616d  h=False).    nam
+0001ac90: 655f 325f 6f6e 5f63 6c6f 7564 203d 2063  e_2_on_cloud = c
+0001aca0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+0001acb0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+0001acc0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+0001acd0: 6627 7b6e 616d 657d 2d32 272c 2073 706f  f'{name}-2', spo
+0001ace0: 742e 5350 4f54 5f43 4c55 5354 4552 5f4e  t.SPOT_CLUSTER_N
+0001acf0: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
+0001ad00: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
+0001ad10: 3d46 616c 7365 290a 2020 2020 6e61 6d65  =False).    name
+0001ad20: 5f33 5f6f 6e5f 636c 6f75 6420 3d20 636f  _3_on_cloud = co
+0001ad30: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+0001ad40: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+0001ad50: 636c 6f75 6428 0a20 2020 2020 2020 2066  cloud(.        f
+0001ad60: 277b 6e61 6d65 7d2d 3327 2c20 7370 6f74  '{name}-3', spot
+0001ad70: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
+0001ad80: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
+0001ad90: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
+0001ada0: 4661 6c73 6529 0a20 2020 2072 6567 696f  False).    regio
+0001adb0: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
+0001adc0: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
+0001add0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001ade0: 7370 6f74 5f63 616e 6365 6c6c 6174 696f  spot_cancellatio
+0001adf0: 6e5f 6177 7327 2c0a 2020 2020 2020 2020  n_aws',.        
+0001ae00: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
+0001ae10: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
+0001ae20: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
+0001ae30: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
+0001ae40: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
+0001ae50: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+0001ae60: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
+0001ae70: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+0001ae80: 7d20 2d6e 207b 6e61 6d65 7d20 2273 6c65  } -n {name} "sle
+0001ae90: 6570 2031 3030 3022 2020 2d79 202d 6427  ep 1000"  -y -d'
+0001aea0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001aeb0: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+0001aec0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001aed0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001aee0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001aef0: 6e31 207c 2067 7265 7020 2253 5441 5254  n1 | grep "START
+0001af00: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+0001af10: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+0001af20: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+0001af30: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+0001af40: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0001af50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001af60: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001af70: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001af80: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001af90: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+0001afa0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+0001afb0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001afc0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
+0001afd0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+0001afe0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001aff0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001b000: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+0001b010: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001b020: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
+0001b030: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
+0001b040: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001b050: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001b060: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+0001b070: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+0001b080: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+0001b090: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d2d  {name_on_cloud}-
+0001b0a0: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
+0001b0b0: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+0001b0c0: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+0001b0d0: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
+0001b0e0: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
+0001b0f0: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
+0001b100: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0001b110: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
+0001b120: 7322 205d 5d20 7c7c 205b 5b20 2224 7322  s" ]] || [[ "$s"
+0001b130: 203d 2022 7465 726d 696e 6174 6564 2220   = "terminated" 
+0001b140: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+0001b150: 2273 6875 7474 696e 672d 646f 776e 2220  "shutting-down" 
+0001b160: 5d5d 270a 2020 2020 2020 2020 2020 2020  ]]'.            
+0001b170: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
+0001b180: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
+0001b190: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
+0001b1a0: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
+0001b1b0: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
+0001b1c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001b1d0: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+0001b1e0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001b1f0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001b200: 616d 657d 2d32 2074 6573 7473 2f74 6573  ame}-2 tests/tes
+0001b210: 745f 7961 6d6c 732f 7465 7374 5f6c 6f6e  t_yamls/test_lon
+0001b220: 675f 7365 7475 702e 7961 6d6c 2020 2d79  g_setup.yaml  -y
+0001b230: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001b240: 2020 2773 6c65 6570 2033 3030 272c 0a20    'sleep 300',. 
+0001b250: 2020 2020 2020 2020 2020 205f 5350 4f54             _SPOT
+0001b260: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
+0001b270: 6d61 7428 6a6f 625f 6e61 6d65 3d66 277b  mat(job_name=f'{
+0001b280: 6e61 6d65 7d2d 3227 292c 0a20 2020 2020  name}-2'),.     
+0001b290: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
+0001b2a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b2b0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+0001b2c0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+0001b2d0: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
+0001b2e0: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
+0001b2f0: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
+0001b300: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001b310: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
+0001b320: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001b330: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001b340: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
+0001b350: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001b360: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001b370: 2020 2028 6627 733d 2428 6177 7320 6563     (f's=$(aws ec
+0001b380: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
+0001b390: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+0001b3a0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+0001b3b0: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+0001b3c0: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
+0001b3d0: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+0001b3e0: 6573 3d7b 6e61 6d65 5f32 5f6f 6e5f 636c  es={name_2_on_cl
+0001b3f0: 6f75 647d 2d2a 2027 0a20 2020 2020 2020  oud}-* '.       
+0001b400: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
+0001b410: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
+0001b420: 6e73 7461 6e63 6573 5b5d 2e53 7461 7465  nstances[].State
+0001b430: 5b5d 2e4e 616d 6520 270a 2020 2020 2020  [].Name '.      
+0001b440: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
+0001b450: 2074 6578 7429 2026 2620 6563 686f 2022   text) && echo "
+0001b460: 2473 2220 2626 2065 6368 6f3b 205b 5b20  $s" && echo; [[ 
+0001b470: 2d7a 2022 2473 2220 5d5d 207c 7c20 5b5b  -z "$s" ]] || [[
+0001b480: 2022 2473 2220 3d20 2274 6572 6d69 6e61   "$s" = "termina
+0001b490: 7465 6422 205d 5d20 7c7c 205b 5b20 2224  ted" ]] || [[ "$
+0001b4a0: 7322 203d 2022 7368 7574 7469 6e67 2d64  s" = "shutting-d
+0001b4b0: 6f77 6e22 205d 5d27 0a20 2020 2020 2020  own" ]]'.       
+0001b4c0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0001b4d0: 2020 2020 2320 5465 7374 2063 616e 6365      # Test cance
+0001b4e0: 6c6c 6174 696f 6e20 6475 7269 6e67 2073  llation during s
+0001b4f0: 706f 7420 6a6f 6220 6973 2072 6563 6f76  pot job is recov
+0001b500: 6572 696e 672e 0a20 2020 2020 2020 2020  ering..         
+0001b510: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
+0001b520: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
+0001b530: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+0001b540: 6e7d 202d 6e20 7b6e 616d 657d 2d33 2022  n} -n {name}-3 "
+0001b550: 736c 6565 7020 3130 3030 2220 202d 7920  sleep 1000"  -y 
+0001b560: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+0001b570: 2027 736c 6565 7020 3330 3027 2c0a 2020   'sleep 300',.  
+0001b580: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001b590: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001b5a0: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
+0001b5b0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001b5c0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+0001b5d0: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
+0001b5e0: 6174 6520 7468 6520 636c 7573 7465 7220  ate the cluster 
+0001b5f0: 6d61 6e75 616c 6c79 2e0a 2020 2020 2020  manually..      
+0001b600: 2020 2020 2020 2866 2761 7773 2065 6332        (f'aws ec2
+0001b610: 2074 6572 6d69 6e61 7465 2d69 6e73 7461   terminate-insta
+0001b620: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
+0001b630: 6567 696f 6e7d 202d 2d69 6e73 7461 6e63  egion} --instanc
+0001b640: 652d 6964 7320 2428 270a 2020 2020 2020  e-ids $('.      
+0001b650: 2020 2020 2020 2066 2761 7773 2065 6332         f'aws ec2
+0001b660: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
+0001b670: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
+0001b680: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
+0001b690: 2020 2020 2066 272d 2d66 696c 7465 7273       f'--filters
+0001b6a0: 204e 616d 653d 7461 673a 7261 792d 636c   Name=tag:ray-cl
+0001b6b0: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
+0001b6c0: 733d 7b6e 616d 655f 335f 6f6e 5f63 6c6f  s={name_3_on_clo
+0001b6d0: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
+0001b6e0: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
+0001b6f0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
+0001b700: 7374 616e 6365 735b 5d2e 496e 7374 616e  stances[].Instan
+0001b710: 6365 4964 2027 0a20 2020 2020 2020 2020  ceId '.         
+0001b720: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
+0001b730: 7874 2927 292c 0a20 2020 2020 2020 2020  xt)'),.         
+0001b740: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+0001b750: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001b760: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+0001b770: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0001b780: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001b790: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
+0001b7a0: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
+0001b7b0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+0001b7c0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+0001b7d0: 277b 6e61 6d65 7d2d 3327 292c 0a20 2020  '{name}-3'),.   
+0001b7e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001b7f0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0001b800: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001b810: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001b820: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
+0001b830: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
+0001b840: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
+0001b850: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001b860: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
+0001b870: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+0001b880: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001b890: 7b6e 616d 657d 2d33 207c 2068 6561 6420  {name}-3 | head 
+0001b8a0: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
+0001b8b0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+0001b8c0: 2020 2020 2023 2054 6865 2063 6c75 7374       # The clust
+0001b8d0: 6572 2073 686f 756c 6420 6265 2074 6572  er should be ter
+0001b8e0: 6d69 6e61 7465 6420 2873 6875 7474 696e  minated (shuttin
+0001b8f0: 672d 646f 776e 2920 6166 7465 7220 6361  g-down) after ca
+0001b900: 6e63 656c 6c61 7469 6f6e 2e20 5765 2064  ncellation. We d
+0001b910: 6f6e 2774 2075 7365 2074 6865 2060 3d60  on't use the `=`
+0001b920: 206f 7065 7261 746f 7220 6865 7265 2062   operator here b
+0001b930: 6563 6175 7365 0a20 2020 2020 2020 2020  ecause.         
+0001b940: 2020 2023 2074 6865 7265 2063 616e 2062     # there can b
+0001b950: 6520 6d75 6c74 6970 6c65 2056 4d20 7769  e multiple VM wi
+0001b960: 7468 2074 6865 2073 616d 6520 6e61 6d65  th the same name
+0001b970: 2064 7565 2074 6f20 7468 6520 7265 636f   due to the reco
+0001b980: 7665 7279 2e0a 2020 2020 2020 2020 2020  very..          
+0001b990: 2020 2866 2773 3d24 2861 7773 2065 6332    (f's=$(aws ec2
+0001b9a0: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
+0001b9b0: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
+0001b9c0: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
+0001b9d0: 2020 2020 2066 272d 2d66 696c 7465 7273       f'--filters
+0001b9e0: 204e 616d 653d 7461 673a 7261 792d 636c   Name=tag:ray-cl
+0001b9f0: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
+0001ba00: 733d 7b6e 616d 655f 335f 6f6e 5f63 6c6f  s={name_3_on_clo
+0001ba10: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
+0001ba20: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
+0001ba30: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
+0001ba40: 7374 616e 6365 735b 5d2e 5374 6174 655b  stances[].State[
+0001ba50: 5d2e 4e61 6d65 2027 0a20 2020 2020 2020  ].Name '.       
+0001ba60: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+0001ba70: 7465 7874 2920 2626 2065 6368 6f20 2224  text) && echo "$
+0001ba80: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
+0001ba90: 7a20 2224 7322 205d 5d20 7c7c 2065 6368  z "$s" ]] || ech
+0001baa0: 6f20 2224 7322 207c 2067 7265 7020 2d76  o "$s" | grep -v
+0001bab0: 202d 4520 2270 656e 6469 6e67 7c72 756e   -E "pending|run
+0001bac0: 6e69 6e67 7c73 746f 7070 6564 7c73 746f  ning|stopped|sto
+0001bad0: 7070 696e 6722 270a 2020 2020 2020 2020  pping"'.        
+0001bae0: 2020 2020 292c 0a20 2020 2020 2020 205d      ),.        ]
+0001baf0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0001bb00: 743d 3235 202a 2036 3029 0a20 2020 2072  t=25 * 60).    r
+0001bb10: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001bb20: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001bb30: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
+0001bb40: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+0001bb50: 6566 2074 6573 745f 7370 6f74 5f63 616e  ef test_spot_can
+0001bb60: 6365 6c6c 6174 696f 6e5f 6763 7028 293a  cellation_gcp():
+0001bb70: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0001bb80: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0001bb90: 2020 2020 6e61 6d65 5f33 203d 2066 277b      name_3 = f'{
+0001bba0: 6e61 6d65 7d2d 3327 0a20 2020 206e 616d  name}-3'.    nam
+0001bbb0: 655f 335f 6f6e 5f63 6c6f 7564 203d 2063  e_3_on_cloud = c
+0001bbc0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+0001bbd0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+0001bbe0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+0001bbf0: 6e61 6d65 5f33 2c20 7370 6f74 2e53 504f  name_3, spot.SPO
+0001bc00: 545f 434c 5553 5445 525f 4e41 4d45 5f50  T_CLUSTER_NAME_P
+0001bc10: 5245 4649 585f 4c45 4e47 5448 2c20 6164  REFIX_LENGTH, ad
+0001bc20: 645f 7573 6572 5f68 6173 683d 4661 6c73  d_user_hash=Fals
+0001bc30: 6529 0a20 2020 207a 6f6e 6520 3d20 2775  e).    zone = 'u
+0001bc40: 732d 7765 7374 332d 6227 0a20 2020 2071  s-west3-b'.    q
+0001bc50: 7565 7279 5f73 7461 7465 5f63 6d64 203d  uery_state_cmd =
+0001bc60: 2028 0a20 2020 2020 2020 2027 6763 6c6f   (.        'gclo
+0001bc70: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+0001bc80: 6e63 6573 206c 6973 7420 270a 2020 2020  nces list '.    
+0001bc90: 2020 2020 6627 2d2d 6669 6c74 6572 3d22      f'--filter="
+0001bca0: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
+0001bcb0: 7465 722d 6e61 6d65 3a7b 6e61 6d65 5f33  ter-name:{name_3
+0001bcc0: 5f6f 6e5f 636c 6f75 647d 2922 2027 0a20  _on_cloud})" '. 
+0001bcd0: 2020 2020 2020 2027 2d2d 666f 726d 6174         '--format
+0001bce0: 3d22 7661 6c75 6528 7374 6174 7573 2922  ="value(status)"
+0001bcf0: 2729 0a20 2020 2071 7565 7279 5f63 6d64  ').    query_cmd
+0001bd00: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+0001bd10: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+0001bd20: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
+0001bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd40: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
+0001bd50: 6c75 7374 6572 2d6e 616d 653a 7b6e 616d  luster-name:{nam
+0001bd60: 655f 335f 6f6e 5f63 6c6f 7564 7d29 2220  e_3_on_cloud})" 
+0001bd70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001bd80: 2020 2066 272d 2d7a 6f6e 6573 3d7b 7a6f     f'--zones={zo
+0001bd90: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
+0001bda0: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
+0001bdb0: 2074 6572 6d69 6e61 7465 5f63 6d64 203d   terminate_cmd =
+0001bdc0: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
+0001bdd0: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
+0001bde0: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
+0001bdf0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+0001be00: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
+0001be10: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
+0001be20: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
+0001be30: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+0001be40: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
+0001be50: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
+0001be60: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001be70: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+0001be80: 6475 7269 6e67 2073 706f 7420 636c 7573  during spot clus
+0001be90: 7465 7220 6265 696e 6720 6c61 756e 6368  ter being launch
+0001bea0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0001beb0: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
+0001bec0: 6820 2d2d 636c 6f75 6420 6763 7020 2d2d  h --cloud gcp --
+0001bed0: 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e 207b  zone {zone} -n {
+0001bee0: 6e61 6d65 7d20 2273 6c65 6570 2031 3030  name} "sleep 100
+0001bef0: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
+0001bf00: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
+0001bf10: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001bf20: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001bf30: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001bf40: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001bf50: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
+0001bf60: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
+0001bf70: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+0001bf80: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001bf90: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
+0001bfa0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0001bfb0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+0001bfc0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+0001bfd0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001bfe0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001bff0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+0001c000: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001c010: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+0001c020: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001c030: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+0001c040: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0001c050: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001c060: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
+0001c070: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
+0001c080: 2063 616e 6365 6c6c 696e 6720 7468 6520   cancelling the 
+0001c090: 7370 6f74 2063 6c75 7374 6572 2064 7572  spot cluster dur
+0001c0a0: 696e 6720 7370 6f74 206a 6f62 2062 6569  ing spot job bei
+0001c0b0: 6e67 2073 6574 7570 2e0a 2020 2020 2020  ng setup..      
+0001c0c0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
+0001c0d0: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+0001c0e0: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+0001c0f0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 7465  } -n {name}-2 te
+0001c100: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+0001c110: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
+0001c120: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
+0001c130: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001c140: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
+0001c150: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
+0001c160: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+0001c170: 616d 653d 6627 7b6e 616d 657d 2d32 2729  ame=f'{name}-2')
+0001c180: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001c190: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0001c1a0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+0001c1b0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001c1c0: 7b6e 616d 657d 2d32 207c 2068 6561 6420  {name}-2 | head 
+0001c1d0: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
+0001c1e0: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
+0001c1f0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+0001c200: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
+0001c210: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+0001c220: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+0001c230: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
+0001c240: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001c250: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
+0001c260: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
+0001c270: 2063 616e 6365 6c6c 6174 696f 6e20 6475   cancellation du
+0001c280: 7269 6e67 2073 706f 7420 6a6f 6220 6973  ring spot job is
+0001c290: 2072 6563 6f76 6572 696e 672e 0a20 2020   recovering..   
+0001c2a0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+0001c2b0: 706f 7420 6c61 756e 6368 202d 2d63 6c6f  pot launch --clo
+0001c2c0: 7564 2067 6370 202d 2d7a 6f6e 6520 7b7a  ud gcp --zone {z
+0001c2d0: 6f6e 657d 202d 6e20 7b6e 616d 657d 2d33  one} -n {name}-3
+0001c2e0: 2022 736c 6565 7020 3130 3030 2220 202d   "sleep 1000"  -
+0001c2f0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+0001c300: 2020 2027 736c 6565 7020 3330 3027 2c0a     'sleep 300',.
+0001c310: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001c320: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+0001c330: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0001c340: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001c350: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+0001c360: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+0001c370: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+0001c380: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001c390: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
+0001c3a0: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
+0001c3b0: 2020 2027 736c 6565 7020 3830 272c 0a20     'sleep 80',. 
+0001c3c0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+0001c3d0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+0001c3e0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0001c3f0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001c400: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+0001c410: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+0001c420: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+0001c430: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+0001c440: 7b6e 616d 657d 2d33 2729 2c0a 2020 2020  {name}-3'),.    
+0001c450: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0001c460: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001c470: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+0001c480: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001c490: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+0001c4a0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+0001c4b0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+0001c4c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001c4d0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+0001c4e0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+0001c4f0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001c500: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+0001c510: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+0001c520: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+0001c530: 2020 2020 2320 5468 6520 636c 7573 7465      # The cluste
+0001c540: 7220 7368 6f75 6c64 2062 6520 7465 726d  r should be term
+0001c550: 696e 6174 6564 2028 5354 4f50 5049 4e47  inated (STOPPING
+0001c560: 2920 6166 7465 7220 6361 6e63 656c 6c61  ) after cancella
+0001c570: 7469 6f6e 2e20 5765 2064 6f6e 2774 2075  tion. We don't u
+0001c580: 7365 2074 6865 2060 3d60 206f 7065 7261  se the `=` opera
+0001c590: 746f 7220 6865 7265 2062 6563 6175 7365  tor here because
+0001c5a0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+0001c5b0: 6865 7265 2063 616e 2062 6520 6d75 6c74  here can be mult
+0001c5c0: 6970 6c65 2056 4d20 7769 7468 2074 6865  iple VM with the
+0001c5d0: 2073 616d 6520 6e61 6d65 2064 7565 2074   same name due t
+0001c5e0: 6f20 7468 6520 7265 636f 7665 7279 2e0a  o the recovery..
+0001c5f0: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
+0001c600: 3d24 287b 7175 6572 795f 7374 6174 655f  =$({query_state_
+0001c610: 636d 647d 2920 2626 2065 6368 6f20 2224  cmd}) && echo "$
+0001c620: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
+0001c630: 7a20 2224 7322 205d 5d20 7c7c 2065 6368  z "$s" ]] || ech
+0001c640: 6f20 2224 7322 207c 2067 7265 7020 2d76  o "$s" | grep -v
+0001c650: 202d 4520 2250 524f 5649 5349 4f4e 494e   -E "PROVISIONIN
+0001c660: 477c 5354 4147 494e 477c 5255 4e4e 494e  G|STAGING|RUNNIN
+0001c670: 477c 5245 5041 4952 494e 477c 5445 524d  G|REPAIRING|TERM
+0001c680: 494e 4154 4544 7c53 5553 5045 4e44 494e  INATED|SUSPENDIN
+0001c690: 477c 5355 5350 454e 4445 447c 5355 5350  G|SUSPENDED|SUSP
+0001c6a0: 454e 4445 4422 270a 2020 2020 2020 2020  ENDED"'.        
+0001c6b0: 2020 2020 292c 0a20 2020 2020 2020 205d      ),.        ]
+0001c6c0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0001c6d0: 743d 3235 202a 2036 3029 0a20 2020 2072  t=25 * 60).    r
+0001c6e0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001c6f0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0001c700: 2054 6573 7469 6e67 2073 746f 7261 6765   Testing storage
+0001c710: 2066 6f72 206d 616e 6167 6564 2073 706f   for managed spo
+0001c720: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
+0001c730: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+0001c740: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+0001c750: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+0001c760: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0001c770: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0001c780: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
+0001c790: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
+0001c7a0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0001c7b0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001c7c0: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+0001c7d0: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
+0001c7e0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+0001c7f0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+0001c800: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0001c810: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
+0001c820: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+0001c830: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+0001c840: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001c850: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
+0001c860: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
+0001c870: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+0001c880: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+0001c890: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+0001c8a0: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+0001c8b0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001c8c0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001c8d0: 6172 6b2e 6e6f 5f6b 7562 6572 6e65 7465  ark.no_kubernete
+0001c8e0: 7320 2023 204b 7562 6572 6e65 7465 7320  s  # Kubernetes 
+0001c8f0: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
+0001c900: 6e6f 7469 6f6e 206f 6620 7370 6f74 2069  notion of spot i
+0001c910: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001c920: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+0001c930: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+0001c940: 5f73 746f 7261 6765 2867 656e 6572 6963  _storage(generic
+0001c950: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+0001c960: 2020 2222 2254 6573 7420 7374 6f72 6167    """Test storag
+0001c970: 6520 7769 7468 206d 616e 6167 6564 2073  e with managed s
+0001c980: 706f 7422 2222 0a20 2020 206e 616d 6520  pot""".    name 
+0001c990: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001c9a0: 616d 6528 290a 2020 2020 7961 6d6c 5f73  ame().    yaml_s
+0001c9b0: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+0001c9c0: 6828 0a20 2020 2020 2020 2027 6578 616d  h(.        'exam
+0001c9d0: 706c 6573 2f6d 616e 6167 6564 5f73 706f  ples/managed_spo
+0001c9e0: 745f 7769 7468 5f73 746f 7261 6765 2e79  t_with_storage.y
+0001c9f0: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
+0001ca00: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
+0001ca10: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
+0001ca20: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
+0001ca30: 297d 270a 0a20 2020 2023 2041 6c73 6f20  )}'..    # Also 
+0001ca40: 7065 7266 6f72 6d20 7265 6769 6f6e 2074  perform region t
+0001ca50: 6573 7469 6e67 2066 6f72 2062 7563 6b65  esting for bucke
+0001ca60: 7420 6372 6561 7469 6f6e 2074 6f20 7661  t creation to va
+0001ca70: 6c69 6461 7465 2069 6620 6275 636b 6574  lidate if bucket
+0001ca80: 7320 6172 650a 2020 2020 2320 6372 6561  s are.    # crea
+0001ca90: 7465 6420 696e 2074 6865 2063 6f72 7265  ted in the corre
+0001caa0: 6374 2072 6567 696f 6e20 616e 6420 636f  ct region and co
+0001cab0: 7272 6563 746c 7920 6d6f 756e 7465 6420  rrectly mounted 
+0001cac0: 696e 2073 706f 7420 6a6f 6273 2e0a 2020  in spot jobs..  
+0001cad0: 2020 2320 486f 7765 7665 722c 2077 6520    # However, we 
+0001cae0: 696e 6a65 6374 2074 6869 7320 7465 7374  inject this test
+0001caf0: 696e 6720 6f6e 6c79 2066 6f72 2041 5753  ing only for AWS
+0001cb00: 2061 6e64 2047 4350 2073 696e 6365 2074   and GCP since t
+0001cb10: 6865 7920 6172 6520 7468 650a 2020 2020  hey are the.    
+0001cb20: 2320 7375 7070 6f72 7465 6420 6f62 6a65  # supported obje
+0001cb30: 6374 2073 746f 7261 6765 2070 726f 7669  ct storage provi
+0001cb40: 6465 7273 2069 6e20 536b 7950 696c 6f74  ders in SkyPilot
+0001cb50: 2e0a 2020 2020 7265 6769 6f6e 5f66 6c61  ..    region_fla
+0001cb60: 6720 3d20 2727 0a20 2020 2072 6567 696f  g = ''.    regio
+0001cb70: 6e5f 7661 6c69 6461 7469 6f6e 5f63 6d64  n_validation_cmd
+0001cb80: 203d 2027 7472 7565 270a 2020 2020 6966   = 'true'.    if
+0001cb90: 2067 656e 6572 6963 5f63 6c6f 7564 203d   generic_cloud =
+0001cba0: 3d20 2761 7773 273a 0a20 2020 2020 2020  = 'aws':.       
+0001cbb0: 2072 6567 696f 6e20 3d20 2765 752d 6365   region = 'eu-ce
+0001cbc0: 6e74 7261 6c2d 3127 0a20 2020 2020 2020  ntral-1'.       
+0001cbd0: 2072 6567 696f 6e5f 666c 6167 203d 2066   region_flag = f
+0001cbe0: 2720 2d2d 7265 6769 6f6e 207b 7265 6769  ' --region {regi
+0001cbf0: 6f6e 7d27 0a20 2020 2020 2020 2072 6567  on}'.        reg
+0001cc00: 696f 6e5f 636d 6420 3d20 5465 7374 5374  ion_cmd = TestSt
+0001cc10: 6f72 6167 6557 6974 6843 7265 6465 6e74  orageWithCredent
+0001cc20: 6961 6c73 2e63 6c69 5f72 6567 696f 6e5f  ials.cli_region_
+0001cc30: 636d 6428 0a20 2020 2020 2020 2020 2020  cmd(.           
+0001cc40: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0001cc50: 7265 5479 7065 2e53 332c 2073 746f 7261  reType.S3, stora
+0001cc60: 6765 5f6e 616d 6529 0a20 2020 2020 2020  ge_name).       
+0001cc70: 2072 6567 696f 6e5f 7661 6c69 6461 7469   region_validati
+0001cc80: 6f6e 5f63 6d64 203d 2066 277b 7265 6769  on_cmd = f'{regi
+0001cc90: 6f6e 5f63 6d64 7d20 7c20 6772 6570 207b  on_cmd} | grep {
+0001cca0: 7265 6769 6f6e 7d27 0a20 2020 2065 6c69  region}'.    eli
+0001ccb0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+0001ccc0: 3d3d 2027 6763 7027 3a0a 2020 2020 2020  == 'gcp':.      
+0001ccd0: 2020 7265 6769 6f6e 203d 2027 7573 2d77    region = 'us-w
+0001cce0: 6573 7432 270a 2020 2020 2020 2020 7265  est2'.        re
+0001ccf0: 6769 6f6e 5f66 6c61 6720 3d20 6627 202d  gion_flag = f' -
+0001cd00: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+0001cd10: 270a 2020 2020 2020 2020 7265 6769 6f6e  '.        region
+0001cd20: 5f63 6d64 203d 2054 6573 7453 746f 7261  _cmd = TestStora
+0001cd30: 6765 5769 7468 4372 6564 656e 7469 616c  geWithCredential
+0001cd40: 732e 636c 695f 7265 6769 6f6e 5f63 6d64  s.cli_region_cmd
+0001cd50: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+0001cd60: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001cd70: 7970 652e 4743 532c 2073 746f 7261 6765  ype.GCS, storage
+0001cd80: 5f6e 616d 6529 0a20 2020 2020 2020 2072  _name).        r
+0001cd90: 6567 696f 6e5f 7661 6c69 6461 7469 6f6e  egion_validation
+0001cda0: 5f63 6d64 203d 2066 277b 7265 6769 6f6e  _cmd = f'{region
+0001cdb0: 5f63 6d64 7d20 7c20 6772 6570 207b 7265  _cmd} | grep {re
+0001cdc0: 6769 6f6e 7d27 0a0a 2020 2020 7961 6d6c  gion}'..    yaml
+0001cdd0: 5f73 7472 203d 2079 616d 6c5f 7374 722e  _str = yaml_str.
+0001cde0: 7265 706c 6163 6528 2773 6b79 2d77 6f72  replace('sky-wor
+0001cdf0: 6b64 6972 2d7a 6877 7527 2c20 7374 6f72  kdir-zhwu', stor
+0001ce00: 6167 655f 6e61 6d65 290a 2020 2020 7769  age_name).    wi
+0001ce10: 7468 2074 656d 7066 696c 652e 4e61 6d65  th tempfile.Name
+0001ce20: 6454 656d 706f 7261 7279 4669 6c65 2873  dTemporaryFile(s
+0001ce30: 7566 6669 783d 272e 7961 6d6c 272c 206d  uffix='.yaml', m
+0001ce40: 6f64 653d 2777 2729 2061 7320 663a 0a20  ode='w') as f:. 
+0001ce50: 2020 2020 2020 2066 2e77 7269 7465 2879         f.write(y
+0001ce60: 616d 6c5f 7374 7229 0a20 2020 2020 2020  aml_str).       
+0001ce70: 2066 2e66 6c75 7368 2829 0a20 2020 2020   f.flush().     
+0001ce80: 2020 2066 696c 655f 7061 7468 203d 2066     file_path = f
+0001ce90: 2e6e 616d 650a 2020 2020 2020 2020 7465  .name.        te
+0001cea0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0001ceb0: 2020 2020 2020 2027 7370 6f74 5f73 746f         'spot_sto
+0001cec0: 7261 6765 272c 0a20 2020 2020 2020 2020  rage',.         
+0001ced0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001cee0: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
+0001cef0: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
+0001cf00: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001cf10: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+0001cf20: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+0001cf30: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0001cf40: 7d7b 7265 6769 6f6e 5f66 6c61 677d 207b  }{region_flag} {
+0001cf50: 6669 6c65 5f70 6174 687d 202d 7927 2c0a  file_path} -y',.
+0001cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf70: 7265 6769 6f6e 5f76 616c 6964 6174 696f  region_validatio
+0001cf80: 6e5f 636d 642c 2020 2320 4368 6563 6b20  n_cmd,  # Check 
+0001cf90: 6966 2074 6865 2062 7563 6b65 7420 6973  if the bucket is
+0001cfa0: 2063 7265 6174 6564 2069 6e20 7468 6520   created in the 
+0001cfb0: 636f 7272 6563 7420 7265 6769 6f6e 0a20  correct region. 
+0001cfc0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001cfd0: 736c 6565 7020 3630 272c 2020 2320 5761  sleep 60',  # Wa
+0001cfe0: 6974 2074 6865 2073 706f 7420 7175 6575  it the spot queu
+0001cff0: 6520 746f 2062 6520 7570 6461 7465 640a  e to be updated.
+0001d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d010: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0001d020: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001d030: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+0001d040: 4544 272c 0a20 2020 2020 2020 2020 2020  ED',.           
+0001d050: 2020 2020 2066 275b 2024 2861 7773 2073       f'[ $(aws s
+0001d060: 3361 7069 206c 6973 742d 6275 636b 6574  3api list-bucket
+0001d070: 7320 2d2d 7175 6572 7920 2242 7563 6b65  s --query "Bucke
+0001d080: 7473 5b3f 636f 6e74 6169 6e73 284e 616d  ts[?contains(Nam
+0001d090: 652c 205c 277b 7374 6f72 6167 655f 6e61  e, \'{storage_na
+0001d0a0: 6d65 7d5c 2729 5d2e 4e61 6d65 2220 2d2d  me}\')].Name" --
+0001d0b0: 6f75 7470 7574 2074 6578 7420 7c20 7763  output text | wc
+0001d0c0: 202d 6c29 202d 6571 2030 205d 270a 2020   -l) -eq 0 ]'.  
+0001d0d0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+0001d0e0: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+0001d0f0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+0001d100: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+0001d110: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0001d120: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
+0001d130: 2073 696e 6365 2073 6b79 2073 706f 7420   since sky spot 
+0001d140: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
+0001d150: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
+0001d160: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
+0001d170: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+0001d180: 3d32 3020 2a20 3630 2c0a 2020 2020 2020  =20 * 60,.      
+0001d190: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
+0001d1a0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0001d1b0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+0001d1c0: 7374 696e 6720 7370 6f74 2054 5055 202d  sting spot TPU -
+0001d1d0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+0001d1e0: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
+0001d1f0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+0001d200: 7370 6f74 0a40 7079 7465 7374 2e6d 6172  spot.@pytest.mar
+0001d210: 6b2e 7470 750a 6465 6620 7465 7374 5f73  k.tpu.def test_s
+0001d220: 706f 745f 7470 7528 293a 0a20 2020 2022  pot_tpu():.    "
+0001d230: 2222 5465 7374 206d 616e 6167 6564 2073  ""Test managed s
+0001d240: 706f 7420 6f6e 2054 5055 2e22 2222 0a20  pot on TPU.""". 
+0001d250: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001d260: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0001d270: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0001d280: 2020 2020 2020 2027 7465 7374 2d73 706f         'test-spo
+0001d290: 742d 7470 7527 2c0a 2020 2020 2020 2020  t-tpu',.        
+0001d2a0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0001d2b0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+0001d2c0: 2d6e 207b 6e61 6d65 7d20 6578 616d 706c  -n {name} exampl
+0001d2d0: 6573 2f74 7075 2f74 7075 766d 5f6d 6e69  es/tpu/tpuvm_mni
+0001d2e0: 7374 2e79 616d 6c20 2d79 202d 6427 2c0a  st.yaml -y -d',.
+0001d2f0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001d300: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0001d310: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001d320: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001d330: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001d340: 7c20 6772 6570 2053 5441 5254 494e 4727  | grep STARTING'
+0001d350: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001d360: 6c65 6570 2038 3430 272c 2020 2320 5450  leep 840',  # TP
+0001d370: 5520 7461 6b65 7320 6120 7768 696c 6520  U takes a while 
+0001d380: 746f 206c 6175 6e63 680a 2020 2020 2020  to launch.      
+0001d390: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0001d3a0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001d3b0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001d3c0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001d3d0: 4e47 5c7c 5355 4343 4545 4445 4422 272c  NG\|SUCCEEDED"',
+0001d3e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001d3f0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+0001d400: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+0001d410: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+0001d420: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
+0001d430: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
+0001d440: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
+0001d450: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
+0001d460: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
+0001d470: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
+0001d480: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+0001d490: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0001d4a0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0001d4b0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+0001d4c0: 2065 6e76 2066 6f72 2073 706f 7420 2d2d   env for spot --
+0001d4d0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+0001d4e0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0001d4f0: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
+0001d500: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
+0001d510: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
+0001d520: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
+0001d530: 6f5f 617a 7572 6520 2023 2041 7a75 7265  o_azure  # Azure
+0001d540: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+0001d550: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+0001d560: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0001d570: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+0001d580: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
+0001d590: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001d5a0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001d5b0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+0001d5c0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+0001d5d0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001d5e0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001d5f0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+0001d600: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
+0001d610: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+0001d620: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0001d630: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+0001d640: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+0001d650: 6365 2064 6f65 7320 6e6f 7420 7375 7070  ce does not supp
+0001d660: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+0001d670: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001d680: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
+0001d690: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
+0001d6a0: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
+0001d6b0: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
+0001d6c0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001d6d0: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+0001d6e0: 6566 2074 6573 745f 7370 6f74 5f69 6e6c  ef test_spot_inl
+0001d6f0: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
+0001d700: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0001d710: 2022 2222 5465 7374 2073 706f 7420 656e   """Test spot en
+0001d720: 7622 2222 0a20 2020 206e 616d 6520 3d20  v""".    name = 
+0001d730: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001d740: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0001d750: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
+0001d760: 7374 2d73 706f 742d 696e 6c69 6e65 2d65  st-spot-inline-e
+0001d770: 6e76 272c 0a20 2020 2020 2020 205b 0a20  nv',.        [. 
+0001d780: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001d790: 2073 706f 7420 6c61 756e 6368 202d 6e20   spot launch -n 
+0001d7a0: 7b6e 616d 657d 202d 7920 2d2d 636c 6f75  {name} -y --clou
+0001d7b0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0001d7c0: 7d20 2d2d 656e 7620 5445 5354 5f45 4e56  } --env TEST_ENV
+0001d7d0: 3d22 6865 6c6c 6f20 776f 726c 6422 202d  ="hello world" -
+0001d7e0: 2d20 2228 5b5b 2021 202d 7a20 5c5c 225c  - "([[ ! -z \\"\
+0001d7f0: 2454 4553 545f 454e 565c 5c22 205d 5d20  $TEST_ENV\\" ]] 
+0001d800: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001d810: 534b 5950 494c 4f54 5f4e 4f44 455f 4950  SKYPILOT_NODE_IP
+0001d820: 535c 5c22 205d 5d20 2626 205b 5b20 2120  S\\" ]] && [[ ! 
+0001d830: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001d840: 5f4e 4f44 455f 5241 4e4b 5c5c 2220 5d5d  _NODE_RANK\\" ]]
+0001d850: 2920 7c7c 2065 7869 7420 3122 272c 0a20  ) || exit 1"',. 
+0001d860: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001d870: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+0001d880: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0001d890: 455f 5741 4954 7d20 7c20 6772 6570 207b  E_WAIT} | grep {
+0001d8a0: 6e61 6d65 7d20 7c20 6772 6570 2053 5543  name} | grep SUC
+0001d8b0: 4345 4544 4544 272c 0a20 2020 2020 2020  CEEDED',.       
+0001d8c0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+0001d8d0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+0001d8e0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+0001d8f0: 6d65 292c 0a20 2020 2020 2020 2023 2049  me),.        # I
+0001d900: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
+0001d910: 7369 6e63 6520 736b 7920 7370 6f74 2071  since sky spot q
+0001d920: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
+0001d930: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
+0001d940: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
+0001d950: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0001d960: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001d970: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001d980: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0001d990: 2054 6573 7469 6e67 2065 6e76 202d 2d2d   Testing env ---
+0001d9a0: 2d2d 2d2d 2d2d 2d0a 6465 6620 7465 7374  -------.def test
+0001d9b0: 5f69 6e6c 696e 655f 656e 7628 6765 6e65  _inline_env(gene
+0001d9c0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0001d9d0: 0a20 2020 2022 2222 5465 7374 2065 6e76  .    """Test env
+0001d9e0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+0001d9f0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0001da00: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0001da10: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+0001da20: 742d 696e 6c69 6e65 2d65 6e76 272c 0a20  t-inline-env',. 
+0001da30: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0001da40: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0001da50: 6820 2d63 207b 6e61 6d65 7d20 2d79 202d  h -c {name} -y -
+0001da60: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0001da70: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
+0001da80: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
+0001da90: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
+0001daa0: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
+0001dab0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
+0001dac0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
+0001dad0: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
+0001dae0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
+0001daf0: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
+0001db00: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
+0001db10: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001db20: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+0001db30: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0001db40: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0001db50: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+0001db60: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0001db70: 616d 657d 202d 2d65 6e76 2054 4553 545f  ame} --env TEST_
+0001db80: 454e 5632 3d22 7375 6363 6573 7322 2022  ENV2="success" "
+0001db90: 285b 5b20 2120 2d7a 205c 5c22 5c24 5445  ([[ ! -z \\"\$TE
+0001dba0: 5354 5f45 4e56 325c 5c22 205d 5d20 2626  ST_ENV2\\" ]] &&
+0001dbb0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
+0001dbc0: 5950 494c 4f54 5f4e 4f44 455f 4950 535c  YPILOT_NODE_IPS\
+0001dbd0: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
+0001dbe0: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
+0001dbf0: 4f44 455f 5241 4e4b 5c5c 2220 5d5d 2920  ODE_RANK\\" ]]) 
+0001dc00: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0001dc10: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001dc20: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+0001dc30: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+0001dc40: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0001dc50: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0001dc60: 2c0a 2020 2020 2020 2020 5f67 6574 5f74  ,.        _get_t
+0001dc70: 696d 656f 7574 2867 656e 6572 6963 5f63  imeout(generic_c
+0001dc80: 6c6f 7564 292c 0a20 2020 2029 0a20 2020  loud),.    ).   
+0001dc90: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001dca0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+0001dcb0: 2d2d 2054 6573 7469 6e67 2065 6e76 2066  -- Testing env f
+0001dcc0: 696c 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a64  ile ----------.d
+0001dcd0: 6566 2074 6573 745f 696e 6c69 6e65 5f65  ef test_inline_e
+0001dce0: 6e76 5f66 696c 6528 6765 6e65 7269 635f  nv_file(generic_
+0001dcf0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0001dd00: 2022 2222 5465 7374 2065 6e76 2222 220a   """Test env""".
+0001dd10: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001dd20: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001dd30: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001dd40: 2020 2020 2020 2020 2774 6573 742d 696e          'test-in
+0001dd50: 6c69 6e65 2d65 6e76 2d66 696c 6527 2c0a  line-env-file',.
+0001dd60: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001dd70: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0001dd80: 6368 202d 6320 7b6e 616d 657d 202d 7920  ch -c {name} -y 
+0001dd90: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+0001dda0: 5f63 6c6f 7564 7d20 2d2d 656e 7620 5445  _cloud} --env TE
+0001ddb0: 5354 5f45 4e56 3d22 6865 6c6c 6f20 776f  ST_ENV="hello wo
+0001ddc0: 726c 6422 202d 2d20 2228 5b5b 2021 202d  rld" -- "([[ ! -
+0001ddd0: 7a20 5c5c 225c 2454 4553 545f 454e 565c  z \\"\$TEST_ENV\
+0001dde0: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
+0001ddf0: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
+0001de00: 4f44 455f 4950 535c 5c22 205d 5d20 2626  ODE_IPS\\" ]] &&
+0001de10: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
+0001de20: 5950 494c 4f54 5f4e 4f44 455f 5241 4e4b  YPILOT_NODE_RANK
+0001de30: 5c5c 2220 5d5d 2920 7c7c 2065 7869 7420  \\" ]]) || exit 
+0001de40: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
+0001de50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0001de60: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+0001de70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001de80: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0001de90: 656e 762d 6669 6c65 2065 7861 6d70 6c65  env-file example
+0001dea0: 732f 7361 6d70 6c65 5f64 6f74 656e 7620  s/sample_dotenv 
+0001deb0: 2228 5b5b 2021 202d 7a20 5c5c 225c 2454  "([[ ! -z \\"\$T
+0001dec0: 4553 545f 454e 5632 5c5c 2220 5d5d 2026  EST_ENV2\\" ]] &
+0001ded0: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
+0001dee0: 4b59 5049 4c4f 545f 4e4f 4445 5f49 5053  KYPILOT_NODE_IPS
+0001def0: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
+0001df00: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
+0001df10: 4e4f 4445 5f52 414e 4b5c 5c22 205d 5d29  NODE_RANK\\" ]])
+0001df20: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
+0001df30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001df40: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
+0001df50: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+0001df60: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0001df70: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0001df80: 272c 0a20 2020 2020 2020 205f 6765 745f  ',.        _get_
+0001df90: 7469 6d65 6f75 7428 6765 6e65 7269 635f  timeout(generic_
+0001dfa0: 636c 6f75 6429 2c0a 2020 2020 290a 2020  cloud),.    ).  
+0001dfb0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001dfc0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+0001dfd0: 2d2d 2d20 5465 7374 696e 6720 6375 7374  --- Testing cust
+0001dfe0: 6f6d 2069 6d61 6765 202d 2d2d 2d2d 2d2d  om image -------
+0001dff0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0001e000: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
+0001e010: 735f 6375 7374 6f6d 5f69 6d61 6765 2829  s_custom_image()
+0001e020: 3a0a 2020 2020 2222 2254 6573 7420 4157  :.    """Test AW
+0001e030: 5320 6375 7374 6f6d 2069 6d61 6765 2222  S custom image""
+0001e040: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+0001e050: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0001e060: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001e070: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
+0001e080: 6177 732d 6375 7374 6f6d 2d69 6d61 6765  aws-custom-image
+0001e090: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0001e0a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001e0b0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0001e0c0: 2d2d 7265 7472 792d 756e 7469 6c2d 7570  --retry-until-up
+0001e0d0: 202d 7920 7465 7374 732f 7465 7374 5f79   -y tests/test_y
+0001e0e0: 616d 6c73 2f74 6573 745f 6375 7374 6f6d  amls/test_custom
+0001e0f0: 5f69 6d61 6765 2e79 616d 6c20 2d2d 636c  _image.yaml --cl
+0001e100: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
+0001e110: 2075 732d 6561 7374 2d32 202d 2d69 6d61   us-east-2 --ima
+0001e120: 6765 2d69 6420 616d 692d 3036 3264 6464  ge-id ami-062ddd
+0001e130: 3930 6662 3666 3832 3637 6127 2c20 2023  90fb6f8267a',  #
+0001e140: 204e 7669 6469 6120 696d 6167 650a 2020   Nvidia image.  
+0001e150: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001e160: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0001e170: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+0001e180: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0001e190: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0001e1a0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0001e1b0: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
+0001e1c0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0001e1d0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+0001e1e0: 7374 2e6d 6172 6b2e 6b75 6265 726e 6574  st.mark.kubernet
+0001e1f0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+0001e200: 7061 7261 6d65 7472 697a 6528 0a20 2020  parametrize(.   
+0001e210: 2022 696d 6167 655f 6964 222c 0a20 2020   "image_id",.   
+0001e220: 205b 0a20 2020 2020 2020 2022 646f 636b   [.        "dock
+0001e230: 6572 3a6e 7669 6469 612f 6375 6461 3a31  er:nvidia/cuda:1
+0001e240: 312e 382e 302d 6465 7665 6c2d 7562 756e  1.8.0-devel-ubun
+0001e250: 7475 3138 2e30 3422 2c0a 2020 2020 2020  tu18.04",.      
+0001e260: 2020 2264 6f63 6b65 723a 7562 756e 7475    "docker:ubuntu
+0001e270: 3a31 382e 3034 222c 0a20 2020 2020 2020  :18.04",.       
+0001e280: 2023 2054 6573 7420 696d 6167 6520 7769   # Test image wi
+0001e290: 7468 2070 7974 686f 6e20 332e 3131 2069  th python 3.11 i
+0001e2a0: 6e73 7461 6c6c 6564 2062 7920 6465 6661  nstalled by defa
+0001e2b0: 756c 742e 0a20 2020 2020 2020 2022 646f  ult..        "do
+0001e2c0: 636b 6572 3a63 6f6e 7469 6e75 756d 696f  cker:continuumio
+0001e2d0: 2f6d 696e 6963 6f6e 6461 3322 2c0a 2020  /miniconda3",.  
+0001e2e0: 2020 5d29 0a64 6566 2074 6573 745f 6b75    ]).def test_ku
+0001e2f0: 6265 726e 6574 6573 5f63 7573 746f 6d5f  bernetes_custom_
+0001e300: 696d 6167 6528 696d 6167 655f 6964 293a  image(image_id):
+0001e310: 0a20 2020 2022 2222 5465 7374 204b 7562  .    """Test Kub
+0001e320: 6572 6e65 7465 7320 6375 7374 6f6d 2069  ernetes custom i
+0001e330: 6d61 6765 2222 220a 2020 2020 6e61 6d65  mage""".    name
+0001e340: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001e350: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0001e360: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001e370: 2774 6573 742d 6b75 6265 726e 6574 6573  'test-kubernetes
+0001e380: 2d63 7573 746f 6d2d 696d 6167 6527 2c0a  -custom-image',.
+0001e390: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001e3a0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+0001e3b0: 6368 202d 6320 7b6e 616d 657d 202d 2d72  ch -c {name} --r
+0001e3c0: 6574 7279 2d75 6e74 696c 2d75 7020 2d79  etry-until-up -y
+0001e3d0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+0001e3e0: 732f 7465 7374 5f63 7573 746f 6d5f 696d  s/test_custom_im
+0001e3f0: 6167 652e 7961 6d6c 202d 2d63 6c6f 7564  age.yaml --cloud
+0001e400: 206b 7562 6572 6e65 7465 7320 2d2d 696d   kubernetes --im
+0001e410: 6167 652d 6964 207b 696d 6167 655f 6964  age-id {image_id
+0001e420: 7d20 2d2d 7265 6769 6f6e 204e 6f6e 6520  } --region None 
+0001e430: 2d2d 6770 7573 2054 343a 3127 2c0a 2020  --gpus T4:1',.  
+0001e440: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0001e450: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0001e460: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+0001e470: 2020 2020 2023 2054 7279 2065 7865 6320       # Try exec 
+0001e480: 746f 2072 756e 2061 6761 696e 2061 6e64  to run again and
+0001e490: 2063 6865 636b 2069 6620 7468 6520 6c6f   check if the lo
+0001e4a0: 6773 2061 7265 2070 7269 6e74 6564 0a20  gs are printed. 
+0001e4b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001e4c0: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
+0001e4d0: 7473 2f74 6573 745f 7961 6d6c 732f 7465  ts/test_yamls/te
+0001e4e0: 7374 5f63 7573 746f 6d5f 696d 6167 652e  st_custom_image.
+0001e4f0: 7961 6d6c 202d 2d63 6c6f 7564 206b 7562  yaml --cloud kub
+0001e500: 6572 6e65 7465 7320 2d2d 696d 6167 652d  ernetes --image-
+0001e510: 6964 207b 696d 6167 655f 6964 7d20 2d2d  id {image_id} --
+0001e520: 7265 6769 6f6e 204e 6f6e 6520 2d2d 6770  region None --gp
+0001e530: 7573 2054 343a 3120 7c20 6772 6570 2022  us T4:1 | grep "
+0001e540: 4865 6c6c 6f20 3130 3022 272c 0a20 2020  Hello 100"',.   
+0001e550: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+0001e560: 7375 7265 2073 7368 2069 7320 776f 726b  sure ssh is work
+0001e570: 696e 6720 7769 7468 2063 7573 746f 6d20  ing with custom 
+0001e580: 7573 6572 6e61 6d65 0a20 2020 2020 2020  username.       
+0001e590: 2020 2020 2066 2773 7368 207b 6e61 6d65       f'ssh {name
+0001e5a0: 7d20 6563 686f 2068 6920 7c20 6772 6570  } echo hi | grep
+0001e5b0: 2068 6927 2c0a 2020 2020 2020 2020 5d2c   hi',.        ],
+0001e5c0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0001e5d0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0001e5e0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001e5f0: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
+0001e600: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0001e610: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0001e620: 6d61 726b 2e73 6c6f 770a 6465 6620 7465  mark.slow.def te
+0001e630: 7374 5f61 7a75 7265 5f73 7461 7274 5f73  st_azure_start_s
+0001e640: 746f 705f 7477 6f5f 6e6f 6465 7328 293a  top_two_nodes():
+0001e650: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0001e660: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0001e670: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0001e680: 0a20 2020 2020 2020 2027 617a 7572 652d  .        'azure-
+0001e690: 7374 6172 742d 7374 6f70 2d74 776f 2d6e  start-stop-two-n
+0001e6a0: 6f64 6573 272c 0a20 2020 2020 2020 205b  odes',.        [
+0001e6b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001e6c0: 6b79 206c 6175 6e63 6820 2d2d 6e75 6d2d  ky launch --num-
+0001e6d0: 6e6f 6465 733d 3220 2d79 202d 6320 7b6e  nodes=2 -y -c {n
+0001e6e0: 616d 657d 2065 7861 6d70 6c65 732f 617a  ame} examples/az
+0001e6f0: 7572 655f 7374 6172 745f 7374 6f70 2e79  ure_start_stop.y
+0001e700: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0001e710: 2020 6627 736b 7920 6578 6563 202d 2d6e    f'sky exec --n
+0001e720: 756d 2d6e 6f64 6573 3d32 207b 6e61 6d65  um-nodes=2 {name
+0001e730: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
+0001e740: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+0001e750: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001e760: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0001e770: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+0001e780: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+0001e790: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0001e7a0: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
+0001e7b0: 7020 2d79 207b 6e61 6d65 7d27 2c0a 2020  p -y {name}',.  
 0001e7c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001e7d0: 6578 6563 202d 2d6e 756d 2d6e 6f64 6573  exec --num-nodes
-0001e7e0: 3d32 207b 6e61 6d65 7d20 6578 616d 706c  =2 {name} exampl
-0001e7f0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
-0001e800: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
-0001e810: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0001e820: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-0001e830: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-0001e840: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-0001e850: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-0001e860: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001e870: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001e880: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
-0001e890: 2a20 3630 2c20 2023 2033 3020 6d69 6e73  * 60,  # 30 mins
-0001e8a0: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
-0001e8b0: 6e64 207e 3233 206d 696e 7329 0a20 2020  nd ~23 mins).   
-0001e8c0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0001e8d0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0001e8e0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-0001e8f0: 2065 6e76 2066 6f72 2064 6973 6b20 7469   env for disk ti
-0001e900: 6572 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  er ----------.@p
-0001e910: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
-0001e920: 6566 2074 6573 745f 6177 735f 6469 736b  ef test_aws_disk
-0001e930: 5f74 6965 7228 293a 0a0a 2020 2020 6465  _tier():..    de
-0001e940: 6620 5f67 6574 5f61 7773 5f71 7565 7279  f _get_aws_query
-0001e950: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
-0001e960: 2069 6e73 7461 6e63 655f 6964 2c20 6669   instance_id, fi
-0001e970: 656c 642c 2065 7870 6563 7465 6429 3a0a  eld, expected):.
-0001e980: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-0001e990: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
-0001e9a0: 6265 2d76 6f6c 756d 6573 202d 2d72 6567  be-volumes --reg
-0001e9b0: 696f 6e20 7b72 6567 696f 6e7d 2027 0a20  ion {region} '. 
-0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001e9d0: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
-0001e9e0: 6174 7461 6368 6d65 6e74 2e69 6e73 7461  attachment.insta
-0001e9f0: 6e63 652d 6964 2c56 616c 7565 733d 7b69  nce-id,Values={i
-0001ea00: 6e73 7461 6e63 655f 6964 7d20 270a 2020  nstance_id} '.  
-0001ea10: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001ea20: 2d2d 7175 6572 7920 566f 6c75 6d65 735b  --query Volumes[
-0001ea30: 2a5d 2e7b 6669 656c 647d 207c 2067 7265  *].{field} | gre
-0001ea40: 7020 7b65 7870 6563 7465 647d 203b 2027  p {expected} ; '
-0001ea50: 290a 0a20 2020 2066 6f72 2064 6973 6b5f  )..    for disk_
-0001ea60: 7469 6572 2069 6e20 6c69 7374 2872 6573  tier in list(res
-0001ea70: 6f75 7263 6573 5f75 7469 6c73 2e44 6973  ources_utils.Dis
-0001ea80: 6b54 6965 7229 3a0a 2020 2020 2020 2020  kTier):.        
-0001ea90: 7370 6563 7320 3d20 4157 532e 5f67 6574  specs = AWS._get
-0001eaa0: 5f64 6973 6b5f 7370 6563 7328 6469 736b  _disk_specs(disk
-0001eab0: 5f74 6965 7229 0a20 2020 2020 2020 206e  _tier).        n
-0001eac0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0001ead0: 6572 5f6e 616d 6528 2920 2b20 272d 2720  er_name() + '-' 
-0001eae0: 2b20 6469 736b 5f74 6965 722e 7661 6c75  + disk_tier.valu
-0001eaf0: 650a 2020 2020 2020 2020 6e61 6d65 5f6f  e.        name_o
-0001eb00: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
-0001eb10: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-0001eb20: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-0001eb30: 6428 0a20 2020 2020 2020 2020 2020 206e  d(.            n
-0001eb40: 616d 652c 2073 6b79 2e41 5753 2e6d 6178  ame, sky.AWS.max
-0001eb50: 5f63 6c75 7374 6572 5f6e 616d 655f 6c65  _cluster_name_le
-0001eb60: 6e67 7468 2829 290a 2020 2020 2020 2020  ngth()).        
-0001eb70: 7265 6769 6f6e 203d 2027 7573 2d65 6173  region = 'us-eas
-0001eb80: 742d 3227 0a20 2020 2020 2020 2074 6573  t-2'.        tes
-0001eb90: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001eba0: 2020 2020 2020 2761 7773 2d64 6973 6b2d        'aws-disk-
-0001ebb0: 7469 6572 2d27 202b 2064 6973 6b5f 7469  tier-' + disk_ti
-0001ebc0: 6572 2e76 616c 7565 2c0a 2020 2020 2020  er.value,.      
-0001ebd0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001ebe0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0001ebf0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0001ec00: 7d20 2d2d 636c 6f75 6420 6177 7320 2d2d  } --cloud aws --
-0001ec10: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001ec20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ec30: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
-0001ec40: 7b64 6973 6b5f 7469 6572 2e76 616c 7565  {disk_tier.value
-0001ec50: 7d20 6563 686f 2022 6865 6c6c 6f20 736b  } echo "hello sk
-0001ec60: 7922 272c 0a20 2020 2020 2020 2020 2020  y"',.           
-0001ec70: 2020 2020 2066 2769 643d 6061 7773 2065       f'id=`aws e
-0001ec80: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-0001ec90: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-0001eca0: 7265 6769 6f6e 7d20 2d2d 6669 6c74 6572  region} --filter
-0001ecb0: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-0001ecc0: 2020 2020 6627 4e61 6d65 3d74 6167 3a72      f'Name=tag:r
-0001ecd0: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001ece0: 5661 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f  Values={name_on_
-0001ecf0: 636c 6f75 647d 202d 2d71 7565 7279 2027  cloud} --query '
-0001ed00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ed10: 2066 2752 6573 6572 7661 7469 6f6e 735b   f'Reservations[
-0001ed20: 5d2e 496e 7374 616e 6365 735b 5d2e 496e  ].Instances[].In
-0001ed30: 7374 616e 6365 4964 202d 2d6f 7574 7075  stanceId --outpu
-0001ed40: 7420 7465 7874 603b 2027 202b 0a20 2020  t text`; ' +.   
-0001ed50: 2020 2020 2020 2020 2020 2020 205f 6765               _ge
-0001ed60: 745f 6177 735f 7175 6572 795f 636f 6d6d  t_aws_query_comm
-0001ed70: 616e 6428 7265 6769 6f6e 2c20 2724 6964  and(region, '$id
-0001ed80: 272c 2027 566f 6c75 6d65 5479 7065 272c  ', 'VolumeType',
-0001ed90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edb0: 2020 2020 2020 2020 7370 6563 735b 2764          specs['d
-0001edc0: 6973 6b5f 7469 6572 275d 2920 2b0a 2020  isk_tier']) +.  
-0001edd0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-0001ede0: 2720 6966 2064 6973 6b5f 7469 6572 203d  ' if disk_tier =
-0001edf0: 3d20 7265 736f 7572 6365 735f 7574 696c  = resources_util
-0001ee00: 732e 4469 736b 5469 6572 2e4c 4f57 2065  s.DiskTier.LOW e
-0001ee10: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-0001ee20: 2020 2020 2028 5f67 6574 5f61 7773 5f71       (_get_aws_q
-0001ee30: 7565 7279 5f63 6f6d 6d61 6e64 2872 6567  uery_command(reg
-0001ee40: 696f 6e2c 2027 2469 6427 2c20 2749 6f70  ion, '$id', 'Iop
-0001ee50: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0001ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee70: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-0001ee80: 6373 5b27 6469 736b 5f69 6f70 7327 5d29  cs['disk_iops'])
-0001ee90: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
-0001eea0: 2020 2020 205f 6765 745f 6177 735f 7175       _get_aws_qu
-0001eeb0: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
-0001eec0: 6f6e 2c20 2724 6964 272c 2027 5468 726f  on, '$id', 'Thro
-0001eed0: 7567 6870 7574 272c 0a20 2020 2020 2020  ughput',.       
-0001eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef00: 2020 7370 6563 735b 2764 6973 6b5f 7468    specs['disk_th
-0001ef10: 726f 7567 6870 7574 275d 2929 292c 0a20  roughput']))),. 
-0001ef20: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-0001ef30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001ef40: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0001ef50: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-0001ef60: 656f 7574 3d31 3020 2a20 3630 2c20 2023  eout=10 * 60,  #
-0001ef70: 2031 3020 6d69 6e73 2020 2869 7420 7461   10 mins  (it ta
-0001ef80: 6b65 7320 6172 6f75 6e64 207e 3620 6d69  kes around ~6 mi
-0001ef90: 6e73 290a 2020 2020 2020 2020 290a 2020  ns).        ).  
-0001efa0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-0001efb0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001efc0: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
-0001efd0: 7465 7374 5f67 6370 5f64 6973 6b5f 7469  test_gcp_disk_ti
-0001efe0: 6572 2829 3a0a 2020 2020 666f 7220 6469  er():.    for di
-0001eff0: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
-0001f000: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
-0001f010: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
-0001f020: 2020 2074 7970 6520 3d20 4743 502e 5f67     type = GCP._g
-0001f030: 6574 5f64 6973 6b5f 7479 7065 2864 6973  et_disk_type(dis
-0001f040: 6b5f 7469 6572 290a 2020 2020 2020 2020  k_tier).        
-0001f050: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001f060: 7465 725f 6e61 6d65 2829 202b 2027 2d27  ter_name() + '-'
-0001f070: 202b 2064 6973 6b5f 7469 6572 2e76 616c   + disk_tier.val
-0001f080: 7565 0a20 2020 2020 2020 206e 616d 655f  ue.        name_
-0001f090: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-0001f0a0: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-0001f0b0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-0001f0c0: 7564 280a 2020 2020 2020 2020 2020 2020  ud(.            
-0001f0d0: 6e61 6d65 2c20 736b 792e 4743 502e 6d61  name, sky.GCP.ma
-0001f0e0: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
-0001f0f0: 656e 6774 6828 2929 0a20 2020 2020 2020  ength()).       
-0001f100: 2072 6567 696f 6e20 3d20 2775 732d 7765   region = 'us-we
-0001f110: 7374 3227 0a20 2020 2020 2020 2074 6573  st2'.        tes
-0001f120: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0001f130: 2020 2020 2020 2767 6370 2d64 6973 6b2d        'gcp-disk-
-0001f140: 7469 6572 2d27 202b 2064 6973 6b5f 7469  tier-' + disk_ti
-0001f150: 6572 2e76 616c 7565 2c0a 2020 2020 2020  er.value,.      
-0001f160: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001f170: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0001f180: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0001f190: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
-0001f1a0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001f1b0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001f1c0: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
-0001f1d0: 7b64 6973 6b5f 7469 6572 2e76 616c 7565  {disk_tier.value
-0001f1e0: 7d20 6563 686f 2022 6865 6c6c 6f20 736b  } echo "hello sk
-0001f1f0: 7922 272c 0a20 2020 2020 2020 2020 2020  y"',.           
-0001f200: 2020 2020 2066 276e 616d 653d 6067 636c       f'name=`gcl
-0001f210: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-0001f220: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
-0001f230: 7465 723d 270a 2020 2020 2020 2020 2020  ter='.          
-0001f240: 2020 2020 2020 6627 226c 6162 656c 732e        f'"labels.
-0001f250: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-0001f260: 3a7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  :{name_on_cloud}
-0001f270: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-0001f280: 2020 2020 272d 2d66 6f72 6d61 743d 2276      '--format="v
-0001f290: 616c 7565 286e 616d 6529 2260 3b20 270a  alue(name)"`; '.
-0001f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2b0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
-0001f2c0: 2064 6973 6b73 206c 6973 7420 2d2d 6669   disks list --fi
-0001f2d0: 6c74 6572 3d22 6e61 6d65 3d24 6e61 6d65  lter="name=$name
-0001f2e0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-0001f2f0: 2020 2020 6627 2d2d 666f 726d 6174 3d22      f'--format="
-0001f300: 7661 6c75 6528 7479 7065 2922 207c 2067  value(type)" | g
-0001f310: 7265 7020 7b74 7970 657d 2027 0a20 2020  rep {type} '.   
-0001f320: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0001f330: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0001f340: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0001f350: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
-0001f360: 7574 3d36 202a 2036 302c 2020 2320 3620  ut=6 * 60,  # 6 
-0001f370: 6d69 6e73 2020 2869 7420 7461 6b65 7320  mins  (it takes 
-0001f380: 6172 6f75 6e64 207e 3320 6d69 6e73 290a  around ~3 mins).
-0001f390: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001f3a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0001f3b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-0001f3c0: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
-0001f3d0: 7374 5f61 7a75 7265 5f64 6973 6b5f 7469  st_azure_disk_ti
-0001f3e0: 6572 2829 3a0a 2020 2020 666f 7220 6469  er():.    for di
-0001f3f0: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
-0001f400: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
-0001f410: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
-0001f420: 2020 2069 6620 6469 736b 5f74 6965 7220     if disk_tier 
-0001f430: 3d3d 2072 6573 6f75 7263 6573 5f75 7469  == resources_uti
-0001f440: 6c73 2e44 6973 6b54 6965 722e 4849 4748  ls.DiskTier.HIGH
-0001f450: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001f460: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
-0001f470: 7570 706f 7274 2068 6967 6820 6469 736b  upport high disk
-0001f480: 2074 6965 722e 0a20 2020 2020 2020 2020   tier..         
-0001f490: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-0001f4a0: 2020 2020 7479 7065 203d 2041 7a75 7265      type = Azure
-0001f4b0: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
-0001f4c0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
-0001f4d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001f4e0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
-0001f4f0: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
-0001f500: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
-0001f510: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-0001f520: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-0001f530: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-0001f540: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
-0001f550: 2020 206e 616d 652c 2073 6b79 2e41 7a75     name, sky.Azu
-0001f560: 7265 2e6d 6178 5f63 6c75 7374 6572 5f6e  re.max_cluster_n
-0001f570: 616d 655f 6c65 6e67 7468 2829 290a 2020  ame_length()).  
-0001f580: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
-0001f590: 7765 7374 7573 3227 0a20 2020 2020 2020  westus2'.       
-0001f5a0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001f5b0: 2020 2020 2020 2020 2020 2761 7a75 7265            'azure
-0001f5c0: 2d64 6973 6b2d 7469 6572 2d27 202b 2064  -disk-tier-' + d
-0001f5d0: 6973 6b5f 7469 6572 2e76 616c 7565 2c0a  isk_tier.value,.
-0001f5e0: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
-0001f5f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001f600: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-0001f610: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-0001f620: 617a 7572 6520 2d2d 7265 6769 6f6e 207b  azure --region {
-0001f630: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-0001f640: 2020 2020 2020 2020 2020 6627 2d2d 6469            f'--di
-0001f650: 736b 2d74 6965 7220 7b64 6973 6b5f 7469  sk-tier {disk_ti
-0001f660: 6572 2e76 616c 7565 7d20 6563 686f 2022  er.value} echo "
-0001f670: 6865 6c6c 6f20 736b 7922 272c 0a20 2020  hello sky"',.   
-0001f680: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
-0001f690: 7a20 7265 736f 7572 6365 206c 6973 7420  z resource list 
-0001f6a0: 2d2d 7461 6720 7261 792d 636c 7573 7465  --tag ray-cluste
-0001f6b0: 722d 6e61 6d65 3d7b 6e61 6d65 5f6f 6e5f  r-name={name_on_
-0001f6c0: 636c 6f75 647d 202d 2d71 7565 7279 2027  cloud} --query '
-0001f6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f6e0: 2066 2722 5b3f 7479 7065 3d3d 5c27 4d69   f'"[?type==\'Mi
-0001f6f0: 6372 6f73 6f66 742e 436f 6d70 7574 652f  crosoft.Compute/
-0001f700: 6469 736b 735c 275d 2e73 6b75 2e6e 616d  disks\'].sku.nam
-0001f710: 6522 2027 0a20 2020 2020 2020 2020 2020  e" '.           
-0001f720: 2020 2020 2066 272d 2d6f 7574 7075 7420       f'--output 
-0001f730: 7473 7620 7c20 6772 6570 207b 7479 7065  tsv | grep {type
-0001f740: 7d27 0a20 2020 2020 2020 2020 2020 205d  }'.            ]
-0001f750: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001f760: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0001f770: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0001f780: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-0001f790: 2c20 2023 2032 3020 6d69 6e73 2020 2869  ,  # 20 mins  (i
-0001f7a0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-0001f7b0: 3132 206d 696e 7329 0a20 2020 2020 2020  12 mins).       
-0001f7c0: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
-0001f7d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001f7e0: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
-0001f7f0: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
-0001f800: 655f 6265 7374 5f74 6965 725f 6661 696c  e_best_tier_fail
-0001f810: 6f76 6572 2829 3a0a 2020 2020 7479 7065  over():.    type
-0001f820: 203d 2041 7a75 7265 2e5f 6765 745f 6469   = Azure._get_di
-0001f830: 736b 5f74 7970 6528 7265 736f 7572 6365  sk_type(resource
-0001f840: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
-0001f850: 2e4c 4f57 290a 2020 2020 6e61 6d65 203d  .LOW).    name =
-0001f860: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001f870: 6d65 2829 0a20 2020 206e 616d 655f 6f6e  me().    name_on
-0001f880: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
-0001f890: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
-0001f8a0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
-0001f8b0: 280a 2020 2020 2020 2020 6e61 6d65 2c20  (.        name, 
-0001f8c0: 736b 792e 417a 7572 652e 6d61 785f 636c  sky.Azure.max_cl
-0001f8d0: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
-0001f8e0: 6828 2929 0a20 2020 2072 6567 696f 6e20  h()).    region 
-0001f8f0: 3d20 2777 6573 7475 7332 270a 2020 2020  = 'westus2'.    
-0001f900: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001f910: 2020 2020 2027 617a 7572 652d 6265 7374       'azure-best
-0001f920: 2d74 6965 722d 6661 696c 6f76 6572 272c  -tier-failover',
-0001f930: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0001f940: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0001f950: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0001f960: 202d 2d63 6c6f 7564 2061 7a75 7265 202d   --cloud azure -
-0001f970: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-0001f980: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-0001f990: 272d 2d64 6973 6b2d 7469 6572 2062 6573  '--disk-tier bes
-0001f9a0: 7420 2d2d 696e 7374 616e 6365 2d74 7970  t --instance-typ
-0001f9b0: 6520 5374 616e 6461 7264 5f44 385f 7635  e Standard_D8_v5
-0001f9c0: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
-0001f9d0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001f9e0: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
-0001f9f0: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
-0001fa00: 7374 6572 2d6e 616d 653d 7b6e 616d 655f  ster-name={name_
-0001fa10: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
-0001fa20: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
-0001fa30: 6627 225b 3f74 7970 653d 3d5c 274d 6963  f'"[?type==\'Mic
-0001fa40: 726f 736f 6674 2e43 6f6d 7075 7465 2f64  rosoft.Compute/d
-0001fa50: 6973 6b73 5c27 5d2e 736b 752e 6e61 6d65  isks\'].sku.name
-0001fa60: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-0001fa70: 6627 2d2d 6f75 7470 7574 2074 7376 207c  f'--output tsv |
-0001fa80: 2067 7265 7020 7b74 7970 657d 272c 0a20   grep {type}',. 
-0001fa90: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0001faa0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0001fab0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0001fac0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-0001fad0: 2c20 2023 2032 3020 6d69 6e73 2020 2869  ,  # 20 mins  (i
-0001fae0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-0001faf0: 3132 206d 696e 7329 0a20 2020 2029 0a20  12 mins).    ). 
-0001fb00: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001fb10: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001fb20: 2054 6573 7469 6e67 205a 6572 6f20 5175   Testing Zero Qu
-0001fb30: 6f74 6120 4661 696c 6f76 6572 202d 2d2d  ota Failover ---
-0001fb40: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-0001fb50: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
-0001fb60: 735f 7a65 726f 5f71 756f 7461 5f66 6169  s_zero_quota_fai
-0001fb70: 6c6f 7665 7228 293a 0a0a 2020 2020 6e61  lover():..    na
-0001fb80: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001fb90: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
-0001fba0: 696f 6e20 3d20 6765 745f 6177 735f 7265  ion = get_aws_re
-0001fbb0: 6769 6f6e 5f66 6f72 5f71 756f 7461 5f66  gion_for_quota_f
-0001fbc0: 6169 6c6f 7665 7228 290a 0a20 2020 2069  ailover()..    i
-0001fbd0: 6620 6e6f 7420 7265 6769 6f6e 3a0a 2020  f not region:.  
-0001fbe0: 2020 2020 2020 7079 7465 7374 2e78 6661        pytest.xfa
-0001fbf0: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
-0001fc00: 2755 6e61 626c 6520 746f 2074 6573 7420  'Unable to test 
-0001fc10: 7a65 726f 2071 756f 7461 2066 6169 6c6f  zero quota failo
-0001fc20: 7665 7220 6f70 7469 6d69 7a61 7469 6f6e  ver optimization
-0001fc30: 20e2 8094 2071 756f 7461 7320 270a 2020   ... quotas '.  
-0001fc40: 2020 2020 2020 2020 2020 2766 6f72 2045            'for E
-0001fc50: 4332 2050 3320 696e 7374 616e 6365 7320  C2 P3 instances 
-0001fc60: 7765 7265 2066 6f75 6e64 206f 6e20 616c  were found on al
-0001fc70: 6c20 4157 5320 7265 6769 6f6e 732e 2049  l AWS regions. I
-0001fc80: 7320 7468 6973 2027 0a20 2020 2020 2020  s this '.       
-0001fc90: 2020 2020 2027 6578 7065 6374 6564 2066       'expected f
-0001fca0: 6f72 2079 6f75 7220 6163 636f 756e 743f  or your account?
-0001fcb0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
-0001fcc0: 6e0a 0a20 2020 2074 6573 7420 3d20 5465  n..    test = Te
-0001fcd0: 7374 280a 2020 2020 2020 2020 2761 7773  st(.        'aws
-0001fce0: 2d7a 6572 6f2d 7175 6f74 612d 6661 696c  -zero-quota-fail
-0001fcf0: 6f76 6572 272c 0a20 2020 2020 2020 205b  over',.        [
-0001fd00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0001fd10: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0001fd20: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
-0001fd30: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
-0001fd40: 696f 6e7d 202d 2d67 7075 7320 5631 3030  ion} --gpus V100
-0001fd50: 3a38 202d 2d75 7365 2d73 706f 7420 7c20  :8 --use-spot | 
-0001fd60: 6772 6570 2022 466f 756e 6420 6e6f 2071  grep "Found no q
-0001fd70: 756f 7461 2227 2c0a 2020 2020 2020 2020  uota"',.        
-0001fd80: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0001fd90: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0001fda0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0001fdb0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0001fdc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-0001fdd0: 700a 6465 6620 7465 7374 5f67 6370 5f7a  p.def test_gcp_z
-0001fde0: 6572 6f5f 7175 6f74 615f 6661 696c 6f76  ero_quota_failov
-0001fdf0: 6572 2829 3a0a 0a20 2020 206e 616d 6520  er():..    name 
-0001fe00: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001fe10: 616d 6528 290a 2020 2020 7265 6769 6f6e  ame().    region
-0001fe20: 203d 2067 6574 5f67 6370 5f72 6567 696f   = get_gcp_regio
-0001fe30: 6e5f 666f 725f 7175 6f74 615f 6661 696c  n_for_quota_fail
-0001fe40: 6f76 6572 2829 0a0a 2020 2020 6966 206e  over()..    if n
-0001fe50: 6f74 2072 6567 696f 6e3a 0a20 2020 2020  ot region:.     
-0001fe60: 2020 2070 7974 6573 742e 7866 6169 6c28     pytest.xfail(
-0001fe70: 0a20 2020 2020 2020 2020 2020 2027 556e  .            'Un
-0001fe80: 6162 6c65 2074 6f20 7465 7374 207a 6572  able to test zer
-0001fe90: 6f20 7175 6f74 6120 6661 696c 6f76 6572  o quota failover
-0001fea0: 206f 7074 696d 697a 6174 696f 6e20 e280   optimization ..
-0001feb0: 9420 7175 6f74 6173 2027 0a20 2020 2020  . quotas '.     
-0001fec0: 2020 2020 2020 2027 666f 7220 4131 3030         'for A100
-0001fed0: 2d38 3047 4220 4750 5573 2077 6572 6520  -80GB GPUs were 
-0001fee0: 666f 756e 6420 6f6e 2061 6c6c 2047 4350  found on all GCP
-0001fef0: 2072 6567 696f 6e73 2e20 4973 2074 6869   regions. Is thi
-0001ff00: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-0001ff10: 2765 7870 6563 7465 6420 666f 7220 796f  'expected for yo
-0001ff20: 7572 2061 6363 6f75 6e74 3f27 290a 2020  ur account?').  
-0001ff30: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0001ff40: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001ff50: 2020 2020 2020 2027 6763 702d 7a65 726f         'gcp-zero
-0001ff60: 2d71 756f 7461 2d66 6169 6c6f 7665 7227  -quota-failover'
-0001ff70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0001ff80: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0001ff90: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0001ffa0: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
-0001ffb0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001ffc0: 2d2d 6770 7573 2041 3130 302d 3830 4742  --gpus A100-80GB
-0001ffd0: 3a31 202d 2d75 7365 2d73 706f 7420 7c20  :1 --use-spot | 
-0001ffe0: 6772 6570 2022 466f 756e 6420 6e6f 2071  grep "Found no q
-0001fff0: 756f 7461 2227 2c0a 2020 2020 2020 2020  uota"',.        
-00020000: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00020010: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00020020: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00020030: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00020040: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00020050: 7374 696e 6720 736b 7973 6572 7665 202d  sting skyserve -
-00020060: 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a 6465 6620  ---------...def 
-00020070: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00020080: 6528 2920 2d3e 2073 7472 3a0a 2020 2020  e() -> str:.    
-00020090: 2222 2252 6574 7572 6e73 2061 2075 7365  """Returns a use
-000200a0: 722d 756e 6971 7565 2073 6572 7669 6365  r-unique service
-000200b0: 206e 616d 6520 666f 7220 6561 6368 2074   name for each t
-000200c0: 6573 745f 736b 7973 6572 7665 5f3c 6e61  est_skyserve_<na
-000200d0: 6d65 3e28 292e 0a0a 2020 2020 4d75 7374  me>()...    Must
-000200e0: 2062 6520 6361 6c6c 6564 2066 726f 6d20   be called from 
-000200f0: 6561 6368 2074 6573 745f 736b 7973 6572  each test_skyser
-00020100: 7665 5f3c 6e61 6d65 3e28 292e 0a20 2020  ve_<name>()..   
-00020110: 2022 2222 0a20 2020 2063 616c 6c65 725f   """.    caller_
-00020120: 6675 6e63 5f6e 616d 6520 3d20 696e 7370  func_name = insp
-00020130: 6563 742e 7374 6163 6b28 295b 315d 5b33  ect.stack()[1][3
-00020140: 5d0a 2020 2020 7465 7374 5f6e 616d 6520  ].    test_name 
-00020150: 3d20 6361 6c6c 6572 5f66 756e 635f 6e61  = caller_func_na
-00020160: 6d65 2e72 6570 6c61 6365 2827 5f27 2c20  me.replace('_', 
-00020170: 272d 2729 2e72 6570 6c61 6365 2827 7465  '-').replace('te
-00020180: 7374 2d27 2c20 2774 2d27 290a 2020 2020  st-', 't-').    
-00020190: 7465 7374 5f6e 616d 6520 3d20 7465 7374  test_name = test
-000201a0: 5f6e 616d 652e 7265 706c 6163 6528 2773  _name.replace('s
-000201b0: 6b79 7365 7276 652d 272c 2027 7373 2d27  kyserve-', 'ss-'
-000201c0: 290a 2020 2020 7465 7374 5f6e 616d 6520  ).    test_name 
-000201d0: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-000201e0: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-000201f0: 5f6f 6e5f 636c 6f75 6428 7465 7374 5f6e  _on_cloud(test_n
-00020200: 616d 652c 2032 3429 0a20 2020 2072 6574  ame, 24).    ret
-00020210: 7572 6e20 6627 7b74 6573 745f 6e61 6d65  urn f'{test_name
-00020220: 7d2d 7b74 6573 745f 6964 7d27 0a0a 0a23  }-{test_id}'...#
-00020230: 2057 6520 6368 6563 6b20 7468 6520 6f75   We check the ou
-00020240: 7470 7574 206f 6620 7468 6520 736b 7973  tput of the skys
-00020250: 6572 7665 2073 6572 7669 6365 2074 6f20  erve service to 
-00020260: 7365 6520 6966 2069 7420 6973 2072 6561  see if it is rea
-00020270: 6479 2e20 4f75 7470 7574 206f 660a 2320  dy. Output of.# 
-00020280: 6052 4550 4c49 4341 5360 2069 7320 696e  `REPLICAS` is in
-00020290: 2074 6865 2066 6f72 6d20 6f66 2060 312f   the form of `1/
-000202a0: 3260 2077 6865 7265 2074 6865 2066 6972  2` where the fir
-000202b0: 7374 206e 756d 6265 7220 6973 2074 6865  st number is the
-000202c0: 206e 756d 6265 7220 6f66 0a23 2072 6561   number of.# rea
-000202d0: 6479 2072 6570 6c69 6361 7320 616e 6420  dy replicas and 
-000202e0: 7468 6520 7365 636f 6e64 206e 756d 6265  the second numbe
-000202f0: 7220 6973 2074 6865 206e 756d 6265 7220  r is the number 
-00020300: 6f66 2074 6f74 616c 2072 6570 6c69 6361  of total replica
-00020310: 732e 2057 650a 2320 6772 6570 2073 7563  s. We.# grep suc
-00020320: 6820 666f 726d 6174 2074 6f20 656e 7375  h format to ensu
-00020330: 7265 2074 6861 7420 7468 6520 7365 7276  re that the serv
-00020340: 6963 6520 6973 2072 6561 6479 2c20 616e  ice is ready, an
-00020350: 6420 6561 726c 7920 6578 6974 2069 6620  d early exit if 
-00020360: 616e 790a 2320 6661 696c 7572 6520 6465  any.# failure de
-00020370: 7465 6374 6564 2e20 496e 2074 6865 2065  tected. In the e
-00020380: 6e64 2077 6520 736c 6565 7020 666f 720a  nd we sleep for.
-00020390: 2320 7365 7276 652e 4c42 5f43 4f4e 5452  # serve.LB_CONTR
-000203a0: 4f4c 4c45 525f 5359 4e43 5f49 4e54 4552  OLLER_SYNC_INTER
-000203b0: 5641 4c5f 5345 434f 4e44 5320 746f 206d  VAL_SECONDS to m
-000203c0: 616b 6520 7375 7265 206c 6f61 6420 6261  ake sure load ba
-000203d0: 6c61 6e63 6572 2068 6176 650a 2320 656e  lancer have.# en
-000203e0: 6f75 6768 2074 696d 6520 746f 2073 796e  ough time to syn
-000203f0: 6320 7769 7468 2074 6865 2063 6f6e 7472  c with the contr
-00020400: 6f6c 6c65 7220 616e 6420 6765 7420 616c  oller and get al
-00020410: 6c20 7265 6164 7920 7265 706c 6963 6120  l ready replica 
-00020420: 4950 732e 0a5f 5345 5256 455f 5741 4954  IPs.._SERVE_WAIT
-00020430: 5f55 4e54 494c 5f52 4541 4459 203d 2028  _UNTIL_READY = (
-00020440: 0a20 2020 2027 7b7b 2077 6869 6c65 2074  .    '{{ while t
-00020450: 7275 653b 2064 6f27 0a20 2020 2027 2020  rue; do'.    '  
-00020460: 2020 2073 3d24 2873 6b79 2073 6572 7665     s=$(sky serve
-00020470: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00020480: 2065 6368 6f20 2224 7322 3b27 0a20 2020   echo "$s";'.   
-00020490: 2027 2020 2020 2065 6368 6f20 2224 7322   '     echo "$s"
-000204a0: 207c 2067 7265 7020 2d71 2022 7b72 6570   | grep -q "{rep
-000204b0: 6c69 6361 5f6e 756d 7d2f 7b72 6570 6c69  lica_num}/{repli
-000204c0: 6361 5f6e 756d 7d22 2026 2620 6272 6561  ca_num}" && brea
-000204d0: 6b3b 270a 2020 2020 2720 2020 2020 6563  k;'.    '     ec
-000204e0: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
-000204f0: 7120 2246 4149 4c45 4422 2026 2620 6578  q "FAILED" && ex
-00020500: 6974 2031 3b27 0a20 2020 2027 2020 2020  it 1;'.    '    
-00020510: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
-00020520: 2720 646f 6e65 3b20 7d7d 3b20 6563 686f  ' done; }}; echo
-00020530: 2022 476f 7420 7365 7276 6963 6520 7374   "Got service st
-00020540: 6174 7573 2024 7322 3b27 0a20 2020 2066  atus $s";'.    f
-00020550: 2773 6c65 6570 207b 7365 7276 652e 4c42  'sleep {serve.LB
-00020560: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
-00020570: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
-00020580: 5320 2b20 327d 3b27 290a 5f49 505f 5245  S + 2};')._IP_RE
-00020590: 4745 5820 3d20 7227 285b 302d 395d 7b31  GEX = r'([0-9]{1
-000205a0: 2c33 7d5c 2e29 7b33 7d5b 302d 395d 7b31  ,3}\.){3}[0-9]{1
-000205b0: 2c33 7d27 0a5f 4157 4b5f 414c 4c5f 4c49  ,3}'._AWK_ALL_LI
-000205c0: 4e45 535f 4245 4c4f 575f 5245 504c 4943  NES_BELOW_REPLIC
-000205d0: 4153 203d 2072 272f 5265 706c 6963 6173  AS = r'/Replicas
-000205e0: 2f7b 666c 6167 3d31 3b20 6e65 7874 7d20  /{flag=1; next} 
-000205f0: 666c 6167 270a 5f53 4552 5649 4345 5f4c  flag'._SERVICE_L
-00020600: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
-00020610: 5245 4745 5820 3d20 2750 524f 5649 5349  REGEX = 'PROVISI
-00020620: 4f4e 494e 475c 7c53 5441 5254 494e 4727  ONING\|STARTING'
-00020630: 0a23 2053 696e 6365 2077 6520 646f 6e27  .# Since we don'
-00020640: 7420 616c 6c6f 7720 7465 726d 696e 6174  t allow terminat
-00020650: 6520 7468 6520 7365 7276 6963 6520 6966  e the service if
-00020660: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-00020670: 6973 2049 4e49 542c 0a23 2077 6869 6368  is INIT,.# which
-00020680: 2069 7320 636f 6d6d 6f6e 2066 6f72 2073   is common for s
-00020690: 696d 756c 7461 6e65 6f75 7320 7079 7465  imultaneous pyte
-000206a0: 7374 2c20 7765 206e 6565 6420 746f 2077  st, we need to w
-000206b0: 6169 7420 756e 7469 6c20 7468 650a 2320  ait until the.# 
-000206c0: 636f 6e74 726f 6c6c 6572 2069 7320 5550  controller is UP
-000206d0: 2062 6566 6f72 6520 7765 2063 616e 2074   before we can t
-000206e0: 6572 6d69 6e61 7465 2074 6865 2073 6572  erminate the ser
-000206f0: 7669 6365 2e0a 2320 5468 6520 7465 6172  vice..# The tear
-00020700: 646f 776e 2063 6f6d 6d61 6e64 2068 6173  down command has
-00020710: 2061 2031 302d 6d69 6e73 2074 696d 656f   a 10-mins timeo
-00020720: 7574 2c20 736f 2077 6520 646f 6e27 7420  ut, so we don't 
-00020730: 6e65 6564 2074 6f20 646f 0a23 2074 6865  need to do.# the
-00020740: 2074 696d 656f 7574 2068 6572 652e 2053   timeout here. S
-00020750: 6565 2069 6d70 6c65 6d65 6e74 6174 696f  ee implementatio
-00020760: 6e20 6f66 2072 756e 5f6f 6e65 5f74 6573  n of run_one_tes
-00020770: 7428 2920 666f 7220 6465 7461 696c 732e  t() for details.
-00020780: 0a5f 5445 4152 444f 574e 5f53 4552 5649  ._TEARDOWN_SERVI
-00020790: 4345 203d 2028 0a20 2020 2027 2866 6f72  CE = (.    '(for
-000207a0: 2069 2069 6e20 6073 6571 2031 2032 3060   i in `seq 1 20`
-000207b0: 3b20 646f 270a 2020 2020 2720 2020 2020  ; do'.    '     
-000207c0: 733d 2428 736b 7920 7365 7276 6520 646f  s=$(sky serve do
-000207d0: 776e 202d 7920 7b6e 616d 657d 293b 270a  wn -y {name});'.
-000207e0: 2020 2020 2720 2020 2020 6563 686f 2022      '     echo "
-000207f0: 5472 7969 6e67 2074 6f20 7465 726d 696e  Trying to termin
-00020800: 6174 6520 7b6e 616d 657d 223b 270a 2020  ate {name}";'.  
-00020810: 2020 2720 2020 2020 6563 686f 2022 2473    '     echo "$s
-00020820: 223b 270a 2020 2020 2720 2020 2020 6563  ";'.    '     ec
-00020830: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
-00020840: 7120 2273 6368 6564 756c 6564 2074 6f20  q "scheduled to 
-00020850: 6265 2074 6572 6d69 6e61 7465 645c 7c4e  be terminated\|N
-00020860: 6f20 7365 7276 6963 6520 746f 2074 6572  o service to ter
-00020870: 6d69 6e61 7465 2220 2626 2062 7265 616b  minate" && break
-00020880: 3b27 0a20 2020 2027 2020 2020 2073 6c65  ;'.    '     sle
-00020890: 6570 2031 303b 270a 2020 2020 2720 2020  ep 10;'.    '   
-000208a0: 2020 5b20 2469 202d 6571 2032 3020 5d20    [ $i -eq 20 ] 
-000208b0: 2626 2065 6368 6f20 2246 6169 6c65 6420  && echo "Failed 
-000208c0: 746f 2074 6572 6d69 6e61 7465 2073 6572  to terminate ser
-000208d0: 7669 6365 207b 6e61 6d65 7d22 3b27 0a20  vice {name}";'. 
-000208e0: 2020 2027 646f 6e65 2927 290a 0a5f 5345     'done)').._SE
-000208f0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00020900: 5420 3d20 280a 2020 2020 2765 7870 6f72  T = (.    'expor
-00020910: 7420 4f52 4947 494e 5f53 4b59 5049 4c4f  t ORIGIN_SKYPILO
-00020920: 545f 4445 4255 473d 2453 4b59 5049 4c4f  T_DEBUG=$SKYPILO
-00020930: 545f 4445 4255 473b 2065 7870 6f72 7420  T_DEBUG; export 
-00020940: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
-00020950: 3b20 270a 2020 2020 2765 6e64 706f 696e  ; '.    'endpoin
-00020960: 743d 2428 736b 7920 7365 7276 6520 7374  t=$(sky serve st
-00020970: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-00020980: 7b6e 616d 657d 293b 2027 0a20 2020 2027  {name}); '.    '
-00020990: 756e 7469 6c20 2120 6563 686f 2022 2465  until ! echo "$e
-000209a0: 6e64 706f 696e 7422 207c 2067 7265 7020  ndpoint" | grep 
-000209b0: 2243 6f6e 7472 6f6c 6c65 7220 6973 2069  "Controller is i
-000209c0: 6e69 7469 616c 697a 696e 6722 3b20 270a  nitializing"; '.
-000209d0: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
-000209e0: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
-000209f0: 656e 6470 6f69 6e74 2074 6f20 6265 2072  endpoint to be r
-00020a00: 6561 6479 2e2e 2e22 3b20 270a 2020 2020  eady..."; '.    
-00020a10: 2773 6c65 6570 2035 3b20 656e 6470 6f69  'sleep 5; endpoi
-00020a20: 6e74 3d24 2873 6b79 2073 6572 7665 2073  nt=$(sky serve s
-00020a30: 7461 7475 7320 2d2d 656e 6470 6f69 6e74  tatus --endpoint
-00020a40: 207b 6e61 6d65 7d29 3b20 646f 6e65 3b20   {name}); done; 
-00020a50: 270a 2020 2020 2765 7870 6f72 7420 534b  '.    'export SK
-00020a60: 5950 494c 4f54 5f44 4542 5547 3d24 4f52  YPILOT_DEBUG=$OR
-00020a70: 4947 494e 5f53 4b59 5049 4c4f 545f 4445  IGIN_SKYPILOT_DE
-00020a80: 4255 473b 2065 6368 6f20 2224 656e 6470  BUG; echo "$endp
-00020a90: 6f69 6e74 2227 290a 0a5f 5345 5256 455f  oint"').._SERVE_
-00020aa0: 5354 4154 5553 5f57 4149 5420 3d20 2827  STATUS_WAIT = ('
-00020ab0: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00020ac0: 6174 7573 207b 6e61 6d65 7d29 3b20 270a  atus {name}); '.
-00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ae0: 2020 2020 2020 2775 6e74 696c 2021 2065        'until ! e
-00020af0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00020b00: 2243 6f6e 7472 6f6c 6c65 7220 6973 2069  "Controller is i
-00020b10: 6e69 7469 616c 697a 696e 672e 223b 2027  nitializing."; '
-00020b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020b30: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
-00020b40: 2257 6169 7469 6e67 2066 6f72 2073 6572  "Waiting for ser
-00020b50: 7665 2073 7461 7475 7320 746f 2062 6520  ve status to be 
-00020b60: 7265 6164 792e 2e2e 223b 2027 0a20 2020  ready..."; '.   
-00020b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b80: 2020 2027 736c 6565 7020 353b 2073 3d24     'sleep 5; s=$
-00020b90: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00020ba0: 7320 7b6e 616d 657d 293b 2064 6f6e 653b  s {name}); done;
-00020bb0: 2065 6368 6f20 2224 7322 2729 0a0a 0a64   echo "$s"')...d
-00020bc0: 6566 205f 6765 745f 7265 706c 6963 615f  ef _get_replica_
-00020bd0: 6970 286e 616d 653a 2073 7472 2c20 7265  ip(name: str, re
-00020be0: 706c 6963 615f 6964 3a20 696e 7429 202d  plica_id: int) -
-00020bf0: 3e20 7374 723a 0a20 2020 2072 6574 7572  > str:.    retur
-00020c00: 6e20 2866 2769 707b 7265 706c 6963 615f  n (f'ip{replica_
-00020c10: 6964 7d3d 2428 6563 686f 2022 2473 2220  id}=$(echo "$s" 
-00020c20: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
-00020c30: 6627 6177 6b20 227b 5f41 574b 5f41 4c4c  f'awk "{_AWK_ALL
-00020c40: 5f4c 494e 4553 5f42 454c 4f57 5f52 4550  _LINES_BELOW_REP
-00020c50: 4c49 4341 537d 2220 7c20 270a 2020 2020  LICAS}" | '.    
-00020c60: 2020 2020 2020 2020 6627 6772 6570 202d          f'grep -
-00020c70: 4520 227b 6e61 6d65 7d5c 732b 7b72 6570  E "{name}\s+{rep
-00020c80: 6c69 6361 5f69 647d 2220 7c20 270a 2020  lica_id}" | '.  
-00020c90: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
-00020ca0: 202d 456f 2022 7b5f 4950 5f52 4547 4558   -Eo "{_IP_REGEX
-00020cb0: 7d22 2927 290a 0a0a 6465 6620 5f67 6574  }")')...def _get
-00020cc0: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
-00020cd0: 6573 7428 6e61 6d65 3a20 7374 722c 2063  est(name: str, c
-00020ce0: 6c6f 7564 3a20 7374 722c 0a20 2020 2020  loud: str,.     
-00020cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d00: 2020 2020 2020 2074 696d 656f 7574 5f6d         timeout_m
-00020d10: 696e 7574 6573 3a20 696e 7429 202d 3e20  inutes: int) -> 
-00020d20: 5465 7374 3a0a 2020 2020 7465 7374 203d  Test:.    test =
-00020d30: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-00020d40: 2774 6573 742d 736b 7973 6572 7665 2d7b  'test-skyserve-{
-00020d50: 636c 6f75 642e 7265 706c 6163 6528 225f  cloud.replace("_
-00020d60: 222c 2022 2d22 297d 272c 0a20 2020 2020  ", "-")}',.     
-00020d70: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00020d80: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-00020d90: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
-00020da0: 7473 2f73 6b79 7365 7276 652f 6874 7470  ts/skyserve/http
-00020db0: 2f7b 636c 6f75 647d 2e79 616d 6c27 2c0a  /{cloud}.yaml',.
-00020dc0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-00020dd0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-00020de0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-00020df0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00020e00: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
-00020e10: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00020e20: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00020e30: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00020e40: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
-00020e50: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00020e60: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00020e70: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00020e80: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00020e90: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00020ea0: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00020eb0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00020ec0: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
-00020ed0: 7574 5f6d 696e 7574 6573 202a 2036 302c  ut_minutes * 60,
-00020ee0: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-00020ef0: 6e20 7465 7374 0a0a 0a64 6566 205f 6368  n test...def _ch
-00020f00: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00020f10: 7461 7475 7328 6e61 6d65 3a20 7374 722c  tatus(name: str,
-00020f20: 2063 6865 636b 5f74 7570 6c65 733a 204c   check_tuples: L
-00020f30: 6973 745b 5475 706c 655b 696e 742c 2062  ist[Tuple[int, b
-00020f40: 6f6f 6c2c 0a20 2020 2020 2020 2020 2020  ool,.           
-00020f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e7d0: 7374 6172 7420 2d79 207b 6e61 6d65 7d27  start -y {name}'
+0001e7e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001e7f0: 736b 7920 6578 6563 202d 2d6e 756d 2d6e  sky exec --num-n
+0001e800: 6f64 6573 3d32 207b 6e61 6d65 7d20 6578  odes=2 {name} ex
+0001e810: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
+0001e820: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+0001e830: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001e840: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+0001e850: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0001e860: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0001e870: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+0001e880: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0001e890: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0001e8a0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+0001e8b0: 3d33 3020 2a20 3630 2c20 2023 2033 3020  =30 * 60,  # 30 
+0001e8c0: 6d69 6e73 2020 2869 7420 7461 6b65 7320  mins  (it takes 
+0001e8d0: 6172 6f75 6e64 207e 3233 206d 696e 7329  around ~23 mins)
+0001e8e0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0001e8f0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0001e900: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0001e910: 7469 6e67 2065 6e76 2066 6f72 2064 6973  ting env for dis
+0001e920: 6b20 7469 6572 202d 2d2d 2d2d 2d2d 2d2d  k tier ---------
+0001e930: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
+0001e940: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
+0001e950: 6469 736b 5f74 6965 7228 293a 0a0a 2020  disk_tier():..  
+0001e960: 2020 6465 6620 5f67 6574 5f61 7773 5f71    def _get_aws_q
+0001e970: 7565 7279 5f63 6f6d 6d61 6e64 2872 6567  uery_command(reg
+0001e980: 696f 6e2c 2069 6e73 7461 6e63 655f 6964  ion, instance_id
+0001e990: 2c20 6669 656c 642c 2065 7870 6563 7465  , field, expecte
+0001e9a0: 6429 3a0a 2020 2020 2020 2020 7265 7475  d):.        retu
+0001e9b0: 726e 2028 6627 6177 7320 6563 3220 6465  rn (f'aws ec2 de
+0001e9c0: 7363 7269 6265 2d76 6f6c 756d 6573 202d  scribe-volumes -
+0001e9d0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+0001e9e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001e9f0: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+0001ea00: 616d 653d 6174 7461 6368 6d65 6e74 2e69  ame=attachment.i
+0001ea10: 6e73 7461 6e63 652d 6964 2c56 616c 7565  nstance-id,Value
+0001ea20: 733d 7b69 6e73 7461 6e63 655f 6964 7d20  s={instance_id} 
+0001ea30: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001ea40: 2020 6627 2d2d 7175 6572 7920 566f 6c75    f'--query Volu
+0001ea50: 6d65 735b 2a5d 2e7b 6669 656c 647d 207c  mes[*].{field} |
+0001ea60: 2067 7265 7020 7b65 7870 6563 7465 647d   grep {expected}
+0001ea70: 203b 2027 290a 0a20 2020 2066 6f72 2064   ; ')..    for d
+0001ea80: 6973 6b5f 7469 6572 2069 6e20 6c69 7374  isk_tier in list
+0001ea90: 2872 6573 6f75 7263 6573 5f75 7469 6c73  (resources_utils
+0001eaa0: 2e44 6973 6b54 6965 7229 3a0a 2020 2020  .DiskTier):.    
+0001eab0: 2020 2020 7370 6563 7320 3d20 4157 532e      specs = AWS.
+0001eac0: 5f67 6574 5f64 6973 6b5f 7370 6563 7328  _get_disk_specs(
+0001ead0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
+0001eae0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0001eaf0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
+0001eb00: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
+0001eb10: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
+0001eb20: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
+0001eb30: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+0001eb40: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+0001eb50: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
+0001eb60: 2020 206e 616d 652c 2073 6b79 2e41 5753     name, sky.AWS
+0001eb70: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
+0001eb80: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
+0001eb90: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
+0001eba0: 2d65 6173 742d 3227 0a20 2020 2020 2020  -east-2'.       
+0001ebb0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001ebc0: 2020 2020 2020 2020 2020 2761 7773 2d64            'aws-d
+0001ebd0: 6973 6b2d 7469 6572 2d27 202b 2064 6973  isk-tier-' + dis
+0001ebe0: 6b5f 7469 6572 2e76 616c 7565 2c0a 2020  k_tier.value,.  
+0001ebf0: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+0001ec00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001ec10: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0001ec20: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
+0001ec30: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001ec40: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001ec50: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
+0001ec60: 6965 7220 7b64 6973 6b5f 7469 6572 2e76  ier {disk_tier.v
+0001ec70: 616c 7565 7d20 6563 686f 2022 6865 6c6c  alue} echo "hell
+0001ec80: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
+0001ec90: 2020 2020 2020 2020 2066 2769 643d 6061           f'id=`a
+0001eca0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+0001ecb0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+0001ecc0: 6f6e 207b 7265 6769 6f6e 7d20 2d2d 6669  on {region} --fi
+0001ecd0: 6c74 6572 7320 270a 2020 2020 2020 2020  lters '.        
+0001ece0: 2020 2020 2020 2020 6627 4e61 6d65 3d74          f'Name=t
+0001ecf0: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
+0001ed00: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
+0001ed10: 5f6f 6e5f 636c 6f75 647d 202d 2d71 7565  _on_cloud} --que
+0001ed20: 7279 2027 0a20 2020 2020 2020 2020 2020  ry '.           
+0001ed30: 2020 2020 2066 2752 6573 6572 7661 7469       f'Reservati
+0001ed40: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
+0001ed50: 5d2e 496e 7374 616e 6365 4964 202d 2d6f  ].InstanceId --o
+0001ed60: 7574 7075 7420 7465 7874 603b 2027 202b  utput text`; ' +
+0001ed70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ed80: 205f 6765 745f 6177 735f 7175 6572 795f   _get_aws_query_
+0001ed90: 636f 6d6d 616e 6428 7265 6769 6f6e 2c20  command(region, 
+0001eda0: 2724 6964 272c 2027 566f 6c75 6d65 5479  '$id', 'VolumeTy
+0001edb0: 7065 272c 0a20 2020 2020 2020 2020 2020  pe',.           
+0001edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edd0: 2020 2020 2020 2020 2020 2020 7370 6563              spec
+0001ede0: 735b 2764 6973 6b5f 7469 6572 275d 2920  s['disk_tier']) 
+0001edf0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+0001ee00: 2020 2827 2720 6966 2064 6973 6b5f 7469    ('' if disk_ti
+0001ee10: 6572 203d 3d20 7265 736f 7572 6365 735f  er == resources_
+0001ee20: 7574 696c 732e 4469 736b 5469 6572 2e4c  utils.DiskTier.L
+0001ee30: 4f57 2065 6c73 650a 2020 2020 2020 2020  OW else.        
+0001ee40: 2020 2020 2020 2020 2028 5f67 6574 5f61           (_get_a
+0001ee50: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
+0001ee60: 2872 6567 696f 6e2c 2027 2469 6427 2c20  (region, '$id', 
+0001ee70: 2749 6f70 7327 2c0a 2020 2020 2020 2020  'Iops',.        
+0001ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eea0: 2073 7065 6373 5b27 6469 736b 5f69 6f70   specs['disk_iop
+0001eeb0: 7327 5d29 202b 0a20 2020 2020 2020 2020  s']) +.         
+0001eec0: 2020 2020 2020 2020 205f 6765 745f 6177           _get_aw
+0001eed0: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
+0001eee0: 7265 6769 6f6e 2c20 2724 6964 272c 2027  region, '$id', '
+0001eef0: 5468 726f 7567 6870 7574 272c 0a20 2020  Throughput',.   
+0001ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef20: 2020 2020 2020 7370 6563 735b 2764 6973        specs['dis
+0001ef30: 6b5f 7468 726f 7567 6870 7574 275d 2929  k_throughput']))
+0001ef40: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
+0001ef50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001ef60: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0001ef70: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+0001ef80: 2074 696d 656f 7574 3d31 3020 2a20 3630   timeout=10 * 60
+0001ef90: 2c20 2023 2031 3020 6d69 6e73 2020 2869  ,  # 10 mins  (i
+0001efa0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
+0001efb0: 3620 6d69 6e73 290a 2020 2020 2020 2020  6 mins).        
+0001efc0: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
+0001efd0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0001efe0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+0001eff0: 6465 6620 7465 7374 5f67 6370 5f64 6973  def test_gcp_dis
+0001f000: 6b5f 7469 6572 2829 3a0a 2020 2020 666f  k_tier():.    fo
+0001f010: 7220 6469 736b 5f74 6965 7220 696e 206c  r disk_tier in l
+0001f020: 6973 7428 7265 736f 7572 6365 735f 7574  ist(resources_ut
+0001f030: 696c 732e 4469 736b 5469 6572 293a 0a20  ils.DiskTier):. 
+0001f040: 2020 2020 2020 2074 7970 6520 3d20 4743         type = GC
+0001f050: 502e 5f67 6574 5f64 6973 6b5f 7479 7065  P._get_disk_type
+0001f060: 2864 6973 6b5f 7469 6572 290a 2020 2020  (disk_tier).    
+0001f070: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001f080: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
+0001f090: 2027 2d27 202b 2064 6973 6b5f 7469 6572   '-' + disk_tier
+0001f0a0: 2e76 616c 7565 0a20 2020 2020 2020 206e  .value.        n
+0001f0b0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
+0001f0c0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+0001f0d0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+0001f0e0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+0001f0f0: 2020 2020 6e61 6d65 2c20 736b 792e 4743      name, sky.GC
+0001f100: 502e 6d61 785f 636c 7573 7465 725f 6e61  P.max_cluster_na
+0001f110: 6d65 5f6c 656e 6774 6828 2929 0a20 2020  me_length()).   
+0001f120: 2020 2020 2072 6567 696f 6e20 3d20 2775       region = 'u
+0001f130: 732d 7765 7374 3227 0a20 2020 2020 2020  s-west2'.       
+0001f140: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0001f150: 2020 2020 2020 2020 2020 2767 6370 2d64            'gcp-d
+0001f160: 6973 6b2d 7469 6572 2d27 202b 2064 6973  isk-tier-' + dis
+0001f170: 6b5f 7469 6572 2e76 616c 7565 2c0a 2020  k_tier.value,.  
+0001f180: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+0001f190: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f1a0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0001f1b0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+0001f1c0: 7020 2d2d 7265 6769 6f6e 207b 7265 6769  p --region {regi
+0001f1d0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001f1e0: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
+0001f1f0: 6965 7220 7b64 6973 6b5f 7469 6572 2e76  ier {disk_tier.v
+0001f200: 616c 7565 7d20 6563 686f 2022 6865 6c6c  alue} echo "hell
+0001f210: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
+0001f220: 2020 2020 2020 2020 2066 276e 616d 653d           f'name=
+0001f230: 6067 636c 6f75 6420 636f 6d70 7574 6520  `gcloud compute 
+0001f240: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
+0001f250: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
+0001f260: 2020 2020 2020 2020 2020 6627 226c 6162            f'"lab
+0001f270: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+0001f280: 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f 636c  name:{name_on_cl
+0001f290: 6f75 647d 2220 270a 2020 2020 2020 2020  oud}" '.        
+0001f2a0: 2020 2020 2020 2020 272d 2d66 6f72 6d61          '--forma
+0001f2b0: 743d 2276 616c 7565 286e 616d 6529 2260  t="value(name)"`
+0001f2c0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+0001f2d0: 2020 2020 6627 6763 6c6f 7564 2063 6f6d      f'gcloud com
+0001f2e0: 7075 7465 2064 6973 6b73 206c 6973 7420  pute disks list 
+0001f2f0: 2d2d 6669 6c74 6572 3d22 6e61 6d65 3d24  --filter="name=$
+0001f300: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
+0001f310: 2020 2020 2020 2020 6627 2d2d 666f 726d          f'--form
+0001f320: 6174 3d22 7661 6c75 6528 7479 7065 2922  at="value(type)"
+0001f330: 207c 2067 7265 7020 7b74 7970 657d 2027   | grep {type} '
+0001f340: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+0001f350: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f360: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0001f370: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+0001f380: 696d 656f 7574 3d36 202a 2036 302c 2020  imeout=6 * 60,  
+0001f390: 2320 3620 6d69 6e73 2020 2869 7420 7461  # 6 mins  (it ta
+0001f3a0: 6b65 7320 6172 6f75 6e64 207e 3320 6d69  kes around ~3 mi
+0001f3b0: 6e73 290a 2020 2020 2020 2020 290a 2020  ns).        ).  
+0001f3c0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
+0001f3d0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+0001f3e0: 7374 2e6d 6172 6b2e 617a 7572 650a 6465  st.mark.azure.de
+0001f3f0: 6620 7465 7374 5f61 7a75 7265 5f64 6973  f test_azure_dis
+0001f400: 6b5f 7469 6572 2829 3a0a 2020 2020 666f  k_tier():.    fo
+0001f410: 7220 6469 736b 5f74 6965 7220 696e 206c  r disk_tier in l
+0001f420: 6973 7428 7265 736f 7572 6365 735f 7574  ist(resources_ut
+0001f430: 696c 732e 4469 736b 5469 6572 293a 0a20  ils.DiskTier):. 
+0001f440: 2020 2020 2020 2069 6620 6469 736b 5f74         if disk_t
+0001f450: 6965 7220 3d3d 2072 6573 6f75 7263 6573  ier == resources
+0001f460: 5f75 7469 6c73 2e44 6973 6b54 6965 722e  _utils.DiskTier.
+0001f470: 4849 4748 3a0a 2020 2020 2020 2020 2020  HIGH:.          
+0001f480: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
+0001f490: 6f74 2073 7570 706f 7274 2068 6967 6820  ot support high 
+0001f4a0: 6469 736b 2074 6965 722e 0a20 2020 2020  disk tier..     
+0001f4b0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0001f4c0: 2020 2020 2020 2020 7479 7065 203d 2041          type = A
+0001f4d0: 7a75 7265 2e5f 6765 745f 6469 736b 5f74  zure._get_disk_t
+0001f4e0: 7970 6528 6469 736b 5f74 6965 7229 0a20  ype(disk_tier). 
+0001f4f0: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+0001f500: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001f510: 2920 2b20 272d 2720 2b20 6469 736b 5f74  ) + '-' + disk_t
+0001f520: 6965 722e 7661 6c75 650a 2020 2020 2020  ier.value.      
+0001f530: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+0001f540: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+0001f550: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+0001f560: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+0001f570: 2020 2020 2020 206e 616d 652c 2073 6b79         name, sky
+0001f580: 2e41 7a75 7265 2e6d 6178 5f63 6c75 7374  .Azure.max_clust
+0001f590: 6572 5f6e 616d 655f 6c65 6e67 7468 2829  er_name_length()
+0001f5a0: 290a 2020 2020 2020 2020 7265 6769 6f6e  ).        region
+0001f5b0: 203d 2027 7765 7374 7573 3227 0a20 2020   = 'westus2'.   
+0001f5c0: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
+0001f5d0: 280a 2020 2020 2020 2020 2020 2020 2761  (.            'a
+0001f5e0: 7a75 7265 2d64 6973 6b2d 7469 6572 2d27  zure-disk-tier-'
+0001f5f0: 202b 2064 6973 6b5f 7469 6572 2e76 616c   + disk_tier.val
+0001f600: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0001f610: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0001f620: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0001f630: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+0001f640: 6f75 6420 617a 7572 6520 2d2d 7265 6769  oud azure --regi
+0001f650: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+0001f660: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001f670: 2d2d 6469 736b 2d74 6965 7220 7b64 6973  --disk-tier {dis
+0001f680: 6b5f 7469 6572 2e76 616c 7565 7d20 6563  k_tier.value} ec
+0001f690: 686f 2022 6865 6c6c 6f20 736b 7922 272c  ho "hello sky"',
+0001f6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f6b0: 2066 2761 7a20 7265 736f 7572 6365 206c   f'az resource l
+0001f6c0: 6973 7420 2d2d 7461 6720 7261 792d 636c  ist --tag ray-cl
+0001f6d0: 7573 7465 722d 6e61 6d65 3d7b 6e61 6d65  uster-name={name
+0001f6e0: 5f6f 6e5f 636c 6f75 647d 202d 2d71 7565  _on_cloud} --que
+0001f6f0: 7279 2027 0a20 2020 2020 2020 2020 2020  ry '.           
+0001f700: 2020 2020 2066 2722 5b3f 7479 7065 3d3d       f'"[?type==
+0001f710: 5c27 4d69 6372 6f73 6f66 742e 436f 6d70  \'Microsoft.Comp
+0001f720: 7574 652f 6469 736b 735c 275d 2e73 6b75  ute/disks\'].sku
+0001f730: 2e6e 616d 6522 2027 0a20 2020 2020 2020  .name" '.       
+0001f740: 2020 2020 2020 2020 2066 272d 2d6f 7574           f'--out
+0001f750: 7075 7420 7473 7620 7c20 6772 6570 207b  put tsv | grep {
+0001f760: 7479 7065 7d27 0a20 2020 2020 2020 2020  type}'.         
+0001f770: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+0001f780: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0001f790: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0001f7a0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+0001f7b0: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
+0001f7c0: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
+0001f7d0: 6e64 207e 3132 206d 696e 7329 0a20 2020  nd ~12 mins).   
+0001f7e0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0001f7f0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001f800: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001f810: 2e61 7a75 7265 0a64 6566 2074 6573 745f  .azure.def test_
+0001f820: 617a 7572 655f 6265 7374 5f74 6965 725f  azure_best_tier_
+0001f830: 6661 696c 6f76 6572 2829 3a0a 2020 2020  failover():.    
+0001f840: 7479 7065 203d 2041 7a75 7265 2e5f 6765  type = Azure._ge
+0001f850: 745f 6469 736b 5f74 7970 6528 7265 736f  t_disk_type(reso
+0001f860: 7572 6365 735f 7574 696c 732e 4469 736b  urces_utils.Disk
+0001f870: 5469 6572 2e4c 4f57 290a 2020 2020 6e61  Tier.LOW).    na
+0001f880: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0001f890: 725f 6e61 6d65 2829 0a20 2020 206e 616d  r_name().    nam
+0001f8a0: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
+0001f8b0: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
+0001f8c0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
+0001f8d0: 6c6f 7564 280a 2020 2020 2020 2020 6e61  loud(.        na
+0001f8e0: 6d65 2c20 736b 792e 417a 7572 652e 6d61  me, sky.Azure.ma
+0001f8f0: 785f 636c 7573 7465 725f 6e61 6d65 5f6c  x_cluster_name_l
+0001f900: 656e 6774 6828 2929 0a20 2020 2072 6567  ength()).    reg
+0001f910: 696f 6e20 3d20 2777 6573 7475 7332 270a  ion = 'westus2'.
+0001f920: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0001f930: 0a20 2020 2020 2020 2027 617a 7572 652d  .        'azure-
+0001f940: 6265 7374 2d74 6965 722d 6661 696c 6f76  best-tier-failov
+0001f950: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
+0001f960: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001f970: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0001f980: 616d 657d 202d 2d63 6c6f 7564 2061 7a75  ame} --cloud azu
+0001f990: 7265 202d 2d72 6567 696f 6e20 7b72 6567  re --region {reg
+0001f9a0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+0001f9b0: 2020 2066 272d 2d64 6973 6b2d 7469 6572     f'--disk-tier
+0001f9c0: 2062 6573 7420 2d2d 696e 7374 616e 6365   best --instance
+0001f9d0: 2d74 7970 6520 5374 616e 6461 7264 5f44  -type Standard_D
+0001f9e0: 385f 7635 2065 6368 6f20 2268 656c 6c6f  8_v5 echo "hello
+0001f9f0: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
+0001fa00: 2020 2020 6627 617a 2072 6573 6f75 7263      f'az resourc
+0001fa10: 6520 6c69 7374 202d 2d74 6167 2072 6179  e list --tag ray
+0001fa20: 2d63 6c75 7374 6572 2d6e 616d 653d 7b6e  -cluster-name={n
+0001fa30: 616d 655f 6f6e 5f63 6c6f 7564 7d20 2d2d  ame_on_cloud} --
+0001fa40: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
+0001fa50: 2020 2020 6627 225b 3f74 7970 653d 3d5c      f'"[?type==\
+0001fa60: 274d 6963 726f 736f 6674 2e43 6f6d 7075  'Microsoft.Compu
+0001fa70: 7465 2f64 6973 6b73 5c27 5d2e 736b 752e  te/disks\'].sku.
+0001fa80: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
+0001fa90: 2020 2020 6627 2d2d 6f75 7470 7574 2074      f'--output t
+0001faa0: 7376 207c 2067 7265 7020 7b74 7970 657d  sv | grep {type}
+0001fab0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001fac0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0001fad0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0001fae0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+0001faf0: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
+0001fb00: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
+0001fb10: 6e64 207e 3132 206d 696e 7329 0a20 2020  nd ~12 mins).   
+0001fb20: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0001fb30: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0001fb40: 2d2d 2d2d 2054 6573 7469 6e67 205a 6572  ---- Testing Zer
+0001fb50: 6f20 5175 6f74 6120 4661 696c 6f76 6572  o Quota Failover
+0001fb60: 202d 2d2d 2d2d 2d0a 4070 7974 6573 742e   ------.@pytest.
+0001fb70: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+0001fb80: 745f 6177 735f 7a65 726f 5f71 756f 7461  t_aws_zero_quota
+0001fb90: 5f66 6169 6c6f 7665 7228 293a 0a0a 2020  _failover():..  
+0001fba0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001fbb0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001fbc0: 2072 6567 696f 6e20 3d20 6765 745f 6177   region = get_aw
+0001fbd0: 735f 7265 6769 6f6e 5f66 6f72 5f71 756f  s_region_for_quo
+0001fbe0: 7461 5f66 6169 6c6f 7665 7228 290a 0a20  ta_failover().. 
+0001fbf0: 2020 2069 6620 6e6f 7420 7265 6769 6f6e     if not region
+0001fc00: 3a0a 2020 2020 2020 2020 7079 7465 7374  :.        pytest
+0001fc10: 2e78 6661 696c 280a 2020 2020 2020 2020  .xfail(.        
+0001fc20: 2020 2020 2755 6e61 626c 6520 746f 2074      'Unable to t
+0001fc30: 6573 7420 7a65 726f 2071 756f 7461 2066  est zero quota f
+0001fc40: 6169 6c6f 7665 7220 6f70 7469 6d69 7a61  ailover optimiza
+0001fc50: 7469 6f6e 20e2 8094 2071 756f 7461 7320  tion ... quotas 
+0001fc60: 270a 2020 2020 2020 2020 2020 2020 2766  '.            'f
+0001fc70: 6f72 2045 4332 2050 3320 696e 7374 616e  or EC2 P3 instan
+0001fc80: 6365 7320 7765 7265 2066 6f75 6e64 206f  ces were found o
+0001fc90: 6e20 616c 6c20 4157 5320 7265 6769 6f6e  n all AWS region
+0001fca0: 732e 2049 7320 7468 6973 2027 0a20 2020  s. Is this '.   
+0001fcb0: 2020 2020 2020 2020 2027 6578 7065 6374           'expect
+0001fcc0: 6564 2066 6f72 2079 6f75 7220 6163 636f  ed for your acco
+0001fcd0: 756e 743f 2729 0a20 2020 2020 2020 2072  unt?').        r
+0001fce0: 6574 7572 6e0a 0a20 2020 2074 6573 7420  eturn..    test 
+0001fcf0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001fd00: 2761 7773 2d7a 6572 6f2d 7175 6f74 612d  'aws-zero-quota-
+0001fd10: 6661 696c 6f76 6572 272c 0a20 2020 2020  failover',.     
+0001fd20: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0001fd30: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0001fd40: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+0001fd50: 7564 2061 7773 202d 2d72 6567 696f 6e20  ud aws --region 
+0001fd60: 7b72 6567 696f 6e7d 202d 2d67 7075 7320  {region} --gpus 
+0001fd70: 5631 3030 3a38 202d 2d75 7365 2d73 706f  V100:8 --use-spo
+0001fd80: 7420 7c20 6772 6570 2022 466f 756e 6420  t | grep "Found 
+0001fd90: 6e6f 2071 756f 7461 2227 2c0a 2020 2020  no quota"',.    
+0001fda0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001fdb0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001fdc0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0001fdd0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0001fde0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0001fdf0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+0001fe00: 6370 5f7a 6572 6f5f 7175 6f74 615f 6661  cp_zero_quota_fa
+0001fe10: 696c 6f76 6572 2829 3a0a 0a20 2020 206e  ilover():..    n
+0001fe20: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+0001fe30: 6572 5f6e 616d 6528 290a 2020 2020 7265  er_name().    re
+0001fe40: 6769 6f6e 203d 2067 6574 5f67 6370 5f72  gion = get_gcp_r
+0001fe50: 6567 696f 6e5f 666f 725f 7175 6f74 615f  egion_for_quota_
+0001fe60: 6661 696c 6f76 6572 2829 0a0a 2020 2020  failover()..    
+0001fe70: 6966 206e 6f74 2072 6567 696f 6e3a 0a20  if not region:. 
+0001fe80: 2020 2020 2020 2070 7974 6573 742e 7866         pytest.xf
+0001fe90: 6169 6c28 0a20 2020 2020 2020 2020 2020  ail(.           
+0001fea0: 2027 556e 6162 6c65 2074 6f20 7465 7374   'Unable to test
+0001feb0: 207a 6572 6f20 7175 6f74 6120 6661 696c   zero quota fail
+0001fec0: 6f76 6572 206f 7074 696d 697a 6174 696f  over optimizatio
+0001fed0: 6e20 e280 9420 7175 6f74 6173 2027 0a20  n ... quotas '. 
+0001fee0: 2020 2020 2020 2020 2020 2027 666f 7220             'for 
+0001fef0: 4131 3030 2d38 3047 4220 4750 5573 2077  A100-80GB GPUs w
+0001ff00: 6572 6520 666f 756e 6420 6f6e 2061 6c6c  ere found on all
+0001ff10: 2047 4350 2072 6567 696f 6e73 2e20 4973   GCP regions. Is
+0001ff20: 2074 6869 7320 270a 2020 2020 2020 2020   this '.        
+0001ff30: 2020 2020 2765 7870 6563 7465 6420 666f      'expected fo
+0001ff40: 7220 796f 7572 2061 6363 6f75 6e74 3f27  r your account?'
+0001ff50: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001ff60: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
+0001ff70: 7428 0a20 2020 2020 2020 2027 6763 702d  t(.        'gcp-
+0001ff80: 7a65 726f 2d71 756f 7461 2d66 6169 6c6f  zero-quota-failo
+0001ff90: 7665 7227 2c0a 2020 2020 2020 2020 5b0a  ver',.        [.
+0001ffa0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001ffb0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0001ffc0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+0001ffd0: 7020 2d2d 7265 6769 6f6e 207b 7265 6769  p --region {regi
+0001ffe0: 6f6e 7d20 2d2d 6770 7573 2041 3130 302d  on} --gpus A100-
+0001fff0: 3830 4742 3a31 202d 2d75 7365 2d73 706f  80GB:1 --use-spo
+00020000: 7420 7c20 6772 6570 2022 466f 756e 6420  t | grep "Found 
+00020010: 6e6f 2071 756f 7461 2227 2c0a 2020 2020  no quota"',.    
+00020020: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00020030: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00020040: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00020050: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00020060: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+00020070: 2d20 5465 7374 696e 6720 736b 7973 6572  - Testing skyser
+00020080: 7665 202d 2d2d 2d2d 2d2d 2d2d 2d0a 0a0a  ve ----------...
+00020090: 6465 6620 5f67 6574 5f73 6572 7669 6365  def _get_service
+000200a0: 5f6e 616d 6528 2920 2d3e 2073 7472 3a0a  _name() -> str:.
+000200b0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
+000200c0: 2075 7365 722d 756e 6971 7565 2073 6572   user-unique ser
+000200d0: 7669 6365 206e 616d 6520 666f 7220 6561  vice name for ea
+000200e0: 6368 2074 6573 745f 736b 7973 6572 7665  ch test_skyserve
+000200f0: 5f3c 6e61 6d65 3e28 292e 0a0a 2020 2020  _<name>()...    
+00020100: 4d75 7374 2062 6520 6361 6c6c 6564 2066  Must be called f
+00020110: 726f 6d20 6561 6368 2074 6573 745f 736b  rom each test_sk
+00020120: 7973 6572 7665 5f3c 6e61 6d65 3e28 292e  yserve_<name>().
+00020130: 0a20 2020 2022 2222 0a20 2020 2063 616c  .    """.    cal
+00020140: 6c65 725f 6675 6e63 5f6e 616d 6520 3d20  ler_func_name = 
+00020150: 696e 7370 6563 742e 7374 6163 6b28 295b  inspect.stack()[
+00020160: 315d 5b33 5d0a 2020 2020 7465 7374 5f6e  1][3].    test_n
+00020170: 616d 6520 3d20 6361 6c6c 6572 5f66 756e  ame = caller_fun
+00020180: 635f 6e61 6d65 2e72 6570 6c61 6365 2827  c_name.replace('
+00020190: 5f27 2c20 272d 2729 2e72 6570 6c61 6365  _', '-').replace
+000201a0: 2827 7465 7374 2d27 2c20 2774 2d27 290a  ('test-', 't-').
+000201b0: 2020 2020 7465 7374 5f6e 616d 6520 3d20      test_name = 
+000201c0: 7465 7374 5f6e 616d 652e 7265 706c 6163  test_name.replac
+000201d0: 6528 2773 6b79 7365 7276 652d 272c 2027  e('skyserve-', '
+000201e0: 7373 2d27 290a 2020 2020 7465 7374 5f6e  ss-').    test_n
+000201f0: 616d 6520 3d20 636f 6d6d 6f6e 5f75 7469  ame = common_uti
+00020200: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
+00020210: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 7465  name_on_cloud(te
+00020220: 7374 5f6e 616d 652c 2032 3429 0a20 2020  st_name, 24).   
+00020230: 2072 6574 7572 6e20 6627 7b74 6573 745f   return f'{test_
+00020240: 6e61 6d65 7d2d 7b74 6573 745f 6964 7d27  name}-{test_id}'
+00020250: 0a0a 0a23 2057 6520 6368 6563 6b20 7468  ...# We check th
+00020260: 6520 6f75 7470 7574 206f 6620 7468 6520  e output of the 
+00020270: 736b 7973 6572 7665 2073 6572 7669 6365  skyserve service
+00020280: 2074 6f20 7365 6520 6966 2069 7420 6973   to see if it is
+00020290: 2072 6561 6479 2e20 4f75 7470 7574 206f   ready. Output o
+000202a0: 660a 2320 6052 4550 4c49 4341 5360 2069  f.# `REPLICAS` i
+000202b0: 7320 696e 2074 6865 2066 6f72 6d20 6f66  s in the form of
+000202c0: 2060 312f 3260 2077 6865 7265 2074 6865   `1/2` where the
+000202d0: 2066 6972 7374 206e 756d 6265 7220 6973   first number is
+000202e0: 2074 6865 206e 756d 6265 7220 6f66 0a23   the number of.#
+000202f0: 2072 6561 6479 2072 6570 6c69 6361 7320   ready replicas 
+00020300: 616e 6420 7468 6520 7365 636f 6e64 206e  and the second n
+00020310: 756d 6265 7220 6973 2074 6865 206e 756d  umber is the num
+00020320: 6265 7220 6f66 2074 6f74 616c 2072 6570  ber of total rep
+00020330: 6c69 6361 732e 2057 650a 2320 6772 6570  licas. We.# grep
+00020340: 2073 7563 6820 666f 726d 6174 2074 6f20   such format to 
+00020350: 656e 7375 7265 2074 6861 7420 7468 6520  ensure that the 
+00020360: 7365 7276 6963 6520 6973 2072 6561 6479  service is ready
+00020370: 2c20 616e 6420 6561 726c 7920 6578 6974  , and early exit
+00020380: 2069 6620 616e 790a 2320 6661 696c 7572   if any.# failur
+00020390: 6520 6465 7465 6374 6564 2e20 496e 2074  e detected. In t
+000203a0: 6865 2065 6e64 2077 6520 736c 6565 7020  he end we sleep 
+000203b0: 666f 720a 2320 7365 7276 652e 4c42 5f43  for.# serve.LB_C
+000203c0: 4f4e 5452 4f4c 4c45 525f 5359 4e43 5f49  ONTROLLER_SYNC_I
+000203d0: 4e54 4552 5641 4c5f 5345 434f 4e44 5320  NTERVAL_SECONDS 
+000203e0: 746f 206d 616b 6520 7375 7265 206c 6f61  to make sure loa
+000203f0: 6420 6261 6c61 6e63 6572 2068 6176 650a  d balancer have.
+00020400: 2320 656e 6f75 6768 2074 696d 6520 746f  # enough time to
+00020410: 2073 796e 6320 7769 7468 2074 6865 2063   sync with the c
+00020420: 6f6e 7472 6f6c 6c65 7220 616e 6420 6765  ontroller and ge
+00020430: 7420 616c 6c20 7265 6164 7920 7265 706c  t all ready repl
+00020440: 6963 6120 4950 732e 0a5f 5345 5256 455f  ica IPs.._SERVE_
+00020450: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00020460: 203d 2028 0a20 2020 2027 7b7b 2077 6869   = (.    '{{ whi
+00020470: 6c65 2074 7275 653b 2064 6f27 0a20 2020  le true; do'.   
+00020480: 2027 2020 2020 2073 3d24 2873 6b79 2073   '     s=$(sky s
+00020490: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+000204a0: 657d 293b 2065 6368 6f20 2224 7322 3b27  e}); echo "$s";'
+000204b0: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
+000204c0: 2224 7322 207c 2067 7265 7020 2d71 2022  "$s" | grep -q "
+000204d0: 7b72 6570 6c69 6361 5f6e 756d 7d2f 7b72  {replica_num}/{r
+000204e0: 6570 6c69 6361 5f6e 756d 7d22 2026 2620  eplica_num}" && 
+000204f0: 6272 6561 6b3b 270a 2020 2020 2720 2020  break;'.    '   
+00020500: 2020 6563 686f 2022 2473 2220 7c20 6772    echo "$s" | gr
+00020510: 6570 202d 7120 2246 4149 4c45 4422 2026  ep -q "FAILED" &
+00020520: 2620 6578 6974 2031 3b27 0a20 2020 2027  & exit 1;'.    '
+00020530: 2020 2020 2073 6c65 6570 2031 303b 270a       sleep 10;'.
+00020540: 2020 2020 2720 646f 6e65 3b20 7d7d 3b20      ' done; }}; 
+00020550: 6563 686f 2022 476f 7420 7365 7276 6963  echo "Got servic
+00020560: 6520 7374 6174 7573 2024 7322 3b27 0a20  e status $s";'. 
+00020570: 2020 2066 2773 6c65 6570 207b 7365 7276     f'sleep {serv
+00020580: 652e 4c42 5f43 4f4e 5452 4f4c 4c45 525f  e.LB_CONTROLLER_
+00020590: 5359 4e43 5f49 4e54 4552 5641 4c5f 5345  SYNC_INTERVAL_SE
+000205a0: 434f 4e44 5320 2b20 327d 3b27 290a 5f49  CONDS + 2};')._I
+000205b0: 505f 5245 4745 5820 3d20 7227 285b 302d  P_REGEX = r'([0-
+000205c0: 395d 7b31 2c33 7d5c 2e29 7b33 7d5b 302d  9]{1,3}\.){3}[0-
+000205d0: 395d 7b31 2c33 7d27 0a5f 4157 4b5f 414c  9]{1,3}'._AWK_AL
+000205e0: 4c5f 4c49 4e45 535f 4245 4c4f 575f 5245  L_LINES_BELOW_RE
+000205f0: 504c 4943 4153 203d 2072 272f 5265 706c  PLICAS = r'/Repl
+00020600: 6963 6173 2f7b 666c 6167 3d31 3b20 6e65  icas/{flag=1; ne
+00020610: 7874 7d20 666c 6167 270a 5f53 4552 5649  xt} flag'._SERVI
+00020620: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+00020630: 5455 535f 5245 4745 5820 3d20 2750 524f  TUS_REGEX = 'PRO
+00020640: 5649 5349 4f4e 494e 475c 7c53 5441 5254  VISIONING\|START
+00020650: 494e 4727 0a23 2053 696e 6365 2077 6520  ING'.# Since we 
+00020660: 646f 6e27 7420 616c 6c6f 7720 7465 726d  don't allow term
+00020670: 696e 6174 6520 7468 6520 7365 7276 6963  inate the servic
+00020680: 6520 6966 2074 6865 2063 6f6e 7472 6f6c  e if the control
+00020690: 6c65 7220 6973 2049 4e49 542c 0a23 2077  ler is INIT,.# w
+000206a0: 6869 6368 2069 7320 636f 6d6d 6f6e 2066  hich is common f
+000206b0: 6f72 2073 696d 756c 7461 6e65 6f75 7320  or simultaneous 
+000206c0: 7079 7465 7374 2c20 7765 206e 6565 6420  pytest, we need 
+000206d0: 746f 2077 6169 7420 756e 7469 6c20 7468  to wait until th
+000206e0: 650a 2320 636f 6e74 726f 6c6c 6572 2069  e.# controller i
+000206f0: 7320 5550 2062 6566 6f72 6520 7765 2063  s UP before we c
+00020700: 616e 2074 6572 6d69 6e61 7465 2074 6865  an terminate the
+00020710: 2073 6572 7669 6365 2e0a 2320 5468 6520   service..# The 
+00020720: 7465 6172 646f 776e 2063 6f6d 6d61 6e64  teardown command
+00020730: 2068 6173 2061 2031 302d 6d69 6e73 2074   has a 10-mins t
+00020740: 696d 656f 7574 2c20 736f 2077 6520 646f  imeout, so we do
+00020750: 6e27 7420 6e65 6564 2074 6f20 646f 0a23  n't need to do.#
+00020760: 2074 6865 2074 696d 656f 7574 2068 6572   the timeout her
+00020770: 652e 2053 6565 2069 6d70 6c65 6d65 6e74  e. See implement
+00020780: 6174 696f 6e20 6f66 2072 756e 5f6f 6e65  ation of run_one
+00020790: 5f74 6573 7428 2920 666f 7220 6465 7461  _test() for deta
+000207a0: 696c 732e 0a5f 5445 4152 444f 574e 5f53  ils.._TEARDOWN_S
+000207b0: 4552 5649 4345 203d 2028 0a20 2020 2027  ERVICE = (.    '
+000207c0: 2866 6f72 2069 2069 6e20 6073 6571 2031  (for i in `seq 1
+000207d0: 2032 3060 3b20 646f 270a 2020 2020 2720   20`; do'.    ' 
+000207e0: 2020 2020 733d 2428 736b 7920 7365 7276      s=$(sky serv
+000207f0: 6520 646f 776e 202d 7920 7b6e 616d 657d  e down -y {name}
+00020800: 293b 270a 2020 2020 2720 2020 2020 6563  );'.    '     ec
+00020810: 686f 2022 5472 7969 6e67 2074 6f20 7465  ho "Trying to te
+00020820: 726d 696e 6174 6520 7b6e 616d 657d 223b  rminate {name}";
+00020830: 270a 2020 2020 2720 2020 2020 6563 686f  '.    '     echo
+00020840: 2022 2473 223b 270a 2020 2020 2720 2020   "$s";'.    '   
+00020850: 2020 6563 686f 2022 2473 2220 7c20 6772    echo "$s" | gr
+00020860: 6570 202d 7120 2273 6368 6564 756c 6564  ep -q "scheduled
+00020870: 2074 6f20 6265 2074 6572 6d69 6e61 7465   to be terminate
+00020880: 645c 7c4e 6f20 7365 7276 6963 6520 746f  d\|No service to
+00020890: 2074 6572 6d69 6e61 7465 2220 2626 2062   terminate" && b
+000208a0: 7265 616b 3b27 0a20 2020 2027 2020 2020  reak;'.    '    
+000208b0: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
+000208c0: 2720 2020 2020 5b20 2469 202d 6571 2032  '     [ $i -eq 2
+000208d0: 3020 5d20 2626 2065 6368 6f20 2246 6169  0 ] && echo "Fai
+000208e0: 6c65 6420 746f 2074 6572 6d69 6e61 7465  led to terminate
+000208f0: 2073 6572 7669 6365 207b 6e61 6d65 7d22   service {name}"
+00020900: 3b27 0a20 2020 2027 646f 6e65 2927 290a  ;'.    'done)').
+00020910: 0a5f 5345 5256 455f 454e 4450 4f49 4e54  ._SERVE_ENDPOINT
+00020920: 5f57 4149 5420 3d20 280a 2020 2020 2765  _WAIT = (.    'e
+00020930: 7870 6f72 7420 4f52 4947 494e 5f53 4b59  xport ORIGIN_SKY
+00020940: 5049 4c4f 545f 4445 4255 473d 2453 4b59  PILOT_DEBUG=$SKY
+00020950: 5049 4c4f 545f 4445 4255 473b 2065 7870  PILOT_DEBUG; exp
+00020960: 6f72 7420 534b 5950 494c 4f54 5f44 4542  ort SKYPILOT_DEB
+00020970: 5547 3d30 3b20 270a 2020 2020 2765 6e64  UG=0; '.    'end
+00020980: 706f 696e 743d 2428 736b 7920 7365 7276  point=$(sky serv
+00020990: 6520 7374 6174 7573 202d 2d65 6e64 706f  e status --endpo
+000209a0: 696e 7420 7b6e 616d 657d 293b 2027 0a20  int {name}); '. 
+000209b0: 2020 2027 756e 7469 6c20 2120 6563 686f     'until ! echo
+000209c0: 2022 2465 6e64 706f 696e 7422 207c 2067   "$endpoint" | g
+000209d0: 7265 7020 2243 6f6e 7472 6f6c 6c65 7220  rep "Controller 
+000209e0: 6973 2069 6e69 7469 616c 697a 696e 6722  is initializing"
+000209f0: 3b20 270a 2020 2020 2764 6f20 6563 686f  ; '.    'do echo
+00020a00: 2022 5761 6974 696e 6720 666f 7220 7365   "Waiting for se
+00020a10: 7276 6520 656e 6470 6f69 6e74 2074 6f20  rve endpoint to 
+00020a20: 6265 2072 6561 6479 2e2e 2e22 3b20 270a  be ready..."; '.
+00020a30: 2020 2020 2773 6c65 6570 2035 3b20 656e      'sleep 5; en
+00020a40: 6470 6f69 6e74 3d24 2873 6b79 2073 6572  dpoint=$(sky ser
+00020a50: 7665 2073 7461 7475 7320 2d2d 656e 6470  ve status --endp
+00020a60: 6f69 6e74 207b 6e61 6d65 7d29 3b20 646f  oint {name}); do
+00020a70: 6e65 3b20 270a 2020 2020 2765 7870 6f72  ne; '.    'expor
+00020a80: 7420 534b 5950 494c 4f54 5f44 4542 5547  t SKYPILOT_DEBUG
+00020a90: 3d24 4f52 4947 494e 5f53 4b59 5049 4c4f  =$ORIGIN_SKYPILO
+00020aa0: 545f 4445 4255 473b 2065 6368 6f20 2224  T_DEBUG; echo "$
+00020ab0: 656e 6470 6f69 6e74 2227 290a 0a5f 5345  endpoint"').._SE
+00020ac0: 5256 455f 5354 4154 5553 5f57 4149 5420  RVE_STATUS_WAIT 
+00020ad0: 3d20 2827 733d 2428 736b 7920 7365 7276  = ('s=$(sky serv
+00020ae0: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+00020af0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00020b00: 2020 2020 2020 2020 2020 2775 6e74 696c            'until
+00020b10: 2021 2065 6368 6f20 2224 7322 207c 2067   ! echo "$s" | g
+00020b20: 7265 7020 2243 6f6e 7472 6f6c 6c65 7220  rep "Controller 
+00020b30: 6973 2069 6e69 7469 616c 697a 696e 672e  is initializing.
+00020b40: 223b 2027 0a20 2020 2020 2020 2020 2020  "; '.           
+00020b50: 2020 2020 2020 2020 2020 2027 646f 2065             'do e
+00020b60: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
+00020b70: 2073 6572 7665 2073 7461 7475 7320 746f   serve status to
+00020b80: 2062 6520 7265 6164 792e 2e2e 223b 2027   be ready..."; '
+00020b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020ba0: 2020 2020 2020 2027 736c 6565 7020 353b         'sleep 5;
+00020bb0: 2073 3d24 2873 6b79 2073 6572 7665 2073   s=$(sky serve s
+00020bc0: 7461 7475 7320 7b6e 616d 657d 293b 2064  tatus {name}); d
+00020bd0: 6f6e 653b 2065 6368 6f20 2224 7322 2729  one; echo "$s"')
+00020be0: 0a0a 0a64 6566 205f 6765 745f 7265 706c  ...def _get_repl
+00020bf0: 6963 615f 6970 286e 616d 653a 2073 7472  ica_ip(name: str
+00020c00: 2c20 7265 706c 6963 615f 6964 3a20 696e  , replica_id: in
+00020c10: 7429 202d 3e20 7374 723a 0a20 2020 2072  t) -> str:.    r
+00020c20: 6574 7572 6e20 2866 2769 707b 7265 706c  eturn (f'ip{repl
+00020c30: 6963 615f 6964 7d3d 2428 6563 686f 2022  ica_id}=$(echo "
+00020c40: 2473 2220 7c20 270a 2020 2020 2020 2020  $s" | '.        
+00020c50: 2020 2020 6627 6177 6b20 227b 5f41 574b      f'awk "{_AWK
+00020c60: 5f41 4c4c 5f4c 494e 4553 5f42 454c 4f57  _ALL_LINES_BELOW
+00020c70: 5f52 4550 4c49 4341 537d 2220 7c20 270a  _REPLICAS}" | '.
+00020c80: 2020 2020 2020 2020 2020 2020 6627 6772              f'gr
+00020c90: 6570 202d 4520 227b 6e61 6d65 7d5c 732b  ep -E "{name}\s+
+00020ca0: 7b72 6570 6c69 6361 5f69 647d 2220 7c20  {replica_id}" | 
+00020cb0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00020cc0: 6772 6570 202d 456f 2022 7b5f 4950 5f52  grep -Eo "{_IP_R
+00020cd0: 4547 4558 7d22 2927 290a 0a0a 6465 6620  EGEX}")')...def 
+00020ce0: 5f67 6574 5f73 6b79 7365 7276 655f 6874  _get_skyserve_ht
+00020cf0: 7470 5f74 6573 7428 6e61 6d65 3a20 7374  tp_test(name: st
+00020d00: 722c 2063 6c6f 7564 3a20 7374 722c 0a20  r, cloud: str,. 
+00020d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d20: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+00020d30: 7574 5f6d 696e 7574 6573 3a20 696e 7429  ut_minutes: int)
+00020d40: 202d 3e20 5465 7374 3a0a 2020 2020 7465   -> Test:.    te
+00020d50: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00020d60: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
+00020d70: 7665 2d7b 636c 6f75 642e 7265 706c 6163  ve-{cloud.replac
+00020d80: 6528 225f 222c 2022 2d22 297d 272c 0a20  e("_", "-")}',. 
+00020d90: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00020da0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00020db0: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d79   up -n {name} -y
+00020dc0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00020dd0: 6874 7470 2f7b 636c 6f75 647d 2e79 616d  http/{cloud}.yam
+00020de0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00020df0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00020e00: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00020e10: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00020e20: 615f 6e75 6d3d 3229 2c0a 2020 2020 2020  a_num=2),.      
+00020e30: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00020e40: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00020e50: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00020e60: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00020e70: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
+00020e80: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00020e90: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00020ea0: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
+00020eb0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00020ec0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00020ed0: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00020ee0: 2020 2020 2020 2074 696d 656f 7574 3d74         timeout=t
+00020ef0: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+00020f00: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00020f10: 6574 7572 6e20 7465 7374 0a0a 0a64 6566  eturn test...def
+00020f20: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00020f30: 696e 5f73 7461 7475 7328 6e61 6d65 3a20  in_status(name: 
+00020f40: 7374 722c 2063 6865 636b 5f74 7570 6c65  str, check_tuple
+00020f50: 733a 204c 6973 745b 5475 706c 655b 696e  s: List[Tuple[in
+00020f60: 742c 2062 6f6f 6c2c 0a20 2020 2020 2020  t, bool,.       
 00020f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f80: 2020 2020 2020 7374 725d 5d29 202d 3e20        str]]) -> 
-00020f90: 7374 723a 0a20 2020 2022 2222 4368 6563  str:.    """Chec
-00020fa0: 6b20 7265 706c 6963 6173 2720 7374 6174  k replicas' stat
-00020fb0: 7573 2061 6e64 2063 6f75 6e74 2069 6e20  us and count in 
-00020fc0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00020fd0: 0a0a 2020 2020 5765 2077 696c 6c20 6368  ..    We will ch
-00020fe0: 6563 6b20 7643 5055 3d32 2c20 6173 2061  eck vCPU=2, as a
-00020ff0: 6c6c 206f 7572 2074 6573 7473 2075 7365  ll our tests use
-00021000: 2076 4350 553d 322e 0a20 2020 200a 2020   vCPU=2..    .  
-00021010: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00021020: 6e61 6d65 3a20 7468 6520 6e61 6d65 206f  name: the name o
-00021030: 6620 7468 6520 7365 7276 6963 650a 2020  f the service.  
-00021040: 2020 2020 2020 6368 6563 6b5f 7475 706c        check_tupl
-00021050: 6573 3a20 4120 6c69 7374 206f 6620 7265  es: A list of re
-00021060: 706c 6963 6120 7072 6f70 6572 7479 2074  plica property t
-00021070: 6f20 6368 6563 6b2e 2045 6163 6820 7475  o check. Each tu
-00021080: 706c 6520 6973 0a20 2020 2020 2020 2020  ple is.         
-00021090: 2020 2028 636f 756e 742c 2069 735f 7370     (count, is_sp
-000210a0: 6f74 2c20 7374 6174 7573 290a 2020 2020  ot, status).    
-000210b0: 2222 220a 2020 2020 6368 6563 6b5f 636d  """.    check_cm
-000210c0: 6420 3d20 2727 0a20 2020 2066 6f72 2063  d = ''.    for c
-000210d0: 6865 636b 5f74 7570 6c65 2069 6e20 6368  heck_tuple in ch
-000210e0: 6563 6b5f 7475 706c 6573 3a0a 2020 2020  eck_tuples:.    
-000210f0: 2020 2020 636f 756e 742c 2069 735f 7370      count, is_sp
-00021100: 6f74 2c20 7374 6174 7573 203d 2063 6865  ot, status = che
-00021110: 636b 5f74 7570 6c65 0a20 2020 2020 2020  ck_tuple.       
-00021120: 2072 6573 6f75 7263 655f 7374 7220 3d20   resource_str = 
-00021130: 2727 0a20 2020 2020 2020 2069 6620 7374  ''.        if st
-00021140: 6174 7573 206e 6f74 2069 6e20 5b27 5045  atus not in ['PE
-00021150: 4e44 494e 4727 2c20 2753 4855 5454 494e  NDING', 'SHUTTIN
-00021160: 475f 444f 574e 270a 2020 2020 2020 2020  G_DOWN'.        
-00021170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021180: 205d 2061 6e64 206e 6f74 2073 7461 7475   ] and not statu
-00021190: 732e 7374 6172 7473 7769 7468 2827 4641  s.startswith('FA
-000211a0: 494c 4544 2729 3a0a 2020 2020 2020 2020  ILED'):.        
-000211b0: 2020 2020 7370 6f74 5f73 7472 203d 2027      spot_str = '
-000211c0: 270a 2020 2020 2020 2020 2020 2020 6966  '.            if
-000211d0: 2069 735f 7370 6f74 3a0a 2020 2020 2020   is_spot:.      
-000211e0: 2020 2020 2020 2020 2020 7370 6f74 5f73            spot_s
-000211f0: 7472 203d 2027 5c5b 5370 6f74 5c5d 270a  tr = '\[Spot\]'.
-00021200: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-00021210: 7572 6365 5f73 7472 203d 2066 2728 7b73  urce_str = f'({s
-00021220: 706f 745f 7374 727d 7643 5055 3d32 2927  pot_str}vCPU=2)'
-00021230: 0a20 2020 2020 2020 2063 6865 636b 5f63  .        check_c
-00021240: 6d64 202b 3d20 2866 2720 6563 686f 2022  md += (f' echo "
-00021250: 2473 2220 7c20 6772 6570 2022 7b72 6573  $s" | grep "{res
-00021260: 6f75 7263 655f 7374 727d 2220 7c20 270a  ource_str}" | '.
-00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021280: 2020 2020 2020 6627 6772 6570 2022 7b73        f'grep "{s
-00021290: 7461 7475 737d 2220 7c20 7763 202d 6c20  tatus}" | wc -l 
-000212a0: 7c20 6772 6570 207b 636f 756e 747d 207c  | grep {count} |
-000212b0: 7c20 6578 6974 2031 3b27 290a 2020 2020  | exit 1;').    
-000212c0: 7265 7475 726e 2028 6627 7b5f 5345 5256  return (f'{_SERV
-000212d0: 455f 5354 4154 5553 5f57 4149 542e 666f  E_STATUS_WAIT.fo
-000212e0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-000212f0: 3b20 6563 686f 2022 2473 223b 2027 202b  ; echo "$s"; ' +
-00021300: 2063 6865 636b 5f63 6d64 290a 0a0a 6465   check_cmd)...de
-00021310: 6620 5f63 6865 636b 5f73 6572 7669 6365  f _check_service
-00021320: 5f76 6572 7369 6f6e 2873 6572 7669 6365  _version(service
-00021330: 5f6e 616d 653a 2073 7472 2c20 7665 7273  _name: str, vers
-00021340: 696f 6e3a 2073 7472 2920 2d3e 2073 7472  ion: str) -> str
-00021350: 3a0a 2020 2020 2320 4772 6570 2074 6865  :.    # Grep the
-00021360: 206c 696e 6573 2062 6566 6f72 6520 2753   lines before 'S
-00021370: 6572 7669 6365 2052 6570 6c69 6361 7327  ervice Replicas'
-00021380: 2061 6e64 2063 6865 636b 2069 6620 7468   and check if th
-00021390: 6520 7365 7276 6963 6520 7665 7273 696f  e service versio
-000213a0: 6e0a 2020 2020 2320 6973 2063 6f72 7265  n.    # is corre
-000213b0: 6374 2e0a 2020 2020 7265 7475 726e 2028  ct..    return (
-000213c0: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
-000213d0: 6570 202d 4231 3030 3020 2253 6572 7669  ep -B1000 "Servi
-000213e0: 6365 2052 6570 6c69 6361 7322 207c 2027  ce Replicas" | '
-000213f0: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
-00021400: 7265 7020 2d45 2022 7b73 6572 7669 6365  rep -E "{service
-00021410: 5f6e 616d 657d 5c73 2b7b 7665 7273 696f  _name}\s+{versio
-00021420: 6e7d 2220 7c7c 2065 7869 7420 313b 2027  n}" || exit 1; '
-00021430: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00021440: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
-00021450: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
-00021460: 5f73 6b79 7365 7276 655f 6763 705f 6874  _skyserve_gcp_ht
-00021470: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
-00021480: 7420 736b 7973 6572 7665 206f 6e20 4743  t skyserve on GC
-00021490: 5022 2222 0a20 2020 206e 616d 6520 3d20  P""".    name = 
-000214a0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-000214b0: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-000214c0: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-000214d0: 705f 7465 7374 286e 616d 652c 2027 6763  p_test(name, 'gc
-000214e0: 7027 2c20 3230 290a 2020 2020 7275 6e5f  p', 20).    run_
-000214f0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00021500: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00021510: 730a 4070 7974 6573 742e 6d61 726b 2e73  s.@pytest.mark.s
-00021520: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
-00021530: 7973 6572 7665 5f61 7773 5f68 7474 7028  yserve_aws_http(
-00021540: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-00021550: 6b79 7365 7276 6520 6f6e 2041 5753 2222  kyserve on AWS""
-00021560: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-00021570: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-00021580: 0a20 2020 2074 6573 7420 3d20 5f67 6574  .    test = _get
-00021590: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
-000215a0: 6573 7428 6e61 6d65 2c20 2761 7773 272c  est(name, 'aws',
-000215b0: 2032 3029 0a20 2020 2072 756e 5f6f 6e65   20).    run_one
-000215c0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000215d0: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
-000215e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-000215f0: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-00021600: 7365 7276 655f 617a 7572 655f 6874 7470  serve_azure_http
-00021610: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
-00021620: 736b 7973 6572 7665 206f 6e20 417a 7572  skyserve on Azur
-00021630: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
-00021640: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00021650: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-00021660: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-00021670: 705f 7465 7374 286e 616d 652c 2027 617a  p_test(name, 'az
-00021680: 7572 6527 2c20 3330 290a 2020 2020 7275  ure', 30).    ru
-00021690: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000216a0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000216b0: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
-000216c0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-000216d0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-000216e0: 7665 5f6c 6c6d 2867 656e 6572 6963 5f63  ve_llm(generic_c
-000216f0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00021700: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-00021710: 2077 6974 6820 7265 616c 204c 4c4d 2075   with real LLM u
-00021720: 7365 6361 7365 2222 220a 2020 2020 6e61  secase""".    na
-00021730: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00021740: 655f 6e61 6d65 2829 0a0a 2020 2020 6465  e_name()..    de
-00021750: 6620 6765 6e65 7261 7465 5f6c 6c6d 5f74  f generate_llm_t
-00021760: 6573 745f 636f 6d6d 616e 6428 7072 6f6d  est_command(prom
-00021770: 7074 3a20 7374 722c 2065 7870 6563 7465  pt: str, expecte
-00021780: 645f 6f75 7470 7574 3a20 7374 7229 202d  d_output: str) -
-00021790: 3e20 7374 723a 0a20 2020 2020 2020 2070  > str:.        p
-000217a0: 726f 6d70 7420 3d20 7368 6c65 782e 7175  rompt = shlex.qu
-000217b0: 6f74 6528 7072 6f6d 7074 290a 2020 2020  ote(prompt).    
-000217c0: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
-000217d0: 7075 7420 3d20 7368 6c65 782e 7175 6f74  put = shlex.quot
-000217e0: 6528 6578 7065 6374 6564 5f6f 7574 7075  e(expected_outpu
-000217f0: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
-00021800: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
-00021810: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
-00021820: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
-00021830: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-00021840: 2020 2020 2020 2020 2020 2770 7974 686f            'pytho
-00021850: 6e20 7465 7374 732f 736b 7973 6572 7665  n tests/skyserve
-00021860: 2f6c 6c6d 2f67 6574 5f72 6573 706f 6e73  /llm/get_respons
-00021870: 652e 7079 202d 2d65 6e64 706f 696e 7420  e.py --endpoint 
-00021880: 2465 6e64 706f 696e 7420 270a 2020 2020  $endpoint '.    
-00021890: 2020 2020 2020 2020 6627 2d2d 7072 6f6d          f'--prom
-000218a0: 7074 207b 7072 6f6d 7074 7d20 7c20 6772  pt {prompt} | gr
-000218b0: 6570 207b 6578 7065 6374 6564 5f6f 7574  ep {expected_out
-000218c0: 7075 747d 2729 0a0a 2020 2020 7769 7468  put}')..    with
-000218d0: 206f 7065 6e28 2774 6573 7473 2f73 6b79   open('tests/sky
-000218e0: 7365 7276 652f 6c6c 6d2f 7072 6f6d 7074  serve/llm/prompt
-000218f0: 5f6f 7574 7075 742e 6a73 6f6e 272c 2027  _output.json', '
-00021900: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
-00021910: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
-00021920: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
-00021930: 2020 7072 6f6d 7074 326f 7574 7075 7420    prompt2output 
-00021940: 3d20 6a73 6f6e 2e6c 6f61 6428 6629 0a0a  = json.load(f)..
-00021950: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00021960: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
-00021970: 736b 7973 6572 7665 2d6c 6c6d 272c 0a20  skyserve-llm',. 
-00021980: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00021990: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-000219a0: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
-000219b0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-000219c0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-000219d0: 6b79 7365 7276 652f 6c6c 6d2f 7365 7276  kyserve/llm/serv
-000219e0: 6963 652e 7961 6d6c 272c 0a20 2020 2020  ice.yaml',.     
-000219f0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
-00021a00: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
-00021a10: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
-00021a20: 2072 6570 6c69 6361 5f6e 756d 3d31 292c   replica_num=1),
-00021a30: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
-00021a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a50: 6765 6e65 7261 7465 5f6c 6c6d 5f74 6573  generate_llm_tes
-00021a60: 745f 636f 6d6d 616e 6428 7072 6f6d 7074  t_command(prompt
-00021a70: 2c20 6f75 7470 7574 290a 2020 2020 2020  , output).      
-00021a80: 2020 2020 2020 2020 2020 666f 7220 7072            for pr
-00021a90: 6f6d 7074 2c20 6f75 7470 7574 2069 6e20  ompt, output in 
-00021aa0: 7072 6f6d 7074 326f 7574 7075 742e 6974  prompt2output.it
-00021ab0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-00021ac0: 2020 5d2c 0a20 2020 2020 2020 205d 2c0a    ],.        ],.
-00021ad0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-00021ae0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-00021af0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-00021b00: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-00021b10: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00021b20: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00021b30: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00021b40: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00021b50: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00021b60: 745f 736b 7973 6572 7665 5f73 706f 745f  t_skyserve_spot_
-00021b70: 7265 636f 7665 7279 2829 3a0a 2020 2020  recovery():.    
-00021b80: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-00021b90: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
-00021ba0: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
-00021bb0: 6c31 2d61 270a 0a20 2020 2074 6573 7420  l1-a'..    test 
-00021bc0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00021bd0: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-00021be0: 7370 6f74 2d72 6563 6f76 6572 792d 6763  spot-recovery-gc
-00021bf0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-00021c00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00021c10: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00021c20: 657d 202d 7920 7465 7374 732f 736b 7973  e} -y tests/skys
-00021c30: 6572 7665 2f73 706f 742f 7265 636f 7665  erve/spot/recove
-00021c40: 7279 2e79 616d 6c27 2c0a 2020 2020 2020  ry.yaml',.      
-00021c50: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00021c60: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00021c70: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00021c80: 7265 706c 6963 615f 6e75 6d3d 3129 2c0a  replica_num=1),.
-00021c90: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00021ca0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00021cb0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00021cc0: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00021cd0: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
-00021ce0: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00021cf0: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-00021d00: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
-00021d10: 2020 2020 2020 2020 205f 7465 726d 696e           _termin
-00021d20: 6174 655f 6763 705f 7265 706c 6963 6128  ate_gcp_replica(
-00021d30: 6e61 6d65 2c20 7a6f 6e65 2c20 3129 2c0a  name, zone, 1),.
-00021d40: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-00021d50: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-00021d60: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-00021d70: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00021d80: 6d3d 3129 2c0a 2020 2020 2020 2020 2020  m=1),.          
-00021d90: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00021da0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00021db0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00021dc0: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
-00021dd0: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00021de0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00021df0: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00021e00: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00021e10: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00021e20: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00021e30: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00021e40: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00021e50: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00021e60: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00021e70: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00021e80: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
-00021e90: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00021ea0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-00021eb0: 7665 5f62 6173 655f 6f6e 6465 6d61 6e64  ve_base_ondemand
-00021ec0: 5f66 616c 6c62 6163 6b28 6765 6e65 7269  _fallback(generi
-00021ed0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00021ee0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00021ef0: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00021f00: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00021f10: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
-00021f20: 7973 6572 7665 2d62 6173 652d 6f6e 6465  yserve-base-onde
-00021f30: 6d61 6e64 2d66 616c 6c62 6163 6b27 2c0a  mand-fallback',.
-00021f40: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00021f50: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00021f60: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
-00021f70: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00021f80: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
-00021f90: 736b 7973 6572 7665 2f73 706f 742f 6261  skyserve/spot/ba
-00021fa0: 7365 5f6f 6e64 656d 616e 645f 6661 6c6c  se_ondemand_fall
-00021fb0: 6261 636b 2e79 616d 6c27 2c0a 2020 2020  back.yaml',.    
-00021fc0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00021fd0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00021fe0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00021ff0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-00022000: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
-00022010: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-00022020: 7374 6174 7573 286e 616d 652c 205b 2831  status(name, [(1
-00022030: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
-00022040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00022050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022060: 2020 2020 2020 2020 2020 2020 2020 2831                (1
-00022070: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
-00022080: 295d 292c 0a20 2020 2020 2020 205d 2c0a  )]),.        ],.
-00022090: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-000220a0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-000220b0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-000220c0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-000220d0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-000220e0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000220f0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00022100: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00022110: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00022120: 745f 736b 7973 6572 7665 5f64 796e 616d  t_skyserve_dynam
-00022130: 6963 5f6f 6e64 656d 616e 645f 6661 6c6c  ic_ondemand_fall
-00022140: 6261 636b 2829 3a0a 2020 2020 6e61 6d65  back():.    name
-00022150: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-00022160: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
-00022170: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
-00022180: 270a 0a20 2020 2074 6573 7420 3d20 5465  '..    test = Te
-00022190: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
-000221a0: 7374 2d73 6b79 7365 7276 652d 6479 6e61  st-skyserve-dyna
-000221b0: 6d69 632d 6f6e 6465 6d61 6e64 2d66 616c  mic-ondemand-fal
-000221c0: 6c62 6163 6b27 2c0a 2020 2020 2020 2020  lback',.        
-000221d0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-000221e0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-000221f0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00022200: 6370 202d 7920 7465 7374 732f 736b 7973  cp -y tests/skys
-00022210: 6572 7665 2f73 706f 742f 6479 6e61 6d69  erve/spot/dynami
-00022220: 635f 6f6e 6465 6d61 6e64 5f66 616c 6c62  c_ondemand_fallb
-00022230: 6163 6b2e 7961 6d6c 272c 0a20 2020 2020  ack.yaml',.     
-00022240: 2020 2020 2020 2066 2773 6c65 6570 2034         f'sleep 4
-00022250: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00022260: 2320 3220 6f6e 2d64 656d 616e 6420 2870  # 2 on-demand (p
-00022270: 726f 7669 7369 6f6e 696e 6729 202b 2032  rovisioning) + 2
-00022280: 2053 706f 7420 2870 726f 7669 7369 6f6e   Spot (provision
-00022290: 696e 6729 2e0a 2020 2020 2020 2020 2020  ing)..          
-000222a0: 2020 6627 7b5f 5345 5256 455f 5354 4154    f'{_SERVE_STAT
-000222b0: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
-000222c0: 616d 653d 6e61 6d65 297d 3b20 6563 686f  ame=name)}; echo
-000222d0: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
-000222e0: 2020 2020 2765 6368 6f20 2224 7322 207c      'echo "$s" |
-000222f0: 2067 7265 7020 2d71 2022 302f 3422 207c   grep -q "0/4" |
-00022300: 7c20 6578 6974 2031 272c 0a20 2020 2020  | exit 1',.     
-00022310: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
-00022320: 7220 7468 6520 7072 6f76 6973 696f 6e69  r the provisioni
-00022330: 6e67 2073 7461 7274 730a 2020 2020 2020  ng starts.      
-00022340: 2020 2020 2020 6627 736c 6565 7020 3430        f'sleep 40
-00022350: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00022360: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00022370: 5f73 7461 7475 7328 6e61 6d65 2c20 5b0a  _status(name, [.
-00022380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022390: 2832 2c20 5472 7565 2c20 5f53 4552 5649  (2, True, _SERVI
-000223a0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-000223b0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
-000223c0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
-000223d0: 2020 2020 2020 2020 2832 2c20 4661 6c73          (2, Fals
-000223e0: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
-000223f0: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
-00022400: 4558 202b 2027 5c7c 5348 5554 5449 4e47  EX + '\|SHUTTING
-00022410: 5f44 4f57 4e27 290a 2020 2020 2020 2020  _DOWN').        
-00022420: 2020 2020 5d29 2c0a 0a20 2020 2020 2020      ]),..       
-00022430: 2020 2020 2023 2057 6169 7420 756e 7469       # Wait unti
-00022440: 6c20 3220 7370 6f74 2069 6e73 7461 6e63  l 2 spot instanc
-00022450: 6573 2061 7265 2072 6561 6479 2e0a 2020  es are ready..  
-00022460: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00022470: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00022480: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00022490: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-000224a0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
-000224b0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-000224c0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-000224d0: 2832 2c20 5472 7565 2c20 2752 4541 4459  (2, True, 'READY
-000224e0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000224f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022510: 2830 2c20 4661 6c73 652c 2027 2729 5d29  (0, False, '')])
-00022520: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
-00022530: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
-00022540: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
-00022550: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
-00022560: 2066 2773 6c65 6570 2034 3027 2c0a 2020   f'sleep 40',.  
-00022570: 2020 2020 2020 2020 2020 2320 3120 6f6e            # 1 on
-00022580: 2d64 656d 616e 6420 2870 726f 7669 7369  -demand (provisi
-00022590: 6f6e 696e 6729 202b 2031 2053 706f 7420  oning) + 1 Spot 
-000225a0: 2872 6561 6479 2920 2b20 3120 7370 6f74  (ready) + 1 spot
-000225b0: 2028 7072 6f76 6973 696f 6e69 6e67 292e   (provisioning).
-000225c0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000225d0: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
-000225e0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
-000225f0: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
-00022600: 2020 2020 2027 6563 686f 2022 2473 2220       'echo "$s" 
-00022610: 7c20 6772 6570 202d 7120 2231 2f33 2227  | grep -q "1/3"'
-00022620: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
-00022630: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-00022640: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
-00022650: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
-00022660: 312c 2054 7275 652c 2027 5245 4144 5927  1, True, 'READY'
-00022670: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00022680: 2020 2020 2020 2020 2020 2831 2c20 5472            (1, Tr
-00022690: 7565 2c20 5f53 4552 5649 4345 5f4c 4155  ue, _SERVICE_LAU
-000226a0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
-000226b0: 4745 5829 2c0a 2020 2020 2020 2020 2020  GEX),.          
-000226c0: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
-000226d0: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
-000226e0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-000226f0: 535f 5245 4745 5829 5d29 2c0a 0a20 2020  S_REGEX)]),..   
-00022700: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-00022710: 756e 7469 6c20 3220 7370 6f74 2069 6e73  until 2 spot ins
-00022720: 7461 6e63 6573 2061 7265 2072 6561 6479  tances are ready
-00022730: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
-00022740: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-00022750: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-00022760: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-00022770: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
-00022780: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
-00022790: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-000227a0: 652c 205b 2832 2c20 5472 7565 2c20 2752  e, [(2, True, 'R
-000227b0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
-000227c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000227e0: 2020 2020 2830 2c20 4661 6c73 652c 2027      (0, False, '
-000227f0: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
-00022800: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00022810: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00022820: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00022830: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00022840: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00022850: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00022860: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00022870: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00022880: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00022890: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-000228a0: 7365 7276 655f 7573 6572 5f62 7567 5f72  serve_user_bug_r
-000228b0: 6573 7461 7274 2867 656e 6572 6963 5f63  estart(generic_c
-000228c0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-000228d0: 2222 2254 6573 7473 2074 6861 7420 7765  """Tests that we
-000228e0: 2072 6573 7461 7274 2074 6865 2073 6572   restart the ser
-000228f0: 7669 6365 2061 6674 6572 2075 7365 7220  vice after user 
-00022900: 6275 672e 2222 220a 2020 2020 2320 544f  bug.""".    # TO
-00022910: 444f 287a 6877 7529 3a20 7468 6973 2062  DO(zhwu): this b
-00022920: 6568 6176 696f 7220 6e65 6564 7320 736f  ehavior needs so
-00022930: 6d65 2072 6574 6869 6e6b 696e 672e 0a20  me rethinking.. 
-00022940: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
-00022950: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
-00022960: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00022970: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
-00022980: 7973 6572 7665 2d75 7365 722d 6275 672d  yserve-user-bug-
-00022990: 7265 7374 6172 7427 2c0a 2020 2020 2020  restart',.      
-000229a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-000229b0: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-000229c0: 6e20 7b6e 616d 657d 202d 2d63 6c6f 7564  n {name} --cloud
-000229d0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-000229e0: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-000229f0: 7665 2f72 6573 7461 7274 2f75 7365 725f  ve/restart/user_
-00022a00: 6275 672e 7961 6d6c 272c 0a20 2020 2020  bug.yaml',.     
-00022a10: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00022a20: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
-00022a30: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-00022a40: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
-00022a50: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
-00022a60: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
-00022a70: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
-00022a80: 207c 2067 7265 7020 2253 4855 5454 494e   | grep "SHUTTIN
-00022a90: 475f 444f 574e 223b 2027 0a20 2020 2020  G_DOWN"; '.     
-00022aa0: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
-00022ab0: 2257 6169 7469 6e67 2066 6f72 2066 6972  "Waiting for fir
-00022ac0: 7374 2073 6572 7669 6365 2074 6f20 6265  st service to be
-00022ad0: 2053 4855 5454 494e 4720 444f 574e 2e2e   SHUTTING DOWN..
-00022ae0: 2e22 3b20 270a 2020 2020 2020 2020 2020  ."; '.          
-00022af0: 2020 6627 736c 6565 7020 353b 2073 3d24    f'sleep 5; s=$
-00022b00: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00022b10: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
-00022b20: 2224 7322 3b20 646f 6e65 3b20 272c 0a20  "$s"; done; ',. 
-00022b30: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00022b40: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00022b50: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
-00022b60: 2224 7322 3b27 0a20 2020 2020 2020 2020  "$s";'.         
-00022b70: 2020 2027 756e 7469 6c20 6563 686f 2022     'until echo "
-00022b80: 2473 2220 7c20 6772 6570 202d 4120 3130  $s" | grep -A 10
-00022b90: 3020 2253 6572 7669 6365 2052 6570 6c69  0 "Service Repli
-00022ba0: 6361 7322 207c 2067 7265 7020 2246 4149  cas" | grep "FAI
-00022bb0: 4c45 4422 3b20 270a 2020 2020 2020 2020  LED"; '.        
-00022bc0: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
-00022bd0: 6974 696e 6720 666f 7220 6669 7273 7420  iting for first 
-00022be0: 7365 7276 6963 6520 746f 2062 6520 4641  service to be FA
-00022bf0: 494c 4544 2e2e 2e22 3b20 270a 2020 2020  ILED..."; '.    
-00022c00: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-00022c10: 353b 2073 3d24 2873 6b79 2073 6572 7665  5; s=$(sky serve
-00022c20: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00022c30: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
-00022c40: 3b20 6563 686f 2022 2473 223b 2027 0a20  ; echo "$s"; '. 
-00022c50: 2020 2020 2020 2020 2020 202b 205f 6368             + _ch
-00022c60: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00022c70: 7461 7475 7328 6e61 6d65 2c20 5b28 312c  tatus(name, [(1,
-00022c80: 2054 7275 652c 2027 4641 494c 4544 2729   True, 'FAILED')
-00022c90: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
-00022ca0: 2023 2055 7365 7220 6275 6720 6661 696c   # User bug fail
-00022cb0: 7572 6520 7769 6c6c 2063 6175 7365 206e  ure will cause n
-00022cc0: 6f20 6675 7274 6865 7220 7363 616c 696e  o further scalin
-00022cd0: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
-00022ce0: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
-00022cf0: 7020 2d41 2031 3030 2022 5365 7276 6963  p -A 100 "Servic
-00022d00: 6520 5265 706c 6963 6173 2220 7c20 6772  e Replicas" | gr
-00022d10: 6570 2022 7b6e 616d 657d 2220 7c20 7763  ep "{name}" | wc
-00022d20: 202d 6c20 7c20 6772 6570 2031 3b20 270a   -l | grep 1; '.
-00022d30: 2020 2020 2020 2020 2020 2020 6627 6563              f'ec
-00022d40: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
-00022d50: 4220 3130 3020 224e 4f5f 5245 504c 4943  B 100 "NO_REPLIC
-00022d60: 4122 207c 2067 7265 7020 2230 2f30 2227  A" | grep "0/0"'
-00022d70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00022d80: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
-00022d90: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00022da0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00022db0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00022dc0: 652f 6175 746f 5f72 6573 7461 7274 2e79  e/auto_restart.y
-00022dd0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00022de0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00022df0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00022e00: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00022e10: 2020 2020 2020 2020 2020 2020 2775 6e74              'unt
-00022e20: 696c 2063 7572 6c20 2d4c 2068 7474 703a  il curl -L http:
-00022e30: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00022e40: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00022e50: 2068 6572 6521 223b 2064 6f20 736c 6565   here!"; do slee
-00022e60: 7020 323b 2064 6f6e 653b 2073 6c65 6570  p 2; done; sleep
-00022e70: 2032 3b20 270a 2020 2020 2020 2020 2020   2; '.          
-00022e80: 2020 2b20 5f63 6865 636b 5f72 6570 6c69    + _check_repli
-00022e90: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-00022ea0: 652c 205b 2831 2c20 4661 6c73 652c 2027  e, [(1, False, '
-00022eb0: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
-00022ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ee0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
-00022ef0: 2c20 2746 4149 4c45 4427 295d 292c 0a20  , 'FAILED')]),. 
-00022f00: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00022f10: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-00022f20: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-00022f30: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00022f40: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00022f50: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00022f60: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00022f70: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
-00022f80: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
-00022f90: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
-00022fa0: 2074 6573 745f 736b 7973 6572 7665 5f6c   test_skyserve_l
-00022fb0: 6f61 645f 6261 6c61 6e63 6572 2867 656e  oad_balancer(gen
-00022fc0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00022fd0: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-00022fe0: 7973 6572 7665 206c 6f61 6420 6261 6c61  yserve load bala
-00022ff0: 6e63 6572 2072 6f75 6e64 2d72 6f62 696e  ncer round-robin
-00023000: 2070 6f6c 6963 7922 2222 0a20 2020 206e   policy""".    n
-00023010: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-00023020: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
-00023030: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00023040: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00023050: 7665 2d6c 6f61 642d 6261 6c61 6e63 6572  ve-load-balancer
-00023060: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00023070: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00023080: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
-00023090: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-000230a0: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
-000230b0: 7473 2f73 6b79 7365 7276 652f 6c6f 6164  ts/skyserve/load
-000230c0: 5f62 616c 616e 6365 722f 7365 7276 6963  _balancer/servic
-000230d0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-000230e0: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-000230f0: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-00023100: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-00023110: 6570 6c69 6361 5f6e 756d 3d33 292c 0a20  eplica_num=3),. 
-00023120: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00023130: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
-00023140: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
-00023150: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
-00023160: 2020 2020 2066 277b 5f53 4552 5645 5f53       f'{_SERVE_S
-00023170: 5441 5455 535f 5741 4954 2e66 6f72 6d61  TATUS_WAIT.forma
-00023180: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
-00023190: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000231a0: 5f67 6574 5f72 6570 6c69 6361 5f69 7028  _get_replica_ip(
-000231b0: 6e61 6d65 2c20 3129 7d3b 2027 0a20 2020  name, 1)}; '.   
-000231c0: 2020 2020 2020 2020 2066 277b 5f67 6574           f'{_get
-000231d0: 5f72 6570 6c69 6361 5f69 7028 6e61 6d65  _replica_ip(name
-000231e0: 2c20 3229 7d3b 207b 5f67 6574 5f72 6570  , 2)}; {_get_rep
-000231f0: 6c69 6361 5f69 7028 6e61 6d65 2c20 3329  lica_ip(name, 3)
-00023200: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-00023210: 2027 7079 7468 6f6e 2074 6573 7473 2f73   'python tests/s
-00023220: 6b79 7365 7276 652f 6c6f 6164 5f62 616c  kyserve/load_bal
-00023230: 616e 6365 722f 7465 7374 5f72 6f75 6e64  ancer/test_round
-00023240: 5f72 6f62 696e 2e70 7920 270a 2020 2020  _robin.py '.    
-00023250: 2020 2020 2020 2020 272d 2d65 6e64 706f          '--endpo
-00023260: 696e 7420 2465 6e64 706f 696e 7420 2d2d  int $endpoint --
-00023270: 7265 706c 6963 612d 6e75 6d20 3320 2d2d  replica-num 3 --
-00023280: 7265 706c 6963 612d 6970 7320 2469 7031  replica-ips $ip1
-00023290: 2024 6970 3220 2469 7033 272c 0a20 2020   $ip2 $ip3',.   
-000232a0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000232b0: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
-000232c0: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
-000232d0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-000232e0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-000232f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00023300: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00023310: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
-00023320: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
-00023330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00023340: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
-00023350: 7465 7374 5f73 6b79 7365 7276 655f 6175  test_skyserve_au
-00023360: 746f 5f72 6573 7461 7274 2829 3a0a 2020  to_restart():.  
-00023370: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-00023380: 7665 2077 6974 6820 6175 746f 2072 6573  ve with auto res
-00023390: 7461 7274 2222 220a 2020 2020 6e61 6d65  tart""".    name
-000233a0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-000233b0: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
-000233c0: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
-000233d0: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
-000233e0: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-000233f0: 742d 736b 7973 6572 7665 2d61 7574 6f2d  t-skyserve-auto-
-00023400: 7265 7374 6172 7427 2c0a 2020 2020 2020  restart',.      
-00023410: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00023420: 2320 544f 444f 2874 6961 6e29 3a20 7765  # TODO(tian): we
-00023430: 2063 616e 2064 796e 616d 6963 616c 6c79   can dynamically
-00023440: 2067 656e 6572 6174 6520 5941 4d4c 2066   generate YAML f
-00023450: 726f 6d20 7465 6d70 6c61 7465 2074 6f0a  rom template to.
-00023460: 2020 2020 2020 2020 2020 2020 2320 6176              # av
-00023470: 6f69 6420 6d61 696e 7461 696e 696e 6720  oid maintaining 
-00023480: 746f 6f20 6d61 6e79 2059 414d 4c20 6669  too many YAML fi
-00023490: 6c65 730a 2020 2020 2020 2020 2020 2020  les.            
-000234a0: 6627 736b 7920 7365 7276 6520 7570 202d  f'sky serve up -
-000234b0: 6e20 7b6e 616d 657d 202d 7920 7465 7374  n {name} -y test
-000234c0: 732f 736b 7973 6572 7665 2f61 7574 6f5f  s/skyserve/auto_
-000234d0: 7265 7374 6172 742e 7961 6d6c 272c 0a20  restart.yaml',. 
-000234e0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-000234f0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00023500: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00023510: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00023520: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
-00023530: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-00023540: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-00023550: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
-00023560: 2020 2020 2020 2020 2020 2027 6375 726c             'curl
-00023570: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-00023580: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
-00023590: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
-000235a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000235b0: 736c 6565 7020 666f 7220 3230 2073 6563  sleep for 20 sec
-000235c0: 6f6e 6473 2028 696e 6974 6961 6c20 6465  onds (initial de
-000235d0: 6c61 7929 2074 6f20 6d61 6b65 2073 7572  lay) to make sur
-000235e0: 6520 6974 2077 696c 6c0a 2020 2020 2020  e it will.      
-000235f0: 2020 2020 2020 2320 6265 2072 6573 7461        # be resta
-00023600: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
-00023610: 2066 2773 6c65 6570 2032 3027 2c0a 2020   f'sleep 20',.  
-00023620: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
-00023630: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
-00023640: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
-00023650: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
-00023660: 6169 7420 666f 7220 636f 6e73 6563 7574  ait for consecut
-00023670: 6976 6520 6661 696c 7572 6520 7469 6d65  ive failure time
-00023680: 6f75 7420 7061 7373 6564 2e0a 2020 2020  out passed..    
-00023690: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-000236a0: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
-000236b0: 7573 696e 6720 7370 6f74 2c20 6974 2077  using spot, it w
-000236c0: 6f6e 2774 2063 6865 636b 2074 6865 2063  on't check the c
-000236d0: 6c75 7374 6572 2073 7461 7475 730a 2020  luster status.  
-000236e0: 2020 2020 2020 2020 2020 2320 6f6e 2074            # on t
-000236f0: 6865 2063 6c6f 7564 2028 7369 6e63 6520  he cloud (since 
-00023700: 6d61 6e75 616c 2073 6875 7464 6f77 6e20  manual shutdown 
-00023710: 6973 206e 6f74 2061 2063 6f6d 6d6f 6e20  is not a common 
-00023720: 6265 6861 7669 6f72 2061 6e64 2073 7563  behavior and suc
-00023730: 680a 2020 2020 2020 2020 2020 2020 2320  h.            # 
-00023740: 7175 6572 6965 7320 7461 6b65 7320 6120  queries takes a 
-00023750: 6c6f 7420 6f66 2074 696d 6529 2e20 496e  lot of time). In
-00023760: 7374 6561 642c 2077 6520 7468 696e 6b20  stead, we think 
-00023770: 636f 6e74 696e 756f 7573 2033 206d 696e  continuous 3 min
-00023780: 2070 726f 6265 0a20 2020 2020 2020 2020   probe.         
-00023790: 2020 2023 2066 6169 6c75 7265 2069 7320     # failure is 
-000237a0: 6e6f 7420 6120 7465 6d70 6f72 6172 7920  not a temporary 
-000237b0: 7072 6f62 6c65 6d20 6275 7420 696e 6465  problem but inde
-000237c0: 6564 2061 2066 6169 6c75 7265 2e0a 2020  ed a failure..  
-000237d0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000237e0: 2031 3830 272c 0a20 2020 2020 2020 2020   180',.         
-000237f0: 2020 2023 2057 6520 6361 6e6e 6f74 2075     # We cannot u
-00023800: 7365 205f 5345 5256 455f 5741 4954 5f55  se _SERVE_WAIT_U
-00023810: 4e54 494c 5f52 4541 4459 3b20 7468 6572  NTIL_READY; ther
-00023820: 6520 7769 6c6c 2062 6520 6120 696e 7465  e will be a inte
-00023830: 726d 6564 6961 7465 2074 696d 650a 2020  rmediate time.  
-00023840: 2020 2020 2020 2020 2020 2320 7468 6174            # that
-00023850: 2074 6865 206f 7574 7075 7420 6f66 2060   the output of `
-00023860: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00023870: 6020 7368 6f77 7320 4641 494c 4544 2061  ` shows FAILED a
-00023880: 6e64 2074 6869 7320 7374 6174 7573 2077  nd this status w
-00023890: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
-000238a0: 2320 6361 7573 6520 5f53 4552 5645 5f57  # cause _SERVE_W
-000238b0: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
-000238c0: 746f 2065 6172 6c79 2071 7569 742e 0a20  to early quit.. 
-000238d0: 2020 2020 2020 2020 2020 2027 2877 6869             '(whi
-000238e0: 6c65 2074 7275 653b 2064 6f27 0a20 2020  le true; do'.   
-000238f0: 2020 2020 2020 2020 2066 2720 2020 206f           f'    o
-00023900: 7574 7075 743d 2428 736b 7920 7365 7276  utput=$(sky serv
-00023910: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
-00023920: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
-00023930: 2020 2020 2065 6368 6f20 2224 6f75 7470       echo "$outp
-00023940: 7574 2220 7c20 6772 6570 202d 7120 2231  ut" | grep -q "1
-00023950: 2f31 2220 2626 2062 7265 616b 3b27 0a20  /1" && break;'. 
-00023960: 2020 2020 2020 2020 2020 2027 2020 2020             '    
-00023970: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
-00023980: 2020 2020 2020 2020 6627 646f 6e65 293b          f'done);
-00023990: 2073 6c65 6570 207b 7365 7276 652e 4c42   sleep {serve.LB
-000239a0: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
-000239b0: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
-000239c0: 537d 3b27 2c0a 2020 2020 2020 2020 2020  S};',.          
-000239d0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-000239e0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-000239f0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00023a00: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
-00023a10: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00023a20: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00023a30: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00023a40: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00023a50: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00023a60: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00023a70: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00023a80: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00023a90: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00023aa0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00023ab0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00023ac0: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
-00023ad0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00023ae0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-00023af0: 7665 5f63 616e 6365 6c28 6765 6e65 7269  ve_cancel(generi
-00023b00: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00023b10: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
-00023b20: 7276 6520 7769 7468 2063 616e 6365 6c22  rve with cancel"
-00023b30: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-00023b40: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-00023b50: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
-00023b60: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
-00023b70: 7374 2d73 6b79 7365 7276 652d 6361 6e63  st-skyserve-canc
-00023b80: 656c 272c 0a20 2020 2020 2020 205b 0a20  el',.        [. 
-00023b90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00023ba0: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
-00023bb0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00023bc0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00023bd0: 6573 7473 2f73 6b79 7365 7276 652f 6361  ests/skyserve/ca
-00023be0: 6e63 656c 2f63 616e 6365 6c2e 7961 6d6c  ncel/cancel.yaml
-00023bf0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00023c00: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00023c10: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00023c20: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00023c30: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
-00023c40: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00023c50: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00023c60: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00023c70: 2070 7974 686f 6e33 2027 0a20 2020 2020   python3 '.     
-00023c80: 2020 2020 2020 2027 7465 7374 732f 736b         'tests/sk
-00023c90: 7973 6572 7665 2f63 616e 6365 6c2f 7365  yserve/cancel/se
-00023ca0: 6e64 5f63 616e 6365 6c5f 7265 7175 6573  nd_cancel_reques
-00023cb0: 742e 7079 2027 0a20 2020 2020 2020 2020  t.py '.         
-00023cc0: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
-00023cd0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00023ce0: 2252 6571 7565 7374 2077 6173 2063 616e  "Request was can
-00023cf0: 6365 6c6c 6564 2227 2c0a 2020 2020 2020  celled"',.      
-00023d00: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-00023d10: 7365 7276 6520 6c6f 6773 207b 6e61 6d65  serve logs {name
-00023d20: 7d20 3120 2d2d 6e6f 2d66 6f6c 6c6f 7729  } 1 --no-follow)
-00023d30: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00023d40: 2775 6e74 696c 2021 2065 6368 6f20 2224  'until ! echo "$
-00023d50: 7322 207c 2067 7265 7020 2250 6c65 6173  s" | grep "Pleas
-00023d60: 6520 7761 6974 2066 6f72 2074 6865 2063  e wait for the c
-00023d70: 6f6e 7472 6f6c 6c65 7220 746f 2062 6522  ontroller to be"
-00023d80: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00023d90: 2764 6f20 6563 686f 2022 5761 6974 696e  'do echo "Waitin
-00023da0: 6720 666f 7220 7365 7276 6520 6c6f 6773  g for serve logs
-00023db0: 223b 2073 6c65 6570 2031 303b 2027 0a20  "; sleep 10; '. 
-00023dc0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00023dd0: 2873 6b79 2073 6572 7665 206c 6f67 7320  (sky serve logs 
-00023de0: 7b6e 616d 657d 2031 202d 2d6e 6f2d 666f  {name} 1 --no-fo
-00023df0: 6c6c 6f77 293b 2064 6f6e 653b 2027 0a20  llow); done; '. 
-00023e00: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
-00023e10: 2022 2473 223b 2065 6368 6f20 2224 7322   "$s"; echo "$s"
-00023e20: 207c 2067 7265 7020 2243 6c69 656e 7420   | grep "Client 
-00023e30: 6469 7363 6f6e 6e65 6374 6564 2c20 7374  disconnected, st
-00023e40: 6f70 7069 6e67 2063 6f6d 7075 7461 7469  opping computati
-00023e50: 6f6e 2227 2c0a 2020 2020 2020 2020 5d2c  on"',.        ],
-00023e60: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00023e70: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00023e80: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00023e90: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00023ea0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00023eb0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00023ec0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00023ed0: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00023ee0: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-00023ef0: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-00023f00: 7365 7276 655f 7570 6461 7465 2867 656e  serve_update(gen
-00023f10: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00023f20: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-00023f30: 7973 6572 7665 2077 6974 6820 7570 6461  yserve with upda
-00023f40: 7465 2222 220a 2020 2020 6e61 6d65 203d  te""".    name =
-00023f50: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-00023f60: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00023f70: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00023f80: 7465 7374 2d73 6b79 7365 7276 652d 7570  test-skyserve-up
-00023f90: 6461 7465 272c 0a20 2020 2020 2020 205b  date',.        [
-00023fa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00023fb0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-00023fc0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00023fd0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00023fe0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00023ff0: 7570 6461 7465 2f6f 6c64 2e79 616d 6c27  update/old.yaml'
-00024000: 2c0a 2020 2020 2020 2020 2020 2020 5f53  ,.            _S
-00024010: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-00024020: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-00024030: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-00024040: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
-00024050: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-00024060: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-00024070: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-00024080: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00024090: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-000240a0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-000240b0: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
-000240c0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-000240d0: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
-000240e0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-000240f0: 7564 7d20 2d2d 6d6f 6465 2062 6c75 655f  ud} --mode blue_
-00024100: 6772 6565 6e20 2d79 2074 6573 7473 2f73  green -y tests/s
-00024110: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
-00024120: 6577 2e79 616d 6c27 2c0a 2020 2020 2020  ew.yaml',.      
-00024130: 2020 2020 2020 2320 736c 6565 7020 6265        # sleep be
-00024140: 666f 7265 2075 7064 6174 6520 6973 2072  fore update is r
-00024150: 6567 6973 7465 7265 642e 0a20 2020 2020  egistered..     
-00024160: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
-00024170: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00024180: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-00024190: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-000241a0: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-000241b0: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-000241c0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-000241d0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-000241e0: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
-000241f0: 7420 6865 7265 2122 3b20 646f 2073 6c65  t here!"; do sle
-00024200: 6570 2032 3b20 646f 6e65 3b27 0a20 2020  ep 2; done;'.   
-00024210: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-00024220: 7375 7265 2074 6865 2074 7261 6666 6963  sure the traffic
-00024230: 2069 7320 6e6f 7420 6d69 7865 640a 2020   is not mixed.  
-00024240: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
-00024250: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-00024260: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00024270: 6e65 7720 536b 7950 696c 6f74 2068 6572  new SkyPilot her
-00024280: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-00024290: 2023 2054 6865 206c 6174 6573 7420 3220   # The latest 2 
-000242a0: 7665 7273 696f 6e20 7368 6f75 6c64 2062  version should b
-000242b0: 6520 5245 4144 5920 616e 6420 7468 6520  e READY and the 
-000242c0: 6f6c 6465 7220 7665 7273 696f 6e73 2073  older versions s
-000242d0: 686f 756c 6420 6265 2073 6875 7474 696e  hould be shuttin
-000242e0: 6720 646f 776e 0a20 2020 2020 2020 2020  g down.         
-000242f0: 2020 2028 5f63 6865 636b 5f72 6570 6c69     (_check_repli
-00024300: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-00024310: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
-00024320: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
-00024330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024350: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
-00024360: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
-00024370: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
-00024380: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
-00024390: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-000243a0: 2232 2229 292c 0a20 2020 2020 2020 205d  "2")),.        ]
-000243b0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
-000243c0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
-000243d0: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
-000243e0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-000243f0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-00024400: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00024410: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00024420: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
-00024430: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
-00024440: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
-00024450: 7973 6572 7665 5f72 6f6c 6c69 6e67 5f75  yserve_rolling_u
-00024460: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
-00024470: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00024480: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
-00024490: 7769 7468 2072 6f6c 6c69 6e67 2075 7064  with rolling upd
-000244a0: 6174 6522 2222 0a20 2020 206e 616d 6520  ate""".    name 
-000244b0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-000244c0: 616d 6528 290a 2020 2020 7369 6e67 6c65  ame().    single
-000244d0: 5f6e 6577 5f72 6570 6c69 6361 203d 205f  _new_replica = _
-000244e0: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-000244f0: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
-00024500: 206e 616d 652c 205b 2832 2c20 4661 6c73   name, [(2, Fals
-00024510: 652c 2027 5245 4144 5927 292c 2028 312c  e, 'READY'), (1,
-00024520: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
-00024530: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-00024540: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
-00024550: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
-00024560: 7365 2c20 2753 4855 5454 494e 475f 444f  se, 'SHUTTING_DO
-00024570: 574e 2729 5d29 0a20 2020 2074 6573 7420  WN')]).    test 
-00024580: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00024590: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-000245a0: 726f 6c6c 696e 672d 7570 6461 7465 272c  rolling-update',
-000245b0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000245c0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
-000245d0: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
-000245e0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000245f0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-00024600: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00024610: 2f6f 6c64 2e79 616d 6c27 2c0a 2020 2020  /old.yaml',.    
-00024620: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00024630: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00024640: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00024650: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-00024660: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00024670: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-00024680: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-00024690: 653d 6e61 6d65 297d 3b20 6375 726c 202d  e=name)}; curl -
-000246a0: 4c20 6874 7470 3a2f 2f24 656e 6470 6f69  L http://$endpoi
-000246b0: 6e74 207c 2067 7265 7020 2248 692c 2053  nt | grep "Hi, S
-000246c0: 6b79 5069 6c6f 7420 6865 7265 2227 2c0a  kyPilot here"',.
-000246d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000246e0: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
-000246f0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00024700: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00024710: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00024720: 7570 6461 7465 2f6e 6577 2e79 616d 6c27  update/new.yaml'
-00024730: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00024740: 4d61 6b65 2073 7572 6520 7468 6520 7472  Make sure the tr
-00024750: 6166 6669 6320 6973 206d 6978 6564 2061  affic is mixed a
-00024760: 6372 6f73 7320 7477 6f20 7665 7273 696f  cross two versio
-00024770: 6e73 2c20 7468 6520 7265 706c 6963 6173  ns, the replicas
-00024780: 0a20 2020 2020 2020 2020 2020 2023 2077  .            # w
-00024790: 6974 6820 6576 656e 2069 6420 7769 6c6c  ith even id will
-000247a0: 2073 6c65 6570 2036 3020 7365 636f 6e64   sleep 60 second
-000247b0: 7320 6265 666f 7265 2062 6569 6e67 2072  s before being r
-000247c0: 6561 6479 2c20 736f 2077 650a 2020 2020  eady, so we.    
-000247d0: 2020 2020 2020 2020 2320 7368 6f75 6c64          # should
-000247e0: 2062 6520 6162 6c65 2074 6f20 6765 7420   be able to get 
-000247f0: 6f62 7365 7276 6520 7468 6520 7065 7269  observe the peri
-00024800: 6f64 2074 6861 7420 7468 6520 7472 6166  od that the traf
-00024810: 6669 6320 6973 206d 6978 6564 0a20 2020  fic is mixed.   
-00024820: 2020 2020 2020 2020 2023 2061 6372 6f73           # acros
-00024830: 7320 7477 6f20 7665 7273 696f 6e73 2e0a  s two versions..
-00024840: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00024850: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00024860: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-00024870: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
-00024880: 2020 2020 2020 2775 6e74 696c 2063 7572        'until cur
-00024890: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-000248a0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-000248b0: 2c20 6e65 7720 536b 7950 696c 6f74 2068  , new SkyPilot h
-000248c0: 6572 6521 223b 2064 6f20 736c 6565 7020  ere!"; do sleep 
-000248d0: 323b 2064 6f6e 653b 2073 6c65 6570 2032  2; done; sleep 2
-000248e0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-000248f0: 2320 5468 6520 6c61 7465 7374 2076 6572  # The latest ver
-00024900: 7369 6f6e 2073 686f 756c 6420 6861 7665  sion should have
-00024910: 206f 6e65 2052 4541 4459 2061 6e64 2074   one READY and t
-00024920: 6865 206f 6e65 206f 6620 7468 6520 6f6c  he one of the ol
-00024930: 6465 7220 7665 7273 696f 6e73 2073 686f  der versions sho
-00024940: 756c 6420 6265 2073 6875 7474 696e 6720  uld be shutting 
-00024950: 646f 776e 0a20 2020 2020 2020 2020 2020  down.           
-00024960: 2066 277b 7369 6e67 6c65 5f6e 6577 5f72   f'{single_new_r
-00024970: 6570 6c69 6361 7d20 7b5f 6368 6563 6b5f  eplica} {_check_
-00024980: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-00024990: 6e61 6d65 2c20 2231 2c32 2229 7d20 270a  name, "1,2")} '.
-000249a0: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
-000249b0: 6563 6b20 7468 6520 6f75 7470 7574 2066  eck the output f
-000249c0: 726f 6d20 7468 6520 6f6c 6420 7665 7273  rom the old vers
-000249d0: 696f 6e2c 2069 6d6d 6564 6961 7465 6c79  ion, immediately
-000249e0: 2061 6674 6572 2074 6865 0a20 2020 2020   after the.     
-000249f0: 2020 2020 2020 2023 206f 7574 7075 7420         # output 
-00024a00: 6672 6f6d 2074 6865 206e 6577 2076 6572  from the new ver
-00024a10: 7369 6f6e 2061 7070 6561 7273 2e20 5468  sion appears. Th
-00024a20: 6973 2069 7320 6775 6172 616e 7465 6564  is is guaranteed
-00024a30: 2062 7920 7468 650a 2020 2020 2020 2020   by the.        
-00024a40: 2020 2020 2320 726f 756e 6420 726f 6269      # round robi
-00024a50: 6e20 6c6f 6164 2062 616c 616e 6369 6e67  n load balancing
-00024a60: 2070 6f6c 6963 792e 0a20 2020 2020 2020   policy..       
-00024a70: 2020 2020 2023 2054 4f44 4f28 7a68 7775       # TODO(zhwu
-00024a80: 293a 2077 6520 7368 6f75 6c64 2068 6176  ): we should hav
-00024a90: 6520 6120 6d6f 7265 2067 656e 6572 616c  e a more general
-00024aa0: 697a 6564 2077 6179 2066 6f72 2063 6865  ized way for che
-00024ab0: 636b 696e 6720 7468 650a 2020 2020 2020  cking the.      
-00024ac0: 2020 2020 2020 2320 6d69 7865 6420 7665        # mixed ve
-00024ad0: 7273 696f 6e20 6f66 2072 6570 6c69 6361  rsion of replica
-00024ae0: 7320 746f 2061 766f 6964 2064 6570 656e  s to avoid depen
-00024af0: 6469 6e67 206f 6e20 7468 6520 7370 6563  ding on the spec
-00024b00: 6966 6963 0a20 2020 2020 2020 2020 2020  ific.           
-00024b10: 2023 2072 6f75 6e64 2072 6f62 696e 206c   # round robin l
-00024b20: 6f61 6420 6261 6c61 6e63 696e 6720 706f  oad balancing po
-00024b30: 6c69 6379 2e0a 2020 2020 2020 2020 2020  licy..          
-00024b40: 2020 2763 7572 6c20 2d4c 2068 7474 703a    'curl -L http:
-00024b50: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
-00024b60: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-00024b70: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-00024b80: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-00024b90: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-00024ba0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-00024bb0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-00024bc0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-00024bd0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00024be0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00024bf0: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
-00024c00: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00024c10: 726e 6574 6573 0a64 6566 2074 6573 745f  rnetes.def test_
-00024c20: 736b 7973 6572 7665 5f66 6173 745f 7570  skyserve_fast_up
-00024c30: 6461 7465 2867 656e 6572 6963 5f63 6c6f  date(generic_clo
-00024c40: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-00024c50: 2254 6573 7420 736b 7973 6572 7665 2077  "Test skyserve w
-00024c60: 6974 6820 6661 7374 2075 7064 6174 6520  ith fast update 
-00024c70: 2849 6e63 7265 6d65 6e74 2076 6572 7369  (Increment versi
-00024c80: 6f6e 206f 6620 6f6c 6420 7265 706c 6963  on of old replic
-00024c90: 6173 2922 2222 0a20 2020 206e 616d 6520  as)""".    name 
-00024ca0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00024cb0: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
-00024cc0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00024cd0: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-00024ce0: 6661 7374 2d75 7064 6174 6527 2c0a 2020  fast-update',.  
-00024cf0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00024d00: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00024d10: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
-00024d20: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00024d30: 5f63 6c6f 7564 7d20 7465 7374 732f 736b  _cloud} tests/sk
-00024d40: 7973 6572 7665 2f75 7064 6174 652f 6275  yserve/update/bu
-00024d50: 6d70 5f76 6572 7369 6f6e 5f62 6566 6f72  mp_version_befor
-00024d60: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-00024d70: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-00024d80: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-00024d90: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-00024da0: 6570 6c69 6361 5f6e 756d 3d32 292c 0a20  eplica_num=2),. 
-00024db0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00024dc0: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
-00024dd0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
-00024de0: 616d 6529 7d3b 2063 7572 6c20 2d4c 2068  ame)}; curl -L h
-00024df0: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00024e00: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
-00024e10: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
-00024e20: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00024e30: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
-00024e40: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00024e50: 7269 635f 636c 6f75 647d 202d 2d6d 6f64  ric_cloud} --mod
-00024e60: 6520 626c 7565 5f67 7265 656e 202d 7920  e blue_green -y 
-00024e70: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
-00024e80: 7064 6174 652f 6275 6d70 5f76 6572 7369  pdate/bump_versi
-00024e90: 6f6e 5f61 6674 6572 2e79 616d 6c27 2c0a  on_after.yaml',.
-00024ea0: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
-00024eb0: 6565 7020 746f 2077 6169 7420 666f 7220  eep to wait for 
-00024ec0: 7570 6461 7465 2074 6f20 6265 2072 6567  update to be reg
-00024ed0: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
-00024ee0: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-00024ef0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00024f00: 3220 6f6e 2d64 6561 6d6e 6420 2872 6561  2 on-deamnd (rea
-00024f10: 6479 2920 2b20 3120 6f6e 2d64 656d 616e  dy) + 1 on-deman
-00024f20: 6420 2870 726f 7669 7369 6f6e 696e 6729  d (provisioning)
-00024f30: 2e0a 2020 2020 2020 2020 2020 2020 280a  ..            (.
-00024f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f50: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00024f60: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
-00024f70: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00024f80: 6d65 2c20 5b28 322c 2046 616c 7365 2c20  me, [(2, False, 
-00024f90: 2752 4541 4459 2729 2c0a 2020 2020 2020  'READY'),.      
-00024fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fb0: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
-00024fc0: 5f53 4552 5649 4345 5f4c 4155 4e43 4849  _SERVICE_LAUNCHI
-00024fd0: 4e47 5f53 5441 5455 535f 5245 4745 5829  NG_STATUS_REGEX)
-00024fe0: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
-00024ff0: 2020 2020 2023 2046 6173 7420 7570 6461       # Fast upda
-00025000: 7465 2077 696c 6c20 6469 7265 6374 6c79  te will directly
-00025010: 2068 6176 6520 7468 6520 6c61 7465 7374   have the latest
-00025020: 2076 6572 7369 6f6e 2072 6561 6479 2e0a   version ready..
-00025030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025040: 5f63 6865 636b 5f73 6572 7669 6365 5f76  _check_service_v
-00025050: 6572 7369 6f6e 286e 616d 652c 2022 3222  ersion(name, "2"
-00025060: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00025070: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00025080: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-00025090: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-000250a0: 615f 6e75 6d3d 3329 202b 0a20 2020 2020  a_num=3) +.     
-000250b0: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-000250c0: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-000250d0: 6d65 2c20 2232 2229 2c0a 2020 2020 2020  me, "2"),.      
-000250e0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-000250f0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00025100: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00025110: 3b20 6375 726c 202d 4c20 6874 7470 3a2f  ; curl -L http:/
-00025120: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00025130: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00025140: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00025150: 2020 2020 2320 5465 7374 2072 6f6c 6c69      # Test rolli
-00025160: 6e67 2075 7064 6174 650a 2020 2020 2020  ng update.      
-00025170: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00025180: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
-00025190: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000251a0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
-000251b0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-000251c0: 2f62 756d 705f 7665 7273 696f 6e5f 6265  /bump_version_be
-000251d0: 666f 7265 2e79 616d 6c27 2c0a 2020 2020  fore.yaml',.    
-000251e0: 2020 2020 2020 2020 2320 736c 6565 7020          # sleep 
-000251f0: 746f 2077 6169 7420 666f 7220 7570 6461  to wait for upda
-00025200: 7465 2074 6f20 6265 2072 6567 6973 7465  te to be registe
-00025210: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
-00025220: 2027 736c 6565 7020 3330 272c 0a20 2020   'sleep 30',.   
-00025230: 2020 2020 2020 2020 2023 2032 206f 6e2d           # 2 on-
-00025240: 6465 616d 6e64 2028 7265 6164 7929 202b  deamnd (ready) +
-00025250: 2031 206f 6e2d 6465 6d61 6e64 2028 7368   1 on-demand (sh
-00025260: 7574 7469 6e67 2064 6f77 6e29 2e0a 2020  utting down)..  
-00025270: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00025280: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00025290: 7573 286e 616d 652c 205b 2832 2c20 4661  us(name, [(2, Fa
-000252a0: 6c73 652c 2027 5245 4144 5927 292c 0a20  lse, 'READY'),. 
-000252b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000252c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000252d0: 2020 2020 2020 2020 2020 2028 312c 2046             (1, F
-000252e0: 616c 7365 2c20 2753 4855 5454 494e 475f  alse, 'SHUTTING_
-000252f0: 444f 574e 2729 5d29 2c0a 2020 2020 2020  DOWN')]),.      
-00025300: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00025310: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00025320: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00025330: 7265 706c 6963 615f 6e75 6d3d 3229 202b  replica_num=2) +
-00025340: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00025350: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
-00025360: 696f 6e28 6e61 6d65 2c20 2233 2229 2c0a  ion(name, "3"),.
-00025370: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00025380: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
-00025390: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-000253a0: 6e61 6d65 297d 3b20 6375 726c 202d 4c20  name)}; curl -L 
-000253b0: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
-000253c0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
-000253d0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
-000253e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000253f0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
-00025400: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
-00025410: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00025420: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
-00025430: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00025440: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00025450: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
-00025460: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00025470: 5f6b 7562 6572 6e65 7465 730a 6465 6620  _kubernetes.def 
-00025480: 7465 7374 5f73 6b79 7365 7276 655f 7570  test_skyserve_up
-00025490: 6461 7465 5f61 7574 6f73 6361 6c65 2867  date_autoscale(g
-000254a0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-000254b0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-000254c0: 736b 7973 6572 7665 2075 7064 6174 6520  skyserve update 
-000254d0: 7769 7468 2061 7574 6f73 6361 6c65 2222  with autoscale""
-000254e0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-000254f0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-00025500: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00025510: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-00025520: 2d73 6b79 7365 7276 652d 7570 6461 7465  -skyserve-update
-00025530: 2d61 7574 6f73 6361 6c65 272c 0a20 2020  -autoscale',.   
-00025540: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00025550: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00025560: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
-00025570: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00025580: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-00025590: 7365 7276 652f 7570 6461 7465 2f6e 756d  serve/update/num
-000255a0: 5f6d 696e 5f74 776f 2e79 616d 6c27 2c0a  _min_two.yaml',.
-000255b0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-000255c0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-000255d0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-000255e0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-000255f0: 6d3d 3229 202b 0a20 2020 2020 2020 2020  m=2) +.         
-00025600: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
-00025610: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-00025620: 2231 2229 2c0a 2020 2020 2020 2020 2020  "1"),.          
-00025630: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00025640: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00025650: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
-00025660: 2020 2020 2020 2020 2020 2020 2763 7572              'cur
-00025670: 6c20 2d4c 2068 7474 703a 2f2f 2465 6e64  l -L http://$end
-00025680: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00025690: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-000256a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000256b0: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
-000256c0: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
-000256d0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-000256e0: 202d 2d6d 6f64 6520 626c 7565 5f67 7265   --mode blue_gre
-000256f0: 656e 202d 7920 7465 7374 732f 736b 7973  en -y tests/skys
-00025700: 6572 7665 2f75 7064 6174 652f 6e75 6d5f  erve/update/num_
-00025710: 6d69 6e5f 6f6e 652e 7961 6d6c 272c 0a20  min_one.yaml',. 
-00025720: 2020 2020 2020 2020 2020 2023 2073 6c65             # sle
-00025730: 6570 2062 6566 6f72 6520 7570 6461 7465  ep before update
-00025740: 2069 7320 7265 6769 7374 6572 6564 2e0a   is registered..
-00025750: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00025760: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
-00025770: 2020 2020 2320 5469 6d65 6f75 7420 7769      # Timeout wi
-00025780: 6c6c 2062 6520 7472 6967 6765 7265 6420  ll be triggered 
-00025790: 7768 656e 2075 7064 6174 6520 6661 696c  when update fail
-000257a0: 732e 0a20 2020 2020 2020 2020 2020 205f  s..            _
-000257b0: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-000257c0: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-000257d0: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-000257e0: 5f6e 756d 3d31 2920 2b0a 2020 2020 2020  _num=1) +.      
-000257f0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
-00025800: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
-00025810: 652c 2022 3222 292c 0a20 2020 2020 2020  e, "2"),.       
-00025820: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00025830: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00025840: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00025850: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00025860: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00025870: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00025880: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
-00025890: 7265 2122 272c 0a20 2020 2020 2020 2020  re!"',.         
-000258a0: 2020 2023 2052 6f6c 6c69 6e67 2055 7064     # Rolling Upd
-000258b0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-000258c0: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-000258d0: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
-000258e0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000258f0: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-00025900: 7276 652f 7570 6461 7465 2f6e 756d 5f6d  rve/update/num_m
-00025910: 696e 5f74 776f 2e79 616d 6c27 2c0a 2020  in_two.yaml',.  
-00025920: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
-00025930: 7020 6265 666f 7265 2075 7064 6174 6520  p before update 
-00025940: 6973 2072 6567 6973 7465 7265 642e 0a20  is registered.. 
-00025950: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00025960: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
-00025970: 2020 2023 2054 696d 656f 7574 2077 696c     # Timeout wil
-00025980: 6c20 6265 2074 7269 6767 6572 6564 2077  l be triggered w
-00025990: 6865 6e20 7570 6461 7465 2066 6169 6c73  hen update fails
-000259a0: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
-000259b0: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
-000259c0: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
-000259d0: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
-000259e0: 6e75 6d3d 3229 202b 0a20 2020 2020 2020  num=2) +.       
-000259f0: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
-00025a00: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
-00025a10: 2c20 2233 2229 2c0a 2020 2020 2020 2020  , "3"),.        
-00025a20: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
-00025a30: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
-00025a40: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
-00025a50: 270a 2020 2020 2020 2020 2020 2020 2763  '.            'c
-00025a60: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
-00025a70: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-00025a80: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
-00025a90: 6521 2227 2c0a 2020 2020 2020 2020 5d2c  e!"',.        ],
-00025aa0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00025ab0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00025ac0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00025ad0: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
-00025ae0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00025af0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00025b00: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00025b10: 726b 2e73 6572 7665 0a40 7079 7465 7374  rk.serve.@pytest
-00025b20: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-00025b30: 6528 276d 6f64 6527 2c20 5b27 726f 6c6c  e('mode', ['roll
-00025b40: 696e 6727 2c20 2762 6c75 655f 6772 6565  ing', 'blue_gree
-00025b50: 6e27 5d29 0a40 7079 7465 7374 2e6d 6172  n']).@pytest.mar
-00025b60: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
-00025b70: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-00025b80: 655f 6e65 775f 6175 746f 7363 616c 6572  e_new_autoscaler
-00025b90: 5f75 7064 6174 6528 6d6f 6465 3a20 7374  _update(mode: st
-00025ba0: 722c 2067 656e 6572 6963 5f63 6c6f 7564  r, generic_cloud
-00025bb0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-00025bc0: 6573 7420 736b 7973 6572 7665 2077 6974  est skyserve wit
-00025bd0: 6820 7570 6461 7465 2074 6861 7420 6368  h update that ch
-00025be0: 616e 6765 7320 6175 746f 7363 616c 6572  anges autoscaler
-00025bf0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00025c00: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00025c10: 2829 202b 206d 6f64 650a 0a20 2020 2066  () + mode..    f
-00025c20: 6f75 725f 7370 6f74 5f75 705f 636d 6420  our_spot_up_cmd 
-00025c30: 3d20 5f63 6865 636b 5f72 6570 6c69 6361  = _check_replica
-00025c40: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-00025c50: 205b 2834 2c20 5472 7565 2c20 2752 4541   [(4, True, 'REA
-00025c60: 4459 2729 5d29 0a20 2020 2075 7064 6174  DY')]).    updat
-00025c70: 655f 6368 6563 6b20 3d20 5b66 2775 6e74  e_check = [f'unt
-00025c80: 696c 2028 7b66 6f75 725f 7370 6f74 5f75  il ({four_spot_u
-00025c90: 705f 636d 647d 293b 2064 6f20 736c 6565  p_cmd}); do slee
-00025ca0: 7020 353b 2064 6f6e 653b 2073 6c65 6570  p 5; done; sleep
-00025cb0: 2031 303b 275d 0a20 2020 2069 6620 6d6f   10;'].    if mo
-00025cc0: 6465 203d 3d20 2772 6f6c 6c69 6e67 273a  de == 'rolling':
-00025cd0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00025ce0: 2072 6f6c 6c69 6e67 2075 7064 6174 652c   rolling update,
-00025cf0: 2069 7420 7769 6c6c 2074 6572 6d69 6e61   it will termina
-00025d00: 7465 206f 6e65 206f 6620 7468 6520 6f6c  te one of the ol
-00025d10: 6420 6f6e 2d64 656d 616e 640a 2020 2020  d on-demand.    
-00025d20: 2020 2020 2320 696e 7374 616e 6365 732c      # instances,
-00025d30: 206f 6e63 6520 7468 6572 6520 6172 6520   once there are 
-00025d40: 3420 7370 6f74 2069 6e73 7461 6e63 6520  4 spot instance 
-00025d50: 7265 6164 792e 0a20 2020 2020 2020 2075  ready..        u
-00025d60: 7064 6174 655f 6368 6563 6b20 2b3d 205b  pdate_check += [
-00025d70: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00025d80: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00025d90: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
-00025da0: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
-00025db0: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
-00025dc0: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
-00025dd0: 5553 5f52 4547 4558 292c 0a20 2020 2020  US_REGEX),.     
-00025de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025df0: 2020 2831 2c20 4661 6c73 652c 2027 5348    (1, False, 'SH
-00025e00: 5554 5449 4e47 5f44 4f57 4e27 292c 2028  UTTING_DOWN'), (
-00025e10: 312c 2046 616c 7365 2c20 2752 4541 4459  1, False, 'READY
-00025e20: 2729 5d29 202b 0a20 2020 2020 2020 2020  ')]) +.         
-00025e30: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
-00025e40: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-00025e50: 2231 2c32 2229 2c0a 2020 2020 2020 2020  "1,2"),.        
-00025e60: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
-00025e70: 2020 2020 2320 4368 6563 6b20 626c 7565      # Check blue
-00025e80: 2067 7265 656e 2075 7064 6174 652c 2069   green update, i
-00025e90: 7420 7769 6c6c 206b 6565 7020 626f 7468  t will keep both
-00025ea0: 206f 6c64 206f 6e2d 6465 6d61 6e64 2069   old on-demand i
-00025eb0: 6e73 7461 6e63 6573 0a20 2020 2020 2020  nstances.       
-00025ec0: 2023 2072 756e 6e69 6e67 2c20 6f6e 6365   # running, once
-00025ed0: 2074 6865 7265 2061 7265 2034 2073 706f   there are 4 spo
-00025ee0: 7420 696e 7374 616e 6365 2072 6561 6479  t instance ready
-00025ef0: 2e0a 2020 2020 2020 2020 7570 6461 7465  ..        update
-00025f00: 5f63 6865 636b 202b 3d20 5b0a 2020 2020  _check += [.    
-00025f10: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
-00025f20: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
-00025f30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00025f40: 2020 6e61 6d65 2c20 5b28 312c 2046 616c    name, [(1, Fal
-00025f50: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
-00025f60: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
-00025f70: 4745 5829 2c0a 2020 2020 2020 2020 2020  GEX),.          
-00025f80: 2020 2020 2020 2020 2020 2020 2028 322c               (2,
-00025f90: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
-00025fa0: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
-00025fb0: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
-00025fc0: 7665 7273 696f 6e28 6e61 6d65 2c20 2231  version(name, "1
-00025fd0: 2229 2c0a 2020 2020 2020 2020 5d0a 2020  "),.        ].  
-00025fe0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00025ff0: 2020 2020 2020 2027 7465 7374 2d73 6b79         'test-sky
-00026000: 7365 7276 652d 6e65 772d 6175 746f 7363  serve-new-autosc
-00026010: 616c 6572 2d75 7064 6174 6527 2c0a 2020  aler-update',.  
-00026020: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00026030: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00026040: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
-00026050: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00026060: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
-00026070: 7973 6572 7665 2f75 7064 6174 652f 6e65  yserve/update/ne
-00026080: 775f 6175 746f 7363 616c 6572 5f62 6566  w_autoscaler_bef
-00026090: 6f72 652e 7961 6d6c 272c 0a20 2020 2020  ore.yaml',.     
-000260a0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
-000260b0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
-000260c0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
-000260d0: 2072 6570 6c69 6361 5f6e 756d 3d32 2920   replica_num=2) 
-000260e0: 2b0a 2020 2020 2020 2020 2020 2020 5f63  +.            _c
-000260f0: 6865 636b 5f73 6572 7669 6365 5f76 6572  heck_service_ver
-00026100: 7369 6f6e 286e 616d 652c 2022 3122 292c  sion(name, "1"),
-00026110: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00026120: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
-00026130: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
-00026140: 3d6e 616d 6529 7d3b 2027 0a20 2020 2020  =name)}; '.     
-00026150: 2020 2020 2020 2027 733d 2428 6375 726c         's=$(curl
-00026160: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-00026170: 6f69 6e74 293b 2065 6368 6f20 2224 7322  oint); echo "$s"
-00026180: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-00026190: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
-000261a0: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
-000261b0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-000261c0: 2075 7064 6174 6520 7b6e 616d 657d 202d   update {name} -
-000261d0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-000261e0: 636c 6f75 647d 202d 2d6d 6f64 6520 7b6d  cloud} --mode {m
-000261f0: 6f64 657d 202d 7920 7465 7374 732f 736b  ode} -y tests/sk
-00026200: 7973 6572 7665 2f75 7064 6174 652f 6e65  yserve/update/ne
-00026210: 775f 6175 746f 7363 616c 6572 5f61 6674  w_autoscaler_aft
-00026220: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-00026230: 2020 2020 2020 2320 5761 6974 2066 6f72        # Wait for
-00026240: 2075 7064 6174 6520 746f 2062 6520 7265   update to be re
-00026250: 6769 7374 6572 6564 0a20 2020 2020 2020  gistered.       
-00026260: 2020 2020 2066 2773 6c65 6570 2031 3230       f'sleep 120
-00026270: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00026280: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00026290: 5f73 7461 7475 7328 0a20 2020 2020 2020  _status(.       
-000262a0: 2020 2020 2020 2020 206e 616d 652c 205b           name, [
-000262b0: 2834 2c20 5472 7565 2c20 5f53 4552 5649  (4, True, _SERVI
-000262c0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-000262d0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
-000262e0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
-000262f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00026300: 312c 2046 616c 7365 2c20 5f53 4552 5649  1, False, _SERVI
-00026310: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-00026320: 5455 535f 5245 4745 5829 2c0a 2020 2020  TUS_REGEX),.    
-00026330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026340: 2020 2028 322c 2046 616c 7365 2c20 2752     (2, False, 'R
-00026350: 4541 4459 2729 5d29 2c0a 2020 2020 2020  EADY')]),.      
-00026360: 2020 2020 2020 2a75 7064 6174 655f 6368        *update_ch
-00026370: 6563 6b2c 0a20 2020 2020 2020 2020 2020  eck,.           
-00026380: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00026390: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-000263a0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-000263b0: 6361 5f6e 756d 3d35 292c 0a20 2020 2020  ca_num=5),.     
-000263c0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-000263d0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
-000263e0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-000263f0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-00026400: 2027 6375 726c 202d 4c20 6874 7470 3a2f   'curl -L http:/
-00026410: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00026420: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00026430: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00026440: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
-00026450: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
-00026460: 652c 205b 2834 2c20 5472 7565 2c20 2752  e, [(4, True, 'R
-00026470: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
-00026480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000264a0: 2020 2020 2831 2c20 4661 6c73 652c 2027      (1, False, '
-000264b0: 5245 4144 5927 295d 292c 0a20 2020 2020  READY')]),.     
-000264c0: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
-000264d0: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
-000264e0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000264f0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-00026500: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-00026510: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00026520: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00026530: 7374 2e6d 6172 6b2e 7365 7276 650a 6465  st.mark.serve.de
-00026540: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
-00026550: 6661 696c 7572 6573 2867 656e 6572 6963  failures(generic
-00026560: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00026570: 2020 2222 2254 6573 7420 7265 706c 6963    """Test replic
-00026580: 6120 6661 696c 7572 6520 7374 6174 7573  a failure status
-00026590: 6573 2222 220a 2020 2020 6e61 6d65 203d  es""".    name =
-000265a0: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
-000265b0: 6d65 2829 0a0a 2020 2020 7465 7374 203d  me()..    test =
-000265c0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000265d0: 7465 7374 2d73 6b79 7365 7276 652d 6661  test-skyserve-fa
-000265e0: 696c 7572 6573 272c 0a20 2020 2020 2020  ilures',.       
-000265f0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00026600: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
-00026610: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00026620: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00026630: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
-00026640: 652f 6661 696c 7572 6573 2f69 6e69 7469  e/failures/initi
-00026650: 616c 5f64 656c 6179 2e79 616d 6c27 2c0a  al_delay.yaml',.
-00026660: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00026670: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
-00026680: 7573 207b 6e61 6d65 7d29 3b20 270a 2020  us {name}); '.  
-00026690: 2020 2020 2020 2020 2020 6627 756e 7469            f'unti
-000266a0: 6c20 6563 686f 2022 2473 2220 7c20 6772  l echo "$s" | gr
-000266b0: 6570 2022 4641 494c 4544 5f49 4e49 5449  ep "FAILED_INITI
-000266c0: 414c 5f44 454c 4159 223b 2064 6f20 270a  AL_DELAY"; do '.
-000266d0: 2020 2020 2020 2020 2020 2020 2765 6368              'ech
-000266e0: 6f20 2257 6169 7469 6e67 2066 6f72 2072  o "Waiting for r
-000266f0: 6570 6c69 6361 2074 6f20 6265 2066 6169  eplica to be fai
-00026700: 6c65 642e 2e2e 223b 2073 6c65 6570 2035  led..."; sleep 5
-00026710: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00026720: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
-00026730: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
-00026740: 6563 686f 2022 2473 223b 2064 6f6e 653b  echo "$s"; done;
-00026750: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00026760: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
-00026770: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
-00026780: 5f53 5441 5455 535f 5741 4954 2e66 6f72  _STATUS_WAIT.for
-00026790: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-000267a0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-000267b0: 7020 227b 6e61 6d65 7d22 207c 2067 7265  p "{name}" | gre
-000267c0: 7020 2246 4149 4c45 445f 494e 4954 4941  p "FAILED_INITIA
-000267d0: 4c5f 4445 4c41 5922 207c 2077 6320 2d6c  L_DELAY" | wc -l
-000267e0: 207c 2067 7265 7020 323b 2027 0a20 2020   | grep 2; '.   
-000267f0: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-00026800: 7375 7265 206e 6f20 6e65 7720 7265 706c  sure no new repl
-00026810: 6963 6173 2061 7265 2073 7461 7274 6564  icas are started
-00026820: 2066 6f72 2065 6172 6c79 2066 6169 6c75   for early failu
-00026830: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
-00026840: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
-00026850: 6570 202d 4120 3130 3020 2253 6572 7669  ep -A 100 "Servi
-00026860: 6365 2052 6570 6c69 6361 7322 207c 2067  ce Replicas" | g
-00026870: 7265 7020 227b 6e61 6d65 7d22 207c 2077  rep "{name}" | w
-00026880: 6320 2d6c 207c 2067 7265 7020 323b 272c  c -l | grep 2;',
-00026890: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000268a0: 6b79 2073 6572 7665 2075 7064 6174 6520  ky serve update 
-000268b0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-000268c0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-000268d0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
-000268e0: 2f66 6169 6c75 7265 732f 7072 6f62 696e  /failures/probin
-000268f0: 672e 7961 6d6c 272c 0a20 2020 2020 2020  g.yaml',.       
-00026900: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
-00026910: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
-00026920: 657d 293b 2027 0a20 2020 2020 2020 2020  e}); '.         
-00026930: 2020 2023 2057 6169 7420 666f 7220 7265     # Wait for re
-00026940: 706c 6963 6120 746f 2062 6520 7265 6164  plica to be read
-00026950: 792e 0a20 2020 2020 2020 2020 2020 2066  y..            f
-00026960: 2775 6e74 696c 2065 6368 6f20 2224 7322  'until echo "$s"
-00026970: 207c 2067 7265 7020 2252 4541 4459 223b   | grep "READY";
-00026980: 2064 6f20 270a 2020 2020 2020 2020 2020   do '.          
-00026990: 2020 2765 6368 6f20 2257 6169 7469 6e67    'echo "Waiting
-000269a0: 2066 6f72 2072 6570 6c69 6361 2074 6f20   for replica to 
-000269b0: 6265 2066 6169 6c65 642e 2e2e 223b 2073  be failed..."; s
-000269c0: 6c65 6570 2035 3b20 270a 2020 2020 2020  leep 5; '.      
-000269d0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-000269e0: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
-000269f0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-00026a00: 2064 6f6e 653b 272c 0a20 2020 2020 2020   done;',.       
-00026a10: 2020 2020 2023 2057 6169 7420 666f 7220       # Wait for 
-00026a20: 7265 706c 6963 6120 746f 2063 6861 6e67  replica to chang
-00026a30: 6520 746f 2046 4149 4c45 445f 5052 4f42  e to FAILED_PROB
-00026a40: 494e 470a 2020 2020 2020 2020 2020 2020  ING.            
-00026a50: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
-00026a60: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
-00026a70: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00026a80: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
-00026a90: 7c20 6772 6570 2022 4641 494c 4544 5f50  | grep "FAILED_P
-00026aa0: 524f 4249 4e47 223b 2064 6f20 270a 2020  ROBING"; do '.  
-00026ab0: 2020 2020 2020 2020 2020 2765 6368 6f20            'echo 
-00026ac0: 2257 6169 7469 6e67 2066 6f72 2072 6570  "Waiting for rep
-00026ad0: 6c69 6361 2074 6f20 6265 2066 6169 6c65  lica to be faile
-00026ae0: 642e 2e2e 223b 2073 6c65 6570 2035 3b20  d..."; sleep 5; 
-00026af0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00026b00: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00026b10: 6174 7573 207b 6e61 6d65 7d29 3b20 6563  atus {name}); ec
-00026b20: 686f 2022 2473 223b 2064 6f6e 653b 2720  ho "$s"; done;' 
-00026b30: 2b0a 2020 2020 2020 2020 2020 2020 5f63  +.            _c
-00026b40: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-00026b50: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
-00026b60: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
-00026b70: 312c 2046 616c 7365 2c20 2746 4149 4c45  1, False, 'FAILE
-00026b80: 445f 5052 4f42 494e 4727 292c 0a20 2020  D_PROBING'),.   
-00026b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ba0: 2020 2020 2831 2c20 4661 6c73 652c 205f      (1, False, _
-00026bb0: 5345 5256 4943 455f 4c41 554e 4348 494e  SERVICE_LAUNCHIN
-00026bc0: 475f 5354 4154 5553 5f52 4547 4558 295d  G_STATUS_REGEX)]
-00026bd0: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
-00026be0: 2054 4f44 4f28 7a68 7775 293a 2061 6464   TODO(zhwu): add
-00026bf0: 2074 6573 7420 666f 7220 4641 494c 4544   test for FAILED
-00026c00: 5f50 524f 5649 5349 4f4e 0a20 2020 2020  _PROVISION.     
-00026c10: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
-00026c20: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
-00026c30: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00026c40: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-00026c50: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-00026c60: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00026c70: 7374 2874 6573 7429 0a0a 0a23 2054 4f44  st(test)...# TOD
-00026c80: 4f28 5a69 6d69 6e67 2c20 5469 616e 293a  O(Ziming, Tian):
-00026c90: 2041 6464 2074 6573 7473 2066 6f72 2061   Add tests for a
-00026ca0: 7574 6f73 6361 6c69 6e67 2e0a 0a0a 2320  utoscaling....# 
-00026cb0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00026cc0: 7573 6572 2072 6179 2063 6c75 7374 6572  user ray cluster
-00026cd0: 202d 2d2d 2d2d 2d2d 2d0a 6465 6620 7465   --------.def te
-00026ce0: 7374 5f75 7365 725f 7261 795f 636c 7573  st_user_ray_clus
-00026cf0: 7465 7228 6765 6e65 7269 635f 636c 6f75  ter(generic_clou
-00026d00: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00026d10: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00026d20: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00026d30: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00026d40: 2027 7573 6572 2d72 6179 2d63 6c75 7374   'user-ray-clust
-00026d50: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
-00026d60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00026d70: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00026d80: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00026d90: 6e65 7269 635f 636c 6f75 647d 2022 7261  neric_cloud} "ra
-00026da0: 7920 7374 6172 7420 2d2d 6865 6164 2227  y start --head"'
-00026db0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00026dc0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00026dd0: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
-00026de0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00026df0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00026e00: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00026e10: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00026e20: 2d72 207b 6e61 6d65 7d20 7c20 6772 6570  -r {name} | grep
-00026e30: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
-00026e40: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00026e50: 6d65 7d20 2265 6368 6f20 6279 6522 272c  me} "echo bye"',
-00026e60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00026e70: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00026e80: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00026e90: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00026ea0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00026eb0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00026ec0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00026ed0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2054  t)...# ------- T
-00026ee0: 6573 7469 6e67 2074 6865 2063 6f72 6520  esting the core 
-00026ef0: 4150 4920 2d2d 2d2d 2d2d 2d2d 0a23 204d  API --------.# M
-00026f00: 6f73 7420 6f66 2074 6865 2063 6f72 6520  ost of the core 
-00026f10: 4150 4973 2068 6176 6520 6265 656e 2074  APIs have been t
-00026f20: 6573 7465 6420 696e 2074 6865 2043 4c49  ested in the CLI
-00026f30: 2074 6573 7473 2e0a 2320 5468 6573 6520   tests..# These 
-00026f40: 7465 7374 7320 6172 6520 666f 7220 7465  tests are for te
-00026f50: 7374 696e 6720 7468 6520 7265 7475 726e  sting the return
-00026f60: 2076 616c 7565 206f 6620 7468 6520 4150   value of the AP
-00026f70: 4973 206e 6f74 2066 756c 6c79 2075 7365  Is not fully use
-00026f80: 6420 696e 2043 4c49 2e0a 0a0a 4070 7974  d in CLI....@pyt
-00026f90: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
-00026fa0: 2074 6573 745f 636f 7265 5f61 7069 5f73   test_core_api_s
-00026fb0: 6b79 5f6c 6175 6e63 685f 6578 6563 2829  ky_launch_exec()
-00026fc0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00026fd0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00026fe0: 0a20 2020 2074 6173 6b20 3d20 736b 792e  .    task = sky.
-00026ff0: 5461 736b 2872 756e 3d22 7768 6f61 6d69  Task(run="whoami
-00027000: 2229 0a20 2020 2074 6173 6b2e 7365 745f  ").    task.set_
-00027010: 7265 736f 7572 6365 7328 736b 792e 5265  resources(sky.Re
-00027020: 736f 7572 6365 7328 636c 6f75 643d 736b  sources(cloud=sk
-00027030: 792e 4743 5028 2929 290a 2020 2020 6a6f  y.GCP())).    jo
-00027040: 625f 6964 2c20 6861 6e64 6c65 203d 2073  b_id, handle = s
-00027050: 6b79 2e6c 6175 6e63 6828 7461 736b 2c20  ky.launch(task, 
-00027060: 636c 7573 7465 725f 6e61 6d65 3d6e 616d  cluster_name=nam
-00027070: 6529 0a20 2020 2061 7373 6572 7420 6a6f  e).    assert jo
-00027080: 625f 6964 203d 3d20 310a 2020 2020 6173  b_id == 1.    as
-00027090: 7365 7274 2068 616e 646c 6520 6973 206e  sert handle is n
-000270a0: 6f74 204e 6f6e 650a 2020 2020 6173 7365  ot None.    asse
-000270b0: 7274 2068 616e 646c 652e 636c 7573 7465  rt handle.cluste
-000270c0: 725f 6e61 6d65 203d 3d20 6e61 6d65 0a20  r_name == name. 
-000270d0: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
-000270e0: 2e6c 6175 6e63 6865 645f 7265 736f 7572  .launched_resour
-000270f0: 6365 732e 636c 6f75 642e 6973 5f73 616d  ces.cloud.is_sam
-00027100: 655f 636c 6f75 6428 736b 792e 4743 5028  e_cloud(sky.GCP(
-00027110: 2929 0a20 2020 206a 6f62 5f69 645f 6578  )).    job_id_ex
-00027120: 6563 2c20 6861 6e64 6c65 5f65 7865 6320  ec, handle_exec 
-00027130: 3d20 736b 792e 6578 6563 2874 6173 6b2c  = sky.exec(task,
-00027140: 2063 6c75 7374 6572 5f6e 616d 653d 6e61   cluster_name=na
-00027150: 6d65 290a 2020 2020 6173 7365 7274 206a  me).    assert j
-00027160: 6f62 5f69 645f 6578 6563 203d 3d20 320a  ob_id_exec == 2.
-00027170: 2020 2020 6173 7365 7274 2068 616e 646c      assert handl
-00027180: 655f 6578 6563 2069 7320 6e6f 7420 4e6f  e_exec is not No
-00027190: 6e65 0a20 2020 2061 7373 6572 7420 6861  ne.    assert ha
-000271a0: 6e64 6c65 5f65 7865 632e 636c 7573 7465  ndle_exec.cluste
-000271b0: 725f 6e61 6d65 203d 3d20 6e61 6d65 0a20  r_name == name. 
-000271c0: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
-000271d0: 5f65 7865 632e 6c61 756e 6368 6564 5f72  _exec.launched_r
-000271e0: 6573 6f75 7263 6573 2e63 6c6f 7564 2e69  esources.cloud.i
-000271f0: 735f 7361 6d65 5f63 6c6f 7564 2873 6b79  s_same_cloud(sky
-00027200: 2e47 4350 2829 290a 2020 2020 2320 466f  .GCP()).    # Fo
-00027210: 7220 6475 6d6d 7920 7461 736b 2028 692e  r dummy task (i.
-00027220: 652e 2074 6173 6b2e 7275 6e20 6973 204e  e. task.run is N
-00027230: 6f6e 6529 2c20 7468 6520 6a6f 6220 776f  one), the job wo
-00027240: 6e27 7420 6265 2073 7562 6d69 7474 6564  n't be submitted
-00027250: 2e0a 2020 2020 6475 6d6d 795f 7461 736b  ..    dummy_task
-00027260: 203d 2073 6b79 2e54 6173 6b28 290a 2020   = sky.Task().  
-00027270: 2020 6a6f 625f 6964 5f64 756d 6d79 2c20    job_id_dummy, 
-00027280: 5f20 3d20 736b 792e 6578 6563 2864 756d  _ = sky.exec(dum
-00027290: 6d79 5f74 6173 6b2c 2063 6c75 7374 6572  my_task, cluster
-000272a0: 5f6e 616d 653d 6e61 6d65 290a 2020 2020  _name=name).    
-000272b0: 6173 7365 7274 206a 6f62 5f69 645f 6475  assert job_id_du
-000272c0: 6d6d 7920 6973 204e 6f6e 650a 2020 2020  mmy is None.    
-000272d0: 736b 792e 646f 776e 286e 616d 6529 0a0a  sky.down(name)..
-000272e0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-000272f0: 7374 696e 6720 5374 6f72 6167 6520 2d2d  sting Storage --
-00027300: 2d2d 2d2d 2d2d 2d2d 0a63 6c61 7373 2054  --------.class T
-00027310: 6573 7453 746f 7261 6765 5769 7468 4372  estStorageWithCr
-00027320: 6564 656e 7469 616c 733a 0a20 2020 2022  edentials:.    "
-00027330: 2222 5374 6f72 6167 6520 7465 7374 7320  ""Storage tests 
-00027340: 7768 6963 6820 7265 7175 6972 6520 6372  which require cr
-00027350: 6564 656e 7469 616c 7320 616e 6420 6e65  edentials and ne
-00027360: 7477 6f72 6b20 636f 6e6e 6563 7469 6f6e  twork connection
-00027370: 2222 220a 0a20 2020 2041 5753 5f49 4e56  """..    AWS_INV
-00027380: 414c 4944 5f4e 414d 4553 203d 205b 0a20  ALID_NAMES = [. 
-00027390: 2020 2020 2020 2027 6162 272c 2020 2320         'ab',  # 
-000273a0: 6c65 7373 2074 6861 6e20 3320 6368 6172  less than 3 char
-000273b0: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
-000273c0: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-000273d0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
-000273e0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
-000273f0: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
-00027400: 6d6e 6f70 7172 7374 7576 7778 797a 3127  mnopqrstuvwxyz1'
-00027410: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
-00027420: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
-00027430: 6572 730a 2020 2020 2020 2020 2741 6263  ers.        'Abc
-00027440: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
-00027450: 7320 616e 2075 7070 6572 6361 7365 206c  s an uppercase l
-00027460: 6574 7465 720a 2020 2020 2020 2020 2761  etter.        'a
-00027470: 6263 2064 6566 272c 2020 2320 636f 6e74  bc def',  # cont
-00027480: 6169 6e73 2061 2073 7061 6365 0a20 2020  ains a space.   
-00027490: 2020 2020 2027 6162 632e 2e64 6566 272c       'abc..def',
-000274a0: 2020 2320 7477 6f20 6164 6a61 6365 6e74    # two adjacent
-000274b0: 2070 6572 696f 6473 0a20 2020 2020 2020   periods.       
-000274c0: 2027 3139 322e 3136 382e 352e 3427 2c20   '192.168.5.4', 
-000274d0: 2023 2066 6f72 6d61 7474 6564 2061 7320   # formatted as 
-000274e0: 616e 2049 5020 6164 6472 6573 730a 2020  an IP address.  
-000274f0: 2020 2020 2020 2778 6e2d 2d62 7563 6b65        'xn--bucke
-00027500: 7427 2c20 2023 2073 7461 7274 7320 7769  t',  # starts wi
-00027510: 7468 2027 786e 2d2d 2720 7072 6566 6978  th 'xn--' prefix
-00027520: 0a20 2020 2020 2020 2027 6275 636b 6574  .        'bucket
-00027530: 2d73 3361 6c69 6173 272c 2020 2320 656e  -s3alias',  # en
-00027540: 6473 2077 6974 6820 272d 7333 616c 6961  ds with '-s3alia
-00027550: 7327 2073 7566 6669 780a 2020 2020 2020  s' suffix.      
-00027560: 2020 2762 7563 6b65 742d 2d6f 6c2d 7333    'bucket--ol-s3
-00027570: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
-00027580: 272d 2d6f 6c2d 7333 2720 7375 6666 6978  '--ol-s3' suffix
-00027590: 0a20 2020 2020 2020 2027 2e61 6263 272c  .        '.abc',
-000275a0: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
-000275b0: 6120 646f 740a 2020 2020 2020 2020 2761  a dot.        'a
-000275c0: 6263 2e27 2c20 2023 2065 6e64 7320 7769  bc.',  # ends wi
-000275d0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-000275e0: 2027 2d61 6263 272c 2020 2320 7374 6172   '-abc',  # star
-000275f0: 7473 2077 6974 6820 6120 6879 7068 656e  ts with a hyphen
-00027600: 0a20 2020 2020 2020 2027 6162 632d 272c  .        'abc-',
-00027610: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
-00027620: 6879 7068 656e 0a20 2020 205d 0a0a 2020  hyphen.    ]..  
-00027630: 2020 4743 535f 494e 5641 4c49 445f 4e41    GCS_INVALID_NA
-00027640: 4d45 5320 3d20 5b0a 2020 2020 2020 2020  MES = [.        
-00027650: 2761 6227 2c20 2023 206c 6573 7320 7468  'ab',  # less th
-00027660: 616e 2033 2063 6861 7261 6374 6572 730a  an 3 characters.
-00027670: 2020 2020 2020 2020 2761 6263 6465 6667          'abcdefg
-00027680: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00027690: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
-000276a0: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-000276b0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-000276c0: 7475 7677 7879 7a31 272c 0a20 2020 2020  tuvwxyz1',.     
-000276d0: 2020 2023 206d 6f72 6520 7468 616e 2036     # more than 6
-000276e0: 3320 6368 6172 6163 7465 7273 2028 7769  3 characters (wi
-000276f0: 7468 6f75 7420 646f 7473 290a 2020 2020  thout dots).    
-00027700: 2020 2020 2741 6263 6465 6627 2c20 2023      'Abcdef',  #
-00027710: 2063 6f6e 7461 696e 7320 616e 2075 7070   contains an upp
-00027720: 6572 6361 7365 206c 6574 7465 720a 2020  ercase letter.  
-00027730: 2020 2020 2020 2761 6263 2064 6566 272c        'abc def',
-00027740: 2020 2320 636f 6e74 6169 6e73 2061 2073    # contains a s
-00027750: 7061 6365 0a20 2020 2020 2020 2027 6162  pace.        'ab
-00027760: 632e 2e64 6566 272c 2020 2320 7477 6f20  c..def',  # two 
-00027770: 6164 6a61 6365 6e74 2070 6572 696f 6473  adjacent periods
-00027780: 0a20 2020 2020 2020 2027 6162 635f 2e64  .        'abc_.d
-00027790: 6566 2e67 6869 2e6a 6b6c 6d6e 6f70 7172  ef.ghi.jklmnopqr
-000277a0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-000277b0: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
-000277c0: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
-000277d0: 6f70 7172 7374 7576 7778 797a 3127 0a20  opqrstuvwxyz1'. 
-000277e0: 2020 2020 2020 2023 204d 6f72 6520 7468         # More th
-000277f0: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
-00027800: 2062 6574 7765 656e 2064 6f74 730a 2020   between dots.  
-00027810: 2020 2020 2020 2761 6263 5f2e 6465 662e        'abc_.def.
-00027820: 6768 692e 6a6b 6c6d 6e6f 7071 7273 7475  ghi.jklmnopqrstu
-00027830: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00027840: 6c6d 6e6f 7071 6667 6869 6a6b 6c6d 6e6f  lmnopqfghijklmno
-00027850: 7071 7273 7475 7677 2720 2a20 352c 0a20  pqrstuvw' * 5,. 
-00027860: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
-00027870: 616e 2032 3232 2063 6861 7261 6374 6572  an 222 character
-00027880: 7320 2877 6974 6820 646f 7473 290a 2020  s (with dots).  
-00027890: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
-000278a0: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
-000278b0: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
-000278c0: 7373 0a20 2020 2020 2020 2027 676f 6f67  ss.        'goog
-000278d0: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
-000278e0: 7473 2077 6974 6820 2767 6f6f 6727 2070  ts with 'goog' p
-000278f0: 7265 6669 780a 2020 2020 2020 2020 2767  refix.        'g
-00027900: 6f6f 676c 6562 7563 6b65 7427 2c20 2023  ooglebucket',  #
-00027910: 2063 6f6e 7461 696e 7320 2767 6f6f 676c   contains 'googl
-00027920: 6527 0a20 2020 2020 2020 2027 6730 3067  e'.        'g00g
-00027930: 6c65 6275 636b 6574 272c 2020 2320 7661  lebucket',  # va
-00027940: 7269 616e 7420 6f66 2027 676f 6f67 6c65  riant of 'google
-00027950: 270a 2020 2020 2020 2020 2767 6f30 676c  '.        'go0gl
-00027960: 6562 7563 6b65 7427 2c20 2023 2076 6172  ebucket',  # var
-00027970: 6961 6e74 206f 6620 2767 6f6f 676c 6527  iant of 'google'
-00027980: 0a20 2020 2020 2020 2027 6730 6f67 6c65  .        'g0ogle
-00027990: 6275 636b 6574 272c 2020 2320 7661 7269  bucket',  # vari
-000279a0: 616e 7420 6f66 2027 676f 6f67 6c65 270a  ant of 'google'.
-000279b0: 2020 2020 2020 2020 272e 6162 6327 2c20          '.abc', 
-000279c0: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
-000279d0: 2064 6f74 0a20 2020 2020 2020 2027 6162   dot.        'ab
-000279e0: 632e 272c 2020 2320 656e 6473 2077 6974  c.',  # ends wit
-000279f0: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
-00027a00: 275f 6162 6327 2c20 2023 2073 7461 7274  '_abc',  # start
-00027a10: 7320 7769 7468 2061 6e20 756e 6465 7273  s with an unders
-00027a20: 636f 7265 0a20 2020 2020 2020 2027 6162  core.        'ab
-00027a30: 635f 272c 2020 2320 656e 6473 2077 6974  c_',  # ends wit
-00027a40: 6820 616e 2075 6e64 6572 7363 6f72 650a  h an underscore.
-00027a50: 2020 2020 5d0a 0a20 2020 2049 424d 5f49      ]..    IBM_I
-00027a60: 4e56 414c 4944 5f4e 414d 4553 203d 205b  NVALID_NAMES = [
-00027a70: 0a20 2020 2020 2020 2027 6162 272c 2020  .        'ab',  
-00027a80: 2320 6c65 7373 2074 6861 6e20 3320 6368  # less than 3 ch
-00027a90: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
-00027aa0: 2027 6162 6364 6566 6768 696a 6b6c 6d6e   'abcdefghijklmn
-00027ab0: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
-00027ac0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
-00027ad0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00027ae0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00027af0: 3127 2c0a 2020 2020 2020 2020 2320 6d6f  1',.        # mo
-00027b00: 7265 2074 6861 6e20 3633 2063 6861 7261  re than 63 chara
-00027b10: 6374 6572 730a 2020 2020 2020 2020 2741  cters.        'A
-00027b20: 6263 6465 6627 2c20 2023 2063 6f6e 7461  bcdef',  # conta
-00027b30: 696e 7320 616e 2075 7070 6572 6361 7365  ins an uppercase
-00027b40: 206c 6574 7465 720a 2020 2020 2020 2020   letter.        
-00027b50: 2761 6263 2064 6566 272c 2020 2320 636f  'abc def',  # co
-00027b60: 6e74 6169 6e73 2061 2073 7061 6365 0a20  ntains a space. 
-00027b70: 2020 2020 2020 2027 6162 632e 2e64 6566         'abc..def
-00027b80: 272c 2020 2320 7477 6f20 6164 6a61 6365  ',  # two adjace
-00027b90: 6e74 2070 6572 696f 6473 0a20 2020 2020  nt periods.     
-00027ba0: 2020 2027 3139 322e 3136 382e 352e 3427     '192.168.5.4'
-00027bb0: 2c20 2023 2066 6f72 6d61 7474 6564 2061  ,  # formatted a
-00027bc0: 7320 616e 2049 5020 6164 6472 6573 730a  s an IP address.
-00027bd0: 2020 2020 2020 2020 2778 6e2d 2d62 7563          'xn--buc
-00027be0: 6b65 7427 2c20 2023 2073 7461 7274 7320  ket',  # starts 
-00027bf0: 7769 7468 2027 786e 2d2d 2720 7072 6566  with 'xn--' pref
-00027c00: 6978 0a20 2020 2020 2020 2027 2e61 6263  ix.        '.abc
-00027c10: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-00027c20: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
-00027c30: 2761 6263 2e27 2c20 2023 2065 6e64 7320  'abc.',  # ends 
-00027c40: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00027c50: 2020 2027 2d61 6263 272c 2020 2320 7374     '-abc',  # st
-00027c60: 6172 7473 2077 6974 6820 6120 6879 7068  arts with a hyph
-00027c70: 656e 0a20 2020 2020 2020 2027 6162 632d  en.        'abc-
-00027c80: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
-00027c90: 6120 6879 7068 656e 0a20 2020 2020 2020  a hyphen.       
-00027ca0: 2027 612e 2d62 6327 2c20 2023 2063 6f6e   'a.-bc',  # con
-00027cb0: 7461 696e 7320 7468 6520 7365 7175 656e  tains the sequen
-00027cc0: 6365 2027 2e2d 270a 2020 2020 2020 2020  ce '.-'.        
-00027cd0: 2761 2d2e 6263 272c 2020 2320 636f 6e74  'a-.bc',  # cont
-00027ce0: 6169 6e73 2074 6865 2073 6571 7565 6e63  ains the sequenc
-00027cf0: 6520 272d 2e27 0a20 2020 2020 2020 2027  e '-.'.        '
-00027d00: 6126 6263 2720 2023 2063 6f6e 7461 696e  a&bc'  # contain
-00027d10: 7320 7370 6563 6961 6c20 6368 6172 6163  s special charac
-00027d20: 7465 7273 0a20 2020 2020 2020 2027 6162  ters.        'ab
-00027d30: 5e63 2720 2023 2063 6f6e 7461 696e 7320  ^c'  # contains 
-00027d40: 7370 6563 6961 6c20 6368 6172 6163 7465  special characte
-00027d50: 7273 0a20 2020 205d 0a20 2020 2047 4954  rs.    ].    GIT
-00027d60: 4947 4e4f 5245 5f53 594e 435f 5445 5354  IGNORE_SYNC_TEST
-00027d70: 5f44 4952 5f53 5452 5543 5455 5245 203d  _DIR_STRUCTURE =
-00027d80: 207b 0a20 2020 2020 2020 2027 646f 7562   {.        'doub
-00027d90: 6c65 5f61 7374 6572 6973 6b27 3a20 7b0a  le_asterisk': {.
-00027da0: 2020 2020 2020 2020 2020 2020 2764 6f75              'dou
-00027db0: 626c 655f 6173 7465 7269 736b 5f65 7863  ble_asterisk_exc
-00027dc0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
-00027dd0: 2020 2020 2020 2020 2020 2764 6f75 626c            'doubl
-00027de0: 655f 6173 7465 7269 736b 5f65 7863 6c75  e_asterisk_exclu
-00027df0: 6465 645f 6469 7227 3a20 7b0a 2020 2020  ded_dir': {.    
-00027e00: 2020 2020 2020 2020 2020 2020 2764 6972              'dir
-00027e10: 5f65 7863 6c75 6465 6427 3a20 4e6f 6e65  _excluded': None
-00027e20: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00027e30: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00027e40: 2020 2020 2764 6f75 626c 655f 6173 7465      'double_aste
-00027e50: 7269 736b 5f70 6172 656e 7427 3a20 7b0a  risk_parent': {.
-00027e60: 2020 2020 2020 2020 2020 2020 2770 6172              'par
-00027e70: 656e 7427 3a20 7b0a 2020 2020 2020 2020  ent': {.        
-00027e80: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
-00027e90: 636c 7564 6564 2e74 7874 273a 204e 6f6e  cluded.txt': Non
-00027ea0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00027eb0: 2020 2027 6368 696c 6427 3a20 7b0a 2020     'child': {.  
-00027ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ed0: 2020 2764 6f75 626c 655f 6173 7465 7269    'double_asteri
-00027ee0: 736b 5f70 6172 656e 745f 6368 696c 645f  sk_parent_child_
-00027ef0: 6578 636c 7564 6564 2e74 7874 273a 204e  excluded.txt': N
-00027f00: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00027f10: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00027f20: 2020 2020 2020 2020 2764 6f75 626c 655f          'double_
-00027f30: 6173 7465 7269 736b 5f70 6172 656e 745f  asterisk_parent_
-00027f40: 6578 636c 7564 6564 2e74 7874 273a 204e  excluded.txt': N
-00027f50: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00027f60: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
-00027f70: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-00027f80: 2e6c 6f67 273a 204e 6f6e 652c 0a20 2020  .log': None,.   
-00027f90: 2020 2020 2027 6578 636c 7564 6564 5f64       'excluded_d
-00027fa0: 6972 273a 207b 0a20 2020 2020 2020 2020  ir': {.         
-00027fb0: 2020 2027 6578 636c 7564 6564 2e74 7874     'excluded.txt
-00027fc0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00027fd0: 2020 2020 2027 6e65 7374 6564 5f65 7863       'nested_exc
-00027fe0: 6c75 6465 6427 3a20 7b0a 2020 2020 2020  luded': {.      
-00027ff0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-00028000: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
-00028010: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00028020: 2020 207d 2c0a 2020 2020 2020 2020 2765     },.        'e
-00028030: 7870 2d31 273a 207b 0a20 2020 2020 2020  xp-1': {.       
-00028040: 2020 2020 2027 6265 5f65 7863 6c75 6465       'be_exclude
-00028050: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
-00028060: 2020 7d2c 0a20 2020 2020 2020 2027 6578    },.        'ex
-00028070: 702d 3227 3a20 7b0a 2020 2020 2020 2020  p-2': {.        
-00028080: 2020 2020 2762 655f 6578 636c 7564 6564      'be_excluded
-00028090: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-000280a0: 207d 2c0a 2020 2020 2020 2020 2766 726f   },.        'fro
-000280b0: 6e74 5f73 6c61 7368 5f65 7863 6c75 6465  nt_slash_exclude
-000280c0: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
-000280d0: 2020 2769 6e63 6c75 6465 642e 6c6f 6727    'included.log'
-000280e0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-000280f0: 2769 6e63 6c75 6465 642e 7478 7427 3a20  'included.txt': 
-00028100: 4e6f 6e65 2c0a 2020 2020 2020 2020 2769  None,.        'i
-00028110: 6e63 6c75 6465 5f64 6972 273a 207b 0a20  nclude_dir': {. 
-00028120: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
-00028130: 7564 6564 2e6c 6f67 273a 204e 6f6e 652c  uded.log': None,
-00028140: 0a20 2020 2020 2020 2020 2020 2027 696e  .            'in
-00028150: 636c 7564 6564 2e6c 6f67 273a 204e 6f6e  cluded.log': Non
-00028160: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
-00028170: 2020 2020 2020 276e 6573 7465 645f 646f        'nested_do
-00028180: 7562 6c65 5f61 7374 6572 6973 6b27 3a20  uble_asterisk': 
-00028190: 7b0a 2020 2020 2020 2020 2020 2020 276f  {.            'o
-000281a0: 6e65 273a 207b 0a20 2020 2020 2020 2020  ne': {.         
-000281b0: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
-000281c0: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
-000281d0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-000281e0: 2020 2020 2020 2020 2020 2020 2774 776f              'two
-000281f0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00028200: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-00028210: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
-00028220: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00028230: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00028240: 2027 6e65 7374 6564 5f77 696c 6463 6172   'nested_wildcar
-00028250: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
-00028260: 2020 2020 2020 276d 6f6e 6461 7927 3a20        'monday': 
-00028270: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00028280: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
-00028290: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-000282a0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-000282b0: 2020 2020 2020 2027 7475 6573 6461 7927         'tuesday'
-000282c0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-000282d0: 2020 2020 2761 6c73 6f5f 6578 636c 7564      'also_exclud
-000282e0: 652e 7478 7427 3a20 4e6f 6e65 2c0a 2020  e.txt': None,.  
-000282f0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00028300: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00028310: 276e 6f5f 736c 6173 685f 6578 636c 7564  'no_slash_exclud
-00028320: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
-00028330: 2020 2027 6e6f 5f73 6c61 7368 5f74 6573     'no_slash_tes
-00028340: 7473 273a 207b 0a20 2020 2020 2020 2020  ts': {.         
-00028350: 2020 2027 6e6f 5f73 6c61 7368 5f65 7863     'no_slash_exc
-00028360: 6c75 6465 6427 3a20 7b0a 2020 2020 2020  luded': {.      
-00028370: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
-00028380: 6578 636c 7564 6564 2e74 7874 273a 204e  excluded.txt': N
-00028390: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000283a0: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
-000283b0: 2020 2020 2020 2027 7175 6573 7469 6f6e         'question
-000283c0: 5f6d 6172 6b27 3a20 7b0a 2020 2020 2020  _mark': {.      
-000283d0: 2020 2020 2020 2765 7863 6c75 6465 6431        'excluded1
-000283e0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-000283f0: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00028400: 6564 402e 7478 7427 3a20 4e6f 6e65 2c0a  ed@.txt': None,.
-00028410: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00028420: 2020 2027 7371 7561 7265 5f62 7261 636b     'square_brack
-00028430: 6574 273a 207b 0a20 2020 2020 2020 2020  et': {.         
-00028440: 2020 2027 6578 636c 7564 6564 312e 7478     'excluded1.tx
-00028450: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00028460: 2020 7d2c 0a20 2020 2020 2020 2027 7371    },.        'sq
-00028470: 7561 7265 5f62 7261 636b 6574 5f61 6c70  uare_bracket_alp
-00028480: 6861 273a 207b 0a20 2020 2020 2020 2020  ha': {.         
-00028490: 2020 2027 6578 636c 7564 6564 7a2e 7478     'excludedz.tx
-000284a0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-000284b0: 2020 7d2c 0a20 2020 2020 2020 2027 7371    },.        'sq
-000284c0: 7561 7265 5f62 7261 636b 6574 5f65 7863  uare_bracket_exc
-000284d0: 6c61 273a 207b 0a20 2020 2020 2020 2020  la': {.         
-000284e0: 2020 2027 6578 636c 7564 6564 322e 7478     'excluded2.tx
-000284f0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-00028500: 2020 2020 2020 2765 7863 6c75 6465 6440        'excluded@
-00028510: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00028520: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00028530: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-00028540: 7369 6e67 6c65 273a 207b 0a20 2020 2020  single': {.     
-00028550: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-00028560: 302e 7478 7427 3a20 4e6f 6e65 2c0a 2020  0.txt': None,.  
-00028570: 2020 2020 2020 7d2c 0a20 2020 207d 0a0a        },.    }..
-00028580: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00028590: 640a 2020 2020 6465 6620 6372 6561 7465  d.    def create
-000285a0: 5f64 6972 5f73 7472 7563 7475 7265 2862  _dir_structure(b
-000285b0: 6173 655f 7061 7468 2c20 7374 7275 6374  ase_path, struct
-000285c0: 7572 6529 3a0a 2020 2020 2020 2020 2320  ure):.        # 
-000285d0: 6372 6561 7465 7320 6120 6769 7665 6e20  creates a given 
-000285e0: 6669 6c65 2053 5452 5543 5455 5245 2069  file STRUCTURE i
-000285f0: 6e20 4241 5345 5f50 4154 480a 2020 2020  n BASE_PATH.    
-00028600: 2020 2020 666f 7220 6e61 6d65 2c20 7375      for name, su
-00028610: 6273 7472 7563 7475 7265 2069 6e20 7374  bstructure in st
-00028620: 7275 6374 7572 652e 6974 656d 7328 293a  ructure.items():
-00028630: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-00028640: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
-00028650: 2862 6173 655f 7061 7468 2c20 6e61 6d65  (base_path, name
-00028660: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00028670: 2073 7562 7374 7275 6374 7572 6520 6973   substructure is
-00028680: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00028690: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-000286a0: 6120 6669 6c65 0a20 2020 2020 2020 2020  a file.         
-000286b0: 2020 2020 2020 206f 7065 6e28 7061 7468         open(path
-000286c0: 2c20 2761 272c 2065 6e63 6f64 696e 673d  , 'a', encoding=
-000286d0: 2775 7466 2d38 2729 2e63 6c6f 7365 2829  'utf-8').close()
-000286e0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000286f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00028700: 2020 2023 2043 7265 6174 6520 6120 7375     # Create a su
-00028710: 6264 6972 6563 746f 7279 0a20 2020 2020  bdirectory.     
-00028720: 2020 2020 2020 2020 2020 206f 732e 6d6b             os.mk
-00028730: 6469 7228 7061 7468 290a 2020 2020 2020  dir(path).      
-00028740: 2020 2020 2020 2020 2020 5465 7374 5374            TestSt
-00028750: 6f72 6167 6557 6974 6843 7265 6465 6e74  orageWithCredent
-00028760: 6961 6c73 2e63 7265 6174 655f 6469 725f  ials.create_dir_
-00028770: 7374 7275 6374 7572 6528 0a20 2020 2020  structure(.     
-00028780: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00028790: 6174 682c 2073 7562 7374 7275 6374 7572  ath, substructur
-000287a0: 6529 0a0a 2020 2020 4073 7461 7469 636d  e)..    @staticm
-000287b0: 6574 686f 640a 2020 2020 6465 6620 636c  ethod.    def cl
-000287c0: 695f 6465 6c65 7465 5f63 6d64 2873 746f  i_delete_cmd(sto
-000287d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
-000287e0: 6e61 6d65 293a 0a20 2020 2020 2020 2069  name):.        i
-000287f0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-00028800: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00028810: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
-00028820: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-00028830: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-00028840: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-00028850: 7475 726e 2066 2761 7773 2073 3320 7262  turn f'aws s3 rb
-00028860: 207b 7572 6c7d 202d 2d66 6f72 6365 270a   {url} --force'.
-00028870: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-00028880: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-00028890: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-000288a0: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
-000288b0: 7572 6c20 3d20 6627 6773 3a2f 2f7b 6275  url = f'gs://{bu
-000288c0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
-000288d0: 2020 2020 2020 2020 6773 7574 696c 5f61          gsutil_a
-000288e0: 6c69 6173 2c20 616c 6961 735f 6765 6e20  lias, alias_gen 
-000288f0: 3d20 6461 7461 5f75 7469 6c73 2e67 6574  = data_utils.get
-00028900: 5f67 7375 7469 6c5f 636f 6d6d 616e 6428  _gsutil_command(
-00028910: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00028920: 7475 726e 2066 277b 616c 6961 735f 6765  turn f'{alias_ge
-00028930: 6e7d 3b20 7b67 7375 7469 6c5f 616c 6961  n}; {gsutil_alia
-00028940: 737d 2072 6d20 2d72 207b 7572 6c7d 270a  s} rm -r {url}'.
-00028950: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-00028960: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-00028970: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-00028980: 323a 0a20 2020 2020 2020 2020 2020 2065  2:.            e
-00028990: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
-000289a0: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
-000289b0: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
-000289c0: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-000289d0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-000289e0: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-000289f0: 6574 7572 6e20 6627 4157 535f 5348 4152  eturn f'AWS_SHAR
-00028a00: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
-00028a10: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
-00028a20: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
-00028a30: 4154 487d 2061 7773 2073 3320 7262 207b  ATH} aws s3 rb {
-00028a40: 7572 6c7d 202d 2d66 6f72 6365 202d 2d65  url} --force --e
-00028a50: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-00028a60: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-00028a70: 3d72 3227 0a20 2020 2020 2020 2069 6620  =r2'.        if 
-00028a80: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
-00028a90: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00028aa0: 7970 652e 4942 4d3a 0a20 2020 2020 2020  ype.IBM:.       
-00028ab0: 2020 2020 2062 7563 6b65 745f 7263 6c6f       bucket_rclo
-00028ac0: 6e65 5f70 726f 6669 6c65 203d 2052 636c  ne_profile = Rcl
-00028ad0: 6f6e 652e 6765 6e65 7261 7465 5f72 636c  one.generate_rcl
-00028ae0: 6f6e 655f 6275 636b 6574 5f70 726f 6669  one_bucket_profi
-00028af0: 6c65 5f6e 616d 6528 0a20 2020 2020 2020  le_name(.       
-00028b00: 2020 2020 2020 2020 2062 7563 6b65 745f           bucket_
-00028b10: 6e61 6d65 2c20 5263 6c6f 6e65 2e52 636c  name, Rclone.Rcl
-00028b20: 6f6e 6543 6c6f 7564 732e 4942 4d29 0a20  oneClouds.IBM). 
-00028b30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00028b40: 6e20 6627 7263 6c6f 6e65 2070 7572 6765  n f'rclone purge
-00028b50: 207b 6275 636b 6574 5f72 636c 6f6e 655f   {bucket_rclone_
-00028b60: 7072 6f66 696c 657d 3a7b 6275 636b 6574  profile}:{bucket
-00028b70: 5f6e 616d 657d 2026 2620 7263 6c6f 6e65  _name} && rclone
-00028b80: 2063 6f6e 6669 6720 6465 6c65 7465 207b   config delete {
-00028b90: 6275 636b 6574 5f72 636c 6f6e 655f 7072  bucket_rclone_pr
-00028ba0: 6f66 696c 657d 270a 0a20 2020 2040 7374  ofile}'..    @st
-00028bb0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-00028bc0: 6566 2063 6c69 5f6c 735f 636d 6428 7374  ef cli_ls_cmd(st
-00028bd0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-00028be0: 5f6e 616d 652c 2073 7566 6669 783d 2727  _name, suffix=''
-00028bf0: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
-00028c00: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00028c10: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00028c20: 652e 5333 3a0a 2020 2020 2020 2020 2020  e.S3:.          
-00028c30: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
-00028c40: 2020 2020 2020 2020 2020 2020 2075 726c               url
-00028c50: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
-00028c60: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
-00028c70: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-00028c80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00028c90: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
-00028ca0: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
-00028cb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00028cc0: 726e 2066 2761 7773 2073 3320 6c73 207b  rn f'aws s3 ls {
-00028cd0: 7572 6c7d 270a 2020 2020 2020 2020 6966  url}'.        if
-00028ce0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-00028cf0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00028d00: 5479 7065 2e47 4353 3a0a 2020 2020 2020  Type.GCS:.      
-00028d10: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
-00028d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028d30: 2075 726c 203d 2066 2767 733a 2f2f 7b62   url = f'gs://{b
-00028d40: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
-00028d50: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
-00028d60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00028d70: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
-00028d80: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
-00028d90: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
-00028da0: 7265 7475 726e 2066 2767 7375 7469 6c20  return f'gsutil 
-00028db0: 6c73 207b 7572 6c7d 270a 2020 2020 2020  ls {url}'.      
-00028dc0: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-00028dd0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00028de0: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
-00028df0: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
-00028e00: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
-00028e10: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
-00028e20: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
-00028e30: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
-00028e40: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
-00028e50: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
-00028e60: 5f6e 616d 657d 2f7b 7375 6666 6978 7d27  _name}/{suffix}'
-00028e70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00028e80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00028e90: 2020 2075 726c 203d 2066 2773 333a 2f2f     url = f's3://
-00028ea0: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-00028eb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00028ec0: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
-00028ed0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
-00028ee0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
-00028ef0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
-00028f00: 2061 7773 2073 3320 6c73 207b 7572 6c7d   aws s3 ls {url}
-00028f10: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-00028f20: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-00028f30: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
-00028f40: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-00028f50: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00028f60: 6f72 6554 7970 652e 4942 4d3a 0a20 2020  oreType.IBM:.   
-00028f70: 2020 2020 2020 2020 2062 7563 6b65 745f           bucket_
-00028f80: 7263 6c6f 6e65 5f70 726f 6669 6c65 203d  rclone_profile =
-00028f90: 2052 636c 6f6e 652e 6765 6e65 7261 7465   Rclone.generate
-00028fa0: 5f72 636c 6f6e 655f 6275 636b 6574 5f70  _rclone_bucket_p
-00028fb0: 726f 6669 6c65 5f6e 616d 6528 0a20 2020  rofile_name(.   
-00028fc0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
-00028fd0: 6b65 745f 6e61 6d65 2c20 5263 6c6f 6e65  ket_name, Rclone
-00028fe0: 2e52 636c 6f6e 6543 6c6f 7564 732e 4942  .RcloneClouds.IB
-00028ff0: 4d29 0a20 2020 2020 2020 2020 2020 2072  M).            r
-00029000: 6574 7572 6e20 6627 7263 6c6f 6e65 206c  eturn f'rclone l
-00029010: 7320 7b62 7563 6b65 745f 7263 6c6f 6e65  s {bucket_rclone
-00029020: 5f70 726f 6669 6c65 7d3a 7b62 7563 6b65  _profile}:{bucke
-00029030: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
-00029040: 270a 0a20 2020 2040 7374 6174 6963 6d65  '..    @staticme
-00029050: 7468 6f64 0a20 2020 2064 6566 2063 6c69  thod.    def cli
-00029060: 5f72 6567 696f 6e5f 636d 6428 7374 6f72  _region_cmd(stor
-00029070: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
-00029080: 616d 6529 3a0a 2020 2020 2020 2020 6966  ame):.        if
-00029090: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-000290a0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-000290b0: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
-000290c0: 2020 2020 2072 6574 7572 6e20 2827 6177       return ('aw
-000290d0: 7320 7333 6170 6920 6765 742d 6275 636b  s s3api get-buck
-000290e0: 6574 2d6c 6f63 6174 696f 6e20 270a 2020  et-location '.  
-000290f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029100: 2020 6627 2d2d 6275 636b 6574 207b 6275    f'--bucket {bu
-00029110: 636b 6574 5f6e 616d 657d 202d 2d6f 7574  cket_name} --out
-00029120: 7075 7420 7465 7874 2729 0a20 2020 2020  put text').     
-00029130: 2020 2065 6c69 6620 7374 6f72 655f 7479     elif store_ty
-00029140: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029150: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
-00029160: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00029170: 7572 6e20 2866 2767 7375 7469 6c20 6c73  urn (f'gsutil ls
-00029180: 202d 4c20 2d62 2067 733a 2f2f 7b62 7563   -L -b gs://{buc
-00029190: 6b65 745f 6e61 6d65 7d2f 207c 2027 0a20  ket_name}/ | '. 
-000291a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291b0: 2020 2027 6772 6570 2022 4c6f 6361 7469     'grep "Locati
-000291c0: 6f6e 2063 6f6e 7374 7261 696e 7422 207c  on constraint" |
-000291d0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000291e0: 2020 2020 2020 2027 6177 6b20 5c27 7b70         'awk \'{p
-000291f0: 7269 6e74 2074 6f6c 6f77 6572 2824 4e46  rint tolower($NF
-00029200: 297d 5c27 2729 0a20 2020 2020 2020 2065  )}\'').        e
-00029210: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00029220: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-00029230: 656e 7465 6445 7272 6f72 2866 2752 6567  entedError(f'Reg
-00029240: 696f 6e20 636f 6d6d 616e 6420 6e6f 7420  ion command not 
-00029250: 696d 706c 656d 656e 7465 6420 666f 7220  implemented for 
-00029260: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00029270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029280: 2020 2020 2020 2020 6627 7b73 746f 7265          f'{store
-00029290: 5f74 7970 657d 2729 0a0a 2020 2020 4073  _type}')..    @s
-000292a0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-000292b0: 6465 6620 636c 695f 636f 756e 745f 6e61  def cli_count_na
-000292c0: 6d65 5f69 6e5f 6275 636b 6574 2873 746f  me_in_bucket(sto
-000292d0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
-000292e0: 6e61 6d65 2c20 6669 6c65 5f6e 616d 652c  name, file_name,
-000292f0: 2073 7566 6669 783d 2727 293a 0a20 2020   suffix=''):.   
-00029300: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00029310: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00029320: 622e 5374 6f72 6554 7970 652e 5333 3a0a  b.StoreType.S3:.
-00029330: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00029340: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
-00029350: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-00029360: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
-00029370: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
-00029380: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
-00029390: 2d2d 7072 6566 6978 207b 7375 6666 6978  --prefix {suffix
-000293a0: 7d20 2d2d 7175 6572 7920 226c 656e 6774  } --query "lengt
-000293b0: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
-000293c0: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
-000293d0: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
-000293e0: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-000293f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00029400: 2020 2020 7265 7475 726e 2066 2761 7773      return f'aws
-00029410: 2073 3361 7069 206c 6973 742d 6f62 6a65   s3api list-obje
-00029420: 6374 7320 2d2d 6275 636b 6574 2022 7b62  cts --bucket "{b
-00029430: 7563 6b65 745f 6e61 6d65 7d22 202d 2d71  ucket_name}" --q
-00029440: 7565 7279 2022 6c65 6e67 7468 2843 6f6e  uery "length(Con
-00029450: 7465 6e74 735b 3f63 6f6e 7461 696e 7328  tents[?contains(
-00029460: 4b65 792c 5c27 7b66 696c 655f 6e61 6d65  Key,\'{file_name
-00029470: 7d5c 2729 5d2e 4b65 7929 2227 0a20 2020  }\')].Key)"'.   
-00029480: 2020 2020 2065 6c69 6620 7374 6f72 655f       elif store_
-00029490: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-000294a0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-000294b0: 533a 0a20 2020 2020 2020 2020 2020 2069  S:.            i
-000294c0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
-000294d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000294e0: 2066 2767 7375 7469 6c20 6c73 202d 7220   f'gsutil ls -r 
-000294f0: 6773 3a2f 2f7b 6275 636b 6574 5f6e 616d  gs://{bucket_nam
-00029500: 657d 2f7b 7375 6666 6978 7d20 7c20 6772  e}/{suffix} | gr
-00029510: 6570 2022 7b66 696c 655f 6e61 6d65 7d22  ep "{file_name}"
-00029520: 207c 2077 6320 2d6c 270a 2020 2020 2020   | wc -l'.      
-00029530: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00029540: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00029550: 726e 2066 2767 7375 7469 6c20 6c73 202d  rn f'gsutil ls -
-00029560: 7220 6773 3a2f 2f7b 6275 636b 6574 5f6e  r gs://{bucket_n
-00029570: 616d 657d 207c 2067 7265 7020 227b 6669  ame} | grep "{fi
-00029580: 6c65 5f6e 616d 657d 2220 7c20 7763 202d  le_name}" | wc -
-00029590: 6c27 0a20 2020 2020 2020 2065 6c69 6620  l'.        elif 
-000295a0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
-000295b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-000295c0: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
-000295d0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
-000295e0: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
-000295f0: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
-00029600: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00029610: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
-00029620: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-00029630: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
-00029640: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
-00029650: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
-00029660: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
-00029670: 2073 3361 7069 206c 6973 742d 6f62 6a65   s3api list-obje
-00029680: 6374 7320 2d2d 6275 636b 6574 2022 7b62  cts --bucket "{b
-00029690: 7563 6b65 745f 6e61 6d65 7d22 202d 2d70  ucket_name}" --p
-000296a0: 7265 6669 7820 7b73 7566 6669 787d 202d  refix {suffix} -
-000296b0: 2d71 7565 7279 2022 6c65 6e67 7468 2843  -query "length(C
-000296c0: 6f6e 7465 6e74 735b 3f63 6f6e 7461 696e  ontents[?contain
-000296d0: 7328 4b65 792c 5c27 7b66 696c 655f 6e61  s(Key,\'{file_na
-000296e0: 6d65 7d5c 2729 5d2e 4b65 7929 2220 2d2d  me}\')].Key)" --
-000296f0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-00029700: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-00029710: 653d 7232 270a 2020 2020 2020 2020 2020  e=r2'.          
-00029720: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00029730: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00029740: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-00029750: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-00029760: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-00029770: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-00029780: 7320 7333 6170 6920 6c69 7374 2d6f 626a  s s3api list-obj
-00029790: 6563 7473 202d 2d62 7563 6b65 7420 227b  ects --bucket "{
-000297a0: 6275 636b 6574 5f6e 616d 657d 2220 2d2d  bucket_name}" --
-000297b0: 7175 6572 7920 226c 656e 6774 6828 436f  query "length(Co
-000297c0: 6e74 656e 7473 5b3f 636f 6e74 6169 6e73  ntents[?contains
-000297d0: 284b 6579 2c5c 277b 6669 6c65 5f6e 616d  (Key,\'{file_nam
-000297e0: 657d 5c27 295d 2e4b 6579 2922 202d 2d65  e}\')].Key)" --e
-000297f0: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-00029800: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-00029810: 3d72 3227 0a0a 2020 2020 4073 7461 7469  =r2'..    @stati
-00029820: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-00029830: 636c 695f 636f 756e 745f 6669 6c65 5f69  cli_count_file_i
-00029840: 6e5f 6275 636b 6574 2873 746f 7265 5f74  n_bucket(store_t
-00029850: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
-00029860: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
-00029870: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00029880: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00029890: 652e 5333 3a0a 2020 2020 2020 2020 2020  e.S3:.          
-000298a0: 2020 7265 7475 726e 2066 2761 7773 2073    return f'aws s
-000298b0: 3320 6c73 2073 333a 2f2f 7b62 7563 6b65  3 ls s3://{bucke
-000298c0: 745f 6e61 6d65 7d20 2d2d 7265 6375 7273  t_name} --recurs
-000298d0: 6976 6520 7c20 7763 202d 6c27 0a20 2020  ive | wc -l'.   
-000298e0: 2020 2020 2065 6c69 6620 7374 6f72 655f       elif store_
-000298f0: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-00029900: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-00029910: 533a 0a20 2020 2020 2020 2020 2020 2072  S:.            r
-00029920: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
-00029930: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
-00029940: 745f 6e61 6d65 7d2f 2a2a 207c 2077 6320  t_name}/** | wc 
-00029950: 2d6c 270a 2020 2020 2020 2020 656c 6966  -l'.        elif
-00029960: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-00029970: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00029980: 5479 7065 2e52 323a 0a20 2020 2020 2020  Type.R2:.       
-00029990: 2020 2020 2065 6e64 706f 696e 745f 7572       endpoint_ur
-000299a0: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
-000299b0: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
-000299c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000299d0: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
-000299e0: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
-000299f0: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
-00029a00: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
-00029a10: 487d 2061 7773 2073 3320 6c73 2073 333a  H} aws s3 ls s3:
-00029a20: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d20  //{bucket_name} 
-00029a30: 2d2d 7265 6375 7273 6976 6520 2d2d 656e  --recursive --en
-00029a40: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
-00029a50: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
-00029a60: 7232 207c 2077 6320 2d6c 270a 0a20 2020  r2 | wc -l'..   
-00029a70: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-00029a80: 0a20 2020 2064 6566 2074 6d70 5f73 6f75  .    def tmp_sou
-00029a90: 7263 6528 7365 6c66 2c20 746d 705f 7061  rce(self, tmp_pa
-00029aa0: 7468 293a 0a20 2020 2020 2020 2023 2043  th):.        # C
-00029ab0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-00029ac0: 7279 2064 6972 6563 746f 7279 2077 6974  ry directory wit
-00029ad0: 6820 6120 6669 6c65 2069 6e20 6974 0a20  h a file in it. 
-00029ae0: 2020 2020 2020 2074 6d70 5f64 6972 203d         tmp_dir =
-00029af0: 2074 6d70 5f70 6174 6820 2f20 2774 6d70   tmp_path / 'tmp
-00029b00: 2d73 6f75 7263 6527 0a20 2020 2020 2020  -source'.       
-00029b10: 2074 6d70 5f64 6972 2e6d 6b64 6972 2829   tmp_dir.mkdir()
-00029b20: 0a20 2020 2020 2020 2074 6d70 5f66 696c  .        tmp_fil
-00029b30: 6520 3d20 746d 705f 6469 7220 2f20 2774  e = tmp_dir / 't
-00029b40: 6d70 2d66 696c 6527 0a20 2020 2020 2020  mp-file'.       
-00029b50: 2074 6d70 5f66 696c 652e 7772 6974 655f   tmp_file.write_
-00029b60: 7465 7874 2827 7465 7374 2729 0a20 2020  text('test').   
-00029b70: 2020 2020 2063 6972 636c 655f 6c69 6e6b       circle_link
-00029b80: 203d 2074 6d70 5f64 6972 202f 2027 6369   = tmp_dir / 'ci
-00029b90: 7263 6c65 2d6c 696e 6b27 0a20 2020 2020  rcle-link'.     
-00029ba0: 2020 2063 6972 636c 655f 6c69 6e6b 2e73     circle_link.s
-00029bb0: 796d 6c69 6e6b 5f74 6f28 746d 705f 6469  ymlink_to(tmp_di
-00029bc0: 722c 2074 6172 6765 745f 6973 5f64 6972  r, target_is_dir
-00029bd0: 6563 746f 7279 3d54 7275 6529 0a20 2020  ectory=True).   
-00029be0: 2020 2020 2079 6965 6c64 2073 7472 2874       yield str(t
-00029bf0: 6d70 5f64 6972 290a 0a20 2020 2040 7374  mp_dir)..    @st
-00029c00: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-00029c10: 6566 2067 656e 6572 6174 655f 6275 636b  ef generate_buck
-00029c20: 6574 5f6e 616d 6528 293a 0a20 2020 2020  et_name():.     
-00029c30: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
-00029c40: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
-00029c50: 6e61 6d65 0a20 2020 2020 2020 2023 2074  name.        # t
-00029c60: 696d 652e 7469 6d65 2829 2072 6574 7572  ime.time() retur
-00029c70: 6e73 2076 6172 7969 6e67 2070 7265 6369  ns varying preci
-00029c80: 7369 6f6e 206f 6e20 6469 6666 6572 656e  sion on differen
-00029c90: 7420 7379 7374 656d 732c 2073 6f20 7765  t systems, so we
-00029ca0: 0a20 2020 2020 2020 2023 2072 6570 6c61  .        # repla
-00029cb0: 6365 2074 6865 2064 6563 696d 616c 2070  ce the decimal p
-00029cc0: 6f69 6e74 2061 6e64 2075 7365 2077 6861  oint and use wha
-00029cd0: 7465 7665 7220 7072 6563 6973 696f 6e20  tever precision 
-00029ce0: 7765 2063 616e 2067 6574 2e0a 2020 2020  we can get..    
-00029cf0: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
-00029d00: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
-00029d10: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
-00029d20: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00029d30: 2066 2773 6b79 2d74 6573 742d 7b74 696d   f'sky-test-{tim
-00029d40: 6573 7461 6d70 7d27 0a0a 2020 2020 4070  estamp}'..    @p
-00029d50: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-00029d60: 2020 6465 6620 746d 705f 6275 636b 6574    def tmp_bucket
-00029d70: 5f6e 616d 6528 7365 6c66 293a 0a20 2020  _name(self):.   
-00029d80: 2020 2020 2079 6965 6c64 2073 656c 662e       yield self.
-00029d90: 6765 6e65 7261 7465 5f62 7563 6b65 745f  generate_bucket_
-00029da0: 6e61 6d65 2829 0a0a 2020 2020 4073 7461  name()..    @sta
-00029db0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-00029dc0: 6620 7969 656c 645f 7374 6f72 6167 655f  f yield_storage_
-00029dd0: 6f62 6a65 6374 280a 2020 2020 2020 2020  object(.        
-00029de0: 2020 2020 6e61 6d65 3a20 4f70 7469 6f6e      name: Option
-00029df0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00029e00: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-00029e10: 6365 3a20 4f70 7469 6f6e 616c 5b73 746f  ce: Optional[sto
-00029e20: 7261 6765 5f6c 6962 2e50 6174 685d 203d  rage_lib.Path] =
-00029e30: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-00029e40: 2020 2073 746f 7265 733a 204f 7074 696f     stores: Optio
-00029e50: 6e61 6c5b 4469 6374 5b73 746f 7261 6765  nal[Dict[storage
-00029e60: 5f6c 6962 2e53 746f 7265 5479 7065 2c0a  _lib.StoreType,.
-00029e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029e90: 2020 7374 6f72 6167 655f 6c69 622e 4162    storage_lib.Ab
-00029ea0: 7374 7261 6374 5374 6f72 655d 5d20 3d20  stractStore]] = 
-00029eb0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00029ec0: 2020 7065 7273 6973 7465 6e74 3a20 4f70    persistent: Op
-00029ed0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2054  tional[bool] = T
-00029ee0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00029ef0: 206d 6f64 653a 2073 746f 7261 6765 5f6c   mode: storage_l
-00029f00: 6962 2e53 746f 7261 6765 4d6f 6465 203d  ib.StorageMode =
-00029f10: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00029f20: 7261 6765 4d6f 6465 2e4d 4f55 4e54 293a  rageMode.MOUNT):
-00029f30: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-00029f40: 6573 2061 2074 656d 706f 7261 7279 2073  es a temporary s
-00029f50: 746f 7261 6765 206f 626a 6563 742e 2053  torage object. S
-00029f60: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-00029f70: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-00029f80: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-00029f90: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-00029fa0: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
-00029fb0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00029fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029fe0: 736f 7572 6365 3d73 6f75 7263 652c 0a20  source=source,. 
+00020f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020fa0: 2020 2020 2020 2020 2020 7374 725d 5d29            str]])
+00020fb0: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
+00020fc0: 4368 6563 6b20 7265 706c 6963 6173 2720  Check replicas' 
+00020fd0: 7374 6174 7573 2061 6e64 2063 6f75 6e74  status and count
+00020fe0: 2069 6e20 736b 7920 7365 7276 6520 7374   in sky serve st
+00020ff0: 6174 7573 0a0a 2020 2020 5765 2077 696c  atus..    We wil
+00021000: 6c20 6368 6563 6b20 7643 5055 3d32 2c20  l check vCPU=2, 
+00021010: 6173 2061 6c6c 206f 7572 2074 6573 7473  as all our tests
+00021020: 2075 7365 2076 4350 553d 322e 0a20 2020   use vCPU=2..   
+00021030: 200a 2020 2020 4172 6773 3a0a 2020 2020   .    Args:.    
+00021040: 2020 2020 6e61 6d65 3a20 7468 6520 6e61      name: the na
+00021050: 6d65 206f 6620 7468 6520 7365 7276 6963  me of the servic
+00021060: 650a 2020 2020 2020 2020 6368 6563 6b5f  e.        check_
+00021070: 7475 706c 6573 3a20 4120 6c69 7374 206f  tuples: A list o
+00021080: 6620 7265 706c 6963 6120 7072 6f70 6572  f replica proper
+00021090: 7479 2074 6f20 6368 6563 6b2e 2045 6163  ty to check. Eac
+000210a0: 6820 7475 706c 6520 6973 0a20 2020 2020  h tuple is.     
+000210b0: 2020 2020 2020 2028 636f 756e 742c 2069         (count, i
+000210c0: 735f 7370 6f74 2c20 7374 6174 7573 290a  s_spot, status).
+000210d0: 2020 2020 2222 220a 2020 2020 6368 6563      """.    chec
+000210e0: 6b5f 636d 6420 3d20 2727 0a20 2020 2066  k_cmd = ''.    f
+000210f0: 6f72 2063 6865 636b 5f74 7570 6c65 2069  or check_tuple i
+00021100: 6e20 6368 6563 6b5f 7475 706c 6573 3a0a  n check_tuples:.
+00021110: 2020 2020 2020 2020 636f 756e 742c 2069          count, i
+00021120: 735f 7370 6f74 2c20 7374 6174 7573 203d  s_spot, status =
+00021130: 2063 6865 636b 5f74 7570 6c65 0a20 2020   check_tuple.   
+00021140: 2020 2020 2072 6573 6f75 7263 655f 7374       resource_st
+00021150: 7220 3d20 2727 0a20 2020 2020 2020 2069  r = ''.        i
+00021160: 6620 7374 6174 7573 206e 6f74 2069 6e20  f status not in 
+00021170: 5b27 5045 4e44 494e 4727 2c20 2753 4855  ['PENDING', 'SHU
+00021180: 5454 494e 475f 444f 574e 270a 2020 2020  TTING_DOWN'.    
+00021190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211a0: 2020 2020 205d 2061 6e64 206e 6f74 2073       ] and not s
+000211b0: 7461 7475 732e 7374 6172 7473 7769 7468  tatus.startswith
+000211c0: 2827 4641 494c 4544 2729 3a0a 2020 2020  ('FAILED'):.    
+000211d0: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
+000211e0: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
+000211f0: 2020 6966 2069 735f 7370 6f74 3a0a 2020    if is_spot:.  
+00021200: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+00021210: 6f74 5f73 7472 203d 2027 5c5b 5370 6f74  ot_str = '\[Spot
+00021220: 5c5d 270a 2020 2020 2020 2020 2020 2020  \]'.            
+00021230: 7265 736f 7572 6365 5f73 7472 203d 2066  resource_str = f
+00021240: 2728 7b73 706f 745f 7374 727d 7643 5055  '({spot_str}vCPU
+00021250: 3d32 2927 0a20 2020 2020 2020 2063 6865  =2)'.        che
+00021260: 636b 5f63 6d64 202b 3d20 2866 2720 6563  ck_cmd += (f' ec
+00021270: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
+00021280: 7b72 6573 6f75 7263 655f 7374 727d 2220  {resource_str}" 
+00021290: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+000212a0: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
+000212b0: 2022 7b73 7461 7475 737d 2220 7c20 7763   "{status}" | wc
+000212c0: 202d 6c20 7c20 6772 6570 207b 636f 756e   -l | grep {coun
+000212d0: 747d 207c 7c20 6578 6974 2031 3b27 290a  t} || exit 1;').
+000212e0: 2020 2020 7265 7475 726e 2028 6627 7b5f      return (f'{_
+000212f0: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
+00021300: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00021310: 6d65 297d 3b20 6563 686f 2022 2473 223b  me)}; echo "$s";
+00021320: 2027 202b 2063 6865 636b 5f63 6d64 290a   ' + check_cmd).
+00021330: 0a0a 6465 6620 5f63 6865 636b 5f73 6572  ..def _check_ser
+00021340: 7669 6365 5f76 6572 7369 6f6e 2873 6572  vice_version(ser
+00021350: 7669 6365 5f6e 616d 653a 2073 7472 2c20  vice_name: str, 
+00021360: 7665 7273 696f 6e3a 2073 7472 2920 2d3e  version: str) ->
+00021370: 2073 7472 3a0a 2020 2020 2320 4772 6570   str:.    # Grep
+00021380: 2074 6865 206c 696e 6573 2062 6566 6f72   the lines befor
+00021390: 6520 2753 6572 7669 6365 2052 6570 6c69  e 'Service Repli
+000213a0: 6361 7327 2061 6e64 2063 6865 636b 2069  cas' and check i
+000213b0: 6620 7468 6520 7365 7276 6963 6520 7665  f the service ve
+000213c0: 7273 696f 6e0a 2020 2020 2320 6973 2063  rsion.    # is c
+000213d0: 6f72 7265 6374 2e0a 2020 2020 7265 7475  orrect..    retu
+000213e0: 726e 2028 6627 6563 686f 2022 2473 2220  rn (f'echo "$s" 
+000213f0: 7c20 6772 6570 202d 4231 3030 3020 2253  | grep -B1000 "S
+00021400: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+00021410: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+00021420: 2066 2767 7265 7020 2d45 2022 7b73 6572   f'grep -E "{ser
+00021430: 7669 6365 5f6e 616d 657d 5c73 2b7b 7665  vice_name}\s+{ve
+00021440: 7273 696f 6e7d 2220 7c7c 2065 7869 7420  rsion}" || exit 
+00021450: 313b 2027 290a 0a0a 4070 7974 6573 742e  1; ')...@pytest.
+00021460: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00021470: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00021480: 7465 7374 5f73 6b79 7365 7276 655f 6763  test_skyserve_gc
+00021490: 705f 6874 7470 2829 3a0a 2020 2020 2222  p_http():.    ""
+000214a0: 2254 6573 7420 736b 7973 6572 7665 206f  "Test skyserve o
+000214b0: 6e20 4743 5022 2222 0a20 2020 206e 616d  n GCP""".    nam
+000214c0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+000214d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+000214e0: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
+000214f0: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
+00021500: 2027 6763 7027 2c20 3230 290a 2020 2020   'gcp', 20).    
+00021510: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00021520: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00021530: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+00021540: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00021550: 745f 736b 7973 6572 7665 5f61 7773 5f68  t_skyserve_aws_h
+00021560: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+00021570: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
+00021580: 5753 2222 220a 2020 2020 6e61 6d65 203d  WS""".    name =
+00021590: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+000215a0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+000215b0: 5f67 6574 5f73 6b79 7365 7276 655f 6874  _get_skyserve_ht
+000215c0: 7470 5f74 6573 7428 6e61 6d65 2c20 2761  tp_test(name, 'a
+000215d0: 7773 272c 2032 3029 0a20 2020 2072 756e  ws', 20).    run
+000215e0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000215f0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
+00021600: 7a75 7265 0a40 7079 7465 7374 2e6d 6172  zure.@pytest.mar
+00021610: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00021620: 5f73 6b79 7365 7276 655f 617a 7572 655f  _skyserve_azure_
+00021630: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
+00021640: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
+00021650: 417a 7572 6522 2222 0a20 2020 206e 616d  Azure""".    nam
+00021660: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00021670: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00021680: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
+00021690: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
+000216a0: 2027 617a 7572 6527 2c20 3330 290a 2020   'azure', 30).  
+000216b0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000216c0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000216d0: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
+000216e0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+000216f0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00021700: 7973 6572 7665 5f6c 6c6d 2867 656e 6572  yserve_llm(gener
+00021710: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00021720: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+00021730: 6572 7665 2077 6974 6820 7265 616c 204c  erve with real L
+00021740: 4c4d 2075 7365 6361 7365 2222 220a 2020  LM usecase""".  
+00021750: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+00021760: 7276 6963 655f 6e61 6d65 2829 0a0a 2020  rvice_name()..  
+00021770: 2020 6465 6620 6765 6e65 7261 7465 5f6c    def generate_l
+00021780: 6c6d 5f74 6573 745f 636f 6d6d 616e 6428  lm_test_command(
+00021790: 7072 6f6d 7074 3a20 7374 722c 2065 7870  prompt: str, exp
+000217a0: 6563 7465 645f 6f75 7470 7574 3a20 7374  ected_output: st
+000217b0: 7229 202d 3e20 7374 723a 0a20 2020 2020  r) -> str:.     
+000217c0: 2020 2070 726f 6d70 7420 3d20 7368 6c65     prompt = shle
+000217d0: 782e 7175 6f74 6528 7072 6f6d 7074 290a  x.quote(prompt).
+000217e0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+000217f0: 5f6f 7574 7075 7420 3d20 7368 6c65 782e  _output = shlex.
+00021800: 7175 6f74 6528 6578 7065 6374 6564 5f6f  quote(expected_o
+00021810: 7574 7075 7429 0a20 2020 2020 2020 2072  utput).        r
+00021820: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+00021830: 2020 2020 6627 7b5f 5345 5256 455f 454e      f'{_SERVE_EN
+00021840: 4450 4f49 4e54 5f57 4149 542e 666f 726d  DPOINT_WAIT.form
+00021850: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00021860: 270a 2020 2020 2020 2020 2020 2020 2770  '.            'p
+00021870: 7974 686f 6e20 7465 7374 732f 736b 7973  ython tests/skys
+00021880: 6572 7665 2f6c 6c6d 2f67 6574 5f72 6573  erve/llm/get_res
+00021890: 706f 6e73 652e 7079 202d 2d65 6e64 706f  ponse.py --endpo
+000218a0: 696e 7420 2465 6e64 706f 696e 7420 270a  int $endpoint '.
+000218b0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000218c0: 7072 6f6d 7074 207b 7072 6f6d 7074 7d20  prompt {prompt} 
+000218d0: 7c20 6772 6570 207b 6578 7065 6374 6564  | grep {expected
+000218e0: 5f6f 7574 7075 747d 2729 0a0a 2020 2020  _output}')..    
+000218f0: 7769 7468 206f 7065 6e28 2774 6573 7473  with open('tests
+00021900: 2f73 6b79 7365 7276 652f 6c6c 6d2f 7072  /skyserve/llm/pr
+00021910: 6f6d 7074 5f6f 7574 7075 742e 6a73 6f6e  ompt_output.json
+00021920: 272c 2027 7227 2c0a 2020 2020 2020 2020  ', 'r',.        
+00021930: 2020 2020 2020 656e 636f 6469 6e67 3d27        encoding='
+00021940: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
+00021950: 2020 2020 2020 7072 6f6d 7074 326f 7574        prompt2out
+00021960: 7075 7420 3d20 6a73 6f6e 2e6c 6f61 6428  put = json.load(
+00021970: 6629 0a0a 2020 2020 7465 7374 203d 2054  f)..    test = T
+00021980: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
+00021990: 6573 742d 736b 7973 6572 7665 2d6c 6c6d  est-skyserve-llm
+000219a0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000219b0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000219c0: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+000219d0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+000219e0: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+000219f0: 7473 2f73 6b79 7365 7276 652f 6c6c 6d2f  ts/skyserve/llm/
+00021a00: 7365 7276 6963 652e 7961 6d6c 272c 0a20  service.yaml',. 
+00021a10: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+00021a20: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+00021a30: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+00021a40: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00021a50: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
+00021a60: 202a 5b0a 2020 2020 2020 2020 2020 2020   *[.            
+00021a70: 2020 2020 6765 6e65 7261 7465 5f6c 6c6d      generate_llm
+00021a80: 5f74 6573 745f 636f 6d6d 616e 6428 7072  _test_command(pr
+00021a90: 6f6d 7074 2c20 6f75 7470 7574 290a 2020  ompt, output).  
+00021aa0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00021ab0: 7220 7072 6f6d 7074 2c20 6f75 7470 7574  r prompt, output
+00021ac0: 2069 6e20 7072 6f6d 7074 326f 7574 7075   in prompt2outpu
+00021ad0: 742e 6974 656d 7328 290a 2020 2020 2020  t.items().      
+00021ae0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00021af0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00021b00: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00021b10: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00021b20: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00021b30: 3d32 3520 2a20 3630 2c0a 2020 2020 290a  =25 * 60,.    ).
+00021b40: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00021b50: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00021b60: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
+00021b70: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00021b80: 2074 6573 745f 736b 7973 6572 7665 5f73   test_skyserve_s
+00021b90: 706f 745f 7265 636f 7665 7279 2829 3a0a  pot_recovery():.
+00021ba0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00021bb0: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
+00021bc0: 2020 207a 6f6e 6520 3d20 2775 732d 6365     zone = 'us-ce
+00021bd0: 6e74 7261 6c31 2d61 270a 0a20 2020 2074  ntral1-a'..    t
+00021be0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00021bf0: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00021c00: 7276 652d 7370 6f74 2d72 6563 6f76 6572  rve-spot-recover
+00021c10: 792d 6763 7027 2c0a 2020 2020 2020 2020  y-gcp',.        
+00021c20: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00021c30: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00021c40: 7b6e 616d 657d 202d 7920 7465 7374 732f  {name} -y tests/
+00021c50: 736b 7973 6572 7665 2f73 706f 742f 7265  skyserve/spot/re
+00021c60: 636f 7665 7279 2e79 616d 6c27 2c0a 2020  covery.yaml',.  
+00021c70: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00021c80: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00021c90: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00021ca0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00021cb0: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00021cc0: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+00021cd0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+00021ce0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
+00021cf0: 2020 2020 2020 2020 2020 2763 7572 6c20            'curl 
+00021d00: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00021d10: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00021d20: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+00021d30: 0a20 2020 2020 2020 2020 2020 205f 7465  .            _te
+00021d40: 726d 696e 6174 655f 6763 705f 7265 706c  rminate_gcp_repl
+00021d50: 6963 6128 6e61 6d65 2c20 7a6f 6e65 2c20  ica(name, zone, 
+00021d60: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
+00021d70: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00021d80: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00021d90: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00021da0: 615f 6e75 6d3d 3129 2c0a 2020 2020 2020  a_num=1),.      
+00021db0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00021dc0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00021dd0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00021de0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00021df0: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
+00021e00: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00021e10: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00021e20: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
+00021e30: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00021e40: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00021e50: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00021e60: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00021e70: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00021e80: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00021e90: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00021ea0: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
+00021eb0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00021ec0: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00021ed0: 7973 6572 7665 5f62 6173 655f 6f6e 6465  yserve_base_onde
+00021ee0: 6d61 6e64 5f66 616c 6c62 6163 6b28 6765  mand_fallback(ge
+00021ef0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00021f00: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00021f10: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
+00021f20: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00021f30: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+00021f40: 742d 736b 7973 6572 7665 2d62 6173 652d  t-skyserve-base-
+00021f50: 6f6e 6465 6d61 6e64 2d66 616c 6c62 6163  ondemand-fallbac
+00021f60: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
+00021f70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00021f80: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+00021f90: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00021fa0: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+00021fb0: 7374 732f 736b 7973 6572 7665 2f73 706f  sts/skyserve/spo
+00021fc0: 742f 6261 7365 5f6f 6e64 656d 616e 645f  t/base_ondemand_
+00021fd0: 6661 6c6c 6261 636b 2e79 616d 6c27 2c0a  fallback.yaml',.
+00021fe0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00021ff0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00022000: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00022010: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00022020: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
+00022030: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00022040: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
+00022050: 205b 2831 2c20 5472 7565 2c20 2752 4541   [(1, True, 'REA
+00022060: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
+00022070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022090: 2020 2831 2c20 4661 6c73 652c 2027 5245    (1, False, 'RE
+000220a0: 4144 5927 295d 292c 0a20 2020 2020 2020  ADY')]),.       
+000220b0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+000220c0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+000220d0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+000220e0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+000220f0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
+00022100: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00022110: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00022120: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
+00022130: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00022140: 2074 6573 745f 736b 7973 6572 7665 5f64   test_skyserve_d
+00022150: 796e 616d 6963 5f6f 6e64 656d 616e 645f  ynamic_ondemand_
+00022160: 6661 6c6c 6261 636b 2829 3a0a 2020 2020  fallback():.    
+00022170: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00022180: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
+00022190: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
+000221a0: 6c31 2d61 270a 0a20 2020 2074 6573 7420  l1-a'..    test 
+000221b0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000221c0: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+000221d0: 6479 6e61 6d69 632d 6f6e 6465 6d61 6e64  dynamic-ondemand
+000221e0: 2d66 616c 6c62 6163 6b27 2c0a 2020 2020  -fallback',.    
+000221f0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00022200: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+00022210: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
+00022220: 7564 2067 6370 202d 7920 7465 7374 732f  ud gcp -y tests/
+00022230: 736b 7973 6572 7665 2f73 706f 742f 6479  skyserve/spot/dy
+00022240: 6e61 6d69 635f 6f6e 6465 6d61 6e64 5f66  namic_ondemand_f
+00022250: 616c 6c62 6163 6b2e 7961 6d6c 272c 0a20  allback.yaml',. 
+00022260: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
+00022270: 6570 2034 3027 2c0a 2020 2020 2020 2020  ep 40',.        
+00022280: 2020 2020 2320 3220 6f6e 2d64 656d 616e      # 2 on-deman
+00022290: 6420 2870 726f 7669 7369 6f6e 696e 6729  d (provisioning)
+000222a0: 202b 2032 2053 706f 7420 2870 726f 7669   + 2 Spot (provi
+000222b0: 7369 6f6e 696e 6729 2e0a 2020 2020 2020  sioning)..      
+000222c0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+000222d0: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
+000222e0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+000222f0: 6563 686f 2022 2473 223b 270a 2020 2020  echo "$s";'.    
+00022300: 2020 2020 2020 2020 2765 6368 6f20 2224          'echo "$
+00022310: 7322 207c 2067 7265 7020 2d71 2022 302f  s" | grep -q "0/
+00022320: 3422 207c 7c20 6578 6974 2031 272c 0a20  4" || exit 1',. 
+00022330: 2020 2020 2020 2020 2020 2023 2057 6169             # Wai
+00022340: 7420 666f 7220 7468 6520 7072 6f76 6973  t for the provis
+00022350: 696f 6e69 6e67 2073 7461 7274 730a 2020  ioning starts.  
+00022360: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00022370: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+00022380: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00022390: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+000223a0: 2c20 5b0a 2020 2020 2020 2020 2020 2020  , [.            
+000223b0: 2020 2020 2832 2c20 5472 7565 2c20 5f53      (2, True, _S
+000223c0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+000223d0: 5f53 5441 5455 535f 5245 4745 5820 2b20  _STATUS_REGEX + 
+000223e0: 275c 7c52 4541 4459 2729 2c0a 2020 2020  '\|READY'),.    
+000223f0: 2020 2020 2020 2020 2020 2020 2832 2c20              (2, 
+00022400: 4661 6c73 652c 205f 5345 5256 4943 455f  False, _SERVICE_
+00022410: 4c41 554e 4348 494e 475f 5354 4154 5553  LAUNCHING_STATUS
+00022420: 5f52 4547 4558 202b 2027 5c7c 5348 5554  _REGEX + '\|SHUT
+00022430: 5449 4e47 5f44 4f57 4e27 290a 2020 2020  TING_DOWN').    
+00022440: 2020 2020 2020 2020 5d29 2c0a 0a20 2020          ]),..   
+00022450: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+00022460: 756e 7469 6c20 3220 7370 6f74 2069 6e73  until 2 spot ins
+00022470: 7461 6e63 6573 2061 7265 2072 6561 6479  tances are ready
+00022480: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
+00022490: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+000224a0: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+000224b0: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+000224c0: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
+000224d0: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+000224e0: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+000224f0: 652c 205b 2832 2c20 5472 7565 2c20 2752  e, [(2, True, 'R
+00022500: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+00022510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022530: 2020 2020 2830 2c20 4661 6c73 652c 2027      (0, False, '
+00022540: 2729 5d29 2c0a 2020 2020 2020 2020 2020  ')]),.          
+00022550: 2020 5f74 6572 6d69 6e61 7465 5f67 6370    _terminate_gcp
+00022560: 5f72 6570 6c69 6361 286e 616d 652c 207a  _replica(name, z
+00022570: 6f6e 652c 2031 292c 0a20 2020 2020 2020  one, 1),.       
+00022580: 2020 2020 2066 2773 6c65 6570 2034 3027       f'sleep 40'
+00022590: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000225a0: 3120 6f6e 2d64 656d 616e 6420 2870 726f  1 on-demand (pro
+000225b0: 7669 7369 6f6e 696e 6729 202b 2031 2053  visioning) + 1 S
+000225c0: 706f 7420 2872 6561 6479 2920 2b20 3120  pot (ready) + 1 
+000225d0: 7370 6f74 2028 7072 6f76 6973 696f 6e69  spot (provisioni
+000225e0: 6e67 292e 0a20 2020 2020 2020 2020 2020  ng)..           
+000225f0: 2066 277b 5f53 4552 5645 5f53 5441 5455   f'{_SERVE_STATU
+00022600: 535f 5741 4954 2e66 6f72 6d61 7428 6e61  S_WAIT.format(na
+00022610: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00022620: 2020 2020 2020 2020 2027 6563 686f 2022           'echo "
+00022630: 2473 2220 7c20 6772 6570 202d 7120 2231  $s" | grep -q "1
+00022640: 2f33 2227 2c0a 2020 2020 2020 2020 2020  /3"',.          
+00022650: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00022660: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00022670: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00022680: 2c20 5b28 312c 2054 7275 652c 2027 5245  , [(1, True, 'RE
+00022690: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+000226a0: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+000226b0: 2c20 5472 7565 2c20 5f53 4552 5649 4345  , True, _SERVICE
+000226c0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+000226d0: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
+000226e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000226f0: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
+00022700: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00022710: 5441 5455 535f 5245 4745 5829 5d29 2c0a  TATUS_REGEX)]),.
+00022720: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+00022730: 6169 7420 756e 7469 6c20 3220 7370 6f74  ait until 2 spot
+00022740: 2069 6e73 7461 6e63 6573 2061 7265 2072   instances are r
+00022750: 6561 6479 2e0a 2020 2020 2020 2020 2020  eady..          
+00022760: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00022770: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00022780: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00022790: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
+000227a0: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
+000227b0: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
+000227c0: 286e 616d 652c 205b 2832 2c20 5472 7565  (name, [(2, True
+000227d0: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
+000227e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000227f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022800: 2020 2020 2020 2020 2830 2c20 4661 6c73          (0, Fals
+00022810: 652c 2027 2729 5d29 2c0a 2020 2020 2020  e, '')]),.      
+00022820: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00022830: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00022840: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00022850: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00022860: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00022870: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00022880: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00022890: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
+000228a0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+000228b0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
+000228c0: 5f73 6b79 7365 7276 655f 7573 6572 5f62  _skyserve_user_b
+000228d0: 7567 5f72 6573 7461 7274 2867 656e 6572  ug_restart(gener
+000228e0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+000228f0: 2020 2020 2222 2254 6573 7473 2074 6861      """Tests tha
+00022900: 7420 7765 2072 6573 7461 7274 2074 6865  t we restart the
+00022910: 2073 6572 7669 6365 2061 6674 6572 2075   service after u
+00022920: 7365 7220 6275 672e 2222 220a 2020 2020  ser bug.""".    
+00022930: 2320 544f 444f 287a 6877 7529 3a20 7468  # TODO(zhwu): th
+00022940: 6973 2062 6568 6176 696f 7220 6e65 6564  is behavior need
+00022950: 7320 736f 6d65 2072 6574 6869 6e6b 696e  s some rethinkin
+00022960: 672e 0a20 2020 206e 616d 6520 3d20 5f67  g..    name = _g
+00022970: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
+00022980: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00022990: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+000229a0: 742d 736b 7973 6572 7665 2d75 7365 722d  t-skyserve-user-
+000229b0: 6275 672d 7265 7374 6172 7427 2c0a 2020  bug-restart',.  
+000229c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000229d0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+000229e0: 7570 202d 6e20 7b6e 616d 657d 202d 2d63  up -n {name} --c
+000229f0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00022a00: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00022a10: 7973 6572 7665 2f72 6573 7461 7274 2f75  yserve/restart/u
+00022a20: 7365 725f 6275 672e 7961 6d6c 272c 0a20  ser_bug.yaml',. 
+00022a30: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00022a40: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00022a50: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
+00022a60: 2224 7322 3b27 0a20 2020 2020 2020 2020  "$s";'.         
+00022a70: 2020 2027 756e 7469 6c20 6563 686f 2022     'until echo "
+00022a80: 2473 2220 7c20 6772 6570 202d 4120 3130  $s" | grep -A 10
+00022a90: 3020 2253 6572 7669 6365 2052 6570 6c69  0 "Service Repli
+00022aa0: 6361 7322 207c 2067 7265 7020 2253 4855  cas" | grep "SHU
+00022ab0: 5454 494e 475f 444f 574e 223b 2027 0a20  TTING_DOWN"; '. 
+00022ac0: 2020 2020 2020 2020 2020 2027 646f 2065             'do e
+00022ad0: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
+00022ae0: 2066 6972 7374 2073 6572 7669 6365 2074   first service t
+00022af0: 6f20 6265 2053 4855 5454 494e 4720 444f  o be SHUTTING DO
+00022b00: 574e 2e2e 2e22 3b20 270a 2020 2020 2020  WN..."; '.      
+00022b10: 2020 2020 2020 6627 736c 6565 7020 353b        f'sleep 5;
+00022b20: 2073 3d24 2873 6b79 2073 6572 7665 2073   s=$(sky serve s
+00022b30: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00022b40: 6368 6f20 2224 7322 3b20 646f 6e65 3b20  cho "$s"; done; 
+00022b50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00022b60: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00022b70: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00022b80: 6368 6f20 2224 7322 3b27 0a20 2020 2020  cho "$s";'.     
+00022b90: 2020 2020 2020 2027 756e 7469 6c20 6563         'until ec
+00022ba0: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+00022bb0: 4120 3130 3020 2253 6572 7669 6365 2052  A 100 "Service R
+00022bc0: 6570 6c69 6361 7322 207c 2067 7265 7020  eplicas" | grep 
+00022bd0: 2246 4149 4c45 4422 3b20 270a 2020 2020  "FAILED"; '.    
+00022be0: 2020 2020 2020 2020 2764 6f20 6563 686f          'do echo
+00022bf0: 2022 5761 6974 696e 6720 666f 7220 6669   "Waiting for fi
+00022c00: 7273 7420 7365 7276 6963 6520 746f 2062  rst service to b
+00022c10: 6520 4641 494c 4544 2e2e 2e22 3b20 270a  e FAILED..."; '.
+00022c20: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
+00022c30: 6565 7020 353b 2073 3d24 2873 6b79 2073  eep 5; s=$(sky s
+00022c40: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00022c50: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00022c60: 646f 6e65 3b20 6563 686f 2022 2473 223b  done; echo "$s";
+00022c70: 2027 0a20 2020 2020 2020 2020 2020 202b   '.            +
+00022c80: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00022c90: 696e 5f73 7461 7475 7328 6e61 6d65 2c20  in_status(name, 
+00022ca0: 5b28 312c 2054 7275 652c 2027 4641 494c  [(1, True, 'FAIL
+00022cb0: 4544 2729 5d29 202b 0a20 2020 2020 2020  ED')]) +.       
+00022cc0: 2020 2020 2023 2055 7365 7220 6275 6720       # User bug 
+00022cd0: 6661 696c 7572 6520 7769 6c6c 2063 6175  failure will cau
+00022ce0: 7365 206e 6f20 6675 7274 6865 7220 7363  se no further sc
+00022cf0: 616c 696e 672e 0a20 2020 2020 2020 2020  aling..         
+00022d00: 2020 2066 2765 6368 6f20 2224 7322 207c     f'echo "$s" |
+00022d10: 2067 7265 7020 2d41 2031 3030 2022 5365   grep -A 100 "Se
+00022d20: 7276 6963 6520 5265 706c 6963 6173 2220  rvice Replicas" 
+00022d30: 7c20 6772 6570 2022 7b6e 616d 657d 2220  | grep "{name}" 
+00022d40: 7c20 7763 202d 6c20 7c20 6772 6570 2031  | wc -l | grep 1
+00022d50: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00022d60: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
+00022d70: 6570 202d 4220 3130 3020 224e 4f5f 5245  ep -B 100 "NO_RE
+00022d80: 504c 4943 4122 207c 2067 7265 7020 2230  PLICA" | grep "0
+00022d90: 2f30 2227 2c0a 2020 2020 2020 2020 2020  /0"',.          
+00022da0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
+00022db0: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
+00022dc0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00022dd0: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
+00022de0: 7365 7276 652f 6175 746f 5f72 6573 7461  serve/auto_resta
+00022df0: 7274 2e79 616d 6c27 2c0a 2020 2020 2020  rt.yaml',.      
+00022e00: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00022e10: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00022e20: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00022e30: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00022e40: 2775 6e74 696c 2063 7572 6c20 2d4c 2068  'until curl -L h
+00022e50: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+00022e60: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00022e70: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
+00022e80: 736c 6565 7020 323b 2064 6f6e 653b 2073  sleep 2; done; s
+00022e90: 6c65 6570 2032 3b20 270a 2020 2020 2020  leep 2; '.      
+00022ea0: 2020 2020 2020 2b20 5f63 6865 636b 5f72        + _check_r
+00022eb0: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
+00022ec0: 286e 616d 652c 205b 2831 2c20 4661 6c73  (name, [(1, Fals
+00022ed0: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
+00022ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f00: 2020 2020 2020 2020 2020 2028 312c 2046             (1, F
+00022f10: 616c 7365 2c20 2746 4149 4c45 4427 295d  alse, 'FAILED')]
+00022f20: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
+00022f30: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00022f40: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00022f50: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00022f60: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00022f70: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00022f80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00022f90: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00022fa0: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+00022fb0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00022fc0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00022fd0: 7665 5f6c 6f61 645f 6261 6c61 6e63 6572  ve_load_balancer
+00022fe0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00022ff0: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
+00023000: 7420 736b 7973 6572 7665 206c 6f61 6420  t skyserve load 
+00023010: 6261 6c61 6e63 6572 2072 6f75 6e64 2d72  balancer round-r
+00023020: 6f62 696e 2070 6f6c 6963 7922 2222 0a20  obin policy""". 
+00023030: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00023040: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00023050: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00023060: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+00023070: 7973 6572 7665 2d6c 6f61 642d 6261 6c61  yserve-load-bala
+00023080: 6e63 6572 272c 0a20 2020 2020 2020 205b  ncer',.        [
+00023090: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000230a0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
+000230b0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+000230c0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+000230d0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+000230e0: 6c6f 6164 5f62 616c 616e 6365 722f 7365  load_balancer/se
+000230f0: 7276 6963 652e 7961 6d6c 272c 0a20 2020  rvice.yaml',.   
+00023100: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00023110: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00023120: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00023130: 652c 2072 6570 6c69 6361 5f6e 756d 3d33  e, replica_num=3
+00023140: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00023150: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00023160: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00023170: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00023180: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00023190: 5645 5f53 5441 5455 535f 5741 4954 2e66  VE_STATUS_WAIT.f
+000231a0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000231b0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+000231c0: 2066 277b 5f67 6574 5f72 6570 6c69 6361   f'{_get_replica
+000231d0: 5f69 7028 6e61 6d65 2c20 3129 7d3b 2027  _ip(name, 1)}; '
+000231e0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000231f0: 5f67 6574 5f72 6570 6c69 6361 5f69 7028  _get_replica_ip(
+00023200: 6e61 6d65 2c20 3229 7d3b 207b 5f67 6574  name, 2)}; {_get
+00023210: 5f72 6570 6c69 6361 5f69 7028 6e61 6d65  _replica_ip(name
+00023220: 2c20 3329 7d3b 2027 0a20 2020 2020 2020  , 3)}; '.       
+00023230: 2020 2020 2027 7079 7468 6f6e 2074 6573       'python tes
+00023240: 7473 2f73 6b79 7365 7276 652f 6c6f 6164  ts/skyserve/load
+00023250: 5f62 616c 616e 6365 722f 7465 7374 5f72  _balancer/test_r
+00023260: 6f75 6e64 5f72 6f62 696e 2e70 7920 270a  ound_robin.py '.
+00023270: 2020 2020 2020 2020 2020 2020 272d 2d65              '--e
+00023280: 6e64 706f 696e 7420 2465 6e64 706f 696e  ndpoint $endpoin
+00023290: 7420 2d2d 7265 706c 6963 612d 6e75 6d20  t --replica-num 
+000232a0: 3320 2d2d 7265 706c 6963 612d 6970 7320  3 --replica-ips 
+000232b0: 2469 7031 2024 6970 3220 2469 7033 272c  $ip1 $ip2 $ip3',
+000232c0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000232d0: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
+000232e0: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
+000232f0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00023300: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+00023310: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00023320: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00023330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00023340: 700a 4070 7974 6573 742e 6d61 726b 2e73  p.@pytest.mark.s
+00023350: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
+00023360: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
+00023370: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+00023380: 655f 6175 746f 5f72 6573 7461 7274 2829  e_auto_restart()
+00023390: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
+000233a0: 7973 6572 7665 2077 6974 6820 6175 746f  yserve with auto
+000233b0: 2072 6573 7461 7274 2222 220a 2020 2020   restart""".    
+000233c0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+000233d0: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
+000233e0: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
+000233f0: 6c31 2d61 270a 2020 2020 7465 7374 203d  l1-a'.    test =
+00023400: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
+00023410: 2774 6573 742d 736b 7973 6572 7665 2d61  'test-skyserve-a
+00023420: 7574 6f2d 7265 7374 6172 7427 2c0a 2020  uto-restart',.  
+00023430: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00023440: 2020 2020 2320 544f 444f 2874 6961 6e29      # TODO(tian)
+00023450: 3a20 7765 2063 616e 2064 796e 616d 6963  : we can dynamic
+00023460: 616c 6c79 2067 656e 6572 6174 6520 5941  ally generate YA
+00023470: 4d4c 2066 726f 6d20 7465 6d70 6c61 7465  ML from template
+00023480: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
+00023490: 2320 6176 6f69 6420 6d61 696e 7461 696e  # avoid maintain
+000234a0: 696e 6720 746f 6f20 6d61 6e79 2059 414d  ing too many YAM
+000234b0: 4c20 6669 6c65 730a 2020 2020 2020 2020  L files.        
+000234c0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+000234d0: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
+000234e0: 7465 7374 732f 736b 7973 6572 7665 2f61  tests/skyserve/a
+000234f0: 7574 6f5f 7265 7374 6172 742e 7961 6d6c  uto_restart.yaml
+00023500: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00023510: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
+00023520: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
+00023530: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
+00023540: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
+00023550: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+00023560: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+00023570: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+00023580: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00023590: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+000235a0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+000235b0: 2248 692c 2053 6b79 5069 6c6f 7420 6865  "Hi, SkyPilot he
+000235c0: 7265 2227 2c0a 2020 2020 2020 2020 2020  re"',.          
+000235d0: 2020 2320 736c 6565 7020 666f 7220 3230    # sleep for 20
+000235e0: 2073 6563 6f6e 6473 2028 696e 6974 6961   seconds (initia
+000235f0: 6c20 6465 6c61 7929 2074 6f20 6d61 6b65  l delay) to make
+00023600: 2073 7572 6520 6974 2077 696c 6c0a 2020   sure it will.  
+00023610: 2020 2020 2020 2020 2020 2320 6265 2072            # be r
+00023620: 6573 7461 7274 6564 0a20 2020 2020 2020  estarted.       
+00023630: 2020 2020 2066 2773 6c65 6570 2032 3027       f'sleep 20'
+00023640: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
+00023650: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
+00023660: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
+00023670: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
+00023680: 2023 2057 6169 7420 666f 7220 636f 6e73   # Wait for cons
+00023690: 6563 7574 6976 6520 6661 696c 7572 6520  ecutive failure 
+000236a0: 7469 6d65 6f75 7420 7061 7373 6564 2e0a  timeout passed..
+000236b0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+000236c0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+000236d0: 6e6f 7420 7573 696e 6720 7370 6f74 2c20  not using spot, 
+000236e0: 6974 2077 6f6e 2774 2063 6865 636b 2074  it won't check t
+000236f0: 6865 2063 6c75 7374 6572 2073 7461 7475  he cluster statu
+00023700: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+00023710: 6f6e 2074 6865 2063 6c6f 7564 2028 7369  on the cloud (si
+00023720: 6e63 6520 6d61 6e75 616c 2073 6875 7464  nce manual shutd
+00023730: 6f77 6e20 6973 206e 6f74 2061 2063 6f6d  own is not a com
+00023740: 6d6f 6e20 6265 6861 7669 6f72 2061 6e64  mon behavior and
+00023750: 2073 7563 680a 2020 2020 2020 2020 2020   such.          
+00023760: 2020 2320 7175 6572 6965 7320 7461 6b65    # queries take
+00023770: 7320 6120 6c6f 7420 6f66 2074 696d 6529  s a lot of time)
+00023780: 2e20 496e 7374 6561 642c 2077 6520 7468  . Instead, we th
+00023790: 696e 6b20 636f 6e74 696e 756f 7573 2033  ink continuous 3
+000237a0: 206d 696e 2070 726f 6265 0a20 2020 2020   min probe.     
+000237b0: 2020 2020 2020 2023 2066 6169 6c75 7265         # failure
+000237c0: 2069 7320 6e6f 7420 6120 7465 6d70 6f72   is not a tempor
+000237d0: 6172 7920 7072 6f62 6c65 6d20 6275 7420  ary problem but 
+000237e0: 696e 6465 6564 2061 2066 6169 6c75 7265  indeed a failure
+000237f0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+00023800: 6c65 6570 2031 3830 272c 0a20 2020 2020  leep 180',.     
+00023810: 2020 2020 2020 2023 2057 6520 6361 6e6e         # We cann
+00023820: 6f74 2075 7365 205f 5345 5256 455f 5741  ot use _SERVE_WA
+00023830: 4954 5f55 4e54 494c 5f52 4541 4459 3b20  IT_UNTIL_READY; 
+00023840: 7468 6572 6520 7769 6c6c 2062 6520 6120  there will be a 
+00023850: 696e 7465 726d 6564 6961 7465 2074 696d  intermediate tim
+00023860: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+00023870: 7468 6174 2074 6865 206f 7574 7075 7420  that the output 
+00023880: 6f66 2060 736b 7920 7365 7276 6520 7374  of `sky serve st
+00023890: 6174 7573 6020 7368 6f77 7320 4641 494c  atus` shows FAIL
+000238a0: 4544 2061 6e64 2074 6869 7320 7374 6174  ED and this stat
+000238b0: 7573 2077 696c 6c0a 2020 2020 2020 2020  us will.        
+000238c0: 2020 2020 2320 6361 7573 6520 5f53 4552      # cause _SER
+000238d0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+000238e0: 4144 5920 746f 2065 6172 6c79 2071 7569  ADY to early qui
+000238f0: 742e 0a20 2020 2020 2020 2020 2020 2027  t..            '
+00023900: 2877 6869 6c65 2074 7275 653b 2064 6f27  (while true; do'
+00023910: 0a20 2020 2020 2020 2020 2020 2066 2720  .            f' 
+00023920: 2020 206f 7574 7075 743d 2428 736b 7920     output=$(sky 
+00023930: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
+00023940: 6d65 7d29 3b27 0a20 2020 2020 2020 2020  me});'.         
+00023950: 2020 2027 2020 2020 2065 6368 6f20 2224     '     echo "$
+00023960: 6f75 7470 7574 2220 7c20 6772 6570 202d  output" | grep -
+00023970: 7120 2231 2f31 2220 2626 2062 7265 616b  q "1/1" && break
+00023980: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
+00023990: 2020 2020 2073 6c65 6570 2031 303b 270a       sleep 10;'.
+000239a0: 2020 2020 2020 2020 2020 2020 6627 646f              f'do
+000239b0: 6e65 293b 2073 6c65 6570 207b 7365 7276  ne); sleep {serv
+000239c0: 652e 4c42 5f43 4f4e 5452 4f4c 4c45 525f  e.LB_CONTROLLER_
+000239d0: 5359 4e43 5f49 4e54 4552 5641 4c5f 5345  SYNC_INTERVAL_SE
+000239e0: 434f 4e44 537d 3b27 2c0a 2020 2020 2020  CONDS};',.      
+000239f0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00023a00: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00023a10: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00023a20: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00023a30: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
+00023a40: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00023a50: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00023a60: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
+00023a70: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00023a80: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00023a90: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00023aa0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00023ab0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00023ac0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00023ad0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00023ae0: 6172 6b2e 7365 7276 650a 4070 7974 6573  ark.serve.@pytes
+00023af0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00023b00: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00023b10: 7973 6572 7665 5f63 616e 6365 6c28 6765  yserve_cancel(ge
+00023b20: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00023b30: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00023b40: 6b79 7365 7276 6520 7769 7468 2063 616e  kyserve with can
+00023b50: 6365 6c22 2222 0a20 2020 206e 616d 6520  cel""".    name 
+00023b60: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00023b70: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
+00023b80: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00023b90: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00023ba0: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+00023bb0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00023bc0: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00023bd0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00023be0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00023bf0: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00023c00: 652f 6361 6e63 656c 2f63 616e 6365 6c2e  e/cancel/cancel.
+00023c10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00023c20: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00023c30: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00023c40: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00023c50: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
+00023c60: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00023c70: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00023c80: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00023c90: 6529 7d3b 2070 7974 686f 6e33 2027 0a20  e)}; python3 '. 
+00023ca0: 2020 2020 2020 2020 2020 2027 7465 7374             'test
+00023cb0: 732f 736b 7973 6572 7665 2f63 616e 6365  s/skyserve/cance
+00023cc0: 6c2f 7365 6e64 5f63 616e 6365 6c5f 7265  l/send_cancel_re
+00023cd0: 7175 6573 742e 7079 2027 0a20 2020 2020  quest.py '.     
+00023ce0: 2020 2020 2020 2027 2d2d 656e 6470 6f69         '--endpoi
+00023cf0: 6e74 2024 656e 6470 6f69 6e74 207c 2067  nt $endpoint | g
+00023d00: 7265 7020 2252 6571 7565 7374 2077 6173  rep "Request was
+00023d10: 2063 616e 6365 6c6c 6564 2227 2c0a 2020   cancelled"',.  
+00023d20: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00023d30: 736b 7920 7365 7276 6520 6c6f 6773 207b  sky serve logs {
+00023d40: 6e61 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c  name} 1 --no-fol
+00023d50: 6c6f 7729 3b20 270a 2020 2020 2020 2020  low); '.        
+00023d60: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
+00023d70: 6f20 2224 7322 207c 2067 7265 7020 2250  o "$s" | grep "P
+00023d80: 6c65 6173 6520 7761 6974 2066 6f72 2074  lease wait for t
+00023d90: 6865 2063 6f6e 7472 6f6c 6c65 7220 746f  he controller to
+00023da0: 2062 6522 3b20 270a 2020 2020 2020 2020   be"; '.        
+00023db0: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+00023dc0: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
+00023dd0: 6c6f 6773 223b 2073 6c65 6570 2031 303b  logs"; sleep 10;
+00023de0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00023df0: 2773 3d24 2873 6b79 2073 6572 7665 206c  's=$(sky serve l
+00023e00: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
+00023e10: 6f2d 666f 6c6c 6f77 293b 2064 6f6e 653b  o-follow); done;
+00023e20: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00023e30: 6563 686f 2022 2473 223b 2065 6368 6f20  echo "$s"; echo 
+00023e40: 2224 7322 207c 2067 7265 7020 2243 6c69  "$s" | grep "Cli
+00023e50: 656e 7420 6469 7363 6f6e 6e65 6374 6564  ent disconnected
+00023e60: 2c20 7374 6f70 7069 6e67 2063 6f6d 7075  , stopping compu
+00023e70: 7461 7469 6f6e 2227 2c0a 2020 2020 2020  tation"',.      
+00023e80: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00023e90: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00023ea0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00023eb0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00023ec0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00023ed0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00023ee0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00023ef0: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
+00023f00: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
+00023f10: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
+00023f20: 5f73 6b79 7365 7276 655f 7570 6461 7465  _skyserve_update
+00023f30: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00023f40: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
+00023f50: 7420 736b 7973 6572 7665 2077 6974 6820  t skyserve with 
+00023f60: 7570 6461 7465 2222 220a 2020 2020 6e61  update""".    na
+00023f70: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+00023f80: 655f 6e61 6d65 2829 0a20 2020 2074 6573  e_name().    tes
+00023f90: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00023fa0: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
+00023fb0: 652d 7570 6461 7465 272c 0a20 2020 2020  e-update',.     
+00023fc0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00023fd0: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+00023fe0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+00023ff0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00024000: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+00024010: 7276 652f 7570 6461 7465 2f6f 6c64 2e79  rve/update/old.y
+00024020: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00024030: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+00024040: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+00024050: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00024060: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
+00024070: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00024080: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00024090: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000240a0: 297d 3b20 6375 726c 202d 4c20 6874 7470  )}; curl -L http
+000240b0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+000240c0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000240d0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
+000240e0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+000240f0: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00024100: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00024110: 5f63 6c6f 7564 7d20 2d2d 6d6f 6465 2062  _cloud} --mode b
+00024120: 6c75 655f 6772 6565 6e20 2d79 2074 6573  lue_green -y tes
+00024130: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00024140: 7465 2f6e 6577 2e79 616d 6c27 2c0a 2020  te/new.yaml',.  
+00024150: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
+00024160: 7020 6265 666f 7265 2075 7064 6174 6520  p before update 
+00024170: 6973 2072 6567 6973 7465 7265 642e 0a20  is registered.. 
+00024180: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00024190: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+000241a0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+000241b0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000241c0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+000241d0: 0a20 2020 2020 2020 2020 2020 2027 756e  .            'un
+000241e0: 7469 6c20 6375 726c 202d 4c20 6874 7470  til curl -L http
+000241f0: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+00024200: 7265 7020 2248 692c 206e 6577 2053 6b79  rep "Hi, new Sky
+00024210: 5069 6c6f 7420 6865 7265 2122 3b20 646f  Pilot here!"; do
+00024220: 2073 6c65 6570 2032 3b20 646f 6e65 3b27   sleep 2; done;'
+00024230: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
+00024240: 616b 6520 7375 7265 2074 6865 2074 7261  ake sure the tra
+00024250: 6666 6963 2069 7320 6e6f 7420 6d69 7865  ffic is not mixe
+00024260: 640a 2020 2020 2020 2020 2020 2020 2763  d.            'c
+00024270: 7572 6c20 2d4c 2068 7474 703a 2f2f 2465  url -L http://$e
+00024280: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00024290: 4869 2c20 6e65 7720 536b 7950 696c 6f74  Hi, new SkyPilot
+000242a0: 2068 6572 6522 272c 0a20 2020 2020 2020   here"',.       
+000242b0: 2020 2020 2023 2054 6865 206c 6174 6573       # The lates
+000242c0: 7420 3220 7665 7273 696f 6e20 7368 6f75  t 2 version shou
+000242d0: 6c64 2062 6520 5245 4144 5920 616e 6420  ld be READY and 
+000242e0: 7468 6520 6f6c 6465 7220 7665 7273 696f  the older versio
+000242f0: 6e73 2073 686f 756c 6420 6265 2073 6875  ns should be shu
+00024300: 7474 696e 6720 646f 776e 0a20 2020 2020  tting down.     
+00024310: 2020 2020 2020 2028 5f63 6865 636b 5f72         (_check_r
+00024320: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
+00024330: 286e 616d 652c 205b 2832 2c20 4661 6c73  (name, [(2, Fals
+00024340: 652c 2027 5245 4144 5927 292c 0a20 2020  e, 'READY'),.   
+00024350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024370: 2020 2020 2020 2020 2020 2832 2c20 4661            (2, Fa
+00024380: 6c73 652c 2027 5348 5554 5449 4e47 5f44  lse, 'SHUTTING_D
+00024390: 4f57 4e27 295d 2920 2b0a 2020 2020 2020  OWN')]) +.      
+000243a0: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+000243b0: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+000243c0: 6d65 2c20 2232 2229 292c 0a20 2020 2020  me, "2")),.     
+000243d0: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
+000243e0: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
+000243f0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00024400: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00024410: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00024420: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00024430: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00024440: 7374 2e6d 6172 6b2e 7365 7276 650a 4070  st.mark.serve.@p
+00024450: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
+00024460: 6265 726e 6574 6573 0a64 6566 2074 6573  bernetes.def tes
+00024470: 745f 736b 7973 6572 7665 5f72 6f6c 6c69  t_skyserve_rolli
+00024480: 6e67 5f75 7064 6174 6528 6765 6e65 7269  ng_update(generi
+00024490: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+000244a0: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+000244b0: 7276 6520 7769 7468 2072 6f6c 6c69 6e67  rve with rolling
+000244c0: 2075 7064 6174 6522 2222 0a20 2020 206e   update""".    n
+000244d0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+000244e0: 6365 5f6e 616d 6528 290a 2020 2020 7369  ce_name().    si
+000244f0: 6e67 6c65 5f6e 6577 5f72 6570 6c69 6361  ngle_new_replica
+00024500: 203d 205f 6368 6563 6b5f 7265 706c 6963   = _check_replic
+00024510: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
+00024520: 2020 2020 206e 616d 652c 205b 2832 2c20       name, [(2, 
+00024530: 4661 6c73 652c 2027 5245 4144 5927 292c  False, 'READY'),
+00024540: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
+00024550: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00024560: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
+00024570: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+00024580: 2046 616c 7365 2c20 2753 4855 5454 494e   False, 'SHUTTIN
+00024590: 475f 444f 574e 2729 5d29 0a20 2020 2074  G_DOWN')]).    t
+000245a0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000245b0: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+000245c0: 7276 652d 726f 6c6c 696e 672d 7570 6461  rve-rolling-upda
+000245d0: 7465 272c 0a20 2020 2020 2020 205b 0a20  te',.        [. 
+000245e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000245f0: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
+00024600: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00024610: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
+00024620: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+00024630: 6461 7465 2f6f 6c64 2e79 616d 6c27 2c0a  date/old.yaml',.
+00024640: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00024650: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00024660: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00024670: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00024680: 6d3d 3229 2c0a 2020 2020 2020 2020 2020  m=2),.          
+00024690: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+000246a0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+000246b0: 286e 616d 653d 6e61 6d65 297d 3b20 6375  (name=name)}; cu
+000246c0: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
+000246d0: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
+000246e0: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
+000246f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00024700: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
+00024710: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
+00024720: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00024730: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+00024740: 7276 652f 7570 6461 7465 2f6e 6577 2e79  rve/update/new.y
+00024750: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00024760: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
+00024770: 6520 7472 6166 6669 6320 6973 206d 6978  e traffic is mix
+00024780: 6564 2061 6372 6f73 7320 7477 6f20 7665  ed across two ve
+00024790: 7273 696f 6e73 2c20 7468 6520 7265 706c  rsions, the repl
+000247a0: 6963 6173 0a20 2020 2020 2020 2020 2020  icas.           
+000247b0: 2023 2077 6974 6820 6576 656e 2069 6420   # with even id 
+000247c0: 7769 6c6c 2073 6c65 6570 2036 3020 7365  will sleep 60 se
+000247d0: 636f 6e64 7320 6265 666f 7265 2062 6569  conds before bei
+000247e0: 6e67 2072 6561 6479 2c20 736f 2077 650a  ng ready, so we.
+000247f0: 2020 2020 2020 2020 2020 2020 2320 7368              # sh
+00024800: 6f75 6c64 2062 6520 6162 6c65 2074 6f20  ould be able to 
+00024810: 6765 7420 6f62 7365 7276 6520 7468 6520  get observe the 
+00024820: 7065 7269 6f64 2074 6861 7420 7468 6520  period that the 
+00024830: 7472 6166 6669 6320 6973 206d 6978 6564  traffic is mixed
+00024840: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+00024850: 6372 6f73 7320 7477 6f20 7665 7273 696f  cross two versio
+00024860: 6e73 2e0a 2020 2020 2020 2020 2020 2020  ns..            
+00024870: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+00024880: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+00024890: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
+000248a0: 2020 2020 2020 2020 2020 2775 6e74 696c            'until
+000248b0: 2063 7572 6c20 2d4c 2068 7474 703a 2f2f   curl -L http://
+000248c0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+000248d0: 2022 4869 2c20 6e65 7720 536b 7950 696c   "Hi, new SkyPil
+000248e0: 6f74 2068 6572 6521 223b 2064 6f20 736c  ot here!"; do sl
+000248f0: 6565 7020 323b 2064 6f6e 653b 2073 6c65  eep 2; done; sle
+00024900: 6570 2032 3b20 270a 2020 2020 2020 2020  ep 2; '.        
+00024910: 2020 2020 2320 5468 6520 6c61 7465 7374      # The latest
+00024920: 2076 6572 7369 6f6e 2073 686f 756c 6420   version should 
+00024930: 6861 7665 206f 6e65 2052 4541 4459 2061  have one READY a
+00024940: 6e64 2074 6865 206f 6e65 206f 6620 7468  nd the one of th
+00024950: 6520 6f6c 6465 7220 7665 7273 696f 6e73  e older versions
+00024960: 2073 686f 756c 6420 6265 2073 6875 7474   should be shutt
+00024970: 696e 6720 646f 776e 0a20 2020 2020 2020  ing down.       
+00024980: 2020 2020 2066 277b 7369 6e67 6c65 5f6e       f'{single_n
+00024990: 6577 5f72 6570 6c69 6361 7d20 7b5f 6368  ew_replica} {_ch
+000249a0: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
+000249b0: 696f 6e28 6e61 6d65 2c20 2231 2c32 2229  ion(name, "1,2")
+000249c0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+000249d0: 2320 4368 6563 6b20 7468 6520 6f75 7470  # Check the outp
+000249e0: 7574 2066 726f 6d20 7468 6520 6f6c 6420  ut from the old 
+000249f0: 7665 7273 696f 6e2c 2069 6d6d 6564 6961  version, immedia
+00024a00: 7465 6c79 2061 6674 6572 2074 6865 0a20  tely after the. 
+00024a10: 2020 2020 2020 2020 2020 2023 206f 7574             # out
+00024a20: 7075 7420 6672 6f6d 2074 6865 206e 6577  put from the new
+00024a30: 2076 6572 7369 6f6e 2061 7070 6561 7273   version appears
+00024a40: 2e20 5468 6973 2069 7320 6775 6172 616e  . This is guaran
+00024a50: 7465 6564 2062 7920 7468 650a 2020 2020  teed by the.    
+00024a60: 2020 2020 2020 2020 2320 726f 756e 6420          # round 
+00024a70: 726f 6269 6e20 6c6f 6164 2062 616c 616e  robin load balan
+00024a80: 6369 6e67 2070 6f6c 6963 792e 0a20 2020  cing policy..   
+00024a90: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
+00024aa0: 7a68 7775 293a 2077 6520 7368 6f75 6c64  zhwu): we should
+00024ab0: 2068 6176 6520 6120 6d6f 7265 2067 656e   have a more gen
+00024ac0: 6572 616c 697a 6564 2077 6179 2066 6f72  eralized way for
+00024ad0: 2063 6865 636b 696e 6720 7468 650a 2020   checking the.  
+00024ae0: 2020 2020 2020 2020 2020 2320 6d69 7865            # mixe
+00024af0: 6420 7665 7273 696f 6e20 6f66 2072 6570  d version of rep
+00024b00: 6c69 6361 7320 746f 2061 766f 6964 2064  licas to avoid d
+00024b10: 6570 656e 6469 6e67 206f 6e20 7468 6520  epending on the 
+00024b20: 7370 6563 6966 6963 0a20 2020 2020 2020  specific.       
+00024b30: 2020 2020 2023 2072 6f75 6e64 2072 6f62       # round rob
+00024b40: 696e 206c 6f61 6420 6261 6c61 6e63 696e  in load balancin
+00024b50: 6720 706f 6c69 6379 2e0a 2020 2020 2020  g policy..      
+00024b60: 2020 2020 2020 2763 7572 6c20 2d4c 2068        'curl -L h
+00024b70: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
+00024b80: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+00024b90: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+00024ba0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00024bb0: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
+00024bc0: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
+00024bd0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00024be0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00024bf0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00024c00: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00024c10: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
+00024c20: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00024c30: 6b75 6265 726e 6574 6573 0a64 6566 2074  kubernetes.def t
+00024c40: 6573 745f 736b 7973 6572 7665 5f66 6173  est_skyserve_fas
+00024c50: 745f 7570 6461 7465 2867 656e 6572 6963  t_update(generic
+00024c60: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00024c70: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+00024c80: 7665 2077 6974 6820 6661 7374 2075 7064  ve with fast upd
+00024c90: 6174 6520 2849 6e63 7265 6d65 6e74 2076  ate (Increment v
+00024ca0: 6572 7369 6f6e 206f 6620 6f6c 6420 7265  ersion of old re
+00024cb0: 706c 6963 6173 2922 2222 0a20 2020 206e  plicas)""".    n
+00024cc0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
+00024cd0: 6365 5f6e 616d 6528 290a 0a20 2020 2074  ce_name()..    t
+00024ce0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00024cf0: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00024d00: 7276 652d 6661 7374 2d75 7064 6174 6527  rve-fast-update'
+00024d10: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00024d20: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00024d30: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+00024d40: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
+00024d50: 6572 6963 5f63 6c6f 7564 7d20 7465 7374  eric_cloud} test
+00024d60: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+00024d70: 652f 6275 6d70 5f76 6572 7369 6f6e 5f62  e/bump_version_b
+00024d80: 6566 6f72 652e 7961 6d6c 272c 0a20 2020  efore.yaml',.   
+00024d90: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00024da0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00024db0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00024dc0: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
+00024dd0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00024de0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00024df0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00024e00: 6d65 3d6e 616d 6529 7d3b 2063 7572 6c20  me=name)}; curl 
+00024e10: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
+00024e20: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+00024e30: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
+00024e40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00024e50: 6b79 2073 6572 7665 2075 7064 6174 6520  ky serve update 
+00024e60: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00024e70: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00024e80: 2d6d 6f64 6520 626c 7565 5f67 7265 656e  -mode blue_green
+00024e90: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00024ea0: 7665 2f75 7064 6174 652f 6275 6d70 5f76  ve/update/bump_v
+00024eb0: 6572 7369 6f6e 5f61 6674 6572 2e79 616d  ersion_after.yam
+00024ec0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00024ed0: 2320 736c 6565 7020 746f 2077 6169 7420  # sleep to wait 
+00024ee0: 666f 7220 7570 6461 7465 2074 6f20 6265  for update to be
+00024ef0: 2072 6567 6973 7465 7265 642e 0a20 2020   registered..   
+00024f00: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00024f10: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
+00024f20: 2020 2320 3220 6f6e 2d64 6561 6d6e 6420    # 2 on-deamnd 
+00024f30: 2872 6561 6479 2920 2b20 3120 6f6e 2d64  (ready) + 1 on-d
+00024f40: 656d 616e 6420 2870 726f 7669 7369 6f6e  emand (provision
+00024f50: 696e 6729 2e0a 2020 2020 2020 2020 2020  ing)..          
+00024f60: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
+00024f70: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+00024f80: 6361 5f69 6e5f 7374 6174 7573 280a 2020  ca_in_status(.  
+00024f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fa0: 2020 6e61 6d65 2c20 5b28 322c 2046 616c    name, [(2, Fal
+00024fb0: 7365 2c20 2752 4541 4459 2729 2c0a 2020  se, 'READY'),.  
+00024fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fd0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
+00024fe0: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
+00024ff0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+00025000: 4745 5829 5d29 202b 0a20 2020 2020 2020  GEX)]) +.       
+00025010: 2020 2020 2020 2020 2023 2046 6173 7420           # Fast 
+00025020: 7570 6461 7465 2077 696c 6c20 6469 7265  update will dire
+00025030: 6374 6c79 2068 6176 6520 7468 6520 6c61  ctly have the la
+00025040: 7465 7374 2076 6572 7369 6f6e 2072 6561  test version rea
+00025050: 6479 2e0a 2020 2020 2020 2020 2020 2020  dy..            
+00025060: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
+00025070: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
+00025080: 2022 3222 2929 2c0a 2020 2020 2020 2020   "2")),.        
+00025090: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+000250a0: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+000250b0: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+000250c0: 706c 6963 615f 6e75 6d3d 3329 202b 0a20  plica_num=3) +. 
+000250d0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+000250e0: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
+000250f0: 6e28 6e61 6d65 2c20 2232 2229 2c0a 2020  n(name, "2"),.  
+00025100: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00025110: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00025120: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00025130: 6d65 297d 3b20 6375 726c 202d 4c20 6874  me)}; curl -L ht
+00025140: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00025150: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00025160: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00025170: 2020 2020 2020 2020 2320 5465 7374 2072          # Test r
+00025180: 6f6c 6c69 6e67 2075 7064 6174 650a 2020  olling update.  
+00025190: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000251a0: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
+000251b0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+000251c0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
+000251d0: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+000251e0: 6461 7465 2f62 756d 705f 7665 7273 696f  date/bump_versio
+000251f0: 6e5f 6265 666f 7265 2e79 616d 6c27 2c0a  n_before.yaml',.
+00025200: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
+00025210: 6565 7020 746f 2077 6169 7420 666f 7220  eep to wait for 
+00025220: 7570 6461 7465 2074 6f20 6265 2072 6567  update to be reg
+00025230: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
+00025240: 2020 2020 2027 736c 6565 7020 3330 272c       'sleep 30',
+00025250: 0a20 2020 2020 2020 2020 2020 2023 2032  .            # 2
+00025260: 206f 6e2d 6465 616d 6e64 2028 7265 6164   on-deamnd (read
+00025270: 7929 202b 2031 206f 6e2d 6465 6d61 6e64  y) + 1 on-demand
+00025280: 2028 7368 7574 7469 6e67 2064 6f77 6e29   (shutting down)
+00025290: 2e0a 2020 2020 2020 2020 2020 2020 5f63  ..            _c
+000252a0: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+000252b0: 7374 6174 7573 286e 616d 652c 205b 2832  status(name, [(2
+000252c0: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
+000252d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000252e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252f0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00025300: 312c 2046 616c 7365 2c20 2753 4855 5454  1, False, 'SHUTT
+00025310: 494e 475f 444f 574e 2729 5d29 2c0a 2020  ING_DOWN')]),.  
+00025320: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00025330: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00025340: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+00025350: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+00025360: 3229 202b 0a20 2020 2020 2020 2020 2020  2) +.           
+00025370: 205f 6368 6563 6b5f 7365 7276 6963 655f   _check_service_
+00025380: 7665 7273 696f 6e28 6e61 6d65 2c20 2233  version(name, "3
+00025390: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+000253a0: 6627 7b5f 5345 5256 455f 454e 4450 4f49  f'{_SERVE_ENDPOI
+000253b0: 4e54 5f57 4149 542e 666f 726d 6174 286e  NT_WAIT.format(n
+000253c0: 616d 653d 6e61 6d65 297d 3b20 6375 726c  ame=name)}; curl
+000253d0: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
+000253e0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+000253f0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00025400: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00025410: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+00025420: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+00025430: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00025440: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+00025450: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00025460: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00025470: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+00025480: 6572 7665 0a40 7079 7465 7374 2e6d 6172  erve.@pytest.mar
+00025490: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 730a  k.no_kubernetes.
+000254a0: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
+000254b0: 655f 7570 6461 7465 5f61 7574 6f73 6361  e_update_autosca
+000254c0: 6c65 2867 656e 6572 6963 5f63 6c6f 7564  le(generic_cloud
+000254d0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
+000254e0: 6573 7420 736b 7973 6572 7665 2075 7064  est skyserve upd
+000254f0: 6174 6520 7769 7468 2061 7574 6f73 6361  ate with autosca
+00025500: 6c65 2222 220a 2020 2020 6e61 6d65 203d  le""".    name =
+00025510: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00025520: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00025530: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
+00025540: 7465 7374 2d73 6b79 7365 7276 652d 7570  test-skyserve-up
+00025550: 6461 7465 2d61 7574 6f73 6361 6c65 272c  date-autoscale',
+00025560: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00025570: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00025580: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00025590: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000255a0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+000255b0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+000255c0: 2f6e 756d 5f6d 696e 5f74 776f 2e79 616d  /num_min_two.yam
+000255d0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000255e0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+000255f0: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00025600: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00025610: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
+00025620: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+00025630: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00025640: 6d65 2c20 2231 2229 2c0a 2020 2020 2020  me, "1"),.      
+00025650: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00025660: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00025670: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00025680: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00025690: 2763 7572 6c20 2d4c 2068 7474 703a 2f2f  'curl -L http://
+000256a0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+000256b0: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+000256c0: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
+000256d0: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+000256e0: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
+000256f0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00025700: 6f75 647d 202d 2d6d 6f64 6520 626c 7565  oud} --mode blue
+00025710: 5f67 7265 656e 202d 7920 7465 7374 732f  _green -y tests/
+00025720: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00025730: 6e75 6d5f 6d69 6e5f 6f6e 652e 7961 6d6c  num_min_one.yaml
+00025740: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00025750: 2073 6c65 6570 2062 6566 6f72 6520 7570   sleep before up
+00025760: 6461 7465 2069 7320 7265 6769 7374 6572  date is register
+00025770: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00025780: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+00025790: 2020 2020 2020 2020 2320 5469 6d65 6f75          # Timeou
+000257a0: 7420 7769 6c6c 2062 6520 7472 6967 6765  t will be trigge
+000257b0: 7265 6420 7768 656e 2075 7064 6174 6520  red when update 
+000257c0: 6661 696c 732e 0a20 2020 2020 2020 2020  fails..         
+000257d0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+000257e0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+000257f0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00025800: 6c69 6361 5f6e 756d 3d31 2920 2b0a 2020  lica_num=1) +.  
+00025810: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00025820: 5f73 6572 7669 6365 5f76 6572 7369 6f6e  _service_version
+00025830: 286e 616d 652c 2022 3222 292c 0a20 2020  (name, "2"),.   
+00025840: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00025850: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00025860: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025870: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+00025880: 2020 2027 6375 726c 202d 4c20 6874 7470     'curl -L http
+00025890: 3a2f 2f24 656e 6470 6f69 6e74 207c 2067  ://$endpoint | g
+000258a0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
+000258b0: 7420 6865 7265 2122 272c 0a20 2020 2020  t here!"',.     
+000258c0: 2020 2020 2020 2023 2052 6f6c 6c69 6e67         # Rolling
+000258d0: 2055 7064 6174 650a 2020 2020 2020 2020   Update.        
+000258e0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
+000258f0: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
+00025900: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+00025910: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+00025920: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
+00025930: 756d 5f6d 696e 5f74 776f 2e79 616d 6c27  um_min_two.yaml'
+00025940: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00025950: 736c 6565 7020 6265 666f 7265 2075 7064  sleep before upd
+00025960: 6174 6520 6973 2072 6567 6973 7465 7265  ate is registere
+00025970: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+00025980: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
+00025990: 2020 2020 2020 2023 2054 696d 656f 7574         # Timeout
+000259a0: 2077 696c 6c20 6265 2074 7269 6767 6572   will be trigger
+000259b0: 6564 2077 6865 6e20 7570 6461 7465 2066  ed when update f
+000259c0: 6169 6c73 2e0a 2020 2020 2020 2020 2020  ails..          
+000259d0: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
+000259e0: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
+000259f0: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
+00025a00: 6963 615f 6e75 6d3d 3229 202b 0a20 2020  ica_num=2) +.   
+00025a10: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
+00025a20: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
+00025a30: 6e61 6d65 2c20 2233 2229 2c0a 2020 2020  name, "3"),.    
+00025a40: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
+00025a50: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
+00025a60: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00025a70: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+00025a80: 2020 2763 7572 6c20 2d4c 2068 7474 703a    'curl -L http:
+00025a90: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00025aa0: 6570 2022 4869 2c20 536b 7950 696c 6f74  ep "Hi, SkyPilot
+00025ab0: 2068 6572 6521 2227 2c0a 2020 2020 2020   here!"',.      
+00025ac0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00025ad0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00025ae0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00025af0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00025b00: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
+00025b10: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00025b20: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00025b30: 742e 6d61 726b 2e73 6572 7665 0a40 7079  t.mark.serve.@py
+00025b40: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+00025b50: 7472 697a 6528 276d 6f64 6527 2c20 5b27  trize('mode', ['
+00025b60: 726f 6c6c 696e 6727 2c20 2762 6c75 655f  rolling', 'blue_
+00025b70: 6772 6565 6e27 5d29 0a40 7079 7465 7374  green']).@pytest
+00025b80: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
+00025b90: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
+00025ba0: 7365 7276 655f 6e65 775f 6175 746f 7363  serve_new_autosc
+00025bb0: 616c 6572 5f75 7064 6174 6528 6d6f 6465  aler_update(mode
+00025bc0: 3a20 7374 722c 2067 656e 6572 6963 5f63  : str, generic_c
+00025bd0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00025be0: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
+00025bf0: 2077 6974 6820 7570 6461 7465 2074 6861   with update tha
+00025c00: 7420 6368 616e 6765 7320 6175 746f 7363  t changes autosc
+00025c10: 616c 6572 2222 220a 2020 2020 6e61 6d65  aler""".    name
+00025c20: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00025c30: 6e61 6d65 2829 202b 206d 6f64 650a 0a20  name() + mode.. 
+00025c40: 2020 2066 6f75 725f 7370 6f74 5f75 705f     four_spot_up_
+00025c50: 636d 6420 3d20 5f63 6865 636b 5f72 6570  cmd = _check_rep
+00025c60: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
+00025c70: 616d 652c 205b 2834 2c20 5472 7565 2c20  ame, [(4, True, 
+00025c80: 2752 4541 4459 2729 5d29 0a20 2020 2075  'READY')]).    u
+00025c90: 7064 6174 655f 6368 6563 6b20 3d20 5b66  pdate_check = [f
+00025ca0: 2775 6e74 696c 2028 7b66 6f75 725f 7370  'until ({four_sp
+00025cb0: 6f74 5f75 705f 636d 647d 293b 2064 6f20  ot_up_cmd}); do 
+00025cc0: 736c 6565 7020 353b 2064 6f6e 653b 2073  sleep 5; done; s
+00025cd0: 6c65 6570 2031 303b 275d 0a20 2020 2069  leep 10;'].    i
+00025ce0: 6620 6d6f 6465 203d 3d20 2772 6f6c 6c69  f mode == 'rolli
+00025cf0: 6e67 273a 0a20 2020 2020 2020 2023 2043  ng':.        # C
+00025d00: 6865 636b 2072 6f6c 6c69 6e67 2075 7064  heck rolling upd
+00025d10: 6174 652c 2069 7420 7769 6c6c 2074 6572  ate, it will ter
+00025d20: 6d69 6e61 7465 206f 6e65 206f 6620 7468  minate one of th
+00025d30: 6520 6f6c 6420 6f6e 2d64 656d 616e 640a  e old on-demand.
+00025d40: 2020 2020 2020 2020 2320 696e 7374 616e          # instan
+00025d50: 6365 732c 206f 6e63 6520 7468 6572 6520  ces, once there 
+00025d60: 6172 6520 3420 7370 6f74 2069 6e73 7461  are 4 spot insta
+00025d70: 6e63 6520 7265 6164 792e 0a20 2020 2020  nce ready..     
+00025d80: 2020 2075 7064 6174 655f 6368 6563 6b20     update_check 
+00025d90: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
+00025da0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00025db0: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+00025dc0: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+00025dd0: 205b 2831 2c20 4661 6c73 652c 205f 5345   [(1, False, _SE
+00025de0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00025df0: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+00025e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e10: 2020 2020 2020 2831 2c20 4661 6c73 652c        (1, False,
+00025e20: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
+00025e30: 292c 2028 312c 2046 616c 7365 2c20 2752  ), (1, False, 'R
+00025e40: 4541 4459 2729 5d29 202b 0a20 2020 2020  EADY')]) +.     
+00025e50: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+00025e60: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00025e70: 6d65 2c20 2231 2c32 2229 2c0a 2020 2020  me, "1,2"),.    
+00025e80: 2020 2020 5d0a 2020 2020 656c 7365 3a0a      ].    else:.
+00025e90: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00025ea0: 626c 7565 2067 7265 656e 2075 7064 6174  blue green updat
+00025eb0: 652c 2069 7420 7769 6c6c 206b 6565 7020  e, it will keep 
+00025ec0: 626f 7468 206f 6c64 206f 6e2d 6465 6d61  both old on-dema
+00025ed0: 6e64 2069 6e73 7461 6e63 6573 0a20 2020  nd instances.   
+00025ee0: 2020 2020 2023 2072 756e 6e69 6e67 2c20       # running, 
+00025ef0: 6f6e 6365 2074 6865 7265 2061 7265 2034  once there are 4
+00025f00: 2073 706f 7420 696e 7374 616e 6365 2072   spot instance r
+00025f10: 6561 6479 2e0a 2020 2020 2020 2020 7570  eady..        up
+00025f20: 6461 7465 5f63 6865 636b 202b 3d20 5b0a  date_check += [.
+00025f30: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
+00025f40: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
+00025f50: 6174 7573 280a 2020 2020 2020 2020 2020  atus(.          
+00025f60: 2020 2020 2020 6e61 6d65 2c20 5b28 312c        name, [(1,
+00025f70: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+00025f80: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+00025f90: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
+00025fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025fb0: 2028 322c 2046 616c 7365 2c20 2752 4541   (2, False, 'REA
+00025fc0: 4459 2729 5d29 202b 0a20 2020 2020 2020  DY')]) +.       
+00025fd0: 2020 2020 205f 6368 6563 6b5f 7365 7276       _check_serv
+00025fe0: 6963 655f 7665 7273 696f 6e28 6e61 6d65  ice_version(name
+00025ff0: 2c20 2231 2229 2c0a 2020 2020 2020 2020  , "1"),.        
+00026000: 5d0a 2020 2020 7465 7374 203d 2054 6573  ].    test = Tes
+00026010: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
+00026020: 2d73 6b79 7365 7276 652d 6e65 772d 6175  -skyserve-new-au
+00026030: 746f 7363 616c 6572 2d75 7064 6174 6527  toscaler-update'
+00026040: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00026050: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00026060: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+00026070: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00026080: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
+00026090: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+000260a0: 652f 6e65 775f 6175 746f 7363 616c 6572  e/new_autoscaler
+000260b0: 5f62 6566 6f72 652e 7961 6d6c 272c 0a20  _before.yaml',. 
+000260c0: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
+000260d0: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
+000260e0: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
+000260f0: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
+00026100: 3d32 2920 2b0a 2020 2020 2020 2020 2020  =2) +.          
+00026110: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
+00026120: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
+00026130: 3122 292c 0a20 2020 2020 2020 2020 2020  1"),.           
+00026140: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
+00026150: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
+00026160: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
+00026170: 2020 2020 2020 2020 2020 2027 733d 2428             's=$(
+00026180: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
+00026190: 656e 6470 6f69 6e74 293b 2065 6368 6f20  endpoint); echo 
+000261a0: 2224 7322 3b20 6563 686f 2022 2473 2220  "$s"; echo "$s" 
+000261b0: 7c20 6772 6570 2022 4869 2c20 536b 7950  | grep "Hi, SkyP
+000261c0: 696c 6f74 2068 6572 6522 272c 0a20 2020  ilot here"',.   
+000261d0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000261e0: 6572 7665 2075 7064 6174 6520 7b6e 616d  erve update {nam
+000261f0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00026200: 7269 635f 636c 6f75 647d 202d 2d6d 6f64  ric_cloud} --mod
+00026210: 6520 7b6d 6f64 657d 202d 7920 7465 7374  e {mode} -y test
+00026220: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
+00026230: 652f 6e65 775f 6175 746f 7363 616c 6572  e/new_autoscaler
+00026240: 5f61 6674 6572 2e79 616d 6c27 2c0a 2020  _after.yaml',.  
+00026250: 2020 2020 2020 2020 2020 2320 5761 6974            # Wait
+00026260: 2066 6f72 2075 7064 6174 6520 746f 2062   for update to b
+00026270: 6520 7265 6769 7374 6572 6564 0a20 2020  e registered.   
+00026280: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+00026290: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
+000262a0: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+000262b0: 615f 696e 5f73 7461 7475 7328 0a20 2020  a_in_status(.   
+000262c0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
+000262d0: 652c 205b 2834 2c20 5472 7565 2c20 5f53  e, [(4, True, _S
+000262e0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+000262f0: 5f53 5441 5455 535f 5245 4745 5820 2b20  _STATUS_REGEX + 
+00026300: 275c 7c52 4541 4459 2729 2c0a 2020 2020  '\|READY'),.    
+00026310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026320: 2020 2028 312c 2046 616c 7365 2c20 5f53     (1, False, _S
+00026330: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+00026340: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
+00026350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026360: 2020 2020 2020 2028 322c 2046 616c 7365         (2, False
+00026370: 2c20 2752 4541 4459 2729 5d29 2c0a 2020  , 'READY')]),.  
+00026380: 2020 2020 2020 2020 2020 2a75 7064 6174            *updat
+00026390: 655f 6368 6563 6b2c 0a20 2020 2020 2020  e_check,.       
+000263a0: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
+000263b0: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
+000263c0: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
+000263d0: 6570 6c69 6361 5f6e 756d 3d35 292c 0a20  eplica_num=5),. 
+000263e0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+000263f0: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
+00026400: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00026410: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00026420: 2020 2020 2027 6375 726c 202d 4c20 6874       'curl -L ht
+00026430: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00026440: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00026450: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00026460: 2020 2020 2020 2020 5f63 6865 636b 5f72          _check_r
+00026470: 6570 6c69 6361 5f69 6e5f 7374 6174 7573  eplica_in_status
+00026480: 286e 616d 652c 205b 2834 2c20 5472 7565  (name, [(4, True
+00026490: 2c20 2752 4541 4459 2729 2c0a 2020 2020  , 'READY'),.    
+000264a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000264b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000264c0: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
+000264d0: 652c 2027 5245 4144 5927 295d 292c 0a20  e, 'READY')]),. 
+000264e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000264f0: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
+00026500: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
+00026510: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00026520: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+00026530: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00026540: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00026550: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00026560: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
+00026570: 7276 655f 6661 696c 7572 6573 2867 656e  rve_failures(gen
+00026580: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00026590: 3a0a 2020 2020 2222 2254 6573 7420 7265  :.    """Test re
+000265a0: 706c 6963 6120 6661 696c 7572 6520 7374  plica failure st
+000265b0: 6174 7573 6573 2222 220a 2020 2020 6e61  atuses""".    na
+000265c0: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
+000265d0: 655f 6e61 6d65 2829 0a0a 2020 2020 7465  e_name()..    te
+000265e0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+000265f0: 2020 2027 7465 7374 2d73 6b79 7365 7276     'test-skyserv
+00026600: 652d 6661 696c 7572 6573 272c 0a20 2020  e-failures',.   
+00026610: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00026620: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00026630: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
+00026640: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00026650: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
+00026660: 7365 7276 652f 6661 696c 7572 6573 2f69  serve/failures/i
+00026670: 6e69 7469 616c 5f64 656c 6179 2e79 616d  nitial_delay.yam
+00026680: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00026690: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
+000266a0: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+000266b0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+000266c0: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
+000266d0: 7c20 6772 6570 2022 4641 494c 4544 5f49  | grep "FAILED_I
+000266e0: 4e49 5449 414c 5f44 454c 4159 223b 2064  NITIAL_DELAY"; d
+000266f0: 6f20 270a 2020 2020 2020 2020 2020 2020  o '.            
+00026700: 2765 6368 6f20 2257 6169 7469 6e67 2066  'echo "Waiting f
+00026710: 6f72 2072 6570 6c69 6361 2074 6f20 6265  or replica to be
+00026720: 2066 6169 6c65 642e 2e2e 223b 2073 6c65   failed..."; sle
+00026730: 6570 2035 3b20 270a 2020 2020 2020 2020  ep 5; '.        
+00026740: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
+00026750: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00026760: 7d29 3b20 6563 686f 2022 2473 223b 2064  }); echo "$s"; d
+00026770: 6f6e 653b 272c 0a20 2020 2020 2020 2020  one;',.         
+00026780: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+00026790: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+000267a0: 4552 5645 5f53 5441 5455 535f 5741 4954  ERVE_STATUS_WAIT
+000267b0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000267c0: 6529 7d3b 2065 6368 6f20 2224 7322 207c  e)}; echo "$s" |
+000267d0: 2067 7265 7020 227b 6e61 6d65 7d22 207c   grep "{name}" |
+000267e0: 2067 7265 7020 2246 4149 4c45 445f 494e   grep "FAILED_IN
+000267f0: 4954 4941 4c5f 4445 4c41 5922 207c 2077  ITIAL_DELAY" | w
+00026800: 6320 2d6c 207c 2067 7265 7020 323b 2027  c -l | grep 2; '
+00026810: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
+00026820: 616b 6520 7375 7265 206e 6f20 6e65 7720  ake sure no new 
+00026830: 7265 706c 6963 6173 2061 7265 2073 7461  replicas are sta
+00026840: 7274 6564 2066 6f72 2065 6172 6c79 2066  rted for early f
+00026850: 6169 6c75 7265 2e0a 2020 2020 2020 2020  ailure..        
+00026860: 2020 2020 6627 6563 686f 2022 2473 2220      f'echo "$s" 
+00026870: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
+00026880: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+00026890: 207c 2067 7265 7020 227b 6e61 6d65 7d22   | grep "{name}"
+000268a0: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
+000268b0: 323b 272c 0a20 2020 2020 2020 2020 2020  2;',.           
+000268c0: 2066 2773 6b79 2073 6572 7665 2075 7064   f'sky serve upd
+000268d0: 6174 6520 7b6e 616d 657d 202d 2d63 6c6f  ate {name} --clo
+000268e0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+000268f0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
+00026900: 6572 7665 2f66 6169 6c75 7265 732f 7072  erve/failures/pr
+00026910: 6f62 696e 672e 7961 6d6c 272c 0a20 2020  obing.yaml',.   
+00026920: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00026930: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
+00026940: 7b6e 616d 657d 293b 2027 0a20 2020 2020  {name}); '.     
+00026950: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
+00026960: 7220 7265 706c 6963 6120 746f 2062 6520  r replica to be 
+00026970: 7265 6164 792e 0a20 2020 2020 2020 2020  ready..         
+00026980: 2020 2066 2775 6e74 696c 2065 6368 6f20     f'until echo 
+00026990: 2224 7322 207c 2067 7265 7020 2252 4541  "$s" | grep "REA
+000269a0: 4459 223b 2064 6f20 270a 2020 2020 2020  DY"; do '.      
+000269b0: 2020 2020 2020 2765 6368 6f20 2257 6169        'echo "Wai
+000269c0: 7469 6e67 2066 6f72 2072 6570 6c69 6361  ting for replica
+000269d0: 2074 6f20 6265 2066 6169 6c65 642e 2e2e   to be failed...
+000269e0: 223b 2073 6c65 6570 2035 3b20 270a 2020  "; sleep 5; '.  
+000269f0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00026a00: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+00026a10: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+00026a20: 2473 223b 2064 6f6e 653b 272c 0a20 2020  $s"; done;',.   
+00026a30: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+00026a40: 666f 7220 7265 706c 6963 6120 746f 2063  for replica to c
+00026a50: 6861 6e67 6520 746f 2046 4149 4c45 445f  hange to FAILED_
+00026a60: 5052 4f42 494e 470a 2020 2020 2020 2020  PROBING.        
+00026a70: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
+00026a80: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00026a90: 7d29 3b20 270a 2020 2020 2020 2020 2020  }); '.          
+00026aa0: 2020 6627 756e 7469 6c20 6563 686f 2022    f'until echo "
+00026ab0: 2473 2220 7c20 6772 6570 2022 4641 494c  $s" | grep "FAIL
+00026ac0: 4544 5f50 524f 4249 4e47 223b 2064 6f20  ED_PROBING"; do 
+00026ad0: 270a 2020 2020 2020 2020 2020 2020 2765  '.            'e
+00026ae0: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
+00026af0: 2072 6570 6c69 6361 2074 6f20 6265 2066   replica to be f
+00026b00: 6169 6c65 642e 2e2e 223b 2073 6c65 6570  ailed..."; sleep
+00026b10: 2035 3b20 270a 2020 2020 2020 2020 2020   5; '.          
+00026b20: 2020 6627 733d 2428 736b 7920 7365 7276    f's=$(sky serv
+00026b30: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+00026b40: 3b20 6563 686f 2022 2473 223b 2064 6f6e  ; echo "$s"; don
+00026b50: 653b 2720 2b0a 2020 2020 2020 2020 2020  e;' +.          
+00026b60: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00026b70: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00026b80: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00026b90: 2c20 5b28 312c 2046 616c 7365 2c20 2746  , [(1, False, 'F
+00026ba0: 4149 4c45 445f 5052 4f42 494e 4727 292c  AILED_PROBING'),
+00026bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026bc0: 2020 2020 2020 2020 2831 2c20 4661 6c73          (1, Fals
+00026bd0: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+00026be0: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00026bf0: 4558 295d 292c 0a20 2020 2020 2020 2020  EX)]),.         
+00026c00: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+00026c10: 2061 6464 2074 6573 7420 666f 7220 4641   add test for FA
+00026c20: 494c 4544 5f50 524f 5649 5349 4f4e 0a20  ILED_PROVISION. 
+00026c30: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00026c40: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
+00026c50: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
+00026c60: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00026c70: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+00026c80: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00026c90: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00026ca0: 2054 4f44 4f28 5a69 6d69 6e67 2c20 5469   TODO(Ziming, Ti
+00026cb0: 616e 293a 2041 6464 2074 6573 7473 2066  an): Add tests f
+00026cc0: 6f72 2061 7574 6f73 6361 6c69 6e67 2e0a  or autoscaling..
+00026cd0: 0a0a 2320 2d2d 2d2d 2d2d 2d20 5465 7374  ..# ------- Test
+00026ce0: 696e 6720 7573 6572 2072 6179 2063 6c75  ing user ray clu
+00026cf0: 7374 6572 202d 2d2d 2d2d 2d2d 2d0a 6465  ster --------.de
+00026d00: 6620 7465 7374 5f75 7365 725f 7261 795f  f test_user_ray_
+00026d10: 636c 7573 7465 7228 6765 6e65 7269 635f  cluster(generic_
+00026d20: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00026d30: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00026d40: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00026d50: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00026d60: 2020 2020 2027 7573 6572 2d72 6179 2d63       'user-ray-c
+00026d70: 6c75 7374 6572 272c 0a20 2020 2020 2020  luster',.       
+00026d80: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00026d90: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00026da0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00026db0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00026dc0: 2022 7261 7920 7374 6172 7420 2d2d 6865   "ray start --he
+00026dd0: 6164 2227 2c0a 2020 2020 2020 2020 2020  ad"',.          
+00026de0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00026df0: 6d65 7d20 2265 6368 6f20 6869 2227 2c0a  me} "echo hi"',.
+00026e00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00026e10: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00026e20: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00026e30: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00026e40: 7475 7320 2d72 207b 6e61 6d65 7d20 7c20  tus -r {name} | 
+00026e50: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
+00026e60: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00026e70: 207b 6e61 6d65 7d20 2265 6368 6f20 6279   {name} "echo by
+00026e80: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+00026e90: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00026ea0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+00026eb0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00026ec0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00026ed0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00026ee0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00026ef0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00026f00: 2d2d 2054 6573 7469 6e67 2074 6865 2063  -- Testing the c
+00026f10: 6f72 6520 4150 4920 2d2d 2d2d 2d2d 2d2d  ore API --------
+00026f20: 0a23 204d 6f73 7420 6f66 2074 6865 2063  .# Most of the c
+00026f30: 6f72 6520 4150 4973 2068 6176 6520 6265  ore APIs have be
+00026f40: 656e 2074 6573 7465 6420 696e 2074 6865  en tested in the
+00026f50: 2043 4c49 2074 6573 7473 2e0a 2320 5468   CLI tests..# Th
+00026f60: 6573 6520 7465 7374 7320 6172 6520 666f  ese tests are fo
+00026f70: 7220 7465 7374 696e 6720 7468 6520 7265  r testing the re
+00026f80: 7475 726e 2076 616c 7565 206f 6620 7468  turn value of th
+00026f90: 6520 4150 4973 206e 6f74 2066 756c 6c79  e APIs not fully
+00026fa0: 2075 7365 6420 696e 2043 4c49 2e0a 0a0a   used in CLI....
+00026fb0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00026fc0: 0a64 6566 2074 6573 745f 636f 7265 5f61  .def test_core_a
+00026fd0: 7069 5f73 6b79 5f6c 6175 6e63 685f 6578  pi_sky_launch_ex
+00026fe0: 6563 2829 3a0a 2020 2020 6e61 6d65 203d  ec():.    name =
+00026ff0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00027000: 6d65 2829 0a20 2020 2074 6173 6b20 3d20  me().    task = 
+00027010: 736b 792e 5461 736b 2872 756e 3d22 7768  sky.Task(run="wh
+00027020: 6f61 6d69 2229 0a20 2020 2074 6173 6b2e  oami").    task.
+00027030: 7365 745f 7265 736f 7572 6365 7328 736b  set_resources(sk
+00027040: 792e 5265 736f 7572 6365 7328 636c 6f75  y.Resources(clou
+00027050: 643d 736b 792e 4743 5028 2929 290a 2020  d=sky.GCP())).  
+00027060: 2020 6a6f 625f 6964 2c20 6861 6e64 6c65    job_id, handle
+00027070: 203d 2073 6b79 2e6c 6175 6e63 6828 7461   = sky.launch(ta
+00027080: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
+00027090: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
+000270a0: 7420 6a6f 625f 6964 203d 3d20 310a 2020  t job_id == 1.  
+000270b0: 2020 6173 7365 7274 2068 616e 646c 6520    assert handle 
+000270c0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+000270d0: 6173 7365 7274 2068 616e 646c 652e 636c  assert handle.cl
+000270e0: 7573 7465 725f 6e61 6d65 203d 3d20 6e61  uster_name == na
+000270f0: 6d65 0a20 2020 2061 7373 6572 7420 6861  me.    assert ha
+00027100: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
+00027110: 736f 7572 6365 732e 636c 6f75 642e 6973  sources.cloud.is
+00027120: 5f73 616d 655f 636c 6f75 6428 736b 792e  _same_cloud(sky.
+00027130: 4743 5028 2929 0a20 2020 206a 6f62 5f69  GCP()).    job_i
+00027140: 645f 6578 6563 2c20 6861 6e64 6c65 5f65  d_exec, handle_e
+00027150: 7865 6320 3d20 736b 792e 6578 6563 2874  xec = sky.exec(t
+00027160: 6173 6b2c 2063 6c75 7374 6572 5f6e 616d  ask, cluster_nam
+00027170: 653d 6e61 6d65 290a 2020 2020 6173 7365  e=name).    asse
+00027180: 7274 206a 6f62 5f69 645f 6578 6563 203d  rt job_id_exec =
+00027190: 3d20 320a 2020 2020 6173 7365 7274 2068  = 2.    assert h
+000271a0: 616e 646c 655f 6578 6563 2069 7320 6e6f  andle_exec is no
+000271b0: 7420 4e6f 6e65 0a20 2020 2061 7373 6572  t None.    asser
+000271c0: 7420 6861 6e64 6c65 5f65 7865 632e 636c  t handle_exec.cl
+000271d0: 7573 7465 725f 6e61 6d65 203d 3d20 6e61  uster_name == na
+000271e0: 6d65 0a20 2020 2061 7373 6572 7420 6861  me.    assert ha
+000271f0: 6e64 6c65 5f65 7865 632e 6c61 756e 6368  ndle_exec.launch
+00027200: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
+00027210: 7564 2e69 735f 7361 6d65 5f63 6c6f 7564  ud.is_same_cloud
+00027220: 2873 6b79 2e47 4350 2829 290a 2020 2020  (sky.GCP()).    
+00027230: 2320 466f 7220 6475 6d6d 7920 7461 736b  # For dummy task
+00027240: 2028 692e 652e 2074 6173 6b2e 7275 6e20   (i.e. task.run 
+00027250: 6973 204e 6f6e 6529 2c20 7468 6520 6a6f  is None), the jo
+00027260: 6220 776f 6e27 7420 6265 2073 7562 6d69  b won't be submi
+00027270: 7474 6564 2e0a 2020 2020 6475 6d6d 795f  tted..    dummy_
+00027280: 7461 736b 203d 2073 6b79 2e54 6173 6b28  task = sky.Task(
+00027290: 290a 2020 2020 6a6f 625f 6964 5f64 756d  ).    job_id_dum
+000272a0: 6d79 2c20 5f20 3d20 736b 792e 6578 6563  my, _ = sky.exec
+000272b0: 2864 756d 6d79 5f74 6173 6b2c 2063 6c75  (dummy_task, clu
+000272c0: 7374 6572 5f6e 616d 653d 6e61 6d65 290a  ster_name=name).
+000272d0: 2020 2020 6173 7365 7274 206a 6f62 5f69      assert job_i
+000272e0: 645f 6475 6d6d 7920 6973 204e 6f6e 650a  d_dummy is None.
+000272f0: 2020 2020 736b 792e 646f 776e 286e 616d      sky.down(nam
+00027300: 6529 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  e)...# ---------
+00027310: 2d20 5465 7374 696e 6720 5374 6f72 6167  - Testing Storag
+00027320: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a63 6c61  e ----------.cla
+00027330: 7373 2054 6573 7453 746f 7261 6765 5769  ss TestStorageWi
+00027340: 7468 4372 6564 656e 7469 616c 733a 0a20  thCredentials:. 
+00027350: 2020 2022 2222 5374 6f72 6167 6520 7465     """Storage te
+00027360: 7374 7320 7768 6963 6820 7265 7175 6972  sts which requir
+00027370: 6520 6372 6564 656e 7469 616c 7320 616e  e credentials an
+00027380: 6420 6e65 7477 6f72 6b20 636f 6e6e 6563  d network connec
+00027390: 7469 6f6e 2222 220a 0a20 2020 2041 5753  tion"""..    AWS
+000273a0: 5f49 4e56 414c 4944 5f4e 414d 4553 203d  _INVALID_NAMES =
+000273b0: 205b 0a20 2020 2020 2020 2027 6162 272c   [.        'ab',
+000273c0: 2020 2320 6c65 7373 2074 6861 6e20 3320    # less than 3 
+000273d0: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
+000273e0: 2020 2027 6162 6364 6566 6768 696a 6b6c     'abcdefghijkl
+000273f0: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
+00027400: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00027410: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+00027420: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+00027430: 797a 3127 2c0a 2020 2020 2020 2020 2320  yz1',.        # 
+00027440: 6d6f 7265 2074 6861 6e20 3633 2063 6861  more than 63 cha
+00027450: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
+00027460: 2741 6263 6465 6627 2c20 2023 2063 6f6e  'Abcdef',  # con
+00027470: 7461 696e 7320 616e 2075 7070 6572 6361  tains an upperca
+00027480: 7365 206c 6574 7465 720a 2020 2020 2020  se letter.      
+00027490: 2020 2761 6263 2064 6566 272c 2020 2320    'abc def',  # 
+000274a0: 636f 6e74 6169 6e73 2061 2073 7061 6365  contains a space
+000274b0: 0a20 2020 2020 2020 2027 6162 632e 2e64  .        'abc..d
+000274c0: 6566 272c 2020 2320 7477 6f20 6164 6a61  ef',  # two adja
+000274d0: 6365 6e74 2070 6572 696f 6473 0a20 2020  cent periods.   
+000274e0: 2020 2020 2027 3139 322e 3136 382e 352e       '192.168.5.
+000274f0: 3427 2c20 2023 2066 6f72 6d61 7474 6564  4',  # formatted
+00027500: 2061 7320 616e 2049 5020 6164 6472 6573   as an IP addres
+00027510: 730a 2020 2020 2020 2020 2778 6e2d 2d62  s.        'xn--b
+00027520: 7563 6b65 7427 2c20 2023 2073 7461 7274  ucket',  # start
+00027530: 7320 7769 7468 2027 786e 2d2d 2720 7072  s with 'xn--' pr
+00027540: 6566 6978 0a20 2020 2020 2020 2027 6275  efix.        'bu
+00027550: 636b 6574 2d73 3361 6c69 6173 272c 2020  cket-s3alias',  
+00027560: 2320 656e 6473 2077 6974 6820 272d 7333  # ends with '-s3
+00027570: 616c 6961 7327 2073 7566 6669 780a 2020  alias' suffix.  
+00027580: 2020 2020 2020 2762 7563 6b65 742d 2d6f        'bucket--o
+00027590: 6c2d 7333 272c 2020 2320 656e 6473 2077  l-s3',  # ends w
+000275a0: 6974 6820 272d 2d6f 6c2d 7333 2720 7375  ith '--ol-s3' su
+000275b0: 6666 6978 0a20 2020 2020 2020 2027 2e61  ffix.        '.a
+000275c0: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
+000275d0: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
+000275e0: 2020 2761 6263 2e27 2c20 2023 2065 6e64    'abc.',  # end
+000275f0: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00027600: 2020 2020 2027 2d61 6263 272c 2020 2320       '-abc',  # 
+00027610: 7374 6172 7473 2077 6974 6820 6120 6879  starts with a hy
+00027620: 7068 656e 0a20 2020 2020 2020 2027 6162  phen.        'ab
+00027630: 632d 272c 2020 2320 656e 6473 2077 6974  c-',  # ends wit
+00027640: 6820 6120 6879 7068 656e 0a20 2020 205d  h a hyphen.    ]
+00027650: 0a0a 2020 2020 4743 535f 494e 5641 4c49  ..    GCS_INVALI
+00027660: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
+00027670: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
+00027680: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
+00027690: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
+000276a0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+000276b0: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+000276c0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+000276d0: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+000276e0: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
+000276f0: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
+00027700: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
+00027710: 2028 7769 7468 6f75 7420 646f 7473 290a   (without dots).
+00027720: 2020 2020 2020 2020 2741 6263 6465 6627          'Abcdef'
+00027730: 2c20 2023 2063 6f6e 7461 696e 7320 616e  ,  # contains an
+00027740: 2075 7070 6572 6361 7365 206c 6574 7465   uppercase lette
+00027750: 720a 2020 2020 2020 2020 2761 6263 2064  r.        'abc d
+00027760: 6566 272c 2020 2320 636f 6e74 6169 6e73  ef',  # contains
+00027770: 2061 2073 7061 6365 0a20 2020 2020 2020   a space.       
+00027780: 2027 6162 632e 2e64 6566 272c 2020 2320   'abc..def',  # 
+00027790: 7477 6f20 6164 6a61 6365 6e74 2070 6572  two adjacent per
+000277a0: 696f 6473 0a20 2020 2020 2020 2027 6162  iods.        'ab
+000277b0: 635f 2e64 6566 2e67 6869 2e6a 6b6c 6d6e  c_.def.ghi.jklmn
+000277c0: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
+000277d0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+000277e0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
+000277f0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00027800: 3127 0a20 2020 2020 2020 2023 204d 6f72  1'.        # Mor
+00027810: 6520 7468 616e 2036 3320 6368 6172 6163  e than 63 charac
+00027820: 7465 7273 2062 6574 7765 656e 2064 6f74  ters between dot
+00027830: 730a 2020 2020 2020 2020 2761 6263 5f2e  s.        'abc_.
+00027840: 6465 662e 6768 692e 6a6b 6c6d 6e6f 7071  def.ghi.jklmnopq
+00027850: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
+00027860: 6869 6a6b 6c6d 6e6f 7071 6667 6869 6a6b  hijklmnopqfghijk
+00027870: 6c6d 6e6f 7071 7273 7475 7677 2720 2a20  lmnopqrstuvw' * 
+00027880: 352c 0a20 2020 2020 2020 2023 206d 6f72  5,.        # mor
+00027890: 6520 7468 616e 2032 3232 2063 6861 7261  e than 222 chara
+000278a0: 6374 6572 7320 2877 6974 6820 646f 7473  cters (with dots
+000278b0: 290a 2020 2020 2020 2020 2731 3932 2e31  ).        '192.1
+000278c0: 3638 2e35 2e34 272c 2020 2320 666f 726d  68.5.4',  # form
+000278d0: 6174 7465 6420 6173 2061 6e20 4950 2061  atted as an IP a
+000278e0: 6464 7265 7373 0a20 2020 2020 2020 2027  ddress.        '
+000278f0: 676f 6f67 6275 636b 6574 272c 2020 2320  googbucket',  # 
+00027900: 7374 6172 7473 2077 6974 6820 2767 6f6f  starts with 'goo
+00027910: 6727 2070 7265 6669 780a 2020 2020 2020  g' prefix.      
+00027920: 2020 2767 6f6f 676c 6562 7563 6b65 7427    'googlebucket'
+00027930: 2c20 2023 2063 6f6e 7461 696e 7320 2767  ,  # contains 'g
+00027940: 6f6f 676c 6527 0a20 2020 2020 2020 2027  oogle'.        '
+00027950: 6730 3067 6c65 6275 636b 6574 272c 2020  g00glebucket',  
+00027960: 2320 7661 7269 616e 7420 6f66 2027 676f  # variant of 'go
+00027970: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
+00027980: 6f30 676c 6562 7563 6b65 7427 2c20 2023  o0glebucket',  #
+00027990: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
+000279a0: 676c 6527 0a20 2020 2020 2020 2027 6730  gle'.        'g0
+000279b0: 6f67 6c65 6275 636b 6574 272c 2020 2320  oglebucket',  # 
+000279c0: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
+000279d0: 6c65 270a 2020 2020 2020 2020 272e 6162  le'.        '.ab
+000279e0: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
+000279f0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
+00027a00: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
+00027a10: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
+00027a20: 2020 2020 275f 6162 6327 2c20 2023 2073      '_abc',  # s
+00027a30: 7461 7274 7320 7769 7468 2061 6e20 756e  tarts with an un
+00027a40: 6465 7273 636f 7265 0a20 2020 2020 2020  derscore.       
+00027a50: 2027 6162 635f 272c 2020 2320 656e 6473   'abc_',  # ends
+00027a60: 2077 6974 6820 616e 2075 6e64 6572 7363   with an undersc
+00027a70: 6f72 650a 2020 2020 5d0a 0a20 2020 2049  ore.    ]..    I
+00027a80: 424d 5f49 4e56 414c 4944 5f4e 414d 4553  BM_INVALID_NAMES
+00027a90: 203d 205b 0a20 2020 2020 2020 2027 6162   = [.        'ab
+00027aa0: 272c 2020 2320 6c65 7373 2074 6861 6e20  ',  # less than 
+00027ab0: 3320 6368 6172 6163 7465 7273 0a20 2020  3 characters.   
+00027ac0: 2020 2020 2027 6162 6364 6566 6768 696a       'abcdefghij
+00027ad0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00027ae0: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
+00027af0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
+00027b00: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
+00027b10: 7778 797a 3127 2c0a 2020 2020 2020 2020  wxyz1',.        
+00027b20: 2320 6d6f 7265 2074 6861 6e20 3633 2063  # more than 63 c
+00027b30: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
+00027b40: 2020 2741 6263 6465 6627 2c20 2023 2063    'Abcdef',  # c
+00027b50: 6f6e 7461 696e 7320 616e 2075 7070 6572  ontains an upper
+00027b60: 6361 7365 206c 6574 7465 720a 2020 2020  case letter.    
+00027b70: 2020 2020 2761 6263 2064 6566 272c 2020      'abc def',  
+00027b80: 2320 636f 6e74 6169 6e73 2061 2073 7061  # contains a spa
+00027b90: 6365 0a20 2020 2020 2020 2027 6162 632e  ce.        'abc.
+00027ba0: 2e64 6566 272c 2020 2320 7477 6f20 6164  .def',  # two ad
+00027bb0: 6a61 6365 6e74 2070 6572 696f 6473 0a20  jacent periods. 
+00027bc0: 2020 2020 2020 2027 3139 322e 3136 382e         '192.168.
+00027bd0: 352e 3427 2c20 2023 2066 6f72 6d61 7474  5.4',  # formatt
+00027be0: 6564 2061 7320 616e 2049 5020 6164 6472  ed as an IP addr
+00027bf0: 6573 730a 2020 2020 2020 2020 2778 6e2d  ess.        'xn-
+00027c00: 2d62 7563 6b65 7427 2c20 2023 2073 7461  -bucket',  # sta
+00027c10: 7274 7320 7769 7468 2027 786e 2d2d 2720  rts with 'xn--' 
+00027c20: 7072 6566 6978 0a20 2020 2020 2020 2027  prefix.        '
+00027c30: 2e61 6263 272c 2020 2320 7374 6172 7473  .abc',  # starts
+00027c40: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
+00027c50: 2020 2020 2761 6263 2e27 2c20 2023 2065      'abc.',  # e
+00027c60: 6e64 7320 7769 7468 2061 2064 6f74 0a20  nds with a dot. 
+00027c70: 2020 2020 2020 2027 2d61 6263 272c 2020         '-abc',  
+00027c80: 2320 7374 6172 7473 2077 6974 6820 6120  # starts with a 
+00027c90: 6879 7068 656e 0a20 2020 2020 2020 2027  hyphen.        '
+00027ca0: 6162 632d 272c 2020 2320 656e 6473 2077  abc-',  # ends w
+00027cb0: 6974 6820 6120 6879 7068 656e 0a20 2020  ith a hyphen.   
+00027cc0: 2020 2020 2027 612e 2d62 6327 2c20 2023       'a.-bc',  #
+00027cd0: 2063 6f6e 7461 696e 7320 7468 6520 7365   contains the se
+00027ce0: 7175 656e 6365 2027 2e2d 270a 2020 2020  quence '.-'.    
+00027cf0: 2020 2020 2761 2d2e 6263 272c 2020 2320      'a-.bc',  # 
+00027d00: 636f 6e74 6169 6e73 2074 6865 2073 6571  contains the seq
+00027d10: 7565 6e63 6520 272d 2e27 0a20 2020 2020  uence '-.'.     
+00027d20: 2020 2027 6126 6263 2720 2023 2063 6f6e     'a&bc'  # con
+00027d30: 7461 696e 7320 7370 6563 6961 6c20 6368  tains special ch
+00027d40: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+00027d50: 2027 6162 5e63 2720 2023 2063 6f6e 7461   'ab^c'  # conta
+00027d60: 696e 7320 7370 6563 6961 6c20 6368 6172  ins special char
+00027d70: 6163 7465 7273 0a20 2020 205d 0a20 2020  acters.    ].   
+00027d80: 2047 4954 4947 4e4f 5245 5f53 594e 435f   GITIGNORE_SYNC_
+00027d90: 5445 5354 5f44 4952 5f53 5452 5543 5455  TEST_DIR_STRUCTU
+00027da0: 5245 203d 207b 0a20 2020 2020 2020 2027  RE = {.        '
+00027db0: 646f 7562 6c65 5f61 7374 6572 6973 6b27  double_asterisk'
+00027dc0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00027dd0: 2764 6f75 626c 655f 6173 7465 7269 736b  'double_asterisk
+00027de0: 5f65 7863 6c75 6465 6427 3a20 4e6f 6e65  _excluded': None
+00027df0: 2c0a 2020 2020 2020 2020 2020 2020 2764  ,.            'd
+00027e00: 6f75 626c 655f 6173 7465 7269 736b 5f65  ouble_asterisk_e
+00027e10: 7863 6c75 6465 645f 6469 7227 3a20 7b0a  xcluded_dir': {.
+00027e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e30: 2764 6972 5f65 7863 6c75 6465 6427 3a20  'dir_excluded': 
+00027e40: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00027e50: 2020 7d2c 0a20 2020 2020 2020 207d 2c0a    },.        },.
+00027e60: 2020 2020 2020 2020 2764 6f75 626c 655f          'double_
+00027e70: 6173 7465 7269 736b 5f70 6172 656e 7427  asterisk_parent'
+00027e80: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00027e90: 2770 6172 656e 7427 3a20 7b0a 2020 2020  'parent': {.    
+00027ea0: 2020 2020 2020 2020 2020 2020 2761 6c73              'als
+00027eb0: 6f5f 6578 636c 7564 6564 2e74 7874 273a  o_excluded.txt':
+00027ec0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00027ed0: 2020 2020 2020 2027 6368 696c 6427 3a20         'child': 
+00027ee0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00027ef0: 2020 2020 2020 2764 6f75 626c 655f 6173        'double_as
+00027f00: 7465 7269 736b 5f70 6172 656e 745f 6368  terisk_parent_ch
+00027f10: 696c 645f 6578 636c 7564 6564 2e74 7874  ild_excluded.txt
+00027f20: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+00027f30: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00027f40: 2020 2020 2020 2020 2020 2020 2764 6f75              'dou
+00027f50: 626c 655f 6173 7465 7269 736b 5f70 6172  ble_asterisk_par
+00027f60: 656e 745f 6578 636c 7564 6564 2e74 7874  ent_excluded.txt
+00027f70: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+00027f80: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00027f90: 7d2c 0a20 2020 2020 2020 2027 6578 636c  },.        'excl
+00027fa0: 7564 6564 2e6c 6f67 273a 204e 6f6e 652c  uded.log': None,
+00027fb0: 0a20 2020 2020 2020 2027 6578 636c 7564  .        'exclud
+00027fc0: 6564 5f64 6972 273a 207b 0a20 2020 2020  ed_dir': {.     
+00027fd0: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+00027fe0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
+00027ff0: 2020 2020 2020 2020 2027 6e65 7374 6564           'nested
+00028000: 5f65 7863 6c75 6465 6427 3a20 7b0a 2020  _excluded': {.  
+00028010: 2020 2020 2020 2020 2020 2020 2020 2765                'e
+00028020: 7863 6c75 6465 6427 3a20 4e6f 6e65 2c0a  xcluded': None,.
+00028030: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00028040: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00028050: 2020 2765 7870 2d31 273a 207b 0a20 2020    'exp-1': {.   
+00028060: 2020 2020 2020 2020 2027 6265 5f65 7863           'be_exc
+00028070: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+00028080: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00028090: 2027 6578 702d 3227 3a20 7b0a 2020 2020   'exp-2': {.    
+000280a0: 2020 2020 2020 2020 2762 655f 6578 636c          'be_excl
+000280b0: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
+000280c0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000280d0: 2766 726f 6e74 5f73 6c61 7368 5f65 7863  'front_slash_exc
+000280e0: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+000280f0: 2020 2020 2020 2769 6e63 6c75 6465 642e        'included.
+00028100: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
+00028110: 2020 2020 2769 6e63 6c75 6465 642e 7478      'included.tx
+00028120: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+00028130: 2020 2769 6e63 6c75 6465 5f64 6972 273a    'include_dir':
+00028140: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00028150: 6578 636c 7564 6564 2e6c 6f67 273a 204e  excluded.log': N
+00028160: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00028170: 2027 696e 636c 7564 6564 2e6c 6f67 273a   'included.log':
+00028180: 204e 6f6e 652c 0a20 2020 2020 2020 207d   None,.        }
+00028190: 2c0a 2020 2020 2020 2020 276e 6573 7465  ,.        'neste
+000281a0: 645f 646f 7562 6c65 5f61 7374 6572 6973  d_double_asteris
+000281b0: 6b27 3a20 7b0a 2020 2020 2020 2020 2020  k': {.          
+000281c0: 2020 276f 6e65 273a 207b 0a20 2020 2020    'one': {.     
+000281d0: 2020 2020 2020 2020 2020 2027 616c 736f             'also
+000281e0: 5f65 7863 6c75 6465 2e74 7874 273a 204e  _exclude.txt': N
+000281f0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00028200: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+00028210: 2774 776f 273a 207b 0a20 2020 2020 2020  'two': {.       
+00028220: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
+00028230: 7863 6c75 6465 2e74 7874 273a 204e 6f6e  xclude.txt': Non
+00028240: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+00028250: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+00028260: 2020 2020 2027 6e65 7374 6564 5f77 696c       'nested_wil
+00028270: 6463 6172 645f 6469 7227 3a20 7b0a 2020  dcard_dir': {.  
+00028280: 2020 2020 2020 2020 2020 276d 6f6e 6461            'monda
+00028290: 7927 3a20 7b0a 2020 2020 2020 2020 2020  y': {.          
+000282a0: 2020 2020 2020 2761 6c73 6f5f 6578 636c        'also_excl
+000282b0: 7564 652e 7478 7427 3a20 4e6f 6e65 2c0a  ude.txt': None,.
+000282c0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+000282d0: 2020 2020 2020 2020 2020 2027 7475 6573             'tues
+000282e0: 6461 7927 3a20 7b0a 2020 2020 2020 2020  day': {.        
+000282f0: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
+00028300: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
+00028310: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
+00028320: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00028330: 2020 2020 276e 6f5f 736c 6173 685f 6578      'no_slash_ex
+00028340: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+00028350: 2020 2020 2020 2027 6e6f 5f73 6c61 7368         'no_slash
+00028360: 5f74 6573 7473 273a 207b 0a20 2020 2020  _tests': {.     
+00028370: 2020 2020 2020 2027 6e6f 5f73 6c61 7368         'no_slash
+00028380: 5f65 7863 6c75 6465 6427 3a20 7b0a 2020  _excluded': {.  
+00028390: 2020 2020 2020 2020 2020 2020 2020 2761                'a
+000283a0: 6c73 6f5f 6578 636c 7564 6564 2e74 7874  lso_excluded.txt
+000283b0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+000283c0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000283d0: 7d2c 0a20 2020 2020 2020 2027 7175 6573  },.        'ques
+000283e0: 7469 6f6e 5f6d 6172 6b27 3a20 7b0a 2020  tion_mark': {.  
+000283f0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
+00028400: 6465 6431 2e74 7874 273a 204e 6f6e 652c  ded1.txt': None,
+00028410: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
+00028420: 636c 7564 6564 402e 7478 7427 3a20 4e6f  cluded@.txt': No
+00028430: 6e65 2c0a 2020 2020 2020 2020 7d2c 0a20  ne,.        },. 
+00028440: 2020 2020 2020 2027 7371 7561 7265 5f62         'square_b
+00028450: 7261 636b 6574 273a 207b 0a20 2020 2020  racket': {.     
+00028460: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+00028470: 312e 7478 7427 3a20 4e6f 6e65 2c0a 2020  1.txt': None,.  
+00028480: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00028490: 2027 7371 7561 7265 5f62 7261 636b 6574   'square_bracket
+000284a0: 5f61 6c70 6861 273a 207b 0a20 2020 2020  _alpha': {.     
+000284b0: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+000284c0: 7a2e 7478 7427 3a20 4e6f 6e65 2c0a 2020  z.txt': None,.  
+000284d0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000284e0: 2027 7371 7561 7265 5f62 7261 636b 6574   'square_bracket
+000284f0: 5f65 7863 6c61 273a 207b 0a20 2020 2020  _excla': {.     
+00028500: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
+00028510: 322e 7478 7427 3a20 4e6f 6e65 2c0a 2020  2.txt': None,.  
+00028520: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
+00028530: 6465 6440 2e74 7874 273a 204e 6f6e 652c  ded@.txt': None,
+00028540: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
+00028550: 2020 2020 2773 7175 6172 655f 6272 6163      'square_brac
+00028560: 6b65 745f 7369 6e67 6c65 273a 207b 0a20  ket_single': {. 
+00028570: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+00028580: 7564 6564 302e 7478 7427 3a20 4e6f 6e65  uded0.txt': None
+00028590: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+000285a0: 207d 0a0a 2020 2020 4073 7461 7469 636d   }..    @staticm
+000285b0: 6574 686f 640a 2020 2020 6465 6620 6372  ethod.    def cr
+000285c0: 6561 7465 5f64 6972 5f73 7472 7563 7475  eate_dir_structu
+000285d0: 7265 2862 6173 655f 7061 7468 2c20 7374  re(base_path, st
+000285e0: 7275 6374 7572 6529 3a0a 2020 2020 2020  ructure):.      
+000285f0: 2020 2320 6372 6561 7465 7320 6120 6769    # creates a gi
+00028600: 7665 6e20 6669 6c65 2053 5452 5543 5455  ven file STRUCTU
+00028610: 5245 2069 6e20 4241 5345 5f50 4154 480a  RE in BASE_PATH.
+00028620: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
+00028630: 2c20 7375 6273 7472 7563 7475 7265 2069  , substructure i
+00028640: 6e20 7374 7275 6374 7572 652e 6974 656d  n structure.item
+00028650: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00028660: 2070 6174 6820 3d20 6f73 2e70 6174 682e   path = os.path.
+00028670: 6a6f 696e 2862 6173 655f 7061 7468 2c20  join(base_path, 
+00028680: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00028690: 2020 6966 2073 7562 7374 7275 6374 7572    if substructur
+000286a0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+000286b0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
+000286c0: 6174 6520 6120 6669 6c65 0a20 2020 2020  ate a file.     
+000286d0: 2020 2020 2020 2020 2020 206f 7065 6e28             open(
+000286e0: 7061 7468 2c20 2761 272c 2065 6e63 6f64  path, 'a', encod
+000286f0: 696e 673d 2775 7466 2d38 2729 2e63 6c6f  ing='utf-8').clo
+00028700: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+00028710: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00028720: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
+00028730: 6120 7375 6264 6972 6563 746f 7279 0a20  a subdirectory. 
+00028740: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00028750: 732e 6d6b 6469 7228 7061 7468 290a 2020  s.mkdir(path).  
+00028760: 2020 2020 2020 2020 2020 2020 2020 5465                Te
+00028770: 7374 5374 6f72 6167 6557 6974 6843 7265  stStorageWithCre
+00028780: 6465 6e74 6961 6c73 2e63 7265 6174 655f  dentials.create_
+00028790: 6469 725f 7374 7275 6374 7572 6528 0a20  dir_structure(. 
+000287a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000287b0: 2020 2070 6174 682c 2073 7562 7374 7275     path, substru
+000287c0: 6374 7572 6529 0a0a 2020 2020 4073 7461  cture)..    @sta
+000287d0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+000287e0: 6620 636c 695f 6465 6c65 7465 5f63 6d64  f cli_delete_cmd
+000287f0: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
+00028800: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+00028810: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+00028820: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+00028830: 5374 6f72 6554 7970 652e 5333 3a0a 2020  StoreType.S3:.  
+00028840: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00028850: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
+00028860: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
+00028870: 2020 7265 7475 726e 2066 2761 7773 2073    return f'aws s
+00028880: 3320 7262 207b 7572 6c7d 202d 2d66 6f72  3 rb {url} --for
+00028890: 6365 270a 2020 2020 2020 2020 6966 2073  ce'.        if s
+000288a0: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+000288b0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+000288c0: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+000288d0: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
+000288e0: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
+000288f0: 2020 2020 2020 2020 2020 2020 6773 7574              gsut
+00028900: 696c 5f61 6c69 6173 2c20 616c 6961 735f  il_alias, alias_
+00028910: 6765 6e20 3d20 6461 7461 5f75 7469 6c73  gen = data_utils
+00028920: 2e67 6574 5f67 7375 7469 6c5f 636f 6d6d  .get_gsutil_comm
+00028930: 616e 6428 290a 2020 2020 2020 2020 2020  and().          
+00028940: 2020 7265 7475 726e 2066 277b 616c 6961    return f'{alia
+00028950: 735f 6765 6e7d 3b20 7b67 7375 7469 6c5f  s_gen}; {gsutil_
+00028960: 616c 6961 737d 2072 6d20 2d72 207b 7572  alias} rm -r {ur
+00028970: 6c7d 270a 2020 2020 2020 2020 6966 2073  l}'.        if s
+00028980: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+00028990: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+000289a0: 7065 2e52 323a 0a20 2020 2020 2020 2020  pe.R2:.         
+000289b0: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
+000289c0: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
+000289d0: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
+000289e0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+000289f0: 2066 2773 333a 2f2f 7b62 7563 6b65 745f   f's3://{bucket_
+00028a00: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
+00028a10: 2020 2072 6574 7572 6e20 6627 4157 535f     return f'AWS_
+00028a20: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+00028a30: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+00028a40: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+00028a50: 4c53 5f50 4154 487d 2061 7773 2073 3320  LS_PATH} aws s3 
+00028a60: 7262 207b 7572 6c7d 202d 2d66 6f72 6365  rb {url} --force
+00028a70: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+00028a80: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+00028a90: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
+00028aa0: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+00028ab0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00028ac0: 6f72 6554 7970 652e 4942 4d3a 0a20 2020  oreType.IBM:.   
+00028ad0: 2020 2020 2020 2020 2062 7563 6b65 745f           bucket_
+00028ae0: 7263 6c6f 6e65 5f70 726f 6669 6c65 203d  rclone_profile =
+00028af0: 2052 636c 6f6e 652e 6765 6e65 7261 7465   Rclone.generate
+00028b00: 5f72 636c 6f6e 655f 6275 636b 6574 5f70  _rclone_bucket_p
+00028b10: 726f 6669 6c65 5f6e 616d 6528 0a20 2020  rofile_name(.   
+00028b20: 2020 2020 2020 2020 2020 2020 2062 7563               buc
+00028b30: 6b65 745f 6e61 6d65 2c20 5263 6c6f 6e65  ket_name, Rclone
+00028b40: 2e52 636c 6f6e 6543 6c6f 7564 732e 4942  .RcloneClouds.IB
+00028b50: 4d29 0a20 2020 2020 2020 2020 2020 2072  M).            r
+00028b60: 6574 7572 6e20 6627 7263 6c6f 6e65 2070  eturn f'rclone p
+00028b70: 7572 6765 207b 6275 636b 6574 5f72 636c  urge {bucket_rcl
+00028b80: 6f6e 655f 7072 6f66 696c 657d 3a7b 6275  one_profile}:{bu
+00028b90: 636b 6574 5f6e 616d 657d 2026 2620 7263  cket_name} && rc
+00028ba0: 6c6f 6e65 2063 6f6e 6669 6720 6465 6c65  lone config dele
+00028bb0: 7465 207b 6275 636b 6574 5f72 636c 6f6e  te {bucket_rclon
+00028bc0: 655f 7072 6f66 696c 657d 270a 0a20 2020  e_profile}'..   
+00028bd0: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00028be0: 2020 2064 6566 2063 6c69 5f6c 735f 636d     def cli_ls_cm
+00028bf0: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
+00028c00: 636b 6574 5f6e 616d 652c 2073 7566 6669  cket_name, suffi
+00028c10: 783d 2727 293a 0a20 2020 2020 2020 2069  x=''):.        i
+00028c20: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
+00028c30: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00028c40: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
+00028c50: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
+00028c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028c70: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
+00028c80: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+00028c90: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
+00028ca0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00028cb0: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
+00028cc0: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
+00028cd0: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
+00028ce0: 7265 7475 726e 2066 2761 7773 2073 3320  return f'aws s3 
+00028cf0: 6c73 207b 7572 6c7d 270a 2020 2020 2020  ls {url}'.      
+00028d00: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+00028d10: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+00028d20: 746f 7265 5479 7065 2e47 4353 3a0a 2020  toreType.GCS:.  
+00028d30: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
+00028d40: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+00028d50: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
+00028d60: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d2f  //{bucket_name}/
+00028d70: 7b73 7566 6669 787d 270a 2020 2020 2020  {suffix}'.      
+00028d80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00028d90: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+00028da0: 3d20 6627 6773 3a2f 2f7b 6275 636b 6574  = f'gs://{bucket
+00028db0: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+00028dc0: 2020 2020 7265 7475 726e 2066 2767 7375      return f'gsu
+00028dd0: 7469 6c20 6c73 207b 7572 6c7d 270a 2020  til ls {url}'.  
+00028de0: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+00028df0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+00028e00: 6962 2e53 746f 7265 5479 7065 2e52 323a  ib.StoreType.R2:
+00028e10: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+00028e20: 706f 696e 745f 7572 6c20 3d20 636c 6f75  point_url = clou
+00028e30: 6466 6c61 7265 2e63 7265 6174 655f 656e  dflare.create_en
+00028e40: 6470 6f69 6e74 2829 0a20 2020 2020 2020  dpoint().       
+00028e50: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
+00028e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e70: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
+00028e80: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
+00028e90: 6978 7d27 0a20 2020 2020 2020 2020 2020  ix}'.           
+00028ea0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00028eb0: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
+00028ec0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
+00028ed0: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
+00028ee0: 6574 7572 6e20 6627 4157 535f 5348 4152  eturn f'AWS_SHAR
+00028ef0: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
+00028f00: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
+00028f10: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
+00028f20: 4154 487d 2061 7773 2073 3320 6c73 207b  ATH} aws s3 ls {
+00028f30: 7572 6c7d 202d 2d65 6e64 706f 696e 7420  url} --endpoint 
+00028f40: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
+00028f50: 2d70 726f 6669 6c65 3d72 3227 0a20 2020  -profile=r2'.   
+00028f60: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+00028f70: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+00028f80: 622e 5374 6f72 6554 7970 652e 4942 4d3a  b.StoreType.IBM:
+00028f90: 0a20 2020 2020 2020 2020 2020 2062 7563  .            buc
+00028fa0: 6b65 745f 7263 6c6f 6e65 5f70 726f 6669  ket_rclone_profi
+00028fb0: 6c65 203d 2052 636c 6f6e 652e 6765 6e65  le = Rclone.gene
+00028fc0: 7261 7465 5f72 636c 6f6e 655f 6275 636b  rate_rclone_buck
+00028fd0: 6574 5f70 726f 6669 6c65 5f6e 616d 6528  et_profile_name(
+00028fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028ff0: 2062 7563 6b65 745f 6e61 6d65 2c20 5263   bucket_name, Rc
+00029000: 6c6f 6e65 2e52 636c 6f6e 6543 6c6f 7564  lone.RcloneCloud
+00029010: 732e 4942 4d29 0a20 2020 2020 2020 2020  s.IBM).         
+00029020: 2020 2072 6574 7572 6e20 6627 7263 6c6f     return f'rclo
+00029030: 6e65 206c 7320 7b62 7563 6b65 745f 7263  ne ls {bucket_rc
+00029040: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b62  lone_profile}:{b
+00029050: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+00029060: 6669 787d 270a 0a20 2020 2040 7374 6174  fix}'..    @stat
+00029070: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+00029080: 2063 6c69 5f72 6567 696f 6e5f 636d 6428   cli_region_cmd(
+00029090: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+000290a0: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
+000290b0: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+000290c0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+000290d0: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
+000290e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000290f0: 2827 6177 7320 7333 6170 6920 6765 742d  ('aws s3api get-
+00029100: 6275 636b 6574 2d6c 6f63 6174 696f 6e20  bucket-location 
+00029110: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00029120: 2020 2020 2020 6627 2d2d 6275 636b 6574        f'--bucket
+00029130: 207b 6275 636b 6574 5f6e 616d 657d 202d   {bucket_name} -
+00029140: 2d6f 7574 7075 7420 7465 7874 2729 0a20  -output text'). 
+00029150: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
+00029160: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
+00029170: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00029180: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
+00029190: 2072 6574 7572 6e20 2866 2767 7375 7469   return (f'gsuti
+000291a0: 6c20 6c73 202d 4c20 2d62 2067 733a 2f2f  l ls -L -b gs://
+000291b0: 7b62 7563 6b65 745f 6e61 6d65 7d2f 207c  {bucket_name}/ |
+000291c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000291d0: 2020 2020 2020 2027 6772 6570 2022 4c6f         'grep "Lo
+000291e0: 6361 7469 6f6e 2063 6f6e 7374 7261 696e  cation constrain
+000291f0: 7422 207c 2027 0a20 2020 2020 2020 2020  t" | '.         
+00029200: 2020 2020 2020 2020 2020 2027 6177 6b20             'awk 
+00029210: 5c27 7b70 7269 6e74 2074 6f6c 6f77 6572  \'{print tolower
+00029220: 2824 4e46 297d 5c27 2729 0a20 2020 2020  ($NF)}\'').     
+00029230: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00029240: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+00029250: 706c 656d 656e 7465 6445 7272 6f72 2866  plementedError(f
+00029260: 2752 6567 696f 6e20 636f 6d6d 616e 6420  'Region command 
+00029270: 6e6f 7420 696d 706c 656d 656e 7465 6420  not implemented 
+00029280: 666f 7220 270a 2020 2020 2020 2020 2020  for '.          
+00029290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292a0: 2020 2020 2020 2020 2020 2020 6627 7b73              f'{s
+000292b0: 746f 7265 5f74 7970 657d 2729 0a0a 2020  tore_type}')..  
+000292c0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+000292d0: 2020 2020 6465 6620 636c 695f 636f 756e      def cli_coun
+000292e0: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
+000292f0: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
+00029300: 6b65 745f 6e61 6d65 2c20 6669 6c65 5f6e  ket_name, file_n
+00029310: 616d 652c 2073 7566 6669 783d 2727 293a  ame, suffix=''):
+00029320: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
+00029330: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
+00029340: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00029350: 5333 3a0a 2020 2020 2020 2020 2020 2020  S3:.            
+00029360: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
+00029370: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00029380: 6e20 6627 6177 7320 7333 6170 6920 6c69  n f'aws s3api li
+00029390: 7374 2d6f 626a 6563 7473 202d 2d62 7563  st-objects --buc
+000293a0: 6b65 7420 227b 6275 636b 6574 5f6e 616d  ket "{bucket_nam
+000293b0: 657d 2220 2d2d 7072 6566 6978 207b 7375  e}" --prefix {su
+000293c0: 6666 6978 7d20 2d2d 7175 6572 7920 226c  ffix} --query "l
+000293d0: 656e 6774 6828 436f 6e74 656e 7473 5b3f  ength(Contents[?
+000293e0: 636f 6e74 6169 6e73 284b 6579 2c5c 277b  contains(Key,\'{
+000293f0: 6669 6c65 5f6e 616d 657d 5c27 295d 2e4b  file_name}\')].K
+00029400: 6579 2922 270a 2020 2020 2020 2020 2020  ey)"'.          
+00029410: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029420: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+00029430: 2761 7773 2073 3361 7069 206c 6973 742d  'aws s3api list-
+00029440: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
+00029450: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
+00029460: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
+00029470: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
+00029480: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
+00029490: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2227  name}\')].Key)"'
+000294a0: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
+000294b0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+000294c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+000294d0: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
+000294e0: 2020 2069 6620 7375 6666 6978 3a0a 2020     if suffix:.  
+000294f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00029500: 7475 726e 2066 2767 7375 7469 6c20 6c73  turn f'gsutil ls
+00029510: 202d 7220 6773 3a2f 2f7b 6275 636b 6574   -r gs://{bucket
+00029520: 5f6e 616d 657d 2f7b 7375 6666 6978 7d20  _name}/{suffix} 
+00029530: 7c20 6772 6570 2022 7b66 696c 655f 6e61  | grep "{file_na
+00029540: 6d65 7d22 207c 2077 6320 2d6c 270a 2020  me}" | wc -l'.  
+00029550: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00029560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029570: 7265 7475 726e 2066 2767 7375 7469 6c20  return f'gsutil 
+00029580: 6c73 202d 7220 6773 3a2f 2f7b 6275 636b  ls -r gs://{buck
+00029590: 6574 5f6e 616d 657d 207c 2067 7265 7020  et_name} | grep 
+000295a0: 227b 6669 6c65 5f6e 616d 657d 2220 7c20  "{file_name}" | 
+000295b0: 7763 202d 6c27 0a20 2020 2020 2020 2065  wc -l'.        e
+000295c0: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
+000295d0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+000295e0: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
+000295f0: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
+00029600: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
+00029610: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
+00029620: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00029630: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
+00029640: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00029650: 6e20 6627 4157 535f 5348 4152 4544 5f43  n f'AWS_SHARED_C
+00029660: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
+00029670: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
+00029680: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
+00029690: 2061 7773 2073 3361 7069 206c 6973 742d   aws s3api list-
+000296a0: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
+000296b0: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
+000296c0: 202d 2d70 7265 6669 7820 7b73 7566 6669   --prefix {suffi
+000296d0: 787d 202d 2d71 7565 7279 2022 6c65 6e67  x} --query "leng
+000296e0: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
+000296f0: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
+00029700: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
+00029710: 2220 2d2d 656e 6470 6f69 6e74 207b 656e  " --endpoint {en
+00029720: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+00029730: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
+00029740: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00029750: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00029760: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
+00029770: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
+00029780: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
+00029790: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
+000297a0: 7d20 6177 7320 7333 6170 6920 6c69 7374  } aws s3api list
+000297b0: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+000297c0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+000297d0: 2220 2d2d 7175 6572 7920 226c 656e 6774  " --query "lengt
+000297e0: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
+000297f0: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
+00029800: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
+00029810: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+00029820: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+00029830: 6669 6c65 3d72 3227 0a0a 2020 2020 4073  file=r2'..    @s
+00029840: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00029850: 6465 6620 636c 695f 636f 756e 745f 6669  def cli_count_fi
+00029860: 6c65 5f69 6e5f 6275 636b 6574 2873 746f  le_in_bucket(sto
+00029870: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
+00029880: 6e61 6d65 293a 0a20 2020 2020 2020 2069  name):.        i
+00029890: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
+000298a0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+000298b0: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
+000298c0: 2020 2020 2020 7265 7475 726e 2066 2761        return f'a
+000298d0: 7773 2073 3320 6c73 2073 333a 2f2f 7b62  ws s3 ls s3://{b
+000298e0: 7563 6b65 745f 6e61 6d65 7d20 2d2d 7265  ucket_name} --re
+000298f0: 6375 7273 6976 6520 7c20 7763 202d 6c27  cursive | wc -l'
+00029900: 0a20 2020 2020 2020 2065 6c69 6620 7374  .        elif st
+00029910: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+00029920: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00029930: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
+00029940: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
+00029950: 696c 206c 7320 2d72 2067 733a 2f2f 7b62  il ls -r gs://{b
+00029960: 7563 6b65 745f 6e61 6d65 7d2f 2a2a 207c  ucket_name}/** |
+00029970: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
+00029980: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
+00029990: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+000299a0: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
+000299b0: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
+000299c0: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+000299d0: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+000299e0: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
+000299f0: 2072 6574 7572 6e20 6627 4157 535f 5348   return f'AWS_SH
+00029a00: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
+00029a10: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
+00029a20: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
+00029a30: 5f50 4154 487d 2061 7773 2073 3320 6c73  _PATH} aws s3 ls
+00029a40: 2073 333a 2f2f 7b62 7563 6b65 745f 6e61   s3://{bucket_na
+00029a50: 6d65 7d20 2d2d 7265 6375 7273 6976 6520  me} --recursive 
+00029a60: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
+00029a70: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
+00029a80: 696c 653d 7232 207c 2077 6320 2d6c 270a  ile=r2 | wc -l'.
+00029a90: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+00029aa0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+00029ab0: 5f73 6f75 7263 6528 7365 6c66 2c20 746d  _source(self, tm
+00029ac0: 705f 7061 7468 293a 0a20 2020 2020 2020  p_path):.       
+00029ad0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+00029ae0: 706f 7261 7279 2064 6972 6563 746f 7279  porary directory
+00029af0: 2077 6974 6820 6120 6669 6c65 2069 6e20   with a file in 
+00029b00: 6974 0a20 2020 2020 2020 2074 6d70 5f64  it.        tmp_d
+00029b10: 6972 203d 2074 6d70 5f70 6174 6820 2f20  ir = tmp_path / 
+00029b20: 2774 6d70 2d73 6f75 7263 6527 0a20 2020  'tmp-source'.   
+00029b30: 2020 2020 2074 6d70 5f64 6972 2e6d 6b64       tmp_dir.mkd
+00029b40: 6972 2829 0a20 2020 2020 2020 2074 6d70  ir().        tmp
+00029b50: 5f66 696c 6520 3d20 746d 705f 6469 7220  _file = tmp_dir 
+00029b60: 2f20 2774 6d70 2d66 696c 6527 0a20 2020  / 'tmp-file'.   
+00029b70: 2020 2020 2074 6d70 5f66 696c 652e 7772       tmp_file.wr
+00029b80: 6974 655f 7465 7874 2827 7465 7374 2729  ite_text('test')
+00029b90: 0a20 2020 2020 2020 2063 6972 636c 655f  .        circle_
+00029ba0: 6c69 6e6b 203d 2074 6d70 5f64 6972 202f  link = tmp_dir /
+00029bb0: 2027 6369 7263 6c65 2d6c 696e 6b27 0a20   'circle-link'. 
+00029bc0: 2020 2020 2020 2063 6972 636c 655f 6c69         circle_li
+00029bd0: 6e6b 2e73 796d 6c69 6e6b 5f74 6f28 746d  nk.symlink_to(tm
+00029be0: 705f 6469 722c 2074 6172 6765 745f 6973  p_dir, target_is
+00029bf0: 5f64 6972 6563 746f 7279 3d54 7275 6529  _directory=True)
+00029c00: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+00029c10: 7472 2874 6d70 5f64 6972 290a 0a20 2020  tr(tmp_dir)..   
+00029c20: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+00029c30: 2020 2064 6566 2067 656e 6572 6174 655f     def generate_
+00029c40: 6275 636b 6574 5f6e 616d 6528 293a 0a20  bucket_name():. 
+00029c50: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+00029c60: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
+00029c70: 6b65 7420 6e61 6d65 0a20 2020 2020 2020  ket name.       
+00029c80: 2023 2074 696d 652e 7469 6d65 2829 2072   # time.time() r
+00029c90: 6574 7572 6e73 2076 6172 7969 6e67 2070  eturns varying p
+00029ca0: 7265 6369 7369 6f6e 206f 6e20 6469 6666  recision on diff
+00029cb0: 6572 656e 7420 7379 7374 656d 732c 2073  erent systems, s
+00029cc0: 6f20 7765 0a20 2020 2020 2020 2023 2072  o we.        # r
+00029cd0: 6570 6c61 6365 2074 6865 2064 6563 696d  eplace the decim
+00029ce0: 616c 2070 6f69 6e74 2061 6e64 2075 7365  al point and use
+00029cf0: 2077 6861 7465 7665 7220 7072 6563 6973   whatever precis
+00029d00: 696f 6e20 7765 2063 616e 2067 6574 2e0a  ion we can get..
+00029d10: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
+00029d20: 7020 3d20 7374 7228 7469 6d65 2e74 696d  p = str(time.tim
+00029d30: 6528 2929 2e72 6570 6c61 6365 2827 2e27  e()).replace('.'
+00029d40: 2c20 2727 290a 2020 2020 2020 2020 7265  , '').        re
+00029d50: 7475 726e 2066 2773 6b79 2d74 6573 742d  turn f'sky-test-
+00029d60: 7b74 696d 6573 7461 6d70 7d27 0a0a 2020  {timestamp}'..  
+00029d70: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+00029d80: 650a 2020 2020 6465 6620 746d 705f 6275  e.    def tmp_bu
+00029d90: 636b 6574 5f6e 616d 6528 7365 6c66 293a  cket_name(self):
+00029da0: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+00029db0: 656c 662e 6765 6e65 7261 7465 5f62 7563  elf.generate_buc
+00029dc0: 6b65 745f 6e61 6d65 2829 0a0a 2020 2020  ket_name()..    
+00029dd0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+00029de0: 2020 6465 6620 7969 656c 645f 7374 6f72    def yield_stor
+00029df0: 6167 655f 6f62 6a65 6374 280a 2020 2020  age_object(.    
+00029e00: 2020 2020 2020 2020 6e61 6d65 3a20 4f70          name: Op
+00029e10: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00029e20: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00029e30: 736f 7572 6365 3a20 4f70 7469 6f6e 616c  source: Optional
+00029e40: 5b73 746f 7261 6765 5f6c 6962 2e50 6174  [storage_lib.Pat
+00029e50: 685d 203d 204e 6f6e 652c 0a20 2020 2020  h] = None,.     
+00029e60: 2020 2020 2020 2073 746f 7265 733a 204f         stores: O
+00029e70: 7074 696f 6e61 6c5b 4469 6374 5b73 746f  ptional[Dict[sto
+00029e80: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00029e90: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+00029ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029eb0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+00029ec0: 622e 4162 7374 7261 6374 5374 6f72 655d  b.AbstractStore]
+00029ed0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00029ee0: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
+00029ef0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00029f00: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+00029f10: 2020 2020 206d 6f64 653a 2073 746f 7261       mode: stora
+00029f20: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
+00029f30: 6465 203d 2073 746f 7261 6765 5f6c 6962  de = storage_lib
+00029f40: 2e53 746f 7261 6765 4d6f 6465 2e4d 4f55  .StorageMode.MOU
+00029f50: 4e54 293a 0a20 2020 2020 2020 2023 2043  NT):.        # C
+00029f60: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
+00029f70: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
+00029f80: 742e 2053 746f 7265 7320 6d75 7374 2062  t. Stores must b
+00029f90: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+00029fa0: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
+00029fb0: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+00029fc0: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
+00029fd0: 616d 653d 6e61 6d65 2c0a 2020 2020 2020  ame=name,.      
+00029fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a010: 2020 2020 2020 2020 2073 746f 7265 733d           stores=
-0002a020: 7374 6f72 6573 2c0a 2020 2020 2020 2020  stores,.        
-0002a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a050: 2020 7065 7273 6973 7465 6e74 3d70 6572    persistent=per
-0002a060: 7369 7374 656e 742c 0a20 2020 2020 2020  sistent,.       
-0002a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a090: 2020 206d 6f64 653d 6d6f 6465 290a 2020     mode=mode).  
-0002a0a0: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
-0002a0b0: 6167 655f 6f62 6a0a 2020 2020 2020 2020  age_obj.        
-0002a0c0: 6861 6e64 6c65 203d 2067 6c6f 6261 6c5f  handle = global_
-0002a0d0: 7573 6572 5f73 7461 7465 2e67 6574 5f68  user_state.get_h
-0002a0e0: 616e 646c 655f 6672 6f6d 5f73 746f 7261  andle_from_stora
-0002a0f0: 6765 5f6e 616d 6528 0a20 2020 2020 2020  ge_name(.       
-0002a100: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002a110: 2e6e 616d 6529 0a20 2020 2020 2020 2069  .name).        i
-0002a120: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
-0002a130: 2020 2020 2020 2320 4966 2068 616e 646c        # If handl
-0002a140: 6520 6578 6973 7473 2c20 6465 6c65 7465  e exists, delete
-0002a150: 206d 616e 7561 6c6c 790a 2020 2020 2020   manually.      
-0002a160: 2020 2020 2020 2320 544f 444f 2872 6f6d        # TODO(rom
-0002a170: 696c 6229 3a20 5468 6973 2069 7320 706f  ilb): This is po
-0002a180: 7465 6e74 6961 6c6c 7920 7269 736b 7920  tentially risky 
-0002a190: 2d20 6966 2074 6865 2064 656c 6574 6520  - if the delete 
-0002a1a0: 6d65 7468 6f64 2068 6173 0a20 2020 2020  method has.     
-0002a1b0: 2020 2020 2020 2023 2020 2062 7567 732c         #   bugs,
-0002a1c0: 2074 6869 7320 6361 6e20 6361 7573 6520   this can cause 
-0002a1d0: 7265 736f 7572 6365 206c 6561 6b73 2e20  resource leaks. 
-0002a1e0: 4964 6561 6c6c 7920 7765 2073 686f 756c  Ideally we shoul
-0002a1f0: 6420 6d61 6e75 616c 6c79 0a20 2020 2020  d manually.     
-0002a200: 2020 2020 2020 2023 2020 2065 6a65 6374         #   eject
-0002a210: 2073 746f 7261 6765 2066 726f 6d20 676c   storage from gl
-0002a220: 6f62 616c 5f75 7365 725f 7374 6174 6520  obal_user_state 
-0002a230: 616e 6420 6465 6c65 7465 2074 6865 2062  and delete the b
-0002a240: 7563 6b65 7420 7573 696e 670a 2020 2020  ucket using.    
-0002a250: 2020 2020 2020 2020 2320 2020 626f 746f          #   boto
-0002a260: 3320 6469 7265 6374 6c79 2e0a 2020 2020  3 directly..    
-0002a270: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002a280: 6f62 6a2e 6465 6c65 7465 2829 0a0a 2020  obj.delete()..  
-0002a290: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002a2a0: 650a 2020 2020 6465 6620 746d 705f 7363  e.    def tmp_sc
-0002a2b0: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0002a2c0: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
-0002a2d0: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-0002a2e0: 2020 2320 4372 6561 7465 7320 6120 7374    # Creates a st
-0002a2f0: 6f72 6167 6520 6f62 6a65 6374 2077 6974  orage object wit
-0002a300: 6820 6e6f 2073 6f75 7263 6520 746f 2063  h no source to c
-0002a310: 7265 6174 6520 6120 7363 7261 7463 6820  reate a scratch 
-0002a320: 7374 6f72 6167 652e 0a20 2020 2020 2020  storage..       
-0002a330: 2023 2053 746f 7265 7320 6d75 7374 2062   # Stores must b
-0002a340: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
-0002a350: 6573 742e 0a20 2020 2020 2020 2079 6965  est..        yie
-0002a360: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-0002a370: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-0002a380: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
-0002a390: 745f 6e61 6d65 290a 0a20 2020 2040 7079  t_name)..    @py
-0002a3a0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002a3b0: 2064 6566 2074 6d70 5f6d 756c 7469 706c   def tmp_multipl
-0002a3c0: 655f 7363 7261 7463 685f 7374 6f72 6167  e_scratch_storag
-0002a3d0: 655f 6f62 6a28 7365 6c66 293a 0a20 2020  e_obj(self):.   
-0002a3e0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002a3f0: 206c 6973 7420 6f66 2035 2073 746f 7261   list of 5 stora
-0002a400: 6765 206f 626a 6563 7473 2077 6974 6820  ge objects with 
-0002a410: 6e6f 2073 6f75 7263 6520 746f 2063 7265  no source to cre
-0002a420: 6174 650a 2020 2020 2020 2020 2320 6d75  ate.        # mu
-0002a430: 6c74 6970 6c65 2073 6372 6174 6368 2073  ltiple scratch s
-0002a440: 746f 7261 6765 732e 0a20 2020 2020 2020  torages..       
-0002a450: 2023 2053 746f 7265 7320 666f 7220 6561   # Stores for ea
-0002a460: 6368 206f 626a 6563 7420 696e 2074 6865  ch object in the
-0002a470: 206c 6973 7420 6d75 7374 2062 6520 6164   list must be ad
-0002a480: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0002a490: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002a4a0: 5f6d 756c 745f 6f62 6a20 3d20 5b5d 0a20  _mult_obj = []. 
-0002a4b0: 2020 2020 2020 2066 6f72 205f 2069 6e20         for _ in 
-0002a4c0: 7261 6e67 6528 3529 3a0a 2020 2020 2020  range(5):.      
-0002a4d0: 2020 2020 2020 7469 6d65 7374 616d 7020        timestamp 
-0002a4e0: 3d20 7374 7228 7469 6d65 2e74 696d 6528  = str(time.time(
-0002a4f0: 2929 2e72 6570 6c61 6365 2827 2e27 2c20  )).replace('.', 
-0002a500: 2727 290a 2020 2020 2020 2020 2020 2020  '').            
-0002a510: 7374 6f72 655f 6f62 6a20 3d20 7374 6f72  store_obj = stor
-0002a520: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-0002a530: 6e61 6d65 3d66 2773 6b79 2d74 6573 742d  name=f'sky-test-
-0002a540: 7b74 696d 6573 7461 6d70 7d27 290a 2020  {timestamp}').  
-0002a550: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0002a560: 655f 6d75 6c74 5f6f 626a 2e61 7070 656e  e_mult_obj.appen
-0002a570: 6428 7374 6f72 655f 6f62 6a29 0a20 2020  d(store_obj).   
-0002a580: 2020 2020 2079 6965 6c64 2073 746f 7261       yield stora
-0002a590: 6765 5f6d 756c 745f 6f62 6a0a 2020 2020  ge_mult_obj.    
-0002a5a0: 2020 2020 666f 7220 7374 6f72 6167 655f      for storage_
-0002a5b0: 6f62 6a20 696e 2073 746f 7261 6765 5f6d  obj in storage_m
-0002a5c0: 756c 745f 6f62 6a3a 0a20 2020 2020 2020  ult_obj:.       
-0002a5d0: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
-0002a5e0: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-0002a5f0: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
-0002a600: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
-0002a610: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002a620: 6f72 6167 655f 6f62 6a2e 6e61 6d65 290a  orage_obj.name).
-0002a630: 2020 2020 2020 2020 2020 2020 6966 2068              if h
-0002a640: 616e 646c 653a 0a20 2020 2020 2020 2020  andle:.         
-0002a650: 2020 2020 2020 2023 2049 6620 6861 6e64         # If hand
-0002a660: 6c65 2065 7869 7374 732c 2064 656c 6574  le exists, delet
-0002a670: 6520 6d61 6e75 616c 6c79 0a20 2020 2020  e manually.     
-0002a680: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0002a690: 4f28 726f 6d69 6c62 293a 2054 6869 7320  O(romilb): This 
-0002a6a0: 6973 2070 6f74 656e 7469 616c 6c79 2072  is potentially r
-0002a6b0: 6973 6b79 202d 2069 6620 7468 6520 6465  isky - if the de
-0002a6c0: 6c65 7465 206d 6574 686f 6420 6861 730a  lete method has.
-0002a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6e0: 2320 6275 6773 2c20 7468 6973 2063 616e  # bugs, this can
-0002a6f0: 2063 6175 7365 2072 6573 6f75 7263 6520   cause resource 
-0002a700: 6c65 616b 732e 2049 6465 616c 6c79 2077  leaks. Ideally w
-0002a710: 6520 7368 6f75 6c64 206d 616e 7561 6c6c  e should manuall
-0002a720: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-0002a730: 2020 2320 656a 6563 7420 7374 6f72 6167    # eject storag
-0002a740: 6520 6672 6f6d 2067 6c6f 6261 6c5f 7573  e from global_us
-0002a750: 6572 5f73 7461 7465 2061 6e64 2064 656c  er_state and del
-0002a760: 6574 6520 7468 6520 6275 636b 6574 2075  ete the bucket u
-0002a770: 7369 6e67 0a20 2020 2020 2020 2020 2020  sing.           
-0002a780: 2020 2020 2023 2062 6f74 6f33 2064 6972       # boto3 dir
-0002a790: 6563 746c 792e 0a20 2020 2020 2020 2020  ectly..         
-0002a7a0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-0002a7b0: 626a 2e64 656c 6574 6528 290a 0a20 2020  bj.delete()..   
-0002a7c0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0002a7d0: 0a20 2020 2064 6566 2074 6d70 5f6d 756c  .    def tmp_mul
-0002a7e0: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
-0002a7f0: 7263 655f 7374 6f72 6167 655f 6f62 6a28  rce_storage_obj(
-0002a800: 7365 6c66 293a 0a20 2020 2020 2020 2023  self):.        #
-0002a810: 2043 7265 6174 6573 2061 206c 6973 7420   Creates a list 
-0002a820: 6f66 2073 746f 7261 6765 206f 626a 6563  of storage objec
-0002a830: 7473 2077 6974 6820 6375 7374 6f6d 2073  ts with custom s
-0002a840: 6f75 7263 6520 6e61 6d65 7320 746f 0a20  ource names to. 
-0002a850: 2020 2020 2020 2023 2063 7265 6174 6520         # create 
-0002a860: 6d75 6c74 6970 6c65 2073 6372 6174 6368  multiple scratch
-0002a870: 2073 746f 7261 6765 732e 0a20 2020 2020   storages..     
-0002a880: 2020 2023 2053 746f 7265 7320 666f 7220     # Stores for 
-0002a890: 6561 6368 206f 626a 6563 7420 696e 2074  each object in t
-0002a8a0: 6865 206c 6973 7420 6d75 7374 2062 6520  he list must be 
-0002a8b0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
-0002a8c0: 742e 0a20 2020 2020 2020 2063 7573 746f  t..        custo
-0002a8d0: 6d5f 736f 7572 6365 5f6e 616d 6573 203d  m_source_names =
-0002a8e0: 205b 2722 7061 7468 2057 6974 6820 5370   ['"path With Sp
-0002a8f0: 6163 6573 2227 2c20 2770 6174 6820 5769  aces"', 'path Wi
-0002a900: 7468 2053 7061 6365 7327 5d0a 2020 2020  th Spaces'].    
-0002a910: 2020 2020 7374 6f72 6167 655f 6d75 6c74      storage_mult
-0002a920: 5f6f 626a 203d 205b 5d0a 2020 2020 2020  _obj = [].      
-0002a930: 2020 666f 7220 6e61 6d65 2069 6e20 6375    for name in cu
-0002a940: 7374 6f6d 5f73 6f75 7263 655f 6e61 6d65  stom_source_name
-0002a950: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-0002a960: 7263 5f70 6174 6820 3d20 6f73 2e70 6174  rc_path = os.pat
-0002a970: 682e 6578 7061 6e64 7573 6572 2866 277e  h.expanduser(f'~
-0002a980: 2f7b 6e61 6d65 7d27 290a 2020 2020 2020  /{name}').      
-0002a990: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
-0002a9a0: 7468 2873 7263 5f70 6174 6829 2e65 7870  th(src_path).exp
-0002a9b0: 616e 6475 7365 7228 292e 6d6b 6469 7228  anduser().mkdir(
-0002a9c0: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
-0002a9d0: 2020 2020 2020 2020 2020 2074 696d 6573             times
-0002a9e0: 7461 6d70 203d 2073 7472 2874 696d 652e  tamp = str(time.
-0002a9f0: 7469 6d65 2829 292e 7265 706c 6163 6528  time()).replace(
-0002aa00: 272e 272c 2027 2729 0a20 2020 2020 2020  '.', '').       
-0002aa10: 2020 2020 2073 746f 7265 5f6f 626a 203d       store_obj =
-0002aa20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002aa30: 7261 6765 286e 616d 653d 6627 736b 792d  rage(name=f'sky-
-0002aa40: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
-0002aa50: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0002aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002aa80: 6f75 7263 653d 7372 635f 7061 7468 290a  ource=src_path).
-0002aa90: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002aaa0: 6167 655f 6d75 6c74 5f6f 626a 2e61 7070  age_mult_obj.app
-0002aab0: 656e 6428 7374 6f72 655f 6f62 6a29 0a20  end(store_obj). 
-0002aac0: 2020 2020 2020 2079 6965 6c64 2073 746f         yield sto
-0002aad0: 7261 6765 5f6d 756c 745f 6f62 6a0a 2020  rage_mult_obj.  
-0002aae0: 2020 2020 2020 666f 7220 7374 6f72 6167        for storag
-0002aaf0: 655f 6f62 6a20 696e 2073 746f 7261 6765  e_obj in storage
-0002ab00: 5f6d 756c 745f 6f62 6a3a 0a20 2020 2020  _mult_obj:.     
-0002ab10: 2020 2020 2020 2068 616e 646c 6520 3d20         handle = 
-0002ab20: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
-0002ab30: 652e 6765 745f 6861 6e64 6c65 5f66 726f  e.get_handle_fro
-0002ab40: 6d5f 7374 6f72 6167 655f 6e61 6d65 280a  m_storage_name(.
-0002ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab60: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002ab70: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002ab80: 2068 616e 646c 653a 0a20 2020 2020 2020   handle:.       
-0002ab90: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002aba0: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
-0002abb0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-0002abc0: 7265 0a20 2020 2064 6566 2074 6d70 5f6c  re.    def tmp_l
-0002abd0: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-0002abe0: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-0002abf0: 745f 6e61 6d65 2c20 746d 705f 736f 7572  t_name, tmp_sour
-0002ac00: 6365 293a 0a20 2020 2020 2020 2023 2043  ce):.        # C
-0002ac10: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-0002ac20: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
-0002ac30: 742e 2053 746f 7265 7320 6d75 7374 2062  t. Stores must b
-0002ac40: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
-0002ac50: 6573 742e 0a20 2020 2020 2020 2079 6965  est..        yie
-0002ac60: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-0002ac70: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-0002ac80: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
-0002ac90: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
-0002aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002acc0: 2020 2020 2073 6f75 7263 653d 746d 705f       source=tmp_
-0002acd0: 736f 7572 6365 290a 0a20 2020 2040 7079  source)..    @py
-0002ace0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002acf0: 2064 6566 2074 6d70 5f6c 6f63 616c 5f6c   def tmp_local_l
-0002ad00: 6973 745f 7374 6f72 6167 655f 6f62 6a28  ist_storage_obj(
-0002ad10: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
-0002ad20: 5f6e 616d 652c 2074 6d70 5f73 6f75 7263  _name, tmp_sourc
-0002ad30: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
-0002ad40: 6561 7465 7320 6120 7465 6d70 2073 746f  eates a temp sto
-0002ad50: 7261 6765 206f 626a 6563 7420 7768 6963  rage object whic
-0002ad60: 6820 7573 6573 2061 206c 6973 7420 6f66  h uses a list of
-0002ad70: 2070 6174 6873 2061 7320 736f 7572 6365   paths as source
-0002ad80: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
-0002ad90: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
-0002ada0: 2069 6e20 7468 6520 7465 7374 2e20 4166   in the test. Af
-0002adb0: 7465 7220 7570 6c6f 6164 2c20 7468 6520  ter upload, the 
-0002adc0: 6275 636b 6574 2073 686f 756c 640a 2020  bucket should.  
-0002add0: 2020 2020 2020 2320 6861 7665 2074 776f        # have two
-0002ade0: 2066 696c 6573 202d 202f 746d 702d 6669   files - /tmp-fi
-0002adf0: 6c65 2061 6e64 202f 746d 702d 736f 7572  le and /tmp-sour
-0002ae00: 6365 2f74 6d70 2d66 696c 650a 2020 2020  ce/tmp-file.    
-0002ae10: 2020 2020 6c69 7374 5f73 6f75 7263 6520      list_source 
-0002ae20: 3d20 5b74 6d70 5f73 6f75 7263 652c 2074  = [tmp_source, t
-0002ae30: 6d70 5f73 6f75 7263 6520 2b20 272f 746d  mp_source + '/tm
-0002ae40: 702d 6669 6c65 275d 0a20 2020 2020 2020  p-file'].       
-0002ae50: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
-0002ae60: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
-0002ae70: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
-0002ae80: 7563 6b65 745f 6e61 6d65 2c0a 2020 2020  ucket_name,.    
-0002ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aeb0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0002aec0: 6c69 7374 5f73 6f75 7263 6529 0a0a 2020  list_source)..  
-0002aed0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002aee0: 650a 2020 2020 6465 6620 746d 705f 6275  e.    def tmp_bu
-0002aef0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
-0002af00: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
-0002af10: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
-0002af20: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
-0002af30: 656d 706f 7261 7279 2073 746f 7261 6765  emporary storage
-0002af40: 206f 626a 6563 7420 666f 7220 7465 7374   object for test
-0002af50: 696e 6720 6275 6c6b 2064 656c 6574 696f  ing bulk deletio
-0002af60: 6e2e 0a20 2020 2020 2020 2023 2053 746f  n..        # Sto
-0002af70: 7265 7320 6d75 7374 2062 6520 6164 6465  res must be adde
-0002af80: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
-0002af90: 2020 2020 2020 2077 6974 6820 7465 6d70         with temp
-0002afa0: 6669 6c65 2e54 656d 706f 7261 7279 4469  file.TemporaryDi
-0002afb0: 7265 6374 6f72 7928 2920 6173 2074 6d70  rectory() as tmp
-0002afc0: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
-0002afd0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002afe0: 6b5f 6f75 7470 7574 2866 276d 6b64 6972  k_output(f'mkdir
-0002aff0: 202d 7020 7b74 6d70 6469 727d 2f66 6f6c   -p {tmpdir}/fol
-0002b000: 6465 727b 7b30 3030 2e2e 3235 357d 7d27  der{{000..255}}'
-0002b010: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b030: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-0002b040: 290a 2020 2020 2020 2020 2020 2020 7375  ).            su
-0002b050: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002b060: 7574 7075 7428 6627 746f 7563 6820 7b74  utput(f'touch {t
-0002b070: 6d70 6469 727d 2f74 6573 747b 7b30 3030  mpdir}/test{{000
-0002b080: 2e2e 3235 357d 7d2e 7478 7427 2c0a 2020  ..255}}.txt',.  
-0002b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0b0: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
-0002b0c0: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
-0002b0d0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0002b0e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-0002b0f0: 2020 2066 2774 6f75 6368 207b 746d 7064     f'touch {tmpd
-0002b100: 6972 7d2f 666f 6c64 6572 7b7b 3030 302e  ir}/folder{{000.
-0002b110: 2e32 3535 7d7d 2f74 6573 742e 7478 7427  .255}}/test.txt'
-0002b120: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-0002b130: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-0002b140: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
-0002b150: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
-0002b160: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
-0002b170: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0002b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1a0: 2020 2020 2020 736f 7572 6365 3d74 6d70        source=tmp
-0002b1b0: 6469 7229 0a0a 2020 2020 4070 7974 6573  dir)..    @pytes
-0002b1c0: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002b1d0: 6620 746d 705f 636f 7079 5f6d 6e74 5f65  f tmp_copy_mnt_e
-0002b1e0: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
-0002b1f0: 6f62 6a28 7365 6c66 2c20 746d 705f 7363  obj(self, tmp_sc
-0002b200: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0002b210: 6a29 3a0a 2020 2020 2020 2020 2320 4372  j):.        # Cr
-0002b220: 6561 7465 7320 6120 636f 7079 206d 6f75  eates a copy mou
-0002b230: 6e74 2073 746f 7261 6765 2077 6869 6368  nt storage which
-0002b240: 2072 6575 7365 7320 616e 2065 7869 7374   reuses an exist
-0002b250: 696e 6720 7374 6f72 6167 6520 6f62 6a65  ing storage obje
-0002b260: 6374 2e0a 2020 2020 2020 2020 746d 705f  ct..        tmp_
-0002b270: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-0002b280: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0002b290: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002b2a0: 7970 652e 5333 290a 2020 2020 2020 2020  ype.S3).        
-0002b2b0: 7374 6f72 6167 655f 6e61 6d65 203d 2074  storage_name = t
-0002b2c0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0002b2d0: 6765 5f6f 626a 2e6e 616d 650a 0a20 2020  ge_obj.name..   
-0002b2e0: 2020 2020 2023 2054 7279 2074 6f20 696e       # Try to in
-0002b2f0: 6974 6961 6c69 7a65 2061 6e6f 7468 6572  itialize another
-0002b300: 2073 746f 7261 6765 2077 6974 6820 7468   storage with th
-0002b310: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
-0002b320: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
-0002b330: 2023 2061 626f 7665 2c20 6275 7420 6e6f   # above, but no
-0002b340: 7720 696e 2043 4f50 5920 6d6f 6465 2e20  w in COPY mode. 
-0002b350: 5468 6973 2073 686f 756c 6420 7375 6363  This should succ
-0002b360: 6565 642e 0a20 2020 2020 2020 2079 6965  eed..        yie
-0002b370: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-0002b380: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-0002b390: 7428 6e61 6d65 3d73 746f 7261 6765 5f6e  t(name=storage_n
-0002b3a0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3d0: 2020 6d6f 6465 3d73 746f 7261 6765 5f6c    mode=storage_l
-0002b3e0: 6962 2e53 746f 7261 6765 4d6f 6465 2e43  ib.StorageMode.C
-0002b3f0: 4f50 5929 0a0a 2020 2020 4070 7974 6573  OPY)..    @pytes
-0002b400: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-0002b410: 6620 746d 705f 6769 7469 676e 6f72 655f  f tmp_gitignore_
-0002b420: 7374 6f72 6167 655f 6f62 6a28 7365 6c66  storage_obj(self
-0002b430: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
-0002b440: 652c 2067 6974 6967 6e6f 7265 5f73 7472  e, gitignore_str
-0002b450: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
-0002b460: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0002b470: 706f 7261 7279 2073 746f 7261 6765 206f  porary storage o
-0002b480: 626a 6563 7420 666f 7220 7465 7374 696e  bject for testin
-0002b490: 6720 2e67 6974 6967 6e6f 7265 2066 696c  g .gitignore fil
-0002b4a0: 7465 722e 0a20 2020 2020 2020 2023 2047  ter..        # G
-0002b4b0: 4954 4947 494e 4f52 455f 5354 5255 4354  ITIGINORE_STRUCT
-0002b4c0: 5552 4520 6973 2072 6570 7265 7365 6e74  URE is represent
-0002b4d0: 696e 6720 6120 6669 6c65 2073 7472 7563  ing a file struc
-0002b4e0: 7475 7265 2069 6e20 6120 6469 6374 696f  ture in a dictio
-0002b4f0: 6e61 7279 0a20 2020 2020 2020 2023 2066  nary.        # f
-0002b500: 6f72 6d61 742e 2043 7265 6174 6564 2073  ormat. Created s
-0002b510: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
-0002b520: 6c6c 2063 6f6e 7461 696e 2074 6865 2066  ll contain the f
-0002b530: 696c 6520 7374 7275 6374 7572 6520 616c  ile structure al
-0002b540: 6f6e 670a 2020 2020 2020 2020 2320 7769  ong.        # wi
-0002b550: 7468 202e 6769 7469 676e 6f72 6520 616e  th .gitignore an
-0002b560: 6420 2e67 6974 2f69 6e66 6f2f 6578 636c  d .git/info/excl
-0002b570: 7564 6520 6669 6c65 7320 746f 2074 6573  ude files to tes
-0002b580: 7420 6578 636c 7564 6520 6669 6c74 6572  t exclude filter
-0002b590: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
-0002b5a0: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
-0002b5b0: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
-0002b5c0: 2020 2020 2020 7769 7468 2074 656d 7066        with tempf
-0002b5d0: 696c 652e 5465 6d70 6f72 6172 7944 6972  ile.TemporaryDir
-0002b5e0: 6563 746f 7279 2829 2061 7320 746d 7064  ectory() as tmpd
-0002b5f0: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-0002b600: 2320 4372 6561 7465 7320 6669 6c65 2073  # Creates file s
-0002b610: 7472 7563 7475 7265 2074 6f20 6265 2075  tructure to be u
-0002b620: 706c 6f61 6465 6420 696e 2074 6865 2053  ploaded in the S
-0002b630: 746f 7261 6765 0a20 2020 2020 2020 2020  torage.         
-0002b640: 2020 2073 656c 662e 6372 6561 7465 5f64     self.create_d
-0002b650: 6972 5f73 7472 7563 7475 7265 2874 6d70  ir_structure(tmp
-0002b660: 6469 722c 2067 6974 6967 6e6f 7265 5f73  dir, gitignore_s
-0002b670: 7472 7563 7475 7265 290a 0a20 2020 2020  tructure)..     
-0002b680: 2020 2020 2020 2023 2043 7265 6174 6520         # Create 
-0002b690: 2e67 6974 6967 6e6f 7265 2061 6e64 206c  .gitignore and l
-0002b6a0: 6973 7420 6669 6c65 732f 6469 7273 2074  ist files/dirs t
-0002b6b0: 6f20 6265 2065 7863 6c75 6465 6420 696e  o be excluded in
-0002b6c0: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
-0002b6d0: 736b 7970 696c 6f74 5f70 6174 6820 3d20  skypilot_path = 
-0002b6e0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-0002b6f0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-0002b700: 736b 792e 5f5f 6669 6c65 5f5f 2929 0a20  sky.__file__)). 
-0002b710: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
-0002b720: 7061 7468 203d 2066 277b 746d 7064 6972  path = f'{tmpdir
-0002b730: 7d2f 2e67 6974 6967 6e6f 7265 270a 2020  }/.gitignore'.  
-0002b740: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
-0002b750: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-0002b760: 696e 2873 6b79 7069 6c6f 745f 7061 7468  in(skypilot_path
-0002b770: 2c20 2774 6573 7473 2f67 6974 6967 6e6f  , 'tests/gitigno
-0002b780: 7265 5f74 6573 7427 290a 2020 2020 2020  re_test').      
-0002b790: 2020 2020 2020 7368 7574 696c 2e63 6f70        shutil.cop
-0002b7a0: 7966 696c 6528 6669 6c65 5f70 6174 682c  yfile(file_path,
-0002b7b0: 2074 656d 705f 7061 7468 290a 0a20 2020   temp_path)..   
-0002b7c0: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
-0002b7d0: 6520 2e67 6974 2f69 6e66 6f2f 6578 636c  e .git/info/excl
-0002b7e0: 7564 6520 616e 6420 6c69 7374 2066 696c  ude and list fil
-0002b7f0: 6573 2f64 6972 7320 746f 2062 6520 6578  es/dirs to be ex
-0002b800: 636c 7564 6564 2069 6e20 6974 0a20 2020  cluded in it.   
-0002b810: 2020 2020 2020 2020 2074 656d 705f 7061           temp_pa
-0002b820: 7468 203d 2066 277b 746d 7064 6972 7d2f  th = f'{tmpdir}/
-0002b830: 2e67 6974 2f69 6e66 6f2f 270a 2020 2020  .git/info/'.    
-0002b840: 2020 2020 2020 2020 6f73 2e6d 616b 6564          os.maked
-0002b850: 6972 7328 7465 6d70 5f70 6174 6829 0a20  irs(temp_path). 
-0002b860: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
-0002b870: 6578 636c 7564 655f 7061 7468 203d 206f  exclude_path = o
-0002b880: 732e 7061 7468 2e6a 6f69 6e28 7465 6d70  s.path.join(temp
-0002b890: 5f70 6174 682c 2027 6578 636c 7564 6527  _path, 'exclude'
-0002b8a0: 290a 2020 2020 2020 2020 2020 2020 6669  ).            fi
-0002b8b0: 6c65 5f70 6174 6820 3d20 6f73 2e70 6174  le_path = os.pat
-0002b8c0: 682e 6a6f 696e 2873 6b79 7069 6c6f 745f  h.join(skypilot_
-0002b8d0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0002b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b8f0: 2020 2020 2020 2020 2020 2027 7465 7374             'test
-0002b900: 732f 6769 745f 696e 666f 5f65 7863 6c75  s/git_info_exclu
-0002b910: 6465 5f74 6573 7427 290a 2020 2020 2020  de_test').      
-0002b920: 2020 2020 2020 7368 7574 696c 2e63 6f70        shutil.cop
-0002b930: 7966 696c 6528 6669 6c65 5f70 6174 682c  yfile(file_path,
-0002b940: 2074 656d 705f 6578 636c 7564 655f 7061   temp_exclude_pa
-0002b950: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
-0002b960: 2023 2043 7265 6174 6520 736b 7920 5374   # Create sky St
-0002b970: 6f72 6167 6520 7769 7468 2074 6865 2066  orage with the f
-0002b980: 696c 6573 2063 7265 6174 6564 0a20 2020  iles created.   
-0002b990: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
-0002b9a0: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
-0002b9b0: 746f 7261 6765 5f6f 626a 6563 7428 0a20  torage_object(. 
-0002b9c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002b9d0: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
-0002b9e0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0002b9f0: 2020 2020 2073 6f75 7263 653d 746d 7064       source=tmpd
-0002ba00: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
-0002ba10: 2020 2020 6d6f 6465 3d73 746f 7261 6765      mode=storage
-0002ba20: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
-0002ba30: 2e43 4f50 5929 0a0a 2020 2020 4070 7974  .COPY)..    @pyt
-0002ba40: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-0002ba50: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
-0002ba60: 7563 6b65 7428 7365 6c66 2c20 746d 705f  ucket(self, tmp_
-0002ba70: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-0002ba80: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002ba90: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
-0002baa0: 6574 2075 7369 6e67 2061 7773 636c 690a  et using awscli.
-0002bab0: 2020 2020 2020 2020 6275 636b 6574 5f75          bucket_u
-0002bac0: 7269 203d 2066 2773 333a 2f2f 7b74 6d70  ri = f's3://{tmp
-0002bad0: 5f62 7563 6b65 745f 6e61 6d65 7d27 0a20  _bucket_name}'. 
-0002bae0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0002baf0: 732e 6368 6563 6b5f 6361 6c6c 285b 2761  s.check_call(['a
-0002bb00: 7773 272c 2027 7333 272c 2027 6d62 272c  ws', 's3', 'mb',
-0002bb10: 2062 7563 6b65 745f 7572 695d 290a 2020   bucket_uri]).  
-0002bb20: 2020 2020 2020 7969 656c 6420 746d 705f        yield tmp_
-0002bb30: 6275 636b 6574 5f6e 616d 652c 2062 7563  bucket_name, buc
-0002bb40: 6b65 745f 7572 690a 2020 2020 2020 2020  ket_uri.        
-0002bb50: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002bb60: 5f63 616c 6c28 5b27 6177 7327 2c20 2773  _call(['aws', 's
-0002bb70: 3327 2c20 2772 6227 2c20 6275 636b 6574  3', 'rb', bucket
-0002bb80: 5f75 7269 2c20 272d 2d66 6f72 6365 275d  _uri, '--force']
-0002bb90: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002bba0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002bbb0: 6d70 5f67 7375 7469 6c5f 6275 636b 6574  mp_gsutil_bucket
-0002bbc0: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-0002bbd0: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-0002bbe0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0002bbf0: 706f 7261 7279 2062 7563 6b65 7420 7573  porary bucket us
-0002bc00: 696e 6720 6773 7574 696c 0a20 2020 2020  ing gsutil.     
-0002bc10: 2020 2062 7563 6b65 745f 7572 6920 3d20     bucket_uri = 
-0002bc20: 6627 6773 3a2f 2f7b 746d 705f 6275 636b  f'gs://{tmp_buck
-0002bc30: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
-0002bc40: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0002bc50: 636b 5f63 616c 6c28 5b27 6773 7574 696c  ck_call(['gsutil
-0002bc60: 272c 2027 6d62 272c 2062 7563 6b65 745f  ', 'mb', bucket_
-0002bc70: 7572 695d 290a 2020 2020 2020 2020 7969  uri]).        yi
-0002bc80: 656c 6420 746d 705f 6275 636b 6574 5f6e  eld tmp_bucket_n
-0002bc90: 616d 652c 2062 7563 6b65 745f 7572 690a  ame, bucket_uri.
-0002bca0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0002bcb0: 7373 2e63 6865 636b 5f63 616c 6c28 5b27  ss.check_call(['
-0002bcc0: 6773 7574 696c 272c 2027 726d 272c 2027  gsutil', 'rm', '
-0002bcd0: 2d72 272c 2062 7563 6b65 745f 7572 695d  -r', bucket_uri]
-0002bce0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0002bcf0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0002bd00: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
-0002bd10: 5f72 3228 7365 6c66 2c20 746d 705f 6275  _r2(self, tmp_bu
-0002bd20: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
-0002bd30: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002bd40: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
-0002bd50: 2075 7369 6e67 2061 7773 636c 690a 2020   using awscli.  
-0002bd60: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
-0002bd70: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
-0002bd80: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
-0002bd90: 290a 2020 2020 2020 2020 6275 636b 6574  ).        bucket
-0002bda0: 5f75 7269 203d 2066 2773 333a 2f2f 7b74  _uri = f's3://{t
-0002bdb0: 6d70 5f62 7563 6b65 745f 6e61 6d65 7d27  mp_bucket_name}'
-0002bdc0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0002bdd0: 6573 732e 6368 6563 6b5f 6361 6c6c 280a  ess.check_call(.
-0002bde0: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
-0002bdf0: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
-0002be00: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
-0002be10: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
-0002be20: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
-0002be30: 3320 6d62 207b 6275 636b 6574 5f75 7269  3 mb {bucket_uri
-0002be40: 7d20 2d2d 656e 6470 6f69 6e74 207b 656e  } --endpoint {en
-0002be50: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
-0002be60: 6f66 696c 653d 7232 272c 0a20 2020 2020  ofile=r2',.     
-0002be70: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-0002be80: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
-0002be90: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0002bea0: 2c20 6275 636b 6574 5f75 7269 0a20 2020  , bucket_uri.   
-0002beb0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0002bec0: 6368 6563 6b5f 6361 6c6c 280a 2020 2020  check_call(.    
-0002bed0: 2020 2020 2020 2020 6627 4157 535f 5348          f'AWS_SH
-0002bee0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
-0002bef0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
-0002bf00: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
-0002bf10: 5f50 4154 487d 2061 7773 2073 3320 7262  _PATH} aws s3 rb
-0002bf20: 207b 6275 636b 6574 5f75 7269 7d20 2d2d   {bucket_uri} --
-0002bf30: 666f 7263 6520 2d2d 656e 6470 6f69 6e74  force --endpoint
-0002bf40: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
-0002bf50: 2d2d 7072 6f66 696c 653d 7232 272c 0a20  --profile=r2',. 
-0002bf60: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-0002bf70: 3d54 7275 6529 0a0a 2020 2020 4070 7974  =True)..    @pyt
-0002bf80: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-0002bf90: 6465 6620 746d 705f 6962 6d5f 636f 735f  def tmp_ibm_cos_
-0002bfa0: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
-0002bfb0: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
-0002bfc0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002bfd0: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
-0002bfe0: 6b65 7420 7573 696e 6720 4942 4d20 434f  ket using IBM CO
-0002bff0: 5320 4150 490a 2020 2020 2020 2020 7374  S API.        st
-0002c000: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
-0002c010: 6167 655f 6c69 622e 4942 4d43 6f73 5374  age_lib.IBMCosSt
-0002c020: 6f72 6528 736f 7572 6365 3d22 222c 206e  ore(source="", n
-0002c030: 616d 653d 746d 705f 6275 636b 6574 5f6e  ame=tmp_bucket_n
-0002c040: 616d 6529 0a20 2020 2020 2020 2079 6965  ame).        yie
-0002c050: 6c64 2074 6d70 5f62 7563 6b65 745f 6e61  ld tmp_bucket_na
-0002c060: 6d65 0a20 2020 2020 2020 2073 746f 7261  me.        stora
-0002c070: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
-0002c080: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-0002c090: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-0002c0a0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
-0002c0b0: 6f62 6a28 7365 6c66 2c20 7265 7175 6573  obj(self, reques
-0002c0c0: 7429 3a0a 2020 2020 2020 2020 2320 496e  t):.        # In
-0002c0d0: 6974 6961 6c69 7a65 7320 6120 7374 6f72  itializes a stor
-0002c0e0: 6167 6520 6f62 6a65 6374 2077 6974 6820  age object with 
-0002c0f0: 6120 7075 626c 6963 2062 7563 6b65 740a  a public bucket.
-0002c100: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002c110: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
-0002c120: 622e 5374 6f72 6167 6528 736f 7572 6365  b.Storage(source
-0002c130: 3d72 6571 7565 7374 2e70 6172 616d 290a  =request.param).
-0002c140: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
-0002c150: 6f72 6167 655f 6f62 6a0a 2020 2020 2020  orage_obj.      
-0002c160: 2020 2320 5468 6973 2064 6f65 7320 6e6f    # This does no
-0002c170: 7420 7265 7175 6972 6520 616e 7920 6465  t require any de
-0002c180: 6c65 7469 6f6e 206c 6f67 6963 2062 6563  letion logic bec
-0002c190: 6175 7365 2069 7420 6973 2061 2070 7562  ause it is a pub
-0002c1a0: 6c69 6320 6275 636b 6574 0a20 2020 2020  lic bucket.     
-0002c1b0: 2020 2023 2061 6e64 2073 686f 756c 6420     # and should 
-0002c1c0: 6e6f 7420 6765 7420 6164 6465 6420 746f  not get added to
-0002c1d0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0002c1e0: 7465 2e0a 0a20 2020 2040 7079 7465 7374  te...    @pytest
-0002c1f0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0002c200: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-0002c210: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0002c220: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
-0002c230: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002c240: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002c250: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
-0002c260: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
-0002c270: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0002c280: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
-0002c290: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
-0002c2a0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002c2b0: 6962 6d29 2c0a 2020 2020 2020 2020 7079  ibm),.        py
-0002c2c0: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
-0002c2d0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002c2e0: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
-0002c2f0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-0002c300: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
-0002c310: 6620 7465 7374 5f6e 6577 5f62 7563 6b65  f test_new_bucke
-0002c320: 745f 6372 6561 7469 6f6e 5f61 6e64 5f64  t_creation_and_d
-0002c330: 656c 6574 696f 6e28 7365 6c66 2c20 746d  eletion(self, tm
-0002c340: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-0002c350: 6f62 6a2c 0a20 2020 2020 2020 2020 2020  obj,.           
-0002c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c380: 2020 2073 746f 7265 5f74 7970 6529 3a0a     store_type):.
-0002c390: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002c3a0: 7320 6120 6e65 7720 6275 636b 6574 2077  s a new bucket w
-0002c3b0: 6974 6820 6120 6c6f 6361 6c20 736f 7572  ith a local sour
-0002c3c0: 6365 2c20 7570 6c6f 6164 7320 6669 6c65  ce, uploads file
-0002c3d0: 7320 746f 2069 740a 2020 2020 2020 2020  s to it.        
-0002c3e0: 2320 616e 6420 6465 6c65 7465 7320 6974  # and deletes it
-0002c3f0: 2e0a 2020 2020 2020 2020 746d 705f 6c6f  ..        tmp_lo
-0002c400: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-0002c410: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0002c420: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
-0002c430: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002c440: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
-0002c450: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
-0002c460: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
-0002c470: 7075 740a 2020 2020 2020 2020 6f75 7420  put.        out 
-0002c480: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002c490: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0002c4a0: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0002c4b0: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-0002c4c0: 7274 2074 6d70 5f6c 6f63 616c 5f73 746f  rt tmp_local_sto
-0002c4d0: 7261 6765 5f6f 626a 2e6e 616d 6520 696e  rage_obj.name in
-0002c4e0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-0002c4f0: 2d38 2729 0a0a 2020 2020 2020 2020 2320  -8')..        # 
-0002c500: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002c510: 6465 6c65 7465 2074 6f20 6465 6c65 7465  delete to delete
-0002c520: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-0002c530: 6563 740a 2020 2020 2020 2020 7375 6270  ect.        subp
-0002c540: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002c550: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
-0002c560: 205b 2773 6b79 272c 2027 7374 6f72 6167   ['sky', 'storag
-0002c570: 6527 2c20 2764 656c 6574 6527 2c20 746d  e', 'delete', tm
-0002c580: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-0002c590: 6f62 6a2e 6e61 6d65 2c20 272d 2d79 6573  obj.name, '--yes
-0002c5a0: 275d 290a 0a20 2020 2020 2020 2023 2052  '])..        # R
-0002c5b0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0002c5c0: 7320 746f 2063 6865 636b 2069 6620 7374  s to check if st
-0002c5d0: 6f72 6167 6520 6f62 6a65 6374 2069 7320  orage object is 
-0002c5e0: 6465 6c65 7465 640a 2020 2020 2020 2020  deleted.        
-0002c5f0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0002c600: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-0002c610: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002c620: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
-0002c630: 6173 7365 7274 2074 6d70 5f6c 6f63 616c  assert tmp_local
-0002c640: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0002c650: 6520 6e6f 7420 696e 206f 7574 2e64 6563  e not in out.dec
-0002c660: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
-0002c670: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
-0002c680: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
-0002c690: 2040 7079 7465 7374 2e6d 6172 6b2e 7864   @pytest.mark.xd
-0002c6a0: 6973 745f 6772 6f75 7028 276d 756c 7469  ist_group('multi
-0002c6b0: 706c 655f 6275 636b 6574 5f64 656c 6574  ple_bucket_delet
-0002c6c0: 696f 6e27 290a 2020 2020 4070 7974 6573  ion').    @pytes
-0002c6d0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0002c6e0: 7a65 2827 7374 6f72 655f 7479 7065 272c  ze('store_type',
-0002c6f0: 205b 0a20 2020 2020 2020 2073 746f 7261   [.        stora
-0002c700: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002c710: 2e53 332c 2073 746f 7261 6765 5f6c 6962  .S3, storage_lib
-0002c720: 2e53 746f 7265 5479 7065 2e47 4353 2c0a  .StoreType.GCS,.
-0002c730: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-0002c740: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
-0002c750: 2e53 746f 7265 5479 7065 2e52 322c 206d  .StoreType.R2, m
-0002c760: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002c770: 2e63 6c6f 7564 666c 6172 6529 2c0a 2020  .cloudflare),.  
-0002c780: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0002c790: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
-0002c7a0: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
-0002c7b0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002c7c0: 6962 6d29 0a20 2020 205d 290a 2020 2020  ibm).    ]).    
-0002c7d0: 6465 6620 7465 7374 5f6d 756c 7469 706c  def test_multipl
-0002c7e0: 655f 6275 636b 6574 735f 6372 6561 7469  e_buckets_creati
-0002c7f0: 6f6e 5f61 6e64 5f64 656c 6574 696f 6e28  on_and_deletion(
-0002c800: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002c810: 662c 2074 6d70 5f6d 756c 7469 706c 655f  f, tmp_multiple_
-0002c820: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-0002c830: 6f62 6a2c 2073 746f 7265 5f74 7970 6529  obj, store_type)
-0002c840: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002c850: 7465 7320 6d75 6c74 6970 6c65 206e 6577  tes multiple new
-0002c860: 2062 7563 6b65 7473 2835 2062 7563 6b65   buckets(5 bucke
-0002c870: 7473 2920 7769 7468 2061 206c 6f63 616c  ts) with a local
-0002c880: 2073 6f75 7263 650a 2020 2020 2020 2020   source.        
-0002c890: 2320 616e 6420 6465 6c65 7465 7320 7468  # and deletes th
-0002c8a0: 656d 2e0a 2020 2020 2020 2020 7374 6f72  em..        stor
-0002c8b0: 6167 655f 6f62 6a5f 6e61 6d65 203d 205b  age_obj_name = [
-0002c8c0: 5d0a 2020 2020 2020 2020 666f 7220 7374  ].        for st
-0002c8d0: 6f72 655f 6f62 6a20 696e 2074 6d70 5f6d  ore_obj in tmp_m
-0002c8e0: 756c 7469 706c 655f 7363 7261 7463 685f  ultiple_scratch_
-0002c8f0: 7374 6f72 6167 655f 6f62 6a3a 0a20 2020  storage_obj:.   
-0002c900: 2020 2020 2020 2020 2073 746f 7265 5f6f           store_o
-0002c910: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0002c920: 7265 5f74 7970 6529 0a20 2020 2020 2020  re_type).       
-0002c930: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002c940: 5f6e 616d 652e 6170 7065 6e64 2873 746f  _name.append(sto
-0002c950: 7265 5f6f 626a 2e6e 616d 6529 0a0a 2020  re_obj.name)..  
-0002c960: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-0002c970: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-0002c980: 6563 6b20 6966 2061 6c6c 2073 746f 7261  eck if all stora
-0002c990: 6765 206f 626a 6563 7473 2065 7869 7374  ge objects exist
-0002c9a0: 7320 696e 2074 6865 0a20 2020 2020 2020  s in the.       
-0002c9b0: 2023 206f 7574 7075 7420 6669 6c74 6572   # output filter
-0002c9c0: 6564 2062 7920 7374 6f72 6520 7479 7065  ed by store type
-0002c9d0: 0a20 2020 2020 2020 206f 7574 5f61 6c6c  .        out_all
-0002c9e0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002c9f0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0002ca00: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0002ca10: 7327 5d29 0a20 2020 2020 2020 206f 7574  s']).        out
-0002ca20: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0002ca30: 2069 7465 6d2e 7370 6c69 7428 295b 305d   item.split()[0]
-0002ca40: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0002ca50: 2069 7465 6d20 696e 206f 7574 5f61 6c6c   item in out_all
-0002ca60: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002ca70: 2e73 706c 6974 6c69 6e65 7328 290a 2020  .splitlines().  
-0002ca80: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
-0002ca90: 7265 5f74 7970 652e 7661 6c75 6520 696e  re_type.value in
-0002caa0: 2069 7465 6d0a 2020 2020 2020 2020 5d0a   item.        ].
-0002cab0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
-0002cac0: 6c6c 285b 6974 656d 2069 6e20 6f75 7420  ll([item in out 
-0002cad0: 666f 7220 6974 656d 2069 6e20 7374 6f72  for item in stor
-0002cae0: 6167 655f 6f62 6a5f 6e61 6d65 5d29 0a0a  age_obj_name])..
-0002caf0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
-0002cb00: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
-0002cb10: 2061 6c6c 2074 6f20 6465 6c65 7465 2061   all to delete a
-0002cb20: 6c6c 2073 746f 7261 6765 206f 626a 6563  ll storage objec
-0002cb30: 7473 0a20 2020 2020 2020 2064 656c 6574  ts.        delet
-0002cb40: 655f 636d 6420 3d20 5b27 736b 7927 2c20  e_cmd = ['sky', 
-0002cb50: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
-0002cb60: 7465 272c 2027 2d2d 7965 7327 5d0a 2020  te', '--yes'].  
-0002cb70: 2020 2020 2020 6465 6c65 7465 5f63 6d64        delete_cmd
-0002cb80: 202b 3d20 7374 6f72 6167 655f 6f62 6a5f   += storage_obj_
-0002cb90: 6e61 6d65 0a20 2020 2020 2020 2073 7562  name.        sub
-0002cba0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002cbb0: 7470 7574 2864 656c 6574 655f 636d 6429  tput(delete_cmd)
-0002cbc0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-0002cbd0: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-0002cbe0: 6f20 6368 6563 6b20 6966 2061 6c6c 2073  o check if all s
-0002cbf0: 746f 7261 6765 206f 626a 6563 7473 2066  torage objects f
-0002cc00: 696c 7465 7265 6420 6279 2073 746f 7265  iltered by store
-0002cc10: 0a20 2020 2020 2020 2023 2074 7970 6520  .        # type 
-0002cc20: 6172 6520 6465 6c65 7465 640a 2020 2020  are deleted.    
-0002cc30: 2020 2020 6f75 745f 616c 6c20 3d20 7375      out_all = su
-0002cc40: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002cc50: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
-0002cc60: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
-0002cc70: 2020 2020 2020 2020 6f75 7420 3d20 5b0a          out = [.
-0002cc80: 2020 2020 2020 2020 2020 2020 6974 656d              item
-0002cc90: 2e73 706c 6974 2829 5b30 5d0a 2020 2020  .split()[0].    
-0002cca0: 2020 2020 2020 2020 666f 7220 6974 656d          for item
-0002ccb0: 2069 6e20 6f75 745f 616c 6c2e 6465 636f   in out_all.deco
-0002ccc0: 6465 2827 7574 662d 3827 292e 7370 6c69  de('utf-8').spli
-0002ccd0: 746c 696e 6573 2829 0a20 2020 2020 2020  tlines().       
-0002cce0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-0002ccf0: 7065 2e76 616c 7565 2069 6e20 6974 656d  pe.value in item
-0002cd00: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
-0002cd10: 2020 2061 7373 6572 7420 616c 6c28 5b69     assert all([i
-0002cd20: 7465 6d20 6e6f 7420 696e 206f 7574 2066  tem not in out f
-0002cd30: 6f72 2069 7465 6d20 696e 2073 746f 7261  or item in stora
-0002cd40: 6765 5f6f 626a 5f6e 616d 655d 290a 0a20  ge_obj_name]).. 
-0002cd50: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002cd60: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-0002cd70: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-0002cd80: 6172 616d 6574 7269 7a65 2827 7374 6f72  arametrize('stor
-0002cd90: 655f 7479 7065 272c 205b 0a20 2020 2020  e_type', [.     
-0002cda0: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-0002cdb0: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
-0002cdc0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002cdd0: 7065 2e47 4353 2c0a 2020 2020 2020 2020  pe.GCS,.        
-0002cde0: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
-0002cdf0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002ce00: 7065 2e49 424d 2c20 6d61 726b 733d 7079  pe.IBM, marks=py
-0002ce10: 7465 7374 2e6d 6172 6b2e 6962 6d29 2c0a  test.mark.ibm),.
-0002ce20: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-0002ce30: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
-0002ce40: 2e53 746f 7265 5479 7065 2e52 322c 206d  .StoreType.R2, m
-0002ce50: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002ce60: 2e63 6c6f 7564 666c 6172 6529 0a20 2020  .cloudflare).   
-0002ce70: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
-0002ce80: 5f75 706c 6f61 645f 736f 7572 6365 5f77  _upload_source_w
-0002ce90: 6974 685f 7370 6163 6573 2873 656c 662c  ith_spaces(self,
-0002cea0: 2073 746f 7265 5f74 7970 652c 0a20 2020   store_type,.   
-0002ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ced0: 2020 2020 746d 705f 6d75 6c74 6970 6c65      tmp_multiple
-0002cee0: 5f63 7573 746f 6d5f 736f 7572 6365 5f73  _custom_source_s
-0002cef0: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
-0002cf00: 2020 2020 2023 2043 7265 6174 6573 2074       # Creates t
-0002cf10: 776f 2062 7563 6b65 7473 2077 6974 6820  wo buckets with 
-0002cf20: 7370 6563 6966 6965 6420 6c6f 6361 6c20  specified local 
-0002cf30: 736f 7572 6365 730a 2020 2020 2020 2020  sources.        
-0002cf40: 2320 7769 7468 2073 7061 6365 7320 696e  # with spaces in
-0002cf50: 2074 6865 206e 616d 650a 2020 2020 2020   the name.      
-0002cf60: 2020 7374 6f72 6167 655f 6f62 6a5f 6e61    storage_obj_na
-0002cf70: 6d65 7320 3d20 5b5d 0a20 2020 2020 2020  mes = [].       
-0002cf80: 2066 6f72 2073 746f 7261 6765 5f6f 626a   for storage_obj
-0002cf90: 2069 6e20 746d 705f 6d75 6c74 6970 6c65   in tmp_multiple
-0002cfa0: 5f63 7573 746f 6d5f 736f 7572 6365 5f73  _custom_source_s
-0002cfb0: 746f 7261 6765 5f6f 626a 3a0a 2020 2020  torage_obj:.    
-0002cfc0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002cfd0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0002cfe0: 6f72 655f 7479 7065 290a 2020 2020 2020  ore_type).      
-0002cff0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002d000: 6a5f 6e61 6d65 732e 6170 7065 6e64 2873  j_names.append(s
-0002d010: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
-0002d020: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-0002d030: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-0002d040: 6f20 6368 6563 6b20 6966 2061 6c6c 2073  o check if all s
-0002d050: 746f 7261 6765 206f 626a 6563 7473 2065  torage objects e
-0002d060: 7869 7374 7320 696e 2074 6865 0a20 2020  xists in the.   
-0002d070: 2020 2020 2023 206f 7574 7075 7420 6669       # output fi
-0002d080: 6c74 6572 6564 2062 7920 7374 6f72 6520  ltered by store 
-0002d090: 7479 7065 0a20 2020 2020 2020 206f 7574  type.        out
-0002d0a0: 5f61 6c6c 203d 2073 7562 7072 6f63 6573  _all = subproces
-0002d0b0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0002d0c0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0002d0d0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0002d0e0: 206f 7574 203d 205b 0a20 2020 2020 2020   out = [.       
-0002d0f0: 2020 2020 2069 7465 6d2e 7370 6c69 7428       item.split(
-0002d100: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-0002d110: 2066 6f72 2069 7465 6d20 696e 206f 7574   for item in out
-0002d120: 5f61 6c6c 2e64 6563 6f64 6528 2775 7466  _all.decode('utf
-0002d130: 2d38 2729 2e73 706c 6974 6c69 6e65 7328  -8').splitlines(
-0002d140: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0002d150: 2073 746f 7265 5f74 7970 652e 7661 6c75   store_type.valu
-0002d160: 6520 696e 2069 7465 6d0a 2020 2020 2020  e in item.      
-0002d170: 2020 5d0a 2020 2020 2020 2020 6173 7365    ].        asse
-0002d180: 7274 2061 6c6c 285b 6974 656d 2069 6e20  rt all([item in 
-0002d190: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
-0002d1a0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
-0002d1b0: 735d 290a 0a20 2020 2040 7079 7465 7374  s])..    @pytest
-0002d1c0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0002d1d0: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-0002d1e0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0002d1f0: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
-0002d200: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002d210: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002d220: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
-0002d230: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
-0002d240: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0002d250: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
-0002d260: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
-0002d270: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002d280: 6962 6d29 2c0a 2020 2020 2020 2020 7079  ibm),.        py
-0002d290: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
-0002d2a0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002d2b0: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
-0002d2c0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-0002d2d0: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
-0002d2e0: 6620 7465 7374 5f62 7563 6b65 745f 6578  f test_bucket_ex
-0002d2f0: 7465 726e 616c 5f64 656c 6574 696f 6e28  ternal_deletion(
-0002d300: 7365 6c66 2c20 746d 705f 7363 7261 7463  self, tmp_scratc
-0002d310: 685f 7374 6f72 6167 655f 6f62 6a2c 0a20  h_storage_obj,. 
-0002d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d340: 2020 2020 2073 746f 7265 5f74 7970 6529       store_type)
-0002d350: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002d360: 7465 7320 6120 6275 636b 6574 2c20 6465  tes a bucket, de
-0002d370: 6c65 7465 7320 6974 2065 7874 6572 6e61  letes it externa
-0002d380: 6c6c 7920 7573 696e 6720 636c 6f75 6420  lly using cloud 
-0002d390: 636c 6920 636f 6d6d 616e 6473 0a20 2020  cli commands.   
-0002d3a0: 2020 2020 2023 2061 6e64 2074 6865 6e20       # and then 
-0002d3b0: 7472 6965 7320 746f 2064 656c 6574 6520  tries to delete 
-0002d3c0: 6974 2075 7369 6e67 2073 6b79 2073 746f  it using sky sto
-0002d3d0: 7261 6765 2064 656c 6574 652e 0a20 2020  rage delete..   
-0002d3e0: 2020 2020 2074 6d70 5f73 6372 6174 6368       tmp_scratch
-0002d3f0: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
-0002d400: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
-0002d410: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
-0002d420: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-0002d430: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
-0002d440: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-0002d450: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
-0002d460: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-0002d470: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002d480: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-0002d490: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-0002d4a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002d4b0: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-0002d4c0: 6167 655f 6f62 6a2e 6e61 6d65 2069 6e20  age_obj.name in 
-0002d4d0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-0002d4e0: 3827 290a 0a20 2020 2020 2020 2023 2044  8')..        # D
-0002d4f0: 656c 6574 6520 6275 636b 6574 2065 7874  elete bucket ext
-0002d500: 6572 6e61 6c6c 790a 2020 2020 2020 2020  ernally.        
-0002d510: 636d 6420 3d20 7365 6c66 2e63 6c69 5f64  cmd = self.cli_d
-0002d520: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
-0002d530: 7479 7065 2c20 746d 705f 7363 7261 7463  type, tmp_scratc
-0002d540: 685f 7374 6f72 6167 655f 6f62 6a2e 6e61  h_storage_obj.na
-0002d550: 6d65 290a 2020 2020 2020 2020 7375 6270  me).        subp
-0002d560: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0002d570: 7075 7428 636d 642c 2073 6865 6c6c 3d54  put(cmd, shell=T
-0002d580: 7275 6529 0a0a 2020 2020 2020 2020 2320  rue)..        # 
-0002d590: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002d5a0: 6465 6c65 7465 2074 6f20 6465 6c65 7465  delete to delete
-0002d5b0: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-0002d5c0: 6563 740a 2020 2020 2020 2020 6f75 7420  ect.        out 
-0002d5d0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0002d5e0: 636b 5f6f 7574 7075 7428 0a20 2020 2020  ck_output(.     
-0002d5f0: 2020 2020 2020 205b 2773 6b79 272c 2027         ['sky', '
-0002d600: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
-0002d610: 6527 2c20 746d 705f 7363 7261 7463 685f  e', tmp_scratch_
-0002d620: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002d630: 2c20 272d 2d79 6573 275d 290a 2020 2020  , '--yes']).    
-0002d640: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-0002d650: 6275 636b 6574 2077 6173 206e 6f74 2063  bucket was not c
-0002d660: 7265 6174 6564 2064 7572 696e 6720 6465  reated during de
-0002d670: 6c65 7469 6f6e 2028 7365 6520 6973 7375  letion (see issu
-0002d680: 6520 2331 3332 3229 0a20 2020 2020 2020  e #1322).       
-0002d690: 2061 7373 6572 7420 2763 7265 6174 6564   assert 'created
-0002d6a0: 2720 6e6f 7420 696e 206f 7574 2e64 6563  ' not in out.dec
-0002d6b0: 6f64 6528 2775 7466 2d38 2729 2e6c 6f77  ode('utf-8').low
-0002d6c0: 6572 2829 0a0a 2020 2020 2020 2020 2320  er()..        # 
-0002d6d0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002d6e0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-0002d6f0: 746f 7261 6765 206f 626a 6563 7420 6973  torage object is
-0002d700: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
-0002d710: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-0002d720: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0002d730: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0002d740: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0002d750: 2061 7373 6572 7420 746d 705f 7363 7261   assert tmp_scra
-0002d760: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
-0002d770: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-0002d780: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0002d790: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002d7a0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-0002d7b0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002d7c0: 2e70 6172 616d 6574 7269 7a65 2827 7374  .parametrize('st
-0002d7d0: 6f72 655f 7479 7065 272c 205b 0a20 2020  ore_type', [.   
-0002d7e0: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-0002d7f0: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
-0002d800: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002d810: 5479 7065 2e47 4353 2c0a 2020 2020 2020  Type.GCS,.      
-0002d820: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
-0002d830: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002d840: 5479 7065 2e49 424d 2c20 6d61 726b 733d  Type.IBM, marks=
-0002d850: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-0002d860: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-0002d870: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-0002d880: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-0002d890: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002d8a0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
-0002d8b0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
-0002d8c0: 7374 5f62 7563 6b65 745f 6275 6c6b 5f64  st_bucket_bulk_d
-0002d8d0: 656c 6574 696f 6e28 7365 6c66 2c20 7374  eletion(self, st
-0002d8e0: 6f72 655f 7479 7065 2c20 746d 705f 6275  ore_type, tmp_bu
-0002d8f0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
-0002d900: 626a 293a 0a20 2020 2020 2020 2023 2043  bj):.        # C
-0002d910: 7265 6174 6573 2061 2074 656d 7020 666f  reates a temp fo
-0002d920: 6c64 6572 2077 6974 6820 6f76 6572 2032  lder with over 2
-0002d930: 3536 2066 696c 6573 2061 6e64 2066 6f6c  56 files and fol
-0002d940: 6465 7273 2c20 7570 6c6f 6164 0a20 2020  ders, upload.   
-0002d950: 2020 2020 2023 2066 696c 6573 2061 6e64       # files and
-0002d960: 2066 6f6c 6465 7273 2074 6f20 6120 6e65   folders to a ne
-0002d970: 7720 6275 636b 6574 2c20 7468 656e 2064  w bucket, then d
-0002d980: 656c 6574 6520 6275 636b 6574 2e0a 2020  elete bucket..  
-0002d990: 2020 2020 2020 746d 705f 6275 6c6b 5f64        tmp_bulk_d
-0002d9a0: 656c 5f73 746f 7261 6765 5f6f 626a 2e61  el_storage_obj.a
-0002d9b0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0002d9c0: 7970 6529 0a0a 2020 2020 2020 2020 7375  ype)..        su
-0002d9d0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002d9e0: 7574 7075 7428 5b0a 2020 2020 2020 2020  utput([.        
-0002d9f0: 2020 2020 2773 6b79 272c 2027 7374 6f72      'sky', 'stor
-0002da00: 6167 6527 2c20 2764 656c 6574 6527 2c20  age', 'delete', 
-0002da10: 746d 705f 6275 6c6b 5f64 656c 5f73 746f  tmp_bulk_del_sto
-0002da20: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
-0002da30: 2d2d 7965 7327 0a20 2020 2020 2020 205d  --yes'.        ]
-0002da40: 290a 0a20 2020 2020 2020 206f 7574 7075  )..        outpu
-0002da50: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-0002da60: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
-0002da70: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-0002da80: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
-0002da90: 7365 7274 2074 6d70 5f62 756c 6b5f 6465  sert tmp_bulk_de
-0002daa0: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
-0002dab0: 6d65 206e 6f74 2069 6e20 6f75 7470 7574  me not in output
-0002dac0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002dad0: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002dae0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002daf0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002db00: 6b2e 7061 7261 6d65 7472 697a 6528 0a20  k.parametrize(. 
-0002db10: 2020 2020 2020 2027 746d 705f 7075 626c         'tmp_publ
-0002db20: 6963 5f73 746f 7261 6765 5f6f 626a 2c20  ic_storage_obj, 
-0002db30: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
-0002db40: 2020 2020 205b 2827 7333 3a2f 2f74 6367       [('s3://tcg
-0002db50: 612d 322d 6f70 656e 272c 2073 746f 7261  a-2-open', stora
-0002db60: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002db70: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
-0002db80: 2773 333a 2f2f 6469 6769 7461 6c63 6f72  's3://digitalcor
-0002db90: 706f 7261 272c 2073 746f 7261 6765 5f6c  pora', storage_l
-0002dba0: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-0002dbb0: 2c0a 2020 2020 2020 2020 2028 2767 733a  ,.         ('gs:
-0002dbc0: 2f2f 6763 702d 7075 626c 6963 2d64 6174  //gcp-public-dat
-0002dbd0: 612d 7365 6e74 696e 656c 2d32 272c 2073  a-sentinel-2', s
-0002dbe0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002dbf0: 5479 7065 2e47 4353 295d 2c0a 2020 2020  Type.GCS)],.    
-0002dc00: 2020 2020 696e 6469 7265 6374 3d5b 2774      indirect=['t
-0002dc10: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
-0002dc20: 655f 6f62 6a27 5d29 0a20 2020 2064 6566  e_obj']).    def
-0002dc30: 2074 6573 745f 7075 626c 6963 5f62 7563   test_public_buc
-0002dc40: 6b65 7428 7365 6c66 2c20 746d 705f 7075  ket(self, tmp_pu
-0002dc50: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0002dc60: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
-0002dc70: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002dc80: 2061 206e 6577 2062 7563 6b65 7420 7769   a new bucket wi
-0002dc90: 7468 2061 2070 7562 6c69 6320 736f 7572  th a public sour
-0002dca0: 6365 2061 6e64 2076 6572 6966 6965 7320  ce and verifies 
-0002dcb0: 7468 6174 2069 7420 6973 206e 6f74 0a20  that it is not. 
-0002dcc0: 2020 2020 2020 2023 2061 6464 6564 2074         # added t
-0002dcd0: 6f20 676c 6f62 616c 5f75 7365 725f 7374  o global_user_st
-0002dce0: 6174 652e 0a20 2020 2020 2020 2074 6d70  ate..        tmp
-0002dcf0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
-0002dd00: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0002dd10: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
-0002dd20: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
-0002dd30: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
-0002dd40: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
-0002dd50: 6374 2065 7869 7374 7320 696e 2074 6865  ct exists in the
-0002dd60: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0002dd70: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-0002dd80: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-0002dd90: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0002dda0: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
-0002ddb0: 6173 7365 7274 2074 6d70 5f70 7562 6c69  assert tmp_publi
-0002ddc0: 635f 7374 6f72 6167 655f 6f62 6a2e 6e61  c_storage_obj.na
-0002ddd0: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
-0002dde0: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
-0002ddf0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002de00: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-0002de10: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-0002de20: 6172 616d 6574 7269 7a65 2827 6e6f 6e65  arametrize('none
-0002de30: 7869 7374 5f62 7563 6b65 745f 7572 6c27  xist_bucket_url'
-0002de40: 2c20 5b0a 2020 2020 2020 2020 2773 333a  , [.        's3:
-0002de50: 2f2f 7b72 616e 646f 6d5f 6e61 6d65 7d27  //{random_name}'
-0002de60: 2c20 2767 733a 2f2f 7b72 616e 646f 6d5f  , 'gs://{random_
-0002de70: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0002de80: 7079 7465 7374 2e70 6172 616d 2827 636f  pytest.param('co
-0002de90: 733a 2f2f 7573 2d65 6173 742f 7b72 616e  s://us-east/{ran
-0002dea0: 646f 6d5f 6e61 6d65 7d27 2c20 6d61 726b  dom_name}', mark
-0002deb0: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
-0002dec0: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
-0002ded0: 7374 2e70 6172 616d 2827 7232 3a2f 2f7b  st.param('r2://{
-0002dee0: 7261 6e64 6f6d 5f6e 616d 657d 272c 206d  random_name}', m
-0002def0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002df00: 2e63 6c6f 7564 666c 6172 6529 0a20 2020  .cloudflare).   
-0002df10: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
-0002df20: 5f6e 6f6e 6578 6973 7465 6e74 5f62 7563  _nonexistent_buc
-0002df30: 6b65 7428 7365 6c66 2c20 6e6f 6e65 7869  ket(self, nonexi
-0002df40: 7374 5f62 7563 6b65 745f 7572 6c29 3a0a  st_bucket_url):.
-0002df50: 2020 2020 2020 2020 2320 4174 7465 6d70          # Attemp
-0002df60: 7473 2074 6f20 6372 6561 7465 2066 6574  ts to create fet
-0002df70: 6368 2061 2073 7472 6f61 6765 2077 6974  ch a stroage wit
-0002df80: 6820 6120 6e6f 6e2d 6578 6973 7465 6e74  h a non-existent
-0002df90: 2073 6f75 7263 652e 0a20 2020 2020 2020   source..       
-0002dfa0: 2023 2047 656e 6572 6174 6520 6120 7261   # Generate a ra
-0002dfb0: 6e64 6f6d 2062 7563 6b65 7420 6e61 6d65  ndom bucket name
-0002dfc0: 2061 6e64 2076 6572 6966 7920 6974 2064   and verify it d
-0002dfd0: 6f65 736e 2774 2065 7869 7374 3a0a 2020  oesn't exist:.  
-0002dfe0: 2020 2020 2020 7265 7472 795f 636f 756e        retry_coun
-0002dff0: 7420 3d20 300a 2020 2020 2020 2020 7768  t = 0.        wh
-0002e000: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
-0002e010: 2020 2020 2020 6e6f 6e65 7869 7374 5f62        nonexist_b
-0002e020: 7563 6b65 745f 6e61 6d65 203d 2073 7472  ucket_name = str
-0002e030: 2875 7569 642e 7575 6964 3428 2929 0a20  (uuid.uuid4()). 
-0002e040: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0002e050: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-0002e060: 6c2e 7374 6172 7473 7769 7468 2827 7333  l.startswith('s3
-0002e070: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-0002e080: 2020 2020 636f 6d6d 616e 6420 3d20 6627      command = f'
-0002e090: 6177 7320 7333 6170 6920 6865 6164 2d62  aws s3api head-b
-0002e0a0: 7563 6b65 7420 2d2d 6275 636b 6574 207b  ucket --bucket {
-0002e0b0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002e0c0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
-0002e0d0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-0002e0e0: 6f75 7470 7574 203d 2027 3430 3427 0a20  output = '404'. 
-0002e0f0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0002e100: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002e110: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
-0002e120: 6773 2729 3a0a 2020 2020 2020 2020 2020  gs'):.          
-0002e130: 2020 2020 2020 636f 6d6d 616e 6420 3d20        command = 
-0002e140: 6627 6773 7574 696c 206c 7320 7b6e 6f6e  f'gsutil ls {non
-0002e150: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0002e160: 2e66 6f72 6d61 7428 7261 6e64 6f6d 5f6e  .format(random_n
-0002e170: 616d 653d 6e6f 6e65 7869 7374 5f62 7563  ame=nonexist_buc
-0002e180: 6b65 745f 6e61 6d65 297d 270a 2020 2020  ket_name)}'.    
-0002e190: 2020 2020 2020 2020 2020 2020 6578 7065              expe
-0002e1a0: 6374 6564 5f6f 7574 7075 7420 3d20 2742  cted_output = 'B
-0002e1b0: 7563 6b65 744e 6f74 466f 756e 6445 7863  ucketNotFoundExc
-0002e1c0: 6570 7469 6f6e 270a 2020 2020 2020 2020  eption'.        
-0002e1d0: 2020 2020 656c 6966 206e 6f6e 6578 6973      elif nonexis
-0002e1e0: 745f 6275 636b 6574 5f75 726c 2e73 7461  t_bucket_url.sta
-0002e1f0: 7274 7377 6974 6828 2772 3227 293a 0a20  rtswith('r2'):. 
-0002e200: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002e210: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
-0002e220: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
-0002e230: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
-0002e240: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
-0002e250: 6e64 203d 2066 2741 5753 5f53 4841 5245  nd = f'AWS_SHARE
-0002e260: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-0002e270: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-0002e280: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-0002e290: 5448 7d20 6177 7320 7333 6170 6920 6865  TH} aws s3api he
-0002e2a0: 6164 2d62 7563 6b65 7420 2d2d 6275 636b  ad-bucket --buck
-0002e2b0: 6574 207b 6e6f 6e65 7869 7374 5f62 7563  et {nonexist_buc
-0002e2c0: 6b65 745f 6e61 6d65 7d20 2d2d 656e 6470  ket_name} --endp
-0002e2d0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-0002e2e0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-0002e2f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002e300: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
-0002e310: 7420 3d20 2734 3034 270a 2020 2020 2020  t = '404'.      
-0002e320: 2020 2020 2020 656c 6966 206e 6f6e 6578        elif nonex
-0002e330: 6973 745f 6275 636b 6574 5f75 726c 2e73  ist_bucket_url.s
-0002e340: 7461 7274 7377 6974 6828 2763 6f73 2729  tartswith('cos')
-0002e350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e360: 2020 2320 5573 696e 6720 4150 4920 6361    # Using API ca
-0002e370: 6c6c 732c 2073 696e 6365 2075 7369 6e67  lls, since using
-0002e380: 2072 636c 6f6e 6520 7265 7175 6972 6573   rclone requires
-0002e390: 2061 2070 726f 6669 6c65 2773 206e 616d   a profile's nam
-0002e3a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0002e3b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0002e3c0: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-0002e3d0: 7465 645f 6f75 7470 7574 203d 2063 6f6d  ted_output = com
-0002e3e0: 6d61 6e64 203d 2022 6563 686f 2220 2023  mand = "echo"  #
-0002e3f0: 2061 766f 6964 2075 6e72 656c 6174 6564   avoid unrelated
-0002e400: 2065 7863 6570 7469 6f6e 2069 6e20 6361   exception in ca
-0002e410: 7365 206f 6620 6661 696c 7572 652e 0a20  se of failure.. 
-0002e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e430: 2020 2062 7563 6b65 745f 6e61 6d65 203d     bucket_name =
-0002e440: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
-0002e450: 6c73 706c 6974 280a 2020 2020 2020 2020  lsplit(.        
-0002e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e470: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0002e480: 7572 6c2e 666f 726d 6174 280a 2020 2020  url.format(.    
-0002e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4a0: 2020 2020 2020 2020 7261 6e64 6f6d 5f6e          random_n
-0002e4b0: 616d 653d 6e6f 6e65 7869 7374 5f62 7563  ame=nonexist_buc
-0002e4c0: 6b65 745f 6e61 6d65 2929 2e70 6174 682e  ket_name)).path.
-0002e4d0: 7374 7269 7028 272f 2729 0a20 2020 2020  strip('/').     
-0002e4e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002e4f0: 6c69 656e 7420 3d20 6962 6d2e 6765 745f  lient = ibm.get_
-0002e500: 636f 735f 636c 6965 6e74 2827 7573 2d65  cos_client('us-e
-0002e510: 6173 7427 290a 2020 2020 2020 2020 2020  ast').          
-0002e520: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-0002e530: 2e68 6561 645f 6275 636b 6574 2842 7563  .head_bucket(Buc
-0002e540: 6b65 743d 6275 636b 6574 5f6e 616d 6529  ket=bucket_name)
-0002e550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e560: 2065 7863 6570 7420 6962 6d2e 6962 6d5f   except ibm.ibm_
-0002e570: 626f 746f 636f 7265 2e65 7863 6570 7469  botocore.excepti
-0002e580: 6f6e 732e 436c 6965 6e74 4572 726f 7220  ons.ClientError 
-0002e590: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0002e5a0: 2020 2020 2020 2020 2020 6966 2065 2e72            if e.r
-0002e5b0: 6573 706f 6e73 655b 2745 7272 6f72 275d  esponse['Error']
-0002e5c0: 5b27 436f 6465 275d 203d 3d20 2734 3034  ['Code'] == '404
-0002e5d0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-0002e5e0: 2020 2020 2020 2020 2020 2023 2073 7563             # suc
-0002e5f0: 6365 7373 0a20 2020 2020 2020 2020 2020  cess.           
-0002e600: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0002e610: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-0002e620: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002e630: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-0002e640: 6545 7272 6f72 2827 556e 7375 7070 6f72  eError('Unsuppor
-0002e650: 7465 6420 6275 636b 6574 2074 7970 6520  ted bucket type 
-0002e660: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e680: 2020 2066 277b 6e6f 6e65 7869 7374 5f62     f'{nonexist_b
-0002e690: 7563 6b65 745f 7572 6c7d 2729 0a0a 2020  ucket_url}')..  
-0002e6a0: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
-0002e6b0: 6b20 6966 2062 7563 6b65 7420 6578 6973  k if bucket exis
-0002e6c0: 7473 2075 7369 6e67 2074 6865 2063 6c69  ts using the cli
-0002e6d0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-0002e6e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0002e6f0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0002e700: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0002e710: 2863 6f6d 6d61 6e64 2c0a 2020 2020 2020  (command,.      
-0002e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e740: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
-0002e750: 7562 7072 6f63 6573 732e 5354 444f 5554  ubprocess.STDOUT
-0002e760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e790: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-0002e7a0: 2020 2020 2020 2020 6578 6365 7074 2073          except s
-0002e7b0: 7562 7072 6f63 6573 732e 4361 6c6c 6564  ubprocess.Called
-0002e7c0: 5072 6f63 6573 7345 7272 6f72 2061 7320  ProcessError as 
-0002e7d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002e7e0: 2020 206f 7574 203d 2065 2e6f 7574 7075     out = e.outpu
-0002e7f0: 740a 2020 2020 2020 2020 2020 2020 6f75  t.            ou
-0002e800: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
-0002e810: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
-0002e820: 2020 2020 6966 2065 7870 6563 7465 645f      if expected_
-0002e830: 6f75 7470 7574 2069 6e20 6f75 743a 0a20  output in out:. 
-0002e840: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0002e850: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
-0002e860: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002e870: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
-0002e880: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-0002e890: 2020 2020 2020 2020 6966 2072 6574 7279          if retry
-0002e8a0: 5f63 6f75 6e74 203e 2033 3a0a 2020 2020  _count > 3:.    
-0002e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e8c0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-0002e8d0: 6f72 2827 556e 6162 6c65 2074 6f20 6669  or('Unable to fi
-0002e8e0: 6e64 2061 206e 6f6e 6578 6973 7465 6e74  nd a nonexistent
-0002e8f0: 2062 7563 6b65 7420 270a 2020 2020 2020   bucket '.      
-0002e900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e920: 2027 746f 2075 7365 2e20 5468 6973 2069   'to use. This i
-0002e930: 7320 6869 676c 7920 756e 6c69 6b65 6c79  s higly unlikely
-0002e940: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
-0002e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e960: 2020 2020 2020 2020 2020 2020 2763 6865              'che
-0002e970: 636b 2069 6620 7468 6520 7465 7374 7320  ck if the tests 
-0002e980: 6172 6520 636f 7272 6563 742e 2729 0a0a  are correct.')..
-0002e990: 2020 2020 2020 2020 7769 7468 2070 7974          with pyt
-0002e9a0: 6573 742e 7261 6973 6573 280a 2020 2020  est.raises(.    
-0002e9b0: 2020 2020 2020 2020 2020 2020 736b 792e              sky.
-0002e9c0: 6578 6365 7074 696f 6e73 2e53 746f 7261  exceptions.Stora
-0002e9d0: 6765 4275 636b 6574 4765 7445 7272 6f72  geBucketGetError
-0002e9e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e9f0: 2020 6d61 7463 683d 2741 7474 656d 7074    match='Attempt
-0002ea00: 6564 2074 6f20 7573 6520 6120 6e6f 6e2d  ed to use a non-
-0002ea10: 6578 6973 7465 6e74 2062 7563 6b65 7420  existent bucket 
-0002ea20: 6173 2061 2073 6f75 7263 6527 293a 0a20  as a source'):. 
-0002ea30: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002ea40: 6765 5f6f 626a 203d 2073 746f 7261 6765  ge_obj = storage
-0002ea50: 5f6c 6962 2e53 746f 7261 6765 2873 6f75  _lib.Storage(sou
-0002ea60: 7263 653d 6e6f 6e65 7869 7374 5f62 7563  rce=nonexist_buc
-0002ea70: 6b65 745f 7572 6c2e 666f 726d 6174 280a  ket_url.format(.
-0002ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea90: 7261 6e64 6f6d 5f6e 616d 653d 6e6f 6e65  random_name=none
-0002eaa0: 7869 7374 5f62 7563 6b65 745f 6e61 6d65  xist_bucket_name
-0002eab0: 2929 0a0a 2020 2020 4070 7974 6573 742e  ))..    @pytest.
-0002eac0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-0002ead0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-0002eae0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0002eaf0: 2770 7269 7661 7465 5f62 7563 6b65 7427  'private_bucket'
-0002eb00: 2c20 5b0a 2020 2020 2020 2020 6627 7333  , [.        f's3
-0002eb10: 3a2f 2f69 6d61 6765 6e65 7427 2c20 6627  ://imagenet', f'
-0002eb20: 6773 3a2f 2f69 6d61 6765 6e65 7427 2c0a  gs://imagenet',.
-0002eb30: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-0002eb40: 6172 616d 2827 636f 733a 2f2f 7573 2d65  aram('cos://us-e
-0002eb50: 6173 742f 6275 636b 6574 3127 2c20 6d61  ast/bucket1', ma
-0002eb60: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-0002eb70: 6962 6d29 0a20 2020 205d 290a 2020 2020  ibm).    ]).    
-0002eb80: 6465 6620 7465 7374 5f70 7269 7661 7465  def test_private
-0002eb90: 5f62 7563 6b65 7428 7365 6c66 2c20 7072  _bucket(self, pr
-0002eba0: 6976 6174 655f 6275 636b 6574 293a 0a20  ivate_bucket):. 
-0002ebb0: 2020 2020 2020 2023 2041 7474 656d 7074         # Attempt
-0002ebc0: 7320 746f 2061 6363 6573 7320 7072 6976  s to access priv
-0002ebd0: 6174 6520 6275 636b 6574 7320 6e6f 7420  ate buckets not 
-0002ebe0: 6265 6c6f 6e67 696e 6720 746f 2074 6865  belonging to the
-0002ebf0: 2075 7365 722e 0a20 2020 2020 2020 2023   user..        #
-0002ec00: 2054 6865 7365 2062 7563 6b65 7473 2061   These buckets a
-0002ec10: 7265 206b 6e6f 776e 2074 6f20 6265 2070  re known to be p
-0002ec20: 7269 7661 7465 2c20 6275 7420 6d61 7920  rivate, but may 
-0002ec30: 6e65 6564 2074 6f20 6265 2075 7064 6174  need to be updat
-0002ec40: 6564 2069 660a 2020 2020 2020 2020 2320  ed if.        # 
-0002ec50: 7468 6579 2061 7265 2072 656d 6f76 6564  they are removed
-0002ec60: 2062 7920 7468 6569 7220 6f77 6e65 7273   by their owners
-0002ec70: 2e0a 2020 2020 2020 2020 7072 6976 6174  ..        privat
-0002ec80: 655f 6275 636b 6574 5f6e 616d 6520 3d20  e_bucket_name = 
-0002ec90: 7572 6c6c 6962 2e70 6172 7365 2e75 726c  urllib.parse.url
-0002eca0: 7370 6c69 7428 7072 6976 6174 655f 6275  split(private_bu
-0002ecb0: 636b 6574 292e 6e65 746c 6f63 2069 6620  cket).netloc if 
-0002ecc0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-0002ecd0: 7572 6c6c 6962 2e70 6172 7365 2e75 726c  urllib.parse.url
-0002ece0: 7370 6c69 7428 7072 6976 6174 655f 6275  split(private_bu
-0002ecf0: 636b 6574 292e 7363 6865 6d65 2021 3d20  cket).scheme != 
-0002ed00: 2763 6f73 2720 656c 7365 205c 0a20 2020  'cos' else \.   
-0002ed10: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0002ed20: 726c 6c69 622e 7061 7273 652e 7572 6c73  rllib.parse.urls
-0002ed30: 706c 6974 2870 7269 7661 7465 5f62 7563  plit(private_buc
-0002ed40: 6b65 7429 2e70 6174 682e 7374 7269 7028  ket).path.strip(
-0002ed50: 272f 2729 0a20 2020 2020 2020 2077 6974  '/').        wit
-0002ed60: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
-0002ed70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ed80: 2073 6b79 2e65 7863 6570 7469 6f6e 732e   sky.exceptions.
-0002ed90: 5374 6f72 6167 6542 7563 6b65 7447 6574  StorageBucketGet
-0002eda0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-0002edb0: 2020 2020 2020 206d 6174 6368 3d73 746f         match=sto
-0002edc0: 7261 6765 5f6c 6962 2e5f 4255 434b 4554  rage_lib._BUCKET
-0002edd0: 5f46 4149 4c5f 544f 5f43 4f4e 4e45 4354  _FAIL_TO_CONNECT
-0002ede0: 5f4d 4553 5341 4745 2e66 6f72 6d61 7428  _MESSAGE.format(
-0002edf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ee00: 2020 2020 206e 616d 653d 7072 6976 6174       name=privat
-0002ee10: 655f 6275 636b 6574 5f6e 616d 6529 293a  e_bucket_name)):
-0002ee20: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002ee30: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-0002ee40: 6765 5f6c 6962 2e53 746f 7261 6765 2873  ge_lib.Storage(s
-0002ee50: 6f75 7263 653d 7072 6976 6174 655f 6275  ource=private_bu
-0002ee60: 636b 6574 290a 0a20 2020 2040 7079 7465  cket)..    @pyte
-0002ee70: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0002ee80: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
-0002ee90: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0002eea0: 7a65 2827 6578 745f 6275 636b 6574 5f66  ze('ext_bucket_f
-0002eeb0: 6978 7475 7265 2c20 7374 6f72 655f 7479  ixture, store_ty
-0002eec0: 7065 272c 0a20 2020 2020 2020 2020 2020  pe',.           
-0002eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eee0: 2020 5b28 2774 6d70 5f61 7773 636c 695f    [('tmp_awscli_
-0002eef0: 6275 636b 6574 272c 2073 746f 7261 6765  bucket', storage
-0002ef00: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0002ef10: 3329 2c0a 2020 2020 2020 2020 2020 2020  3),.            
-0002ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef30: 2020 2827 746d 705f 6773 7574 696c 5f62    ('tmp_gsutil_b
-0002ef40: 7563 6b65 7427 2c20 7374 6f72 6167 655f  ucket', storage_
-0002ef50: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
-0002ef60: 5329 2c0a 2020 2020 2020 2020 2020 2020  S),.            
-0002ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef80: 2020 7079 7465 7374 2e70 6172 616d 2827    pytest.param('
-0002ef90: 746d 705f 6962 6d5f 636f 735f 6275 636b  tmp_ibm_cos_buck
-0002efa0: 6574 272c 0a20 2020 2020 2020 2020 2020  et',.           
-0002efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002efd0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002efe0: 6554 7970 652e 4942 4d2c 0a20 2020 2020  eType.IBM,.     
-0002eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f010: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
-0002f020: 7374 2e6d 6172 6b2e 6962 6d29 2c0a 2020  st.mark.ibm),.  
-0002f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f040: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
-0002f050: 7374 2e70 6172 616d 2827 746d 705f 6177  st.param('tmp_aw
-0002f060: 7363 6c69 5f62 7563 6b65 745f 7232 272c  scli_bucket_r2',
-0002f070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f090: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002f0a0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002f0b0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
-0002f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0e0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0002f0f0: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
-0002f100: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
-0002f110: 6c6f 6164 5f74 6f5f 6578 6973 7469 6e67  load_to_existing
-0002f120: 5f62 7563 6b65 7428 7365 6c66 2c20 6578  _bucket(self, ex
-0002f130: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
-0002f140: 2c20 7265 7175 6573 742c 0a20 2020 2020  , request,.     
-0002f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f170: 2020 746d 705f 736f 7572 6365 2c20 7374    tmp_source, st
-0002f180: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-0002f190: 2020 2023 2054 7269 6573 2075 706c 6f61     # Tries uploa
-0002f1a0: 6469 6e67 2065 7869 7374 696e 6720 6669  ding existing fi
-0002f1b0: 6c65 7320 746f 206e 6577 6c79 2063 7265  les to newly cre
-0002f1c0: 6174 6564 2062 7563 6b65 7420 286f 7574  ated bucket (out
-0002f1d0: 7369 6465 206f 660a 2020 2020 2020 2020  side of.        
-0002f1e0: 2320 736b 7929 2061 6e64 2076 6572 6966  # sky) and verif
-0002f1f0: 6965 7320 7468 6174 2066 696c 6573 2061  ies that files a
-0002f200: 7265 2077 7269 7474 656e 2e0a 2020 2020  re written..    
-0002f210: 2020 2020 6275 636b 6574 5f6e 616d 652c      bucket_name,
-0002f220: 205f 203d 2072 6571 7565 7374 2e67 6574   _ = request.get
-0002f230: 6669 7874 7572 6576 616c 7565 2865 7874  fixturevalue(ext
-0002f240: 5f62 7563 6b65 745f 6669 7874 7572 6529  _bucket_fixture)
-0002f250: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002f260: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-0002f270: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
-0002f280: 6275 636b 6574 5f6e 616d 652c 2073 6f75  bucket_name, sou
-0002f290: 7263 653d 746d 705f 736f 7572 6365 290a  rce=tmp_source).
-0002f2a0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002f2b0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0002f2c0: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
-0002f2d0: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
-0002f2e0: 705f 736f 7572 6365 2f74 6d70 2d66 696c  p_source/tmp-fil
-0002f2f0: 6520 6578 6973 7473 2069 6e20 7468 6520  e exists in the 
-0002f300: 6275 636b 6574 2075 7369 6e67 2061 7773  bucket using aws
-0002f310: 2063 6c69 0a20 2020 2020 2020 206f 7574   cli.        out
-0002f320: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002f330: 6563 6b5f 6f75 7470 7574 2873 656c 662e  eck_output(self.
-0002f340: 636c 695f 6c73 5f63 6d64 2873 746f 7265  cli_ls_cmd(store
-0002f350: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
-0002f360: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
-0002f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f380: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-0002f390: 3d54 7275 6529 0a20 2020 2020 2020 2061  =True).        a
-0002f3a0: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
-0002f3b0: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
-0002f3c0: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
-0002f3d0: 2020 2020 2020 2027 4669 6c65 206e 6f74         'File not
-0002f3e0: 2066 6f75 6e64 2069 6e20 6275 636b 6574   found in bucket
-0002f3f0: 202d 206f 7574 7075 7420 7761 7320 3a20   - output was : 
-0002f400: 7b7d 272e 666f 726d 6174 286f 7574 2e64  {}'.format(out.d
-0002f410: 6563 6f64 650a 2020 2020 2020 2020 2020  ecode.          
-0002f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a000: 2020 2020 736f 7572 6365 3d73 6f75 7263      source=sourc
+0002a010: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a030: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+0002a040: 7265 733d 7374 6f72 6573 2c0a 2020 2020  res=stores,.    
+0002a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a070: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
+0002a080: 3d70 6572 7369 7374 656e 742c 0a20 2020  =persistent,.   
+0002a090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a0b0: 2020 2020 2020 206d 6f64 653d 6d6f 6465         mode=mode
+0002a0c0: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002a0d0: 7374 6f72 6167 655f 6f62 6a0a 2020 2020  storage_obj.    
+0002a0e0: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
+0002a0f0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+0002a100: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
+0002a110: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
+0002a120: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0002a130: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
+0002a140: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
+0002a150: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
+0002a160: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
+0002a170: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
+0002a180: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+0002a190: 2872 6f6d 696c 6229 3a20 5468 6973 2069  (romilb): This i
+0002a1a0: 7320 706f 7465 6e74 6961 6c6c 7920 7269  s potentially ri
+0002a1b0: 736b 7920 2d20 6966 2074 6865 2064 656c  sky - if the del
+0002a1c0: 6574 6520 6d65 7468 6f64 2068 6173 0a20  ete method has. 
+0002a1d0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
+0002a1e0: 7567 732c 2074 6869 7320 6361 6e20 6361  ugs, this can ca
+0002a1f0: 7573 6520 7265 736f 7572 6365 206c 6561  use resource lea
+0002a200: 6b73 2e20 4964 6561 6c6c 7920 7765 2073  ks. Ideally we s
+0002a210: 686f 756c 6420 6d61 6e75 616c 6c79 0a20  hould manually. 
+0002a220: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
+0002a230: 6a65 6374 2073 746f 7261 6765 2066 726f  ject storage fro
+0002a240: 6d20 676c 6f62 616c 5f75 7365 725f 7374  m global_user_st
+0002a250: 6174 6520 616e 6420 6465 6c65 7465 2074  ate and delete t
+0002a260: 6865 2062 7563 6b65 7420 7573 696e 670a  he bucket using.
+0002a270: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002a280: 626f 746f 3320 6469 7265 6374 6c79 2e0a  boto3 directly..
+0002a290: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002a2a0: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
+0002a2b0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002a2c0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002a2d0: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0002a2e0: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0002a2f0: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0002a300: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002a310: 6120 7374 6f72 6167 6520 6f62 6a65 6374  a storage object
+0002a320: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
+0002a330: 746f 2063 7265 6174 6520 6120 7363 7261  to create a scra
+0002a340: 7463 6820 7374 6f72 6167 652e 0a20 2020  tch storage..   
+0002a350: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
+0002a360: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
+0002a370: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
+0002a380: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0002a390: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
+0002a3a0: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
+0002a3b0: 7563 6b65 745f 6e61 6d65 290a 0a20 2020  ucket_name)..   
+0002a3c0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002a3d0: 0a20 2020 2064 6566 2074 6d70 5f6d 756c  .    def tmp_mul
+0002a3e0: 7469 706c 655f 7363 7261 7463 685f 7374  tiple_scratch_st
+0002a3f0: 6f72 6167 655f 6f62 6a28 7365 6c66 293a  orage_obj(self):
+0002a400: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002a410: 6573 2061 206c 6973 7420 6f66 2035 2073  es a list of 5 s
+0002a420: 746f 7261 6765 206f 626a 6563 7473 2077  torage objects w
+0002a430: 6974 6820 6e6f 2073 6f75 7263 6520 746f  ith no source to
+0002a440: 2063 7265 6174 650a 2020 2020 2020 2020   create.        
+0002a450: 2320 6d75 6c74 6970 6c65 2073 6372 6174  # multiple scrat
+0002a460: 6368 2073 746f 7261 6765 732e 0a20 2020  ch storages..   
+0002a470: 2020 2020 2023 2053 746f 7265 7320 666f       # Stores fo
+0002a480: 7220 6561 6368 206f 626a 6563 7420 696e  r each object in
+0002a490: 2074 6865 206c 6973 7420 6d75 7374 2062   the list must b
+0002a4a0: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+0002a4b0: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
+0002a4c0: 7261 6765 5f6d 756c 745f 6f62 6a20 3d20  rage_mult_obj = 
+0002a4d0: 5b5d 0a20 2020 2020 2020 2066 6f72 205f  [].        for _
+0002a4e0: 2069 6e20 7261 6e67 6528 3529 3a0a 2020   in range(5):.  
+0002a4f0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+0002a500: 616d 7020 3d20 7374 7228 7469 6d65 2e74  amp = str(time.t
+0002a510: 696d 6528 2929 2e72 6570 6c61 6365 2827  ime()).replace('
+0002a520: 2e27 2c20 2727 290a 2020 2020 2020 2020  .', '').        
+0002a530: 2020 2020 7374 6f72 655f 6f62 6a20 3d20      store_obj = 
+0002a540: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002a550: 6167 6528 6e61 6d65 3d66 2773 6b79 2d74  age(name=f'sky-t
+0002a560: 6573 742d 7b74 696d 6573 7461 6d70 7d27  est-{timestamp}'
+0002a570: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0002a580: 6f72 6167 655f 6d75 6c74 5f6f 626a 2e61  orage_mult_obj.a
+0002a590: 7070 656e 6428 7374 6f72 655f 6f62 6a29  ppend(store_obj)
+0002a5a0: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+0002a5b0: 746f 7261 6765 5f6d 756c 745f 6f62 6a0a  torage_mult_obj.
+0002a5c0: 2020 2020 2020 2020 666f 7220 7374 6f72          for stor
+0002a5d0: 6167 655f 6f62 6a20 696e 2073 746f 7261  age_obj in stora
+0002a5e0: 6765 5f6d 756c 745f 6f62 6a3a 0a20 2020  ge_mult_obj:.   
+0002a5f0: 2020 2020 2020 2020 2068 616e 646c 6520           handle 
+0002a600: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
+0002a610: 6174 652e 6765 745f 6861 6e64 6c65 5f66  ate.get_handle_f
+0002a620: 726f 6d5f 7374 6f72 6167 655f 6e61 6d65  rom_storage_name
+0002a630: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002a640: 2020 7374 6f72 6167 655f 6f62 6a2e 6e61    storage_obj.na
+0002a650: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0002a660: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
+0002a670: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0002a680: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
+0002a690: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
+0002a6a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002a6b0: 2054 4f44 4f28 726f 6d69 6c62 293a 2054   TODO(romilb): T
+0002a6c0: 6869 7320 6973 2070 6f74 656e 7469 616c  his is potential
+0002a6d0: 6c79 2072 6973 6b79 202d 2069 6620 7468  ly risky - if th
+0002a6e0: 6520 6465 6c65 7465 206d 6574 686f 6420  e delete method 
+0002a6f0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+0002a700: 2020 2020 2320 6275 6773 2c20 7468 6973      # bugs, this
+0002a710: 2063 616e 2063 6175 7365 2072 6573 6f75   can cause resou
+0002a720: 7263 6520 6c65 616b 732e 2049 6465 616c  rce leaks. Ideal
+0002a730: 6c79 2077 6520 7368 6f75 6c64 206d 616e  ly we should man
+0002a740: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
+0002a750: 2020 2020 2020 2320 656a 6563 7420 7374        # eject st
+0002a760: 6f72 6167 6520 6672 6f6d 2067 6c6f 6261  orage from globa
+0002a770: 6c5f 7573 6572 5f73 7461 7465 2061 6e64  l_user_state and
+0002a780: 2064 656c 6574 6520 7468 6520 6275 636b   delete the buck
+0002a790: 6574 2075 7369 6e67 0a20 2020 2020 2020  et using.       
+0002a7a0: 2020 2020 2020 2020 2023 2062 6f74 6f33           # boto3
+0002a7b0: 2064 6972 6563 746c 792e 0a20 2020 2020   directly..     
+0002a7c0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002a7d0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+0002a7e0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0002a7f0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0002a800: 5f6d 756c 7469 706c 655f 6375 7374 6f6d  _multiple_custom
+0002a810: 5f73 6f75 7263 655f 7374 6f72 6167 655f  _source_storage_
+0002a820: 6f62 6a28 7365 6c66 293a 0a20 2020 2020  obj(self):.     
+0002a830: 2020 2023 2043 7265 6174 6573 2061 206c     # Creates a l
+0002a840: 6973 7420 6f66 2073 746f 7261 6765 206f  ist of storage o
+0002a850: 626a 6563 7473 2077 6974 6820 6375 7374  bjects with cust
+0002a860: 6f6d 2073 6f75 7263 6520 6e61 6d65 7320  om source names 
+0002a870: 746f 0a20 2020 2020 2020 2023 2063 7265  to.        # cre
+0002a880: 6174 6520 6d75 6c74 6970 6c65 2073 6372  ate multiple scr
+0002a890: 6174 6368 2073 746f 7261 6765 732e 0a20  atch storages.. 
+0002a8a0: 2020 2020 2020 2023 2053 746f 7265 7320         # Stores 
+0002a8b0: 666f 7220 6561 6368 206f 626a 6563 7420  for each object 
+0002a8c0: 696e 2074 6865 206c 6973 7420 6d75 7374  in the list must
+0002a8d0: 2062 6520 6164 6465 6420 696e 2074 6865   be added in the
+0002a8e0: 2074 6573 742e 0a20 2020 2020 2020 2063   test..        c
+0002a8f0: 7573 746f 6d5f 736f 7572 6365 5f6e 616d  ustom_source_nam
+0002a900: 6573 203d 205b 2722 7061 7468 2057 6974  es = ['"path Wit
+0002a910: 6820 5370 6163 6573 2227 2c20 2770 6174  h Spaces"', 'pat
+0002a920: 6820 5769 7468 2053 7061 6365 7327 5d0a  h With Spaces'].
+0002a930: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002a940: 6d75 6c74 5f6f 626a 203d 205b 5d0a 2020  mult_obj = [].  
+0002a950: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
+0002a960: 6e20 6375 7374 6f6d 5f73 6f75 7263 655f  n custom_source_
+0002a970: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
+0002a980: 2020 2073 7263 5f70 6174 6820 3d20 6f73     src_path = os
+0002a990: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
+0002a9a0: 2866 277e 2f7b 6e61 6d65 7d27 290a 2020  (f'~/{name}').  
+0002a9b0: 2020 2020 2020 2020 2020 7061 7468 6c69            pathli
+0002a9c0: 622e 5061 7468 2873 7263 5f70 6174 6829  b.Path(src_path)
+0002a9d0: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
+0002a9e0: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
+0002a9f0: 6529 0a20 2020 2020 2020 2020 2020 2074  e).            t
+0002aa00: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
+0002aa10: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
+0002aa20: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
+0002aa30: 2020 2020 2020 2020 2073 746f 7265 5f6f           store_o
+0002aa40: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+0002aa50: 2e53 746f 7261 6765 286e 616d 653d 6627  .Storage(name=f'
+0002aa60: 736b 792d 7465 7374 2d7b 7469 6d65 7374  sky-test-{timest
+0002aa70: 616d 707d 272c 0a20 2020 2020 2020 2020  amp}',.         
+0002aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aaa0: 2020 2073 6f75 7263 653d 7372 635f 7061     source=src_pa
+0002aab0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0002aac0: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
+0002aad0: 2e61 7070 656e 6428 7374 6f72 655f 6f62  .append(store_ob
+0002aae0: 6a29 0a20 2020 2020 2020 2079 6965 6c64  j).        yield
+0002aaf0: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
+0002ab00: 6a0a 2020 2020 2020 2020 666f 7220 7374  j.        for st
+0002ab10: 6f72 6167 655f 6f62 6a20 696e 2073 746f  orage_obj in sto
+0002ab20: 7261 6765 5f6d 756c 745f 6f62 6a3a 0a20  rage_mult_obj:. 
+0002ab30: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+0002ab40: 6520 3d20 676c 6f62 616c 5f75 7365 725f  e = global_user_
+0002ab50: 7374 6174 652e 6765 745f 6861 6e64 6c65  state.get_handle
+0002ab60: 5f66 726f 6d5f 7374 6f72 6167 655f 6e61  _from_storage_na
+0002ab70: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
+0002ab80: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
+0002ab90: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0002aba0: 2020 6966 2068 616e 646c 653a 0a20 2020    if handle:.   
+0002abb0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+0002abc0: 7261 6765 5f6f 626a 2e64 656c 6574 6528  rage_obj.delete(
+0002abd0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002abe0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002abf0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
+0002ac00: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0002ac10: 7563 6b65 745f 6e61 6d65 2c20 746d 705f  ucket_name, tmp_
+0002ac20: 736f 7572 6365 293a 0a20 2020 2020 2020  source):.       
+0002ac30: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002ac40: 706f 7261 7279 2073 746f 7261 6765 206f  porary storage o
+0002ac50: 626a 6563 742e 2053 746f 7265 7320 6d75  bject. Stores mu
+0002ac60: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
+0002ac70: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
+0002ac80: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0002ac90: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
+0002aca0: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
+0002acb0: 7563 6b65 745f 6e61 6d65 2c0a 2020 2020  ucket_name,.    
+0002acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ace0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0002acf0: 746d 705f 736f 7572 6365 290a 0a20 2020  tmp_source)..   
+0002ad00: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002ad10: 0a20 2020 2064 6566 2074 6d70 5f6c 6f63  .    def tmp_loc
+0002ad20: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
+0002ad30: 6f62 6a28 7365 6c66 2c20 746d 705f 6275  obj(self, tmp_bu
+0002ad40: 636b 6574 5f6e 616d 652c 2074 6d70 5f73  cket_name, tmp_s
+0002ad50: 6f75 7263 6529 3a0a 2020 2020 2020 2020  ource):.        
+0002ad60: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
+0002ad70: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002ad80: 7768 6963 6820 7573 6573 2061 206c 6973  which uses a lis
+0002ad90: 7420 6f66 2070 6174 6873 2061 7320 736f  t of paths as so
+0002ada0: 7572 6365 2e0a 2020 2020 2020 2020 2320  urce..        # 
+0002adb0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
+0002adc0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
+0002add0: 2e20 4166 7465 7220 7570 6c6f 6164 2c20  . After upload, 
+0002ade0: 7468 6520 6275 636b 6574 2073 686f 756c  the bucket shoul
+0002adf0: 640a 2020 2020 2020 2020 2320 6861 7665  d.        # have
+0002ae00: 2074 776f 2066 696c 6573 202d 202f 746d   two files - /tm
+0002ae10: 702d 6669 6c65 2061 6e64 202f 746d 702d  p-file and /tmp-
+0002ae20: 736f 7572 6365 2f74 6d70 2d66 696c 650a  source/tmp-file.
+0002ae30: 2020 2020 2020 2020 6c69 7374 5f73 6f75          list_sou
+0002ae40: 7263 6520 3d20 5b74 6d70 5f73 6f75 7263  rce = [tmp_sourc
+0002ae50: 652c 2074 6d70 5f73 6f75 7263 6520 2b20  e, tmp_source + 
+0002ae60: 272f 746d 702d 6669 6c65 275d 0a20 2020  '/tmp-file'].   
+0002ae70: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
+0002ae80: 7365 6c66 2e79 6965 6c64 5f73 746f 7261  self.yield_stora
+0002ae90: 6765 5f6f 626a 6563 7428 6e61 6d65 3d74  ge_object(name=t
+0002aea0: 6d70 5f62 7563 6b65 745f 6e61 6d65 2c0a  mp_bucket_name,.
+0002aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aed0: 2020 2020 2020 2020 2020 2020 2073 6f75               sou
+0002aee0: 7263 653d 6c69 7374 5f73 6f75 7263 6529  rce=list_source)
+0002aef0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002af00: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002af10: 705f 6275 6c6b 5f64 656c 5f73 746f 7261  p_bulk_del_stora
+0002af20: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
+0002af30: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0002af40: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002af50: 2061 2074 656d 706f 7261 7279 2073 746f   a temporary sto
+0002af60: 7261 6765 206f 626a 6563 7420 666f 7220  rage object for 
+0002af70: 7465 7374 696e 6720 6275 6c6b 2064 656c  testing bulk del
+0002af80: 6574 696f 6e2e 0a20 2020 2020 2020 2023  etion..        #
+0002af90: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002afa0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002afb0: 742e 0a20 2020 2020 2020 2077 6974 6820  t..        with 
+0002afc0: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
+0002afd0: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
+0002afe0: 2074 6d70 6469 723a 0a20 2020 2020 2020   tmpdir:.       
+0002aff0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002b000: 6368 6563 6b5f 6f75 7470 7574 2866 276d  check_output(f'm
+0002b010: 6b64 6972 202d 7020 7b74 6d70 6469 727d  kdir -p {tmpdir}
+0002b020: 2f66 6f6c 6465 727b 7b30 3030 2e2e 3235  /folder{{000..25
+0002b030: 357d 7d27 2c0a 2020 2020 2020 2020 2020  5}}',.          
+0002b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b050: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
+0002b060: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0002b070: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002b080: 636b 5f6f 7574 7075 7428 6627 746f 7563  ck_output(f'touc
+0002b090: 6820 7b74 6d70 6469 727d 2f74 6573 747b  h {tmpdir}/test{
+0002b0a0: 7b30 3030 2e2e 3235 357d 7d2e 7478 7427  {000..255}}.txt'
+0002b0b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0d0: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
+0002b0e0: 290a 2020 2020 2020 2020 2020 2020 7375  ).            su
+0002b0f0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0002b100: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
+0002b110: 2020 2020 2020 2066 2774 6f75 6368 207b         f'touch {
+0002b120: 746d 7064 6972 7d2f 666f 6c64 6572 7b7b  tmpdir}/folder{{
+0002b130: 3030 302e 2e32 3535 7d7d 2f74 6573 742e  000..255}}/test.
+0002b140: 7478 7427 2c20 7368 656c 6c3d 5472 7565  txt', shell=True
+0002b150: 290a 2020 2020 2020 2020 2020 2020 7969  ).            yi
+0002b160: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
+0002b170: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
+0002b180: 6374 286e 616d 653d 746d 705f 6275 636b  ct(name=tmp_buck
+0002b190: 6574 5f6e 616d 652c 0a20 2020 2020 2020  et_name,.       
+0002b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1c0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002b1d0: 3d74 6d70 6469 7229 0a0a 2020 2020 4070  =tmpdir)..    @p
+0002b1e0: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+0002b1f0: 2020 6465 6620 746d 705f 636f 7079 5f6d    def tmp_copy_m
+0002b200: 6e74 5f65 7869 7374 696e 675f 7374 6f72  nt_existing_stor
+0002b210: 6167 655f 6f62 6a28 7365 6c66 2c20 746d  age_obj(self, tm
+0002b220: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0002b230: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
+0002b240: 2320 4372 6561 7465 7320 6120 636f 7079  # Creates a copy
+0002b250: 206d 6f75 6e74 2073 746f 7261 6765 2077   mount storage w
+0002b260: 6869 6368 2072 6575 7365 7320 616e 2065  hich reuses an e
+0002b270: 7869 7374 696e 6720 7374 6f72 6167 6520  xisting storage 
+0002b280: 6f62 6a65 6374 2e0a 2020 2020 2020 2020  object..        
+0002b290: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
+0002b2a0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+0002b2b0: 6528 7374 6f72 6167 655f 6c69 622e 5374  e(storage_lib.St
+0002b2c0: 6f72 6554 7970 652e 5333 290a 2020 2020  oreType.S3).    
+0002b2d0: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+0002b2e0: 203d 2074 6d70 5f73 6372 6174 6368 5f73   = tmp_scratch_s
+0002b2f0: 746f 7261 6765 5f6f 626a 2e6e 616d 650a  torage_obj.name.
+0002b300: 0a20 2020 2020 2020 2023 2054 7279 2074  .        # Try t
+0002b310: 6f20 696e 6974 6961 6c69 7a65 2061 6e6f  o initialize ano
+0002b320: 7468 6572 2073 746f 7261 6765 2077 6974  ther storage wit
+0002b330: 6820 7468 6520 7374 6f72 6167 6520 6f62  h the storage ob
+0002b340: 6a65 6374 2063 7265 6174 6564 0a20 2020  ject created.   
+0002b350: 2020 2020 2023 2061 626f 7665 2c20 6275       # above, bu
+0002b360: 7420 6e6f 7720 696e 2043 4f50 5920 6d6f  t now in COPY mo
+0002b370: 6465 2e20 5468 6973 2073 686f 756c 6420  de. This should 
+0002b380: 7375 6363 6565 642e 0a20 2020 2020 2020  succeed..       
+0002b390: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0002b3a0: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
+0002b3b0: 626a 6563 7428 6e61 6d65 3d73 746f 7261  bject(name=stora
+0002b3c0: 6765 5f6e 616d 652c 0a20 2020 2020 2020  ge_name,.       
+0002b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3f0: 2020 2020 2020 6d6f 6465 3d73 746f 7261        mode=stora
+0002b400: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
+0002b410: 6465 2e43 4f50 5929 0a0a 2020 2020 4070  de.COPY)..    @p
+0002b420: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+0002b430: 2020 6465 6620 746d 705f 6769 7469 676e    def tmp_gitign
+0002b440: 6f72 655f 7374 6f72 6167 655f 6f62 6a28  ore_storage_obj(
+0002b450: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
+0002b460: 5f6e 616d 652c 2067 6974 6967 6e6f 7265  _name, gitignore
+0002b470: 5f73 7472 7563 7475 7265 293a 0a20 2020  _structure):.   
+0002b480: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002b490: 2074 656d 706f 7261 7279 2073 746f 7261   temporary stora
+0002b4a0: 6765 206f 626a 6563 7420 666f 7220 7465  ge object for te
+0002b4b0: 7374 696e 6720 2e67 6974 6967 6e6f 7265  sting .gitignore
+0002b4c0: 2066 696c 7465 722e 0a20 2020 2020 2020   filter..       
+0002b4d0: 2023 2047 4954 4947 494e 4f52 455f 5354   # GITIGINORE_ST
+0002b4e0: 5255 4354 5552 4520 6973 2072 6570 7265  RUCTURE is repre
+0002b4f0: 7365 6e74 696e 6720 6120 6669 6c65 2073  senting a file s
+0002b500: 7472 7563 7475 7265 2069 6e20 6120 6469  tructure in a di
+0002b510: 6374 696f 6e61 7279 0a20 2020 2020 2020  ctionary.       
+0002b520: 2023 2066 6f72 6d61 742e 2043 7265 6174   # format. Creat
+0002b530: 6564 2073 746f 7261 6765 206f 626a 6563  ed storage objec
+0002b540: 7420 7769 6c6c 2063 6f6e 7461 696e 2074  t will contain t
+0002b550: 6865 2066 696c 6520 7374 7275 6374 7572  he file structur
+0002b560: 6520 616c 6f6e 670a 2020 2020 2020 2020  e along.        
+0002b570: 2320 7769 7468 202e 6769 7469 676e 6f72  # with .gitignor
+0002b580: 6520 616e 6420 2e67 6974 2f69 6e66 6f2f  e and .git/info/
+0002b590: 6578 636c 7564 6520 6669 6c65 7320 746f  exclude files to
+0002b5a0: 2074 6573 7420 6578 636c 7564 6520 6669   test exclude fi
+0002b5b0: 6c74 6572 2e0a 2020 2020 2020 2020 2320  lter..        # 
+0002b5c0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
+0002b5d0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
+0002b5e0: 2e0a 2020 2020 2020 2020 7769 7468 2074  ..        with t
+0002b5f0: 656d 7066 696c 652e 5465 6d70 6f72 6172  empfile.Temporar
+0002b600: 7944 6972 6563 746f 7279 2829 2061 7320  yDirectory() as 
+0002b610: 746d 7064 6972 3a0a 2020 2020 2020 2020  tmpdir:.        
+0002b620: 2020 2020 2320 4372 6561 7465 7320 6669      # Creates fi
+0002b630: 6c65 2073 7472 7563 7475 7265 2074 6f20  le structure to 
+0002b640: 6265 2075 706c 6f61 6465 6420 696e 2074  be uploaded in t
+0002b650: 6865 2053 746f 7261 6765 0a20 2020 2020  he Storage.     
+0002b660: 2020 2020 2020 2073 656c 662e 6372 6561         self.crea
+0002b670: 7465 5f64 6972 5f73 7472 7563 7475 7265  te_dir_structure
+0002b680: 2874 6d70 6469 722c 2067 6974 6967 6e6f  (tmpdir, gitigno
+0002b690: 7265 5f73 7472 7563 7475 7265 290a 0a20  re_structure).. 
+0002b6a0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
+0002b6b0: 6174 6520 2e67 6974 6967 6e6f 7265 2061  ate .gitignore a
+0002b6c0: 6e64 206c 6973 7420 6669 6c65 732f 6469  nd list files/di
+0002b6d0: 7273 2074 6f20 6265 2065 7863 6c75 6465  rs to be exclude
+0002b6e0: 6420 696e 2069 740a 2020 2020 2020 2020  d in it.        
+0002b6f0: 2020 2020 736b 7970 696c 6f74 5f70 6174      skypilot_pat
+0002b700: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+0002b710: 616d 6528 6f73 2e70 6174 682e 6469 726e  ame(os.path.dirn
+0002b720: 616d 6528 736b 792e 5f5f 6669 6c65 5f5f  ame(sky.__file__
+0002b730: 2929 0a20 2020 2020 2020 2020 2020 2074  )).            t
+0002b740: 656d 705f 7061 7468 203d 2066 277b 746d  emp_path = f'{tm
+0002b750: 7064 6972 7d2f 2e67 6974 6967 6e6f 7265  pdir}/.gitignore
+0002b760: 270a 2020 2020 2020 2020 2020 2020 6669  '.            fi
+0002b770: 6c65 5f70 6174 6820 3d20 6f73 2e70 6174  le_path = os.pat
+0002b780: 682e 6a6f 696e 2873 6b79 7069 6c6f 745f  h.join(skypilot_
+0002b790: 7061 7468 2c20 2774 6573 7473 2f67 6974  path, 'tests/git
+0002b7a0: 6967 6e6f 7265 5f74 6573 7427 290a 2020  ignore_test').  
+0002b7b0: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
+0002b7c0: 2e63 6f70 7966 696c 6528 6669 6c65 5f70  .copyfile(file_p
+0002b7d0: 6174 682c 2074 656d 705f 7061 7468 290a  ath, temp_path).
+0002b7e0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0002b7f0: 7265 6174 6520 2e67 6974 2f69 6e66 6f2f  reate .git/info/
+0002b800: 6578 636c 7564 6520 616e 6420 6c69 7374  exclude and list
+0002b810: 2066 696c 6573 2f64 6972 7320 746f 2062   files/dirs to b
+0002b820: 6520 6578 636c 7564 6564 2069 6e20 6974  e excluded in it
+0002b830: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0002b840: 705f 7061 7468 203d 2066 277b 746d 7064  p_path = f'{tmpd
+0002b850: 6972 7d2f 2e67 6974 2f69 6e66 6f2f 270a  ir}/.git/info/'.
+0002b860: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
+0002b870: 616b 6564 6972 7328 7465 6d70 5f70 6174  akedirs(temp_pat
+0002b880: 6829 0a20 2020 2020 2020 2020 2020 2074  h).            t
+0002b890: 656d 705f 6578 636c 7564 655f 7061 7468  emp_exclude_path
+0002b8a0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+0002b8b0: 7465 6d70 5f70 6174 682c 2027 6578 636c  temp_path, 'excl
+0002b8c0: 7564 6527 290a 2020 2020 2020 2020 2020  ude').          
+0002b8d0: 2020 6669 6c65 5f70 6174 6820 3d20 6f73    file_path = os
+0002b8e0: 2e70 6174 682e 6a6f 696e 2873 6b79 7069  .path.join(skypi
+0002b8f0: 6c6f 745f 7061 7468 2c0a 2020 2020 2020  lot_path,.      
+0002b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b910: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002b920: 7465 7374 732f 6769 745f 696e 666f 5f65  tests/git_info_e
+0002b930: 7863 6c75 6465 5f74 6573 7427 290a 2020  xclude_test').  
+0002b940: 2020 2020 2020 2020 2020 7368 7574 696c            shutil
+0002b950: 2e63 6f70 7966 696c 6528 6669 6c65 5f70  .copyfile(file_p
+0002b960: 6174 682c 2074 656d 705f 6578 636c 7564  ath, temp_exclud
+0002b970: 655f 7061 7468 290a 0a20 2020 2020 2020  e_path)..       
+0002b980: 2020 2020 2023 2043 7265 6174 6520 736b       # Create sk
+0002b990: 7920 5374 6f72 6167 6520 7769 7468 2074  y Storage with t
+0002b9a0: 6865 2066 696c 6573 2063 7265 6174 6564  he files created
+0002b9b0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+0002b9c0: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
+0002b9d0: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
+0002b9e0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002b9f0: 2020 206e 616d 653d 746d 705f 6275 636b     name=tmp_buck
+0002ba00: 6574 5f6e 616d 652c 0a20 2020 2020 2020  et_name,.       
+0002ba10: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0002ba20: 746d 7064 6972 2c0a 2020 2020 2020 2020  tmpdir,.        
+0002ba30: 2020 2020 2020 2020 6d6f 6465 3d73 746f          mode=sto
+0002ba40: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
+0002ba50: 4d6f 6465 2e43 4f50 5929 0a0a 2020 2020  Mode.COPY)..    
+0002ba60: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002ba70: 2020 2020 6465 6620 746d 705f 6177 7363      def tmp_awsc
+0002ba80: 6c69 5f62 7563 6b65 7428 7365 6c66 2c20  li_bucket(self, 
+0002ba90: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
+0002baa0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002bab0: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
+0002bac0: 6275 636b 6574 2075 7369 6e67 2061 7773  bucket using aws
+0002bad0: 636c 690a 2020 2020 2020 2020 6275 636b  cli.        buck
+0002bae0: 6574 5f75 7269 203d 2066 2773 333a 2f2f  et_uri = f's3://
+0002baf0: 7b74 6d70 5f62 7563 6b65 745f 6e61 6d65  {tmp_bucket_name
+0002bb00: 7d27 0a20 2020 2020 2020 2073 7562 7072  }'.        subpr
+0002bb10: 6f63 6573 732e 6368 6563 6b5f 6361 6c6c  ocess.check_call
+0002bb20: 285b 2761 7773 272c 2027 7333 272c 2027  (['aws', 's3', '
+0002bb30: 6d62 272c 2062 7563 6b65 745f 7572 695d  mb', bucket_uri]
+0002bb40: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002bb50: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002bb60: 2062 7563 6b65 745f 7572 690a 2020 2020   bucket_uri.    
+0002bb70: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+0002bb80: 6865 636b 5f63 616c 6c28 5b27 6177 7327  heck_call(['aws'
+0002bb90: 2c20 2773 3327 2c20 2772 6227 2c20 6275  , 's3', 'rb', bu
+0002bba0: 636b 6574 5f75 7269 2c20 272d 2d66 6f72  cket_uri, '--for
+0002bbb0: 6365 275d 290a 0a20 2020 2040 7079 7465  ce'])..    @pyte
+0002bbc0: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
+0002bbd0: 6566 2074 6d70 5f67 7375 7469 6c5f 6275  ef tmp_gsutil_bu
+0002bbe0: 636b 6574 2873 656c 662c 2074 6d70 5f62  cket(self, tmp_b
+0002bbf0: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
+0002bc00: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0002bc10: 2074 656d 706f 7261 7279 2062 7563 6b65   temporary bucke
+0002bc20: 7420 7573 696e 6720 6773 7574 696c 0a20  t using gsutil. 
+0002bc30: 2020 2020 2020 2062 7563 6b65 745f 7572         bucket_ur
+0002bc40: 6920 3d20 6627 6773 3a2f 2f7b 746d 705f  i = f'gs://{tmp_
+0002bc50: 6275 636b 6574 5f6e 616d 657d 270a 2020  bucket_name}'.  
+0002bc60: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0002bc70: 2e63 6865 636b 5f63 616c 6c28 5b27 6773  .check_call(['gs
+0002bc80: 7574 696c 272c 2027 6d62 272c 2062 7563  util', 'mb', buc
+0002bc90: 6b65 745f 7572 695d 290a 2020 2020 2020  ket_uri]).      
+0002bca0: 2020 7969 656c 6420 746d 705f 6275 636b    yield tmp_buck
+0002bcb0: 6574 5f6e 616d 652c 2062 7563 6b65 745f  et_name, bucket_
+0002bcc0: 7572 690a 2020 2020 2020 2020 7375 6270  uri.        subp
+0002bcd0: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+0002bce0: 6c28 5b27 6773 7574 696c 272c 2027 726d  l(['gsutil', 'rm
+0002bcf0: 272c 2027 2d72 272c 2062 7563 6b65 745f  ', '-r', bucket_
+0002bd00: 7572 695d 290a 0a20 2020 2040 7079 7465  uri])..    @pyte
+0002bd10: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
+0002bd20: 6566 2074 6d70 5f61 7773 636c 695f 6275  ef tmp_awscli_bu
+0002bd30: 636b 6574 5f72 3228 7365 6c66 2c20 746d  cket_r2(self, tm
+0002bd40: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
+0002bd50: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002bd60: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
+0002bd70: 636b 6574 2075 7369 6e67 2061 7773 636c  cket using awscl
+0002bd80: 690a 2020 2020 2020 2020 656e 6470 6f69  i.        endpoi
+0002bd90: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
+0002bda0: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
+0002bdb0: 696e 7428 290a 2020 2020 2020 2020 6275  int().        bu
+0002bdc0: 636b 6574 5f75 7269 203d 2066 2773 333a  cket_uri = f's3:
+0002bdd0: 2f2f 7b74 6d70 5f62 7563 6b65 745f 6e61  //{tmp_bucket_na
+0002bde0: 6d65 7d27 0a20 2020 2020 2020 2073 7562  me}'.        sub
+0002bdf0: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
+0002be00: 6c6c 280a 2020 2020 2020 2020 2020 2020  ll(.            
+0002be10: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
+0002be20: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
+0002be30: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
+0002be40: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
+0002be50: 7773 2073 3320 6d62 207b 6275 636b 6574  ws s3 mb {bucket
+0002be60: 5f75 7269 7d20 2d2d 656e 6470 6f69 6e74  _uri} --endpoint
+0002be70: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0002be80: 2d2d 7072 6f66 696c 653d 7232 272c 0a20  --profile=r2',. 
+0002be90: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002bea0: 3d54 7275 6529 0a20 2020 2020 2020 2079  =True).        y
+0002beb0: 6965 6c64 2074 6d70 5f62 7563 6b65 745f  ield tmp_bucket_
+0002bec0: 6e61 6d65 2c20 6275 636b 6574 5f75 7269  name, bucket_uri
+0002bed0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0002bee0: 6573 732e 6368 6563 6b5f 6361 6c6c 280a  ess.check_call(.
+0002bef0: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
+0002bf00: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
+0002bf10: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
+0002bf20: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
+0002bf30: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
+0002bf40: 3320 7262 207b 6275 636b 6574 5f75 7269  3 rb {bucket_uri
+0002bf50: 7d20 2d2d 666f 7263 6520 2d2d 656e 6470  } --force --endp
+0002bf60: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
+0002bf70: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
+0002bf80: 272c 0a20 2020 2020 2020 2020 2020 2073  ',.            s
+0002bf90: 6865 6c6c 3d54 7275 6529 0a0a 2020 2020  hell=True)..    
+0002bfa0: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+0002bfb0: 2020 2020 6465 6620 746d 705f 6962 6d5f      def tmp_ibm_
+0002bfc0: 636f 735f 6275 636b 6574 2873 656c 662c  cos_bucket(self,
+0002bfd0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002bfe0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002bff0: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
+0002c000: 2062 7563 6b65 7420 7573 696e 6720 4942   bucket using IB
+0002c010: 4d20 434f 5320 4150 490a 2020 2020 2020  M COS API.      
+0002c020: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+0002c030: 7374 6f72 6167 655f 6c69 622e 4942 4d43  storage_lib.IBMC
+0002c040: 6f73 5374 6f72 6528 736f 7572 6365 3d22  osStore(source="
+0002c050: 222c 206e 616d 653d 746d 705f 6275 636b  ", name=tmp_buck
+0002c060: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
+0002c070: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
+0002c080: 745f 6e61 6d65 0a20 2020 2020 2020 2073  t_name.        s
+0002c090: 746f 7261 6765 5f6f 626a 2e64 656c 6574  torage_obj.delet
+0002c0a0: 6528 290a 0a20 2020 2040 7079 7465 7374  e()..    @pytest
+0002c0b0: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
+0002c0c0: 2074 6d70 5f70 7562 6c69 635f 7374 6f72   tmp_public_stor
+0002c0d0: 6167 655f 6f62 6a28 7365 6c66 2c20 7265  age_obj(self, re
+0002c0e0: 7175 6573 7429 3a0a 2020 2020 2020 2020  quest):.        
+0002c0f0: 2320 496e 6974 6961 6c69 7a65 7320 6120  # Initializes a 
+0002c100: 7374 6f72 6167 6520 6f62 6a65 6374 2077  storage object w
+0002c110: 6974 6820 6120 7075 626c 6963 2062 7563  ith a public buc
+0002c120: 6b65 740a 2020 2020 2020 2020 7374 6f72  ket.        stor
+0002c130: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
+0002c140: 655f 6c69 622e 5374 6f72 6167 6528 736f  e_lib.Storage(so
+0002c150: 7572 6365 3d72 6571 7565 7374 2e70 6172  urce=request.par
+0002c160: 616d 290a 2020 2020 2020 2020 7969 656c  am).        yiel
+0002c170: 6420 7374 6f72 6167 655f 6f62 6a0a 2020  d storage_obj.  
+0002c180: 2020 2020 2020 2320 5468 6973 2064 6f65        # This doe
+0002c190: 7320 6e6f 7420 7265 7175 6972 6520 616e  s not require an
+0002c1a0: 7920 6465 6c65 7469 6f6e 206c 6f67 6963  y deletion logic
+0002c1b0: 2062 6563 6175 7365 2069 7420 6973 2061   because it is a
+0002c1c0: 2070 7562 6c69 6320 6275 636b 6574 0a20   public bucket. 
+0002c1d0: 2020 2020 2020 2023 2061 6e64 2073 686f         # and sho
+0002c1e0: 756c 6420 6e6f 7420 6765 7420 6164 6465  uld not get adde
+0002c1f0: 6420 746f 2067 6c6f 6261 6c5f 7573 6572  d to global_user
+0002c200: 5f73 7461 7465 2e0a 0a20 2020 2040 7079  _state...    @py
+0002c210: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+0002c220: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
+0002c230: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+0002c240: 7269 7a65 2827 7374 6f72 655f 7479 7065  rize('store_type
+0002c250: 272c 205b 0a20 2020 2020 2020 2073 746f  ', [.        sto
+0002c260: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002c270: 7065 2e53 332c 2073 746f 7261 6765 5f6c  pe.S3, storage_l
+0002c280: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+0002c290: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
+0002c2a0: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
+0002c2b0: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+0002c2c0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002c2d0: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
+0002c2e0: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
+0002c2f0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002c300: 5479 7065 2e52 322c 206d 6172 6b73 3d70  Type.R2, marks=p
+0002c310: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
+0002c320: 666c 6172 6529 0a20 2020 205d 290a 2020  flare).    ]).  
+0002c330: 2020 6465 6620 7465 7374 5f6e 6577 5f62    def test_new_b
+0002c340: 7563 6b65 745f 6372 6561 7469 6f6e 5f61  ucket_creation_a
+0002c350: 6e64 5f64 656c 6574 696f 6e28 7365 6c66  nd_deletion(self
+0002c360: 2c20 746d 705f 6c6f 6361 6c5f 7374 6f72  , tmp_local_stor
+0002c370: 6167 655f 6f62 6a2c 0a20 2020 2020 2020  age_obj,.       
+0002c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3a0: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
+0002c3b0: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002c3c0: 6561 7465 7320 6120 6e65 7720 6275 636b  eates a new buck
+0002c3d0: 6574 2077 6974 6820 6120 6c6f 6361 6c20  et with a local 
+0002c3e0: 736f 7572 6365 2c20 7570 6c6f 6164 7320  source, uploads 
+0002c3f0: 6669 6c65 7320 746f 2069 740a 2020 2020  files to it.    
+0002c400: 2020 2020 2320 616e 6420 6465 6c65 7465      # and delete
+0002c410: 7320 6974 2e0a 2020 2020 2020 2020 746d  s it..        tm
+0002c420: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+0002c430: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002c440: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0002c450: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002c460: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002c470: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0002c480: 6374 2065 7869 7374 7320 696e 2074 6865  ct exists in the
+0002c490: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0002c4a0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+0002c4b0: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+0002c4c0: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+0002c4d0: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+0002c4e0: 6173 7365 7274 2074 6d70 5f6c 6f63 616c  assert tmp_local
+0002c4f0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002c500: 6520 696e 206f 7574 2e64 6563 6f64 6528  e in out.decode(
+0002c510: 2775 7466 2d38 2729 0a0a 2020 2020 2020  'utf-8')..      
+0002c520: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002c530: 6167 6520 6465 6c65 7465 2074 6f20 6465  age delete to de
+0002c540: 6c65 7465 2074 6865 2073 746f 7261 6765  lete the storage
+0002c550: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
+0002c560: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002c570: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+0002c580: 2020 2020 205b 2773 6b79 272c 2027 7374       ['sky', 'st
+0002c590: 6f72 6167 6527 2c20 2764 656c 6574 6527  orage', 'delete'
+0002c5a0: 2c20 746d 705f 6c6f 6361 6c5f 7374 6f72  , tmp_local_stor
+0002c5b0: 6167 655f 6f62 6a2e 6e61 6d65 2c20 272d  age_obj.name, '-
+0002c5c0: 2d79 6573 275d 290a 0a20 2020 2020 2020  -yes'])..       
+0002c5d0: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002c5e0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0002c5f0: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
+0002c600: 2069 7320 6465 6c65 7465 640a 2020 2020   is deleted.    
+0002c610: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+0002c620: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002c630: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+0002c640: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
+0002c650: 2020 2020 6173 7365 7274 2074 6d70 5f6c      assert tmp_l
+0002c660: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
+0002c670: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
+0002c680: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002c690: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0002c6a0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+0002c6b0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0002c6c0: 6b2e 7864 6973 745f 6772 6f75 7028 276d  k.xdist_group('m
+0002c6d0: 756c 7469 706c 655f 6275 636b 6574 5f64  ultiple_bucket_d
+0002c6e0: 656c 6574 696f 6e27 290a 2020 2020 4070  eletion').    @p
+0002c6f0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0002c700: 6574 7269 7a65 2827 7374 6f72 655f 7479  etrize('store_ty
+0002c710: 7065 272c 205b 0a20 2020 2020 2020 2073  pe', [.        s
+0002c720: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002c730: 5479 7065 2e53 332c 2073 746f 7261 6765  Type.S3, storage
+0002c740: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+0002c750: 4353 2c0a 2020 2020 2020 2020 7079 7465  CS,.        pyte
+0002c760: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
+0002c770: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+0002c780: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
+0002c790: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0002c7a0: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
+0002c7b0: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
+0002c7c0: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+0002c7d0: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002c7e0: 6172 6b2e 6962 6d29 0a20 2020 205d 290a  ark.ibm).    ]).
+0002c7f0: 2020 2020 6465 6620 7465 7374 5f6d 756c      def test_mul
+0002c800: 7469 706c 655f 6275 636b 6574 735f 6372  tiple_buckets_cr
+0002c810: 6561 7469 6f6e 5f61 6e64 5f64 656c 6574  eation_and_delet
+0002c820: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+0002c830: 2073 656c 662c 2074 6d70 5f6d 756c 7469   self, tmp_multi
+0002c840: 706c 655f 7363 7261 7463 685f 7374 6f72  ple_scratch_stor
+0002c850: 6167 655f 6f62 6a2c 2073 746f 7265 5f74  age_obj, store_t
+0002c860: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
+0002c870: 4372 6561 7465 7320 6d75 6c74 6970 6c65  Creates multiple
+0002c880: 206e 6577 2062 7563 6b65 7473 2835 2062   new buckets(5 b
+0002c890: 7563 6b65 7473 2920 7769 7468 2061 206c  uckets) with a l
+0002c8a0: 6f63 616c 2073 6f75 7263 650a 2020 2020  ocal source.    
+0002c8b0: 2020 2020 2320 616e 6420 6465 6c65 7465      # and delete
+0002c8c0: 7320 7468 656d 2e0a 2020 2020 2020 2020  s them..        
+0002c8d0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002c8e0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+0002c8f0: 7220 7374 6f72 655f 6f62 6a20 696e 2074  r store_obj in t
+0002c900: 6d70 5f6d 756c 7469 706c 655f 7363 7261  mp_multiple_scra
+0002c910: 7463 685f 7374 6f72 6167 655f 6f62 6a3a  tch_storage_obj:
+0002c920: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002c930: 7265 5f6f 626a 2e61 6464 5f73 746f 7265  re_obj.add_store
+0002c940: 2873 746f 7265 5f74 7970 6529 0a20 2020  (store_type).   
+0002c950: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0002c960: 5f6f 626a 5f6e 616d 652e 6170 7065 6e64  _obj_name.append
+0002c970: 2873 746f 7265 5f6f 626a 2e6e 616d 6529  (store_obj.name)
+0002c980: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
+0002c990: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
+0002c9a0: 6f20 6368 6563 6b20 6966 2061 6c6c 2073  o check if all s
+0002c9b0: 746f 7261 6765 206f 626a 6563 7473 2065  torage objects e
+0002c9c0: 7869 7374 7320 696e 2074 6865 0a20 2020  xists in the.   
+0002c9d0: 2020 2020 2023 206f 7574 7075 7420 6669       # output fi
+0002c9e0: 6c74 6572 6564 2062 7920 7374 6f72 6520  ltered by store 
+0002c9f0: 7479 7065 0a20 2020 2020 2020 206f 7574  type.        out
+0002ca00: 5f61 6c6c 203d 2073 7562 7072 6f63 6573  _all = subproces
+0002ca10: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002ca20: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002ca30: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002ca40: 206f 7574 203d 205b 0a20 2020 2020 2020   out = [.       
+0002ca50: 2020 2020 2069 7465 6d2e 7370 6c69 7428       item.split(
+0002ca60: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0002ca70: 2066 6f72 2069 7465 6d20 696e 206f 7574   for item in out
+0002ca80: 5f61 6c6c 2e64 6563 6f64 6528 2775 7466  _all.decode('utf
+0002ca90: 2d38 2729 2e73 706c 6974 6c69 6e65 7328  -8').splitlines(
+0002caa0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002cab0: 2073 746f 7265 5f74 7970 652e 7661 6c75   store_type.valu
+0002cac0: 6520 696e 2069 7465 6d0a 2020 2020 2020  e in item.      
+0002cad0: 2020 5d0a 2020 2020 2020 2020 6173 7365    ].        asse
+0002cae0: 7274 2061 6c6c 285b 6974 656d 2069 6e20  rt all([item in 
+0002caf0: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
+0002cb00: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002cb10: 5d29 0a0a 2020 2020 2020 2020 2320 5275  ])..        # Ru
+0002cb20: 6e20 736b 7920 7374 6f72 6167 6520 6465  n sky storage de
+0002cb30: 6c65 7465 2061 6c6c 2074 6f20 6465 6c65  lete all to dele
+0002cb40: 7465 2061 6c6c 2073 746f 7261 6765 206f  te all storage o
+0002cb50: 626a 6563 7473 0a20 2020 2020 2020 2064  bjects.        d
+0002cb60: 656c 6574 655f 636d 6420 3d20 5b27 736b  elete_cmd = ['sk
+0002cb70: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002cb80: 6465 6c65 7465 272c 2027 2d2d 7965 7327  delete', '--yes'
+0002cb90: 5d0a 2020 2020 2020 2020 6465 6c65 7465  ].        delete
+0002cba0: 5f63 6d64 202b 3d20 7374 6f72 6167 655f  _cmd += storage_
+0002cbb0: 6f62 6a5f 6e61 6d65 0a20 2020 2020 2020  obj_name.       
+0002cbc0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002cbd0: 6b5f 6f75 7470 7574 2864 656c 6574 655f  k_output(delete_
+0002cbe0: 636d 6429 0a0a 2020 2020 2020 2020 2320  cmd)..        # 
+0002cbf0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0002cc00: 6c73 2074 6f20 6368 6563 6b20 6966 2061  ls to check if a
+0002cc10: 6c6c 2073 746f 7261 6765 206f 626a 6563  ll storage objec
+0002cc20: 7473 2066 696c 7465 7265 6420 6279 2073  ts filtered by s
+0002cc30: 746f 7265 0a20 2020 2020 2020 2023 2074  tore.        # t
+0002cc40: 7970 6520 6172 6520 6465 6c65 7465 640a  ype are deleted.
+0002cc50: 2020 2020 2020 2020 6f75 745f 616c 6c20          out_all 
+0002cc60: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+0002cc70: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
+0002cc80: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
+0002cc90: 275d 290a 2020 2020 2020 2020 6f75 7420  ']).        out 
+0002cca0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0002ccb0: 6974 656d 2e73 706c 6974 2829 5b30 5d0a  item.split()[0].
+0002ccc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0002ccd0: 6974 656d 2069 6e20 6f75 745f 616c 6c2e  item in out_all.
+0002cce0: 6465 636f 6465 2827 7574 662d 3827 292e  decode('utf-8').
+0002ccf0: 7370 6c69 746c 696e 6573 2829 0a20 2020  splitlines().   
+0002cd00: 2020 2020 2020 2020 2069 6620 7374 6f72           if stor
+0002cd10: 655f 7479 7065 2e76 616c 7565 2069 6e20  e_type.value in 
+0002cd20: 6974 656d 0a20 2020 2020 2020 205d 0a20  item.        ]. 
+0002cd30: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+0002cd40: 6c28 5b69 7465 6d20 6e6f 7420 696e 206f  l([item not in o
+0002cd50: 7574 2066 6f72 2069 7465 6d20 696e 2073  ut for item in s
+0002cd60: 746f 7261 6765 5f6f 626a 5f6e 616d 655d  torage_obj_name]
+0002cd70: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+0002cd80: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002cd90: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002cda0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
+0002cdb0: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
+0002cdc0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002cdd0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
+0002cde0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002cdf0: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
+0002ce00: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+0002ce10: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002ce20: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
+0002ce30: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+0002ce40: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
+0002ce50: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
+0002ce60: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+0002ce70: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
+0002ce80: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0002ce90: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+0002cea0: 7465 7374 5f75 706c 6f61 645f 736f 7572  test_upload_sour
+0002ceb0: 6365 5f77 6974 685f 7370 6163 6573 2873  ce_with_spaces(s
+0002cec0: 656c 662c 2073 746f 7265 5f74 7970 652c  elf, store_type,
+0002ced0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cef0: 2020 2020 2020 2020 746d 705f 6d75 6c74          tmp_mult
+0002cf00: 6970 6c65 5f63 7573 746f 6d5f 736f 7572  iple_custom_sour
+0002cf10: 6365 5f73 746f 7261 6765 5f6f 626a 293a  ce_storage_obj):
+0002cf20: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002cf30: 6573 2074 776f 2062 7563 6b65 7473 2077  es two buckets w
+0002cf40: 6974 6820 7370 6563 6966 6965 6420 6c6f  ith specified lo
+0002cf50: 6361 6c20 736f 7572 6365 730a 2020 2020  cal sources.    
+0002cf60: 2020 2020 2320 7769 7468 2073 7061 6365      # with space
+0002cf70: 7320 696e 2074 6865 206e 616d 650a 2020  s in the name.  
+0002cf80: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0002cf90: 6a5f 6e61 6d65 7320 3d20 5b5d 0a20 2020  j_names = [].   
+0002cfa0: 2020 2020 2066 6f72 2073 746f 7261 6765       for storage
+0002cfb0: 5f6f 626a 2069 6e20 746d 705f 6d75 6c74  _obj in tmp_mult
+0002cfc0: 6970 6c65 5f63 7573 746f 6d5f 736f 7572  iple_custom_sour
+0002cfd0: 6365 5f73 746f 7261 6765 5f6f 626a 3a0a  ce_storage_obj:.
+0002cfe0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002cff0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+0002d000: 6528 7374 6f72 655f 7479 7065 290a 2020  e(store_type).  
+0002d010: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002d020: 655f 6f62 6a5f 6e61 6d65 732e 6170 7065  e_obj_names.appe
+0002d030: 6e64 2873 746f 7261 6765 5f6f 626a 2e6e  nd(storage_obj.n
+0002d040: 616d 6529 0a0a 2020 2020 2020 2020 2320  ame)..        # 
+0002d050: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0002d060: 6c73 2074 6f20 6368 6563 6b20 6966 2061  ls to check if a
+0002d070: 6c6c 2073 746f 7261 6765 206f 626a 6563  ll storage objec
+0002d080: 7473 2065 7869 7374 7320 696e 2074 6865  ts exists in the
+0002d090: 0a20 2020 2020 2020 2023 206f 7574 7075  .        # outpu
+0002d0a0: 7420 6669 6c74 6572 6564 2062 7920 7374  t filtered by st
+0002d0b0: 6f72 6520 7479 7065 0a20 2020 2020 2020  ore type.       
+0002d0c0: 206f 7574 5f61 6c6c 203d 2073 7562 7072   out_all = subpr
+0002d0d0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002d0e0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002d0f0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002d100: 2020 2020 206f 7574 203d 205b 0a20 2020       out = [.   
+0002d110: 2020 2020 2020 2020 2069 7465 6d2e 7370           item.sp
+0002d120: 6c69 7428 295b 305d 0a20 2020 2020 2020  lit()[0].       
+0002d130: 2020 2020 2066 6f72 2069 7465 6d20 696e       for item in
+0002d140: 206f 7574 5f61 6c6c 2e64 6563 6f64 6528   out_all.decode(
+0002d150: 2775 7466 2d38 2729 2e73 706c 6974 6c69  'utf-8').splitli
+0002d160: 6e65 7328 290a 2020 2020 2020 2020 2020  nes().          
+0002d170: 2020 6966 2073 746f 7265 5f74 7970 652e    if store_type.
+0002d180: 7661 6c75 6520 696e 2069 7465 6d0a 2020  value in item.  
+0002d190: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0002d1a0: 6173 7365 7274 2061 6c6c 285b 6974 656d  assert all([item
+0002d1b0: 2069 6e20 6f75 7420 666f 7220 6974 656d   in out for item
+0002d1c0: 2069 6e20 7374 6f72 6167 655f 6f62 6a5f   in storage_obj_
+0002d1d0: 6e61 6d65 735d 290a 0a20 2020 2040 7079  names])..    @py
+0002d1e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+0002d1f0: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
+0002d200: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+0002d210: 7269 7a65 2827 7374 6f72 655f 7479 7065  rize('store_type
+0002d220: 272c 205b 0a20 2020 2020 2020 2073 746f  ', [.        sto
+0002d230: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002d240: 7065 2e53 332c 2073 746f 7261 6765 5f6c  pe.S3, storage_l
+0002d250: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+0002d260: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
+0002d270: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
+0002d280: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+0002d290: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002d2a0: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
+0002d2b0: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
+0002d2c0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002d2d0: 5479 7065 2e52 322c 206d 6172 6b73 3d70  Type.R2, marks=p
+0002d2e0: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
+0002d2f0: 666c 6172 6529 0a20 2020 205d 290a 2020  flare).    ]).  
+0002d300: 2020 6465 6620 7465 7374 5f62 7563 6b65    def test_bucke
+0002d310: 745f 6578 7465 726e 616c 5f64 656c 6574  t_external_delet
+0002d320: 696f 6e28 7365 6c66 2c20 746d 705f 7363  ion(self, tmp_sc
+0002d330: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002d340: 6a2c 0a20 2020 2020 2020 2020 2020 2020  j,.             
+0002d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d360: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
+0002d370: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
+0002d380: 4372 6561 7465 7320 6120 6275 636b 6574  Creates a bucket
+0002d390: 2c20 6465 6c65 7465 7320 6974 2065 7874  , deletes it ext
+0002d3a0: 6572 6e61 6c6c 7920 7573 696e 6720 636c  ernally using cl
+0002d3b0: 6f75 6420 636c 6920 636f 6d6d 616e 6473  oud cli commands
+0002d3c0: 0a20 2020 2020 2020 2023 2061 6e64 2074  .        # and t
+0002d3d0: 6865 6e20 7472 6965 7320 746f 2064 656c  hen tries to del
+0002d3e0: 6574 6520 6974 2075 7369 6e67 2073 6b79  ete it using sky
+0002d3f0: 2073 746f 7261 6765 2064 656c 6574 652e   storage delete.
+0002d400: 0a20 2020 2020 2020 2074 6d70 5f73 6372  .        tmp_scr
+0002d410: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002d420: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
+0002d430: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
+0002d440: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
+0002d450: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
+0002d460: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002d470: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
+0002d480: 7470 7574 0a20 2020 2020 2020 206f 7574  tput.        out
+0002d490: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0002d4a0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0002d4b0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0002d4c0: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
+0002d4d0: 6572 7420 746d 705f 7363 7261 7463 685f  ert tmp_scratch_
+0002d4e0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002d4f0: 2069 6e20 6f75 742e 6465 636f 6465 2827   in out.decode('
+0002d500: 7574 662d 3827 290a 0a20 2020 2020 2020  utf-8')..       
+0002d510: 2023 2044 656c 6574 6520 6275 636b 6574   # Delete bucket
+0002d520: 2065 7874 6572 6e61 6c6c 790a 2020 2020   externally.    
+0002d530: 2020 2020 636d 6420 3d20 7365 6c66 2e63      cmd = self.c
+0002d540: 6c69 5f64 656c 6574 655f 636d 6428 7374  li_delete_cmd(st
+0002d550: 6f72 655f 7479 7065 2c20 746d 705f 7363  ore_type, tmp_sc
+0002d560: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002d570: 6a2e 6e61 6d65 290a 2020 2020 2020 2020  j.name).        
+0002d580: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0002d590: 5f6f 7574 7075 7428 636d 642c 2073 6865  _output(cmd, she
+0002d5a0: 6c6c 3d54 7275 6529 0a0a 2020 2020 2020  ll=True)..      
+0002d5b0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002d5c0: 6167 6520 6465 6c65 7465 2074 6f20 6465  age delete to de
+0002d5d0: 6c65 7465 2074 6865 2073 746f 7261 6765  lete the storage
+0002d5e0: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
+0002d5f0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+0002d600: 2e63 6865 636b 5f6f 7574 7075 7428 0a20  .check_output(. 
+0002d610: 2020 2020 2020 2020 2020 205b 2773 6b79             ['sky
+0002d620: 272c 2027 7374 6f72 6167 6527 2c20 2764  ', 'storage', 'd
+0002d630: 656c 6574 6527 2c20 746d 705f 7363 7261  elete', tmp_scra
+0002d640: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
+0002d650: 6e61 6d65 2c20 272d 2d79 6573 275d 290a  name, '--yes']).
+0002d660: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+0002d670: 7572 6520 6275 636b 6574 2077 6173 206e  ure bucket was n
+0002d680: 6f74 2063 7265 6174 6564 2064 7572 696e  ot created durin
+0002d690: 6720 6465 6c65 7469 6f6e 2028 7365 6520  g deletion (see 
+0002d6a0: 6973 7375 6520 2331 3332 3229 0a20 2020  issue #1322).   
+0002d6b0: 2020 2020 2061 7373 6572 7420 2763 7265       assert 'cre
+0002d6c0: 6174 6564 2720 6e6f 7420 696e 206f 7574  ated' not in out
+0002d6d0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002d6e0: 2e6c 6f77 6572 2829 0a0a 2020 2020 2020  .lower()..      
+0002d6f0: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002d700: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0002d710: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0002d720: 7420 6973 2064 656c 6574 6564 0a20 2020  t is deleted.   
+0002d730: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002d740: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002d750: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002d760: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002d770: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0002d780: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
+0002d790: 6f62 6a2e 6e61 6d65 206e 6f74 2069 6e20  obj.name not in 
+0002d7a0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0002d7b0: 3827 290a 0a20 2020 2040 7079 7465 7374  8')..    @pytest
+0002d7c0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+0002d7d0: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
+0002d7e0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+0002d7f0: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
+0002d800: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002d810: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0002d820: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
+0002d830: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
+0002d840: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002d850: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
+0002d860: 746f 7265 5479 7065 2e49 424d 2c20 6d61  toreType.IBM, ma
+0002d870: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0002d880: 6962 6d29 2c0a 2020 2020 2020 2020 7079  ibm),.        py
+0002d890: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
+0002d8a0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002d8b0: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
+0002d8c0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0002d8d0: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
+0002d8e0: 6620 7465 7374 5f62 7563 6b65 745f 6275  f test_bucket_bu
+0002d8f0: 6c6b 5f64 656c 6574 696f 6e28 7365 6c66  lk_deletion(self
+0002d900: 2c20 7374 6f72 655f 7479 7065 2c20 746d  , store_type, tm
+0002d910: 705f 6275 6c6b 5f64 656c 5f73 746f 7261  p_bulk_del_stora
+0002d920: 6765 5f6f 626a 293a 0a20 2020 2020 2020  ge_obj):.       
+0002d930: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002d940: 7020 666f 6c64 6572 2077 6974 6820 6f76  p folder with ov
+0002d950: 6572 2032 3536 2066 696c 6573 2061 6e64  er 256 files and
+0002d960: 2066 6f6c 6465 7273 2c20 7570 6c6f 6164   folders, upload
+0002d970: 0a20 2020 2020 2020 2023 2066 696c 6573  .        # files
+0002d980: 2061 6e64 2066 6f6c 6465 7273 2074 6f20   and folders to 
+0002d990: 6120 6e65 7720 6275 636b 6574 2c20 7468  a new bucket, th
+0002d9a0: 656e 2064 656c 6574 6520 6275 636b 6574  en delete bucket
+0002d9b0: 2e0a 2020 2020 2020 2020 746d 705f 6275  ..        tmp_bu
+0002d9c0: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
+0002d9d0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0002d9e0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+0002d9f0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002da00: 636b 5f6f 7574 7075 7428 5b0a 2020 2020  ck_output([.    
+0002da10: 2020 2020 2020 2020 2773 6b79 272c 2027          'sky', '
+0002da20: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
+0002da30: 6527 2c20 746d 705f 6275 6c6b 5f64 656c  e', tmp_bulk_del
+0002da40: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002da50: 652c 2027 2d2d 7965 7327 0a20 2020 2020  e, '--yes'.     
+0002da60: 2020 205d 290a 0a20 2020 2020 2020 206f     ])..        o
+0002da70: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
+0002da80: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002da90: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002daa0: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0002dab0: 2020 6173 7365 7274 2074 6d70 5f62 756c    assert tmp_bul
+0002dac0: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
+0002dad0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+0002dae0: 7470 7574 2e64 6563 6f64 6528 2775 7466  tput.decode('utf
+0002daf0: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
+0002db00: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0002db10: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
+0002db20: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+0002db30: 6528 0a20 2020 2020 2020 2027 746d 705f  e(.        'tmp_
+0002db40: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
+0002db50: 626a 2c20 7374 6f72 655f 7479 7065 272c  bj, store_type',
+0002db60: 0a20 2020 2020 2020 205b 2827 7333 3a2f  .        [('s3:/
+0002db70: 2f74 6367 612d 322d 6f70 656e 272c 2073  /tcga-2-open', s
+0002db80: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0002db90: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
+0002dba0: 2020 2028 2773 333a 2f2f 6469 6769 7461     ('s3://digita
+0002dbb0: 6c63 6f72 706f 7261 272c 2073 746f 7261  lcorpora', stora
+0002dbc0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002dbd0: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
+0002dbe0: 2767 733a 2f2f 6763 702d 7075 626c 6963  'gs://gcp-public
+0002dbf0: 2d64 6174 612d 7365 6e74 696e 656c 2d32  -data-sentinel-2
+0002dc00: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
+0002dc10: 746f 7265 5479 7065 2e47 4353 295d 2c0a  toreType.GCS)],.
+0002dc20: 2020 2020 2020 2020 696e 6469 7265 6374          indirect
+0002dc30: 3d5b 2774 6d70 5f70 7562 6c69 635f 7374  =['tmp_public_st
+0002dc40: 6f72 6167 655f 6f62 6a27 5d29 0a20 2020  orage_obj']).   
+0002dc50: 2064 6566 2074 6573 745f 7075 626c 6963   def test_public
+0002dc60: 5f62 7563 6b65 7428 7365 6c66 2c20 746d  _bucket(self, tm
+0002dc70: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
+0002dc80: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
+0002dc90: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002dca0: 6174 6573 2061 206e 6577 2062 7563 6b65  ates a new bucke
+0002dcb0: 7420 7769 7468 2061 2070 7562 6c69 6320  t with a public 
+0002dcc0: 736f 7572 6365 2061 6e64 2076 6572 6966  source and verif
+0002dcd0: 6965 7320 7468 6174 2069 7420 6973 206e  ies that it is n
+0002dce0: 6f74 0a20 2020 2020 2020 2023 2061 6464  ot.        # add
+0002dcf0: 6564 2074 6f20 676c 6f62 616c 5f75 7365  ed to global_use
+0002dd00: 725f 7374 6174 652e 0a20 2020 2020 2020  r_state..       
+0002dd10: 2074 6d70 5f70 7562 6c69 635f 7374 6f72   tmp_public_stor
+0002dd20: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+0002dd30: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+0002dd40: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0002dd50: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
+0002dd60: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
+0002dd70: 6f62 6a65 6374 2065 7869 7374 7320 696e  object exists in
+0002dd80: 2074 6865 206f 7574 7075 740a 2020 2020   the output.    
+0002dd90: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+0002dda0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0002ddb0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+0002ddc0: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
+0002ddd0: 2020 2020 6173 7365 7274 2074 6d70 5f70      assert tmp_p
+0002dde0: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+0002ddf0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+0002de00: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002de10: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+0002de20: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002de30: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002de40: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
+0002de50: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002de60: 7572 6c27 2c20 5b0a 2020 2020 2020 2020  url', [.        
+0002de70: 2773 333a 2f2f 7b72 616e 646f 6d5f 6e61  's3://{random_na
+0002de80: 6d65 7d27 2c20 2767 733a 2f2f 7b72 616e  me}', 'gs://{ran
+0002de90: 646f 6d5f 6e61 6d65 7d27 2c0a 2020 2020  dom_name}',.    
+0002dea0: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
+0002deb0: 2827 636f 733a 2f2f 7573 2d65 6173 742f  ('cos://us-east/
+0002dec0: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
+0002ded0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+0002dee0: 6b2e 6962 6d29 2c0a 2020 2020 2020 2020  k.ibm),.        
+0002def0: 7079 7465 7374 2e70 6172 616d 2827 7232  pytest.param('r2
+0002df00: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
+0002df10: 272c 206d 6172 6b73 3d70 7974 6573 742e  ', marks=pytest.
+0002df20: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0002df30: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+0002df40: 7465 7374 5f6e 6f6e 6578 6973 7465 6e74  test_nonexistent
+0002df50: 5f62 7563 6b65 7428 7365 6c66 2c20 6e6f  _bucket(self, no
+0002df60: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0002df70: 6c29 3a0a 2020 2020 2020 2020 2320 4174  l):.        # At
+0002df80: 7465 6d70 7473 2074 6f20 6372 6561 7465  tempts to create
+0002df90: 2066 6574 6368 2061 2073 7472 6f61 6765   fetch a stroage
+0002dfa0: 2077 6974 6820 6120 6e6f 6e2d 6578 6973   with a non-exis
+0002dfb0: 7465 6e74 2073 6f75 7263 652e 0a20 2020  tent source..   
+0002dfc0: 2020 2020 2023 2047 656e 6572 6174 6520       # Generate 
+0002dfd0: 6120 7261 6e64 6f6d 2062 7563 6b65 7420  a random bucket 
+0002dfe0: 6e61 6d65 2061 6e64 2076 6572 6966 7920  name and verify 
+0002dff0: 6974 2064 6f65 736e 2774 2065 7869 7374  it doesn't exist
+0002e000: 3a0a 2020 2020 2020 2020 7265 7472 795f  :.        retry_
+0002e010: 636f 756e 7420 3d20 300a 2020 2020 2020  count = 0.      
+0002e020: 2020 7768 696c 6520 5472 7565 3a0a 2020    while True:.  
+0002e030: 2020 2020 2020 2020 2020 6e6f 6e65 7869            nonexi
+0002e040: 7374 5f62 7563 6b65 745f 6e61 6d65 203d  st_bucket_name =
+0002e050: 2073 7472 2875 7569 642e 7575 6964 3428   str(uuid.uuid4(
+0002e060: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
+0002e070: 6620 6e6f 6e65 7869 7374 5f62 7563 6b65  f nonexist_bucke
+0002e080: 745f 7572 6c2e 7374 6172 7473 7769 7468  t_url.startswith
+0002e090: 2827 7333 2729 3a0a 2020 2020 2020 2020  ('s3'):.        
+0002e0a0: 2020 2020 2020 2020 636f 6d6d 616e 6420          command 
+0002e0b0: 3d20 6627 6177 7320 7333 6170 6920 6865  = f'aws s3api he
+0002e0c0: 6164 2d62 7563 6b65 7420 2d2d 6275 636b  ad-bucket --buck
+0002e0d0: 6574 207b 6e6f 6e65 7869 7374 5f62 7563  et {nonexist_buc
+0002e0e0: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
+0002e0f0: 2020 2020 2020 2020 2020 2065 7870 6563             expec
+0002e100: 7465 645f 6f75 7470 7574 203d 2027 3430  ted_output = '40
+0002e110: 3427 0a20 2020 2020 2020 2020 2020 2065  4'.            e
+0002e120: 6c69 6620 6e6f 6e65 7869 7374 5f62 7563  lif nonexist_buc
+0002e130: 6b65 745f 7572 6c2e 7374 6172 7473 7769  ket_url.startswi
+0002e140: 7468 2827 6773 2729 3a0a 2020 2020 2020  th('gs'):.      
+0002e150: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+0002e160: 6420 3d20 6627 6773 7574 696c 206c 7320  d = f'gsutil ls 
+0002e170: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
+0002e180: 5f75 726c 2e66 6f72 6d61 7428 7261 6e64  _url.format(rand
+0002e190: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
+0002e1a0: 5f62 7563 6b65 745f 6e61 6d65 297d 270a  _bucket_name)}'.
+0002e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e1c0: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+0002e1d0: 3d20 2742 7563 6b65 744e 6f74 466f 756e  = 'BucketNotFoun
+0002e1e0: 6445 7863 6570 7469 6f6e 270a 2020 2020  dException'.    
+0002e1f0: 2020 2020 2020 2020 656c 6966 206e 6f6e          elif non
+0002e200: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
+0002e210: 2e73 7461 7274 7377 6974 6828 2772 3227  .startswith('r2'
+0002e220: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002e230: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
+0002e240: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
+0002e250: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
+0002e260: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002e270: 6f6d 6d61 6e64 203d 2066 2741 5753 5f53  ommand = f'AWS_S
+0002e280: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
+0002e290: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
+0002e2a0: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
+0002e2b0: 535f 5041 5448 7d20 6177 7320 7333 6170  S_PATH} aws s3ap
+0002e2c0: 6920 6865 6164 2d62 7563 6b65 7420 2d2d  i head-bucket --
+0002e2d0: 6275 636b 6574 207b 6e6f 6e65 7869 7374  bucket {nonexist
+0002e2e0: 5f62 7563 6b65 745f 6e61 6d65 7d20 2d2d  _bucket_name} --
+0002e2f0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
+0002e300: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
+0002e310: 653d 7232 270a 2020 2020 2020 2020 2020  e=r2'.          
+0002e320: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
+0002e330: 7574 7075 7420 3d20 2734 3034 270a 2020  utput = '404'.  
+0002e340: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+0002e350: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+0002e360: 726c 2e73 7461 7274 7377 6974 6828 2763  rl.startswith('c
+0002e370: 6f73 2729 3a0a 2020 2020 2020 2020 2020  os'):.          
+0002e380: 2020 2020 2020 2320 5573 696e 6720 4150        # Using AP
+0002e390: 4920 6361 6c6c 732c 2073 696e 6365 2075  I calls, since u
+0002e3a0: 7369 6e67 2072 636c 6f6e 6520 7265 7175  sing rclone requ
+0002e3b0: 6972 6573 2061 2070 726f 6669 6c65 2773  ires a profile's
+0002e3c0: 206e 616d 650a 2020 2020 2020 2020 2020   name.          
+0002e3d0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0002e3e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002e3f0: 7870 6563 7465 645f 6f75 7470 7574 203d  xpected_output =
+0002e400: 2063 6f6d 6d61 6e64 203d 2022 6563 686f   command = "echo
+0002e410: 2220 2023 2061 766f 6964 2075 6e72 656c  "  # avoid unrel
+0002e420: 6174 6564 2065 7863 6570 7469 6f6e 2069  ated exception i
+0002e430: 6e20 6361 7365 206f 6620 6661 696c 7572  n case of failur
+0002e440: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+0002e450: 2020 2020 2020 2062 7563 6b65 745f 6e61         bucket_na
+0002e460: 6d65 203d 2075 726c 6c69 622e 7061 7273  me = urllib.pars
+0002e470: 652e 7572 6c73 706c 6974 280a 2020 2020  e.urlsplit(.    
+0002e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e490: 2020 2020 6e6f 6e65 7869 7374 5f62 7563      nonexist_buc
+0002e4a0: 6b65 745f 7572 6c2e 666f 726d 6174 280a  ket_url.format(.
+0002e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4c0: 2020 2020 2020 2020 2020 2020 7261 6e64              rand
+0002e4d0: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
+0002e4e0: 5f62 7563 6b65 745f 6e61 6d65 2929 2e70  _bucket_name)).p
+0002e4f0: 6174 682e 7374 7269 7028 272f 2729 0a20  ath.strip('/'). 
+0002e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e510: 2020 2063 6c69 656e 7420 3d20 6962 6d2e     client = ibm.
+0002e520: 6765 745f 636f 735f 636c 6965 6e74 2827  get_cos_client('
+0002e530: 7573 2d65 6173 7427 290a 2020 2020 2020  us-east').      
+0002e540: 2020 2020 2020 2020 2020 2020 2020 636c                cl
+0002e550: 6965 6e74 2e68 6561 645f 6275 636b 6574  ient.head_bucket
+0002e560: 2842 7563 6b65 743d 6275 636b 6574 5f6e  (Bucket=bucket_n
+0002e570: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0002e580: 2020 2020 2065 7863 6570 7420 6962 6d2e       except ibm.
+0002e590: 6962 6d5f 626f 746f 636f 7265 2e65 7863  ibm_botocore.exc
+0002e5a0: 6570 7469 6f6e 732e 436c 6965 6e74 4572  eptions.ClientEr
+0002e5b0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+0002e5c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002e5d0: 2065 2e72 6573 706f 6e73 655b 2745 7272   e.response['Err
+0002e5e0: 6f72 275d 5b27 436f 6465 275d 203d 3d20  or']['Code'] == 
+0002e5f0: 2734 3034 273a 0a20 2020 2020 2020 2020  '404':.         
+0002e600: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002e610: 2073 7563 6365 7373 0a20 2020 2020 2020   success.       
+0002e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e630: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0002e640: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002e650: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0002e660: 5661 6c75 6545 7272 6f72 2827 556e 7375  ValueError('Unsu
+0002e670: 7070 6f72 7465 6420 6275 636b 6574 2074  pported bucket t
+0002e680: 7970 6520 270a 2020 2020 2020 2020 2020  ype '.          
+0002e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6a0: 2020 2020 2020 2066 277b 6e6f 6e65 7869         f'{nonexi
+0002e6b0: 7374 5f62 7563 6b65 745f 7572 6c7d 2729  st_bucket_url}')
+0002e6c0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0002e6d0: 4368 6563 6b20 6966 2062 7563 6b65 7420  Check if bucket 
+0002e6e0: 6578 6973 7473 2075 7369 6e67 2074 6865  exists using the
+0002e6f0: 2063 6c69 3a0a 2020 2020 2020 2020 2020   cli:.          
+0002e700: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0002e710: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+0002e720: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+0002e730: 7470 7574 2863 6f6d 6d61 6e64 2c0a 2020  tput(command,.  
+0002e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e760: 2020 2020 2020 2020 2020 2020 7374 6465              stde
+0002e770: 7272 3d73 7562 7072 6f63 6573 732e 5354  rr=subprocess.ST
+0002e780: 444f 5554 2c0a 2020 2020 2020 2020 2020  DOUT,.          
+0002e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e7b0: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0002e7c0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002e7d0: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
+0002e7e0: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
+0002e7f0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0002e800: 2020 2020 2020 206f 7574 203d 2065 2e6f         out = e.o
+0002e810: 7574 7075 740a 2020 2020 2020 2020 2020  utput.          
+0002e820: 2020 6f75 7420 3d20 6f75 742e 6465 636f    out = out.deco
+0002e830: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+0002e840: 2020 2020 2020 2020 6966 2065 7870 6563          if expec
+0002e850: 7465 645f 6f75 7470 7574 2069 6e20 6f75  ted_output in ou
+0002e860: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0002e870: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+0002e880: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002e890: 2020 2020 2020 2020 2020 2072 6574 7279             retry
+0002e8a0: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
+0002e8b0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0002e8c0: 6574 7279 5f63 6f75 6e74 203e 2033 3a0a  etry_count > 3:.
+0002e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e8e0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+0002e8f0: 6545 7272 6f72 2827 556e 6162 6c65 2074  eError('Unable t
+0002e900: 6f20 6669 6e64 2061 206e 6f6e 6578 6973  o find a nonexis
+0002e910: 7465 6e74 2062 7563 6b65 7420 270a 2020  tent bucket '.  
+0002e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e940: 2020 2020 2027 746f 2075 7365 2e20 5468       'to use. Th
+0002e950: 6973 2069 7320 6869 676c 7920 756e 6c69  is is higly unli
+0002e960: 6b65 6c79 202d 2027 0a20 2020 2020 2020  kely - '.       
+0002e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e990: 2763 6865 636b 2069 6620 7468 6520 7465  'check if the te
+0002e9a0: 7374 7320 6172 6520 636f 7272 6563 742e  sts are correct.
+0002e9b0: 2729 0a0a 2020 2020 2020 2020 7769 7468  ')..        with
+0002e9c0: 2070 7974 6573 742e 7261 6973 6573 280a   pytest.raises(.
+0002e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e9e0: 736b 792e 6578 6365 7074 696f 6e73 2e53  sky.exceptions.S
+0002e9f0: 746f 7261 6765 4275 636b 6574 4765 7445  torageBucketGetE
+0002ea00: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
+0002ea10: 2020 2020 2020 6d61 7463 683d 2741 7474        match='Att
+0002ea20: 656d 7074 6564 2074 6f20 7573 6520 6120  empted to use a 
+0002ea30: 6e6f 6e2d 6578 6973 7465 6e74 2062 7563  non-existent buc
+0002ea40: 6b65 7420 6173 2061 2073 6f75 7263 6527  ket as a source'
+0002ea50: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0002ea60: 746f 7261 6765 5f6f 626a 203d 2073 746f  torage_obj = sto
+0002ea70: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
+0002ea80: 2873 6f75 7263 653d 6e6f 6e65 7869 7374  (source=nonexist
+0002ea90: 5f62 7563 6b65 745f 7572 6c2e 666f 726d  _bucket_url.form
+0002eaa0: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
+0002eab0: 2020 2020 7261 6e64 6f6d 5f6e 616d 653d      random_name=
+0002eac0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0002ead0: 6e61 6d65 2929 0a0a 2020 2020 4070 7974  name))..    @pyt
+0002eae0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0002eaf0: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+0002eb00: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0002eb10: 697a 6528 2770 7269 7661 7465 5f62 7563  ize('private_buc
+0002eb20: 6b65 7427 2c20 5b0a 2020 2020 2020 2020  ket', [.        
+0002eb30: 6627 7333 3a2f 2f69 6d61 6765 6e65 7427  f's3://imagenet'
+0002eb40: 2c20 6627 6773 3a2f 2f69 6d61 6765 6e65  , f'gs://imagene
+0002eb50: 7427 2c0a 2020 2020 2020 2020 7079 7465  t',.        pyte
+0002eb60: 7374 2e70 6172 616d 2827 636f 733a 2f2f  st.param('cos://
+0002eb70: 7573 2d65 6173 742f 6275 636b 6574 3127  us-east/bucket1'
+0002eb80: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0002eb90: 6172 6b2e 6962 6d29 0a20 2020 205d 290a  ark.ibm).    ]).
+0002eba0: 2020 2020 6465 6620 7465 7374 5f70 7269      def test_pri
+0002ebb0: 7661 7465 5f62 7563 6b65 7428 7365 6c66  vate_bucket(self
+0002ebc0: 2c20 7072 6976 6174 655f 6275 636b 6574  , private_bucket
+0002ebd0: 293a 0a20 2020 2020 2020 2023 2041 7474  ):.        # Att
+0002ebe0: 656d 7074 7320 746f 2061 6363 6573 7320  empts to access 
+0002ebf0: 7072 6976 6174 6520 6275 636b 6574 7320  private buckets 
+0002ec00: 6e6f 7420 6265 6c6f 6e67 696e 6720 746f  not belonging to
+0002ec10: 2074 6865 2075 7365 722e 0a20 2020 2020   the user..     
+0002ec20: 2020 2023 2054 6865 7365 2062 7563 6b65     # These bucke
+0002ec30: 7473 2061 7265 206b 6e6f 776e 2074 6f20  ts are known to 
+0002ec40: 6265 2070 7269 7661 7465 2c20 6275 7420  be private, but 
+0002ec50: 6d61 7920 6e65 6564 2074 6f20 6265 2075  may need to be u
+0002ec60: 7064 6174 6564 2069 660a 2020 2020 2020  pdated if.      
+0002ec70: 2020 2320 7468 6579 2061 7265 2072 656d    # they are rem
+0002ec80: 6f76 6564 2062 7920 7468 6569 7220 6f77  oved by their ow
+0002ec90: 6e65 7273 2e0a 2020 2020 2020 2020 7072  ners..        pr
+0002eca0: 6976 6174 655f 6275 636b 6574 5f6e 616d  ivate_bucket_nam
+0002ecb0: 6520 3d20 7572 6c6c 6962 2e70 6172 7365  e = urllib.parse
+0002ecc0: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
+0002ecd0: 655f 6275 636b 6574 292e 6e65 746c 6f63  e_bucket).netloc
+0002ece0: 2069 6620 5c0a 2020 2020 2020 2020 2020   if \.          
+0002ecf0: 2020 2020 7572 6c6c 6962 2e70 6172 7365      urllib.parse
+0002ed00: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
+0002ed10: 655f 6275 636b 6574 292e 7363 6865 6d65  e_bucket).scheme
+0002ed20: 2021 3d20 2763 6f73 2720 656c 7365 205c   != 'cos' else \
+0002ed30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ed40: 2020 2075 726c 6c69 622e 7061 7273 652e     urllib.parse.
+0002ed50: 7572 6c73 706c 6974 2870 7269 7661 7465  urlsplit(private
+0002ed60: 5f62 7563 6b65 7429 2e70 6174 682e 7374  _bucket).path.st
+0002ed70: 7269 7028 272f 2729 0a20 2020 2020 2020  rip('/').       
+0002ed80: 2077 6974 6820 7079 7465 7374 2e72 6169   with pytest.rai
+0002ed90: 7365 7328 0a20 2020 2020 2020 2020 2020  ses(.           
+0002eda0: 2020 2020 2073 6b79 2e65 7863 6570 7469       sky.excepti
+0002edb0: 6f6e 732e 5374 6f72 6167 6542 7563 6b65  ons.StorageBucke
+0002edc0: 7447 6574 4572 726f 722c 0a20 2020 2020  tGetError,.     
+0002edd0: 2020 2020 2020 2020 2020 206d 6174 6368             match
+0002ede0: 3d73 746f 7261 6765 5f6c 6962 2e5f 4255  =storage_lib._BU
+0002edf0: 434b 4554 5f46 4149 4c5f 544f 5f43 4f4e  CKET_FAIL_TO_CON
+0002ee00: 4e45 4354 5f4d 4553 5341 4745 2e66 6f72  NECT_MESSAGE.for
+0002ee10: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+0002ee20: 2020 2020 2020 2020 206e 616d 653d 7072           name=pr
+0002ee30: 6976 6174 655f 6275 636b 6574 5f6e 616d  ivate_bucket_nam
+0002ee40: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
+0002ee50: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
+0002ee60: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
+0002ee70: 6765 2873 6f75 7263 653d 7072 6976 6174  ge(source=privat
+0002ee80: 655f 6275 636b 6574 290a 0a20 2020 2040  e_bucket)..    @
+0002ee90: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0002eea0: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
+0002eeb0: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0002eec0: 6574 7269 7a65 2827 6578 745f 6275 636b  etrize('ext_buck
+0002eed0: 6574 5f66 6978 7475 7265 2c20 7374 6f72  et_fixture, stor
+0002eee0: 655f 7479 7065 272c 0a20 2020 2020 2020  e_type',.       
+0002eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef00: 2020 2020 2020 5b28 2774 6d70 5f61 7773        [('tmp_aws
+0002ef10: 636c 695f 6275 636b 6574 272c 2073 746f  cli_bucket', sto
+0002ef20: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002ef30: 7065 2e53 3329 2c0a 2020 2020 2020 2020  pe.S3),.        
+0002ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef50: 2020 2020 2020 2827 746d 705f 6773 7574        ('tmp_gsut
+0002ef60: 696c 5f62 7563 6b65 7427 2c20 7374 6f72  il_bucket', stor
+0002ef70: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002ef80: 652e 4743 5329 2c0a 2020 2020 2020 2020  e.GCS),.        
+0002ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002efa0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
+0002efb0: 616d 2827 746d 705f 6962 6d5f 636f 735f  am('tmp_ibm_cos_
+0002efc0: 6275 636b 6574 272c 0a20 2020 2020 2020  bucket',.       
+0002efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eff0: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+0002f000: 5374 6f72 6554 7970 652e 4942 4d2c 0a20  StoreType.IBM,. 
+0002f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f030: 2020 2020 2020 2020 2020 6d61 726b 733d            marks=
+0002f040: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
+0002f050: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f070: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
+0002f080: 705f 6177 7363 6c69 5f62 7563 6b65 745f  p_awscli_bucket_
+0002f090: 7232 272c 0a20 2020 2020 2020 2020 2020  r2',.           
+0002f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0c0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002f0d0: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
+0002f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f100: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
+0002f110: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0002f120: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
+0002f130: 745f 7570 6c6f 6164 5f74 6f5f 6578 6973  t_upload_to_exis
+0002f140: 7469 6e67 5f62 7563 6b65 7428 7365 6c66  ting_bucket(self
+0002f150: 2c20 6578 745f 6275 636b 6574 5f66 6978  , ext_bucket_fix
+0002f160: 7475 7265 2c20 7265 7175 6573 742c 0a20  ture, request,. 
+0002f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f190: 2020 2020 2020 746d 705f 736f 7572 6365        tmp_source
+0002f1a0: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
+0002f1b0: 2020 2020 2020 2023 2054 7269 6573 2075         # Tries u
+0002f1c0: 706c 6f61 6469 6e67 2065 7869 7374 696e  ploading existin
+0002f1d0: 6720 6669 6c65 7320 746f 206e 6577 6c79  g files to newly
+0002f1e0: 2063 7265 6174 6564 2062 7563 6b65 7420   created bucket 
+0002f1f0: 286f 7574 7369 6465 206f 660a 2020 2020  (outside of.    
+0002f200: 2020 2020 2320 736b 7929 2061 6e64 2076      # sky) and v
+0002f210: 6572 6966 6965 7320 7468 6174 2066 696c  erifies that fil
+0002f220: 6573 2061 7265 2077 7269 7474 656e 2e0a  es are written..
+0002f230: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
+0002f240: 616d 652c 205f 203d 2072 6571 7565 7374  ame, _ = request
+0002f250: 2e67 6574 6669 7874 7572 6576 616c 7565  .getfixturevalue
+0002f260: 2865 7874 5f62 7563 6b65 745f 6669 7874  (ext_bucket_fixt
+0002f270: 7572 6529 0a20 2020 2020 2020 2073 746f  ure).        sto
+0002f280: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+0002f290: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
+0002f2a0: 616d 653d 6275 636b 6574 5f6e 616d 652c  ame=bucket_name,
+0002f2b0: 2073 6f75 7263 653d 746d 705f 736f 7572   source=tmp_sour
+0002f2c0: 6365 290a 2020 2020 2020 2020 7374 6f72  ce).        stor
+0002f2d0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+0002f2e0: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
+0002f2f0: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
+0002f300: 6620 746d 705f 736f 7572 6365 2f74 6d70  f tmp_source/tmp
+0002f310: 2d66 696c 6520 6578 6973 7473 2069 6e20  -file exists in 
+0002f320: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
+0002f330: 2061 7773 2063 6c69 0a20 2020 2020 2020   aws cli.       
+0002f340: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002f350: 732e 6368 6563 6b5f 6f75 7470 7574 2873  s.check_output(s
+0002f360: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
+0002f370: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+0002f380: 745f 6e61 6d65 292c 0a20 2020 2020 2020  t_name),.       
+0002f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002f3b0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+0002f3c0: 2020 2061 7373 6572 7420 2774 6d70 2d66     assert 'tmp-f
+0002f3d0: 696c 6527 2069 6e20 6f75 742e 6465 636f  ile' in out.deco
+0002f3e0: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
+0002f3f0: 2020 2020 2020 2020 2020 2027 4669 6c65             'File
+0002f400: 206e 6f74 2066 6f75 6e64 2069 6e20 6275   not found in bu
+0002f410: 636b 6574 202d 206f 7574 7075 7420 7761  cket - output wa
+0002f420: 7320 3a20 7b7d 272e 666f 726d 6174 286f  s : {}'.format(o
+0002f430: 7574 2e64 6563 6f64 650a 2020 2020 2020  ut.decode.      
 0002f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f450: 2020 2020 2020 2827 7574 662d 3827 2929        ('utf-8'))
-0002f460: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-0002f470: 6b20 7379 6d6c 696e 6b73 202d 2073 796d  k symlinks - sym
-0002f480: 6c69 6e6b 7320 646f 6e27 7420 6765 7420  links don't get 
-0002f490: 636f 7069 6564 2062 7920 736b 7920 7374  copied by sky st
-0002f4a0: 6f72 6167 650a 2020 2020 2020 2020 6173  orage.        as
-0002f4b0: 7365 7274 2028 7061 7468 6c69 622e 5061  sert (pathlib.Pa
-0002f4c0: 7468 2874 6d70 5f73 6f75 7263 6529 202f  th(tmp_source) /
-0002f4d0: 2027 6369 7263 6c65 2d6c 696e 6b27 292e   'circle-link').
-0002f4e0: 6973 5f73 796d 6c69 6e6b 2829 2c20 280a  is_symlink(), (.
-0002f4f0: 2020 2020 2020 2020 2020 2020 2763 6972              'cir
-0002f500: 636c 652d 6c69 6e6b 2077 6173 206e 6f74  cle-link was not
-0002f510: 2066 6f75 6e64 2069 6e20 7468 6520 7570   found in the up
-0002f520: 6c6f 6164 2073 6f75 7263 6520 2d20 270a  load source - '.
-0002f530: 2020 2020 2020 2020 2020 2020 2761 7265              'are
-0002f540: 2074 6865 2074 6573 7420 6669 7874 7572   the test fixtur
-0002f550: 6573 2063 6f72 7265 6374 3f27 290a 2020  es correct?').  
-0002f560: 2020 2020 2020 6173 7365 7274 2027 6369        assert 'ci
-0002f570: 7263 6c65 2d6c 696e 6b27 206e 6f74 2069  rcle-link' not i
-0002f580: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
-0002f590: 662d 3827 292c 2028 0a20 2020 2020 2020  f-8'), (.       
-0002f5a0: 2020 2020 2027 5379 6d6c 696e 6b20 666f       'Symlink fo
-0002f5b0: 756e 6420 696e 2062 7563 6b65 7420 2d20  und in bucket - 
-0002f5c0: 6c73 206f 7574 7075 7420 7761 7320 3a20  ls output was : 
-0002f5d0: 7b7d 272e 666f 726d 6174 280a 2020 2020  {}'.format(.    
-0002f5e0: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
-0002f5f0: 6465 636f 6465 2827 7574 662d 3827 2929  decode('utf-8'))
-0002f600: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002f610: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
-0002f620: 746f 2063 6865 636b 2069 6620 7374 6f72  to check if stor
-0002f630: 6167 6520 6f62 6a65 6374 2065 7869 7374  age object exist
-0002f640: 7320 696e 2074 6865 206f 7574 7075 742e  s in the output.
-0002f650: 0a20 2020 2020 2020 2023 2049 7420 7368  .        # It sh
-0002f660: 6f75 6c64 206e 6f74 2065 7869 7374 2062  ould not exist b
-0002f670: 6563 6175 7365 2074 6865 2062 7563 6b65  ecause the bucke
-0002f680: 7420 7761 7320 6372 6561 7465 6420 6578  t was created ex
-0002f690: 7465 726e 616c 6c79 2e0a 2020 2020 2020  ternally..      
-0002f6a0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-0002f6b0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0002f6c0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0002f6d0: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
-0002f6e0: 2020 6173 7365 7274 2073 746f 7261 6765    assert storage
-0002f6f0: 5f6f 626a 2e6e 616d 6520 6e6f 7420 696e  _obj.name not in
-0002f700: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-0002f710: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
-0002f720: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0002f730: 7461 636b 0a20 2020 2064 6566 2074 6573  tack.    def tes
-0002f740: 745f 636f 7079 5f6d 6f75 6e74 5f65 7869  t_copy_mount_exi
-0002f750: 7374 696e 675f 7374 6f72 6167 6528 7365  sting_storage(se
-0002f760: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-0002f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f780: 2020 2020 2020 2020 2020 2020 2074 6d70               tmp
-0002f790: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
-0002f7a0: 6e67 5f73 746f 7261 6765 5f6f 626a 293a  ng_storage_obj):
-0002f7b0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002f7c0: 6573 2061 2062 7563 6b65 7420 7769 7468  es a bucket with
-0002f7d0: 206e 6f20 736f 7572 6365 2069 6e20 4d4f   no source in MO
-0002f7e0: 554e 5420 6d6f 6465 2028 656d 7074 7920  UNT mode (empty 
-0002f7f0: 6275 636b 6574 292c 2061 6e64 0a20 2020  bucket), and.   
-0002f800: 2020 2020 2023 2074 6865 6e20 7472 6965       # then trie
-0002f810: 7320 746f 206c 6f61 6420 7468 6520 7361  s to load the sa
-0002f820: 6d65 2073 746f 7261 6765 2069 6e20 434f  me storage in CO
-0002f830: 5059 206d 6f64 652e 0a20 2020 2020 2020  PY mode..       
-0002f840: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
-0002f850: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
-0002f860: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0002f870: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002f880: 7065 2e53 3329 0a20 2020 2020 2020 2073  pe.S3).        s
-0002f890: 746f 7261 6765 5f6e 616d 6520 3d20 746d  torage_name = tm
-0002f8a0: 705f 636f 7079 5f6d 6e74 5f65 7869 7374  p_copy_mnt_exist
-0002f8b0: 696e 675f 7374 6f72 6167 655f 6f62 6a2e  ing_storage_obj.
-0002f8c0: 6e61 6d65 0a0a 2020 2020 2020 2020 2320  name..        # 
-0002f8d0: 4368 6563 6b20 6073 6b79 2073 746f 7261  Check `sky stora
-0002f8e0: 6765 206c 7360 2074 6f20 656e 7375 7265  ge ls` to ensure
-0002f8f0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002f900: 6578 6973 7473 0a20 2020 2020 2020 206f  exists.        o
-0002f910: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0002f920: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
-0002f930: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-0002f940: 276c 7327 5d29 2e64 6563 6f64 6528 2775  'ls']).decode('u
-0002f950: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
-0002f960: 7373 6572 7420 7374 6f72 6167 655f 6e61  ssert storage_na
-0002f970: 6d65 2069 6e20 6f75 742c 2066 2753 746f  me in out, f'Sto
-0002f980: 7261 6765 207b 7374 6f72 6167 655f 6e61  rage {storage_na
-0002f990: 6d65 7d20 6e6f 7420 666f 756e 6420 696e  me} not found in
-0002f9a0: 2073 6b79 2073 746f 7261 6765 206c 732e   sky storage ls.
-0002f9b0: 270a 0a20 2020 2040 7079 7465 7374 2e6d  '..    @pytest.m
-0002f9c0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002f9d0: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-0002f9e0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-0002f9f0: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
-0002fa00: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
-0002fa10: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
-0002fa20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002fa30: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
-0002fa40: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-0002fa50: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-0002fa60: 7265 5479 7065 2e49 424d 2c20 6d61 726b  reType.IBM, mark
-0002fa70: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
-0002fa80: 6d29 2c0a 2020 2020 2020 2020 7079 7465  m),.        pyte
-0002fa90: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
-0002faa0: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-0002fab0: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
-0002fac0: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
-0002fad0: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-0002fae0: 7465 7374 5f6c 6973 745f 736f 7572 6365  test_list_source
-0002faf0: 2873 656c 662c 2074 6d70 5f6c 6f63 616c  (self, tmp_local
-0002fb00: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
-0002fb10: 6a2c 2073 746f 7265 5f74 7970 6529 3a0a  j, store_type):.
-0002fb20: 2020 2020 2020 2020 2320 5573 6573 2061          # Uses a
-0002fb30: 206c 6973 7420 696e 2074 6865 2073 6f75   list in the sou
-0002fb40: 7263 6520 6669 656c 6420 746f 2073 7065  rce field to spe
-0002fb50: 6369 6679 2061 2066 696c 6520 616e 6420  cify a file and 
-0002fb60: 6120 6469 7265 6374 6f72 7920 746f 0a20  a directory to. 
-0002fb70: 2020 2020 2020 2023 2062 6520 7570 6c6f         # be uplo
-0002fb80: 6164 6564 2074 6f20 7468 6520 7374 6f72  aded to the stor
-0002fb90: 6167 6520 6f62 6a65 6374 2e0a 2020 2020  age object..    
-0002fba0: 2020 2020 746d 705f 6c6f 6361 6c5f 6c69      tmp_local_li
-0002fbb0: 7374 5f73 746f 7261 6765 5f6f 626a 2e61  st_storage_obj.a
-0002fbc0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0002fbd0: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
-0002fbe0: 4368 6563 6b20 6966 2074 6d70 2d66 696c  Check if tmp-fil
-0002fbf0: 6520 6578 6973 7473 2069 6e20 7468 6520  e exists in the 
-0002fc00: 6275 636b 6574 2072 6f6f 7420 7573 696e  bucket root usin
-0002fc10: 6720 636c 690a 2020 2020 2020 2020 6f75  g cli.        ou
-0002fc20: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-0002fc30: 6865 636b 5f6f 7574 7075 7428 7365 6c66  heck_output(self
-0002fc40: 2e63 6c69 5f6c 735f 636d 6428 0a20 2020  .cli_ls_cmd(.   
-0002fc50: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-0002fc60: 7970 652c 2074 6d70 5f6c 6f63 616c 5f6c  ype, tmp_local_l
-0002fc70: 6973 745f 7374 6f72 6167 655f 6f62 6a2e  ist_storage_obj.
-0002fc80: 6e61 6d65 292c 0a20 2020 2020 2020 2020  name),.         
-0002fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fca0: 2020 2020 2020 2020 2020 2020 2073 6865               she
-0002fcb0: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-0002fcc0: 2061 7373 6572 7420 2774 6d70 2d66 696c   assert 'tmp-fil
-0002fcd0: 6527 2069 6e20 6f75 742e 6465 636f 6465  e' in out.decode
-0002fce0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
-0002fcf0: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
-0002fd00: 6f74 2066 6f75 6e64 2069 6e20 6275 636b  ot found in buck
-0002fd10: 6574 202d 206f 7574 7075 7420 7761 7320  et - output was 
-0002fd20: 3a20 7b7d 272e 666f 726d 6174 286f 7574  : {}'.format(out
-0002fd30: 2e64 6563 6f64 650a 2020 2020 2020 2020  .decode.        
-0002fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f470: 2020 2020 2020 2020 2020 2827 7574 662d            ('utf-
+0002f480: 3827 2929 0a0a 2020 2020 2020 2020 2320  8'))..        # 
+0002f490: 4368 6563 6b20 7379 6d6c 696e 6b73 202d  Check symlinks -
+0002f4a0: 2073 796d 6c69 6e6b 7320 646f 6e27 7420   symlinks don't 
+0002f4b0: 6765 7420 636f 7069 6564 2062 7920 736b  get copied by sk
+0002f4c0: 7920 7374 6f72 6167 650a 2020 2020 2020  y storage.      
+0002f4d0: 2020 6173 7365 7274 2028 7061 7468 6c69    assert (pathli
+0002f4e0: 622e 5061 7468 2874 6d70 5f73 6f75 7263  b.Path(tmp_sourc
+0002f4f0: 6529 202f 2027 6369 7263 6c65 2d6c 696e  e) / 'circle-lin
+0002f500: 6b27 292e 6973 5f73 796d 6c69 6e6b 2829  k').is_symlink()
+0002f510: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+0002f520: 2763 6972 636c 652d 6c69 6e6b 2077 6173  'circle-link was
+0002f530: 206e 6f74 2066 6f75 6e64 2069 6e20 7468   not found in th
+0002f540: 6520 7570 6c6f 6164 2073 6f75 7263 6520  e upload source 
+0002f550: 2d20 270a 2020 2020 2020 2020 2020 2020  - '.            
+0002f560: 2761 7265 2074 6865 2074 6573 7420 6669  'are the test fi
+0002f570: 7874 7572 6573 2063 6f72 7265 6374 3f27  xtures correct?'
+0002f580: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0002f590: 2027 6369 7263 6c65 2d6c 696e 6b27 206e   'circle-link' n
+0002f5a0: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
+0002f5b0: 2827 7574 662d 3827 292c 2028 0a20 2020  ('utf-8'), (.   
+0002f5c0: 2020 2020 2020 2020 2027 5379 6d6c 696e           'Symlin
+0002f5d0: 6b20 666f 756e 6420 696e 2062 7563 6b65  k found in bucke
+0002f5e0: 7420 2d20 6c73 206f 7574 7075 7420 7761  t - ls output wa
+0002f5f0: 7320 3a20 7b7d 272e 666f 726d 6174 280a  s : {}'.format(.
+0002f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f610: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0002f620: 3827 2929 290a 0a20 2020 2020 2020 2023  8')))..        #
+0002f630: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002f640: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002f650: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
+0002f660: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
+0002f670: 7075 742e 0a20 2020 2020 2020 2023 2049  put..        # I
+0002f680: 7420 7368 6f75 6c64 206e 6f74 2065 7869  t should not exi
+0002f690: 7374 2062 6563 6175 7365 2074 6865 2062  st because the b
+0002f6a0: 7563 6b65 7420 7761 7320 6372 6561 7465  ucket was create
+0002f6b0: 6420 6578 7465 726e 616c 6c79 2e0a 2020  d externally..  
+0002f6c0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0002f6d0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002f6e0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002f6f0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002f700: 2020 2020 2020 6173 7365 7274 2073 746f        assert sto
+0002f710: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
+0002f720: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
+0002f730: 2775 7466 2d38 2729 0a0a 2020 2020 4070  'utf-8')..    @p
+0002f740: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002f750: 7569 6473 7461 636b 0a20 2020 2064 6566  uidstack.    def
+0002f760: 2074 6573 745f 636f 7079 5f6d 6f75 6e74   test_copy_mount
+0002f770: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
+0002f780: 6528 7365 6c66 2c0a 2020 2020 2020 2020  e(self,.        
+0002f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7b0: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
+0002f7c0: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
+0002f7d0: 626a 293a 0a20 2020 2020 2020 2023 2043  bj):.        # C
+0002f7e0: 7265 6174 6573 2061 2062 7563 6b65 7420  reates a bucket 
+0002f7f0: 7769 7468 206e 6f20 736f 7572 6365 2069  with no source i
+0002f800: 6e20 4d4f 554e 5420 6d6f 6465 2028 656d  n MOUNT mode (em
+0002f810: 7074 7920 6275 636b 6574 292c 2061 6e64  pty bucket), and
+0002f820: 0a20 2020 2020 2020 2023 2074 6865 6e20  .        # then 
+0002f830: 7472 6965 7320 746f 206c 6f61 6420 7468  tries to load th
+0002f840: 6520 7361 6d65 2073 746f 7261 6765 2069  e same storage i
+0002f850: 6e20 434f 5059 206d 6f64 652e 0a20 2020  n COPY mode..   
+0002f860: 2020 2020 2074 6d70 5f63 6f70 795f 6d6e       tmp_copy_mn
+0002f870: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
+0002f880: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+0002f890: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
+0002f8a0: 7265 5479 7065 2e53 3329 0a20 2020 2020  reType.S3).     
+0002f8b0: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
+0002f8c0: 3d20 746d 705f 636f 7079 5f6d 6e74 5f65  = tmp_copy_mnt_e
+0002f8d0: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
+0002f8e0: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
+0002f8f0: 2020 2320 4368 6563 6b20 6073 6b79 2073    # Check `sky s
+0002f900: 746f 7261 6765 206c 7360 2074 6f20 656e  torage ls` to en
+0002f910: 7375 7265 2073 746f 7261 6765 206f 626a  sure storage obj
+0002f920: 6563 7420 6578 6973 7473 0a20 2020 2020  ect exists.     
+0002f930: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+0002f940: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002f950: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
+0002f960: 6527 2c20 276c 7327 5d29 2e64 6563 6f64  e', 'ls']).decod
+0002f970: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
+0002f980: 2020 2061 7373 6572 7420 7374 6f72 6167     assert storag
+0002f990: 655f 6e61 6d65 2069 6e20 6f75 742c 2066  e_name in out, f
+0002f9a0: 2753 746f 7261 6765 207b 7374 6f72 6167  'Storage {storag
+0002f9b0: 655f 6e61 6d65 7d20 6e6f 7420 666f 756e  e_name} not foun
+0002f9c0: 6420 696e 2073 6b79 2073 746f 7261 6765  d in sky storage
+0002f9d0: 206c 732e 270a 0a20 2020 2040 7079 7465   ls.'..    @pyte
+0002f9e0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002f9f0: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002fa00: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002fa10: 7a65 2827 7374 6f72 655f 7479 7065 272c  ze('store_type',
+0002fa20: 205b 0a20 2020 2020 2020 2073 746f 7261   [.        stora
+0002fa30: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002fa40: 2e53 332c 2073 746f 7261 6765 5f6c 6962  .S3, storage_lib
+0002fa50: 2e53 746f 7265 5479 7065 2e47 4353 2c0a  .StoreType.GCS,.
+0002fa60: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
+0002fa70: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
+0002fa80: 2e53 746f 7265 5479 7065 2e49 424d 2c20  .StoreType.IBM, 
+0002fa90: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+0002faa0: 6b2e 6962 6d29 2c0a 2020 2020 2020 2020  k.ibm),.        
+0002fab0: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
+0002fac0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002fad0: 7065 2e52 322c 206d 6172 6b73 3d70 7974  pe.R2, marks=pyt
+0002fae0: 6573 742e 6d61 726b 2e63 6c6f 7564 666c  est.mark.cloudfl
+0002faf0: 6172 6529 0a20 2020 205d 290a 2020 2020  are).    ]).    
+0002fb00: 6465 6620 7465 7374 5f6c 6973 745f 736f  def test_list_so
+0002fb10: 7572 6365 2873 656c 662c 2074 6d70 5f6c  urce(self, tmp_l
+0002fb20: 6f63 616c 5f6c 6973 745f 7374 6f72 6167  ocal_list_storag
+0002fb30: 655f 6f62 6a2c 2073 746f 7265 5f74 7970  e_obj, store_typ
+0002fb40: 6529 3a0a 2020 2020 2020 2020 2320 5573  e):.        # Us
+0002fb50: 6573 2061 206c 6973 7420 696e 2074 6865  es a list in the
+0002fb60: 2073 6f75 7263 6520 6669 656c 6420 746f   source field to
+0002fb70: 2073 7065 6369 6679 2061 2066 696c 6520   specify a file 
+0002fb80: 616e 6420 6120 6469 7265 6374 6f72 7920  and a directory 
+0002fb90: 746f 0a20 2020 2020 2020 2023 2062 6520  to.        # be 
+0002fba0: 7570 6c6f 6164 6564 2074 6f20 7468 6520  uploaded to the 
+0002fbb0: 7374 6f72 6167 6520 6f62 6a65 6374 2e0a  storage object..
+0002fbc0: 2020 2020 2020 2020 746d 705f 6c6f 6361          tmp_loca
+0002fbd0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
+0002fbe0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0002fbf0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
+0002fc00: 2020 2320 4368 6563 6b20 6966 2074 6d70    # Check if tmp
+0002fc10: 2d66 696c 6520 6578 6973 7473 2069 6e20  -file exists in 
+0002fc20: 7468 6520 6275 636b 6574 2072 6f6f 7420  the bucket root 
+0002fc30: 7573 696e 6720 636c 690a 2020 2020 2020  using cli.      
+0002fc40: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+0002fc50: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002fc60: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
+0002fc70: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002fc80: 7265 5f74 7970 652c 2074 6d70 5f6c 6f63  re_type, tmp_loc
+0002fc90: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
+0002fca0: 6f62 6a2e 6e61 6d65 292c 0a20 2020 2020  obj.name),.     
+0002fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fcd0: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+0002fce0: 2020 2020 2061 7373 6572 7420 2774 6d70       assert 'tmp
+0002fcf0: 2d66 696c 6527 2069 6e20 6f75 742e 6465  -file' in out.de
+0002fd00: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
+0002fd10: 0a20 2020 2020 2020 2020 2020 2027 4669  .            'Fi
+0002fd20: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
+0002fd30: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
+0002fd40: 7761 7320 3a20 7b7d 272e 666f 726d 6174  was : {}'.format
+0002fd50: 286f 7574 2e64 6563 6f64 650a 2020 2020  (out.decode.    
 0002fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd70: 2020 2020 2020 2020 2827 7574 662d 3827          ('utf-8'
-0002fd80: 2929 0a0a 2020 2020 2020 2020 2320 4368  ))..        # Ch
-0002fd90: 6563 6b20 6966 2074 6d70 2d66 696c 6520  eck if tmp-file 
-0002fda0: 6578 6973 7473 2069 6e20 7468 6520 6275  exists in the bu
-0002fdb0: 636b 6574 2f74 6d70 2d73 6f75 7263 6520  cket/tmp-source 
-0002fdc0: 7573 696e 6720 636c 690a 2020 2020 2020  using cli.      
-0002fdd0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-0002fde0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0002fdf0: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
-0002fe00: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002fe10: 7265 5f74 7970 652c 2074 6d70 5f6c 6f63  re_type, tmp_loc
-0002fe20: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
-0002fe30: 6f62 6a2e 6e61 6d65 2c20 2774 6d70 2d73  obj.name, 'tmp-s
-0002fe40: 6f75 7263 652f 2729 2c0a 2020 2020 2020  ource/'),.      
-0002fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fe70: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-0002fe80: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
-0002fe90: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
-0002fea0: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
-0002feb0: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
-0002fec0: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
-0002fed0: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
-0002fee0: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
-0002fef0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
-0002ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ff10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd90: 2020 2020 2020 2020 2020 2020 2827 7574              ('ut
+0002fda0: 662d 3827 2929 0a0a 2020 2020 2020 2020  f-8'))..        
+0002fdb0: 2320 4368 6563 6b20 6966 2074 6d70 2d66  # Check if tmp-f
+0002fdc0: 696c 6520 6578 6973 7473 2069 6e20 7468  ile exists in th
+0002fdd0: 6520 6275 636b 6574 2f74 6d70 2d73 6f75  e bucket/tmp-sou
+0002fde0: 7263 6520 7573 696e 6720 636c 690a 2020  rce using cli.  
+0002fdf0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0002fe00: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002fe10: 7075 7428 7365 6c66 2e63 6c69 5f6c 735f  put(self.cli_ls_
+0002fe20: 636d 6428 0a20 2020 2020 2020 2020 2020  cmd(.           
+0002fe30: 2073 746f 7265 5f74 7970 652c 2074 6d70   store_type, tmp
+0002fe40: 5f6c 6f63 616c 5f6c 6973 745f 7374 6f72  _local_list_stor
+0002fe50: 6167 655f 6f62 6a2e 6e61 6d65 2c20 2774  age_obj.name, 't
+0002fe60: 6d70 2d73 6f75 7263 652f 2729 2c0a 2020  mp-source/'),.  
+0002fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe90: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0002fea0: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
+0002feb0: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
+0002fec0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002fed0: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+0002fee0: 2746 696c 6520 6e6f 7420 666f 756e 6420  'File not found 
+0002fef0: 696e 2062 7563 6b65 7420 2d20 6f75 7470  in bucket - outp
+0002ff00: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
+0002ff10: 6d61 7428 6f75 742e 6465 636f 6465 0a20  mat(out.decode. 
 0002ff20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ff30: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
-0002ff40: 2d38 2729 290a 0a20 2020 2040 7079 7465  -8'))..    @pyte
-0002ff50: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0002ff60: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
-0002ff70: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
-0002ff80: 7a65 2827 696e 7661 6c69 645f 6e61 6d65  ze('invalid_name
-0002ff90: 5f6c 6973 742c 2073 746f 7265 5f74 7970  _list, store_typ
-0002ffa0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-0002ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ffc0: 205b 2841 5753 5f49 4e56 414c 4944 5f4e   [(AWS_INVALID_N
-0002ffd0: 414d 4553 2c20 7374 6f72 6167 655f 6c69  AMES, storage_li
-0002ffe0: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
-0002fff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030000: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00030010: 4743 535f 494e 5641 4c49 445f 4e41 4d45  GCS_INVALID_NAME
-00030020: 532c 2073 746f 7261 6765 5f6c 6962 2e53  S, storage_lib.S
-00030030: 746f 7265 5479 7065 2e47 4353 292c 0a20  toreType.GCS),. 
-00030040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030050: 2020 2020 2020 2020 2020 2020 2070 7974               pyt
-00030060: 6573 742e 7061 7261 6d28 4942 4d5f 494e  est.param(IBM_IN
-00030070: 5641 4c49 445f 4e41 4d45 532c 0a20 2020  VALID_NAMES,.   
-00030080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300a0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-000300b0: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
-000300c0: 4d2c 0a20 2020 2020 2020 2020 2020 2020  M,.             
-000300d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300e0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000300f0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
-00030100: 6962 6d29 2c0a 2020 2020 2020 2020 2020  ibm),.          
-00030110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030120: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-00030130: 2841 5753 5f49 4e56 414c 4944 5f4e 414d  (AWS_INVALID_NAM
-00030140: 4553 2c0a 2020 2020 2020 2020 2020 2020  ES,.            
-00030150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030160: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00030170: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00030180: 5479 7065 2e52 322c 0a20 2020 2020 2020  Type.R2,.       
-00030190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301b0: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
-000301c0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-000301d0: 295d 290a 2020 2020 6465 6620 7465 7374  )]).    def test
-000301e0: 5f69 6e76 616c 6964 5f6e 616d 6573 2873  _invalid_names(s
-000301f0: 656c 662c 2069 6e76 616c 6964 5f6e 616d  elf, invalid_nam
-00030200: 655f 6c69 7374 2c20 7374 6f72 655f 7479  e_list, store_ty
-00030210: 7065 293a 0a20 2020 2020 2020 2023 2055  pe):.        # U
-00030220: 7365 7320 6120 6c69 7374 2069 6e20 7468  ses a list in th
-00030230: 6520 736f 7572 6365 2066 6965 6c64 2074  e source field t
-00030240: 6f20 7370 6563 6966 7920 6120 6669 6c65  o specify a file
-00030250: 2061 6e64 2061 2064 6972 6563 746f 7279   and a directory
-00030260: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
-00030270: 2075 706c 6f61 6465 6420 746f 2074 6865   uploaded to the
-00030280: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
-00030290: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
-000302a0: 6520 696e 2069 6e76 616c 6964 5f6e 616d  e in invalid_nam
-000302b0: 655f 6c69 7374 3a0a 2020 2020 2020 2020  e_list:.        
-000302c0: 2020 2020 7769 7468 2070 7974 6573 742e      with pytest.
-000302d0: 7261 6973 6573 2873 6b79 2e65 7863 6570  raises(sky.excep
-000302e0: 7469 6f6e 732e 5374 6f72 6167 654e 616d  tions.StorageNam
-000302f0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
-00030300: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00030310: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-00030320: 6962 2e53 746f 7261 6765 286e 616d 653d  ib.Storage(name=
-00030330: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00030340: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-00030350: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-00030360: 655f 7479 7065 290a 0a20 2020 2040 7079  e_type)..    @py
-00030370: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-00030380: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
-00030390: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-000303a0: 7269 7a65 280a 2020 2020 2020 2020 2767  rize(.        'g
-000303b0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
-000303c0: 7265 2c20 7374 6f72 655f 7479 7065 272c  re, store_type',
-000303d0: 0a20 2020 2020 2020 205b 2847 4954 4947  .        [(GITIG
-000303e0: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
-000303f0: 4952 5f53 5452 5543 5455 5245 2c20 7374  IR_STRUCTURE, st
-00030400: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00030410: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
-00030420: 2020 2847 4954 4947 4e4f 5245 5f53 594e    (GITIGNORE_SYN
-00030430: 435f 5445 5354 5f44 4952 5f53 5452 5543  C_TEST_DIR_STRUC
-00030440: 5455 5245 2c20 7374 6f72 6167 655f 6c69  TURE, storage_li
-00030450: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
-00030460: 2c0a 2020 2020 2020 2020 2070 7974 6573  ,.         pytes
-00030470: 742e 7061 7261 6d28 4749 5449 474e 4f52  t.param(GITIGNOR
-00030480: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
-00030490: 5354 5255 4354 5552 452c 0a20 2020 2020  STRUCTURE,.     
-000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304b0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-000304c0: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
-000304d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304e0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-000304f0: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
-00030500: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
-00030510: 636c 7564 6564 5f66 696c 655f 636c 6f75  cluded_file_clou
-00030520: 645f 7374 6f72 6167 655f 7570 6c6f 6164  d_storage_upload
-00030530: 5f63 6f70 7928 7365 6c66 2c20 6769 7469  _copy(self, giti
-00030540: 676e 6f72 655f 7374 7275 6374 7572 652c  gnore_structure,
-00030550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030580: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-00030590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000305a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305c0: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
-000305d0: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
-000305e0: 293a 0a20 2020 2020 2020 2023 2074 6573  ):.        # tes
-000305f0: 7473 2069 6620 6669 6c65 7320 696e 636c  ts if files incl
-00030600: 7564 6564 2069 6e20 2e67 6974 6967 6e6f  uded in .gitigno
-00030610: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
-00030620: 2f65 7863 6c75 6465 2061 7265 0a20 2020  /exclude are.   
-00030630: 2020 2020 2023 2065 7863 6c75 6465 6420       # excluded 
-00030640: 6672 6f6d 2062 6569 6e67 2074 7261 6e73  from being trans
-00030650: 6665 7272 6564 2074 6f20 5374 6f72 6167  ferred to Storag
-00030660: 650a 0a20 2020 2020 2020 2074 6d70 5f67  e..        tmp_g
-00030670: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
-00030680: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-00030690: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-000306a0: 2020 2020 7570 6c6f 6164 5f66 696c 655f      upload_file_
-000306b0: 6e61 6d65 203d 2027 696e 636c 7564 6564  name = 'included
-000306c0: 270a 2020 2020 2020 2020 2320 436f 756e  '.        # Coun
-000306d0: 7420 7468 6520 6e75 6d62 6572 206f 6620  t the number of 
-000306e0: 6669 6c65 7320 7769 7468 2074 6865 2067  files with the g
-000306f0: 6976 656e 2066 696c 6520 6e61 6d65 0a20  iven file name. 
-00030700: 2020 2020 2020 2075 705f 636d 6420 3d20         up_cmd = 
-00030710: 7365 6c66 2e63 6c69 5f63 6f75 6e74 5f6e  self.cli_count_n
-00030720: 616d 655f 696e 5f62 7563 6b65 7428 7374  ame_in_bucket(st
-00030730: 6f72 655f 7479 7065 2c20 5c0a 2020 2020  ore_type, \.    
-00030740: 2020 2020 2020 2020 746d 705f 6769 7469          tmp_giti
-00030750: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
-00030760: 6a2e 6e61 6d65 2c20 6669 6c65 5f6e 616d  j.name, file_nam
-00030770: 653d 7570 6c6f 6164 5f66 696c 655f 6e61  e=upload_file_na
-00030780: 6d65 290a 2020 2020 2020 2020 6769 745f  me).        git_
-00030790: 6578 636c 7564 655f 636d 6420 3d20 7365  exclude_cmd = se
-000307a0: 6c66 2e63 6c69 5f63 6f75 6e74 5f6e 616d  lf.cli_count_nam
-000307b0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
-000307c0: 655f 7479 7065 2c20 5c0a 2020 2020 2020  e_type, \.      
-000307d0: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
-000307e0: 6f72 655f 7374 6f72 6167 655f 6f62 6a2e  ore_storage_obj.
-000307f0: 6e61 6d65 2c20 6669 6c65 5f6e 616d 653d  name, file_name=
-00030800: 272e 6769 7427 290a 2020 2020 2020 2020  '.git').        
-00030810: 636e 745f 6e75 6d5f 6669 6c65 5f63 6d64  cnt_num_file_cmd
-00030820: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
-00030830: 745f 6669 6c65 5f69 6e5f 6275 636b 6574  t_file_in_bucket
-00030840: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-00030850: 6f72 655f 7479 7065 2c20 746d 705f 6769  ore_type, tmp_gi
-00030860: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
-00030870: 6f62 6a2e 6e61 6d65 290a 0a20 2020 2020  obj.name)..     
-00030880: 2020 2075 705f 6f75 7470 7574 203d 2073     up_output = s
-00030890: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-000308a0: 6f75 7470 7574 2875 705f 636d 642c 2073  output(up_cmd, s
-000308b0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-000308c0: 2020 2067 6974 5f65 7863 6c75 6465 5f6f     git_exclude_o
-000308d0: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
-000308e0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-000308f0: 6769 745f 6578 636c 7564 655f 636d 642c  git_exclude_cmd,
-00030900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030930: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-00030940: 290a 2020 2020 2020 2020 636e 745f 6f75  ).        cnt_ou
-00030950: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
-00030960: 732e 6368 6563 6b5f 6f75 7470 7574 2863  s.check_output(c
-00030970: 6e74 5f6e 756d 5f66 696c 655f 636d 642c  nt_num_file_cmd,
-00030980: 2073 6865 6c6c 3d54 7275 6529 0a0a 2020   shell=True)..  
-00030990: 2020 2020 2020 6173 7365 7274 2027 3327        assert '3'
-000309a0: 2069 6e20 7570 5f6f 7574 7075 742e 6465   in up_output.de
-000309b0: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
-000309c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000309d0: 2027 4669 6c65 7320 746f 2062 6520 696e   'Files to be in
-000309e0: 636c 7564 6564 2061 7265 206e 6f74 2063  cluded are not c
-000309f0: 6f6d 706c 6574 656c 7920 7570 6c6f 6164  ompletely upload
-00030a00: 6564 2e27 0a20 2020 2020 2020 2023 2031  ed.'.        # 1
-00030a10: 2069 7320 7265 6164 2061 7320 2e67 6974   is read as .git
-00030a20: 6967 6e6f 7265 2069 7320 7570 6c6f 6164  ignore is upload
-00030a30: 6564 0a20 2020 2020 2020 2061 7373 6572  ed.        asser
-00030a40: 7420 2731 2720 696e 2067 6974 5f65 7863  t '1' in git_exc
-00030a50: 6c75 6465 5f6f 7574 7075 742e 6465 636f  lude_output.deco
-00030a60: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
-00030a70: 2020 2020 2020 2020 2020 2020 2020 272e                '.
-00030a80: 6769 7420 6469 7265 6374 6f72 7920 7368  git directory sh
-00030a90: 6f75 6c64 206e 6f74 2062 6520 7570 6c6f  ould not be uplo
-00030aa0: 6164 6564 2e27 0a20 2020 2020 2020 2023  aded.'.        #
-00030ab0: 2034 2066 696c 6573 2069 6e63 6c75 6465   4 files include
-00030ac0: 202e 6769 7469 676e 6f72 652c 2069 6e63   .gitignore, inc
-00030ad0: 6c75 6465 642e 6c6f 672c 2069 6e63 6c75  luded.log, inclu
-00030ae0: 6465 642e 7478 742c 2069 6e63 6c75 6465  ded.txt, include
-00030af0: 5f64 6972 2f69 6e63 6c75 6465 642e 6c6f  _dir/included.lo
-00030b00: 670a 2020 2020 2020 2020 6173 7365 7274  g.        assert
-00030b10: 2027 3427 2069 6e20 636e 745f 6f75 7470   '4' in cnt_outp
-00030b20: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00030b30: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
-00030b40: 2020 2020 2027 536f 6d65 2069 7465 6d73       'Some items
-00030b50: 206c 6973 7465 6420 696e 202e 6769 7469   listed in .giti
-00030b60: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
-00030b70: 6e66 6f2f 6578 636c 7564 6520 6172 6520  nfo/exclude are 
-00030b80: 6e6f 7420 6578 636c 7564 6564 2e27 0a0a  not excluded.'..
-00030b90: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00030ba0: 2e70 6172 616d 6574 7269 7a65 2827 6578  .parametrize('ex
-00030bb0: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
-00030bc0: 2c20 7374 6f72 655f 7479 7065 272c 0a20  , store_type',. 
-00030bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030be0: 2020 2020 2020 2020 2020 2020 5b28 2774              [('t
-00030bf0: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
-00030c00: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
-00030c10: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
-00030c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c30: 2020 2020 2020 2020 2020 2020 2827 746d              ('tm
-00030c40: 705f 6773 7574 696c 5f62 7563 6b65 7427  p_gsutil_bucket'
-00030c50: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-00030c60: 6f72 6554 7970 652e 4743 5329 2c0a 2020  oreType.GCS),.  
-00030c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c80: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
-00030c90: 7374 2e70 6172 616d 2827 746d 705f 6177  st.param('tmp_aw
-00030ca0: 7363 6c69 5f62 7563 6b65 745f 7232 272c  scli_bucket_r2',
-00030cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030cd0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00030ce0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00030cf0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
-00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d20: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-00030d30: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
-00030d40: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
-00030d50: 7465 726e 616c 6c79 5f63 7265 6174 6564  ternally_created
-00030d60: 5f62 7563 6b65 745f 6d6f 756e 745f 7769  _bucket_mount_wi
-00030d70: 7468 6f75 745f 736f 7572 6365 280a 2020  thout_source(.  
-00030d80: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
-00030d90: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
-00030da0: 7265 2c20 7265 7175 6573 742c 2073 746f  re, request, sto
-00030db0: 7265 5f74 7970 6529 3a0a 2020 2020 2020  re_type):.      
-00030dc0: 2020 2320 4e6f 6e2d 736b 7920 6d61 6e61    # Non-sky mana
-00030dd0: 6765 6420 6275 636b 6574 7328 6275 636b  ged buckets(buck
-00030de0: 6574 7320 6372 6561 7465 6420 6f75 7473  ets created outs
-00030df0: 6964 6520 6f66 2053 6b79 7069 6c6f 7420  ide of Skypilot 
-00030e00: 434c 4929 0a20 2020 2020 2020 2023 2061  CLI).        # a
-00030e10: 7265 2061 6c6c 6f77 6564 2074 6f20 6265  re allowed to be
-00030e20: 204d 4f55 4e54 6564 2062 7920 7370 6563   MOUNTed by spec
-00030e30: 6966 7969 6e67 2074 6865 2055 5249 206f  ifying the URI o
-00030e40: 6620 7468 6520 6275 636b 6574 2074 6f0a  f the bucket to.
-00030e50: 2020 2020 2020 2020 2320 736f 7572 6365          # source
-00030e60: 2066 6965 6c64 206f 6e6c 792e 2057 6865   field only. Whe
-00030e70: 6e20 6974 2069 7320 6174 7465 6d70 7465  n it is attempte
-00030e80: 6420 6279 2073 7065 6369 6679 696e 6720  d by specifying 
-00030e90: 7468 6520 6e61 6d65 206f 660a 2020 2020  the name of.    
-00030ea0: 2020 2020 2320 7468 6520 6275 636b 6574      # the bucket
-00030eb0: 206f 6e6c 792c 2069 7420 7368 6f75 6c64   only, it should
-00030ec0: 2065 7272 6f72 206f 7574 2e0a 2020 2020   error out..    
-00030ed0: 2020 2020 230a 2020 2020 2020 2020 2320      #.        # 
-00030ee0: 544f 444f 2864 6f79 6f75 6e67 293a 2041  TODO(doyoung): A
-00030ef0: 6464 2074 6573 7420 666f 7220 4942 4d20  dd test for IBM 
-00030f00: 434f 532e 2043 7572 7265 6e74 6c79 2c20  COS. Currently, 
-00030f10: 7468 6973 2069 7320 626c 6f63 6b65 640a  this is blocked.
-00030f20: 2020 2020 2020 2020 2320 6173 2072 636c          # as rcl
-00030f30: 6f6e 6520 7573 6564 2074 6f20 696e 7465  one used to inte
-00030f40: 7261 6374 2077 6974 6820 4942 4d20 434f  ract with IBM CO
-00030f50: 5320 646f 6573 206e 6f74 2073 7570 706f  S does not suppo
-00030f60: 7274 2066 6561 7475 7265 2074 6f0a 2020  rt feature to.  
-00030f70: 2020 2020 2020 2320 6372 6561 7465 2061        # create a
-00030f80: 2062 7563 6b65 742c 2061 6e64 2074 6865   bucket, and the
-00030f90: 2069 626d 636c 6f75 6420 434c 4920 6973   ibmcloud CLI is
-00030fa0: 206e 6f74 2073 7570 706f 7274 6564 2069   not supported i
-00030fb0: 6e20 536b 7970 696c 6f74 2e0a 2020 2020  n Skypilot..    
-00030fc0: 2020 2020 2320 4569 7468 6572 206f 6620      # Either of 
-00030fd0: 7468 6520 6665 6174 7572 6520 6973 206e  the feature is n
-00030fe0: 6563 6573 7361 7279 2074 6f20 7369 6d75  ecessary to simu
-00030ff0: 6c61 7465 2061 6e20 6578 7465 726e 616c  late an external
-00031000: 2062 7563 6b65 740a 2020 2020 2020 2020   bucket.        
-00031010: 2320 6372 6561 7469 6f6e 2066 6f72 2049  # creation for I
-00031020: 424d 2043 4f53 2e0a 2020 2020 2020 2020  BM COS..        
-00031030: 2320 6874 7470 733a 2f2f 6769 7468 7562  # https://github
-00031040: 2e63 6f6d 2f73 6b79 7069 6c6f 742d 6f72  .com/skypilot-or
-00031050: 672f 736b 7970 696c 6f74 2f70 756c 6c2f  g/skypilot/pull/
-00031060: 3139 3636 2f66 696c 6573 2372 3132 3533  1966/files#r1253
-00031070: 3433 3938 3337 0a0a 2020 2020 2020 2020  439837..        
-00031080: 6578 745f 6275 636b 6574 5f6e 616d 652c  ext_bucket_name,
-00031090: 2065 7874 5f62 7563 6b65 745f 7572 6920   ext_bucket_uri 
-000310a0: 3d20 7265 7175 6573 742e 6765 7466 6978  = request.getfix
-000310b0: 7475 7265 7661 6c75 6528 0a20 2020 2020  turevalue(.     
-000310c0: 2020 2020 2020 2065 7874 5f62 7563 6b65         ext_bucke
-000310d0: 745f 6669 7874 7572 6529 0a20 2020 2020  t_fixture).     
-000310e0: 2020 2023 2069 6e76 616c 6964 2073 7065     # invalid spe
-000310f0: 630a 2020 2020 2020 2020 7769 7468 2070  c.        with p
-00031100: 7974 6573 742e 7261 6973 6573 2873 6b79  ytest.raises(sky
-00031110: 2e65 7863 6570 7469 6f6e 732e 5374 6f72  .exceptions.Stor
-00031120: 6167 6553 7065 6345 7272 6f72 2920 6173  ageSpecError) as
-00031130: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00031140: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
-00031150: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-00031160: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00031170: 2020 206e 616d 653d 6578 745f 6275 636b     name=ext_buck
-00031180: 6574 5f6e 616d 652c 206d 6f64 653d 7374  et_name, mode=st
-00031190: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-000311a0: 654d 6f64 652e 4d4f 554e 5429 0a20 2020  eMode.MOUNT).   
-000311b0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-000311c0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-000311d0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-000311e0: 2020 2020 6173 7365 7274 2027 4174 7465      assert 'Atte
-000311f0: 6d70 7465 6420 746f 206d 6f75 6e74 2061  mpted to mount a
-00031200: 206e 6f6e 2d73 6b79 206d 616e 6167 6564   non-sky managed
-00031210: 2062 7563 6b65 7427 2069 6e20 7374 7228   bucket' in str(
-00031220: 6529 0a0a 2020 2020 2020 2020 2320 7661  e)..        # va
-00031230: 6c69 6420 7370 6563 0a20 2020 2020 2020  lid spec.       
-00031240: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
-00031250: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
-00031260: 6765 2873 6f75 7263 653d 6578 745f 6275  ge(source=ext_bu
-00031270: 636b 6574 5f75 7269 2c0a 2020 2020 2020  cket_uri,.      
-00031280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312a0: 2020 2020 6d6f 6465 3d73 746f 7261 6765      mode=storage
-000312b0: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
-000312c0: 2e4d 4f55 4e54 290a 2020 2020 2020 2020  .MOUNT).        
-000312d0: 6861 6e64 6c65 203d 2067 6c6f 6261 6c5f  handle = global_
-000312e0: 7573 6572 5f73 7461 7465 2e67 6574 5f68  user_state.get_h
-000312f0: 616e 646c 655f 6672 6f6d 5f73 746f 7261  andle_from_stora
-00031300: 6765 5f6e 616d 6528 0a20 2020 2020 2020  ge_name(.       
-00031310: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-00031320: 2e6e 616d 6529 0a20 2020 2020 2020 2069  .name).        i
-00031330: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
-00031340: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-00031350: 6a2e 6465 6c65 7465 2829 0a0a 2020 2020  j.delete()..    
-00031360: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00031370: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
-00031380: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
-00031390: 6d65 7472 697a 6528 2772 6567 696f 6e27  metrize('region'
-000313a0: 2c20 5b0a 2020 2020 2020 2020 2761 702d  , [.        'ap-
-000313b0: 6e6f 7274 6865 6173 742d 3127 2c20 2761  northeast-1', 'a
-000313c0: 702d 6e6f 7274 6865 6173 742d 3227 2c20  p-northeast-2', 
-000313d0: 2761 702d 6e6f 7274 6865 6173 742d 3327  'ap-northeast-3'
-000313e0: 2c20 2761 702d 736f 7574 682d 3127 2c0a  , 'ap-south-1',.
-000313f0: 2020 2020 2020 2020 2761 702d 736f 7574          'ap-sout
-00031400: 6865 6173 742d 3127 2c20 2761 702d 736f  heast-1', 'ap-so
-00031410: 7574 6865 6173 742d 3227 2c20 2765 752d  utheast-2', 'eu-
-00031420: 6365 6e74 7261 6c2d 3127 2c20 2765 752d  central-1', 'eu-
-00031430: 6e6f 7274 682d 3127 2c0a 2020 2020 2020  north-1',.      
-00031440: 2020 2765 752d 7765 7374 2d31 272c 2027    'eu-west-1', '
-00031450: 6575 2d77 6573 742d 3227 2c20 2765 752d  eu-west-2', 'eu-
-00031460: 7765 7374 2d33 272c 2027 7361 2d65 6173  west-3', 'sa-eas
-00031470: 742d 3127 2c20 2775 732d 6561 7374 2d31  t-1', 'us-east-1
-00031480: 272c 0a20 2020 2020 2020 2027 7573 2d65  ',.        'us-e
-00031490: 6173 742d 3227 2c20 2775 732d 7765 7374  ast-2', 'us-west
-000314a0: 2d31 272c 2027 7573 2d77 6573 742d 3227  -1', 'us-west-2'
-000314b0: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-000314c0: 7465 7374 5f61 7773 5f72 6567 696f 6e73  test_aws_regions
-000314d0: 2873 656c 662c 2074 6d70 5f6c 6f63 616c  (self, tmp_local
-000314e0: 5f73 746f 7261 6765 5f6f 626a 2c20 7265  _storage_obj, re
-000314f0: 6769 6f6e 293a 0a20 2020 2020 2020 2023  gion):.        #
-00031500: 2054 6869 7320 7465 7374 7320 6372 6561   This tests crea
-00031510: 7469 6f6e 2061 6e64 2075 706c 6f61 6420  tion and upload 
-00031520: 746f 2062 7563 6b65 7420 696e 2061 6c6c  to bucket in all
-00031530: 2041 5753 2073 3320 7265 6769 6f6e 730a   AWS s3 regions.
-00031540: 2020 2020 2020 2020 2320 546f 2074 6573          # To tes
-00031550: 7420 6675 6c6c 2066 756e 6374 696f 6e61  t full functiona
-00031560: 6c69 7479 2c20 7573 6520 7465 7374 5f73  lity, use test_s
-00031570: 706f 745f 7374 6f72 6167 6520 6162 6f76  pot_storage abov
-00031580: 652e 0a20 2020 2020 2020 2073 746f 7265  e..        store
-00031590: 5f74 7970 6520 3d20 7374 6f72 6167 655f  _type = storage_
-000315a0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-000315b0: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
-000315c0: 616c 5f73 746f 7261 6765 5f6f 626a 2e61  al_storage_obj.a
-000315d0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-000315e0: 7970 652c 2072 6567 696f 6e3d 7265 6769  ype, region=regi
-000315f0: 6f6e 290a 2020 2020 2020 2020 6275 636b  on).        buck
-00031600: 6574 5f6e 616d 6520 3d20 746d 705f 6c6f  et_name = tmp_lo
-00031610: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-00031620: 6e61 6d65 0a0a 2020 2020 2020 2020 2320  name..        # 
-00031630: 436f 6e66 6972 6d20 7468 6174 2074 6865  Confirm that the
-00031640: 2062 7563 6b65 7420 7761 7320 6372 6561   bucket was crea
-00031650: 7465 6420 696e 2074 6865 2063 6f72 7265  ted in the corre
-00031660: 6374 2072 6567 696f 6e0a 2020 2020 2020  ct region.      
-00031670: 2020 7265 6769 6f6e 5f63 6d64 203d 2073    region_cmd = s
-00031680: 656c 662e 636c 695f 7265 6769 6f6e 5f63  elf.cli_region_c
-00031690: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
-000316a0: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
-000316b0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-000316c0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-000316d0: 7428 7265 6769 6f6e 5f63 6d64 2c20 7368  t(region_cmd, sh
-000316e0: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-000316f0: 2020 6f75 7470 7574 203d 206f 7574 2e64    output = out.d
-00031700: 6563 6f64 6528 2775 7466 2d38 2729 0a20  ecode('utf-8'). 
-00031710: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-00031720: 6f75 7470 7574 5f72 6567 696f 6e20 3d20  output_region = 
-00031730: 7265 6769 6f6e 0a20 2020 2020 2020 2069  region.        i
-00031740: 6620 7265 6769 6f6e 203d 3d20 2775 732d  f region == 'us-
-00031750: 6561 7374 2d31 273a 0a20 2020 2020 2020  east-1':.       
-00031760: 2020 2020 2065 7870 6563 7465 645f 6f75       expected_ou
-00031770: 7470 7574 5f72 6567 696f 6e20 3d20 274e  tput_region = 'N
-00031780: 6f6e 6527 2020 2320 7573 2d65 6173 742d  one'  # us-east-
-00031790: 3120 6973 2074 6865 2064 6566 6175 6c74  1 is the default
-000317a0: 2072 6567 696f 6e0a 2020 2020 2020 2020   region.        
-000317b0: 6173 7365 7274 2065 7870 6563 7465 645f  assert expected_
-000317c0: 6f75 7470 7574 5f72 6567 696f 6e20 696e  output_region in
-000317d0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-000317e0: 2d38 2729 2c20 280a 2020 2020 2020 2020  -8'), (.        
-000317f0: 2020 2020 6627 4275 636b 6574 2077 6173      f'Bucket was
-00031800: 206e 6f74 2066 6f75 6e64 2069 6e20 7265   not found in re
-00031810: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d20  gion {region} - 
-00031820: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-00031830: 6f75 7470 7574 206f 6620 7b72 6567 696f  output of {regio
-00031840: 6e5f 636d 647d 2077 6173 3a20 7b6f 7574  n_cmd} was: {out
-00031850: 7075 747d 2729 0a0a 2020 2020 2020 2020  put}')..        
-00031860: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
-00031870: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
-00031880: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
-00031890: 6b65 7420 7573 696e 6720 636c 690a 2020  ket using cli.  
-000318a0: 2020 2020 2020 6c73 5f63 6d64 203d 2073        ls_cmd = s
-000318b0: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
-000318c0: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
-000318d0: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
-000318e0: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-000318f0: 2e63 6865 636b 5f6f 7574 7075 7428 6c73  .check_output(ls
-00031900: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
-00031910: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
-00031920: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
-00031930: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
-00031940: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
-00031950: 2069 6e20 6f75 7470 7574 2c20 280a 2020   in output, (.  
-00031960: 2020 2020 2020 2020 2020 6627 746d 702d            f'tmp-
-00031970: 6669 6c65 206e 6f74 2066 6f75 6e64 2069  file not found i
-00031980: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
-00031990: 7420 6f66 207b 6c73 5f63 6d64 7d20 7761  t of {ls_cmd} wa
-000319a0: 733a 207b 6f75 7470 7574 7d27 290a 0a20  s: {output}').. 
-000319b0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-000319c0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-000319d0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-000319e0: 6172 616d 6574 7269 7a65 2827 7265 6769  arametrize('regi
-000319f0: 6f6e 272c 205b 0a20 2020 2020 2020 2027  on', [.        '
-00031a00: 6e6f 7274 6861 6d65 7269 6361 2d6e 6f72  northamerica-nor
-00031a10: 7468 6561 7374 3127 2c20 276e 6f72 7468  theast1', 'north
-00031a20: 616d 6572 6963 612d 6e6f 7274 6865 6173  america-northeas
-00031a30: 7432 272c 2027 7573 2d63 656e 7472 616c  t2', 'us-central
-00031a40: 3127 2c0a 2020 2020 2020 2020 2775 732d  1',.        'us-
-00031a50: 6561 7374 3127 2c20 2775 732d 6561 7374  east1', 'us-east
-00031a60: 3427 2c20 2775 732d 6561 7374 3527 2c20  4', 'us-east5', 
-00031a70: 2775 732d 736f 7574 6831 272c 2027 7573  'us-south1', 'us
-00031a80: 2d77 6573 7431 272c 2027 7573 2d77 6573  -west1', 'us-wes
-00031a90: 7432 272c 0a20 2020 2020 2020 2027 7573  t2',.        'us
-00031aa0: 2d77 6573 7433 272c 2027 7573 2d77 6573  -west3', 'us-wes
-00031ab0: 7434 272c 2027 736f 7574 6861 6d65 7269  t4', 'southameri
-00031ac0: 6361 2d65 6173 7431 272c 2027 736f 7574  ca-east1', 'sout
-00031ad0: 6861 6d65 7269 6361 2d77 6573 7431 272c  hamerica-west1',
-00031ae0: 0a20 2020 2020 2020 2027 6575 726f 7065  .        'europe
-00031af0: 2d63 656e 7472 616c 3227 2c20 2765 7572  -central2', 'eur
-00031b00: 6f70 652d 6e6f 7274 6831 272c 2027 6575  ope-north1', 'eu
-00031b10: 726f 7065 2d73 6f75 7468 7765 7374 3127  rope-southwest1'
-00031b20: 2c20 2765 7572 6f70 652d 7765 7374 3127  , 'europe-west1'
-00031b30: 2c0a 2020 2020 2020 2020 2765 7572 6f70  ,.        'europ
-00031b40: 652d 7765 7374 3227 2c20 2765 7572 6f70  e-west2', 'europ
-00031b50: 652d 7765 7374 3327 2c20 2765 7572 6f70  e-west3', 'europ
-00031b60: 652d 7765 7374 3427 2c20 2765 7572 6f70  e-west4', 'europ
-00031b70: 652d 7765 7374 3627 2c0a 2020 2020 2020  e-west6',.      
-00031b80: 2020 2765 7572 6f70 652d 7765 7374 3827    'europe-west8'
-00031b90: 2c20 2765 7572 6f70 652d 7765 7374 3927  , 'europe-west9'
-00031ba0: 2c20 2765 7572 6f70 652d 7765 7374 3130  , 'europe-west10
-00031bb0: 272c 2027 6575 726f 7065 2d77 6573 7431  ', 'europe-west1
-00031bc0: 3227 2c0a 2020 2020 2020 2020 2761 7369  2',.        'asi
-00031bd0: 612d 6561 7374 3127 2c20 2761 7369 612d  a-east1', 'asia-
-00031be0: 6561 7374 3227 2c20 2761 7369 612d 6e6f  east2', 'asia-no
-00031bf0: 7274 6865 6173 7431 272c 2027 6173 6961  rtheast1', 'asia
-00031c00: 2d6e 6f72 7468 6561 7374 3227 2c0a 2020  -northeast2',.  
-00031c10: 2020 2020 2020 2761 7369 612d 6e6f 7274        'asia-nort
-00031c20: 6865 6173 7433 272c 2027 6173 6961 2d73  heast3', 'asia-s
-00031c30: 6f75 7468 6561 7374 3127 2c20 2761 7369  outheast1', 'asi
-00031c40: 612d 736f 7574 6831 272c 2027 6173 6961  a-south1', 'asia
-00031c50: 2d73 6f75 7468 3227 2c0a 2020 2020 2020  -south2',.      
-00031c60: 2020 2761 7369 612d 736f 7574 6865 6173    'asia-southeas
-00031c70: 7432 272c 2027 6d65 2d63 656e 7472 616c  t2', 'me-central
-00031c80: 3127 2c20 276d 652d 6365 6e74 7261 6c32  1', 'me-central2
-00031c90: 272c 2027 6d65 2d77 6573 7431 272c 0a20  ', 'me-west1',. 
-00031ca0: 2020 2020 2020 2027 6175 7374 7261 6c69         'australi
-00031cb0: 612d 736f 7574 6865 6173 7431 272c 2027  a-southeast1', '
-00031cc0: 6175 7374 7261 6c69 612d 736f 7574 6865  australia-southe
-00031cd0: 6173 7432 272c 2027 6166 7269 6361 2d73  ast2', 'africa-s
-00031ce0: 6f75 7468 3127 0a20 2020 205d 290a 2020  outh1'.    ]).  
-00031cf0: 2020 6465 6620 7465 7374 5f67 6373 5f72    def test_gcs_r
-00031d00: 6567 696f 6e73 2873 656c 662c 2074 6d70  egions(self, tmp
-00031d10: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-00031d20: 626a 2c20 7265 6769 6f6e 293a 0a20 2020  bj, region):.   
-00031d30: 2020 2020 2023 2054 6869 7320 7465 7374       # This test
-00031d40: 7320 6372 6561 7469 6f6e 2061 6e64 2075  s creation and u
-00031d50: 706c 6f61 6420 746f 2062 7563 6b65 7420  pload to bucket 
-00031d60: 696e 2061 6c6c 2047 4353 2072 6567 696f  in all GCS regio
-00031d70: 6e73 0a20 2020 2020 2020 2023 2054 6f20  ns.        # To 
-00031d80: 7465 7374 2066 756c 6c20 6675 6e63 7469  test full functi
-00031d90: 6f6e 616c 6974 792c 2075 7365 2074 6573  onality, use tes
-00031da0: 745f 7370 6f74 5f73 746f 7261 6765 2061  t_spot_storage a
-00031db0: 626f 7665 2e0a 2020 2020 2020 2020 7374  bove..        st
-00031dc0: 6f72 655f 7479 7065 203d 2073 746f 7261  ore_type = stora
-00031dd0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00031de0: 2e47 4353 0a20 2020 2020 2020 2074 6d70  .GCS.        tmp
-00031df0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
-00031e00: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-00031e10: 7265 5f74 7970 652c 2072 6567 696f 6e3d  re_type, region=
-00031e20: 7265 6769 6f6e 290a 2020 2020 2020 2020  region).        
-00031e30: 6275 636b 6574 5f6e 616d 6520 3d20 746d  bucket_name = tm
-00031e40: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-00031e50: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
-00031e60: 2020 2320 436f 6e66 6972 6d20 7468 6174    # Confirm that
-00031e70: 2074 6865 2062 7563 6b65 7420 7761 7320   the bucket was 
-00031e80: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
-00031e90: 6f72 7265 6374 2072 6567 696f 6e0a 2020  orrect region.  
-00031ea0: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
-00031eb0: 203d 2073 656c 662e 636c 695f 7265 6769   = self.cli_regi
-00031ec0: 6f6e 5f63 6d64 2873 746f 7265 5f74 7970  on_cmd(store_typ
-00031ed0: 652c 2062 7563 6b65 745f 6e61 6d65 290a  e, bucket_name).
-00031ee0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-00031ef0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00031f00: 7574 7075 7428 7265 6769 6f6e 5f63 6d64  utput(region_cmd
-00031f10: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-00031f20: 2020 2020 2020 6f75 7470 7574 203d 206f        output = o
-00031f30: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00031f40: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
-00031f50: 7420 7265 6769 6f6e 2069 6e20 6f75 742e  t region in out.
-00031f60: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00031f70: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-00031f80: 2742 7563 6b65 7420 7761 7320 6e6f 7420  'Bucket was not 
-00031f90: 666f 756e 6420 696e 2072 6567 696f 6e20  found in region 
-00031fa0: 7b72 6567 696f 6e7d 202d 2027 0a20 2020  {region} - '.   
-00031fb0: 2020 2020 2020 2020 2066 276f 7574 7075           f'outpu
-00031fc0: 7420 6f66 207b 7265 6769 6f6e 5f63 6d64  t of {region_cmd
-00031fd0: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
-00031fe0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-00031ff0: 636b 2069 6620 746d 705f 736f 7572 6365  ck if tmp_source
-00032000: 2f74 6d70 2d66 696c 6520 6578 6973 7473  /tmp-file exists
-00032010: 2069 6e20 7468 6520 6275 636b 6574 2075   in the bucket u
-00032020: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
-00032030: 206c 735f 636d 6420 3d20 7365 6c66 2e63   ls_cmd = self.c
-00032040: 6c69 5f6c 735f 636d 6428 7374 6f72 655f  li_ls_cmd(store_
-00032050: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00032060: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
-00032070: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00032080: 6b5f 6f75 7470 7574 286c 735f 636d 642c  k_output(ls_cmd,
-00032090: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-000320a0: 2020 2020 206f 7574 7075 7420 3d20 6f75       output = ou
-000320b0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-000320c0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-000320d0: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
-000320e0: 7574 7075 742c 2028 0a20 2020 2020 2020  utput, (.       
-000320f0: 2020 2020 2066 2774 6d70 2d66 696c 6520       f'tmp-file 
-00032100: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
-00032110: 6b65 7420 2d20 6f75 7470 7574 206f 6620  ket - output of 
-00032120: 7b6c 735f 636d 647d 2077 6173 3a20 7b6f  {ls_cmd} was: {o
-00032130: 7574 7075 747d 2729 0a0a 0a23 202d 2d2d  utput}')...# ---
-00032140: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00032150: 5941 4d4c 2053 7065 6373 202d 2d2d 2d2d  YAML Specs -----
-00032160: 2d2d 2d2d 2d0a 2320 4f75 7220 736b 7920  -----.# Our sky 
-00032170: 7374 6f72 6167 6520 7265 7175 6972 6573  storage requires
-00032180: 2063 7265 6465 6e74 6961 6c73 2074 6f20   credentials to 
-00032190: 6368 6563 6b20 7468 6520 6275 636b 6574  check the bucket
-000321a0: 2065 7869 7374 616e 6365 2077 6865 6e0a   existance when.
-000321b0: 2320 6c6f 6164 696e 6720 6120 7461 736b  # loading a task
-000321c0: 2066 726f 6d20 7468 6520 7961 6d6c 2066   from the yaml f
-000321d0: 696c 652c 2073 6f20 7765 2063 616e 6e6f  ile, so we canno
-000321e0: 7420 6d61 6b65 2069 7420 6120 756e 6974  t make it a unit
-000321f0: 2074 6573 742e 0a63 6c61 7373 2054 6573   test..class Tes
-00032200: 7459 616d 6c53 7065 6373 3a0a 2020 2020  tYamlSpecs:.    
-00032210: 2320 544f 444f 287a 6877 7529 3a20 4164  # TODO(zhwu): Ad
-00032220: 6420 7465 7374 2066 6f72 2060 746f 5f79  d test for `to_y
-00032230: 616d 6c5f 636f 6e66 6967 6020 666f 7220  aml_config` for 
-00032240: 7468 6520 5374 6f72 6167 6520 6f62 6a65  the Storage obje
-00032250: 6374 2e0a 2020 2020 2320 2057 6520 7368  ct..    #  We sh
-00032260: 6f75 6c64 206e 6f74 2075 7365 2060 6578  ould not use `ex
-00032270: 616d 706c 6573 2f73 746f 7261 6765 5f64  amples/storage_d
-00032280: 656d 6f2e 7961 6d6c 6020 6865 7265 2c20  emo.yaml` here, 
-00032290: 7369 6e63 6520 6974 2072 6571 7569 7265  since it require
-000322a0: 730a 2020 2020 2320 2075 7365 7273 2074  s.    #  users t
-000322b0: 6f20 656e 7375 7265 2062 7563 6b65 7420  o ensure bucket 
-000322c0: 6e61 6d65 7320 746f 206e 6f74 2065 7869  names to not exi
-000322d0: 7374 2061 6e64 2f6f 7220 6265 2075 6e69  st and/or be uni
-000322e0: 7175 652e 0a20 2020 205f 5445 5354 5f59  que..    _TEST_Y
-000322f0: 414d 4c5f 5041 5448 5320 3d20 5b0a 2020  AML_PATHS = [.  
-00032300: 2020 2020 2020 2765 7861 6d70 6c65 732f        'examples/
-00032310: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 2027  minimal.yaml', '
-00032320: 6578 616d 706c 6573 2f6d 616e 6167 6564  examples/managed
-00032330: 5f73 706f 742e 7961 6d6c 272c 0a20 2020  _spot.yaml',.   
-00032340: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
-00032350: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
-00032360: 2e79 616d 6c27 2c20 2765 7861 6d70 6c65  .yaml', 'example
-00032370: 732f 7265 736e 6574 5f61 7070 2e79 616d  s/resnet_app.yam
-00032380: 6c27 2c0a 2020 2020 2020 2020 2765 7861  l',.        'exa
-00032390: 6d70 6c65 732f 6d75 6c74 695f 686f 7374  mples/multi_host
-000323a0: 6e61 6d65 2e79 616d 6c27 0a20 2020 205d  name.yaml'.    ]
-000323b0: 0a0a 2020 2020 6465 6620 5f69 735f 6469  ..    def _is_di
-000323c0: 6374 5f73 7562 7365 7428 7365 6c66 2c20  ct_subset(self, 
-000323d0: 6431 2c20 6432 293a 0a20 2020 2020 2020  d1, d2):.       
-000323e0: 2022 2222 4368 6563 6b20 6966 2064 3120   """Check if d1 
-000323f0: 6973 2074 6865 2073 7562 7365 7420 6f66  is the subset of
-00032400: 2064 322e 2222 220a 2020 2020 2020 2020   d2.""".        
-00032410: 666f 7220 6b2c 2076 2069 6e20 6431 2e69  for k, v in d1.i
-00032420: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-00032430: 2020 2020 6966 206b 206e 6f74 2069 6e20      if k not in 
-00032440: 6432 3a0a 2020 2020 2020 2020 2020 2020  d2:.            
-00032450: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00032460: 6528 762c 206c 6973 7429 206f 7220 6973  e(v, list) or is
-00032470: 696e 7374 616e 6365 2876 2c20 6469 6374  instance(v, dict
-00032480: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00032490: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-000324a0: 6e28 7629 203d 3d20 302c 2028 6b2c 2076  n(v) == 0, (k, v
-000324b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000324c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000324d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000324e0: 7274 2046 616c 7365 2c20 286b 2c20 7629  rt False, (k, v)
-000324f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00032500: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-00032510: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
-00032520: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00032530: 696e 7374 616e 6365 2864 325b 6b5d 2c20  instance(d2[k], 
-00032540: 6469 6374 292c 2028 6b2c 2076 2c20 6432  dict), (k, v, d2
-00032550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00032560: 2020 7365 6c66 2e5f 6973 5f64 6963 745f    self._is_dict_
-00032570: 7375 6273 6574 2876 2c20 6432 5b6b 5d29  subset(v, d2[k])
-00032580: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00032590: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-000325a0: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
-000325b0: 2020 2020 2020 6966 206b 203d 3d20 2761        if k == 'a
-000325c0: 6363 656c 6572 6174 6f72 7327 3a0a 2020  ccelerators':.  
-000325d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325e0: 2020 7265 736f 7572 6365 7320 3d20 736b    resources = sk
-000325f0: 792e 5265 736f 7572 6365 7328 290a 2020  y.Resources().  
-00032600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032610: 2020 7265 736f 7572 6365 732e 5f73 6574    resources._set
-00032620: 5f61 6363 656c 6572 6174 6f72 7328 762c  _accelerators(v,
-00032630: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
-00032640: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00032650: 7420 7265 736f 7572 6365 732e 6163 6365  t resources.acce
-00032660: 6c65 7261 746f 7273 203d 3d20 6432 5b6b  lerators == d2[k
-00032670: 5d2c 2028 6b2c 2076 2c20 6432 290a 2020  ], (k, v, d2).  
-00032680: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00032690: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000326a0: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
-000326b0: 2e6c 6f77 6572 2829 203d 3d20 6432 5b6b  .lower() == d2[k
-000326c0: 5d2e 6c6f 7765 7228 292c 2028 6b2c 2076  ].lower(), (k, v
-000326d0: 2c20 6432 5b6b 5d29 0a20 2020 2020 2020  , d2[k]).       
-000326e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000326f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00032700: 7420 7620 3d3d 2064 325b 6b5d 2c20 286b  t v == d2[k], (k
-00032710: 2c20 762c 2064 325b 6b5d 290a 0a20 2020  , v, d2[k])..   
-00032720: 2064 6566 205f 6368 6563 6b5f 6571 7569   def _check_equi
-00032730: 7661 6c65 6e74 2873 656c 662c 2079 616d  valent(self, yam
-00032740: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
-00032750: 2022 2222 4368 6563 6b20 6966 2074 6865   """Check if the
-00032760: 2079 616d 6c20 6973 2065 7175 6976 616c   yaml is equival
-00032770: 656e 7420 6166 7465 7220 6c6f 6164 2061  ent after load a
-00032780: 6e64 2064 756d 7020 6167 6169 6e2e 2222  nd dump again.""
-00032790: 220a 2020 2020 2020 2020 6f72 6967 696e  ".        origin
-000327a0: 5f74 6173 6b5f 636f 6e66 6967 203d 2063  _task_config = c
-000327b0: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
-000327c0: 5f79 616d 6c28 7961 6d6c 5f70 6174 6829  _yaml(yaml_path)
-000327d0: 0a0a 2020 2020 2020 2020 7461 736b 203d  ..        task =
-000327e0: 2073 6b79 2e54 6173 6b2e 6672 6f6d 5f79   sky.Task.from_y
-000327f0: 616d 6c28 7961 6d6c 5f70 6174 6829 0a20  aml(yaml_path). 
-00032800: 2020 2020 2020 206e 6577 5f74 6173 6b5f         new_task_
-00032810: 636f 6e66 6967 203d 2074 6173 6b2e 746f  config = task.to
-00032820: 5f79 616d 6c5f 636f 6e66 6967 2829 0a20  _yaml_config(). 
-00032830: 2020 2020 2020 2023 2064 3120 3c3d 2064         # d1 <= d
-00032840: 320a 2020 2020 2020 2020 7072 696e 7428  2.        print(
-00032850: 6f72 6967 696e 5f74 6173 6b5f 636f 6e66  origin_task_conf
-00032860: 6967 2c20 6e65 775f 7461 736b 5f63 6f6e  ig, new_task_con
-00032870: 6669 6729 0a20 2020 2020 2020 2073 656c  fig).        sel
-00032880: 662e 5f69 735f 6469 6374 5f73 7562 7365  f._is_dict_subse
-00032890: 7428 6f72 6967 696e 5f74 6173 6b5f 636f  t(origin_task_co
-000328a0: 6e66 6967 2c20 6e65 775f 7461 736b 5f63  nfig, new_task_c
-000328b0: 6f6e 6669 6729 0a0a 2020 2020 6465 6620  onfig)..    def 
-000328c0: 7465 7374 5f6c 6f61 645f 6475 6d70 5f79  test_load_dump_y
-000328d0: 616d 6c5f 636f 6e66 6967 5f65 7175 6976  aml_config_equiv
-000328e0: 616c 656e 7428 7365 6c66 293a 0a20 2020  alent(self):.   
-000328f0: 2020 2020 2022 2222 5465 7374 2069 6620       """Test if 
-00032900: 7468 6520 7961 6d6c 2063 6f6e 6669 6720  the yaml config 
-00032910: 6973 2065 7175 6976 616c 656e 7420 6166  is equivalent af
-00032920: 7465 7220 6c6f 6164 2061 6e64 2064 756d  ter load and dum
-00032930: 7020 6167 6169 6e2e 2222 220a 2020 2020  p again.""".    
-00032940: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00032950: 2827 7e2f 6461 7461 7365 7473 2729 2e65  ('~/datasets').e
-00032960: 7870 616e 6475 7365 7228 292e 6d6b 6469  xpanduser().mkdi
-00032970: 7228 6578 6973 745f 6f6b 3d54 7275 6529  r(exist_ok=True)
-00032980: 0a20 2020 2020 2020 2070 6174 686c 6962  .        pathlib
-00032990: 2e50 6174 6828 277e 2f74 6d70 6669 6c65  .Path('~/tmpfile
-000329a0: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-000329b0: 746f 7563 6828 290a 2020 2020 2020 2020  touch().        
-000329c0: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
-000329d0: 2e73 7368 2729 2e65 7870 616e 6475 7365  .ssh').expanduse
-000329e0: 7228 292e 6d6b 6469 7228 6578 6973 745f  r().mkdir(exist_
-000329f0: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
-00032a00: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
-00032a10: 2f2e 7373 682f 6964 5f72 7361 2e70 7562  /.ssh/id_rsa.pub
-00032a20: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-00032a30: 746f 7563 6828 290a 2020 2020 2020 2020  touch().        
-00032a40: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
-00032a50: 746d 702d 776f 726b 6469 7227 292e 6578  tmp-workdir').ex
-00032a60: 7061 6e64 7573 6572 2829 2e6d 6b64 6972  panduser().mkdir
-00032a70: 2865 7869 7374 5f6f 6b3d 5472 7565 290a  (exist_ok=True).
-00032a80: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
-00032a90: 5061 7468 2827 7e2f 446f 776e 6c6f 6164  Path('~/Download
-00032aa0: 732f 7470 7527 292e 6578 7061 6e64 7573  s/tpu').expandus
-00032ab0: 6572 2829 2e6d 6b64 6972 2870 6172 656e  er().mkdir(paren
-00032ac0: 7473 3d54 7275 652c 0a20 2020 2020 2020  ts=True,.       
-00032ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff50: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0002ff60: 2775 7466 2d38 2729 290a 0a20 2020 2040  'utf-8'))..    @
+0002ff70: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0002ff80: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
+0002ff90: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0002ffa0: 6574 7269 7a65 2827 696e 7661 6c69 645f  etrize('invalid_
+0002ffb0: 6e61 6d65 5f6c 6973 742c 2073 746f 7265  name_list, store
+0002ffc0: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
+0002ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ffe0: 2020 2020 205b 2841 5753 5f49 4e56 414c       [(AWS_INVAL
+0002fff0: 4944 5f4e 414d 4553 2c20 7374 6f72 6167  ID_NAMES, storag
+00030000: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00030010: 5333 292c 0a20 2020 2020 2020 2020 2020  S3),.           
+00030020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030030: 2020 2028 4743 535f 494e 5641 4c49 445f     (GCS_INVALID_
+00030040: 4e41 4d45 532c 2073 746f 7261 6765 5f6c  NAMES, storage_l
+00030050: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+00030060: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00030070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030080: 2070 7974 6573 742e 7061 7261 6d28 4942   pytest.param(IB
+00030090: 4d5f 494e 5641 4c49 445f 4e41 4d45 532c  M_INVALID_NAMES,
+000300a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000300b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300c0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+000300d0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+000300e0: 652e 4942 4d2c 0a20 2020 2020 2020 2020  e.IBM,.         
+000300f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030110: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
+00030120: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
+00030130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030140: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
+00030150: 6172 616d 2841 5753 5f49 4e56 414c 4944  aram(AWS_INVALID
+00030160: 5f4e 414d 4553 2c0a 2020 2020 2020 2020  _NAMES,.        
+00030170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030190: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
+000301a0: 746f 7265 5479 7065 2e52 322c 0a20 2020  toreType.R2,.   
+000301b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301d0: 2020 2020 2020 2020 6d61 726b 733d 7079          marks=py
+000301e0: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+000301f0: 6c61 7265 295d 290a 2020 2020 6465 6620  lare)]).    def 
+00030200: 7465 7374 5f69 6e76 616c 6964 5f6e 616d  test_invalid_nam
+00030210: 6573 2873 656c 662c 2069 6e76 616c 6964  es(self, invalid
+00030220: 5f6e 616d 655f 6c69 7374 2c20 7374 6f72  _name_list, stor
+00030230: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+00030240: 2023 2055 7365 7320 6120 6c69 7374 2069   # Uses a list i
+00030250: 6e20 7468 6520 736f 7572 6365 2066 6965  n the source fie
+00030260: 6c64 2074 6f20 7370 6563 6966 7920 6120  ld to specify a 
+00030270: 6669 6c65 2061 6e64 2061 2064 6972 6563  file and a direc
+00030280: 746f 7279 2074 6f0a 2020 2020 2020 2020  tory to.        
+00030290: 2320 6265 2075 706c 6f61 6465 6420 746f  # be uploaded to
+000302a0: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
+000302b0: 6563 742e 0a20 2020 2020 2020 2066 6f72  ect..        for
+000302c0: 206e 616d 6520 696e 2069 6e76 616c 6964   name in invalid
+000302d0: 5f6e 616d 655f 6c69 7374 3a0a 2020 2020  _name_list:.    
+000302e0: 2020 2020 2020 2020 7769 7468 2070 7974          with pyt
+000302f0: 6573 742e 7261 6973 6573 2873 6b79 2e65  est.raises(sky.e
+00030300: 7863 6570 7469 6f6e 732e 5374 6f72 6167  xceptions.Storag
+00030310: 654e 616d 6545 7272 6f72 293a 0a20 2020  eNameError):.   
+00030320: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+00030330: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+00030340: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
+00030350: 616d 653d 6e61 6d65 290a 2020 2020 2020  ame=name).      
+00030360: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00030370: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+00030380: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
+00030390: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
+000303a0: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
+000303b0: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
+000303c0: 616d 6574 7269 7a65 280a 2020 2020 2020  ametrize(.      
+000303d0: 2020 2767 6974 6967 6e6f 7265 5f73 7472    'gitignore_str
+000303e0: 7563 7475 7265 2c20 7374 6f72 655f 7479  ucture, store_ty
+000303f0: 7065 272c 0a20 2020 2020 2020 205b 2847  pe',.        [(G
+00030400: 4954 4947 4e4f 5245 5f53 594e 435f 5445  ITIGNORE_SYNC_TE
+00030410: 5354 5f44 4952 5f53 5452 5543 5455 5245  ST_DIR_STRUCTURE
+00030420: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+00030430: 6f72 6554 7970 652e 5333 292c 0a20 2020  oreType.S3),.   
+00030440: 2020 2020 2020 2847 4954 4947 4e4f 5245        (GITIGNORE
+00030450: 5f53 594e 435f 5445 5354 5f44 4952 5f53  _SYNC_TEST_DIR_S
+00030460: 5452 5543 5455 5245 2c20 7374 6f72 6167  TRUCTURE, storag
+00030470: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+00030480: 4743 5329 2c0a 2020 2020 2020 2020 2070  GCS),.         p
+00030490: 7974 6573 742e 7061 7261 6d28 4749 5449  ytest.param(GITI
+000304a0: 474e 4f52 455f 5359 4e43 5f54 4553 545f  GNORE_SYNC_TEST_
+000304b0: 4449 525f 5354 5255 4354 5552 452c 0a20  DIR_STRUCTURE,. 
+000304c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000304d0: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+000304e0: 2e53 746f 7265 5479 7065 2e52 322c 0a20  .StoreType.R2,. 
+000304f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030500: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
+00030510: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+00030520: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
+00030530: 745f 6578 636c 7564 6564 5f66 696c 655f  t_excluded_file_
+00030540: 636c 6f75 645f 7374 6f72 6167 655f 7570  cloud_storage_up
+00030550: 6c6f 6164 5f63 6f70 7928 7365 6c66 2c20  load_copy(self, 
+00030560: 6769 7469 676e 6f72 655f 7374 7275 6374  gitignore_struct
+00030570: 7572 652c 0a20 2020 2020 2020 2020 2020  ure,.           
+00030580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305a0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+000305b0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+000305c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305e0: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
+000305f0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+00030600: 5f6f 626a 293a 0a20 2020 2020 2020 2023  _obj):.        #
+00030610: 2074 6573 7473 2069 6620 6669 6c65 7320   tests if files 
+00030620: 696e 636c 7564 6564 2069 6e20 2e67 6974  included in .git
+00030630: 6967 6e6f 7265 2061 6e64 202e 6769 742f  ignore and .git/
+00030640: 696e 666f 2f65 7863 6c75 6465 2061 7265  info/exclude are
+00030650: 0a20 2020 2020 2020 2023 2065 7863 6c75  .        # exclu
+00030660: 6465 6420 6672 6f6d 2062 6569 6e67 2074  ded from being t
+00030670: 7261 6e73 6665 7272 6564 2074 6f20 5374  ransferred to St
+00030680: 6f72 6167 650a 0a20 2020 2020 2020 2074  orage..        t
+00030690: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
+000306a0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+000306b0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+000306c0: 2020 2020 2020 2020 7570 6c6f 6164 5f66          upload_f
+000306d0: 696c 655f 6e61 6d65 203d 2027 696e 636c  ile_name = 'incl
+000306e0: 7564 6564 270a 2020 2020 2020 2020 2320  uded'.        # 
+000306f0: 436f 756e 7420 7468 6520 6e75 6d62 6572  Count the number
+00030700: 206f 6620 6669 6c65 7320 7769 7468 2074   of files with t
+00030710: 6865 2067 6976 656e 2066 696c 6520 6e61  he given file na
+00030720: 6d65 0a20 2020 2020 2020 2075 705f 636d  me.        up_cm
+00030730: 6420 3d20 7365 6c66 2e63 6c69 5f63 6f75  d = self.cli_cou
+00030740: 6e74 5f6e 616d 655f 696e 5f62 7563 6b65  nt_name_in_bucke
+00030750: 7428 7374 6f72 655f 7479 7065 2c20 5c0a  t(store_type, \.
+00030760: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
+00030770: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
+00030780: 655f 6f62 6a2e 6e61 6d65 2c20 6669 6c65  e_obj.name, file
+00030790: 5f6e 616d 653d 7570 6c6f 6164 5f66 696c  _name=upload_fil
+000307a0: 655f 6e61 6d65 290a 2020 2020 2020 2020  e_name).        
+000307b0: 6769 745f 6578 636c 7564 655f 636d 6420  git_exclude_cmd 
+000307c0: 3d20 7365 6c66 2e63 6c69 5f63 6f75 6e74  = self.cli_count
+000307d0: 5f6e 616d 655f 696e 5f62 7563 6b65 7428  _name_in_bucket(
+000307e0: 7374 6f72 655f 7479 7065 2c20 5c0a 2020  store_type, \.  
+000307f0: 2020 2020 2020 2020 2020 746d 705f 6769            tmp_gi
+00030800: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
+00030810: 6f62 6a2e 6e61 6d65 2c20 6669 6c65 5f6e  obj.name, file_n
+00030820: 616d 653d 272e 6769 7427 290a 2020 2020  ame='.git').    
+00030830: 2020 2020 636e 745f 6e75 6d5f 6669 6c65      cnt_num_file
+00030840: 5f63 6d64 203d 2073 656c 662e 636c 695f  _cmd = self.cli_
+00030850: 636f 756e 745f 6669 6c65 5f69 6e5f 6275  count_file_in_bu
+00030860: 636b 6574 280a 2020 2020 2020 2020 2020  cket(.          
+00030870: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
+00030880: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
+00030890: 6167 655f 6f62 6a2e 6e61 6d65 290a 0a20  age_obj.name).. 
+000308a0: 2020 2020 2020 2075 705f 6f75 7470 7574         up_output
+000308b0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+000308c0: 6563 6b5f 6f75 7470 7574 2875 705f 636d  eck_output(up_cm
+000308d0: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
+000308e0: 2020 2020 2020 2067 6974 5f65 7863 6c75         git_exclu
+000308f0: 6465 5f6f 7574 7075 7420 3d20 7375 6270  de_output = subp
+00030900: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+00030910: 7075 7428 6769 745f 6578 636c 7564 655f  put(git_exclude_
+00030920: 636d 642c 0a20 2020 2020 2020 2020 2020  cmd,.           
+00030930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030950: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
+00030960: 5472 7565 290a 2020 2020 2020 2020 636e  True).        cn
+00030970: 745f 6f75 7470 7574 203d 2073 7562 7072  t_output = subpr
+00030980: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00030990: 7574 2863 6e74 5f6e 756d 5f66 696c 655f  ut(cnt_num_file_
+000309a0: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
+000309b0: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
+000309c0: 2027 3327 2069 6e20 7570 5f6f 7574 7075   '3' in up_outpu
+000309d0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+000309e0: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
+000309f0: 2020 2020 2027 4669 6c65 7320 746f 2062       'Files to b
+00030a00: 6520 696e 636c 7564 6564 2061 7265 206e  e included are n
+00030a10: 6f74 2063 6f6d 706c 6574 656c 7920 7570  ot completely up
+00030a20: 6c6f 6164 6564 2e27 0a20 2020 2020 2020  loaded.'.       
+00030a30: 2023 2031 2069 7320 7265 6164 2061 7320   # 1 is read as 
+00030a40: 2e67 6974 6967 6e6f 7265 2069 7320 7570  .gitignore is up
+00030a50: 6c6f 6164 6564 0a20 2020 2020 2020 2061  loaded.        a
+00030a60: 7373 6572 7420 2731 2720 696e 2067 6974  ssert '1' in git
+00030a70: 5f65 7863 6c75 6465 5f6f 7574 7075 742e  _exclude_output.
+00030a80: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
+00030a90: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+00030aa0: 2020 272e 6769 7420 6469 7265 6374 6f72    '.git director
+00030ab0: 7920 7368 6f75 6c64 206e 6f74 2062 6520  y should not be 
+00030ac0: 7570 6c6f 6164 6564 2e27 0a20 2020 2020  uploaded.'.     
+00030ad0: 2020 2023 2034 2066 696c 6573 2069 6e63     # 4 files inc
+00030ae0: 6c75 6465 202e 6769 7469 676e 6f72 652c  lude .gitignore,
+00030af0: 2069 6e63 6c75 6465 642e 6c6f 672c 2069   included.log, i
+00030b00: 6e63 6c75 6465 642e 7478 742c 2069 6e63  ncluded.txt, inc
+00030b10: 6c75 6465 5f64 6972 2f69 6e63 6c75 6465  lude_dir/include
+00030b20: 642e 6c6f 670a 2020 2020 2020 2020 6173  d.log.        as
+00030b30: 7365 7274 2027 3427 2069 6e20 636e 745f  sert '4' in cnt_
+00030b40: 6f75 7470 7574 2e64 6563 6f64 6528 2775  output.decode('u
+00030b50: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
+00030b60: 2020 2020 2020 2020 2027 536f 6d65 2069           'Some i
+00030b70: 7465 6d73 206c 6973 7465 6420 696e 202e  tems listed in .
+00030b80: 6769 7469 676e 6f72 6520 616e 6420 2e67  gitignore and .g
+00030b90: 6974 2f69 6e66 6f2f 6578 636c 7564 6520  it/info/exclude 
+00030ba0: 6172 6520 6e6f 7420 6578 636c 7564 6564  are not excluded
+00030bb0: 2e27 0a0a 2020 2020 4070 7974 6573 742e  .'..    @pytest.
+00030bc0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00030bd0: 2827 6578 745f 6275 636b 6574 5f66 6978  ('ext_bucket_fix
+00030be0: 7475 7265 2c20 7374 6f72 655f 7479 7065  ture, store_type
+00030bf0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00030c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c10: 5b28 2774 6d70 5f61 7773 636c 695f 6275  [('tmp_awscli_bu
+00030c20: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
+00030c30: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+00030c40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c60: 2827 746d 705f 6773 7574 696c 5f62 7563  ('tmp_gsutil_buc
+00030c70: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
+00030c80: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
+00030c90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cb0: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
+00030cc0: 705f 6177 7363 6c69 5f62 7563 6b65 745f  p_awscli_bucket_
+00030cd0: 7232 272c 0a20 2020 2020 2020 2020 2020  r2',.           
+00030ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d00: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00030d10: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
+00030d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d40: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
+00030d50: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+00030d60: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
+00030d70: 745f 6578 7465 726e 616c 6c79 5f63 7265  t_externally_cre
+00030d80: 6174 6564 5f62 7563 6b65 745f 6d6f 756e  ated_bucket_moun
+00030d90: 745f 7769 7468 6f75 745f 736f 7572 6365  t_without_source
+00030da0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00030db0: 6c66 2c20 6578 745f 6275 636b 6574 5f66  lf, ext_bucket_f
+00030dc0: 6978 7475 7265 2c20 7265 7175 6573 742c  ixture, request,
+00030dd0: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
+00030de0: 2020 2020 2020 2320 4e6f 6e2d 736b 7920        # Non-sky 
+00030df0: 6d61 6e61 6765 6420 6275 636b 6574 7328  managed buckets(
+00030e00: 6275 636b 6574 7320 6372 6561 7465 6420  buckets created 
+00030e10: 6f75 7473 6964 6520 6f66 2053 6b79 7069  outside of Skypi
+00030e20: 6c6f 7420 434c 4929 0a20 2020 2020 2020  lot CLI).       
+00030e30: 2023 2061 7265 2061 6c6c 6f77 6564 2074   # are allowed t
+00030e40: 6f20 6265 204d 4f55 4e54 6564 2062 7920  o be MOUNTed by 
+00030e50: 7370 6563 6966 7969 6e67 2074 6865 2055  specifying the U
+00030e60: 5249 206f 6620 7468 6520 6275 636b 6574  RI of the bucket
+00030e70: 2074 6f0a 2020 2020 2020 2020 2320 736f   to.        # so
+00030e80: 7572 6365 2066 6965 6c64 206f 6e6c 792e  urce field only.
+00030e90: 2057 6865 6e20 6974 2069 7320 6174 7465   When it is atte
+00030ea0: 6d70 7465 6420 6279 2073 7065 6369 6679  mpted by specify
+00030eb0: 696e 6720 7468 6520 6e61 6d65 206f 660a  ing the name of.
+00030ec0: 2020 2020 2020 2020 2320 7468 6520 6275          # the bu
+00030ed0: 636b 6574 206f 6e6c 792c 2069 7420 7368  cket only, it sh
+00030ee0: 6f75 6c64 2065 7272 6f72 206f 7574 2e0a  ould error out..
+00030ef0: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+00030f00: 2020 2320 544f 444f 2864 6f79 6f75 6e67    # TODO(doyoung
+00030f10: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
+00030f20: 4942 4d20 434f 532e 2043 7572 7265 6e74  IBM COS. Current
+00030f30: 6c79 2c20 7468 6973 2069 7320 626c 6f63  ly, this is bloc
+00030f40: 6b65 640a 2020 2020 2020 2020 2320 6173  ked.        # as
+00030f50: 2072 636c 6f6e 6520 7573 6564 2074 6f20   rclone used to 
+00030f60: 696e 7465 7261 6374 2077 6974 6820 4942  interact with IB
+00030f70: 4d20 434f 5320 646f 6573 206e 6f74 2073  M COS does not s
+00030f80: 7570 706f 7274 2066 6561 7475 7265 2074  upport feature t
+00030f90: 6f0a 2020 2020 2020 2020 2320 6372 6561  o.        # crea
+00030fa0: 7465 2061 2062 7563 6b65 742c 2061 6e64  te a bucket, and
+00030fb0: 2074 6865 2069 626d 636c 6f75 6420 434c   the ibmcloud CL
+00030fc0: 4920 6973 206e 6f74 2073 7570 706f 7274  I is not support
+00030fd0: 6564 2069 6e20 536b 7970 696c 6f74 2e0a  ed in Skypilot..
+00030fe0: 2020 2020 2020 2020 2320 4569 7468 6572          # Either
+00030ff0: 206f 6620 7468 6520 6665 6174 7572 6520   of the feature 
+00031000: 6973 206e 6563 6573 7361 7279 2074 6f20  is necessary to 
+00031010: 7369 6d75 6c61 7465 2061 6e20 6578 7465  simulate an exte
+00031020: 726e 616c 2062 7563 6b65 740a 2020 2020  rnal bucket.    
+00031030: 2020 2020 2320 6372 6561 7469 6f6e 2066      # creation f
+00031040: 6f72 2049 424d 2043 4f53 2e0a 2020 2020  or IBM COS..    
+00031050: 2020 2020 2320 6874 7470 733a 2f2f 6769      # https://gi
+00031060: 7468 7562 2e63 6f6d 2f73 6b79 7069 6c6f  thub.com/skypilo
+00031070: 742d 6f72 672f 736b 7970 696c 6f74 2f70  t-org/skypilot/p
+00031080: 756c 6c2f 3139 3636 2f66 696c 6573 2372  ull/1966/files#r
+00031090: 3132 3533 3433 3938 3337 0a0a 2020 2020  1253439837..    
+000310a0: 2020 2020 6578 745f 6275 636b 6574 5f6e      ext_bucket_n
+000310b0: 616d 652c 2065 7874 5f62 7563 6b65 745f  ame, ext_bucket_
+000310c0: 7572 6920 3d20 7265 7175 6573 742e 6765  uri = request.ge
+000310d0: 7466 6978 7475 7265 7661 6c75 6528 0a20  tfixturevalue(. 
+000310e0: 2020 2020 2020 2020 2020 2065 7874 5f62             ext_b
+000310f0: 7563 6b65 745f 6669 7874 7572 6529 0a20  ucket_fixture). 
+00031100: 2020 2020 2020 2023 2069 6e76 616c 6964         # invalid
+00031110: 2073 7065 630a 2020 2020 2020 2020 7769   spec.        wi
+00031120: 7468 2070 7974 6573 742e 7261 6973 6573  th pytest.raises
+00031130: 2873 6b79 2e65 7863 6570 7469 6f6e 732e  (sky.exceptions.
+00031140: 5374 6f72 6167 6553 7065 6345 7272 6f72  StorageSpecError
+00031150: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
+00031160: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
+00031170: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00031180: 6f72 6167 6528 0a20 2020 2020 2020 2020  orage(.         
+00031190: 2020 2020 2020 206e 616d 653d 6578 745f         name=ext_
+000311a0: 6275 636b 6574 5f6e 616d 652c 206d 6f64  bucket_name, mod
+000311b0: 653d 7374 6f72 6167 655f 6c69 622e 5374  e=storage_lib.St
+000311c0: 6f72 6167 654d 6f64 652e 4d4f 554e 5429  orageMode.MOUNT)
+000311d0: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+000311e0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+000311f0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+00031200: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
+00031210: 4174 7465 6d70 7465 6420 746f 206d 6f75  Attempted to mou
+00031220: 6e74 2061 206e 6f6e 2d73 6b79 206d 616e  nt a non-sky man
+00031230: 6167 6564 2062 7563 6b65 7427 2069 6e20  aged bucket' in 
+00031240: 7374 7228 6529 0a0a 2020 2020 2020 2020  str(e)..        
+00031250: 2320 7661 6c69 6420 7370 6563 0a20 2020  # valid spec.   
+00031260: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+00031270: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
+00031280: 746f 7261 6765 2873 6f75 7263 653d 6578  torage(source=ex
+00031290: 745f 6275 636b 6574 5f75 7269 2c0a 2020  t_bucket_uri,.  
+000312a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312c0: 2020 2020 2020 2020 6d6f 6465 3d73 746f          mode=sto
+000312d0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
+000312e0: 4d6f 6465 2e4d 4f55 4e54 290a 2020 2020  Mode.MOUNT).    
+000312f0: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
+00031300: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+00031310: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
+00031320: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
+00031330: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+00031340: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
+00031350: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
+00031360: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+00031370: 655f 6f62 6a2e 6465 6c65 7465 2829 0a0a  e_obj.delete()..
+00031380: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00031390: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
+000313a0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+000313b0: 7061 7261 6d65 7472 697a 6528 2772 6567  parametrize('reg
+000313c0: 696f 6e27 2c20 5b0a 2020 2020 2020 2020  ion', [.        
+000313d0: 2761 702d 6e6f 7274 6865 6173 742d 3127  'ap-northeast-1'
+000313e0: 2c20 2761 702d 6e6f 7274 6865 6173 742d  , 'ap-northeast-
+000313f0: 3227 2c20 2761 702d 6e6f 7274 6865 6173  2', 'ap-northeas
+00031400: 742d 3327 2c20 2761 702d 736f 7574 682d  t-3', 'ap-south-
+00031410: 3127 2c0a 2020 2020 2020 2020 2761 702d  1',.        'ap-
+00031420: 736f 7574 6865 6173 742d 3127 2c20 2761  southeast-1', 'a
+00031430: 702d 736f 7574 6865 6173 742d 3227 2c20  p-southeast-2', 
+00031440: 2765 752d 6365 6e74 7261 6c2d 3127 2c20  'eu-central-1', 
+00031450: 2765 752d 6e6f 7274 682d 3127 2c0a 2020  'eu-north-1',.  
+00031460: 2020 2020 2020 2765 752d 7765 7374 2d31        'eu-west-1
+00031470: 272c 2027 6575 2d77 6573 742d 3227 2c20  ', 'eu-west-2', 
+00031480: 2765 752d 7765 7374 2d33 272c 2027 7361  'eu-west-3', 'sa
+00031490: 2d65 6173 742d 3127 2c20 2775 732d 6561  -east-1', 'us-ea
+000314a0: 7374 2d31 272c 0a20 2020 2020 2020 2027  st-1',.        '
+000314b0: 7573 2d65 6173 742d 3227 2c20 2775 732d  us-east-2', 'us-
+000314c0: 7765 7374 2d31 272c 2027 7573 2d77 6573  west-1', 'us-wes
+000314d0: 742d 3227 0a20 2020 205d 290a 2020 2020  t-2'.    ]).    
+000314e0: 6465 6620 7465 7374 5f61 7773 5f72 6567  def test_aws_reg
+000314f0: 696f 6e73 2873 656c 662c 2074 6d70 5f6c  ions(self, tmp_l
+00031500: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
+00031510: 2c20 7265 6769 6f6e 293a 0a20 2020 2020  , region):.     
+00031520: 2020 2023 2054 6869 7320 7465 7374 7320     # This tests 
+00031530: 6372 6561 7469 6f6e 2061 6e64 2075 706c  creation and upl
+00031540: 6f61 6420 746f 2062 7563 6b65 7420 696e  oad to bucket in
+00031550: 2061 6c6c 2041 5753 2073 3320 7265 6769   all AWS s3 regi
+00031560: 6f6e 730a 2020 2020 2020 2020 2320 546f  ons.        # To
+00031570: 2074 6573 7420 6675 6c6c 2066 756e 6374   test full funct
+00031580: 696f 6e61 6c69 7479 2c20 7573 6520 7465  ionality, use te
+00031590: 7374 5f73 706f 745f 7374 6f72 6167 6520  st_spot_storage 
+000315a0: 6162 6f76 652e 0a20 2020 2020 2020 2073  above..        s
+000315b0: 746f 7265 5f74 7970 6520 3d20 7374 6f72  tore_type = stor
+000315c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+000315d0: 652e 5333 0a20 2020 2020 2020 2074 6d70  e.S3.        tmp
+000315e0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+000315f0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+00031600: 7265 5f74 7970 652c 2072 6567 696f 6e3d  re_type, region=
+00031610: 7265 6769 6f6e 290a 2020 2020 2020 2020  region).        
+00031620: 6275 636b 6574 5f6e 616d 6520 3d20 746d  bucket_name = tm
+00031630: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
+00031640: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
+00031650: 2020 2320 436f 6e66 6972 6d20 7468 6174    # Confirm that
+00031660: 2074 6865 2062 7563 6b65 7420 7761 7320   the bucket was 
+00031670: 6372 6561 7465 6420 696e 2074 6865 2063  created in the c
+00031680: 6f72 7265 6374 2072 6567 696f 6e0a 2020  orrect region.  
+00031690: 2020 2020 2020 7265 6769 6f6e 5f63 6d64        region_cmd
+000316a0: 203d 2073 656c 662e 636c 695f 7265 6769   = self.cli_regi
+000316b0: 6f6e 5f63 6d64 2873 746f 7265 5f74 7970  on_cmd(store_typ
+000316c0: 652c 2062 7563 6b65 745f 6e61 6d65 290a  e, bucket_name).
+000316d0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+000316e0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+000316f0: 7574 7075 7428 7265 6769 6f6e 5f63 6d64  utput(region_cmd
+00031700: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
+00031710: 2020 2020 2020 6f75 7470 7574 203d 206f        output = o
+00031720: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00031730: 2729 0a20 2020 2020 2020 2065 7870 6563  ').        expec
+00031740: 7465 645f 6f75 7470 7574 5f72 6567 696f  ted_output_regio
+00031750: 6e20 3d20 7265 6769 6f6e 0a20 2020 2020  n = region.     
+00031760: 2020 2069 6620 7265 6769 6f6e 203d 3d20     if region == 
+00031770: 2775 732d 6561 7374 2d31 273a 0a20 2020  'us-east-1':.   
+00031780: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
+00031790: 645f 6f75 7470 7574 5f72 6567 696f 6e20  d_output_region 
+000317a0: 3d20 274e 6f6e 6527 2020 2320 7573 2d65  = 'None'  # us-e
+000317b0: 6173 742d 3120 6973 2074 6865 2064 6566  ast-1 is the def
+000317c0: 6175 6c74 2072 6567 696f 6e0a 2020 2020  ault region.    
+000317d0: 2020 2020 6173 7365 7274 2065 7870 6563      assert expec
+000317e0: 7465 645f 6f75 7470 7574 5f72 6567 696f  ted_output_regio
+000317f0: 6e20 696e 206f 7574 2e64 6563 6f64 6528  n in out.decode(
+00031800: 2775 7466 2d38 2729 2c20 280a 2020 2020  'utf-8'), (.    
+00031810: 2020 2020 2020 2020 6627 4275 636b 6574          f'Bucket
+00031820: 2077 6173 206e 6f74 2066 6f75 6e64 2069   was not found i
+00031830: 6e20 7265 6769 6f6e 207b 7265 6769 6f6e  n region {region
+00031840: 7d20 2d20 270a 2020 2020 2020 2020 2020  } - '.          
+00031850: 2020 6627 6f75 7470 7574 206f 6620 7b72    f'output of {r
+00031860: 6567 696f 6e5f 636d 647d 2077 6173 3a20  egion_cmd} was: 
+00031870: 7b6f 7574 7075 747d 2729 0a0a 2020 2020  {output}')..    
+00031880: 2020 2020 2320 4368 6563 6b20 6966 2074      # Check if t
+00031890: 6d70 5f73 6f75 7263 652f 746d 702d 6669  mp_source/tmp-fi
+000318a0: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
+000318b0: 2062 7563 6b65 7420 7573 696e 6720 636c   bucket using cl
+000318c0: 690a 2020 2020 2020 2020 6c73 5f63 6d64  i.        ls_cmd
+000318d0: 203d 2073 656c 662e 636c 695f 6c73 5f63   = self.cli_ls_c
+000318e0: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
+000318f0: 7563 6b65 745f 6e61 6d65 290a 2020 2020  ucket_name).    
+00031900: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+00031910: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+00031920: 7428 6c73 5f63 6d64 2c20 7368 656c 6c3d  t(ls_cmd, shell=
+00031930: 5472 7565 290a 2020 2020 2020 2020 6f75  True).        ou
+00031940: 7470 7574 203d 206f 7574 2e64 6563 6f64  tput = out.decod
+00031950: 6528 2775 7466 2d38 2729 0a20 2020 2020  e('utf-8').     
+00031960: 2020 2061 7373 6572 7420 2774 6d70 2d66     assert 'tmp-f
+00031970: 696c 6527 2069 6e20 6f75 7470 7574 2c20  ile' in output, 
+00031980: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
+00031990: 746d 702d 6669 6c65 206e 6f74 2066 6f75  tmp-file not fou
+000319a0: 6e64 2069 6e20 6275 636b 6574 202d 206f  nd in bucket - o
+000319b0: 7574 7075 7420 6f66 207b 6c73 5f63 6d64  utput of {ls_cmd
+000319c0: 7d20 7761 733a 207b 6f75 7470 7574 7d27  } was: {output}'
+000319d0: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+000319e0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+000319f0: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+00031a00: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
+00031a10: 7265 6769 6f6e 272c 205b 0a20 2020 2020  region', [.     
+00031a20: 2020 2027 6e6f 7274 6861 6d65 7269 6361     'northamerica
+00031a30: 2d6e 6f72 7468 6561 7374 3127 2c20 276e  -northeast1', 'n
+00031a40: 6f72 7468 616d 6572 6963 612d 6e6f 7274  orthamerica-nort
+00031a50: 6865 6173 7432 272c 2027 7573 2d63 656e  heast2', 'us-cen
+00031a60: 7472 616c 3127 2c0a 2020 2020 2020 2020  tral1',.        
+00031a70: 2775 732d 6561 7374 3127 2c20 2775 732d  'us-east1', 'us-
+00031a80: 6561 7374 3427 2c20 2775 732d 6561 7374  east4', 'us-east
+00031a90: 3527 2c20 2775 732d 736f 7574 6831 272c  5', 'us-south1',
+00031aa0: 2027 7573 2d77 6573 7431 272c 2027 7573   'us-west1', 'us
+00031ab0: 2d77 6573 7432 272c 0a20 2020 2020 2020  -west2',.       
+00031ac0: 2027 7573 2d77 6573 7433 272c 2027 7573   'us-west3', 'us
+00031ad0: 2d77 6573 7434 272c 2027 736f 7574 6861  -west4', 'southa
+00031ae0: 6d65 7269 6361 2d65 6173 7431 272c 2027  merica-east1', '
+00031af0: 736f 7574 6861 6d65 7269 6361 2d77 6573  southamerica-wes
+00031b00: 7431 272c 0a20 2020 2020 2020 2027 6575  t1',.        'eu
+00031b10: 726f 7065 2d63 656e 7472 616c 3227 2c20  rope-central2', 
+00031b20: 2765 7572 6f70 652d 6e6f 7274 6831 272c  'europe-north1',
+00031b30: 2027 6575 726f 7065 2d73 6f75 7468 7765   'europe-southwe
+00031b40: 7374 3127 2c20 2765 7572 6f70 652d 7765  st1', 'europe-we
+00031b50: 7374 3127 2c0a 2020 2020 2020 2020 2765  st1',.        'e
+00031b60: 7572 6f70 652d 7765 7374 3227 2c20 2765  urope-west2', 'e
+00031b70: 7572 6f70 652d 7765 7374 3327 2c20 2765  urope-west3', 'e
+00031b80: 7572 6f70 652d 7765 7374 3427 2c20 2765  urope-west4', 'e
+00031b90: 7572 6f70 652d 7765 7374 3627 2c0a 2020  urope-west6',.  
+00031ba0: 2020 2020 2020 2765 7572 6f70 652d 7765        'europe-we
+00031bb0: 7374 3827 2c20 2765 7572 6f70 652d 7765  st8', 'europe-we
+00031bc0: 7374 3927 2c20 2765 7572 6f70 652d 7765  st9', 'europe-we
+00031bd0: 7374 3130 272c 2027 6575 726f 7065 2d77  st10', 'europe-w
+00031be0: 6573 7431 3227 2c0a 2020 2020 2020 2020  est12',.        
+00031bf0: 2761 7369 612d 6561 7374 3127 2c20 2761  'asia-east1', 'a
+00031c00: 7369 612d 6561 7374 3227 2c20 2761 7369  sia-east2', 'asi
+00031c10: 612d 6e6f 7274 6865 6173 7431 272c 2027  a-northeast1', '
+00031c20: 6173 6961 2d6e 6f72 7468 6561 7374 3227  asia-northeast2'
+00031c30: 2c0a 2020 2020 2020 2020 2761 7369 612d  ,.        'asia-
+00031c40: 6e6f 7274 6865 6173 7433 272c 2027 6173  northeast3', 'as
+00031c50: 6961 2d73 6f75 7468 6561 7374 3127 2c20  ia-southeast1', 
+00031c60: 2761 7369 612d 736f 7574 6831 272c 2027  'asia-south1', '
+00031c70: 6173 6961 2d73 6f75 7468 3227 2c0a 2020  asia-south2',.  
+00031c80: 2020 2020 2020 2761 7369 612d 736f 7574        'asia-sout
+00031c90: 6865 6173 7432 272c 2027 6d65 2d63 656e  heast2', 'me-cen
+00031ca0: 7472 616c 3127 2c20 276d 652d 6365 6e74  tral1', 'me-cent
+00031cb0: 7261 6c32 272c 2027 6d65 2d77 6573 7431  ral2', 'me-west1
+00031cc0: 272c 0a20 2020 2020 2020 2027 6175 7374  ',.        'aust
+00031cd0: 7261 6c69 612d 736f 7574 6865 6173 7431  ralia-southeast1
+00031ce0: 272c 2027 6175 7374 7261 6c69 612d 736f  ', 'australia-so
+00031cf0: 7574 6865 6173 7432 272c 2027 6166 7269  utheast2', 'afri
+00031d00: 6361 2d73 6f75 7468 3127 0a20 2020 205d  ca-south1'.    ]
+00031d10: 290a 2020 2020 6465 6620 7465 7374 5f67  ).    def test_g
+00031d20: 6373 5f72 6567 696f 6e73 2873 656c 662c  cs_regions(self,
+00031d30: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+00031d40: 6765 5f6f 626a 2c20 7265 6769 6f6e 293a  ge_obj, region):
+00031d50: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+00031d60: 7465 7374 7320 6372 6561 7469 6f6e 2061  tests creation a
+00031d70: 6e64 2075 706c 6f61 6420 746f 2062 7563  nd upload to buc
+00031d80: 6b65 7420 696e 2061 6c6c 2047 4353 2072  ket in all GCS r
+00031d90: 6567 696f 6e73 0a20 2020 2020 2020 2023  egions.        #
+00031da0: 2054 6f20 7465 7374 2066 756c 6c20 6675   To test full fu
+00031db0: 6e63 7469 6f6e 616c 6974 792c 2075 7365  nctionality, use
+00031dc0: 2074 6573 745f 7370 6f74 5f73 746f 7261   test_spot_stora
+00031dd0: 6765 2061 626f 7665 2e0a 2020 2020 2020  ge above..      
+00031de0: 2020 7374 6f72 655f 7479 7065 203d 2073    store_type = s
+00031df0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+00031e00: 5479 7065 2e47 4353 0a20 2020 2020 2020  Type.GCS.       
+00031e10: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
+00031e20: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+00031e30: 2873 746f 7265 5f74 7970 652c 2072 6567  (store_type, reg
+00031e40: 696f 6e3d 7265 6769 6f6e 290a 2020 2020  ion=region).    
+00031e50: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
+00031e60: 3d20 746d 705f 6c6f 6361 6c5f 7374 6f72  = tmp_local_stor
+00031e70: 6167 655f 6f62 6a2e 6e61 6d65 0a0a 2020  age_obj.name..  
+00031e80: 2020 2020 2020 2320 436f 6e66 6972 6d20        # Confirm 
+00031e90: 7468 6174 2074 6865 2062 7563 6b65 7420  that the bucket 
+00031ea0: 7761 7320 6372 6561 7465 6420 696e 2074  was created in t
+00031eb0: 6865 2063 6f72 7265 6374 2072 6567 696f  he correct regio
+00031ec0: 6e0a 2020 2020 2020 2020 7265 6769 6f6e  n.        region
+00031ed0: 5f63 6d64 203d 2073 656c 662e 636c 695f  _cmd = self.cli_
+00031ee0: 7265 6769 6f6e 5f63 6d64 2873 746f 7265  region_cmd(store
+00031ef0: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
+00031f00: 6d65 290a 2020 2020 2020 2020 6f75 7420  me).        out 
+00031f10: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
+00031f20: 636b 5f6f 7574 7075 7428 7265 6769 6f6e  ck_output(region
+00031f30: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00031f40: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
+00031f50: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
+00031f60: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+00031f70: 7373 6572 7420 7265 6769 6f6e 2069 6e20  ssert region in 
+00031f80: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+00031f90: 3827 292c 2028 0a20 2020 2020 2020 2020  8'), (.         
+00031fa0: 2020 2066 2742 7563 6b65 7420 7761 7320     f'Bucket was 
+00031fb0: 6e6f 7420 666f 756e 6420 696e 2072 6567  not found in reg
+00031fc0: 696f 6e20 7b72 6567 696f 6e7d 202d 2027  ion {region} - '
+00031fd0: 0a20 2020 2020 2020 2020 2020 2066 276f  .            f'o
+00031fe0: 7574 7075 7420 6f66 207b 7265 6769 6f6e  utput of {region
+00031ff0: 5f63 6d64 7d20 7761 733a 207b 6f75 7470  _cmd} was: {outp
+00032000: 7574 7d27 290a 0a20 2020 2020 2020 2023  ut}')..        #
+00032010: 2043 6865 636b 2069 6620 746d 705f 736f   Check if tmp_so
+00032020: 7572 6365 2f74 6d70 2d66 696c 6520 6578  urce/tmp-file ex
+00032030: 6973 7473 2069 6e20 7468 6520 6275 636b  ists in the buck
+00032040: 6574 2075 7369 6e67 2063 6c69 0a20 2020  et using cli.   
+00032050: 2020 2020 206c 735f 636d 6420 3d20 7365       ls_cmd = se
+00032060: 6c66 2e63 6c69 5f6c 735f 636d 6428 7374  lf.cli_ls_cmd(st
+00032070: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
+00032080: 5f6e 616d 6529 0a20 2020 2020 2020 206f  _name).        o
+00032090: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+000320a0: 6368 6563 6b5f 6f75 7470 7574 286c 735f  check_output(ls_
+000320b0: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
+000320c0: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
+000320d0: 3d20 6f75 742e 6465 636f 6465 2827 7574  = out.decode('ut
+000320e0: 662d 3827 290a 2020 2020 2020 2020 6173  f-8').        as
+000320f0: 7365 7274 2027 746d 702d 6669 6c65 2720  sert 'tmp-file' 
+00032100: 696e 206f 7574 7075 742c 2028 0a20 2020  in output, (.   
+00032110: 2020 2020 2020 2020 2066 2774 6d70 2d66           f'tmp-f
+00032120: 696c 6520 6e6f 7420 666f 756e 6420 696e  ile not found in
+00032130: 2062 7563 6b65 7420 2d20 6f75 7470 7574   bucket - output
+00032140: 206f 6620 7b6c 735f 636d 647d 2077 6173   of {ls_cmd} was
+00032150: 3a20 7b6f 7574 7075 747d 2729 0a0a 0a23  : {output}')...#
+00032160: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+00032170: 696e 6720 5941 4d4c 2053 7065 6373 202d  ing YAML Specs -
+00032180: 2d2d 2d2d 2d2d 2d2d 2d0a 2320 4f75 7220  ---------.# Our 
+00032190: 736b 7920 7374 6f72 6167 6520 7265 7175  sky storage requ
+000321a0: 6972 6573 2063 7265 6465 6e74 6961 6c73  ires credentials
+000321b0: 2074 6f20 6368 6563 6b20 7468 6520 6275   to check the bu
+000321c0: 636b 6574 2065 7869 7374 616e 6365 2077  cket existance w
+000321d0: 6865 6e0a 2320 6c6f 6164 696e 6720 6120  hen.# loading a 
+000321e0: 7461 736b 2066 726f 6d20 7468 6520 7961  task from the ya
+000321f0: 6d6c 2066 696c 652c 2073 6f20 7765 2063  ml file, so we c
+00032200: 616e 6e6f 7420 6d61 6b65 2069 7420 6120  annot make it a 
+00032210: 756e 6974 2074 6573 742e 0a63 6c61 7373  unit test..class
+00032220: 2054 6573 7459 616d 6c53 7065 6373 3a0a   TestYamlSpecs:.
+00032230: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
+00032240: 3a20 4164 6420 7465 7374 2066 6f72 2060  : Add test for `
+00032250: 746f 5f79 616d 6c5f 636f 6e66 6967 6020  to_yaml_config` 
+00032260: 666f 7220 7468 6520 5374 6f72 6167 6520  for the Storage 
+00032270: 6f62 6a65 6374 2e0a 2020 2020 2320 2057  object..    #  W
+00032280: 6520 7368 6f75 6c64 206e 6f74 2075 7365  e should not use
+00032290: 2060 6578 616d 706c 6573 2f73 746f 7261   `examples/stora
+000322a0: 6765 5f64 656d 6f2e 7961 6d6c 6020 6865  ge_demo.yaml` he
+000322b0: 7265 2c20 7369 6e63 6520 6974 2072 6571  re, since it req
+000322c0: 7569 7265 730a 2020 2020 2320 2075 7365  uires.    #  use
+000322d0: 7273 2074 6f20 656e 7375 7265 2062 7563  rs to ensure buc
+000322e0: 6b65 7420 6e61 6d65 7320 746f 206e 6f74  ket names to not
+000322f0: 2065 7869 7374 2061 6e64 2f6f 7220 6265   exist and/or be
+00032300: 2075 6e69 7175 652e 0a20 2020 205f 5445   unique..    _TE
+00032310: 5354 5f59 414d 4c5f 5041 5448 5320 3d20  ST_YAML_PATHS = 
+00032320: 5b0a 2020 2020 2020 2020 2765 7861 6d70  [.        'examp
+00032330: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+00032340: 272c 2027 6578 616d 706c 6573 2f6d 616e  ', 'examples/man
+00032350: 6167 6564 5f73 706f 742e 7961 6d6c 272c  aged_spot.yaml',
+00032360: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+00032370: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
+00032380: 756e 7473 2e79 616d 6c27 2c20 2765 7861  unts.yaml', 'exa
+00032390: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
+000323a0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000323b0: 2765 7861 6d70 6c65 732f 6d75 6c74 695f  'examples/multi_
+000323c0: 686f 7374 6e61 6d65 2e79 616d 6c27 0a20  hostname.yaml'. 
+000323d0: 2020 205d 0a0a 2020 2020 6465 6620 5f69     ]..    def _i
+000323e0: 735f 6469 6374 5f73 7562 7365 7428 7365  s_dict_subset(se
+000323f0: 6c66 2c20 6431 2c20 6432 293a 0a20 2020  lf, d1, d2):.   
+00032400: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+00032410: 2064 3120 6973 2074 6865 2073 7562 7365   d1 is the subse
+00032420: 7420 6f66 2064 322e 2222 220a 2020 2020  t of d2.""".    
+00032430: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+00032440: 6431 2e69 7465 6d73 2829 3a0a 2020 2020  d1.items():.    
+00032450: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
+00032460: 2069 6e20 6432 3a0a 2020 2020 2020 2020   in d2:.        
+00032470: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00032480: 7461 6e63 6528 762c 206c 6973 7429 206f  tance(v, list) o
+00032490: 7220 6973 696e 7374 616e 6365 2876 2c20  r isinstance(v, 
+000324a0: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+000324b0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000324c0: 7420 6c65 6e28 7629 203d 3d20 302c 2028  t len(v) == 0, (
+000324d0: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
+000324e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000324f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032500: 6173 7365 7274 2046 616c 7365 2c20 286b  assert False, (k
+00032510: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
+00032520: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00032530: 2876 2c20 6469 6374 293a 0a20 2020 2020  (v, dict):.     
+00032540: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00032550: 7420 6973 696e 7374 616e 6365 2864 325b  t isinstance(d2[
+00032560: 6b5d 2c20 6469 6374 292c 2028 6b2c 2076  k], dict), (k, v
+00032570: 2c20 6432 290a 2020 2020 2020 2020 2020  , d2).          
+00032580: 2020 2020 2020 7365 6c66 2e5f 6973 5f64        self._is_d
+00032590: 6963 745f 7375 6273 6574 2876 2c20 6432  ict_subset(v, d2
+000325a0: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
+000325b0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+000325c0: 2876 2c20 7374 7229 3a0a 2020 2020 2020  (v, str):.      
+000325d0: 2020 2020 2020 2020 2020 6966 206b 203d            if k =
+000325e0: 3d20 2761 6363 656c 6572 6174 6f72 7327  = 'accelerators'
+000325f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032600: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
+00032610: 3d20 736b 792e 5265 736f 7572 6365 7328  = sky.Resources(
+00032620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00032630: 2020 2020 2020 7265 736f 7572 6365 732e        resources.
+00032640: 5f73 6574 5f61 6363 656c 6572 6174 6f72  _set_accelerator
+00032650: 7328 762c 204e 6f6e 6529 0a20 2020 2020  s(v, None).     
+00032660: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00032670: 7373 6572 7420 7265 736f 7572 6365 732e  ssert resources.
+00032680: 6163 6365 6c65 7261 746f 7273 203d 3d20  accelerators == 
+00032690: 6432 5b6b 5d2c 2028 6b2c 2076 2c20 6432  d2[k], (k, v, d2
+000326a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000326b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000326c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000326d0: 7274 2076 2e6c 6f77 6572 2829 203d 3d20  rt v.lower() == 
+000326e0: 6432 5b6b 5d2e 6c6f 7765 7228 292c 2028  d2[k].lower(), (
+000326f0: 6b2c 2076 2c20 6432 5b6b 5d29 0a20 2020  k, v, d2[k]).   
+00032700: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00032710: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00032720: 7373 6572 7420 7620 3d3d 2064 325b 6b5d  ssert v == d2[k]
+00032730: 2c20 286b 2c20 762c 2064 325b 6b5d 290a  , (k, v, d2[k]).
+00032740: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
+00032750: 6571 7569 7661 6c65 6e74 2873 656c 662c  equivalent(self,
+00032760: 2079 616d 6c5f 7061 7468 293a 0a20 2020   yaml_path):.   
+00032770: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+00032780: 2074 6865 2079 616d 6c20 6973 2065 7175   the yaml is equ
+00032790: 6976 616c 656e 7420 6166 7465 7220 6c6f  ivalent after lo
+000327a0: 6164 2061 6e64 2064 756d 7020 6167 6169  ad and dump agai
+000327b0: 6e2e 2222 220a 2020 2020 2020 2020 6f72  n.""".        or
+000327c0: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
+000327d0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+000327e0: 7265 6164 5f79 616d 6c28 7961 6d6c 5f70  read_yaml(yaml_p
+000327f0: 6174 6829 0a0a 2020 2020 2020 2020 7461  ath)..        ta
+00032800: 736b 203d 2073 6b79 2e54 6173 6b2e 6672  sk = sky.Task.fr
+00032810: 6f6d 5f79 616d 6c28 7961 6d6c 5f70 6174  om_yaml(yaml_pat
+00032820: 6829 0a20 2020 2020 2020 206e 6577 5f74  h).        new_t
+00032830: 6173 6b5f 636f 6e66 6967 203d 2074 6173  ask_config = tas
+00032840: 6b2e 746f 5f79 616d 6c5f 636f 6e66 6967  k.to_yaml_config
+00032850: 2829 0a20 2020 2020 2020 2023 2064 3120  ().        # d1 
+00032860: 3c3d 2064 320a 2020 2020 2020 2020 7072  <= d2.        pr
+00032870: 696e 7428 6f72 6967 696e 5f74 6173 6b5f  int(origin_task_
+00032880: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
+00032890: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+000328a0: 2073 656c 662e 5f69 735f 6469 6374 5f73   self._is_dict_s
+000328b0: 7562 7365 7428 6f72 6967 696e 5f74 6173  ubset(origin_tas
+000328c0: 6b5f 636f 6e66 6967 2c20 6e65 775f 7461  k_config, new_ta
+000328d0: 736b 5f63 6f6e 6669 6729 0a0a 2020 2020  sk_config)..    
+000328e0: 6465 6620 7465 7374 5f6c 6f61 645f 6475  def test_load_du
+000328f0: 6d70 5f79 616d 6c5f 636f 6e66 6967 5f65  mp_yaml_config_e
+00032900: 7175 6976 616c 656e 7428 7365 6c66 293a  quivalent(self):
+00032910: 0a20 2020 2020 2020 2022 2222 5465 7374  .        """Test
+00032920: 2069 6620 7468 6520 7961 6d6c 2063 6f6e   if the yaml con
+00032930: 6669 6720 6973 2065 7175 6976 616c 656e  fig is equivalen
+00032940: 7420 6166 7465 7220 6c6f 6164 2061 6e64  t after load and
+00032950: 2064 756d 7020 6167 6169 6e2e 2222 220a   dump again.""".
+00032960: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+00032970: 5061 7468 2827 7e2f 6461 7461 7365 7473  Path('~/datasets
+00032980: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
+00032990: 6d6b 6469 7228 6578 6973 745f 6f6b 3d54  mkdir(exist_ok=T
+000329a0: 7275 6529 0a20 2020 2020 2020 2070 6174  rue).        pat
+000329b0: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
+000329c0: 6669 6c65 2729 2e65 7870 616e 6475 7365  file').expanduse
+000329d0: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+000329e0: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+000329f0: 2827 7e2f 2e73 7368 2729 2e65 7870 616e  ('~/.ssh').expan
+00032a00: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+00032a10: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+00032a20: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
+00032a30: 6828 277e 2f2e 7373 682f 6964 5f72 7361  h('~/.ssh/id_rsa
+00032a40: 2e70 7562 2729 2e65 7870 616e 6475 7365  .pub').expanduse
+00032a50: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00032a60: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00032a70: 2827 7e2f 746d 702d 776f 726b 6469 7227  ('~/tmp-workdir'
+00032a80: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+00032a90: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+00032aa0: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
+00032ab0: 6c69 622e 5061 7468 2827 7e2f 446f 776e  lib.Path('~/Down
+00032ac0: 6c6f 6164 732f 7470 7527 292e 6578 7061  loads/tpu').expa
+00032ad0: 6e64 7573 6572 2829 2e6d 6b64 6972 2870  nduser().mkdir(p
+00032ae0: 6172 656e 7473 3d54 7275 652c 0a20 2020  arents=True,.   
 00032af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032b00: 2020 2020 6578 6973 745f 6f6b 3d54 7275      exist_ok=Tru
-00032b10: 6529 0a20 2020 2020 2020 2066 6f72 2079  e).        for y
-00032b20: 616d 6c5f 7061 7468 2069 6e20 7365 6c66  aml_path in self
-00032b30: 2e5f 5445 5354 5f59 414d 4c5f 5041 5448  ._TEST_YAML_PATH
-00032b40: 533a 0a20 2020 2020 2020 2020 2020 2073  S:.            s
-00032b50: 656c 662e 5f63 6865 636b 5f65 7175 6976  elf._check_equiv
-00032b60: 616c 656e 7428 7961 6d6c 5f70 6174 6829  alent(yaml_path)
-00032b70: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00032b80: 5465 7374 696e 6720 4d75 6c74 6970 6c65  Testing Multiple
-00032b90: 2041 6363 656c 6572 6174 6f72 7320 2d2d   Accelerators --
-00032ba0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00032bb0: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-00032bc0: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
-00032bd0: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
-00032be0: 7274 204b 3830 2067 7075 7320 666f 7220  rt K80 gpus for 
-00032bf0: 6e6f 770a 4070 7974 6573 742e 6d61 726b  now.@pytest.mark
-00032c00: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-00032c10: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
-00032c20: 7320 6e6f 7420 7375 7070 6f72 7420 4b38  s not support K8
-00032c30: 3020 6770 7573 0a64 6566 2074 6573 745f  0 gpus.def test_
-00032c40: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
-00032c50: 6174 6f72 735f 6f72 6465 7265 6428 293a  ators_ordered():
-00032c60: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00032c70: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00032c80: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00032c90: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
-00032ca0: 6c65 2d61 6363 656c 6572 6174 6f72 732d  le-accelerators-
-00032cb0: 6f72 6465 7265 6427 2c0a 2020 2020 2020  ordered',.      
-00032cc0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00032cd0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00032ce0: 2d63 207b 6e61 6d65 7d20 7465 7374 732f  -c {name} tests/
-00032cf0: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-00032d00: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
-00032d10: 6174 6f72 735f 6f72 6465 7265 642e 7961  ators_ordered.ya
-00032d20: 6d6c 207c 2067 7265 7020 2255 7369 6e67  ml | grep "Using
-00032d30: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
-00032d40: 6163 6365 6c65 7261 746f 7273 206c 6973  accelerators lis
-00032d50: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
-00032d60: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00032d70: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00032d80: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00032d90: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00032da0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00032db0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00032dc0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-00032dd0: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00032de0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00032df0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00032e00: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-00032e10: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
-00032e20: 6964 7374 6163 6b20 6861 7320 6c6f 7720  idstack has low 
-00032e30: 6176 6169 6c61 6269 6c69 7479 2066 6f72  availability for
-00032e40: 2054 3420 4750 5573 0a40 7079 7465 7374   T4 GPUs.@pytest
-00032e50: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
-00032e60: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
-00032e70: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
-00032e80: 7274 2054 3420 4750 5573 0a64 6566 2074  rt T4 GPUs.def t
-00032e90: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00032ea0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
-00032eb0: 645f 7769 7468 5f64 6566 6175 6c74 2829  d_with_default()
-00032ec0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00032ed0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00032ee0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00032ef0: 280a 2020 2020 2020 2020 276d 756c 7469  (.        'multi
-00032f00: 706c 652d 6163 6365 6c65 7261 746f 7273  ple-accelerators
-00032f10: 2d6f 7264 6572 6564 272c 0a20 2020 2020  -ordered',.     
-00032f20: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00032f30: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00032f40: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
-00032f50: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-00032f60: 5f6d 756c 7469 706c 655f 6163 6365 6c65  _multiple_accele
-00032f70: 7261 746f 7273 5f6f 7264 6572 6564 5f77  rators_ordered_w
-00032f80: 6974 685f 6465 6661 756c 742e 7961 6d6c  ith_default.yaml
-00032f90: 207c 2067 7265 7020 2255 7369 6e67 2075   | grep "Using u
-00032fa0: 7365 722d 7370 6563 6966 6965 6420 6163  ser-specified ac
-00032fb0: 6365 6c65 7261 746f 7273 206c 6973 7422  celerators list"
-00032fc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00032fd0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00032fe0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00032ff0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00033000: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00033010: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00033020: 7475 7320 7b6e 616d 657d 207c 2067 7265  tus {name} | gre
-00033030: 7020 5370 6f74 272c 0a20 2020 2020 2020  p Spot',.       
-00033040: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00033050: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00033060: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00033070: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00033080: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-00033090: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-000330a0: 466c 7569 6473 7461 636b 2068 6173 206c  Fluidstack has l
-000330b0: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
-000330c0: 666f 7220 5434 2047 5055 730a 4070 7974  for T4 GPUs.@pyt
-000330d0: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
-000330e0: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
-000330f0: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
-00033100: 7070 6f72 7420 5434 2047 5055 730a 6465  pport T4 GPUs.de
-00033110: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
-00033120: 6163 6365 6c65 7261 746f 7273 5f75 6e6f  accelerators_uno
-00033130: 7264 6572 6564 2829 3a0a 2020 2020 6e61  rdered():.    na
-00033140: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00033150: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00033160: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00033170: 2020 276d 756c 7469 706c 652d 6163 6365    'multiple-acce
-00033180: 6c65 7261 746f 7273 2d75 6e6f 7264 6572  lerators-unorder
-00033190: 6564 272c 0a20 2020 2020 2020 205b 0a20  ed',.        [. 
-000331a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000331b0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-000331c0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-000331d0: 7961 6d6c 732f 7465 7374 5f6d 756c 7469  yamls/test_multi
-000331e0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-000331f0: 5f75 6e6f 7264 6572 6564 2e79 616d 6c27  _unordered.yaml'
-00033200: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00033210: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00033220: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00033230: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00033240: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00033250: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00033260: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00033270: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00033280: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00033290: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000332a0: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
-000332b0: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
-000332c0: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
-000332d0: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
-000332e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-000332f0: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-00033300: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
-00033310: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
-00033320: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
-00033330: 5f61 6363 656c 6572 6174 6f72 735f 756e  _accelerators_un
-00033340: 6f72 6465 7265 645f 7769 7468 5f64 6566  ordered_with_def
-00033350: 6175 6c74 2829 3a0a 2020 2020 6e61 6d65  ault():.    name
-00033360: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00033370: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00033380: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00033390: 276d 756c 7469 706c 652d 6163 6365 6c65  'multiple-accele
-000333a0: 7261 746f 7273 2d75 6e6f 7264 6572 6564  rators-unordered
-000333b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000333c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000333d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000333e0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-000333f0: 6d6c 732f 7465 7374 5f6d 756c 7469 706c  mls/test_multipl
-00033400: 655f 6163 6365 6c65 7261 746f 7273 5f75  e_accelerators_u
-00033410: 6e6f 7264 6572 6564 5f77 6974 685f 6465  nordered_with_de
-00033420: 6661 756c 742e 7961 6d6c 272c 0a20 2020  fault.yaml',.   
-00033430: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00033440: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00033450: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00033460: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00033470: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00033480: 2066 2773 6b79 2073 7461 7475 7320 7b6e   f'sky status {n
-00033490: 616d 657d 207c 2067 7265 7020 5370 6f74  ame} | grep Spot
-000334a0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-000334b0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000334c0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-000334d0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-000334e0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000334f0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00033500: 6473 7461 636b 2020 2320 5265 7175 6972  dstack  # Requir
-00033510: 6573 206f 7468 6572 2063 6c6f 7564 7320  es other clouds 
-00033520: 746f 2062 6520 656e 6162 6c65 640a 6465  to be enabled.de
-00033530: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
-00033540: 7265 736f 7572 6365 7328 293a 0a20 2020  resources():.   
-00033550: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00033560: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00033570: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00033580: 2020 2020 2027 6d75 6c74 6970 6c65 2d72       'multiple-r
-00033590: 6573 6f75 7263 6573 272c 0a20 2020 2020  esources',.     
-000335a0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000335b0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000335c0: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
-000335d0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-000335e0: 5f6d 756c 7469 706c 655f 7265 736f 7572  _multiple_resour
-000335f0: 6365 732e 7961 6d6c 272c 0a20 2020 2020  ces.yaml',.     
-00033600: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00033610: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00033620: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00033630: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00033640: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-00033650: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00033660: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00033670: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00033680: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-00033690: 2d2d 2d2d 2d2d 2d2d 2053 6b79 2042 656e  -------- Sky Ben
-000336a0: 6368 6d61 726b 202d 2d2d 2d2d 2d2d 2d2d  chmark ---------
-000336b0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-000336c0: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-000336d0: 5265 7175 6972 6573 206f 7468 6572 2063  Requires other c
-000336e0: 6c6f 7564 7320 746f 2062 6520 656e 6162  louds to be enab
-000336f0: 6c65 640a 4070 7974 6573 742e 6d61 726b  led.@pytest.mark
-00033700: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-00033710: 2320 5265 7175 6972 6573 206f 7468 6572  # Requires other
-00033720: 2063 6c6f 7564 7320 746f 2062 6520 656e   clouds to be en
-00033730: 6162 6c65 640a 4070 7974 6573 742e 6d61  abled.@pytest.ma
-00033740: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-00033750: 0a64 6566 2074 6573 745f 736b 795f 6265  .def test_sky_be
-00033760: 6e63 6828 6765 6e65 7269 635f 636c 6f75  nch(generic_clou
-00033770: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00033780: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00033790: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000337a0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000337b0: 2027 736b 792d 6265 6e63 6827 2c0a 2020   'sky-bench',.  
-000337c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000337d0: 2020 2020 6627 736b 7920 6265 6e63 6820      f'sky bench 
-000337e0: 6c61 756e 6368 202d 7920 2d62 207b 6e61  launch -y -b {na
-000337f0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00033800: 6572 6963 5f63 6c6f 7564 7d20 2d69 3020  eric_cloud} -i0 
-00033810: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00033820: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00033830: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00033840: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
-00033850: 2020 2020 2066 2773 6b79 2062 656e 6368       f'sky bench
-00033860: 2073 686f 7720 7b6e 616d 657d 207c 2067   show {name} | g
-00033870: 7265 7020 736b 792d 6265 6e63 682d 7b6e  rep sky-bench-{n
-00033880: 616d 657d 207c 2067 7265 7020 4649 4e49  ame} | grep FINI
-00033890: 5348 4544 272c 0a20 2020 2020 2020 205d  SHED',.        ]
-000338a0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-000338b0: 6265 6e63 6820 646f 776e 207b 6e61 6d65  bench down {name
-000338c0: 7d20 2d79 3b20 736b 7920 6265 6e63 6820  } -y; sky bench 
-000338d0: 6465 6c65 7465 207b 6e61 6d65 7d20 2d79  delete {name} -y
-000338e0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-000338f0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00032b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b20: 2020 2020 2020 2020 6578 6973 745f 6f6b          exist_ok
+00032b30: 3d54 7275 6529 0a20 2020 2020 2020 2066  =True).        f
+00032b40: 6f72 2079 616d 6c5f 7061 7468 2069 6e20  or yaml_path in 
+00032b50: 7365 6c66 2e5f 5445 5354 5f59 414d 4c5f  self._TEST_YAML_
+00032b60: 5041 5448 533a 0a20 2020 2020 2020 2020  PATHS:.         
+00032b70: 2020 2073 656c 662e 5f63 6865 636b 5f65     self._check_e
+00032b80: 7175 6976 616c 656e 7428 7961 6d6c 5f70  quivalent(yaml_p
+00032b90: 6174 6829 0a0a 0a23 202d 2d2d 2d2d 2d2d  ath)...# -------
+00032ba0: 2d2d 2d20 5465 7374 696e 6720 4d75 6c74  --- Testing Mult
+00032bb0: 6970 6c65 2041 6363 656c 6572 6174 6f72  iple Accelerator
+00032bc0: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
+00032bd0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00032be0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+00032bf0: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+00032c00: 7570 706f 7274 204b 3830 2067 7075 7320  upport K80 gpus 
+00032c10: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+00032c20: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00032c30: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
+00032c40: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00032c50: 7420 4b38 3020 6770 7573 0a64 6566 2074  t K80 gpus.def t
+00032c60: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00032c70: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00032c80: 6428 293a 0a20 2020 206e 616d 6520 3d20  d():.    name = 
+00032c90: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00032ca0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00032cb0: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00032cc0: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
+00032cd0: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
+00032ce0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00032cf0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00032d00: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+00032d10: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00032d20: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00032d30: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00032d40: 642e 7961 6d6c 207c 2067 7265 7020 2255  d.yaml | grep "U
+00032d50: 7369 6e67 2075 7365 722d 7370 6563 6966  sing user-specif
+00032d60: 6965 6420 6163 6365 6c65 7261 746f 7273  ied accelerators
+00032d70: 206c 6973 7422 272c 0a20 2020 2020 2020   list"',.       
+00032d80: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00032d90: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00032da0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00032db0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00032dc0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00032dd0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00032de0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00032df0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00032e00: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00032e10: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00032e20: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00032e30: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+00032e40: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
+00032e50: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
+00032e60: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
+00032e70: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+00032e80: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00032e90: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00032ea0: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
+00032eb0: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
+00032ec0: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
+00032ed0: 6465 7265 645f 7769 7468 5f64 6566 6175  dered_with_defau
+00032ee0: 6c74 2829 3a0a 2020 2020 6e61 6d65 203d  lt():.    name =
+00032ef0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00032f00: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00032f10: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+00032f20: 756c 7469 706c 652d 6163 6365 6c65 7261  ultiple-accelera
+00032f30: 746f 7273 2d6f 7264 6572 6564 272c 0a20  tors-ordered',. 
+00032f40: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00032f50: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00032f60: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00032f70: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00032f80: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
+00032f90: 6365 6c65 7261 746f 7273 5f6f 7264 6572  celerators_order
+00032fa0: 6564 5f77 6974 685f 6465 6661 756c 742e  ed_with_default.
+00032fb0: 7961 6d6c 207c 2067 7265 7020 2255 7369  yaml | grep "Usi
+00032fc0: 6e67 2075 7365 722d 7370 6563 6966 6965  ng user-specifie
+00032fd0: 6420 6163 6365 6c65 7261 746f 7273 206c  d accelerators l
+00032fe0: 6973 7422 272c 0a20 2020 2020 2020 2020  ist"',.         
+00032ff0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00033000: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00033010: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00033020: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00033030: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00033040: 2073 7461 7475 7320 7b6e 616d 657d 207c   status {name} |
+00033050: 2067 7265 7020 5370 6f74 272c 0a20 2020   grep Spot',.   
+00033060: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00033070: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00033080: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00033090: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000330a0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+000330b0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+000330c0: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
+000330d0: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+000330e0: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
+000330f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00033100: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+00033110: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+00033120: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
+00033130: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
+00033140: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
+00033150: 5f75 6e6f 7264 6572 6564 2829 3a0a 2020  _unordered():.  
+00033160: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00033170: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00033180: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00033190: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
+000331a0: 6163 6365 6c65 7261 746f 7273 2d75 6e6f  accelerators-uno
+000331b0: 7264 6572 6564 272c 0a20 2020 2020 2020  rdered',.       
+000331c0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000331d0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000331e0: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+000331f0: 6573 745f 7961 6d6c 732f 7465 7374 5f6d  est_yamls/test_m
+00033200: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
+00033210: 746f 7273 5f75 6e6f 7264 6572 6564 2e79  tors_unordered.y
+00033220: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00033230: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00033240: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00033250: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00033260: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00033270: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00033280: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00033290: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+000332a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000332b0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000332c0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+000332d0: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+000332e0: 6861 7320 6c6f 7720 6176 6169 6c61 6269  has low availabi
+000332f0: 6c69 7479 2066 6f72 2054 3420 4750 5573  lity for T4 GPUs
+00033300: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00033310: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+00033320: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+00033330: 6f74 2073 7570 706f 7274 2054 3420 4750  ot support T4 GP
+00033340: 5573 0a64 6566 2074 6573 745f 6d75 6c74  Us.def test_mult
+00033350: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
+00033360: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
+00033370: 5f64 6566 6175 6c74 2829 3a0a 2020 2020  _default():.    
+00033380: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00033390: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000333a0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000333b0: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
+000333c0: 6365 6c65 7261 746f 7273 2d75 6e6f 7264  celerators-unord
+000333d0: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
+000333e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000333f0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00033400: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+00033410: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
+00033420: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
+00033430: 7273 5f75 6e6f 7264 6572 6564 5f77 6974  rs_unordered_wit
+00033440: 685f 6465 6661 756c 742e 7961 6d6c 272c  h_default.yaml',
+00033450: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00033460: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00033470: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00033480: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00033490: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000334a0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+000334b0: 7320 7b6e 616d 657d 207c 2067 7265 7020  s {name} | grep 
+000334c0: 5370 6f74 272c 0a20 2020 2020 2020 205d  Spot',.        ]
+000334d0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000334e0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+000334f0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00033500: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00033510: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00033520: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
+00033530: 7175 6972 6573 206f 7468 6572 2063 6c6f  quires other clo
+00033540: 7564 7320 746f 2062 6520 656e 6162 6c65  uds to be enable
+00033550: 640a 6465 6620 7465 7374 5f6d 756c 7469  d.def test_multi
+00033560: 706c 655f 7265 736f 7572 6365 7328 293a  ple_resources():
+00033570: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00033580: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00033590: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+000335a0: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
+000335b0: 6c65 2d72 6573 6f75 7263 6573 272c 0a20  le-resources',. 
+000335c0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000335d0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000335e0: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+000335f0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00033600: 7465 7374 5f6d 756c 7469 706c 655f 7265  test_multiple_re
+00033610: 736f 7572 6365 732e 7961 6d6c 272c 0a20  sources.yaml',. 
+00033620: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00033630: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00033640: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00033650: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00033660: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+00033670: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00033680: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00033690: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000336a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000336b0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 6b79  # ---------- Sky
+000336c0: 2042 656e 6368 6d61 726b 202d 2d2d 2d2d   Benchmark -----
+000336d0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+000336e0: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+000336f0: 2020 2320 5265 7175 6972 6573 206f 7468    # Requires oth
+00033700: 6572 2063 6c6f 7564 7320 746f 2062 6520  er clouds to be 
+00033710: 656e 6162 6c65 640a 4070 7974 6573 742e  enabled.@pytest.
+00033720: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00033730: 6365 2020 2320 5265 7175 6972 6573 206f  ce  # Requires o
+00033740: 7468 6572 2063 6c6f 7564 7320 746f 2062  ther clouds to b
+00033750: 6520 656e 6162 6c65 640a 4070 7974 6573  e enabled.@pytes
+00033760: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00033770: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00033780: 795f 6265 6e63 6828 6765 6e65 7269 635f  y_bench(generic_
+00033790: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+000337a0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000337b0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000337c0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000337d0: 2020 2020 2027 736b 792d 6265 6e63 6827       'sky-bench'
+000337e0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000337f0: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
+00033800: 6e63 6820 6c61 756e 6368 202d 7920 2d62  nch launch -y -b
+00033810: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00033820: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00033830: 2d69 3020 7465 7374 732f 7465 7374 5f79  -i0 tests/test_y
+00033840: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00033850: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00033860: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+00033870: 2020 2020 2020 2020 2066 2773 6b79 2062           f'sky b
+00033880: 656e 6368 2073 686f 7720 7b6e 616d 657d  ench show {name}
+00033890: 207c 2067 7265 7020 736b 792d 6265 6e63   | grep sky-benc
+000338a0: 682d 7b6e 616d 657d 207c 2067 7265 7020  h-{name} | grep 
+000338b0: 4649 4e49 5348 4544 272c 0a20 2020 2020  FINISHED',.     
+000338c0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+000338d0: 736b 7920 6265 6e63 6820 646f 776e 207b  sky bench down {
+000338e0: 6e61 6d65 7d20 2d79 3b20 736b 7920 6265  name} -y; sky be
+000338f0: 6e63 6820 6465 6c65 7465 207b 6e61 6d65  nch delete {name
+00033900: 7d20 2d79 272c 0a20 2020 2029 0a20 2020  } -y',.    ).   
+00033910: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00033920: 7374 290a                                st).
```

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_spot_serve.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_spot_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240415/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240416/tests/test_yaml_parser.py`

 * *Files identical despite different names*

