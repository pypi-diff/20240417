# Comparing `tmp/assemblyline_ui-4.5.1.dev89-py3-none-any.whl.zip` & `tmp/assemblyline_ui-4.5.1.dev91-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,79 +1,79 @@
-Zip file size: 177274 bytes, number of entries: 77
--rw-r--r--  2.0 unx       12 b- defN 24-Apr-16 21:25 assemblyline_ui/VERSION
--rw-r--r--  2.0 unx        0 b- defN 24-Apr-16 21:25 assemblyline_ui/__init__.py
--rw-r--r--  2.0 unx     6736 b- defN 24-Apr-16 21:25 assemblyline_ui/app.py
--rw-r--r--  2.0 unx     5951 b- defN 24-Apr-16 21:25 assemblyline_ui/config.py
--rw-r--r--  2.0 unx     4064 b- defN 24-Apr-16 21:25 assemblyline_ui/error.py
--rw-r--r--  2.0 unx      740 b- defN 24-Apr-16 21:25 assemblyline_ui/gunicorn_config.py
--rw-r--r--  2.0 unx      115 b- defN 24-Apr-16 21:25 assemblyline_ui/gunicorn_config_socketio.py
--rw-r--r--  2.0 unx      777 b- defN 24-Apr-16 21:25 assemblyline_ui/healthz.py
--rw-r--r--  2.0 unx      199 b- defN 24-Apr-16 21:25 assemblyline_ui/http_exceptions.py
--rw-r--r--  2.0 unx     2322 b- defN 24-Apr-16 21:25 assemblyline_ui/logger.py
--rw-r--r--  2.0 unx       85 b- defN 24-Apr-16 21:25 assemblyline_ui/patched.py
--rw-r--r--  2.0 unx     2596 b- defN 24-Apr-16 21:25 assemblyline_ui/socketsrv.py
--rw-r--r--  2.0 unx        0 b- defN 24-Apr-16 21:25 assemblyline_ui/api/__init__.py
--rw-r--r--  2.0 unx    16195 b- defN 24-Apr-16 21:25 assemblyline_ui/api/base.py
--rw-r--r--  2.0 unx     3915 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/__init__.py
--rw-r--r--  2.0 unx    37510 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/alert.py
--rw-r--r--  2.0 unx    24904 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/archive.py
--rw-r--r--  2.0 unx     1866 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/assistant.py
--rw-r--r--  2.0 unx    33569 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/authentication.py
--rw-r--r--  2.0 unx    32455 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/badlist.py
--rw-r--r--  2.0 unx     5141 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/bundle.py
--rw-r--r--  2.0 unx     2560 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/error.py
--rw-r--r--  2.0 unx    12508 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/federated_lookup.py
--rw-r--r--  2.0 unx    55854 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/file.py
--rw-r--r--  2.0 unx    11900 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/hash_search.py
--rw-r--r--  2.0 unx     6367 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/help.py
--rw-r--r--  2.0 unx     2910 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/heuristics.py
--rw-r--r--  2.0 unx    20441 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/ingest.py
--rw-r--r--  2.0 unx     5477 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/live.py
--rw-r--r--  2.0 unx    13223 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/ontology.py
--rw-r--r--  2.0 unx     7985 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/replay.py
--rw-r--r--  2.0 unx     6203 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/result.py
--rw-r--r--  2.0 unx    23121 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/retrohunt.py
--rw-r--r--  2.0 unx    23196 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/safelist.py
--rw-r--r--  2.0 unx    20528 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/search.py
--rw-r--r--  2.0 unx    39389 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/service.py
--rw-r--r--  2.0 unx    26966 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/signature.py
--rw-r--r--  2.0 unx    46126 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/submission.py
--rw-r--r--  2.0 unx    20443 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/submit.py
--rw-r--r--  2.0 unx    20730 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/system.py
--rw-r--r--  2.0 unx    11728 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/ui.py
--rw-r--r--  2.0 unx    40316 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/user.py
--rw-r--r--  2.0 unx     4734 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/webauthn.py
--rw-r--r--  2.0 unx    10308 b- defN 24-Apr-16 21:25 assemblyline_ui/api/v4/workflow.py
--rw-r--r--  2.0 unx        0 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/__init__.py
--rw-r--r--  2.0 unx     1686 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/discover.py
--rw-r--r--  2.0 unx     8154 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/oauth.py
--rw-r--r--  2.0 unx     4926 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/result.py
--rw-r--r--  2.0 unx     1686 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/search.py
--rw-r--r--  2.0 unx     3260 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/service.py
--rw-r--r--  2.0 unx      899 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/signature.py
--rw-r--r--  2.0 unx     6835 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/submission.py
--rw-r--r--  2.0 unx     7628 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/user.py
--rw-r--r--  2.0 unx      445 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/ai/__init__.py
--rw-r--r--  2.0 unx     4895 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/ai/base.py
--rw-r--r--  2.0 unx     5692 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/ai/cohere.py
--rw-r--r--  2.0 unx     5446 b- defN 24-Apr-16 21:25 assemblyline_ui/helper/ai/openai.py
--rw-r--r--  2.0 unx        0 b- defN 24-Apr-16 21:25 assemblyline_ui/security/__init__.py
--rw-r--r--  2.0 unx     1410 b- defN 24-Apr-16 21:25 assemblyline_ui/security/apikey_auth.py
--rw-r--r--  2.0 unx    10116 b- defN 24-Apr-16 21:25 assemblyline_ui/security/authenticator.py
--rw-r--r--  2.0 unx    13749 b- defN 24-Apr-16 21:25 assemblyline_ui/security/ldap_auth.py
--rw-r--r--  2.0 unx     3074 b- defN 24-Apr-16 21:25 assemblyline_ui/security/oauth_auth.py
--rw-r--r--  2.0 unx     2951 b- defN 24-Apr-16 21:25 assemblyline_ui/security/second_factor_auth.py
--rw-r--r--  2.0 unx      750 b- defN 24-Apr-16 21:25 assemblyline_ui/security/userpass_auth.py
--rw-r--r--  2.0 unx        0 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/__init__.py
--rw-r--r--  2.0 unx     2170 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/alert.py
--rw-r--r--  2.0 unx     3529 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/base.py
--rw-r--r--  2.0 unx     2041 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/file.py
--rw-r--r--  2.0 unx     4158 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/live_submission.py
--rw-r--r--  2.0 unx     2146 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/retrohunt.py
--rw-r--r--  2.0 unx     1980 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/status.py
--rw-r--r--  2.0 unx     2222 b- defN 24-Apr-16 21:25 assemblyline_ui/sio/submission.py
--rw-r--r--  2.0 unx     1396 b- defN 24-Apr-16 21:25 assemblyline_ui-4.5.1.dev89.dist-info/LICENCE.md
--rw-r--r--  2.0 unx     2898 b- defN 24-Apr-16 21:25 assemblyline_ui-4.5.1.dev89.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Apr-16 21:25 assemblyline_ui-4.5.1.dev89.dist-info/WHEEL
--rw-r--r--  2.0 unx       16 b- defN 24-Apr-16 21:25 assemblyline_ui-4.5.1.dev89.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     6914 b- defN 24-Apr-16 21:25 assemblyline_ui-4.5.1.dev89.dist-info/RECORD
-77 files, 725329 bytes uncompressed, 166228 bytes compressed:  77.1%
+Zip file size: 177587 bytes, number of entries: 77
+-rw-r--r--  2.0 unx       12 b- defN 24-Apr-17 16:46 assemblyline_ui/VERSION
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-17 16:46 assemblyline_ui/__init__.py
+-rw-r--r--  2.0 unx     6747 b- defN 24-Apr-17 16:46 assemblyline_ui/app.py
+-rw-r--r--  2.0 unx     5927 b- defN 24-Apr-17 16:46 assemblyline_ui/config.py
+-rw-r--r--  2.0 unx     4064 b- defN 24-Apr-17 16:46 assemblyline_ui/error.py
+-rw-r--r--  2.0 unx      740 b- defN 24-Apr-17 16:46 assemblyline_ui/gunicorn_config.py
+-rw-r--r--  2.0 unx      115 b- defN 24-Apr-17 16:46 assemblyline_ui/gunicorn_config_socketio.py
+-rw-r--r--  2.0 unx      777 b- defN 24-Apr-17 16:46 assemblyline_ui/healthz.py
+-rw-r--r--  2.0 unx      199 b- defN 24-Apr-17 16:46 assemblyline_ui/http_exceptions.py
+-rw-r--r--  2.0 unx     2322 b- defN 24-Apr-17 16:46 assemblyline_ui/logger.py
+-rw-r--r--  2.0 unx       85 b- defN 24-Apr-17 16:46 assemblyline_ui/patched.py
+-rw-r--r--  2.0 unx     2596 b- defN 24-Apr-17 16:46 assemblyline_ui/socketsrv.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-17 16:46 assemblyline_ui/api/__init__.py
+-rw-r--r--  2.0 unx    17143 b- defN 24-Apr-17 16:46 assemblyline_ui/api/base.py
+-rw-r--r--  2.0 unx     3915 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/__init__.py
+-rw-r--r--  2.0 unx    37510 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/alert.py
+-rw-r--r--  2.0 unx    24904 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/archive.py
+-rw-r--r--  2.0 unx     1866 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/assistant.py
+-rw-r--r--  2.0 unx    33569 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/authentication.py
+-rw-r--r--  2.0 unx    32455 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/badlist.py
+-rw-r--r--  2.0 unx     5141 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/bundle.py
+-rw-r--r--  2.0 unx     2560 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/error.py
+-rw-r--r--  2.0 unx    12508 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/federated_lookup.py
+-rw-r--r--  2.0 unx    56043 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/file.py
+-rw-r--r--  2.0 unx    11900 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/hash_search.py
+-rw-r--r--  2.0 unx     6367 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/help.py
+-rw-r--r--  2.0 unx     2910 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/heuristics.py
+-rw-r--r--  2.0 unx    20441 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/ingest.py
+-rw-r--r--  2.0 unx     5477 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/live.py
+-rw-r--r--  2.0 unx    13223 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/ontology.py
+-rw-r--r--  2.0 unx     7985 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/replay.py
+-rw-r--r--  2.0 unx     6203 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/result.py
+-rw-r--r--  2.0 unx    23121 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/retrohunt.py
+-rw-r--r--  2.0 unx    23196 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/safelist.py
+-rw-r--r--  2.0 unx    20528 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/search.py
+-rw-r--r--  2.0 unx    39389 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/service.py
+-rw-r--r--  2.0 unx    26966 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/signature.py
+-rw-r--r--  2.0 unx    46111 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/submission.py
+-rw-r--r--  2.0 unx    20443 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/submit.py
+-rw-r--r--  2.0 unx    20730 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/system.py
+-rw-r--r--  2.0 unx    11728 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/ui.py
+-rw-r--r--  2.0 unx    40316 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/user.py
+-rw-r--r--  2.0 unx     4734 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/webauthn.py
+-rw-r--r--  2.0 unx    10308 b- defN 24-Apr-17 16:46 assemblyline_ui/api/v4/workflow.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/__init__.py
+-rw-r--r--  2.0 unx     1686 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/discover.py
+-rw-r--r--  2.0 unx     8154 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/oauth.py
+-rw-r--r--  2.0 unx     4926 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/result.py
+-rw-r--r--  2.0 unx     1686 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/search.py
+-rw-r--r--  2.0 unx     3260 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/service.py
+-rw-r--r--  2.0 unx      899 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/signature.py
+-rw-r--r--  2.0 unx     6835 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/submission.py
+-rw-r--r--  2.0 unx     7665 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/user.py
+-rw-r--r--  2.0 unx      445 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/ai/__init__.py
+-rw-r--r--  2.0 unx     4895 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/ai/base.py
+-rw-r--r--  2.0 unx     5692 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/ai/cohere.py
+-rw-r--r--  2.0 unx     5446 b- defN 24-Apr-17 16:46 assemblyline_ui/helper/ai/openai.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-17 16:46 assemblyline_ui/security/__init__.py
+-rw-r--r--  2.0 unx     1409 b- defN 24-Apr-17 16:46 assemblyline_ui/security/apikey_auth.py
+-rw-r--r--  2.0 unx    10116 b- defN 24-Apr-17 16:46 assemblyline_ui/security/authenticator.py
+-rw-r--r--  2.0 unx    13746 b- defN 24-Apr-17 16:46 assemblyline_ui/security/ldap_auth.py
+-rw-r--r--  2.0 unx     3558 b- defN 24-Apr-17 16:46 assemblyline_ui/security/oauth_auth.py
+-rw-r--r--  2.0 unx     2953 b- defN 24-Apr-17 16:46 assemblyline_ui/security/second_factor_auth.py
+-rw-r--r--  2.0 unx      747 b- defN 24-Apr-17 16:46 assemblyline_ui/security/userpass_auth.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/__init__.py
+-rw-r--r--  2.0 unx     2170 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/alert.py
+-rw-r--r--  2.0 unx     3529 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/base.py
+-rw-r--r--  2.0 unx     2041 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/file.py
+-rw-r--r--  2.0 unx     4158 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/live_submission.py
+-rw-r--r--  2.0 unx     2146 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/retrohunt.py
+-rw-r--r--  2.0 unx     1980 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/status.py
+-rw-r--r--  2.0 unx     2222 b- defN 24-Apr-17 16:46 assemblyline_ui/sio/submission.py
+-rw-r--r--  2.0 unx     1396 b- defN 24-Apr-17 16:46 assemblyline_ui-4.5.1.dev91.dist-info/LICENCE.md
+-rw-r--r--  2.0 unx     2898 b- defN 24-Apr-17 16:46 assemblyline_ui-4.5.1.dev91.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-Apr-17 16:46 assemblyline_ui-4.5.1.dev91.dist-info/WHEEL
+-rw-r--r--  2.0 unx       16 b- defN 24-Apr-17 16:46 assemblyline_ui-4.5.1.dev91.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     6914 b- defN 24-Apr-17 16:46 assemblyline_ui-4.5.1.dev91.dist-info/RECORD
+77 files, 726954 bytes uncompressed, 166541 bytes compressed:  77.1%
```

## zipnote {}

```diff
@@ -210,23 +210,23 @@
 
 Filename: assemblyline_ui/sio/status.py
 Comment: 
 
 Filename: assemblyline_ui/sio/submission.py
 Comment: 
 
-Filename: assemblyline_ui-4.5.1.dev89.dist-info/LICENCE.md
+Filename: assemblyline_ui-4.5.1.dev91.dist-info/LICENCE.md
 Comment: 
 
-Filename: assemblyline_ui-4.5.1.dev89.dist-info/METADATA
+Filename: assemblyline_ui-4.5.1.dev91.dist-info/METADATA
 Comment: 
 
-Filename: assemblyline_ui-4.5.1.dev89.dist-info/WHEEL
+Filename: assemblyline_ui-4.5.1.dev91.dist-info/WHEEL
 Comment: 
 
-Filename: assemblyline_ui-4.5.1.dev89.dist-info/top_level.txt
+Filename: assemblyline_ui-4.5.1.dev91.dist-info/top_level.txt
 Comment: 
 
-Filename: assemblyline_ui-4.5.1.dev89.dist-info/RECORD
+Filename: assemblyline_ui-4.5.1.dev91.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## assemblyline_ui/VERSION

```diff
@@ -1 +1 @@
-4.5.1.dev89
+4.5.1.dev91
```

## assemblyline_ui/app.py

```diff
@@ -77,15 +77,15 @@
 
 if all([os.path.exists(fp) for fp in CERT_BUNDLE]):
     # If all files required are present, start up encrypted comms
     ssl_context = CERT_BUNDLE
     if AL_HSTS_MAX_AGE is not None:
         try:
             int(AL_HSTS_MAX_AGE)
-        except:
+        except Exception:
             raise ValueError("AL_HSTS_MAX_AGE must be set to an integer")
 
         def include_hsts_header(response):
             response.headers['Strict-Transport-Security'] = f"max-age={AL_HSTS_MAX_AGE}; includeSubdomains"
             return response
 
         app.after_request(include_hsts_header)
@@ -176,8 +176,8 @@
         wlog.addHandler(h)
 
     app.jinja_env.cache = {}
     app.run(host="0.0.0.0", debug=False, ssl_context=ssl_context)
 
 
 if __name__ == '__main__':
-    main()
+    main()
```

## assemblyline_ui/config.py

```diff
@@ -141,19 +141,18 @@
 # Global instances
 APPS_LIST = forge.CachedObject(get_apps_list, refresh=3600)
 FILESTORE: FileStore = forge.get_filestore(config=config)
 if config.datastore.archive.enabled:
     ARCHIVESTORE: FileStore = forge.get_archivestore(config=config)
 else:
     ARCHIVESTORE = None
+CACHE: Cache = Cache(prefix="flask_cache", host=redis, ttl=24 * 60 * 60)
 if config.ui.ai.enabled:
-    AI_CACHE: Cache = Cache(prefix="ai_cache", host=redis, ttl=24 * 60 * 60)
     AI_AGENT: AIAgent = get_ai_agent(config, LOGGER)
 else:
-    AI_CACHE = None
     AI_AGENT = None
 STORAGE: AssemblylineDatastore = forge.get_datastore(config=config, archive_access=True)
 metadata_validator = MetadataValidator(STORAGE)
 IDENTIFY: Identify = forge.get_identify(config=config, datastore=STORAGE, use_cache=True)
 ARCHIVE_MANAGER: ArchiveManager = ArchiveManager(
     config=config, datastore=STORAGE, filestore=FILESTORE, identify=IDENTIFY)
 SERVICE_LIST = forge.CachedObject(STORAGE.list_all_services, kwargs=dict(as_obj=False, full=True))
```

## assemblyline_ui/api/base.py

```diff
@@ -8,15 +8,15 @@
 from flask import current_app, Blueprint, jsonify, make_response, request, session as flsk_session, Response, abort
 from sys import exc_info
 from traceback import format_tb
 
 from assemblyline_ui.security.apikey_auth import validate_apikey
 from assemblyline_ui.security.authenticator import BaseSecurityRenderer
 from assemblyline_ui.security.oauth_auth import validate_oauth_token
-from assemblyline_ui.config import LOGGER, QUOTA_TRACKER, STORAGE, SECRET_KEY, VERSION
+from assemblyline_ui.config import LOGGER, QUOTA_TRACKER, STORAGE, SECRET_KEY, VERSION, CLASSIFICATION
 from assemblyline_ui.helper.user import login
 from assemblyline_ui.http_exceptions import AuthenticationException
 from assemblyline_ui.config import config
 from assemblyline_ui.logger import log_with_traceback
 from assemblyline.common.str_utils import safe_str
 from assemblyline.odm.models.user import ROLES
 
@@ -44,15 +44,15 @@
 
     def auto_auth_check(self):
         apikey = request.environ.get('HTTP_X_APIKEY', None)
         uname = request.environ.get('HTTP_X_USER', None)
 
         if apikey is not None and uname is not None:
             ip = request.headers.get("X-Forwarded-For", request.remote_addr)
-            with elasticapm.capture_span(name="@api_login:auto_auth_check()", span_type="authentication"):
+            with elasticapm.capture_span(name="auto_auth_check", span_type="authentication"):
                 try:
                     # TODO: apikey_handler is slow to verify the password (bcrypt's fault)
                     #       We could fix this by saving the hash of the combinaison of the
                     #       APIkey and the username in an ExpiringSet and looking it up for
                     #       sub-sequent calls...
                     validated_user, roles_limit = validate_apikey(uname, apikey, STORAGE)
                 except AuthenticationException as ae:
@@ -72,14 +72,15 @@
             abort(401, "Invalid session")
 
         if session.get("roles_limit", []) is None and self.check_xsrf_token and \
                 session.get('xsrf_token', "") != request.environ.get('HTTP_X_XSRF_TOKEN',
                                                                      request.args.get("XSRF_TOKEN", "")):
             abort(403, "Invalid XSRF token")
 
+    @elasticapm.capture_span(span_type='authentication')
     def parse_al_obo_token(self, bearer_token, roles_limit, impersonator):
         # noinspection PyBroadException
         try:
             headers = jwt.get_unverified_header(bearer_token)
 
             # Test token validity
             if 'token_id' not in headers or 'user' not in headers:
@@ -97,122 +98,130 @@
             target_token = target_user.get('apps', {}).get(headers['token_id'], {})
             if target_token != decoded:
                 raise AuthenticationException("Invalid OBO token - Token ID does not match the token")
 
             if target_token['client_id'] != impersonator:
                 raise AuthenticationException(f"Invalid OBO token - {impersonator} is not allowed to use this token")
 
-            logged_in_uname = headers['user']
-
             if roles_limit:
                 roles_limit = [r for r in decoded['roles'] if r in roles_limit]
             else:
                 roles_limit = decoded["roles"]
 
-            return logged_in_uname, roles_limit
+            return target_user, roles_limit
         else:
             raise AuthenticationException("User of the OBO token is not found")
 
     def __call__(self, func):
         @functools.wraps(func)
         def base(*args, **kwargs):
-            if 'user' in kwargs:
-                if kwargs['user'].get('authenticated', False):
-                    return func(*args, **kwargs)
-                else:
-                    abort(403, "Invalid pre-authenticated user")
+            with elasticapm.capture_span(name="assemblyline_ui.api.base.api_login", span_type="authentication"):
+                if 'user' in kwargs:
+                    if kwargs['user'].get('authenticated', False):
+                        return func(*args, **kwargs)
+                    else:
+                        abort(403, "Invalid pre-authenticated user")
 
-            self.test_readonly("API")
-            logged_in_uname, roles_limit = self.get_logged_in_user()
-            impersonator = None
-
-            # Impersonate
-            authorization = request.environ.get("HTTP_AUTHORIZATION", None)
-            if authorization:
-                ip = request.headers.get("X-Forwarded-For", request.remote_addr)
-                impersonator = logged_in_uname
-                bearer_token = authorization.split(" ")[-1]
-                token_provider = request.environ.get("HTTP_X_TOKEN_PROVIDER", None)
-                if token_provider:
-                    # Token has an associated provider, use it to validate the token
-                    try:
-                        logged_in_uname, token_roles_limit = validate_oauth_token(bearer_token, token_provider)
-                    except AuthenticationException as e:
-                        LOGGER.warning(f"Authentication failure. (U:{logged_in_uname} - IP:{ip}) [{str(e)}]")
-                        abort(403, str(e))
-
-                    # Combine role limits
-                    if roles_limit:
-                        roles_limit = [r for r in token_roles_limit if r in roles_limit]
+                self.test_readonly("API")
+                logged_in_uname, roles_limit = self.get_logged_in_user()
+                impersonator = None
+                user = None
+
+                # Impersonate
+                authorization = request.environ.get("HTTP_AUTHORIZATION", None)
+                if authorization:
+                    ip = request.headers.get("X-Forwarded-For", request.remote_addr)
+                    impersonator = logged_in_uname
+                    bearer_token = authorization.split(" ")[-1]
+                    token_provider = request.environ.get("HTTP_X_TOKEN_PROVIDER", None)
+                    if token_provider:
+                        # Token has an associated provider, use it to validate the token
+                        try:
+                            user, token_roles_limit = validate_oauth_token(
+                                bearer_token, token_provider, return_user=True)
+                        except AuthenticationException as e:
+                            LOGGER.warning(f"Authentication failure. (U:{logged_in_uname} - IP:{ip}) [{str(e)}]")
+                            abort(403, str(e))
+
+                        # Combine role limits
+                        if roles_limit:
+                            roles_limit = [r for r in token_roles_limit if r in roles_limit]
+                        else:
+                            roles_limit = token_roles_limit
                     else:
-                        roles_limit = token_roles_limit
-                else:
-                    # Use the internal AL token validator
-                    try:
-                        logged_in_uname, roles_limit = self.parse_al_obo_token(
-                            bearer_token, roles_limit, impersonator)
-                    except AuthenticationException as e:
-                        LOGGER.warning(f"Authentication failure. (U:{logged_in_uname} - IP:{ip}) [{str(e)}]")
-                        abort(403, str(e))
-
-                LOGGER.info(f"{impersonator} [{ip}] is impersonating {logged_in_uname} for query: {request.path}")
-
-            user = login(logged_in_uname, roles_limit)
-
-            # Terms of Service
-            if request.path not in ["/api/v4/help/tos/", "/api/v4/user/whoami/",
-                                    f"/api/v4/user/tos/{logged_in_uname}/",
-                                    "/api/v4/auth/logout/"] \
-                    and not user.get('agrees_with_tos', False) and config.ui.tos is not None:
-                abort(403, "Agree to Terms of Service before you can make any API calls")
-
-            self.test_require_role(user, "API")
-
-            #############################################
-            # Special username api query validation
-            #
-            #    If an API call requests a username, the username as to match
-            #    the logged in user or the user has to be ADMIN
-            #
-            #    API that needs this special validation need to make sure their
-            #    variable name for the username is as an optional parameter
-            #    inside 'username_key'. Default: 'username'
-            if self.username_key in kwargs:
-                if kwargs[self.username_key] != user['uname'] \
-                        and not kwargs[self.username_key] == "__global__" \
-                        and not kwargs[self.username_key] == "__workflow__" \
-                        and not kwargs[self.username_key].lower() == "__current__" \
-                        and ROLES.administration not in user['roles']:
-                    return make_api_response({}, "Your username does not match requested username", 403)
-
-            self.audit_if_required(args, kwargs, logged_in_uname, user, func, impersonator=impersonator)
-
-            # Save user credential in user kwarg for future reference
-            kwargs['user'] = user
-
-            if config.core.metrics.apm_server.server_url is not None:
-                elasticapm.set_user_context(username=user.get('name', None),
-                                            email=user.get('email', None),
-                                            user_id=user.get('uname', None))
-
-            # Check current user quota
-            quota_user = user['uname']
-
-            flsk_session['quota_user'] = quota_user
-            flsk_session['quota_set'] = True
-
-            quota = user.get('api_quota', 10)
-            if not QUOTA_TRACKER.begin(quota_user, quota):
-                if config.ui.enforce_quota:
-                    LOGGER.info(f"User {quota_user} was prevented from using the api due to exceeded quota.")
-                    return make_api_response("", f"You've exceeded your maximum quota of {quota}", 503)
+                        # Use the internal AL token validator
+                        try:
+                            user, roles_limit = self.parse_al_obo_token(bearer_token, roles_limit, impersonator)
+                        except AuthenticationException as e:
+                            LOGGER.warning(f"Authentication failure. (U:{logged_in_uname} - IP:{ip}) [{str(e)}]")
+                            abort(403, str(e))
+
+                    # Intersect impersonator and user classifications
+                    impersonator_user = STORAGE.user.get(impersonator, as_obj=False)
+                    user['classification'] = CLASSIFICATION.intersect_user_classification(
+                        impersonator_user['classification'], user['classification'])
+
+                    # Set currently logged in user
+                    logged_in_uname = user['uname']
+                    LOGGER.info(f"{impersonator} [{ip}] is impersonating "
+                                f"{logged_in_uname} for query: {request.path}")
+
+                user = login(logged_in_uname, roles_limit, user=user)
+
+                # Terms of Service
+                if request.path not in ["/api/v4/help/tos/", "/api/v4/user/whoami/",
+                                        f"/api/v4/user/tos/{logged_in_uname}/",
+                                        "/api/v4/auth/logout/"] \
+                        and not user.get('agrees_with_tos', False) and config.ui.tos is not None:
+                    abort(403, "Agree to Terms of Service before you can make any API calls")
+
+                self.test_require_role(user, "API")
+
+                #############################################
+                # Special username api query validation
+                #
+                #    If an API call requests a username, the username as to match
+                #    the logged in user or the user has to be ADMIN
+                #
+                #    API that needs this special validation need to make sure their
+                #    variable name for the username is as an optional parameter
+                #    inside 'username_key'. Default: 'username'
+                if self.username_key in kwargs:
+                    if kwargs[self.username_key] != user['uname'] \
+                            and not kwargs[self.username_key] == "__global__" \
+                            and not kwargs[self.username_key] == "__workflow__" \
+                            and not kwargs[self.username_key].lower() == "__current__" \
+                            and ROLES.administration not in user['roles']:
+                        return make_api_response({}, "Your username does not match requested username", 403)
+
+                self.audit_if_required(args, kwargs, logged_in_uname, user, func, impersonator=impersonator)
+
+                # Save user credential in user kwarg for future reference
+                kwargs['user'] = user
+
+                if config.core.metrics.apm_server.server_url is not None:
+                    elasticapm.set_user_context(username=user.get('name', None),
+                                                email=user.get('email', None),
+                                                user_id=user.get('uname', None))
+
+                # Check current user quota
+                quota_user = user['uname']
+
+                flsk_session['quota_user'] = quota_user
+                flsk_session['quota_set'] = True
+
+                quota = user.get('api_quota', 10)
+                if not QUOTA_TRACKER.begin(quota_user, quota):
+                    if config.ui.enforce_quota:
+                        LOGGER.info(f"User {quota_user} was prevented from using the api due to exceeded quota.")
+                        return make_api_response("", f"You've exceeded your maximum quota of {quota}", 503)
+                    else:
+                        LOGGER.debug(f"Quota of {quota} exceeded for user {quota_user}.")
                 else:
-                    LOGGER.debug(f"Quota of {quota} exceeded for user {quota_user}.")
-            else:
-                LOGGER.debug(f"{quota_user}'s quota is under or equal its limit of {quota}")
+                    LOGGER.debug(f"{quota_user}'s quota is under or equal its limit of {quota}")
 
             return func(*args, **kwargs)
         base.protected = True
         base.require_role = self.require_role
         base.audit = self.audit
         base.check_xsrf_token = self.check_xsrf_token
         base.allow_readonly = self.allow_readonly
```

## assemblyline_ui/api/v4/file.py

```diff
@@ -14,15 +14,15 @@
 from assemblyline.common.threading import APMAwareThreadPoolExecutor
 from assemblyline.common.str_utils import safe_str
 from assemblyline.datastore.collection import Index
 from assemblyline.datastore.exceptions import DataStoreException
 from assemblyline.filestore import FileStoreException
 from assemblyline.odm.models.user import ROLES
 from assemblyline_ui.api.base import api_login, make_api_response, make_subapi_blueprint, stream_file_response
-from assemblyline_ui.config import AI_CACHE, ALLOW_ZIP_DOWNLOADS, ALLOW_RAW_DOWNLOADS, FILESTORE, STORAGE, config, \
+from assemblyline_ui.config import CACHE, ALLOW_ZIP_DOWNLOADS, ALLOW_RAW_DOWNLOADS, FILESTORE, STORAGE, config, \
     CLASSIFICATION as Classification, ARCHIVESTORE, AI_AGENT
 from assemblyline_ui.helper.ai.base import APIException, EmptyAIResponse
 from assemblyline_ui.helper.result import format_result
 from assemblyline_ui.helper.user import load_user_settings
 from assemblyline.datastore.collection import Index
 
 LABEL_CATEGORIES = ['attribution', 'technique', 'info']
@@ -55,14 +55,17 @@
     Result example:
     <THE ASCII FILE>
     """
 
     user = kwargs['user']
     file_obj = STORAGE.file.get(sha256, as_obj=False)
 
+    if not file_obj:
+        return make_api_response({}, "The file was not found in the system.", 404)
+
     if file_obj['size'] > API_MAX_SIZE:
         return make_api_response({}, "This file is too big to be seen through this API.", 403)
 
     if not file_obj:
         return make_api_response({}, "The file was not found in the system.", 404)
 
     if user and Classification.is_accessible(user['classification'], file_obj['classification']):
@@ -509,32 +512,32 @@
 
     user = kwargs['user']
 
     if archive_only and ROLES.archive_view not in user['roles']:
         return make_api_response({}, "User is not allowed to view the archive", 403)
 
     # Create the cache key
-    cache_key = AI_CACHE.create_key(sha256, user['classification'], index_type, archive_only, lang, with_trace, "file")
+    cache_key = CACHE.create_key(sha256, user['classification'], index_type, archive_only, lang, with_trace, "file")
     ai_summary = None
     if (not no_cache):
         # Get the summary from cache
-        ai_summary = AI_CACHE.get(cache_key)
+        ai_summary = CACHE.get(cache_key)
 
     if not ai_summary:
         data = STORAGE.get_ai_formatted_file_results_data(
             sha256, user_classification=user['classification'],
             user_access_control=user['access_control'], cl_engine=Classification, index_type=index_type)
         if data is None:
             return make_api_response("", "The file was not found in the system.", 404)
 
         try:
             ai_summary = AI_AGENT.summarized_al_submission(data, lang=lang, with_trace=with_trace)
 
             # Save to cache
-            AI_CACHE.set(cache_key, ai_summary)
+            CACHE.set(cache_key, ai_summary)
         except (APIException, EmptyAIResponse) as e:
             return make_api_response("", str(e), 400)
 
     return make_api_response(ai_summary)
 
 
 @file_api.route("/code_summary/<sha256>/", methods=["GET"])
@@ -569,19 +572,19 @@
     no_cache = request.args.get('no_cache', 'false').lower() in ['true', '']
     lang = request.args.get('lang', 'english')
     with_trace = request.args.get('with_trace', 'false').lower() in ['true', '']
 
     user = kwargs['user']
 
     # Create the cache key
-    cache_key = AI_CACHE.create_key(sha256, user['classification'], lang, with_trace, "code")
+    cache_key = CACHE.create_key(sha256, user['classification'], lang, with_trace, "code")
     ai_summary = None
     if (not no_cache):
         # Get the summary from cache
-        ai_summary = AI_CACHE.get(cache_key)
+        ai_summary = CACHE.get(cache_key)
 
     if not ai_summary:
         file_obj = STORAGE.file.get(sha256, as_obj=False)
 
         if not file_obj:
             return make_api_response({}, "The file was not found in the system.", 404)
 
@@ -611,15 +614,15 @@
             if not data:
                 return make_api_response({}, "The file was not found in the system.", 404)
 
             try:
                 ai_summary = AI_AGENT.summarize_code_snippet(data, lang=lang, with_trace=with_trace)
 
                 # Save to cache
-                AI_CACHE.set(cache_key, ai_summary)
+                CACHE.set(cache_key, ai_summary)
             except (APIException, EmptyAIResponse) as e:
                 return make_api_response("", str(e), 400)
         else:
             return make_api_response({}, "You are not allowed to view this file.", 403)
 
     return make_api_response(ai_summary)
 
@@ -1028,14 +1031,17 @@
     Result example:
     <THE LIST OF STRINGS>
     """
     user = kwargs['user']
     hlen = request.args.get('len', "6")
     file_obj = STORAGE.file.get(sha256, as_obj=False)
 
+    if not file_obj:
+        return make_api_response({}, "The file was not found in the system.", 404)
+
     if file_obj['size'] > API_MAX_SIZE:
         return make_api_response({}, "This file is too big to be seen through this API.", 403)
 
     if not file_obj:
         return make_api_response({}, "The file was not found in the system.", 404)
 
     if user and Classification.is_accessible(user['classification'], file_obj['classification']):
```

## assemblyline_ui/api/v4/submission.py

```diff
@@ -5,15 +5,15 @@
 
 from assemblyline.datastore.exceptions import MultiKeyError, SearchException
 from assemblyline.datastore.collection import Index
 from assemblyline.odm.models.user import ROLES
 from assemblyline_core.dispatching.client import DispatchClient
 from assemblyline_ui.api.base import api_login, make_api_response, make_subapi_blueprint
 from assemblyline_ui.config import AI_AGENT, STORAGE, LOGGER, FILESTORE, config, \
-    CLASSIFICATION as Classification, AI_CACHE
+    CLASSIFICATION as Classification, CACHE
 from assemblyline_ui.helper.ai.base import APIException, EmptyAIResponse
 from assemblyline_ui.helper.result import cleanup_heuristic_sections, format_result
 from assemblyline_ui.helper.submission import get_or_create_summary
 
 
 SUB_API = 'submission'
 submission_api = make_subapi_blueprint(SUB_API, api_version=4)
@@ -528,20 +528,20 @@
 
     user = kwargs['user']
 
     if archive_only and ROLES.archive_view not in user['roles']:
         return make_api_response({}, "User is not allowed to view the archive", 403)
 
     # Create the cache key
-    cache_key = AI_CACHE.create_key(sid, user['classification'], index_type,
-                                    archive_only, detailed, lang, with_trace, "submission")
+    cache_key = CACHE.create_key(sid, user['classification'], index_type,
+                                 archive_only, detailed, lang, with_trace, "submission")
     ai_summary = None
     if (not no_cache):
         # Get the summary from cache
-        ai_summary = AI_CACHE.get(cache_key)
+        ai_summary = CACHE.get(cache_key)
 
     if not ai_summary:
         data = STORAGE.get_ai_formatted_submission_data(
             sid, user_classification=user['classification'],
             cl_engine=Classification, index_type=index_type)
         if data is None:
             return make_api_response("", "Submission ID %s does not exists." % sid, 404)
@@ -549,15 +549,15 @@
         try:
             if detailed:
                 ai_summary = AI_AGENT.detailed_al_submission(data, lang=lang, with_trace=with_trace)
             else:
                 ai_summary = AI_AGENT.summarized_al_submission(data, lang=lang, with_trace=with_trace)
 
             # Save to cache
-            AI_CACHE.set(cache_key, ai_summary)
+            CACHE.set(cache_key, ai_summary)
         except (APIException, EmptyAIResponse) as e:
             return make_api_response("", str(e), 400)
 
     return make_api_response(ai_summary)
 
 
 @submission_api.route("/summary/<sid>/", methods=["GET"])
```

## assemblyline_ui/helper/user.py

```diff
@@ -59,16 +59,18 @@
     return None
 
 
 def decrement_submission_quota(user):
     SUBMISSION_TRACKER.end(user['uname'])
 
 
-def login(uname, roles_limit):
-    user = STORAGE.user.get(uname, as_obj=False)
+def login(uname, roles_limit, user=None):
+    if user is None:
+        user = STORAGE.user.get(uname, as_obj=False)
+
     if not user:
         raise AuthenticationException("User %s does not exists" % uname)
 
     if not user['is_active']:
         raise AccessDeniedException("User %s is disabled" % uname)
 
     add_access_control(user)
```

## assemblyline_ui/security/apikey_auth.py

```diff
@@ -2,15 +2,15 @@
 
 from assemblyline.odm.models.user import load_roles_form_acls, ROLES, load_roles
 from assemblyline_ui.config import config
 from assemblyline.common.security import verify_password
 from assemblyline_ui.http_exceptions import AuthenticationException
 
 
-@elasticapm.capture_span(span_type='validate_apikey')
+@elasticapm.capture_span(span_type='authentication')
 def validate_apikey(username, apikey, storage):
     # This function identifies the user via the internal API key functionality
     #   NOTE: It is not recommended to overload this function but you can still do it
     if config.auth.allow_apikeys and apikey:
         user_data = storage.user.get(username)
         if user_data:
             if ROLES.apikey_access not in load_roles(user_data.type, user_data.roles):
```

## assemblyline_ui/security/ldap_auth.py

```diff
@@ -265,15 +265,15 @@
                 return safe_str(value[0])
             else:
                 return value[0]
 
     return None
 
 
-@elasticapm.capture_span(span_type='validate_ldapuser')
+@elasticapm.capture_span(span_type='authentication')
 def validate_ldapuser(username, password, storage):
     if config.auth.ldap.enabled and username and password:
         ldap_obj = BasicLDAPWrapper(config.auth.ldap)
         ldap_info = ldap_obj.login(username, password)
         if ldap_info:
             if not ldap_info['access']:
                 raise AuthenticationException("This user is not allowed access to the system")
```

## assemblyline_ui/security/oauth_auth.py

```diff
@@ -1,33 +1,48 @@
 import elasticapm
 import jwt
 import requests
 
 from copy import copy
 
 from assemblyline.odm.models.user import load_roles_form_acls
-from assemblyline_ui.config import config, get_token_store, STORAGE
+from assemblyline_ui.config import config, get_token_store, STORAGE, CACHE
 from assemblyline_ui.helper.oauth import parse_profile
 from assemblyline_ui.http_exceptions import AuthenticationException
 
 
-@elasticapm.capture_span(span_type='validate_oauth_token_id')
+@elasticapm.capture_span(span_type='authentication')
+def get_jwks_keys(url):
+    cache_key = CACHE.create_key("jwks", url)
+    jwks = CACHE.get(cache_key, reset=False)
+
+    # Go get it is not in cache
+    if not jwks:
+        jwks = requests.get(url).json()
+
+        # Save it to the cache
+        CACHE.set(cache_key, jwks, ttl=600)
+
+    return jwks["keys"]
+
+
+@elasticapm.capture_span(span_type='authentication')
 def validate_oauth_id(username, oauth_token_id):
     # This function identifies the user via a saved oauth_token_id in redis
     if config.auth.oauth.enabled and oauth_token_id:
         if get_token_store(username).exist(oauth_token_id):
             return username
 
         raise AuthenticationException("Invalid token")
 
     return None
 
 
-@elasticapm.capture_span(span_type='validate_oauth_token')
-def validate_oauth_token(oauth_token, oauth_provider):
+@elasticapm.capture_span(span_type='authentication')
+def validate_oauth_token(oauth_token, oauth_provider, return_user=False):
     # This function identifies the user via an externally provided oauth token
     if config.auth.oauth.enabled and oauth_token and oauth_provider:
         oauth_provider_config = config.auth.oauth.providers.get(oauth_provider, None)
 
         if not oauth_provider_config:
             raise AuthenticationException(f"Invalid oAuth provider: {oauth_provider}")
 
@@ -39,15 +54,15 @@
 
         # Gather provider valid audiences
         audiences = copy(oauth_provider_config.external_token_alternate_audiences)
         audiences.append(oauth_provider_config.client_id)
 
         # Find proper signing key
         headers = jwt.get_unverified_header(oauth_token)
-        key_list = requests.get(oauth_provider_config.jwks_uri).json()["keys"]
+        key_list = get_jwks_keys(oauth_provider_config.jwks_uri)
         signing_key = None
         for key in key_list:
             if key['kid'] == headers['kid']:
                 signing_key = jwt.api_jwk.PyJWK(key)
                 break
 
         if signing_key:
@@ -61,15 +76,19 @@
             except jwt.PyJWTError as e:
                 raise AuthenticationException(f"Invalid token - {str(e)}")
 
             # Get user's email from profile
             email = parse_profile(jwt_data, oauth_provider_config).get('email', None)
             if email is not None:
                 # Get user from it's email
-                users = STORAGE.user.search(f"email:{email}", fl="*", as_obj=False)['items']
+                users = STORAGE.user.search(f"email:{email}", fl="*", as_obj=False, rows=1)['items']
                 if users:
                     # Limit user logging in from external token to only user READ/WRITE APIs
-                    return users[0]['uname'], load_roles_form_acls(["R", "W"], [])
+                    roles = load_roles_form_acls(["R", "W"], [])
+
+                    if return_user:
+                        return users[0], roles
+                    return users[0]['uname'], roles
 
         raise AuthenticationException("Invalid token")
 
     return None, None
```

## assemblyline_ui/security/second_factor_auth.py

```diff
@@ -11,15 +11,15 @@
 from assemblyline_ui.config import config
 from assemblyline_ui.http_exceptions import AuthenticationException
 
 rp = PublicKeyCredentialRpEntity(config.ui.fqdn, "Assemblyline server")
 server = U2FFido2Server(f"https://{config.ui.fqdn}", rp)
 
 
-@elasticapm.capture_span(span_type='validate_2fa')
+@elasticapm.capture_span(span_type='authentication')
 def validate_2fa(username, otp_token, state, webauthn_auth_resp, storage):
     security_token_enabled = False
     otp_enabled = False
     security_token_error = False
     otp_error = False
     report_errors = False
```

## assemblyline_ui/security/userpass_auth.py

```diff
@@ -1,15 +1,15 @@
 import elasticapm
 
 from assemblyline_ui.config import config
 from assemblyline.common.security import verify_password
 from assemblyline_ui.http_exceptions import AuthenticationException
 
 
-@elasticapm.capture_span(span_type='validate_userpass')
+@elasticapm.capture_span(span_type='authentication')
 def validate_userpass(username, password, storage):
     # This function uses the internal authenticator to identify the user
     # You can overload this to pass username/password to an LDAP server for exemple
     if config.auth.internal.enabled and username and password:
         user = storage.user.get(username)
         if user:
             if verify_password(password, user.password):
```

## Comparing `assemblyline_ui-4.5.1.dev89.dist-info/LICENCE.md` & `assemblyline_ui-4.5.1.dev91.dist-info/LICENCE.md`

 * *Files identical despite different names*

## Comparing `assemblyline_ui-4.5.1.dev89.dist-info/METADATA` & `assemblyline_ui-4.5.1.dev91.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: assemblyline-ui
-Version: 4.5.1.dev89
+Version: 4.5.1.dev91
 Summary: Assemblyline 4 - API and Socket IO server
 Home-page: https://github.com/CybercentreCanada/assemblyline-ui/
 Author: CCCS Assemblyline development team
 Author-email: assemblyline@cyber.gc.ca
 License: MIT
 Keywords: assemblyline automated malware analysis gc canada cse-cst cse cst cyber cccs
 Classifier: Development Status :: 5 - Production/Stable
```

## Comparing `assemblyline_ui-4.5.1.dev89.dist-info/RECORD` & `assemblyline_ui-4.5.1.dev91.dist-info/RECORD`

 * *Files 6% similar despite different names*

```diff
@@ -1,77 +1,77 @@
-assemblyline_ui/VERSION,sha256=kp6rJFN6f8K2yM5WG2NAnYGyTRlaOfZ2QRtrmn9qHNI,12
+assemblyline_ui/VERSION,sha256=INi_c2y2tbN0fW0holMAsDpKSSWXAB28SFZQOntdJ9A,12
 assemblyline_ui/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-assemblyline_ui/app.py,sha256=9JB-hkhReF2jLUUMe3F01dvN9i2HnRFGydvQCXBkE1U,6736
-assemblyline_ui/config.py,sha256=-b1Qv3SQ5tzuquULldJo5BEFKrF44zVbqFgawB66D3Y,5951
+assemblyline_ui/app.py,sha256=un8yqm60Fk_SyfZGBGJDaZmFflwdlaU_OL2vmieT_BI,6747
+assemblyline_ui/config.py,sha256=EUmv0x4qNeFp-rSTBZhcWkBYKlgvMFuo2QQ9BloqbMU,5927
 assemblyline_ui/error.py,sha256=8c-wumsGPaKsDJAp8N5AIFjoFF4K-7bNnmxZ3RZoiAo,4064
 assemblyline_ui/gunicorn_config.py,sha256=qm2Ehn9nY_yH6Klp2acYFZ9jC7St9hSmXIW42WRXbc4,740
 assemblyline_ui/gunicorn_config_socketio.py,sha256=WWAWzrZOw1OXEiV_nNMKf-wH6A0Ckio2juCYWu-QfAE,115
 assemblyline_ui/healthz.py,sha256=IFr2ofSddFX8pvoixMmZHSlk364oKD_vURl_GRT6J2s,777
 assemblyline_ui/http_exceptions.py,sha256=5DvpspLyuE6fQfR6mpPmQiFDXahr2vr3uuTp7S9Guy8,199
 assemblyline_ui/logger.py,sha256=dgaAzJc39ajD1e3hipc291zqcHyCXMgdDSLzz6V-Jus,2322
 assemblyline_ui/patched.py,sha256=EkYqCoW64CuZvrZjE7xNwZ9bTaiVfwuYBbVUR64g42A,85
 assemblyline_ui/socketsrv.py,sha256=4u8oVCt9iONC15wy1jlf6VJ6LR0zoPstcLHl9g_YaQA,2596
 assemblyline_ui/api/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-assemblyline_ui/api/base.py,sha256=91i4pHTtd6H0Zo01jFm1vwjHq4bZ66pE41pohj_GGyk,16195
+assemblyline_ui/api/base.py,sha256=RuaBo_CExpQ__gchD1XZVAiuTerNgxqkphjffbZXt54,17143
 assemblyline_ui/api/v4/__init__.py,sha256=5sJInJQ7GM-6LTIOvTPFBHE1u-kf562MjjbzX0ZBuDg,3915
 assemblyline_ui/api/v4/alert.py,sha256=XsOATBo5TZb5lhS1h34Pna-RLAZIUpk2WK_0sJ-wesI,37510
 assemblyline_ui/api/v4/archive.py,sha256=mQn0tLEAXUt9SaWN5W9QyWjm8BCln9dPozDQf7tr-Yk,24904
 assemblyline_ui/api/v4/assistant.py,sha256=2GjmY09JRbAZ-ISF73Y2XyEFwKt5a1N3GeFWDFw8oEE,1866
 assemblyline_ui/api/v4/authentication.py,sha256=bcTZOCC2LdJcoA9pOgT9YNWaHhSxZzBVO_IZNVUEvSw,33569
 assemblyline_ui/api/v4/badlist.py,sha256=VTo9r7yVQDb52I9l4-iukP47sRB0ac9P38NAtkAGnXs,32455
 assemblyline_ui/api/v4/bundle.py,sha256=XCxILxICh8eZfkbOC0fYW_v2pdl7n-US24qYEW5_RrA,5141
 assemblyline_ui/api/v4/error.py,sha256=rITm-0yrZYidetWqlJUmwyHEyF6kML5Ta3c0gT-L7M4,2560
 assemblyline_ui/api/v4/federated_lookup.py,sha256=lvINN57_oDn7bMep8PvwL4PqBnRMg16DOWTis81U5Y8,12508
-assemblyline_ui/api/v4/file.py,sha256=cCnl1_jic-a7qlgpkAcUud7b_uDlfZDmw8MsW9yv4lI,55854
+assemblyline_ui/api/v4/file.py,sha256=VqkLzpFaqGMU3Omju1l5cyzaOKWaivuVRV5ncAhV3p0,56043
 assemblyline_ui/api/v4/hash_search.py,sha256=T-otDhWdfR7m7c505S0MwFMe6CmKYyTfTnMnpgccJx4,11900
 assemblyline_ui/api/v4/help.py,sha256=4_C82EW4Cu9XPor9pMIPB7v_0uIFZ1TG2PX1nMNm2ck,6367
 assemblyline_ui/api/v4/heuristics.py,sha256=YfTUmDYrilwdNO1Dlr0qfDRTU4fOhPpSCWARLjt1auo,2910
 assemblyline_ui/api/v4/ingest.py,sha256=SnmTgqypf4Jvnro32stGajbEyl9rUGEhdUC1G1B8o_I,20441
 assemblyline_ui/api/v4/live.py,sha256=4gz8-zbkTnLWBg2OH-AmRIolBZokDjweOZgaw1I3j3U,5477
 assemblyline_ui/api/v4/ontology.py,sha256=M9fSWDZshgsI8SkNEJmwfK0cR3O7OwHryhpi14kqz7k,13223
 assemblyline_ui/api/v4/replay.py,sha256=LF1kUSzTZQGwgNhKy_GpJVxi66dBrKRFfiHiDAJCbY4,7985
 assemblyline_ui/api/v4/result.py,sha256=XJPUZPdVD1SK7kwppKzFvqGngmdRr0ei6qV0Ppl-c14,6203
 assemblyline_ui/api/v4/retrohunt.py,sha256=ScKnj2x5kwJJPOye7bhNxeoBLijgnVdeohCJribWArI,23121
 assemblyline_ui/api/v4/safelist.py,sha256=gB-kU-sirRKE29DJL10kQIzX_MtZbz8BoxFVPenel4M,23196
 assemblyline_ui/api/v4/search.py,sha256=_PfLQJxVRHOW1j68h9Y6uey3dGKlI_zsXY03IOX22fk,20528
 assemblyline_ui/api/v4/service.py,sha256=QRQ77nVRsaveYAa7MH-LxS88wXoePeh0B3SFv8LvxD8,39389
 assemblyline_ui/api/v4/signature.py,sha256=nMqnNYpmQm_-GZI79jmUd05-Zy3dGBJ3Y1hv8hX8stQ,26966
-assemblyline_ui/api/v4/submission.py,sha256=1BRWCXqhIO6xaRWhOi7vILISo_HHVMOv9922bTjb0-g,46126
+assemblyline_ui/api/v4/submission.py,sha256=8EzbjBaNSpjFUCeZXncEypzMbCrosknnej8TvJAsyCk,46111
 assemblyline_ui/api/v4/submit.py,sha256=TEg3E0rMaMF3VxR4PRc297aBBdh6H6Q3OKc_o4Wuqgs,20443
 assemblyline_ui/api/v4/system.py,sha256=Hl1BElnJELpp6paTVrNptTEENxlk2RA5bEKBDStuPpE,20730
 assemblyline_ui/api/v4/ui.py,sha256=nMvm8N51rO2oj_ZB8qQu19jF4S-46-3HVMypzcF49mI,11728
 assemblyline_ui/api/v4/user.py,sha256=8hO08OT9dTZA5JKzRKy3h_O_ZY-dCngtARlLF1opn3Y,40316
 assemblyline_ui/api/v4/webauthn.py,sha256=FxuvXScYiMdgA-ZvojGf7CfQq4C2W8e3dWLxo7W0bx4,4734
 assemblyline_ui/api/v4/workflow.py,sha256=52r5NLh2NL0J1PKD8qfN0lHvoxBhwzCbRhqx_gJDFnM,10308
 assemblyline_ui/helper/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 assemblyline_ui/helper/discover.py,sha256=oJBML1dQl0H2Ic-lm5jI4YWIpm9RRW-mGT5sP-2tb9c,1686
 assemblyline_ui/helper/oauth.py,sha256=D_1f6jd0rhwwMXi4qAieFcqAIpWXOb82oeZr0Zds3lI,8154
 assemblyline_ui/helper/result.py,sha256=u79F3IKN1EcVOkfk1CvQNEwbIWyiq9Wj8OHp3zuwmBc,4926
 assemblyline_ui/helper/search.py,sha256=QdzHgQCzpLCcq2N2auGAK9GDWC3B3V51Vey-BjGRZ6M,1686
 assemblyline_ui/helper/service.py,sha256=75kdOvWBprCi9h42FtoxDUsuKhnD-rh4f3W-y3q8RU0,3260
 assemblyline_ui/helper/signature.py,sha256=PUiQk56QoY5Ye2Pg3jRNgOT2i2ZqTWkk_0dv-Bfy9vI,899
 assemblyline_ui/helper/submission.py,sha256=P4Ff9ps_nUzHxBE7486_xbyUNuXTvOYU3aWdK8VyBOY,6835
-assemblyline_ui/helper/user.py,sha256=40ze4dNudQR-TLgf5CB1_x_Iu-5bsRiu4gVTDvsktxw,7628
+assemblyline_ui/helper/user.py,sha256=OIBQixKqM1plN7PvbMK2WPqXDmW4S6UxgTbSUXEkg4c,7665
 assemblyline_ui/helper/ai/__init__.py,sha256=At7cPA5v4EI07QT95qihEnGMlKn-AVawMNnX6FmUrvY,445
 assemblyline_ui/helper/ai/base.py,sha256=GFKdXtmqUGE2hjxCtX-zR0BMYcPWcrR3MEgIS-WBHng,4895
 assemblyline_ui/helper/ai/cohere.py,sha256=RejpLnTykVT_U61-DqM_WsMmmi91BkeSkkqEOruRA98,5692
 assemblyline_ui/helper/ai/openai.py,sha256=6AdkWe6tIEEKXUbBpmobTXNuVA-H49DU0RVI1OxAejc,5446
 assemblyline_ui/security/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-assemblyline_ui/security/apikey_auth.py,sha256=TDESuSgEEkxWZEm2X0vW1t96uWXMKCvAeJBaXnzZKQc,1410
+assemblyline_ui/security/apikey_auth.py,sha256=1VJGUy77gaJzoEG98kY9EW0rTyerVU_dO-pGpP-nIEw,1409
 assemblyline_ui/security/authenticator.py,sha256=Pjuo6VL2QrI4YL1NDAAxURv_8CYo7bwbNbDhOkLiphk,10116
-assemblyline_ui/security/ldap_auth.py,sha256=2HQh3krpPSRRCLVfow_JP_TERNeV6YLtpXOXGNzFm9Q,13749
-assemblyline_ui/security/oauth_auth.py,sha256=hfyOxNacDSh0OuovDzclsi4eCzk08-h1Y10V4QF-O_0,3074
-assemblyline_ui/security/second_factor_auth.py,sha256=GiJNoL_CjDPAHml0VdcK46GfYzkqYuAkOdW9PIorXYs,2951
-assemblyline_ui/security/userpass_auth.py,sha256=vfG9K_jpdigpZolUmkc_cEtfZ5DgPdLW7V5g68CAsVA,750
+assemblyline_ui/security/ldap_auth.py,sha256=DoZcIJMztDSGFYrsupB55LGZZ3V2nCtkJRqiVeXJu-Q,13746
+assemblyline_ui/security/oauth_auth.py,sha256=uvYE7a5ApfDPc1a_g9xMsIS4FB7L0RixSxDK3pqL0YE,3558
+assemblyline_ui/security/second_factor_auth.py,sha256=l3SjJ5vn3bYxkPTtKWLewbZUSWtm1REqllzZvvsh9BU,2953
+assemblyline_ui/security/userpass_auth.py,sha256=MtAkZsoofLDtDwhRu9dBxxTW1iSYto2PuilFq2hlwHw,747
 assemblyline_ui/sio/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 assemblyline_ui/sio/alert.py,sha256=aTtrkZW21igbP6UcFgo1_fXdF8RpCBlMiKsNdpwItZw,2170
 assemblyline_ui/sio/base.py,sha256=TLSoCLqxvSEFuggmCscnzAY1E60rweIIZLr0ai8jm5M,3529
 assemblyline_ui/sio/file.py,sha256=UMtE7mE7EcbG6KN8HBMQSvv5N7PILCq8nVnrngOnBso,2041
 assemblyline_ui/sio/live_submission.py,sha256=mS0oGO5rEA8PLa8kjBcodOG-Q0CG4SpYAoi8bz9_PCw,4158
 assemblyline_ui/sio/retrohunt.py,sha256=vlH_x6Rb4pm3GM1sNLH1C42-NVR3VoAsEfkAu3L30fY,2146
 assemblyline_ui/sio/status.py,sha256=_Bxf1KLPOJEUIk4J9_j9fzvQWUXqSIT9xnJKhT1hhuc,1980
 assemblyline_ui/sio/submission.py,sha256=IYJuGz73HK9HtYfqc-gWW8tc1lt5VZ62Qn64AaGGtm8,2222
-assemblyline_ui-4.5.1.dev89.dist-info/LICENCE.md,sha256=NSkYo9EH8h5oOkzg4VhjAHF4339MqPP2cQ8msTPgl-c,1396
-assemblyline_ui-4.5.1.dev89.dist-info/METADATA,sha256=dC847qT3l8PKE2F5Qwq6zAilSpxSZCIhcDa-eyuRqMc,2898
-assemblyline_ui-4.5.1.dev89.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-assemblyline_ui-4.5.1.dev89.dist-info/top_level.txt,sha256=WLa7-PKLJTbMUbKKU3q3kg5_uAV67hss5kC71PAbIeg,16
-assemblyline_ui-4.5.1.dev89.dist-info/RECORD,,
+assemblyline_ui-4.5.1.dev91.dist-info/LICENCE.md,sha256=NSkYo9EH8h5oOkzg4VhjAHF4339MqPP2cQ8msTPgl-c,1396
+assemblyline_ui-4.5.1.dev91.dist-info/METADATA,sha256=fHfOhmoqU9aiTHTeXP1x4GDMoZY--RRbF24tk-FGZsk,2898
+assemblyline_ui-4.5.1.dev91.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+assemblyline_ui-4.5.1.dev91.dist-info/top_level.txt,sha256=WLa7-PKLJTbMUbKKU3q3kg5_uAV67hss5kC71PAbIeg,16
+assemblyline_ui-4.5.1.dev91.dist-info/RECORD,,
```

